(function(){"use strict";TS.registerModule("client",{before_login_sig:new signals.Signal,login_sig:new signals.Signal,user_added_to_team_sig:new signals.Signal,user_removed_from_team_sig:new signals.Signal,flexpane_display_switched_sig:new signals.Signal,core_url:null,onStart:function(){TS.client.core_url=document.location.href.split(/\/+messages/)[0]+"/messages";TS.model.ui_state=TS.storage.fetchUIState();TS.model.initial_ui_state_str=TS.model.ui_state?JSON.stringify(TS.model.ui_state):"none";TS.model.flex_name_in_url=TS.utility.getFlexNameFromUrl(location.href).toLowerCase();TS.model.flex_extra_in_url=TS.utility.getFlexExtraFromUrl(location.href);if(TS.model.flex_names.indexOf(TS.model.flex_name_in_url)==-1){TS.model.flex_name_in_url="";TS.model.flex_extra_in_url=""}if(TS.model.flex_name_in_url&&TS.model.flex_name_in_url!=="search"){TS.model.ui_state.flex_name=TS.model.flex_name_in_url;TS.model.ui_state.flex_extra=TS.model.flex_extra_in_url||""}if(TS.model.ui_state.flex_name=="list")TS.model.ui_state.flex_name="files";if(TS.model.ui_state.flex_name=="activity")TS.model.ui_state.flex_name="mentions";TS.model.ui_state.flex_visible=!!TS.model.ui_state.flex_name;TS.storage.storeUIState(TS.model.ui_state);if(TS.boot_data.feature_name_tagging_client){$("body").addClass("feature_name_tagging_client")}if(TS.boot_data.feature_min_web&&TS.boot_data.version_ts==="dev"){var timeout_s=5;TSSSB.call("setTeamIdleTimeout",timeout_s)}TS.client.user_added_to_team_sig.add(TS.client.userAddedToTeam);TS.client.user_removed_from_team_sig.add(TS.client.userRemovedFromTeam)},gogogo:function(){TSConnLogger.log("gogogo","TS.client.gogogo");$(window).bind("popstate",_onPopState);if(TS.model.is_mac_ssb){TSSSB.callMacGap("didSignin",{id:TS.model.user.id,name:TS.model.user.name,team_id:TS.model.team.id,team_name:TS.model.team.name,team_url:"https://"+location.host})}},updateTeamIcon:function(){if(TS.model.team.icon){if(TS.model.team.icon.image_68&&TS.model.team.icon.image_default!==true){if(window.winssb){TSSSB.call("setImage",TS.model.team.icon)}else{TSSSB.call("setImage",TS.model.team.icon.image_68)}}else{TSSSB.call("setImage",false)}}},markLastReadsWithAPI:function(){if(TS.isPartiallyBooted())return;var i;var im;var channel;var group;var mpim;var dont_set_active;if(TS.model&&TS.model.channels){var channels=TS.model.channels;for(i=0;i<channels.length;i++){channel=channels[i];if(channel.needs_api_marking){TS.model.last_reads_set_by_client[channel.id+"_"+channel.last_read]=true;channel.needs_api_marking=false;dont_set_active=channel._marked_reason=="muted"?true:false;TS.api.call("channels.mark",{channel:channel.id,ts:channel.last_read,reason:channel._marked_reason},TS.channels.onMarked,dont_set_active)}}}if(TS.model&&TS.model.ims){for(i=0;i<TS.model.ims.length;i++){im=TS.model.ims[i];if(im.needs_api_marking){TS.model.last_reads_set_by_client[im.id+"_"+im.last_read]=true;im.needs_api_marking=false;TS.api.call("im.mark",{channel:im.id,ts:im.last_read,reason:im._marked_reason},TS.ims.onMarked)}}}if(TS.model&&TS.model.groups){for(i=0;i<TS.model.groups.length;i++){group=TS.model.groups[i];if(group.needs_api_marking){TS.model.last_reads_set_by_client[group.id+"_"+group.last_read]=true;group.needs_api_marking=false;dont_set_active=group._marked_reason=="muted"?true:false;if(group.is_private&&_.startsWith(group.id,"C")){TS.api.call("channels.mark",{channel:group.id,ts:group.last_read,reason:group._marked_reason},TS.groups.onMarked,dont_set_active)}else{TS.api.call("groups.mark",{channel:group.id,ts:group.last_read,reason:group._marked_reason},TS.groups.onMarked,dont_set_active)}}}}if(TS.model&&TS.model.mpims){for(i=0;i<TS.model.mpims.length;i++){mpim=TS.model.mpims[i];if(mpim.needs_api_marking){TS.model.last_reads_set_by_client[mpim.id+"_"+mpim.last_read]=true;mpim.needs_api_marking=false;dont_set_active=mpim._marked_reason=="muted"?true:false;TS.api.call("mpim.mark",{channel:mpim.id,ts:mpim.last_read,reason:mpim._marked_reason},TS.mpims.onMarked,dont_set_active)}}}},activeChannelDisplayGoneAway:function(){TS.model.active_history.pop();var c_id;var model_ob;var got_one;var updateActiveModelObIdsWithoutSwitchingChannels=function(model_ob){TS.model.active_history.push(model_ob.id);TS.model.active_channel_id=null;TS.model.active_im_id=null;TS.model.active_group_id=null;TS.model.active_mpim_id=null;if(model_ob.is_channel){TS.model.active_channel_id=model_ob.id}else if(model_ob.is_im){TS.model.active_im_id=model_ob.id}else if(model_ob.is_mpim){TS.model.active_mpim_id=model_ob.id}else if(model_ob.is_group){TS.model.active_group_id=model_ob.id}TS.model.active_cid=TS.model.active_channel_id||TS.model.active_im_id||TS.model.active_group_id||TS.model.active_mpim_id};while(TS.model.active_history.length&&!got_one){c_id=TS.model.active_history.pop();model_ob=TS.shared.getModelObById(c_id);if(model_ob.is_im&&model_ob.is_open){got_one=true;TS.log(4,"switching to im "+model_ob.id);if(TS.client.activeChannelIsHidden())return updateActiveModelObIdsWithoutSwitchingChannels(model_ob);TS.ims.displayIm(model_ob.id);TS.client.channelDisplaySwitched(model_ob.id)}else if(model_ob.is_mpim&&model_ob.is_open){got_one=true;TS.log(4,"switching to mpim "+model_ob.id);if(TS.client.activeChannelIsHidden())return updateActiveModelObIdsWithoutSwitchingChannels(model_ob);TS.mpims.displayMpim(model_ob.id,null,false,true)}else if(model_ob.is_group&&!model_ob.is_archived){got_one=true;TS.log(4,"switching to group "+model_ob.id);if(TS.client.activeChannelIsHidden())return updateActiveModelObIdsWithoutSwitchingChannels(model_ob);TS.groups.displayGroup(model_ob.id)}else if(model_ob.is_channel){got_one=true;TS.log(4,"switching to channel "+model_ob.id);if(TS.client.activeChannelIsHidden())return updateActiveModelObIdsWithoutSwitchingChannels(model_ob);TS.channels.displayChannel(model_ob.id,null,false,true)}}if(!TS.model.active_history.length){var unarchived_channels_for_user=TS.channels.getUnarchivedChannelsForUser();var unarchived_groups_for_user=TS.groups.getUnarchivedGroups();if(unarchived_channels_for_user.length>0){if(TS.client.activeChannelIsHidden())return updateActiveModelObIdsWithoutSwitchingChannels(unarchived_channels_for_user[0]);TS.channels.displayChannel(unarchived_channels_for_user[0].id,null,false,true);return}else if(unarchived_groups_for_user.length>0){if(TS.client.activeChannelIsHidden())return updateActiveModelObIdsWithoutSwitchingChannels(unarchived_groups_for_user[0]);TS.groups.displayGroup(unarchived_groups_for_user[0].id);return}else{TS.error("WTF no channel or group to display?")}}},flexDisplaySwitched:function(flex_name,flex_extra,replace_history_state,no_history_add){flex_extra=_cleanFlexExtra(flex_extra);if(TS.model.prefs.no_flex_in_history)replace_history_state=true;if(!no_history_add&&(TS.model.c_name_in_url||TS.client.activeChannelIsHidden())){var new_url;if(TS.model.unread_view_is_showing){new_url=TS.utility.refashionUrlForUnreadView(window.location.href,flex_name,flex_extra)}else if(TS.model.threads_view_is_showing){new_url=TS.utility.refashionUrlForThreadsView(window.location.href,flex_name,flex_extra)}else{new_url=TS.utility.refashionUrl(window.location.href,TS.model.c_name_in_url,flex_name,flex_extra)}_putURLInHistory(new_url,replace_history_state)}var prev_flex_name=TS.model.ui_state.flex_name;var prev_flex_extra=TS.model.ui_state.flex_extra;TS.model.flex_name_in_url=flex_name;TS.model.flex_extra_in_url=flex_extra;TS.model.ui_state.flex_name=flex_name;TS.model.ui_state.flex_extra=flex_extra;TS.storage.storeUIState(TS.model.ui_state);TS.client.flexpane_display_switched_sig.dispatch(prev_flex_name,prev_flex_extra)},channelDisplaySwitched:function(model_ob_id,replace_history_state,no_history_add){if(!model_ob_id){TS.error("no model_ob_id?");return false}var c_name;var model_ob=TS.shared.getModelObById(model_ob_id);if(!model_ob){TS.error("unknown model_ob id: "+model_ob_id);return false}if(TS.boot_data.feature_name_tagging_client&&(model_ob.is_im||model_ob.is_mpim)){c_name=model_ob.id}else if(model_ob.is_im){c_name="@"+model_ob.name}else{c_name=model_ob.name}if(!no_history_add){var flex_extra=_cleanFlexExtra(TS.model.flex_extra_in_url);var new_url=TS.utility.refashionUrl(window.location.href,c_name,TS.model.flex_name_in_url,flex_extra);_putURLInHistory(new_url,!TS.model.c_name_in_url||replace_history_state)}TS.model.c_name_in_url=c_name;if(!TS.client.activeChannelIsHidden()){if(model_ob.is_channel&&model_ob_id==TS.model.active_channel_id){TS.warn("not switching, it is the active channel already");return false}if(model_ob.is_im&&model_ob_id==TS.model.active_im_id){TS.warn("not switching, it is the active im already");return false}if(model_ob.is_mpim&&model_ob_id==TS.model.active_mpim_id){TS.warn("not switching, it is the active mpim already");return false}if(model_ob.is_group&&model_ob_id==TS.model.active_group_id){TS.warn("not switching, it is the active group already");return false}}TS.utility.msgs.checkForMsgsToTruncate();TS.model.last_active_cid=TS.model.active_channel_id||TS.model.active_im_id||TS.model.active_group_id||TS.model.active_mpim_id;TS.model.active_channel_id=null;TS.model.active_im_id=null;TS.model.active_group_id=null;TS.model.active_mpim_id=null;TS.model.unread_view_is_showing=false;if(TS.boot_data.feature_message_replies_threads_view)TS.model.threads_view_is_showing=false;if(model_ob.is_channel){TS.model.active_channel_id=model_ob_id}else if(model_ob.is_im){TS.model.active_im_id=model_ob_id}else if(model_ob.is_mpim){TS.model.active_mpim_id=model_ob_id}else if(model_ob.is_group){TS.model.active_group_id=model_ob_id}TS.model.active_cid=TS.model.active_channel_id||TS.model.active_im_id||TS.model.active_group_id||TS.model.active_mpim_id;TSSSB.call("displayChannel",TS.model.active_cid);TS.view.updateTitleWithContext();model_ob.last_made_active=Date.now();var c_id=model_ob_id;TS.log(4,c_id+" is now active");var history=TS.model.active_history;var i=history.indexOf(c_id);if(i!=-1){history.splice(i,1)}history.push(c_id);TS.log(4,history);TS.storage.storeActiveHistory(history);return true},unreadViewActivated:function(replace_history_state,no_history_add){var replace_history_state=replace_history_state;var no_history_add=no_history_add;if(!no_history_add){var flex_extra=_cleanFlexExtra(TS.model.flex_extra_in_url);var new_url;new_url=TS.utility.refashionUrlForUnreadView(window.location.href,TS.model.flex_name_in_url,flex_extra);if(!replace_history_state){if(!TS.model.unread_view_is_showing&&!TS.model.c_name_in_url)replace_history_state=true}_putURLInHistory(new_url,replace_history_state)}if(TS.model.unread_view_is_showing){TS.warn("not switching, unread view is already active");return false}if(TS.boot_data.feature_message_replies_threads_view){TS.client.threads.destroyThreadsView();TS.model.threads_view_is_showing=false}TS.model.unread_view_is_showing=true;TS.view.updateTitleWithContext();return true},threadsViewActivated:function(replace_history_state,no_history_add){if(!no_history_add){var flex_extra=_cleanFlexExtra(TS.model.flex_extra_in_url);var new_url=TS.utility.refashionUrlForThreadsView(window.location.href,TS.model.flex_name_in_url,flex_extra);if(!replace_history_state){if(!TS.model.threads_view_is_showing&&!TS.model.c_name_in_url)replace_history_state=true}_putURLInHistory(new_url,replace_history_state)}if(TS.model.threads_view_is_showing){TS.warn("not switching, threads view is already active");return false}if(TS.boot_data.feature_unread_view&&TS.client.unread.isEnabled()){TS.client.unread.destroyUnreadView();TS.model.unread_view_is_showing=false}TS.model.threads_view_is_showing=true;TS.view.updateTitleWithContext();return true},calculateInitialCid:function(){return _calculateInitialCid()},startCheckingForCleanup:function(){_startCheckingForCleanup()},complianceExportStartChanged:function(){_complianceExportStartChanged()},onFirstLoginMS:function(data){var did_init_enhanced_debugging=_maybeInitEnhancedDebugging();if(!did_init_enhanced_debugging){_maybeDetectBeachballsBasic()}TSConnLogger.log("first_rtm_start","TS.client logged in first time");_switchToInititalModelOb();setInterval(TS.client.markLastReadsWithAPI,5e3);_startCheckingForCleanup();TS.ms.connected_sig.add(_socketConnected);TS.channels.renamed_sig.add(_channelRenamed);TS.groups.renamed_sig.add(_groupRenamed);TS.members.changed_name_sig.add(_memberChangedName);TS.members.changed_account_type_sig.add(_memberAccountTypeChanged);TS.prefs.box_enabled_changed_sig.add(_boxEnabledChanged);TS.prefs.dropbox_enabled_changed_sig.add(_dropboxEnabledChanged);TS.prefs.compliance_export_start_changed_sig.add(_complianceExportStartChanged);TS.prefs.team_disallow_public_file_urls_changed_sig.add(_disallowPublicFileUrlsChanged);if(TS.model.team.prefs.compliance_export_start){_complianceExportStartChanged()}if(window.macgap&&!TS.model.prefs.no_macssb1_banner){TS.prefs.setPrefByAPI({name:"no_macssb1_banner",value:true})}if(window.macgap&&TS.model.mac_ssb_version&&TS.model.mac_ssb_version>=2&&!TS.model.prefs.no_macssb2_banner){TS.prefs.setPrefByAPI({name:"no_macssb2_banner",value:true})}if(window.winssb&&!TS.model.prefs.no_winssb1_banner){TS.prefs.setPrefByAPI({name:"no_winssb1_banner",value:true})}if(window.winssb&&TS.model.is_mac&&!TS.model.prefs.no_macssb1_banner){TS.prefs.setPrefByAPI({name:"no_macssb1_banner",value:true})}if(TS.qs_args["halt_at_loading_screen"]==1)throw new Error("Intentionally halting at loading screen");if(TS._incremental_boot){if(TS.client.ui&&TS.client.ui.$messages_input_container){TS.client.ui.$messages_input_container.addClass("recent-incremental-boot")}}$("#loading_welcome").transition({opacity:0},200,function(){$("#col_channels_bg").css("z-index",0);$("#loading-zone").transition({opacity:0},200,function(){$("body").removeClass("loading");TS.view.resizeManually("onFirstLoginMS");$("#loading-zone, #loading_zone_styles").remove();_maybeOpenModals()})});var model_ob=TS.shared.getActiveModelOb();var has_content=model_ob&&model_ob.msgs&&(model_ob.msgs.length>0||model_ob.latest===null);if(TS.client.archives.current_model_ob){}else if(has_content){TS.metrics.mark("content_visible");TS.metrics.measure("client_content_visible_4","start_nav","content_visible")}else if(model_ob){TS.client.ui.record_content_visible_metric_after_fetching_model_ob=model_ob.id}},onEveryLoginMS:function(data){var model_ob=TS.shared.getActiveModelOb();var controller=TS.shared.getControllerForModelOb(model_ob);var i;var should_defer_initial_msg_history=true;if(model_ob&&!model_ob.history_is_being_fetched){TS.shared.checkInitialMsgHistory(model_ob,controller)}if(!TS.model.ms_logged_in_once){TS.warn(new Date-TSConnLogger.start_time+"ms from first html to login_sig.dispatch()");TS.client.before_login_sig.dispatch();TS.client.login_sig.dispatch()}if(should_defer_initial_msg_history){if(TS.isPartiallyBooted()){if(data._incremental_boot_users_counts_resp){_users_counts_resp_from_incremental_boot=data._incremental_boot_users_counts_resp;_updateUnreadsWithUsersCountsResponse(_users_counts_resp_from_incremental_boot)}}else if(_users_counts_resp_from_incremental_boot){_updateUnreadsWithUsersCountsResponse(_users_counts_resp_from_incremental_boot);_users_counts_resp_from_incremental_boot=undefined}else{_fetchUnreadCountsFromApi()}}var im;for(i=0;i<TS.model.ims.length;i++){im=TS.model.ims[i];if(im.id==TS.model.active_im_id)continue;if(!im.is_open&&!TS.shared.hasUnreads(im))continue;TS.shared.checkInitialMsgHistory(im,TS.ims,should_defer_initial_msg_history)}var channels=TS.model.channels;var channel;for(i=0;i<channels.length;i++){channel=channels[i];if(channel.id==TS.model.active_channel_id)continue;if(!channel.is_member)continue;TS.shared.checkInitialMsgHistory(channel,TS.channels,should_defer_initial_msg_history)}var group;for(i=0;i<TS.model.groups.length;i++){group=TS.model.groups[i];if(group.id==TS.model.active_group_id)continue;if(group.is_archived)continue;TS.shared.checkInitialMsgHistory(group,TS.groups,should_defer_initial_msg_history)}var mpim;for(i=0;i<TS.model.mpims.length;i++){mpim=TS.model.mpims[i];if(mpim.id==TS.model.active_mpim_id)continue;if(mpim.is_archived)continue;if(!mpim.is_open&&!TS.shared.hasUnreads(mpim))continue;TS.shared.checkInitialMsgHistory(mpim,TS.mpims,should_defer_initial_msg_history)}},handleDeepLink:function(url){url=decodeURIComponent(url);TS.info("handleDeepLink url:"+url);if(!url)return;if(!url.indexOf)return;if(url.indexOf("://")==-1)return;if(url.indexOf("?")==-1)return;var A=url.split("?");var cmd=A[0].split("://")[1];TS.info("handleDeepLink cmd:"+cmd);if(!cmd)return;var qs=A[1];TS.info("handleDeepLink qs:"+qs);var qs_args=TS.utility.url.queryStringParse(qs);TS.info("handleDeepLink qs_args:"+JSON.stringify(qs_args,null,2));TS.client._handleParsedDeepLink(cmd,qs_args)},handleDeepLinkWithArgs:function(str){TS.info("handleDeepLinkWithArgs string:"+str);var dict=TS.utility.parseJSONOrElse(str,null);if(!dict)return;var cmd=dict.cmd;if(!cmd)return;delete dict.cmd;TS.client._handleParsedDeepLink(cmd,dict)},_handleParsedDeepLink:function(cmd,qs_args){if(!qs_args.team)return;if(qs_args.team!=TS.model.team.id){TS.generic_dialog.alert("You tried to perform an action on a team you're not yet logged into! Sorry, no can do :/");return}var id=qs_args.id;if(cmd=="channel"){var model_ob=TS.shared.getModelObById(id);if(!model_ob)return TS.error(id+" is not a recognized channel/dm/group");TS.client.ui.tryToJump(model_ob.id,qs_args.message);return}if(cmd=="user"){var member=TS.members.getMemberById(id);if(!member)return TS.error(id+" is not a recognized member");TS.client.ui.previewMember(id);var im=TS.ims.getImByMemberId(id);if(!im)return TS.error("Could not get im channel for user "+id);var model_ob=TS.shared.getModelObById(im.id);if(!model_ob)return TS.error(im+" is not a recognized dm");TS.client.ui.tryToJump(model_ob.id,qs_args.message);return}if(cmd=="file"){TS.client.ui.files.previewFile(id);return}if(cmd=="files"){}},apiPaused:function(info){var message;if(info.reason.API_ERROR){message='We’re having trouble connecting to Slack. We’ll try again shortly, or you can <a onclick="TS.ms.manualReconnectNow()">try now</a>.'}else if(info.reason.SERVICE_DOWN){message='Slack is unavailable, but don’t worry — we’re on the case. <a href="https://status.slack.com/">Check our status page</a> for updates.'}else if(info.reason.OFFLINE){message='Your computer seems to be offline. We’ll keep trying to reconnect, or you can <a onclick="TS.ms.manualReconnectNow()">try now</a>.'}if(TS.model.ms_logged_in_once){$("#connection_div").html(message).removeClass("hidden");TS.client.msg_pane.topMessagesBannerShown()}else{$("#loading_message_attribution").empty();$("#loading_message_attribution_img").remove();$("#loading_welcome_msg").html(message)}},apiUnpaused:function(){if(TS.model.ms_logged_in_once){$("#connection_div").html("").addClass("hidden");TS.client.msg_pane.topMessagesBannerHidden()}else{$("#loading_message_attribution").empty();$("#loading_message_attribution_img").remove();$("#loading_welcome_msg").html("Trying to log in again.")}},displayModelOb:function(model_ob){if(model_ob.presence){return TS.ims.startImByMemberId(model_ob.id)}else if(model_ob.is_im){return TS.ims.startImById(model_ob.id)}else if(model_ob.is_mpim){return TS.mpims.displayMpim(model_ob.id)}else if(model_ob.is_group){return TS.groups.displayGroup(model_ob.id)}else if(model_ob.is_channel){return TS.channels.displayChannel(model_ob.id)}},activateMsgRateLimit:function(args){if(TS.model.is_msg_rate_limited)return;if(!args)args={};TS.model.is_msg_rate_limited=true;if(args.notify_user){TS.client.ui.addEphemeralBotMsg({text:"_Avalanche!_ That's too many messages for Slack to handle — could you slow down just a bit?",ephemeral_type:"disconnected_feedback",slackbot_feels:"sad_surprise"})}},deactivateMsgRateLimit:function(){if(!TS.model.is_msg_rate_limited)return;TS.model.is_msg_rate_limited=false},userAddedToTeam:function(team_id){if(!TS.boot_data.feature_user_added_to_team)return;TS.info("You have been added to a team with the ID of "+team_id+".");if(!TS.model.is_our_app||!TS.model.is_electron)return;var signin_params={user_id:TS.model.user.id,enterprise_id:TS.model.enterprise.id,team_ids:team_id};if(!TS.shared.isRelevantTeam()){TS.info("This team is not relevant, ignoring user_added_to_team for "+team_id+".");return}TS.info("Attempting to sign in to team with ID of "+team_id,signin_params);var signedInTeamIDs=TSSSB.call("getSignedInTeamIds");if(!signedInTeamIDs||!signedInTeamIDs.length){TS.warn("WTF no signed-in team IDs from app?",signedInTeamIDs);return}if(signedInTeamIDs.indexOf(team_id)!==-1){TS.info("User is already signed into team "+team_id+". Exiting.");return}TS.info("calling enterprise.teams.signin for team_id = "+team_id,signin_params);TS.api.call("enterprise.teams.signin",signin_params).then(function(resp){var authed_teams=resp.data.teams;if(!authed_teams||!authed_teams.length){TS.warn("WTF no authed_teams from enterprise.teams.signin?");return}var app_params;_.each(authed_teams,function(item){if(item&&item.team_id==team_id){var url_root=document.domain.split(".").splice(1).join(".")+"/messages";app_params={name:TS.model.user.name,id:TS.model.user.id,team_id:team_id,team_name:item.team_name,team_url:"https://"+item.team_domain+"."+url_root}}});if(app_params){TS.info("calling TSSSB didSignIn with app_params",app_params);TSSSB.call("didSignIn",app_params)}else{TS.warn("WTF did not find matching authed team?",authed_teams)}})},userRemovedFromTeam:function(team_id){if(!TS.boot_data.feature_user_removed_from_team)return;if(team_id!==TS.model.team.id){TS.info("You have been removed from the team with ID = "+team_id+".");return}if(TS.model._user_removed_from_team)return;TS.model._user_removed_from_team=true;TS.generic_dialog.start({body:"<p>You have been removed from the <b>"+TS.utility.htmlEntities(TS.model.team.name)+" team.</p>",show_cancel_button:false,esc_for_ok:true,go_button_text:"OK",onGo:function(){if(TS.model.is_our_app){TS.info("calling TSSSB.signOutAndRemoveTeam because user_removed_from_team with team_id = "+team_id);TSSSB.signOutAndRemoveTeam(team_id)}else{TS.reload(null,"calling TS.reload() because of user_removed_from_team with team_id = "+team_id)}}})},activeChannelIsHidden:function(){return TS.model.unread_view_is_showing||TS.model.threads_view_is_showing}});var _users_counts_resp_from_incremental_boot;var _groupRenamed=function(group){if(group.id!=TS.model.active_group_id)return;if((TS.boot_data.feature_unread_view||TS.boot_data.feature_message_replies_threads_view)&&TS.client.activeChannelIsHidden())return;TS.client.channelDisplaySwitched(group.id,true)};var _channelRenamed=function(channel){if(channel.id!=TS.model.active_channel_id)return;if((TS.boot_data.feature_unread_view||TS.boot_data.feature_message_replies_threads_view)&&TS.client.activeChannelIsHidden())return;TS.client.channelDisplaySwitched(channel.id,true)};var _memberAccountTypeChanged=function(member){if(!member||member.id!=TS.model.user.id)return;var desc;if(member.is_ultra_restricted){desc=" You are now a single-channel guest of the team. "}else if(member.is_restricted){desc=" You are now a restricted member of the team. "}else{desc=" You are now a full member of the team. "}TS.generic_dialog.start({title:"Reload required",body:"<p>Your account permissions have changed!"+desc+"You must now reload for the changes to take effect.</p>",show_cancel_button:false,esc_for_ok:true,go_button_text:"Reload",onGo:function(){TS.reload()}})};var _memberChangedName=function(member){if(TS.model.active_im_id){var member_im=TS.ims.getImByMemberId(member.id);if(!member_im||member_im.id!=TS.model.active_im_id)return;TS.client.channelDisplaySwitched(member_im.id,true)}else if(TS.model.active_mpim_id){var mpim=TS.mpims.getMpimById(TS.model.active_mpim_id);if(!mpim||mpim.members.indexOf(member.id)===0)return;TS.client.channelDisplaySwitched(mpim.id,true)}};var _socketConnected=function(){TS.ims.checkForOldImsToClose();if(TS.shared){if(TS.pri)TS.log(58,"_socketConnected: calling TS.shared.maybeResetHistoryFetchedOnAll");TS.shared.maybeResetHistoryFetchedOnAll()}};var _maybeOpenModals=function(){var modal_to_open=TS.qs_args["open"];if(!modal_to_open)return;if(modal_to_open=="create_channel"){if(TS.model.ms_connected||TS.model.change_channels_when_offline){if(!TS.model.sorting_mode_is_showing){if(TS.permissions.members.canCreateChannels()||TS.members.canUserCreateGroups()){TS.ui.new_channel_modal.start()}}}}else if(modal_to_open=="invite_members"){if(TS.model.user.is_admin||!TS.model.team.prefs.invites_only_admins&&!TS.model.user.is_restricted){TS.ui.admin_invites.start()}}else if(modal_to_open=="notifications"){TS.ui.prefs_dialog.start("notifications")}else if(modal_to_open=="help"){TS.help_modal.start()}_putURLInHistory(TS.utility.url.removeUrlQueryStringValue(location.href,"open"),true)};var _dynamicallyLoadJS=function(id,app_key,url,error_msg){var script_node;var target_node;var js_id=id;var js=document.getElementById(js_id);var app_key_attr="data-app-key";if(js)return;target_node=document.getElementsByTagName("head");if(target_node&&target_node[0]){target_node=target_node[0]}else{target_node=document.body}script_node=document.createElement("script");script_node.setAttribute("async",true);if(app_key){script_node.setAttribute(app_key_attr,app_key)}script_node.id=js_id;script_node.src=url;if(target_node){target_node.appendChild(script_node)}else{if(TS.logError){TS.logError({message:error_msg},"No target_node for TS.client._dynamicallyLoadJS")}}};var _boxEnabledChanged=function(){if(window.BoxSelect||!TS.model.prefs.box_enabled||!boot_data.box_js_url)return;var id="boxjs";var app_key=boot_data.box_app_key;var url=boot_data.box_js_url;var error_msg="_boxEnabledChanged: Could not append box script node";_dynamicallyLoadJS(id,app_key,url,error_msg)};var _dropboxEnabledChanged=function(){if(window.Dropbox)return;if(!TS.model.prefs.dropbox_enabled)return;if(!boot_data.dropbox_js_url)return;var id="dropboxjs";var app_key=boot_data.dropbox_app_key;var url=boot_data.dropbox_js_url;var error_msg="_dropboxEnabledChanged: Could not append dropbox script node";_dynamicallyLoadJS(id,app_key,url,error_msg)};var _complianceExportStartChanged=function(){var model_ob;var member;var $show_when_enabled=$(".show_when_ce_enabled");var $show_when_disabled=$(".show_when_ce_disabled");var $js_compliance_export_start=$(".js_compliance_export_start");if(TS.model.team.prefs.compliance_export_start){$js_compliance_export_start.html(TS.utility.date.toDate(TS.model.team.prefs.compliance_export_start));$show_when_enabled.removeClass("hidden");$show_when_disabled.addClass("hidden")}else{$show_when_enabled.addClass("hidden");$show_when_disabled.removeClass("hidden")}model_ob=TS.shared.getActiveModelOb();if(!model_ob)return;member=TS.members.getMemberById(model_ob.user);if(!member)return;if(model_ob.is_im){$("#im_meta").html(TS.templates.dm_badge({member:member,im:model_ob,compliance_exports_enabled_for_team:!!TS.model.team.prefs.compliance_export_start}))}};var _disallowPublicFileUrlsChanged=function(){if(TS.model.team.prefs.disallow_public_file_urls){$(".file_public_link").remove();$("#file_public_link_revoker").remove()}};var _startCheckingForCleanup=function(){setInterval(function(){if(TS.model.ms_connected){TS.ims.checkForOldImsToClose()}TS.utility.msgs.checkForMsgsToTruncate()},1e3*60*15)};var _onPopState=function(e){if(TS.ui.fs_modal.is_showing){TS.ui.fs_modal.close()}var loc=history.location||document.location;TS.qs_args=TS.utility.url.queryStringParse(loc.search.substring(1));var is_unread_view=TS.boot_data.feature_unread_view&&TS.utility.isUnreadViewPath(loc.pathname);var is_threads_view=TS.boot_data.feature_message_replies_threads_view&&TS.utility.isThreadsViewPath(loc.pathname);var flex_name=TS.utility.getFlexNameFromUrl(loc.href);var flex_extra=TS.utility.getFlexExtraFromUrl(loc.href);if(TS.model.prefs.no_flex_in_history){if((TS.boot_data.feature_unread_view||TS.boot_data.feature_message_replies_threads_view)&&!is_unread_view&&!is_threads_view&&!TS.model.ui_state.flex_name&&TS.model.ui_state.details_tab_active){flex_name="details";flex_extra=""}else{flex_name=TS.model.ui_state.flex_name;flex_extra=TS.model.ui_state.flex_extra}}if((is_unread_view||is_threads_view)&&flex_name==="details"){flex_name="";flex_extra=""}var c_name=TS.utility.getChannelNameFromUrl(loc.href);var cA=c_name.split(":");c_name=cA[0];var c_extra=cA.length>1?cA[1]:"";TS.info("_onPopState"+"\nc_name from new url:"+c_name+"\nc_extra from new url:"+c_extra+"\nflex_name from new url:"+flex_name+"\nflex_extra from new url:"+flex_extra);if(!TS.boot_data.feature_message_replies)TS.client.ui.flex.setFlexStateFromHistory(flex_name,flex_extra);if(!TS.model.channels)return;var c_id;var im;var model_ob;var channel;var group;var mpim;var is_good=false;if(TS.boot_data.feature_name_tagging_client){model_ob=TS.shared.getModelObById(c_name);if(model_ob){c_id=model_ob.id;if(model_ob.is_im){im=model_ob}else if(model_ob.is_mpim){mpim=model_ob}else if(model_ob.is_channel){channel=model_ob}else if(model_ob.is_group){group=model_ob}}}if(!c_id&&c_name){channel=TS.channels.getChannelByName(c_name);if(channel){c_id=channel.id}else if(c_name.indexOf("@")!=-1){im=TS.ims.getImByUsername(c_name);if(im){c_id=im.id}}if(!c_id){group=TS.groups.getGroupByName(c_name);if(group){c_id=group.id}}if(!c_id){mpim=TS.mpims.getMpimByName(c_name);if(mpim&&mpim.is_open)c_id=mpim.id}}if(c_id){is_good=true;TS.info("c_name from new url is good:"+c_name+" "+c_id)}else if(!is_unread_view&&!is_threads_view){if(TS.model.channels.length){channel=TS.channels.getFirstChannelYouAreIn();if(channel){c_id=channel.id;TS.info("got getFirstChannelYouAreIn:"+c_id)}}if(!c_id&&TS.model.ims.length){im=TS.ims.getFirstOpenIm();if(im){c_id=im.id;TS.info("got getFirstOpenIm:"+c_id)}}}if(im){TS.ims.startImByMemberId(im.user,true)}else if(channel){TS.channels.displayChannel(channel.id,null,true,!is_good)}else if(group){TS.groups.displayGroup(group.id,null,true,!is_good)}else if(mpim){TS.mpims.displayMpim(mpim.id,null,true,!is_good)}else if(is_unread_view){TS.client.unread.showUnreadView(true,true)}else if(is_threads_view){TS.client.threads.showThreadsView(true,true)}else{TS.error("WTF DONT KNOW WHAT TO DO")}if(TS.boot_data.feature_message_replies)TS.client.ui.flex.setFlexStateFromHistory(flex_name,flex_extra);if(TS.model.prefs.no_flex_in_history){var new_url;if(is_unread_view){new_url=TS.utility.refashionUrlForUnreadView(window.location.href,flex_name,flex_extra)}else if(is_threads_view){new_url=TS.utility.refashionUrlForThreadsView(window.location.href,flex_name,flex_extra)}else{new_url=TS.utility.refashionUrl(window.location.href,c_name,flex_name,flex_extra)}var replace_history_state=true;_putURLInHistory(new_url,replace_history_state)}};var _switchToInititalModelOb=function(){if(!TS.model.initial_cid){TS.error("TS.model.initial_cid was empty when _switchToInititalModelOb was called, which should be impossible");return}var model_ob=TS.shared.getModelObById(TS.model.initial_cid);if(!model_ob){TS.error("TS.model.initial_cid ("+TS.model.initial_cid+") referred to a channel that does not exist in _switchToInititalModelOb, which should be impossible")}var replace_history_state=true;if(model_ob.is_channel){TS.client.channelDisplaySwitched(model_ob.id,replace_history_state)}else if(model_ob.is_im){if(model_ob.is_open){TS.client.channelDisplaySwitched(model_ob.id,replace_history_state)}else{TS.ims.startImByMemberId(model_ob.user,replace_history_state)}}else if(model_ob.is_mpim){TS.mpims.displayMpim(model_ob.id,null,false,replace_history_state)}else if(model_ob.is_group&&!model_ob.is_mpim){TS.groups.displayGroup(model_ob.id,null,false,replace_history_state)}if(TS.model.initial_unread_view&&TS.model.prefs.enable_unread_view){var direct_from_boot=true;TS.client.unread.showUnreadView(false,replace_history_state,direct_from_boot)}if(TS.model.initial_threads_view){TS.client.threads.showThreadsView(false,replace_history_state)}};var _cleanFlexExtra=function(flex_extra){if(!flex_extra)return flex_extra;
if(flex_extra.indexOf("#")!=-1){flex_extra=flex_extra.replace(/\#/g,"%23")}if(flex_extra.indexOf("/")!=-1){flex_extra=flex_extra.replace(/\//g,"%252F")}return flex_extra};var _putURLInHistory=function(new_url,replace_history_state){if(!history.pushState){TS.warn("This browser does not support pushState.");return}if(replace_history_state){if(window.location.href.replace(/\%20/g," ")==new_url.replace(/\%20/g," ")){}else{window.history.replaceState(null,null,new_url)}}else{if(window.location.href.replace(/\%20/g," ")==new_url.replace(/\%20/g," ")){}else{window.history.pushState(null,null,new_url)}}};var _calculateInitialCid=function(){var history=TS.storage.fetchActiveHistory();var c_id;var i;var channel;var group;var im;var mpim;var model_ob;var maybeSetWelcomeChannelToSlackbot=function(){if(TS.model.welcome_model_ob&&TS.model.welcome_model_ob.id)return;var slackbot=TS.ims.getImByMemberId("USLACKBOT");if(slackbot){TS.model.welcome_model_ob=slackbot}else{TS.error("Tried to lookup Slackbot but failed");TS.generic_dialog.alert("Slack has encountered a problem and needs to reload.","Reload required","Reload").then(TS.reload)}};if(!window.location.pathname.match(/^\/(message|unreads|threads)/)&&window.history){window.history.replaceState(null,null,window.location.origin+"/messages")}maybeSetWelcomeChannelToSlackbot();for(i=0;i<history.length;i++){c_id=history[i];if(TS.model.active_history.indexOf(c_id)>-1)continue;model_ob=TS.shared.getModelObById(c_id);if(!model_ob)continue;if(model_ob.is_channel&&!model_ob.is_archived&&!TS.model.user.is_restricted){TS.model.active_history.push(c_id)}else if(model_ob.is_im&&model_ob.is_open){TS.model.active_history.push(c_id)}else if(model_ob.is_mpim&&model_ob.is_open){TS.model.active_history.push(c_id)}else if(model_ob.is_group&&!model_ob.is_archived){TS.model.active_history.push(c_id)}}var c_name=TS.model.c_name_in_url=TS.utility.getChannelNameFromUrl(location.href);var unread_view=TS.boot_data.feature_unread_view&&TS.utility.isUnreadViewPath(location.pathname);var threads_view=TS.boot_data.feature_message_replies_threads_view&&TS.utility.isThreadsViewPath(location.pathname);if(unread_view)TS.model.initial_unread_view=true;if(threads_view)TS.model.initial_threads_view=true;var getInitialChannelId=function(){if(c_name){channel=TS.channels.getChannelByName(c_name);if(channel)return channel.id;im=TS.ims.getImByUsername(c_name);if(im)return im.id;group=TS.groups.getGroupByName(c_name);if(group)return group.id;mpim=TS.mpims.getMpimByName(c_name);if(mpim)return mpim.id}if(TS.model.active_history.length){c_id=TS.model.active_history[TS.model.active_history.length-1];model_ob=TS.shared.getModelObById(c_id);if(model_ob)return c_id}if(TS.model.user.is_restricted){var channels=TS.model.channels;channels.sort(function(a,b){return a._name_lc>b._name_lc?1:b._name_lc>a._name_lc?-1:0});for(i=0;i<channels.length;i++){channel=channels[i];if(channel.is_archived)continue;if(!channel.is_member)continue;return channel.id}var groups=TS.model.groups;groups.sort(function(a,b){return a._name_lc>b._name_lc?1:b._name_lc>a._name_lc?-1:0});for(i=0;i<groups.length;i++){group=groups[i];if(groups.is_archived)continue;return group.id}var slack_bot_im=TS.ims.getImByMemberId("USLACKBOT");if(slack_bot_im)return slack_bot_im.id}else{if(TS.model.user.is_primary_owner&&!TS.model.prefs.newxp_seen_last_message){var slack_bot_im=TS.ims.getImByMemberId("USLACKBOT");if(slack_bot_im)return slack_bot_im.id}var general=TS.channels.getGeneralChannel();if(general)return general.id}alert("ERROR could not find starting channel")};TS.model.initial_cid=getInitialChannelId()};var _updateUnreadCounts=function(count_infos,model_ob_fetcher){var controller;count_infos.forEach(function(count_info){var model_ob=model_ob_fetcher(count_info);if(!model_ob){TS.warn("users.counts returned data for a model_ob we don't know about",count_info.id);return}if(model_ob.is_archived&&!model_ob.is_member){if(TS.pri)TS.log(58,'ignoring users.counts response for "'+model_ob.id+'" "'+model_ob.name+'" because is_archived and !is_member');return}controller=controller||TS.shared.getControllerForModelOb(model_ob);model_ob._latest_via_users_counts=count_info.latest;if(TS.boot_data.feature_wait_for_all_mentions_in_client)model_ob._mention_count_display_via_users_counts=count_info.mention_count_display;model_ob._users_counts_info=count_info;var model_prev_unread_cnt=parseInt(model_ob.unread_cnt,10);var model_prev_highlight_cnt=parseInt(model_ob.unread_highlight_cnt,10);var min_unread_cnt=count_info.has_unreads?1:0;var is_im=model_ob.is_im||model_ob.is_mpim;if(is_im){model_ob.unread_cnt=count_info.unread_count_display||count_info.dm_count||min_unread_cnt}else{if(min_unread_cnt){model_ob.unread_cnt=Math.max(model_ob.unread_cnt,count_info.unread_count_display||count_info.dm_count||min_unread_cnt)}else{model_ob.unread_cnt=count_info.unread_count_display||count_info.dm_count||min_unread_cnt}model_ob.unread_highlight_cnt=count_info.mention_count_display||0}var is_im=model_ob.is_im||model_ob.is_mpim;var is_muted=TS.notifs.isCorGMuted(model_ob.id);var and_mark=false;if(!controller){TS.warn("Unable to figure out controller for model_ob with id="+model_ob.id);return}if(model_ob.msgs.length&&(model_ob.unread_cnt!==model_prev_unread_cnt||model_ob.unread_highlight_cnt!==model_prev_highlight_cnt)){if(TS.pri)TS.log(58,'msgs exist, calculating unreads for "'+model_ob.id+'" "'+model_ob.name+'"');controller.calcUnreadCnts(model_ob,and_mark)}if(model_ob.unread_cnt!==model_prev_unread_cnt&&!is_muted){if(TS.pri)TS.log(58,'unread count has changed for "'+model_ob.id+'" "'+model_ob.name+'", from '+model_prev_unread_cnt+" to "+model_ob.unread_cnt);controller.unread_changed_sig.dispatch(model_ob)}if(model_ob.unread_highlight_cnt!==model_prev_highlight_cnt){if(TS.pri)TS.log(58,'unread highlight count has changed for "'+model_ob.id+'" "'+model_ob.name+'", from '+model_prev_highlight_cnt+" to "+model_ob.unread_highlight_cnt);controller.unread_highlight_changed_sig.dispatch(model_ob)}if(is_muted){if(!model_ob.unread_highlight_cnt){model_ob.unread_cnt=0;controller.markMostRecentReadMsg(model_ob,TS.model.marked_reasons.none_qualify)}model_ob._show_in_list_even_though_no_unreads=true;if(TS.pri)TS.log(58,"we have a muted channel: #"+model_ob.name);if(TS.model.prefs.sidebar_behavior=="hide_read_channels"){if(TS.pri)TS.log(58,"user pref is to HIDE READ CHANNELS");if(!model_ob.unread_cnt&&!model_ob.unread_highlight_cnt){if(TS.pri)TS.log(58,"#"+model_ob.name+" has no unreads");if(model_ob.id==TS.model.active_cid){if(TS.pri)TS.log(58,"#"+model_ob.name+" is currently being viewed. showing even though no unreads.");model_ob._show_in_list_even_though_no_unreads=true}else{if(TS.pri)TS.log(58,"#"+model_ob.name+" is not the active channel. no unreads, can be hidden.");model_ob._show_in_list_even_though_no_unreads=false}}else{if(TS.pri)TS.log(58,"#"+model_ob.name+" has unreads.");model_ob._show_in_list_even_though_no_unreads=false}}else if(TS.model.prefs.sidebar_behavior=="hide_read_channels_unless_starred"){if(TS.pri)TS.log(58,"user pref is to HIDE READ CHANNELS UNLESS STARRED");if(!model_ob.unread_cnt&&!model_ob.unread_highlight_cnt){if(TS.pri)TS.log(58,"#"+model_ob.name+" has no unreads");if(model_ob.is_starred){if(TS.pri)TS.log(58,"#"+model_ob.name+" IS STARRED - showing even though no unreads.");model_ob._show_in_list_even_though_no_unreads=true}else{if(model_ob.id==TS.model.active_cid){if(TS.pri)TS.log(58,"#"+model_ob.name+" is currently being viewed. showing even though no unreads.");model_ob._show_in_list_even_though_no_unreads=true}else{if(TS.pri)TS.log(58,"#"+model_ob.name+" is not the active channel. no unreads, can be hidden.");model_ob._show_in_list_even_though_no_unreads=false}}}else{if(TS.pri)TS.log(58,"#"+model_ob.name+" has unreads.");model_ob._show_in_list_even_though_no_unreads=false}}if(is_muted&&!model_ob.unread_highlight_cnt)TS.shared.maybeMarkReadIfMuted(model_ob,controller)}if(model_ob.unread_cnt||model_ob.unread_highlight_cnt){if(!TS.client.history_prefetch){TS.warn("WTF no TS.client.history_prefetch module?");return}TS.client.history_prefetch.addToHistoryFetchQueue(model_ob.id)}})};var _fetchUnreadCountsFromApi=function(){var args={mpim_aware:true,only_relevant_ims:true,simple_unreads:true};if(TS.boot_data.feature_message_replies_threads_view)args.include_threads=true;TS.api.callImmediately("users.counts",args).then(_updateUnreadsWithUsersCountsResponse)};var _updateUnreadsWithUsersCountsResponse=function(resp){if(TS.client.history_prefetch)TS.client.history_prefetch.resetHistoryFetchQueue();_updateUnreadCounts(resp.data.channels,function(count_info){return TS.channels.getChannelById(count_info.id)||TS.groups.getGroupById(count_info.id)});_updateUnreadCounts(resp.data.groups,function(count_info){if(count_info.is_mpim){return TS.mpims.getMpimById(count_info.id)}else{return TS.groups.getGroupById(count_info.id)}});_updateUnreadCounts(resp.data.ims,function(count_info){return TS.ims.getImById(count_info.id)});_updateUnreadCounts(resp.data.mpims,function(count_info){if(count_info.is_mpim){return TS.mpims.getMpimById(count_info.id)}});if(TS.boot_data.feature_message_replies_threads_view){var threads=resp.data.threads;if(threads)TS.client.threads.setThreadsUnreadData(threads.has_unreads,threads.mention_count)}if(TS.client.history_prefetch)TS.client.history_prefetch.processHistoryFetchQueue();return null};var _enhanced_debugging_enabled;function _detectBeachballsBasic(){if(!_.isFunction(window.requestAnimationFrame)){TS.warn("Unable to install beachball detector without requestAnimationFrame");return}var MAX_INTERVAL=1e3;var last_raf_handler_time=performance.now();var raf_handler=function(){var now=performance.now();var interval=now-last_raf_handler_time;last_raf_handler_time=now;if(interval>MAX_INTERVAL){TS.metrics.count("beachballs")}requestAnimationFrame(raf_handler)};requestAnimationFrame(raf_handler)}function _detectBeachballsAdvanced(){if(!_.isFunction(window.requestAnimationFrame)){TS.warn("Enhanced debugging: unable to install beachball detector without requestAnimationFrame");return}TS.info("Enhanced debugging: installing beachball detector");var log_buffer=[];var _console_inner=TS.replaceConsoleFunction(function(type,pri,args){var msg=_.toArray(args).slice(1).join(" ");log_buffer.push({type:type,pri:pri,msg:msg,time:performance.now()});return _console_inner.apply(window,arguments)});var MAX_DURATION_COUNT=60;var MAX_INTERVAL_VARIANCE_RATIO=4;var raf_interval_duration_history=[];var last_raf_handler_time=performance.now();var raf_handler=function(){var now=performance.now();var interval=now-last_raf_handler_time;var prev_raf_handler_time=last_raf_handler_time;last_raf_handler_time=now;raf_interval_duration_history.push(interval);if(raf_interval_duration_history.length>MAX_DURATION_COUNT){raf_interval_duration_history.shift()}requestAnimationFrame(raf_handler);if(raf_interval_duration_history.length<MAX_DURATION_COUNT){log_buffer.length=0;return}var average_interval=_.sum(raf_interval_duration_history)/raf_interval_duration_history.length;if(interval>MAX_INTERVAL_VARIANCE_RATIO*average_interval){console.log("========");console.log("Enhanced debugging: slowness detected");console.log("Current time: "+now+"; previous frame was at "+prev_raf_handler_time);console.log("Last frame took: "+Math.round(interval)+" ms");console.log("Average frame takes: "+Math.round(average_interval)+" ms");if(log_buffer.length){console.log("Begin logs since last healthy tick:");log_buffer.forEach(function(log){var time=log.time-prev_raf_handler_time;var time_formatted="["+_.padStart(Math.floor(time),5," ")+"]";var pri=log.pri?" ("+log.pri+")":"";console.log(time_formatted+" "+log.type+pri+": "+log.msg)});console.log("End logs since last healthy tick")}else{console.log("(No logs captured, sorry)")}console.log("========")}log_buffer.length=0};requestAnimationFrame(raf_handler)}var _addJSONInstrumentation=function(){if(JSON._shimmed)return;JSON._shimmed=true;var _json_parse=JSON.parse;JSON.parse=function(str){var t_0=performance.now();var out=_json_parse.apply(this,arguments);var duration=performance.now()-t_0;if(duration>1){TS.info("JSON parsing: "+_.toString(str).length+" bytes took "+_.round(duration,2)+" ms")}return out};var _json_stringify=JSON.stringify;JSON.stringify=function(){var t_0=performance.now();var out=_json_stringify.apply(this,arguments);var duration=performance.now()-t_0;if(duration>1){TS.info("JSON stringify into "+out.length+" bytes took "+_.round(duration,2)+" ms")}return out}};var _maybeDetectBeachballsBasic=function(){var percentage=10;if(TS.utility.enableFeatureForUser(percentage)){_detectBeachballsBasic()}};var _maybeInitEnhancedDebugging=function(){_enhanced_debugging_enabled=TS.client&&(TS.qs_args.enhanced_debugging||TS.model.prefs.enhanced_debugging);if(TS.qs_args.enhanced_debugging==="0"){_enhanced_debugging_enabled=false}if(!_enhanced_debugging_enabled)return false;_detectBeachballsAdvanced();_addJSONInstrumentation();_watchSleepWake();return true};var _watchSleepWake=function(){if(!TS.model.is_our_app)return;var post_sleep_tick_timer;var post_wake_stop_tick_timer;var stop_delay_secs=300;window.addEventListener("sleep",function(){if(post_sleep_tick_timer)return;post_sleep_tick_timer=setInterval(function(){TS.info("Debug tick")},1e3)},false);window.addEventListener("wake",function(){if(post_wake_stop_tick_timer)return;TS.info("Will stop debug ticking in "+stop_delay_secs+" seconds");post_wake_stop_tick_timer=setTimeout(function(){clearTimeout(post_sleep_tick_timer);post_wake_stop_tick_timer=undefined;post_sleep_tick_timer=undefined;TS.info("Stopping debug ticking")},stop_delay_secs*1e3)},false)}})();(function(){"use strict";TS.registerModule("view",{file_list_heading:"All File Types",file_list_lazyload:null,members_list_lazyload:null,user_groups_members_list_lazyload:null,member_stars_list_lazyload:null,last_attachment_max_width:null,resize_sig:new signals.Signal,onStart:function(){TS.view.rebuildMentionsImmediately=TS.view.rebuildMentions;TS.view.rebuildMentions=TS.utility.throttleFunc(TS.view.rebuildMentions,1e3,true);TS.view.rebuildTeamList=TS.utility.throttleFunc(TS.view.rebuildTeamListThrottled,1e3,true);TS.view.maybeRebuildUserGroupList=TS.utility.throttleFunc(TS.view.rebuildUserGroupList,1e3);TS.client.login_sig.add(function(){TS.utility.queueRAF(TS.view.loggedIn)},TS.view);TS.channels.read_only.list_updated_sig.add(TS.view.checkIfInputShouldBeDisabledAndPopulate);TS.user_groups.updated_sig.add(TS.view.userGroupUpdated,TS.view);TS.members.view.team_filter_changed_sig.add(function(){TS.view.maybeRebuildUserGroupList()},TS.view);TS.bots.added_sig.add(TS.view.botChanged,TS.view);TS.bots.changed_name_sig.add(TS.view.botChanged,TS.view);TS.bots.changed_icons_sig.add(TS.view.botChanged,TS.view);TS.bots.changed_during_bulk_upsert_sig.add(TS.view.botChanged,TS.view);TS.ui.window_unloaded_sig.add(TS.view.windowUnloaded,TS.view);TS.client.flexpane_display_switched_sig.add(TS.view.flexpaneDisplaySwitched,TS.view);TS.client.ui.file_dropped_sig.add(TS.view.filesDropped);TS.client.ui.file_pasted_sig.add(TS.view.filePasted);TS.team.team_plan_changed_sig.add(TS.view.teamPlanChanged,TS.view);TS.team.team_profile_changed_sig.add(TS.view.teamProfileChanged,TS.view);TS.mentions.mentions_fetched_sig.add(TS.view.mentionsFetched,TS.view);TS.mentions.mention_changed_sig.add(TS.view.mentionChanged,TS.view);TS.mentions.mention_removed_sig.add(TS.view.mentionRemoved,TS.view);TS.mentions.mentions_being_fetched_sig.add(TS.view.mentionsBeingFetched,TS.view);TS.prefs.a11y_font_size_changed_sig.add(TS.view.resetUI,TS.view);if(TS.boot_data.feature_sli_channel_priority){TS.prefs.channel_sort_changed_sig.add(TS.view.resize)}if(TS.boot_data.feature_unread_view){TS.prefs.enable_unread_view_changed_sig.add(TS.view.resize)}TS.prefs.team_disable_file_editing_changed_sig.add(TS.view.rebuildMsgFile);TS.view.resizeManually("TS.view.onStart");$(window).resize(TS.view.onResize);if(TS.qs_args["new_scroll"]!="0"){var debug=TS.qs_args["debug_scroll"]=="1";if(!TS.environment.supports_custom_scrollbar){TS.client.ui.$msgs_scroller_div.monkeyScroll({debug:debug,always_show:true,no_gutter:true})}if(!TS.environment.supports_custom_scrollbar){$(".flex_content_scroller").monkeyScroll({debug:debug});TS.client.channel_pane.$scroller.monkeyScroll({debug:debug})}}TS.view.ms.changeConnectionStatus("trouble");$("a.clear_unread_messages").tooltip({placement:"bottom",delay:{show:500,hide:150}});$(".channels_list_new_btn").tooltip({container:"body",delay:{show:400,hide:150}});$(".channel_list_header_label, #direct_messages_header").tooltip({placement:"top-left",container:"body",delay:{show:400,hide:150}});TS.view.cached_wh=0;TS.view.resizeManually("TS.view.onStart 2");var mouseup_bound=false;$(window).bind("scroll",function(e){if(mouseup_bound)return;mouseup_bound=true;$(window).unbind("mouseup.scroll").bind("mouseup.scroll",function(e){mouseup_bound=false;$(window).unbind("mouseup.scroll");$("body").scrollTop(0)})});if(TS.model.is_mac)$("#drag_drop_mac_key").text("Command");var percentage=10;_log_resize_duration=TS.utility.enableFeatureForUser(percentage);$("#stars_scroller").on("click.fetchUserStarredItems",".flexpane_load_more_btn",function(e){var $btn=$(this);if(!$btn.data("ladda"))$btn.data("ladda",Ladda.create(this));$btn.data("ladda").start();TS.stars.fetchUserStarredItems().finally(function(){$btn.data("ladda").stop()})})},was_at_bottom_at_first_resize_event:false,resize_tim:0,onResize:function(){if(!TS.view.triggering_resize){TS.view.cached_wh=0}TS.model.ui.cached_file_preview_scroller_rect=null;TS.model.ui.cached_msgs_scroller_rect=null;TS.model.ui.cached_msgs_scroll_result=null;TS.model.ui.cached_search_scroller_rect=null;TS.model.ui.cached_channels_scroller_rect=null;TS.model.ui.cached_archives_scroller_rect=null;TS.model.ui.cached_archive_scroll_result=null;TS.model.ui.cached_convo_scroller_rect=null;TS.model.ui.cached_unread_scroller_rect=null;TS.model.ui.cached_threads_scroller_rect=null;if(TS.view.resize_tim){clearTimeout(TS.view.resize_tim);TS.view.resize_tim=0}else{TS.view.was_at_bottom_at_first_resize_event=TS.client.ui.areMsgsScrolledToBottom(50)}TS.view.resize_tim=setTimeout(function(){clearTimeout(TS.view.resize_tim);TS.view.resize_tim=0;if(TS.view.should_reset_input)TS.view.resetForInput();TS.view.resize(true);TS.view.should_reset_input=false},250);if(TS.view.triggering_resize)return;TS.view.resize(false,true)},team_menu_h:$("#team_menu").outerHeight(),cached_wh:0,last_msgs_div_width:0,last_input_height:0,last_preview_height:0,last_preview_height_changed:0,last_input_container_height:0,msgs_scroller_y:-1,footer_outer_h:-1,default_col_flex_top:-1,triggering_resize:false,resizeManually:function(why,no_scroll_to_bottom){if(TS.boot_data.feature_defer_client_bind_ui&&!TS.model.ms_logged_in_once)return;why=why||"unspecified";TS.log(389,"======================================resizeManually ("+why+") starting");var start=Date.now();TS.view.resize(false,false,!!no_scroll_to_bottom);TS.log(389,"======================================resizeManually ("+why+") took "+(Date.now()-start)+"ms")},setFlexMenuSize:function(){$("#menu_items_scroller").css("max-height",TS.view.cached_wh-99);TS.ui.utility.updateClosestMonkeyScroller($("#menu_items_scroller"))},resetUI:function(){TS.view.resetForFlexpane();TS.view.should_reset_input=true},resetForInput:function(){TS.view.cached_wh=0;TS.view.last_input_height=0;TS.view.last_preview_height=0;TS.view.last_preview_height_changed=0;TS.view.last_input_container_height=0;TS.view.msgs_scroller_y=-1;TS.view.footer_outer_h=-1},resetForFlexpane:function(){TS.view.default_col_flex_top=-1;$("#col_flex").css("top","")},resizeForBanner:function(why){TS.view.msgs_scroller_y=-1;TS.view.resizeManually(why);var $html=$("html");$html.height($html.height());TS.utility.rAF(function(){$html.height("")})},resize:function(from_timer,no_trigger,no_scroll_to_bottom){if(_log_resize_duration){var start_mark="start_resize";TS.metrics.mark(start_mark)}var start=Date.now();TS.log(389,start+" #1 cached_wh:"+TS.view.cached_wh+" TS.view.resize from_timer:"+from_timer+" no_trigger:"+no_trigger+" "+(Date.now()-start)+"ms");start=Date.now();var was_at_bottom=TS.client.ui.areMsgsScrolledToBottom(50);TS.log(389,start+" #2 "+(Date.now()-start)+"ms");start=Date.now();var wh_changed=TS.view.cached_wh===0;var wh=TS.view.cached_wh=TS.view.cached_wh||$(window).height();if(TS.view.msgs_scroller_y==-1){TS.view.msgs_scroller_y=$("#client_body").offset().top}if(TS.view.footer_outer_h==-1){TS.view.footer_outer_h=$("#footer").outerHeight()}if(TS.view.default_col_flex_top==-1){TS.view.default_col_flex_top=parseInt($("#col_flex").css("top"));if(TS.model.is_electron&&TS.model.is_mac&&TSSSB.call("isMainWindowFrameless")){TS.view.default_col_flex_top+=10}}var banner_h=TS.client.ui.$banner.hasClass("hidden")?0:parseInt(TS.client.ui.$banner.css("height"));if(!TS.boot_data.feature_flexbox_client){if(banner_h){$("#col_flex").css("top",TS.view.default_col_flex_top+banner_h)}else{$("#col_flex").css("top",TS.view.default_col_flex_top)}}if(TS.model.menu_is_showing)TS.view.setFlexMenuSize();if(wh_changed||!!TS.view.last_input_height){if(TS.model.prefs&&TS.model.prefs.msg_preview){TS.view.measureMsgPreview()}if(!TS.view.last_input_height||TS.view.last_preview_height_changed){TS.view.measureInput()}if(!TS.boot_data.feature_new_msg_input){$("#message-form").css("height",TS.view.last_input_height)}if(TS.boot_data.feature_new_msg_input){var msgs_scroller_height=wh-TS.view.msgs_scroller_y-TS.view.footer_outer_h;TS.client.ui.$msgs_scroller_div.css("height",msgs_scroller_height)}else{var msgs_scroller_height=wh-TS.view.msgs_scroller_y-TS.view.last_input_container_height-22*TS.utility.getA11yFontSizeMultiplier();TS.client.ui.$msgs_scroller_div.css("height",msgs_scroller_height)}if(TS.model.archive_view_is_showing){if(TS.client.archives.not_member){msgs_scroller_height=wh-(TS.view.msgs_scroller_y+$("#footer_archives").outerHeight())}TS.client.archives.$scroller.css("height",msgs_scroller_height)}var flex_contents_height=wh-TS.view.msgs_scroller_y;$("#flex_contents > .panel").css("height",flex_contents_height);_setChannelsScrollerHeight(wh,banner_h);$("#archives_return").css("top",msgs_scroller_height-25*TS.utility.getA11yFontSizeMultiplier())}TS.log(389,start+" #10 "+(Date.now()-start)+"ms");start=Date.now();if(true||wh_changed||TS.view.never_set){$(".flex_content_scroller").each(function(){var $this=$(this);if(!$this.closest(".panel").hasClass("active"))return;TS.view.never_set=false;var flex_scroller_y=$this.offset().top;var flex_scroller_height=wh-flex_scroller_y;$this.css("height",flex_scroller_height)})}TS.log(389,start+" #11 wh_changed:"+wh_changed+" "+(Date.now()-start)+"ms");start=Date.now();TS.utility.queueRAF(TS.client.msg_pane.padOutMsgsScroller);TS.utility.queueRAF(TS.client.archives.padOutMsgsScroller);if(!no_scroll_to_bottom&&(was_at_bottom||TS.view.was_at_bottom_at_first_resize_event)){var model_ob=TS.shared.getActiveModelOb();if(model_ob){if(TS.model.prefs&&TS.model.prefs.start_scroll_at_oldest){if(model_ob.unread_cnt&&(model_ob.scroll_top==-1||model_ob.scroll_top===undefined)&&TS.client.ui.$msgs_unread_divider&&!TS.client.ui.$msgs_unread_divider.hasClass("no_unreads")){if(TS.client.msg_pane.dont_check_unreads_til_switch){if(TS.pri)TS.log(888,"view resize: NOT scrolling despite unread AND start_scroll_at_oldest AND scroll_top == -1 or undefined (actual value: "+model_ob.scroll_top+"), because _has_auto_scrolled is true.");if(was_at_bottom){if(TS.pri)TS.log(888,"view resize: was at bottom, so insta-scrolling to bottom.");TS.utility.queueRAF(TS.client.ui.instaScrollMsgsToBottom)}else{if(TS.pri)TS.log(888,"view resize: was NOT scrolled to bottom before resize, so not doing anything.")}}else{if(model_ob._has_auto_scrolled){if(TS.pri)TS.log(888,"view resize: NOT scrolling first unread into view despite unread AND start_scroll_at_oldest AND scroll_top == -1 or undefined (actual value: "+model_ob.scroll_top+"), because _has_auto_scrolled is true.")}else{if(TS.pri)TS.log(888,"view resize: scrolling first unread into view because unread AND start_scroll_at_oldest AND scroll_top == -1 or undefined (actual value: "+model_ob.scroll_top+")");TS.client.ui.scrollMsgsSoFirstUnreadMsgIsInView()}}}else{if(was_at_bottom){if(TS.pri)TS.log(888,"view resize: insta-scrolling to bottom because was_at_bottom, AND, !unread_cnt ("+model_ob.unread_cnt+") OR scroll_top ("+model_ob.scroll_top+") OR !TS.client.ui.$msgs_unread_divider ("+TS.client.ui.$msgs_unread_divider+") OR $msg_unread_divider has .no_unreads ("+(TS.client.ui.$msgs_unread_divider?TS.client.ui.$msgs_unread_divider.hasClass("no_unreads"):"undefined")+")");TS.utility.queueRAF(TS.client.ui.instaScrollMsgsToBottom)}}}else{TS.utility.queueRAF(TS.client.ui.instaScrollMsgsToBottom)}}}if(from_timer){TS.view.was_at_bottom_at_first_resize_event=false}else if(!no_trigger){TS.view.triggering_resize=true;$(window).trigger("resize");TS.view.triggering_resize=false}TS.client.ui.checkUnseenChannelsImsGroupsWithUnreads();if(TS.view.msgs_unscrollable){TS.view.makeMsgsDivUnscrollable()}TS.ui.msg_tab_complete.positionUI();TS.view.resize_sig.dispatch();var msgs_div_w=TS.view.last_msgs_div_width=$("#msgs_div").width();TS.view.makeAttachmentWidthRule(msgs_div_w);if(msgs_div_w>400){$("#notification_bar").addClass("wide")}else{$("#notification_bar").removeClass("wide")}if(msgs_div_w>600){$("#notification_bar").addClass("really_wide")}else{$("#notification_bar").removeClass("really_wide")}TS.log(389,start+" #15 "+(Date.now()-start)+"ms");if(_log_resize_duration){TS.metrics.measure("resize",start_mark);TS.metrics.clearMarks(start_mark)}},never_set:true,measureInput:function(){if(TS.boot_data.feature_new_msg_input){TS.view.last_input_height=TS.view.footer_outer_h=$("#footer").outerHeight();return}if(!TS.model.prefs)return;TS.view.last_input_height=TS.client.ui.$msg_input[0].offsetHeight;TS.client.ui.$messages_input_container.css("height",TS.view.last_input_height);if(TS.model.msg_preview_showing){TS.view.last_input_container_height=Math.max(TS.client.ui.$messages_input_container.outerHeight(),TS.client.ui.$msg_preview.outerHeight()-22)}else{TS.view.last_input_container_height=TS.client.ui.$messages_input_container.outerHeight()}},measureMsgPreview:function(){if(TS.boot_data.feature_new_msg_input)return;var footer_height,msg_preview_height,preview_height;var min_preview_height=110;var window_height=TS.view.cached_wh||$(window).height();var messages_input_container_offset_top=TS.client.ui.$messages_input_container.offset().top;footer_height=window_height-messages_input_container_offset_top;TS.client.ui.$msg_preview.css("padding-bottom",footer_height);msg_preview_height=Math.max(messages_input_container_offset_top/2,min_preview_height);TS.client.ui.$msg_preview_msg.css("max-height",msg_preview_height);preview_height=TS.client.ui.$msg_preview.outerHeight();TS.view.last_preview_height_changed=TS.view.last_preview_height!==preview_height;TS.view.last_preview_height=preview_height},makeAttachmentWidthRule:function(msgs_div_w){var max_width,style_id,$style,some,rule;some=-96;if(TS.model.prefs&&TS.model.prefs.theme=="dense"){some=-144}max_width=msgs_div_w+some;rule="			#msgs_div div.dynamic_content_max_width {				max-width:"+max_width+"px;			}		";if(TS.view.last_attachment_max_width!==max_width){TS.view.last_attachment_max_width=max_width;style_id="dynamic_content_max_width_rule";$style=$("#"+style_id);if($style.length){$style.html(rule)}else{$('<style type="text/css" id="'+style_id+'">'+rule+"</style>").appendTo("head")}}},filesSelected:function(files){TS.client.ui.files.validateFiles(files,false,function(file_list,dispatchCallback){TS.ui.upload_dialog.startWithCommentFromChatInput(file_list)})},filePasted:function(file,immediate){if(TS.model.team.prefs.disable_file_uploads==="disable_all"){TS.generic_dialog.start({title:"Upload failed",body:"At the request of your administrator, file uploads have been disabled on this team.",show_cancel_button:false,onGo:function(){TS.files.uploadOver(false)}});return}if(immediate){TS.files.justUploadTheseFileNow([file])}else{TS.ui.upload_dialog.startWithCommentFromChatInput([file])}},filesDropped:function(files,immediate){if(TS.ui.fs_modal.is_showing){TS.ui.fs_modal.close()}if(immediate){TS.files.justUploadTheseFileNow(files)}else{TS.ui.upload_dialog.startWithCommentFromChatInput(files)}},updateTypingText:function(){var A=TS.typing.getTypersInChannel(TS.shared.getActiveModelOb().id);if(!A||!A.length||TS.model.archive_view_is_showing){$("#typing_text").empty();$("#notification_bar").removeClass("showing_typing");return}if(!TS.model.prefs.show_typing)return;$("#notification_bar").addClass("showing_typing");var typing_name;var second_typing_name;if(TS.boot_data.feature_name_tagging_client){typing_name=TS.utility.htmlEntities(TS.members.getMemberFullName(A[0]));if(A.length==2)second_typing_name=TS.utility.htmlEntities(TS.members.getMemberFullName(A[1]))}else{typing_name=TS.members.getMemberDisplayName(A[0],true);if(A.length==2)second_typing_name=TS.members.getMemberDisplayName(A[1],true)}if(A.length==1){$("#typing_text").html('<span class="typing_name">'+typing_name+"</span> is typing")}else if(A.length==2){$("#typing_text").html('<span class="typing_name">'+typing_name+'</span> and <span class="typing_name">'+second_typing_name+"</span> are typing")}else{$("#typing_text").html(TS.model.typing_msg)}},botChanged:function(bot_or_undefined){if(TS.bots.is_in_bulk_upsert_mode){return}TS.client.msg_pane.rebuildMsgsWithReason("botChanged")},switchedHelper:function(skip_rebuild_msgs){var model_ob=TS.shared.getActiveModelOb();var last_model_ob=TS.shared.getModelObById(TS.model.last_active_cid);if(last_model_ob){TS.utility.msgs.removeAllEphemeralMsgsByType("temp_slash_cmd_feedback",last_model_ob.id);last_model_ob._show_in_list_even_though_no_unreads=false;_saveMsgInputCursorPosition(TS.model.last_active_cid)}if(TS.boot_data.feature_unread_view&&TS.client.unread.isEnabled()){TS.client.unread.destroyUnreadView()}if(TS.boot_data.feature_message_replies_threads_view){TS.client.threads.destroyThreadsView();if(!TS.model.ui_state.flex_name&&TS.model.ui_state.details_tab_active){TS.client.ui.flex.openFlexTab("details",true)}}if(model_ob.is_channel&&(!model_ob.is_member||model_ob.is_archived)){TS.client.archives.start()}else if(model_ob.is_group&&model_ob.is_archived){TS.client.archives.start()}else{TS.client.archives.cancel(true)}model_ob._show_in_list_even_though_no_unreads=false;TS.client.msg_pane.clearBlueBarTimer();TS.view.cacheMsgsHtml();if(skip_rebuild_msgs){TS.client.ui.rebuildAllButMsgs()}else{TS.client.ui.rebuildAll()}window.setTimeout(TS.view.focusMessageInput,0);TS.view.checkIfInputShouldBeDisabledAndPopulate();TS.view.showInterstitialAfterChannelOrImShown();var start_mark="start_channel_change_"+TS.model.active_cid;TS.metrics.measureAndClear("channel_change",start_mark)},removeMsg:function(model_ob,msg){TS.view.removeMessageDiv(msg)},removeMsgsAfterTruncation:function(msgs){var msg;var $msg_div;for(var i=0;i<msgs.length;i++){msg=msgs[i];$msg_div=TS.client.msg_pane.getDivsForMsg(msg.ts);var $day_msgs=$msg_div.parent(".day_msgs");TS.client.msg_pane.cleanMsgDiv($msg_div);$msg_div.remove();if(!$day_msgs.children().length){$day_msgs.parent(".day_container").remove()}}var displayed_msgs=TS.utility.msgs.getDisplayedMsgs(TS.shared.getActiveModelOb().msgs);if(displayed_msgs)TS.view.rebuildMsg(displayed_msgs[displayed_msgs.length-1]);TS.client.msg_pane.updateEndMarker();TS.view.resizeManually("TS.view.removeMsgsAfterTruncation")},removeMessageDiv:function(msg,instant){var $msg_div=TS.client.msg_pane.getDivsForMsg(msg.ts);if(!$msg_div.length)return;TS.client.msg_pane.cleanMsgDiv($msg_div);var is_last=TS.client.msg_pane.last_rendered_msg&&TS.client.msg_pane.last_rendered_msg.ts==$msg_div.data("ts");var $msg_div_before_deleted;var $msg_div_after_deleted=$msg_div.nextAll(".message:not(.hidden)").first();
if(is_last){$msg_div_before_deleted=$msg_div.prevAll(".message:not(.hidden)").first()}var doRemove=function(){$msg_div=TS.client.msg_pane.getDivsForMsg(msg.ts);var $day_msgs=$msg_div.parent(".day_msgs");$msg_div.remove();if(!$day_msgs.children().length){$day_msgs.parent(".day_container").remove()}if(TS.client.ui.$msgs_unread_divider){var $msg_divs_after_red_line=TS.client.ui.$msgs_unread_divider.nextAll(".message:not(.hidden)");if(!$msg_divs_after_red_line.length){TS.info("calling TS.client.ui.markMostRecentReadMsgInActive(true) after message removal because there are no displayed messages after the red line now");TS.client.ui.markMostRecentReadMsgInActive(TS.model.marked_reasons.deleted,true)}}if(is_last&&$msg_div_before_deleted&&$msg_div_before_deleted.length){var msg_before=TS.utility.msgs.getMsg($msg_div_before_deleted.data("ts"),TS.shared.getActiveModelOb().msgs);if(msg_before){TS.client.msg_pane.last_rendered_msg=TS.client.msg_pane.last_in_stream_msg=msg_before;TS.info("set a new TS.client.msg_pane.last_rendered_msg && TS.client.msg_pane.last_in_stream_msg because the deleted msg was the last one")}}if($msg_div_after_deleted&&$msg_div_after_deleted.length){var msg_after=TS.utility.msgs.getMsg($msg_div_after_deleted.data("ts"),TS.shared.getActiveModelOb().msgs);if(msg_after){TS.view.rebuildMsg(msg_after)}}TS.view.resizeManually("TS.view.removeMessageDiv")};if(instant||TS.utility.msgs.isTempMsg(msg)){doRemove()}else{$msg_div.addClass("delete_mode").slideUp(200,doRemove)}},updateTitleWithContext:function(){var context_separator,model_ob,context_name,offset,title;model_ob=TS.shared.getActiveModelOb();if(TS.model.unread_view_is_showing){context_name="Unread Messages"}else if(TS.model.threads_view_is_showing){context_name="Threads"}else if(model_ob){context_name=model_ob.name||""}if(!context_name){return}context_separator=" | ";title=document.title;offset=title.indexOf(context_separator);if(offset!==-1){title=context_name+context_separator+title.substr(offset+context_separator.length)}else{title=context_name+context_separator+title}if(_last_title!==title){_last_title=title;TS.utility.queueRAF(function upTitleWithContextRAF(){document.title=title})}},start_time:new Date,checkIfInputShouldBeDisabledAndPopulate:function(){TS.utility.queueRAF(TS.view.actuallyCheckIfInputShouldBeDisabledAndPopulate)},actuallyCheckIfInputShouldBeDisabledAndPopulate:function(){var active_model_ob=TS.shared.getActiveModelOb();if(active_model_ob&&active_model_ob.is_general&&!TS.members.canUserPostInGeneral()){TS.utility.contenteditable.clear(TS.client.ui.$msg_input);if(!TS.boot_data.feature_texty){TS.client.ui.$msg_input.trigger("autosize").trigger("autosize-resize")}TS.utility.contenteditable.disable(TS.client.ui.$msg_input);$("#footer").addClass("disabled");var $el=TS.boot_data.feature_texty?TS.client.ui.$msg_input:$("#message-input-message span");$el.html("Your Team Owners have limited who can post to #<b>"+TS.channels.getGeneralChannel().name+"</b>");TS.utility.contenteditable.placeholder(TS.client.ui.$msg_input,"")}else if(active_model_ob&&(active_model_ob.is_channel||active_model_ob.is_group)&&TS.boot_data.page_needs_enterprise&&active_model_ob.is_shared&&!TS.permissions.members.canPostInChannel(active_model_ob)){TS.utility.contenteditable.clear(TS.client.ui.$msg_input);if(!TS.boot_data.feature_texty){TS.client.ui.$msg_input.trigger("autosize").trigger("autosize-resize")}TS.utility.contenteditable.disable(TS.client.ui.$msg_input);$("#footer").addClass("disabled");var $el=TS.boot_data.feature_texty?TS.client.ui.$msg_input:$("#message-input-message span");if(active_model_ob.is_group){$el.html('Your Team Owners have limited who can post to <ts-icon class="ts_icon_lock prefix"></ts-icon>'+active_model_ob.name+'<ts-icon class="ts_icon_shared_channel"></ts-icon> </b>')}else{$el.html("Your Team Owners have limited who can post to #<b>"+active_model_ob.name+'<ts-icon class="ts_icon_shared_channel"></ts-icon> </b>')}TS.utility.contenteditable.placeholder(TS.client.ui.$msg_input,"")}else if(active_model_ob&&active_model_ob._checking_at_channel_status&&TS.lazyLoadMembersAndBots()){TS.utility.contenteditable.clear(TS.client.ui.$msg_input);TS.utility.contenteditable.placeholder(TS.client.ui.$msg_input,"Sending...");TS.utility.contenteditable.disable(TS.client.ui.$msg_input);$("#footer").addClass("disabled")}else{TS.utility.contenteditable.clear(TS.client.ui.$msg_input);TS.utility.contenteditable.enable(TS.client.ui.$msg_input);$("#footer").removeClass("disabled");TS.client.msg_input.populateWithLast();TS.client.msg_input.setPlaceholder()}},userGroupUpdated:function(user_group_id){if(_loggedInFired){TS.view.maybeRebuildUserGroupList()}if(user_group_id&&TS.model.previewed_user_group_id===user_group_id){var user_group=TS.user_groups.getUserGroupsById(user_group_id);if(user_group&&user_group.date_delete===-1){TS.model.previewed_user_group_id="";if(TS.model.ui_state.flex_name==="team"){$("#back_from_user_group_preview").trigger("click")}return}TS.client.ui.previewUserGroup(user_group_id)}if(TS.client&&TS.client.msg_pane){var model_ob=TS.shared.getActiveModelOb();if(!model_ob||!model_ob.msgs)return;if(TS.pri)TS.log(390,'user group "'+user_group_id+'" updated');var user_group_string="<!subteam^"+user_group_id;_.each(model_ob.msgs,function(msg){if(msg.text&&msg.text.indexOf(user_group_string)!==-1){if(TS.pri)TS.log(390,"rebuilding message with ts="+msg.ts+' because it mentions user group "'+user_group_id+'"');TS.view.rebuildMsg(msg)}})}},rebuildUserGroupTab:function(){if(TS.boot_data.feature_searchable_member_list)return;var user_groups=TS.model.user_groups.filter(function(ug){return!ug.date_delete});var $user_groups_tab=$("#user_groups_list_tab");if(0===user_groups.length){$user_groups_tab.addClass("hidden")}else{$user_groups_tab.removeClass("hidden")}$user_groups_tab.find(".usergroup_count").text(user_groups.length)},maybeRebuildUserGroupList:_.noop,rebuildUserGroupList:function(user_groups){var measure_label="user_groups_flexpane_rebuild";var start_mark_label="start_user_groups_flexpane_rebuild";TS.metrics.mark(start_mark_label);if(!user_groups){user_groups=TS.model.user_groups.concat()}var query;if(TS.boot_data.feature_searchable_member_list){query=TS.client.ui.user_groups.getUserGroupQuery()}else{query=TS.members.view.getTeamFilter()}if(query!==undefined&&query!==null&&query.length){query=query.toLowerCase();user_groups=user_groups.filter(function(ug){return!ug.date_delete&&(ug.handle.indexOf(query)!==-1||ug._name_lc.indexOf(query)!==-1||ug.description&&ug.description.toLowerCase().indexOf(query)!==-1)})}else{query=null;user_groups=user_groups.filter(function(ug){return!ug.date_delete})}var $user_groups_wrapper=$("#user_groups_list");if(user_groups.length){$user_groups_wrapper.empty();var min_item_height=97;var $list_wrapper=$("<div>");$user_groups_wrapper.append($list_wrapper);$list_wrapper.longListView({items:user_groups,approx_item_height:min_item_height,preserve_dom_order:true,scrollable:TS.boot_data.feature_searchable_member_list?$("#user_group_list_scroller"):$("#team_list_scroller"),makeElement:function(){return $('<div style="width:100%">')},renderItem:function($el,item,data){var html=TS.templates.builders.buildUserGroupHTML(item,true);$el.html(html)},calcItemHeight:function($el){var outer_height=$el.outerHeight();if(!outer_height)return min_item_height;return outer_height}})}else if(query&&TS.model.user_groups.length){var template_args={query:query,tab:{label:"User Groups"}};var html='<div class="no_results top_margin">'+TS.templates.team_list_no_results(template_args)+"</div>";$user_groups_wrapper.html(html);if(!TS.boot_data.feature_searchable_member_list){$user_groups_wrapper.find(".clear_members_filter").on("click",function(){TS.members.view.clearFilter("#team_filter","#team_list_scroller")})}}else{$user_groups_wrapper.html(TS.templates.user_group_tip({is_flexpane:true}))}TS.view.rebuildUserGroupTab();TS.metrics.measureAndClear(measure_label,start_mark_label)},showUnSentControlsForMsg:function(msg,model_ob,imsg){if(imsg&&imsg.error&&imsg.error.code=="4"){TS.utility.msgs.handleFailedMsgSend(msg.ts,model_ob,false);var ephemeral_msg={text:"A Team Owner has restricted posting to the #*"+model_ob.name+"* channel.",ephemeral_type:"general_posting_restricted",slackbot_feels:"sad_surprise"};TS.client.ui.addOrFlashEphemeralBotMsg(ephemeral_msg);TS.utility.contenteditable.value(TS.client.ui.$msg_input,msg.text);TS.view.focusMessageInput();return}setTimeout(function(){TS.model.display_unsent_msgs[msg.ts]=true;TS.view.rebuildMsg(msg)},5e3)},scroll_down_when_msg_from_user_is_added:false,addMsg:function(msg,unread_cnt){var scroll_down=false;var model_ob=TS.shared.getActiveModelOb();if(msg.user==TS.model.user.id&&TS.view.scroll_down_when_msg_from_user_is_added){TS.view.scroll_down_when_msg_from_user_is_added=false;scroll_down=true}else if(TS.client.ui.areMsgsScrolledToBottom()){scroll_down=true}var prev_msg=TS.utility.msgs.getPrevDisplayedMsg(msg.ts,model_ob.msgs);var html=TS.templates.builders.buildMsgHTML({msg:msg,model_ob:model_ob,prev_msg:prev_msg,container_id:"msgs_div",enable_slack_action_links:true});var $msg_html_target=TS.client.ui.$msgs_div;var $last_day=TS.client.ui.$msgs_div.find(".day_msgs").last();if(TS.utility.date.toCalendarDate(msg.ts)===$last_day.attr("data-date")){$msg_html_target=$last_day}else{html='<div class="day_msgs" data-date="'+TS.utility.date.toCalendarDate(msg.ts)+'" data-ts="'+msg.ts+'">'+html+"</div>";html='<div class="day_container">'+TS.templates.messages_day_divider({ts:msg.ts})+html+"</div>"}$last_day=null;$msg_html_target.append(html);$msg_html_target=null;var $msg_div=TS.client.msg_pane.getCanonicalDivForMsg(msg.ts);if(TS.model.prefs.animate_new_msgs){$msg_div.css("opacity","0");$msg_div.transition({opacity:1},200)}TS.utility.makeSureAllLinksHaveTargets($msg_div);if(!msg.rsp_id){TS.client.msg_pane.last_in_stream_msg=msg;if(!TS.utility.msgs.isMsgHidden(msg))TS.client.msg_pane.last_rendered_msg=msg}TS.client.msg_pane.assignLastReadMsgDiv(model_ob);TS.client.msg_pane.padOutMsgsScroller();TS.utility.queueRAF(function addMsgRAF(){if(scroll_down){TS.client.ui.instaScrollMsgsToBottom(false)}var and_check_unreads=TS.client.ui.isUserAttentionOnChat()&&!TS.client.activeChannelIsHidden()&&unread_cnt<2;if(msg.user==TS.model.user.id||and_check_unreads){TS.client.msg_pane.checkUnreads()}else{TS.client.ui.checkInlineImgsAndIframes("main")}TS.client.msg_pane.insertUnreadDivider();if(TS.boot_data.feature_message_menus){TS.attachment_actions.select.decorateNewElements(TS.client.ui.$msgs_div)}TS.ui.utility.updateClosestMonkeyScroller(TS.client.ui.$msgs_scroller_div)})},reClassUnreads:function(last_read){var was_at_bottom=TS.client.ui.areMsgsScrolledToBottom();TS.client.ui.$msgs_div.children("div.message").each(function(index){var ts=$(this).data("ts");if(ts>last_read){$(this).addClass("unread")}else{$(this).removeClass("unread")}});if(TS.shared.getActiveModelOb().unread_cnt){TS.client.msg_pane.insertUnreadDivider()}if(was_at_bottom){TS.client.ui.instaScrollMsgsToBottom(false)}},rebuildMsg:function(msg,changed_keys){if(!msg)return;var $msg_div=TS.client.msg_pane.getCanonicalDivForMsg(msg.ts);if(!$msg_div.length)return;var model_ob=TS.shared.getActiveModelOb();var was_at_bottom=TS.client.ui.areMsgsScrolledToBottom();var prev_msg=TS.utility.msgs.getPrevDisplayedMsg(msg.ts,model_ob.msgs);var html=TS.templates.builders.buildMsgHTML({msg:msg,model_ob:model_ob,prev_msg:prev_msg,container_id:"msgs_div",enable_slack_action_links:true});TS.client.msg_pane.cleanMsgDiv($msg_div);var was_hidden=$msg_div.hasClass("hidden");$msg_div.replaceWith(html);$msg_div=TS.client.msg_pane.getCanonicalDivForMsg(msg.ts);if(was_hidden)$msg_div.addClass("hidden");TS.utility.makeSureAllLinksHaveTargets($msg_div);if(was_at_bottom)TS.client.ui.instaScrollMsgsToBottom(true);TS.client.ui.checkInlineImgsAndIframes("main")},rebuildMsgsIncludingMember:function(member){var current_model_ob=TS.shared.getActiveModelOb();_.each(current_model_ob.msgs,function(msg,offset){if(TS.utility.msgs.messageIncludesMember(member,msg)){if(TS.pri)TS.log(888,"memberChangedProfile: Rebuilding msg "+msg.ts+" because it includes member "+member.id);TS.view.rebuildMsg(msg)}})},rebuildMsgFile:function(msg,file,rebuild_archives){if(!msg||!file)return;var $msg=rebuild_archives?TS.client.msg_pane.getDivForArchiveMsg(msg.ts):TS.client.msg_pane.getCanonicalDivForMsg(msg.ts);$msg=$msg.length?$msg:TS.client.msg_pane.getDivForArchiveMsg(msg.ts);if(!$msg.length)return TS.warn("Trying to rebuild message file, but invalid message");var $file_container=$msg.find(".file_container");var data=TS.files.getFileActions(file);data.file=file;data.is_message=true;data.msg_dom_id=$msg.attr("id");data.new_window=!data.edit;data.download=!(file.mode==="snippet"||(file.mode==="post"||file.mode==="space"));$.extend(data,TS.files.getFileTemplateArguments(file));if(file.mode==="post"||file.mode==="space"){$file_container.replaceWith(TS.templates.file_post(data))}else if(file.mode==="snippet"){var $snippet=$(TS.templates.file_snippet(data));$snippet=$snippet.filter(".file_container");$file_container.replaceWith($snippet)}else if(file.mode==="email"){$file_container.replaceWith(TS.templates.file_email(data))}else if(file.mode==="multnomah"){$file_container.replaceWith(TS.templates.file_multnomah(data))}else{return TS.warn("Trying to rebuild message file, but cannot rebuild "+file.mode)}TS.utility.makeSureAllLinksHaveTargets($msg);if(TS.client)TS.ui.utility.updateClosestMonkeyScroller($msg)},showInterstitialAfterChannelOrImShown:function(){var channel=TS.channels.getChannelById(TS.model.active_channel_id);var group=TS.groups.getGroupById(TS.model.active_group_id);var doing_an_overlay=false;if(channel&&channel.needs_created_message){if(TS.model.prefs.no_created_overlays){channel.needs_created_message=false}else{doing_an_overlay=true;TS.view.overlay.startWithCreatedChannel(channel)}}else if(channel&&channel.needs_invited_message){if(TS.model.prefs.no_joined_overlays){channel.needs_invited_message=false}else{doing_an_overlay=true;TS.view.overlay.startWithInvitedChannel(channel)}}else if(channel&&channel.needs_joined_message){if(TS.model.prefs.no_joined_overlays){channel.needs_joined_message=false}else{doing_an_overlay=true;TS.view.overlay.startWithJoinedChannel(channel)}}else if(group&&group.needs_invited_message){if(TS.model.prefs.no_joined_overlays){group.needs_invited_message=false}else{doing_an_overlay=true;TS.view.overlay.startWithInvitedGroup(group)}}else if(group&&group.needs_created_message){if(TS.model.prefs.no_created_overlays){group.needs_created_message=false}else{doing_an_overlay=true;TS.view.overlay.startWithCreatedGroup(group)}}if(!doing_an_overlay){if(!TS.boot_data.feature_js_raf_queue){TS.view.overlay.fadeInAndOut()}}},toggleStarsError:function(show_error){$("#member_stars_more").toggleClass("hidden",show_error);$("#member_stars_error").toggleClass("hidden",!show_error)},rebuildStars:function(force){if(!force&&TS.model.ui_state.flex_name!=="stars")return;var member=TS.model.user;var html="";var $member_stars_list=$("#member_stars_list");var $member_stars_explanation=$("#member_stars_explanation");var $stars_scroller=$("#stars_scroller");var $member_stars_more=$("#member_stars_more");TS.view.cleanStars();if(member.stars&&member.stars.length){TS.model.user.stars.forEach(function(star){html+=TS.templates.builders.buildStarredItemHTML(star)})}if(html){$member_stars_list.html(html);TS.view.member_stars_list_lazyload=$member_stars_list.find(TS.boot_data.feature_files_list?".lazy":"img.lazy").lazyload({container:$stars_scroller});TS.utility.makeSureAllLinksHaveTargets($member_stars_list);$member_stars_explanation.addClass("hidden");if(TS.stars.has_more){$member_stars_more.css("visibility","visible")}else{$member_stars_more.css("visibility","hidden")}}else{$member_stars_list.html("");$member_stars_explanation.removeClass("hidden");$member_stars_more.css("visibility","hidden")}$stars_scroller.trigger("resize")},cleanStars:function(){if(TS.view.member_stars_list_lazyload&&TS.view.member_stars_list_lazyload.detachEvents){TS.view.member_stars_list_lazyload.detachEvents();TS.view.member_stars_list_lazyload=null}$("#member_stars_list").empty()},mentionChanged:function(mention){TS.warn("mentionChanged:"+mention.message.ts);var $msg_div=$("#member_mentions").find("#"+TS.templates.makeMsgDomId(mention.message.ts));if(!$msg_div.length)return TS.view.rebuildMentions();var h=TS.templates.builders.buildMentionHTML(mention);if(!h)return TS.view.rebuildMentions();$msg_div.replaceWith(h)},mentionRemoved:function(ts){TS.warn("mentionRemoved:"+ts);var $msg_div=$("#member_mentions").find("#"+TS.templates.makeMsgDomId(ts));if(!$msg_div.length)return;var doRemove=function(){TS.view.rebuildMentions()};$msg_div.addClass("delete_mode").slideUp(200,doRemove)},mentionsFetched:function(){TS.view.rebuildMentions();$("#member_mentions_more_btn").data("ladda")&&$("#member_mentions_more_btn").data("ladda").stop()},rebuildMentions:function(force){if(!force&&TS.model.ui_state.flex_name!=="mentions")return;$("#mentions_spinner").empty();TS.view.prefs.rebuildMentionOptions();var $btn=$("#member_mentions_more_btn");if($btn.data("ladda")===undefined){$btn.data("ladda",Ladda.create(document.querySelector("#member_mentions_more_btn")));$btn.bind("click.fetchMoreMentions",function(e){TS.mentions.fetchMoreMentions();$(this).data("ladda").start()})}$("#exclude_at_channels").unbind("change.toggle_exclude_at_channels").bind("change.toggle_exclude_at_channels",function(){var checked=$(this).is(":checked");TS.mentions.setExcludeAtChannelsPref(!checked)});$("#exclude_at_user_groups").unbind("change.toggle_exclude_at_user_groups").bind("change.toggle_exclude_at_user_groups",function(){var checked=$(this).is(":checked");TS.mentions.setExcludeAtUserGroupsPref(!checked)});var html=TS.templates.builders.buildMentions();if(html){$("#member_mentions").html(html);TS.utility.makeSureAllLinksHaveTargets($("#member_mentions"));$("#member_mentions_explanation").addClass("hidden");$("#member_replies_explanation").addClass("hidden");if(TS.mentions.has_more){$("#member_mentions_more").css("visibility","visible")}else{TS.view.hideMentionsMoreButton()}}else{$("#member_mentions").html("");$("#member_mentions_explanation").toggleClass("hidden",TS.mentions.active_tab==="replies");$("#member_replies_explanation").toggleClass("hidden",TS.mentions.active_tab!=="replies");$("#member_mentions_more").css("visibility","hidden")}TS.view.resize()},rebuildMentionsLoading:function(){$("#member_mentions").html(TS.templates.builders.loadingHTML())},hideMentionsMoreButton:function(){$("#member_mentions_more").css("visibility","hidden")},cleanMentions:function(){$("#member_mentions").empty()},mentionsBeingFetched:function(user_requested){if(!user_requested)return;$("#mentions_spinner").html(TS.templates.mentions_loading_indicator())},loggedIn:function(){_loggedInFired=true;TS.templates.makeSidebarBehaviorRule();TS.ui.setThemeClasses(true);var model_ob=TS.shared.getActiveModelOb();if(!TS.isPartiallyBooted()&&TS.boot_data.feature_prevent_msg_rebuild&&model_ob.is_group){TS.client.ui.rebuildAllButMsgs()}else{TS.client.ui.rebuildAll()}TS.view.focusMessageInput();TS.presence_manager.createList(TS.model.user.id);_updateUserPresenceIcon();TS.view.buildTeamList();TS.client.msg_input.populateWithLast();TS.client.ui.rebuildMemberListToggle();TS.view.members.updateUserDisplayName();if(TS.boot_data.feature_user_custom_status)TS.view.members.updateUserCurrentStatus();TS.view.showProperTeamPaneFiller();var is_long_list_view=TS.boot_data.page_needs_enterprise&&!TS.lazyLoadMembersAndBots();var include_bots=true;var include_deleted=false;TS.members.view.bindTeamFilter("#team_filter","#team_list_scroller",true,is_long_list_view,include_bots,include_deleted);TS.client.channel_pane.$scroller.css("visibility","visible");TS.view.showInterstitialAfterChannelOrImShown();TS.view.prefs.toggleSpellcheck();if(!TS.boot_data.feature_name_tagging_client){if(TS.members.shouldDisplayRealNames()){$("#col_channels").addClass("real_names")}else{$("#col_channels").removeClass("real_names")}}if(!TS.model.is_iOS){if(TS.ui.growls.no_notifications&&readCookie("no_growl_prompt")!="1"){$("#growl_prompt_div").removeClass("hidden");$("#growl_prompt_a").bind("click",function(){TS.view.overlay.startWithGrowlPromptDisplay()})}else if(TS.ui.growls.shouldShowPermissionButton()&&TS.ui.growls.getPermissionLevel()!="denied"&&readCookie("no_growl_prompt")!="1"){$("#growl_prompt_div").removeClass("hidden");$("#growl_prompt_a").bind("click",function(){TS.view.overlay.startWithGrowlPromptDisplay()})}}if(TS.model.is_FF){TS.client.ui.$msgs_scroller_div.removeAttr("tabindex")}if(TS.boot_data.feature_tinyspeck){var derek_styles;if(TS.boot_data.user_id==="W1NTZGVC6"){derek_styles='.member_image[data-member-id="W1NTZGVC6"] { -webkit-transform: none; -moz-transform: none; -ms-transform: none; transform: none; }'}else{derek_styles='.member_image[data-member-id="W1NTZGVC6"] { -webkit-transform: rotate(180deg); -moz-transform: rotate(180deg); -ms-transform: rotate(180deg); transform: rotate(180deg); }'}$('<style type="text/css">'+derek_styles+"</style>").appendTo("head")}if(TS.shared.getActiveModelOb().is_channel&&!TS.shared.getActiveModelOb().is_member){TS.client.archives.start()}},showProperTeamPaneFiller:function(){var active_member_count=TS.members.getActiveMembersWithSelfAndSlackbot().length;var limit=4;if(TS.model.user.is_admin){$("#team_block").removeClass("hidden");if(active_member_count>limit){$("#team_block_admin_invite_few").addClass("hidden");$("#team_block_admin_invite_many").removeClass("hidden")}else{$("#team_block_admin_invite_few").removeClass("hidden");$("#team_block_admin_invite_many").addClass("hidden")}}if(active_member_count>limit){$("#team_block_description").addClass("hidden")}else{$("#team_block").removeClass("hidden");$("#team_block_description").removeClass("hidden")}if(TS.model.team.email_domain){var domains=TS.model.team.email_domain.split(",");if(domains.length==1){$("#team_block_email_domains").html("<b>@"+TS.utility.htmlEntities(TS.model.team.email_domain)+"</b>")}else{var last_domain=TS.utility.htmlEntities(domains.pop());var domains_str=domains.join("</b>, <b>@")+"</b> or <b>@"+TS.utility.htmlEntities(last_domain)+"</b>";$("#team_block_email_domains").html("<b>@"+domains_str)}$("#team_block").removeClass("hidden");$("#team_block_email_on").removeClass("hidden");$("#team_block_admin_email_off").addClass("hidden")}else{$("#team_block_email_on").addClass("hidden");if(TS.model.user.is_owner){$("#team_block").removeClass("hidden");$("#team_block_admin_email_off").removeClass("hidden")}}if(!TS.model.user.profile||!TS.model.user.profile.phone||!TS.model.user.profile.real_name){$("#team_block").removeClass("hidden");$("#team_block_fill_prompt").removeClass("hidden")}else{$("#team_block_fill_prompt").addClass("hidden")}},current_unread_status:null,changeUnreadStatus:function(status){TS.view.current_unread_status=status;TS.view.maybeChangeFavIco();TS.client.ui.checkUnseenChannelsImsGroupsWithUnreads()},maybeChangeFavIco:function(){var connection_status=TS.view.ms.current_connection_status;var unread_status=TS.view.current_unread_status;var key;if(connection_status=="online"){key="app_icon_32px_green"}else if(connection_status=="trouble"){key="app_icon_32px_yellow"}else{key="app_icon_32px_red"}if(unread_status=="unreads"){key+="_unreads"}else if(unread_status=="mentions"){key+="_mentions"}var url=TS.model.data_urls[key];var favicon=$("#favicon");if(favicon.attr("href")!=url){favicon.replaceWith('<link id="favicon" rel="shortcut icon" href="'+url+'" sizes="16x16 32x32 48x48" type="image/png" />')}},windowUnloaded:function(){if(!TS.model.mac_ssb_version||TS.model.mac_ssb_version>=.32){$("BODY").addClass("loading");$("#connection_div").html("").addClass("hidden");TS.client.msg_pane.topMessagesBannerHidden()}},buildMemberPresenceStatusHTML:function(member){var html="";html+='<span class="'+TS.templates.makeMemberStatusDomClass(member.id)+'">';if(member.status){html+=' - "'+member.status+'"'}html+="</span>";return html},last_team_list_html:null,large_team_directory_trigger:2e3,rebuildTeamMember:function(member){if(TS.lazyLoadMembersAndBots()){if(!TS.model.ui_state.flex_visible||TS.model.ui_state.flex_name!=="team")return}if(!member||!member.id)return;var member_selector='#team_list .team_list_item[data-member-id="'+member.id+'"]';var $node=$(member_selector);if(!$node.length){TS.view.rebuildTeamList(true)}else{if(TS.view.members_list_lazyload){TS.view.members_list_lazyload.detachEvents();TS.view.members_list_lazyload=null}$node.replaceWith(TS.templates.team_list_item({member:member}));$node=$(member_selector);if(!$node.length){TS.error("Unable to find node at selector "+member_selector)}var $list_scroller=$("#team_list_scroller");var $list_wrapper=$("#team_list_members");var $lazy_nodes=$list_wrapper.find(".lazy");TS.view.members_list_lazyload=$lazy_nodes.lazyload({container:$list_scroller,ignore_when_hidden_element:$list_wrapper,all_images_same_size:true});TS.utility.makeSureAllLinksHaveTargets($node);TS.view.updateTeamListCache()}},clearTeamListCache:function(){TS.view.last_team_list_html=null},updateTeamListCache:function(){if(TS.view.last_team_list_html){TS.view.last_team_list_html=$("#team_list_members_wrapper").html()}},rebuildTeamList:_.noop(),rebuildTeamListThrottled:function(ignore_cache){if(TS.boot_data.feature_searchable_member_list)return;if(TS.lazyLoadMembersAndBots()){if(!TS.model.ui_state.flex_visible||TS.model.ui_state.flex_name!=="team"){TS.view.last_team_list_html=null;return}TS.team.ensureEntireTeamLoaded().then(function(){TS.log(1989,"Flannel: directory fully loaded. Rendering ...");TS.view.rebuildTeamListSync(ignore_cache);TS.metrics.mark("team_directory_time_to_first_member");$("#flannel_team_dir_loading").remove()}).catch(function(){TS.error("Flannel: error resolving _fetch_all_members_p")})}else{Promise.resolve().then(function(){TS.view.rebuildTeamListSync();return null})}},rebuildTeamListSync:function(ignore_cache){if(TS.lazyLoadMembersAndBots()&&!TS.team.isEntireTeamLoaded()){throw new Error("Flannel: team list can only be built after the entire team has been loaded")}if(ignore_cache){TS.view.last_team_list_html=null}if(!TS.model.ui_state.flex_visible||TS.model.ui_state.flex_name!=="team")return;var list_dom_id,list_dom_wrapper_id,list_scroller_id,$members,$lazy_nodes,$members_wrapper,members_for_user,is_large_team,$input,is_long_list_view,is_lazy;list_dom_id="team_list_members";list_dom_wrapper_id="team_list_members_wrapper";list_scroller_id="team_list_scroller";$members_wrapper=$("#"+list_dom_wrapper_id);members_for_user=TS.members.getMembersForUser();$input=$("#team_list_container input.member_filter");if(TS.view.large_team_directory_trigger>0&&members_for_user.length>TS.view.large_team_directory_trigger){is_large_team=true}if(TS.client&&TS.boot_data.page_needs_enterprise&&!TS.lazyLoadMembersAndBots()){is_long_list_view=true;is_lazy=true}if(!TS.view.last_team_list_html||!$("#"+list_dom_id).length){TS.view.cleanTeamList();if(!TS.view.last_team_list_html){if(is_large_team&&!is_long_list_view){TS.view.last_team_list_html='<p id="search_or_show_all" class="mini small_top_margin small_left_margin">Search, or <a href="#" class="show_all_members">show all members</a>.</p>'+'<div id="'+list_dom_id+'" class="hidden">'+TS.templates.builders.buildTeamListHTML(members_for_user)+"</div>"}else{TS.view.last_team_list_html='<div id="'+list_dom_id+'">'+TS.templates.builders.buildTeamListHTML(members_for_user,is_long_list_view,is_lazy)+"</div>";$input=$("#team_list_container input.member_filter")}}$members_wrapper.html(TS.view.last_team_list_html);if(TS.lazyLoadMembersAndBots())TS.metrics.measureAndClear("team_directory_time_to_first_member","team_directory_time_to_first_member");var tabs_instance=TS.ui.tabs.create($("#team_tabs"));if(is_long_list_view){var $scrollable=$("#"+list_scroller_id);var approx_item_height=92;var approx_divider_height=40;var make=function($el,items,approx_item_height,approx_divider_height,$scrollable){if(!$el.length)return;return $el.longListView({items:items,approx_item_height:approx_item_height,approx_divider_height:approx_divider_height,preserve_dom_order:true,scrollable:$scrollable,makeElement:function(data){return $(TS.templates.team_list_item({is_long_list_view:true}))},makeDivider:function(data){return $("<div></div>")},renderItem:function($el,item,data){$el.toggleClass("inactive",item.deleted).data("member-id",item.id).data("item",item);$el.html(TS.templates.team_list_item_member_details({member:item,is_long_list_view:true}));TS.utility.makeSureAllLinksHaveTargets($el)},renderDivider:function($el,item,data){$el.data("item",item).html(TS.templates.team_list_item_divider(item))},calcItemHeight:function($el){var outer_height=$el.outerHeight();if(!outer_height)return approx_item_height;return Math.max(outer_height,approx_item_height)},calcDividerHeight:function($el){var outer_height=$el.outerHeight();if(!outer_height)return approx_divider_height;return outer_height}})};_$active_members_list=_$restricted_members_list=_$deleted_members_list=null;_$active_members_list=make($("#active_members_list"),[],approx_item_height,approx_divider_height,$scrollable);_$restricted_members_list=make($("#restricted_members_list"),[],approx_item_height,approx_divider_height,$scrollable);_$deleted_members_list=make($("#deleted_members_list"),[],approx_item_height,approx_divider_height,$scrollable);if(_$restricted_members_list)_$restricted_members_list.longListView("setHidden",true);if(_$deleted_members_list)_$deleted_members_list.longListView("setHidden",true);_tab_scroll_tops={};$scrollable.off("scroll.tab").on("scroll.tab",function(e){_tab_scroll_tops[TS.model.ui_state.tab_name]=$scrollable.scrollTop()});$("#team_tabs").on("click","li.tab",function(e){var $list,is_visible;if(_$active_members_list){is_visible=TS.model.ui_state.tab_name=="active_members";if(is_visible)$list=_$active_members_list;_$active_members_list.longListView("setHidden",!is_visible)}if(_$restricted_members_list){is_visible=TS.model.ui_state.tab_name=="restricted_members";if(is_visible)$list=_$restricted_members_list;_$restricted_members_list.longListView("setHidden",!is_visible)}if(_$deleted_members_list){is_visible=TS.model.ui_state.tab_name=="disabled_members";if(is_visible)$list=_$deleted_members_list;_$deleted_members_list.longListView("setHidden",!is_visible)}if(!$list)return;if(_tab_scroll_tops[TS.model.ui_state.tab_name]){$list.longListView("scrollToPosition",_tab_scroll_tops[TS.model.ui_state.tab_name],true)}else{$list.longListView("scrollToTop",true)}});$members=$("#"+list_dom_id);$members.on("click.toggle_list_item",".team_list_item",TS.members.view.onTeamDirectoryItemClick);TS.client.flex_pane.startLocalTimeInterval();TS.ui.utility.updateClosestMonkeyScroller($scrollable)}else{if(is_large_team){var showAllClick=function(){$("#search_or_show_all").remove();TS.view.large_team_directory_trigger=-1;$input.val("");TS.members.view.clearFilter("#team_filter","#team_list_scroller");$("#"+list_dom_id).removeClass("hidden");TS.view.last_team_list_html=null;TS.view.triggerInitialTeamListLazyLoad()};var updateFilter=function(value,match_count){if(TS.view.large_team_directory_trigger!==-1){if(!value.length||match_count===members_for_user.length){$("#"+list_dom_id).addClass("hidden");$input.focus()}}else{TS.members.view.team_filter_changed_sig.remove(updateFilter)}};$members_wrapper.find(".show_all_members").on("click",showAllClick);TS.members.view.team_filter_changed_sig.add(updateFilter);$input.focus()}$members=$("#"+list_dom_id);$members.on("click.toggle_list_item",".team_list_item",TS.members.view.onTeamDirectoryItemClick);$lazy_nodes=$members.find(".lazy");if(TS.view.members_list_lazyload){TS.view.members_list_lazyload.detachEvents();TS.view.members_list_lazyload=null}TS.view.members_list_lazyload=$lazy_nodes.lazyload({container:$("#"+list_scroller_id),
ignore_when_hidden_element:$("#"+list_dom_id),all_images_same_size:true});$members.one("remove",function(){if(TS.view.members_list_lazyload){TS.view.members_list_lazyload.detachEvents();TS.view.members_list_lazyload=null}if(tabs_instance&&tabs_instance.unbind){tabs_instance.unbind();tabs_instance=null}if($members){$members.empty();$members=null}});TS.client.flex_pane.startLocalTimeInterval();TS.utility.makeSureAllLinksHaveTargets($members);TS.view.triggerInitialTeamListLazyLoad();$lazy_nodes=null}}TS.view.refilterTeamList();if(TS.model.ui_state.tab_name==="user_groups"){var $user_groups_tab=$("#user_groups_list_tab a");if($user_groups_tab.length)$user_groups_tab.trigger("click")}if(TS.model.ui_state.tab_name==="restricted_members"){var $restricted_tab=$("#restricted_members_tab a");if($restricted_tab.length)$restricted_tab.trigger("click")}if(TS.model.ui_state.tab_name==="disabled_members"){var $disabled_tab=$("#disabled_members_tab a");if($disabled_tab.length)$disabled_tab.trigger("click")}if(!TS.model.ui_state.tab_name){TS.model.ui_state.tab_name="active_members";TS.storage.storeUIState(TS.model.ui_state)}},refilterTeamList:function(){if(!TS.model.ui_state.flex_visible||TS.model.ui_state.flex_name!=="team")return;var $input=$("#team_list_container input.member_filter");var last_query=TS.storage.fetchFilterState();if(typeof last_query!=="string")last_query="";if(last_query||TS.boot_data.page_needs_enterprise&&!TS.lazyLoadMembersAndBots()){$input.val(last_query);$("#team_list_container .icon_close").toggleClass("hidden",!last_query);TS.members.view.filterTeam(last_query,"#team_filter","#team_list_scroller",true)}},buildLongListTeamListItems:function(team_list_members,no_dividers){var members=team_list_members.members;var disabled_members=team_list_members.disabled_members;var deleted_bots=team_list_members.deleted_bots;var bots=team_list_members.bots;var restricted_members=team_list_members.restricted_members;var ultra_restricted_members=team_list_members.ultra_restricted_members;var active_members_list_items=members.slice(0);if(bots.length){if(!no_dividers)active_members_list_items.push({bot:true,is_divider:true});active_members_list_items.push.apply(active_members_list_items,bots)}var restricted_members_list_items=[];if(restricted_members.length){if(!no_dividers)restricted_members_list_items.push({multi_channel_guest:true,is_divider:true});restricted_members_list_items.push.apply(restricted_members_list_items,restricted_members)}if(ultra_restricted_members.length){if(!no_dividers)restricted_members_list_items.push({single_channel_guest:true,restricted_members:!!restricted_members.length,is_divider:true});restricted_members_list_items.push.apply(restricted_members_list_items,ultra_restricted_members)}var deleted_members_list_items=disabled_members.slice(0);if(deleted_bots.length){if(!no_dividers)deleted_members_list_items.push({deleted_bot:true,is_divider:true});deleted_members_list_items.push.apply(deleted_members_list_items,deleted_bots)}return{active_members_list_items:active_members_list_items,restricted_members_list_items:restricted_members_list_items,deleted_members_list_items:deleted_members_list_items}},cleanTeamList:function(remove){if(TS.view.members_list_lazyload&&TS.view.members_list_lazyload.detachEvents){TS.view.members_list_lazyload.detachEvents();TS.view.members_list_lazyload=null}var $members=$("#team_list_members");$members.off("click.toggle_list_item");$members.off("click.member_preview_menu");if(remove){$members.remove()}$members=null},triggerInitialTeamListLazyLoad:function(){TS.ui.utility.updateClosestMonkeyScroller($("#team_list_members"));$("#team_list_scroller").trigger("resize-immediate")},buildTeamList:function(){if(TS.lazyLoadMembersAndBots()){if(!TS.model.ui_state.flex_visible||TS.model.ui_state.flex_name!=="team")return}TS.view.rebuildTeamList()},maybeFollowLink:function(e){if(!TS.utility.isSpaceClickEventSafe(e)){return true}if(!e.metaKey&&!e.ctrlKey)return false;var $el=$(e.target);var a=$el.closest("a[href]");if(a.length&&document.hasFocus()){return true}return false},markAllUnread:function(){TS.model.last_reads_set_by_client={};function markIt(model_ob){var displayed_msgs=TS.utility.msgs.getDisplayedMsgs(model_ob.msgs);if(!displayed_msgs.length)return;var msg=displayed_msgs[displayed_msgs.length-1];if(!msg)return;if(model_ob.is_channel){TS.channels.markReadMsg(model_ob.id,msg.ts)}else if(model_ob.is_im){TS.ims.markReadMsg(model_ob.id,msg.ts)}else if(model_ob.is_group){TS.groups.markReadMsg(model_ob.id,msg.ts)}else{TS.warn("markIt "+model_ob.name+"????");return}TS.info("markIt "+model_ob.name+" "+msg.ts)}var i;var model_ob;for(i in TS.model.channels){model_ob=TS.model.channels[i];if(model_ob.is_archived)continue;if(!model_ob.is_member)continue;markIt(model_ob)}for(i in TS.model.ims){model_ob=TS.model.ims[i];if(!model_ob.is_open)continue;markIt(model_ob)}for(i in TS.model.groups){model_ob=TS.model.groups[i];if(model_ob.is_archived)continue;markIt(model_ob)}TS.model.client.reads.length=0;TS.client.markLastReadsWithAPI();TS.client.msg_pane.clearUnreadDividerAndHideNewMsgsBar();TS.client.msg_pane.insertUnreadDivider();TS.client.msg_pane.dont_check_unreads_til_switch=true},onGroupReferenceClick:function(e,id){var group=TS.groups.getGroupById(id);if(!group)return;if(group.is_archived&&!group.was_archived_this_session){e.preventDefault();TS.groups.displayGroup(group.id)}else{e.preventDefault();TS.groups.displayGroup(group.id)}},onChannelReferenceClick:function(e,id){var channel=TS.channels.getChannelById(id);if(!channel)return;if(channel.is_archived&&!channel.was_archived_this_session){e.preventDefault();TS.channels.displayChannel(channel.id)}else{e.preventDefault();TS.channels.displayChannel(channel.id)}},onMemberReferenceClick:function(e,member_name){if(TS.boot_data.feature_name_tagging_client){var m=TS.members.getMemberById(member_name)||TS.members.getMemberByName(member_name)}else{var m=TS.members.getMemberByName(member_name)}if(!m)return;TS.menu.member.startWithMember(e,m.id)},onUserGroupReferenceClick:function(e,id){var ug=TS.user_groups.getUserGroupsById(id);if(!ug)return;TS.client.ui.previewUserGroup(ug.id)},cacheMsgsHtml:function(){return},adjustForWelcomeSlideShow:function(){if(TS.model.cancelled_welcome_2_this_session)return;TS.model.showing_welcome_2=true;$(".messages_banner").css("visibility","hidden");TS.view.makeMsgsDivUnscrollable()},msgs_unscrollable:false,makeMsgsDivUnscrollable:function(){TS.view.msgs_unscrollable=true;TS.client.ui.$msgs_scroller_div.css("overflow-y","hidden").css("height","100%");$("#monkey_scroll_wrapper_for_msgs_scroller_div").find(".monkey_scroll_bar").css("visibility","hidden");TS.client.ui.$msgs_scroller_div.scrollTop(0);TS.client.ui.$msgs_div.css("visibility","hidden");$("#footer").css("visibility","hidden")},unAdjustForWelcomeSlideShow:function(keep_at_top){if(!TS.model.showing_welcome_2){TS.ui.utility.updateClosestMonkeyScroller(TS.client.ui.$msgs_scroller_div);return}TS.model.showing_welcome_2=false;$(".messages_banner").css("visibility","");if(TS.model.seen_onboarding_this_session&&TS.shared.getActiveModelOb().id==TS.model.welcome_model_ob.id){$("#messages_unread_status").css("visibility","hidden")}else{$("#messages_unread_status").css("visibility","")}if(TS.view.makeMsgsDivScrollable()){TS.view.resizeManually("ran TS.view.makeMsgsDivScrollable()",true);if(keep_at_top){TS.client.ui.$msgs_scroller_div.scrollTop(0)}}else{TS.view.resizeManually("NOT ran TS.view.makeMsgsDivScrollable()",true)}},makeMsgsDivScrollable:function(){if(!TS.view.msgs_unscrollable)return false;TS.view.msgs_unscrollable=false;TS.client.ui.$msgs_scroller_div.css("overflow-y","auto").css("height","");$("#monkey_scroll_wrapper_for_msgs_scroller_div").find(".monkey_scroll_bar").css("visibility","");TS.ui.utility.updateClosestMonkeyScroller(TS.client.ui.$msgs_scroller_div);TS.client.ui.$msgs_div.css("visibility","visible");$("#footer").css("visibility","visible");return true},submit:function(e){var text=TS.utility.contenteditable.value(TS.client.ui.$msg_input);if(!TS.model.ms_connected&&text!="/wakewake")return false;TS.client.ui.onSubmit(text,e);return true},focusMessageInput:function(){var im=TS.ims.getImById(TS.model.active_im_id);var model_ob=TS.shared.getActiveModelOb();if(!model_ob)return;if(im&&TS.members.getMemberById(im.user).deleted){TS.utility.contenteditable.placeholder(TS.client.ui.$msg_input,"account deactivated");TS.utility.contenteditable.disable(TS.client.ui.$msg_input);return}if(model_ob&&!model_ob.is_general&&TS.members.canUserPostInGeneral()){TS.utility.contenteditable.enable(TS.client.ui.$msg_input)}if(TS.model.is_iOS){return}var e=TS.model.last_key_down_e;var keymap=TS.utility.keymap;if(e&&e.altKey&&(e.which==keymap.down||e.which==keymap.up)){return}TS.utility.queueRAF(function inputFocusRAF(){TS.client.ui.$msg_input.focus();if(!TS.model.archive_view_is_showing){var cursor_pos=TS.model.input_cursor_positions[model_ob.id];if(cursor_pos){TS.utility.setCursorPosition(TS.client.ui.$msg_input,cursor_pos.start,cursor_pos.length);delete TS.model.input_cursor_positions[model_ob.id]}else{TS.utility.setCursorPosition(TS.client.ui.$msg_input,TS.utility.contenteditable.value(TS.client.ui.$msg_input).length,0)}}})},clearMessageInput:function(){TS.client.msg_input.populate("")},updateTitleBarColor:function(){if(TS.model.is_our_app){TSSSB.call("updateTitleBarColor",TS.utility.rgb2hex($("#team_menu").css("background-color")))}},teamPlanChanged:function(imsg){TS.model.team.plan=imsg.plan;TS.model.can_add_ura=imsg.can_add_ura},teamProfileChanged:function(){TS.view.refilterTeamList();TS.view.rebuildPreviewedMember()},rebuildPreviewedMember:function(){if(TS.model.previewed_member_id)TS.client.ui.previewMember(TS.model.previewed_member_id)},displayMsgInModelOb:function(model_ob,ts){var maybePromise;if(model_ob.is_channel){maybePromise=TS.channels.displayChannel(model_ob.id)}else if(model_ob.is_mpim){maybePromise=TS.mpims.displayMpim(model_ob.id)}else if(model_ob.is_group){maybePromise=TS.groups.displayGroup(model_ob.id)}else{maybePromise=TS.ims.startImById(model_ob.id)}Promise.resolve(maybePromise).then(function(){if(model_ob.id!=TS.model.active_cid)return;var existing_msg=TS.utility.msgs.getMsg(ts,model_ob.msgs);if(existing_msg&&!TS.model.archive_view_is_showing){TS.client.ui.scrollMsgsSoMsgIsInView(ts,false,true)}else{TS.client.archives.start(ts)}return null})},flexpaneDisplaySwitched:function(prev_flex_name){var flex_name=TS.model.ui_state.flex_name;if(!flex_name||prev_flex_name==="team"&&flex_name!=="team"){TS.view.cleanTeamList(true);return}if(prev_flex_name!=="team"&&flex_name==="team"){TS.view.rebuildTeamListThrottled();return}if(flex_name==="mentions"){if(TS.mentions.mentions_needs_fetched){var user_requested=true;TS.mentions.maybeUpdateMentions(user_requested)}}if(flex_name==="files"){TS.client.flex_pane.maybeFetchFileList()}},_maybeUpdateOnboarding:function(){if(TS.model.seen_onboarding_this_session){if(TS.shared.getActiveModelOb().id==TS.model.welcome_model_ob.id){TS.newxp.startOnboarding()}else{TS.newxp.cancelOnboarding()}}}});var _last_title=null;var _tab_scroll_tops={};var _$active_members_list;var _$restricted_members_list;var _$deleted_members_list;var _log_resize_duration=false;var _electron_window_gripper_offset=8;var _setChannelsScrollerHeight=function(window_h,banner_h){var window_h=window_h||TS.view.cached_wh||$(window).height();var banner_h=banner_h||(TS.client.ui.$banner.hasClass("hidden")?0:parseInt(TS.client.ui.$banner.css("height")));var footer_h=$("#col_channels_footer")?parseInt($("#col_channels_footer").css("height")):0;var nav_h=0;var top_offset=TS.view.team_menu_h;if(TS.boot_data.feature_sli_channel_priority||TS.boot_data.feature_unread_view){nav_h=TS.client.channel_pane.$nav.outerHeight();$("#channel_scroll_up").css("top",nav_h)}if(TS.model.is_electron&&TS.model.is_mac&&TSSSB.call("isMainWindowFrameless")){top_offset+=_electron_window_gripper_offset}var height=window_h-(top_offset+footer_h+banner_h+nav_h);TS.client.channel_pane.$scroller.css("height",height)};var _updateUserPresenceIcon=function(){TS.view.ms.maybeChangeConnectionDisplay()};var _loggedInFired;var _saveMsgInputCursorPosition=function(c_id){if(!TS.utility.contenteditable.value(TS.client.ui.$msg_input)){delete TS.model.input_cursor_positions[c_id];return}var cursor_pos=TS.utility.getCursorPosition(TS.client.ui.$msg_input);if(cursor_pos){TS.model.input_cursor_positions[c_id]=cursor_pos}}})();(function(){"use strict";TS.registerModule("view.channel",{onStart:function(){TS.channels.renamed_sig.add(TS.view.channel.channelRenamed,TS.view.channel);TS.channels.switched_sig.add(TS.view.channel.channelSwitched,TS.view.channel);TS.channels.created_sig.add(TS.view.channel.channelCreated,TS.view.channel);TS.channels.deleted_sig.add(TS.view.channel.channelDeleted,TS.view.channel);TS.channels.joined_sig.add(TS.view.channel.channelJoined,TS.view.channel);TS.channels.member_joined_sig.add(TS.view.channel.channelMemberJoined,TS.view.channel);TS.channels.left_sig.add(TS.view.channel.channelLeft,TS.view.channel);TS.channels.member_left_sig.add(TS.view.channel.channelMemberLeft,TS.view.channel);TS.channels.history_fetched_sig.add(TS.view.channel.channelHistoryFetched,TS.view.channel);TS.channels.history_being_fetched_sig.add(TS.view.channel.channelHistoryBeingFetched,TS.view.channel);TS.channels.message_received_sig.add(TS.view.channel.channelMessageReceived,TS.view.channel);TS.channels.message_removed_sig.add(TS.view.channel.channelMessageRemoved,TS.view.channel);TS.channels.message_changed_sig.add(TS.view.channel.channelMessageChanged,TS.view.channel);TS.channels.marked_sig.add(TS.view.channel.channelMarked,TS.view.channel);TS.channels.unread_changed_sig.add(TS.view.channel.channelUnreadCountChanged,TS.view.channel);TS.channels.unread_highlight_changed_sig.add(TS.view.channel.channelUnreadHighlightCountChanged,TS.view.channel);TS.channels.topic_changed_sig.add(TS.view.channel.channelTopicChanged,TS.view.channel);TS.channels.purpose_changed_sig.add(TS.view.channel.channelPurposeChanged,TS.view.channel);TS.channels.archived_sig.add(TS.view.channel.channelArchived,TS.view.channel);TS.channels.unarchived_sig.add(TS.view.channel.channelUnArchived,TS.view.channel);TS.channels.msg_not_sent_sig.add(TS.view.channel.channelMsgNotsent,TS.view.channel)},channelRenamed:function(){TS.client.ui.rebuildAll();TS.view.updateTitleWithContext()},channelSwitched:function(){TS.view._maybeUpdateOnboarding();TS.view.switchedHelper();TS.view.updateTitleWithContext();TS.view.updateTypingText()},channelCreated:function(channel){TS.client.channel_pane.rebuild("channels","starred")},channelDeleted:function(channel){TS.client.channel_pane.rebuild("channels","starred")},channelJoined:function(channel){TS.client.channel_pane.rebuild("channels","starred")},channelMemberJoined:function(channel,member){if(channel.id!=TS.model.active_channel_id)return;TS.client.msg_pane.rebuildChannelMembersList();if(channel.needs_created_message){TS.view.overlay.startWithCreatedChannel(channel)}},channelLeft:function(channel){TS.client.channel_pane.rebuild("channels","starred")},channelMemberLeft:function(channel,member_id){if(channel.id!=TS.model.active_channel_id)return;TS.client.msg_pane.rebuildChannelMembersList()},channelHistoryFetched:function(channel){if(channel.id!=TS.model.active_channel_id)return;TS.client.ui.afterHistoryFetch(channel)},channelHistoryBeingFetched:function(channel){if(channel.id!=TS.model.active_channel_id)return;TS.client.msg_pane.updateEndMarker();channel=TS.channels.getChannelById(TS.model.active_channel_id);if(!channel||!channel.msgs.length)return;if(TS.model.ms_connected){if(channel.history_changed){TS.model.ui.last_top_msg=null}else{var displayed_msgs=TS.utility.msgs.getDisplayedMsgs(channel.msgs);TS.model.ui.last_top_msg=displayed_msgs[displayed_msgs.length-1]}}else{TS.model.ui.last_top_msg=null}$("html").unbind("mousemove.monkeyScroll")},channelMessageReceived:function(channel,msg){if(channel.id!=TS.model.active_channel_id)return;if(!msg){TS.error("no msg?");return}var msgs=channel.msgs;if(TS.boot_data.feature_message_replies){var visible_msgs=_.reject(channel.msgs,TS.utility.msgs.isMsgHidden);msgs=visible_msgs}if(TS.boot_data.feature_message_replies&&TS.utility.msgs.isMsgHidden(msg))return;var will_be_rolled_up=msgs.length>1&&TS.utility.msgs.msgMightBeRolledUp(msg)&&TS.utility.msgs.msgMightBeRolledUp(msgs[1]);if(will_be_rolled_up||msgs.length==1||msgs[0]!=msg){TS.client.msg_pane.rebuildMsgsWithReason("channelMessageReceived")}else{TS.view.addMsg(msg,channel.unread_cnt);if(TS.client&&TS.client.msg_pane)TS.client.msg_pane.maybeClearUnreadDivider(channel,msg)}},channelMessageRemoved:function(channel,msg){if(channel.id!=TS.model.active_channel_id)return;if(!msg){TS.error("no msg?");return}TS.view.removeMsg(channel,msg)},channelMessageChanged:function(channel,msg,changed_keys){if(channel.id!=TS.model.active_channel_id)return;setTimeout(function(){TS.view.rebuildMsg(msg,changed_keys)},0)},channelMarked:function(channel){if(channel.id!=TS.model.active_channel_id)return;TS.client.msg_pane.assignLastReadMsgDiv(channel);TS.view.reClassUnreads(channel.last_read)},channelUnreadCountChanged:function(channel,msg){if(!channel)return;if(TS.client.channel_pane.maybeRebuildBecauseUnreadCntChanged(channel))return;var selector="."+TS.templates.makeChannelDomId(channel);var $channel=$(selector);if(channel.unread_cnt===0){$channel.removeClass("unread mention")}else{if(!TS.notifs.isCorGMuted(channel.id))$channel.addClass("unread");if(channel.unread_highlight_cnt>0)$channel.addClass("mention")}if(channel._show_in_list_even_though_no_unreads){$channel.addClass("show_in_list_even_though_no_unreads")}else{$channel.removeClass("show_in_list_even_though_no_unreads")}var $channel_link=$channel.find(".channel_name");if($channel_link.length){$channel_link.attr("aria-label",TS.templates.builders.makeChannelLinkAriaLabelSafe(channel))}selector="."+TS.templates.makeUnreadMsgsDomId(channel);var $unread=$(selector);if(channel.unread_cnt===0){$unread.html(channel.unread_cnt).addClass("hidden")}else{if(channel.unread_cnt<10){$unread.html(channel.unread_cnt).removeClass("hidden")}else{$unread.html("9+").removeClass("hidden")}}TS.client.ui.checkUnseenChannelsImsGroupsWithUnreads();TS.client.msg_pane.maybeInsertUnreadDividerAndNewMsgsBar(channel);TS.client.msg_pane.maybeResetAndAutoScroll(channel)},channelUnreadHighlightCountChanged:function(channel,msg){if(!channel)return;if(TS.client.channel_pane.maybeRebuildBecauseUnreadCntChanged(channel))return;var selector="."+TS.templates.makeUnreadHighlightDomId(channel);if(channel.unread_highlight_cnt===0){$(selector).html(channel.unread_highlight_cnt).addClass("hidden")}else{if(channel.unread_highlight_cnt<10){$(selector).html(channel.unread_highlight_cnt).removeClass("hidden")}else{$(selector).html("9+").removeClass("hidden")}}},channelTopicChanged:function(channel,user_id,topic){if(!channel)return;if(channel.id!=TS.model.active_channel_id)return;TS.client.msg_pane.updateEndMarker()},channelPurposeChanged:function(channel,user_id,purpose){if(!channel)return;if(channel.id!=TS.model.active_channel_id)return;TS.client.msg_pane.updateEndMarker()},channelArchived:function(channel){TS.client.channel_pane.rebuild("channels","starred");TS.client.msg_pane.rebuildChannelMembersList();if(channel.id!=TS.model.active_channel_id)return;TS.client.archives.start()},channelUnArchived:function(channel){TS.client.channel_pane.rebuild("channels","starred");if(channel.id!=TS.model.active_channel_id)return;TS.client.msg_pane.rebuildChannelMembersList();TS.client.msg_pane.rebuildMsgs()},channelMsgNotsent:function(channel,msg,imsg){if(channel.id!=TS.model.active_channel_id)return;TS.view.showUnSentControlsForMsg(msg,channel,imsg)}})})();(function(){"use strict";TS.registerModule("view.dnd",{onStart:function(){TS.dnd.dnd_statuses_changed_sig.add(TS.view.dnd.dndStatusesChanged,TS.view.dnd);TS.dnd.current_user_dnd_status_changed_sig.add(TS.view.dnd.currentUserDndStatusChanged,TS.view.dnd)},dndStatusesChanged:function(members){if(!members||!members.length)return;var $presence_icons=$(".presence[data-member-presence]");var id_map={};$presence_icons.each(function(){var $this=$(this);var id=$this.attr("data-member-presence");if(!id_map[id])id_map[id]=[];id_map[id].push($this)});members.forEach(function(member){var presences=id_map[member.id];if(!presences)return;presences.forEach(function($presence){var presence=TS.templates.makeMemberPresenceStateClass(member);$presence.removeClass("away active dnd").addClass(presence);var im=TS.ims.getImByMemberId(member.id);if(im){$presence.closest(".im_name").attr("aria-label",TS.templates.builders.makeMemberLinkAriaLabelSafe({member:member,im:im}))}})})},currentUserDndStatusChanged:function(){if(TS.model.ms_connected)TS.view.ms.maybeChangeConnectionDisplay();var $icon=$("#client_header").find(".notifications_menu_btn");if(TS.members.isMemberInDnd(TS.model.user)){$icon.removeClass("ts_icon_bell_o").addClass("ts_icon_snooze_outline")}else{$icon.removeClass("ts_icon_snooze_outline").addClass("ts_icon_bell_o")}}})})();(function(){"use strict";TS.registerModule("view.files",{onStart:function(){TS.files.team_file_added_sig.add(TS.view.files.teamAdded,TS.view.files);TS.files.team_file_deleted_sig.add(TS.view.files.teamDeleted,TS.view.files);TS.files.team_file_changed_sig.add(TS.view.files.teamChanged,TS.view.files);TS.files.file_uploaded_sig.add(TS.view.files.uploaded,TS.view.files);TS.files.file_uploading_sig.add(TS.view.files.uploading,TS.view.files);TS.files.file_progress_sig.add(TS.view.files.progress,TS.view.files);TS.files.file_canceled_sig.add(TS.view.files.canceled,TS.view.files);TS.files.file_queue_emptied_sig.add(TS.view.files.queueEmptied,TS.view.files)},teamAdded:function(file){if(!file.is_deleted&&TS.view.files.shouldAppearInlist(file))TS.view.files.throttledRebuildList()},teamDeleted:function(file){if(TS.view.files.shouldAppearInlist(file))TS.view.files.throttledRebuildList()},teamChanged:function(file){if(!file.is_deleted&&TS.view.files.shouldAppearInlist(file)){if(TS.boot_data.feature_fast_files_flexpane){TS.view.files.singleListItemChanged(file)}else{TS.view.files.throttledRebuildList()}}var model_ob=TS.shared.getActiveModelOb();if(model_ob)TS.utility.msgs.updateFileMsgs(model_ob,file)},uploaded:function(ok,file_id){$("#file_progress").queue(function(next){if(ok){$(this).removeClass("loaded").find(".progress_bar").addClass("seafoam_green_bg no_transition").end().find(".progress_bar_progress_animated_thin").addClass("no_transition progress_bar_progress_thin progress_bar_progress_striped").removeClass("progress_bar_progress_animated_thin").attr("data-label-left","Processing uploaded file... complete!").css({width:"0%"}).end();if(TS.model.ui_state.flex_visible){var file=TS.files.getFileById(file_id);if(file&&(file.mode=="snippet"||file.mode=="post")){TS.client.ui.files.previewFile(file.id,"file_list")}}}else{}next()}).delay(1e3)},uploading:function(filename,retry,cancelable){var html="";if(cancelable)html+='<a id="cancel_upload_in_progress" class="float_right right_margin">cancel</a>';var label="";if(retry){label+="Re-uploading"}else{label+="Uploading"}label+=" "+filename;$("#file_progress").queue(function(next){$(this).removeClass("hidden loaded").find(".progress_bar").removeClass("candy_red_bg seafoam_green_bg").end().find(".progress_bar_progress_thin").removeClass("no_transition").data("label-left-original",label).attr("data-label-left",label).end().find("#progress_text").html(html).find("#cancel_upload_in_progress").click(TS.files.cancelCurrentUpload);next();TS.client.msg_pane.topMessagesBannerShown()}).fadeIn(200)},progress:function(percent){$("#file_progress").queue(function(next){$(this).find(".progress_bar.no_transition").removeClass("no_transition");var $progress_bar_progress=$(".progress_bar_progress_thin");var queue_string=TS.files.uploadQ.length?" (1 of "+(TS.files.uploadQ.length+1)+")":"";if(percent<99){var new_label=$progress_bar_progress.data("label-left-original")+"..."+percent+"%"+queue_string;$progress_bar_progress.css({width:percent+"%"}).attr("data-label-left",new_label)}else{$("#file_progress").addClass("loaded").find(".progress_bar_progress_thin").removeClass("progress_bar_progress_thin progress_bar_progress_striped").addClass("progress_bar_progress_animated_thin").css({width:"100%"}).attr("data-label-left","Processing uploaded file..."+queue_string).end().find("#cancel_upload_in_progress").remove().end()}next()})},canceled:function(filename){$("#file_progress").queue(function(next){$(this).removeClass("loaded").find(".progress_bar").addClass("candy_red_bg").end().find(".progress_bar_progress_thin").addClass("no_transition progress_bar_progress_striped").css({width:"0%"}).attr("data-label-left","").end().find("#progress_text").html("Canceling <strong class='filename'>"+TS.utility.htmlEntities(filename)+"</strong> ...").end().find("#cancel_upload_in_progress").remove().end();next()}).delay(1e3)},queueEmptied:function(){$("#file_progress").fadeOut(200,function(){TS.client.msg_pane.topMessagesBannerHidden()})},throttledRebuildList:function(){TS.utility.throttle.method(TS.view.files.maybeRebuildList,"file_list_rebuild",1e3)},maybeRebuildList:function(){if(!TS.model.ui_state.flex_visible||TS.model.ui_state.flex_name&&TS.model.ui_state.flex_name!=="files"||!TS.model.ui_state.flex_name&&TS.model.default_flex_name!=="files"){return}TS.view.files.rebuildList()},last_files_html:"",rebuildList:function(){if(TS.boot_data.feature_fast_files_flexpane){TS.view.files.rebuildListFast();return}TS.metrics.mark("start_file_flexpane_rebuild");var $file_list=$("#file_list");var $help_block=$("#file_list_block");var list_type=$file_list.data("list");var files=TS.model.files;var member;var webapp_url="/files";if(list_type=="user"){files=TS.model.user.files;webapp_url+="/"+TS.model.user.name}else if(TS.utility.strLooksLikeAMemberId(list_type)){member=TS.members.getMemberById(list_type);if(member){files=member.files;webapp_url+="/"+member.name}else{TS.error(list_type+" is not valid?")}}var html="";var file;for(var i=0;i<files.length;i++){file=files[i];if(!file.is_deleted&&TS.view.files.shouldAppearInlist(file)){html+=TS.templates.builders.fileHTML(file)}}$("#file_list_heading").find(".heading_label").text(TS.view.file_list_heading);$("#file_list_toggle").removeClass("hidden");$("#file_search_cancel").addClass("hidden");html=TS.format.replaceHighlightMarkers(html);var types=TS.model.file_list_types;var no_filter=!types||!types.length||types.indexOf("all")!=-1;$help_block.find(".subsection").addClass("hidden");if(no_filter){$help_block.find('.subsection[data-filter="all"]').removeClass("hidden")}else{if(TS.model.active_file_list_member_filter=="all")webapp_url+="/all";webapp_url+="/"+TS.model.active_file_list_filter;$help_block.find('.subsection[data-filter="'+types[0]+'"]').removeClass("hidden")}if(!html){var from_str=".";if(list_type=="user"){from_str=" from you."}else if(member){from_str=" from <strong>"+TS.members.getMemberDisplayName(member,true)+"</strong>."}if(no_filter){html='<p class="no_results">No files'+from_str+"</p>"}else{html='<p class="no_results">No '+TS.model.file_list_type_map[types[0]]+from_str+"</p>"}}if(html!=TS.view.files.last_files_html||!$file_list.children().length){if(TS.view.file_list_lazyload&&TS.view.file_list_lazyload.detachEvents)TS.view.file_list_lazyload.detachEvents();$file_list.html(html);TS.utility.makeSureAllLinksHaveTargets($file_list);TS.view.file_list_lazyload=$file_list.find(TS.boot_data.feature_files_list?".lazy":"img.lazy").lazyload({container:$("#file_list_scroller")});if(!!TS.client)TS.client.ui.checkInlineImgsAndIframes("file_list");$("#file_list_scroller").trigger("resize-immediate")}TS.view.files.last_files_html=html;if(TS.model.files.length===0){$("#file_listing_bottom_button").addClass("hidden")}else{$("#file_listing_bottom_button").removeClass("hidden").attr("href",webapp_url)}TS.ui.utility.updateClosestMonkeyScroller($file_list);TS.metrics.measureAndClear("file_flexpane_rebuild","start_file_flexpane_rebuild")},rebuildListFast:function(){TS.metrics.mark("start_file_flexpane_rebuild");var $file_list=$("#file_list");var $help_block=$("#file_list_block");var list_type=$file_list.data("list");var files=TS.model.files;var member;var webapp_url="/files";if(list_type=="user"){files=TS.model.user.files;webapp_url+="/"+TS.model.user.name}else if(TS.utility.strLooksLikeAMemberId(list_type)){member=TS.members.getMemberById(list_type);if(member){files=member.files;webapp_url+="/"+member.name}else{TS.error(list_type+" is not valid?")}}var filtered_files=files.filter(function(file){return!file.is_deleted&&TS.view.files.shouldAppearInlist(file)});$("#file_list_heading").find(".heading_label").text(TS.view.file_list_heading);$("#file_list_toggle").removeClass("hidden");$("#file_search_cancel").addClass("hidden");var types=TS.model.file_list_types;var no_filter=!types||!types.length||types.indexOf("all")!=-1;$help_block.find(".subsection").addClass("hidden");if(no_filter){$help_block.find('.subsection[data-filter="all"]').removeClass("hidden")}else{if(TS.model.active_file_list_member_filter=="all")webapp_url+="/all";webapp_url+="/"+TS.model.active_file_list_filter;$help_block.find('.subsection[data-filter="'+types[0]+'"]').removeClass("hidden")}if(!filtered_files.length){var html;var from_str=".";if(list_type=="user"){from_str=" from you."}else if(member){from_str=" from <strong>"+TS.members.getMemberDisplayName(member,true)+"</strong>."}if(no_filter){html='<p class="no_results">No files'+from_str+"</p>"}else{html='<p class="no_results">No '+TS.model.file_list_type_map[types[0]]+from_str+"</p>"}if(_file_list_initialized){$file_list.longListView("destroy");_file_list_initialized=false}$file_list.empty().html(html)}if(filtered_files.length){if(!_file_list_initialized){$file_list.empty();var min_item_height=80;$file_list.longListView({items:filtered_files,approx_item_height:min_item_height,preserve_dom_order:true,scrollable:$("#file_list_scroller"),makeElement:function(){return $("<div>")},renderItem:function($el,item,data){var html=TS.templates.builders.fileHTML(item);html=TS.format.replaceHighlightMarkers(html);var $file=$(html);$file.find("i.lazy").each(function(){var $this=$(this);$this.removeClass("lazy");$this.css("background-image","url("+$this.attr("data-original")+")")});$el.attr("id",$file.attr("id"));$el.attr("class",$file.attr("class"));$el.attr("data-file-id",item.id);$el.data("file-id",item.id);$el.empty();$file.children().each(function(){$el.append(this)});TS.utility.makeSureAllLinksHaveTargets($el)},calcItemHeight:function($el){var outer_height=$el.outerHeight();if(!outer_height)return min_item_height;return outer_height+12}});_file_list_initialized=true}else{$file_list.longListView("setItems",filtered_files,false,true)}}if(TS.model.files.length===0){$("#file_listing_bottom_button").addClass("hidden")}else{$("#file_listing_bottom_button").removeClass("hidden").attr("href",webapp_url)}TS.ui.utility.updateClosestMonkeyScroller($file_list);TS.metrics.measureAndClear("file_flexpane_rebuild","start_file_flexpane_rebuild")},filterSet:function(){if(TS.model.ui.active_tab_id!="files"||!TS.model.ui_state.flex_visible||TS.model.previewed_file_id){TS.client.ui.files.showFileList()}TS.view.files.maybeRebuildList();$("#file_list_scroller").scrollTop(0);TS.client.flex_pane.maybeFetchFileList()},clearFilter:function(){TS.model.active_file_list_filter="all";TS.view.file_list_heading="All File Types";TS.model.file_list_types=["all"];TS.view.files.filterSet();TS.view.files.setButtonState("all");$("#file_list_clear_filter").addClass("hidden")},setButtonState:function(filetype){$(".secondary_file_button").addClass("hidden");if(filetype=="snippets"){$("#secondary_snippet_button").removeClass("hidden")}else if(filetype=="posts"){$("#secondary_post_button").removeClass("hidden")}else{$("#file_list_button").removeClass("hidden")}},shouldAppearInlist:function(file){
var types=TS.model.file_list_types;if(!types)return true;if(!types.length)return true;if(types.indexOf("all")>-1)return true;if(types.indexOf("snippets")>-1&&file.mode=="snippet")return true;if(types.indexOf("posts")>-1&&file.mode=="post")return true;if(types.indexOf("spaces")>-1&&file.mode=="space")return true;if(TS.boot_data.feature_multnomah){if(types.indexOf("multnomah")>-1&&file.mode=="multnomah")return true}if(types.indexOf("emails")>-1&&file.mode=="email")return true;if(types.indexOf("zips")>-1&&file.filetype=="zip")return true;if(types.indexOf("pdfs")>-1&&file.filetype=="pdf")return true;if(types.indexOf("images")>-1&&file.mimetype&&file.mimetype.indexOf("image/")===0)return true;if(types.indexOf("gdocs")>-1&&file.mimetype&&file.mimetype.indexOf("application/vnd.google-apps")===0)return true;return false},singleListItemChanged:function(file){if(!TS.boot_data.feature_fast_files_flexpane)return;if(!_file_list_initialized)return;if(TS.model.ui_state.flex_name!=="files")return;$("#file_list").longListView("itemUpdated",file)},cleanList:function(){if(TS.boot_data.feature_fast_files_flexpane){if(_file_list_initialized){$("#file_list").longListView("destroy");_file_list_initialized=false}}else{if(TS.view.file_list_lazyload&&TS.view.file_list_lazyload.detachEvents){TS.view.file_list_lazyload.detachEvents();TS.view.file_list_lazyload=null}$("#file_list").empty()}},hideList:function(){if(!TS.boot_data.feature_fast_files_flexpane||!_file_list_initialized)return;$("#file_list_scroller").data("disable-scroll",true);$("#file_list").longListView("setHidden",true)},unHideList:function(){if(!TS.boot_data.feature_fast_files_flexpane)return;$("#file_list_scroller").data("disable-scroll",false);if(_file_list_initialized){$("#file_list").longListView("setHidden",false)}else{TS.view.files.rebuildList()}},shareInCurrentChannelOrIM:function(file_id,source_model_ob_id){TS.files.shareOrReshareFile(file_id,undefined,undefined,source_model_ob_id)},"delete":function(file_id){var msg_title;var msg_body;var msg_go_button_text;var obj=TS.files&&TS.files.getFileById?TS.files.getFileById(file_id):null;if(obj&&obj.filetype&&obj.filetype==="space"){msg_title="Delete post";msg_body="Are you sure you want to delete this post permanently?";msg_go_button_text="Yes, delete this post"}else{msg_title="Delete file";msg_body="Are you sure you want to delete this file permanently?";msg_go_button_text="Yes, delete this file"}TS.generic_dialog.start({title:msg_title,body:msg_body,show_cancel_button:true,show_go_button:true,go_button_class:"btn_danger",go_button_text:msg_go_button_text,cancel_button_text:"Cancel",onGo:function(){TS.files.deleteFile(file_id)}})},saveToDropbox:function(file_id){TS.generic_dialog.start({title:"Save to Dropbox",body:"Do you want to save this file to your Dropbox Slack folder?",show_cancel_button:true,show_go_button:true,go_button_text:"Yes",cancel_button_text:"No",onGo:function(){TS.files.saveFileToDropbox(file_id)}})}});var _file_list_initialized=false})();(function(){"use strict";TS.registerModule("view.group",{onStart:function(){TS.groups.renamed_sig.add(TS.view.group.groupRenamed,TS.view.group);TS.groups.switched_sig.add(TS.view.group.groupSwitched,TS.view.group);TS.groups.deleted_sig.add(TS.view.group.groupDeleted,TS.view.group);TS.groups.joined_sig.add(TS.view.group.groupJoined,TS.view.group);TS.groups.member_joined_sig.add(TS.view.group.groupMemberJoined,TS.view.group);TS.groups.left_sig.add(TS.view.group.groupLeft,TS.view.group);TS.groups.member_left_sig.add(TS.view.group.groupMemberLeft,TS.view.group);TS.groups.history_fetched_sig.add(TS.view.group.groupHistoryFetched,TS.view.group);TS.groups.history_being_fetched_sig.add(TS.view.group.groupHistoryBeingFetched,TS.view.group);TS.groups.message_received_sig.add(TS.view.group.groupMessageReceived,TS.view.group);TS.groups.message_removed_sig.add(TS.view.group.groupMessageRemoved,TS.view.group);TS.groups.message_changed_sig.add(TS.view.group.groupMessageChanged,TS.view.group);TS.groups.marked_sig.add(TS.view.group.groupMarked,TS.view.group);TS.groups.unread_changed_sig.add(TS.view.group.groupUnreadCountChanged,TS.view.group);TS.groups.unread_highlight_changed_sig.add(TS.view.group.groupUnreadHighlightCountChanged,TS.view.group);TS.groups.topic_changed_sig.add(TS.view.group.groupTopicChanged,TS.view.group);TS.groups.purpose_changed_sig.add(TS.view.group.groupPurposeChanged,TS.view.group);TS.groups.opened_sig.add(TS.view.group.groupOpened,TS.view.group);TS.groups.closed_sig.add(TS.view.group.groupClosed,TS.view.group);TS.groups.archived_sig.add(TS.view.group.groupArchived,TS.view.group);TS.groups.unarchived_sig.add(TS.view.group.groupUnArchived,TS.view.group);TS.groups.msg_not_sent_sig.add(TS.view.group.groupMsgNotSent,TS.view.group)},groupRenamed:function(){TS.view.updateTitleWithContext();TS.client.ui.rebuildAll()},groupSwitched:function(){TS.view._maybeUpdateOnboarding();TS.view.switchedHelper();TS.view.unAdjustForWelcomeSlideShow();TS.view.updateTitleWithContext();TS.view.updateTypingText()},groupDeleted:function(group){TS.client.channel_pane.rebuild("channels","starred")},groupJoined:function(group){TS.client.channel_pane.rebuild("channels","starred")},created_group_overlay_tim:0,groupMemberJoined:function(group,member){if(group.id!=TS.model.active_group_id)return;TS.client.msg_pane.rebuildChannelMembersList();if(group.needs_created_message){clearTimeout(TS.view.group.created_group_overlay_tim);TS.view.group.created_group_overlay_tim=setTimeout(function(){if(group.id==TS.model.active_group_id){TS.view.overlay.startWithCreatedGroup(group)}},1e3)}},groupLeft:function(group){TS.client.channel_pane.rebuild("channels","starred")},groupMemberLeft:function(group,member_id){if(group.id!=TS.model.active_group_id)return;TS.client.msg_pane.rebuildChannelMembersList()},groupHistoryFetched:function(group){if(group.id!=TS.model.active_group_id)return;TS.client.ui.afterHistoryFetch(group)},groupHistoryBeingFetched:function(group){if(group.id!=TS.model.active_group_id)return;TS.client.msg_pane.updateEndMarker();group=TS.groups.getGroupById(TS.model.active_group_id);if(!group||!group.msgs.length)return;if(TS.model.ms_connected){if(group.history_changed){TS.model.ui.last_top_msg=null}else{var displayed_msgs=TS.utility.msgs.getDisplayedMsgs(group.msgs);TS.model.ui.last_top_msg=displayed_msgs[displayed_msgs.length-1]}}else{TS.model.ui.last_top_msg=null}$("html").unbind("mousemove.monkeyScroll")},groupMessageReceived:function(group,msg){if(group.id!=TS.model.active_group_id)return;if(!msg){TS.error("no msg?");return}var msgs=group.msgs;if(TS.boot_data.feature_message_replies){var visible_msgs=_.reject(group.msgs,TS.utility.msgs.isMsgHidden);msgs=visible_msgs}if(TS.boot_data.feature_message_replies&&TS.utility.msgs.isMsgHidden(msg))return;var will_be_rolled_up=msgs.length>1&&TS.utility.msgs.msgMightBeRolledUp(msg)&&TS.utility.msgs.msgMightBeRolledUp(msgs[1]);if(will_be_rolled_up||msgs.length==1||msgs[0]!=msg){TS.client.msg_pane.rebuildMsgsWithReason("groupMessageReceived")}else{TS.view.addMsg(msg,group.unread_cnt);if(TS.client&&TS.client.msg_pane)TS.client.msg_pane.maybeClearUnreadDivider(group,msg)}},groupMessageRemoved:function(group,msg){if(group.id!=TS.model.active_group_id)return;if(!msg){TS.error("no msg?");return}TS.view.removeMsg(group,msg)},groupMessageChanged:function(group,msg,changed_keys){if(group.id!=TS.model.active_group_id)return;setTimeout(function(){TS.view.rebuildMsg(msg,changed_keys)},0)},groupMarked:function(group){if(group.id!=TS.model.active_group_id)return;TS.client.msg_pane.assignLastReadMsgDiv(group);TS.view.reClassUnreads(group.last_read)},groupUnreadCountChanged:function(group,msg){if(!group)return;if(TS.client.channel_pane.maybeRebuildBecauseUnreadCntChanged(group))return;var selector="."+TS.templates.makeGroupDomId(group);var $group=$(selector);if(group.unread_cnt===0){$group.removeClass("unread mention")}else{$group.addClass("unread");if(group.unread_highlight_cnt>0)$group.addClass("mention")}if(group._show_in_list_even_though_no_unreads){$group.addClass("show_in_list_even_though_no_unreads")}else{$group.removeClass("show_in_list_even_though_no_unreads")}var $group_link=$group.find(".group_name");if($group_link.length){$group_link.attr("aria-label",TS.templates.builders.makeChannelLinkAriaLabelSafe(group))}selector="."+TS.templates.makeUnreadMsgsDomId(group);var $unread=$(selector);if(group.unread_cnt===0){$unread.html(group.unread_cnt).addClass("hidden")}else{if(group.unread_cnt<10){$unread.html(group.unread_cnt).removeClass("hidden")}else{$unread.html("9+").removeClass("hidden")}}TS.client.ui.checkUnseenChannelsImsGroupsWithUnreads();TS.client.msg_pane.maybeInsertUnreadDividerAndNewMsgsBar(group);TS.client.msg_pane.maybeResetAndAutoScroll(group)},groupUnreadHighlightCountChanged:function(group,msg){if(!group)return;if(TS.client.channel_pane.maybeRebuildBecauseUnreadCntChanged(group))return;var selector="."+TS.templates.makeUnreadHighlightDomId(group);if(group.unread_highlight_cnt===0){$(selector).html(group.unread_highlight_cnt).addClass("hidden")}else{if(group.unread_highlight_cnt<10){$(selector).html(group.unread_highlight_cnt).removeClass("hidden")}else{$(selector).html("9+").removeClass("hidden")}}},groupTopicChanged:function(group,user_id,topic){if(!group)return;if(group.id!=TS.model.active_group_id)return;TS.client.msg_pane.updateEndMarker()},groupPurposeChanged:function(group,user_id,purpose){if(!group)return;if(group.id!=TS.model.active_group_id)return;TS.client.msg_pane.updateEndMarker()},groupOpened:function(group){TS.client.msg_pane.rebuildChannelMembersList();TS.client.channel_pane.rebuild("channels","starred")},groupClosed:function(group){TS.client.msg_pane.rebuildChannelMembersList();TS.client.channel_pane.rebuild("channels","starred")},groupArchived:function(group){TS.client.channel_pane.rebuild("channels","starred");if(group.id!=TS.model.active_group_id)return;TS.client.archives.start()},groupUnArchived:function(group){TS.client.channel_pane.rebuild("channels","starred");if(group.id!=TS.model.active_group_id)return;TS.client.msg_pane.rebuildMsgs()},groupMsgNotSent:function(group,msg,imsg){if(group.id!=TS.model.active_group_id)return;TS.view.showUnSentControlsForMsg(msg,group,imsg)}})})();(function(){"use strict";TS.registerModule("view.im",{onStart:function(){TS.ims.opened_sig.add(TS.view.im.imOpened,TS.view.im);TS.ims.closed_sig.add(TS.view.im.imClosed,TS.view.im);TS.ims.switched_sig.add(TS.view.im.imSwitched,TS.view.im);TS.ims.history_fetched_sig.add(TS.view.im.imHistoryFetched,TS.view.im);TS.ims.history_being_fetched_sig.add(TS.view.im.imHistoryBeingFetched,TS.view.im);TS.ims.message_received_sig.add(TS.view.im.imMessageReceived,TS.view.im);TS.ims.message_removed_sig.add(TS.view.im.imMessageRemoved,TS.view.im);TS.ims.message_changed_sig.add(TS.view.im.imMessageChanged,TS.view.im);TS.ims.marked_sig.add(TS.view.im.imMarked,TS.view.im);TS.ims.unread_changed_sig.add(TS.view.im.imUnreadCountChanged,TS.view.im);TS.ims.unread_highlight_changed_sig.add(TS.view.im.imUnreadHighlightCountChanged,TS.view.im);TS.ims.msg_not_sent_sig.add(TS.view.im.imMsgNotsent,TS.view.im)},imOpened:function(im){TS.client.msg_pane.rebuildChannelMembersList();TS.client.channel_pane.rebuild("ims","starred")},imClosed:function(im){TS.client.msg_pane.rebuildChannelMembersList();TS.client.channel_pane.rebuild("ims","starred")},imSwitched:function(){TS.view._maybeUpdateOnboarding();TS.view.switchedHelper();if(!TS.newxp.inOnboarding())TS.view.unAdjustForWelcomeSlideShow();TS.view.updateTitleWithContext();TS.view.updateTypingText()},imHistoryFetched:function(im){if(im.id!==TS.model.active_im_id)return;TS.client.ui.afterHistoryFetch(im)},imHistoryBeingFetched:function(im){if(im.id!==TS.model.active_im_id)return;TS.client.msg_pane.updateEndMarker();im=TS.ims.getImById(TS.model.active_im_id);if(!im||!im.msgs.length)return;if(TS.model.ms_connected){if(im.history_changed){TS.model.ui.last_top_msg=null}else{var displayed_msgs=TS.utility.msgs.getDisplayedMsgs(im.msgs);TS.model.ui.last_top_msg=displayed_msgs[displayed_msgs.length-1]}}else{TS.model.ui.last_top_msg=null}TS.client.msg_pane.updateEndMarker();$("html").unbind("mousemove.monkeyScroll")},imMessageReceived:function(im,msg){if(!im.is_open){TS.client.channel_pane.rebuild("ims","starred")}if(im.id!==TS.model.active_im_id)return;if(!msg){TS.error("no msg?");return}if(TS.boot_data.feature_message_replies&&TS.utility.msgs.isMsgHidden(msg))return;if(im.msgs.length===1||im.msgs[0]!==msg){TS.client.msg_pane.rebuildMsgsWithReason("imMessageReceived")}else{TS.view.addMsg(msg,im.unread_cnt);if(TS.client&&TS.client.msg_pane)TS.client.msg_pane.maybeClearUnreadDivider(im,msg)}},imMessageRemoved:function(im,msg){if(im.id!==TS.model.active_im_id)return;if(!msg){TS.error("no msg?");return}TS.view.removeMsg(im,msg)},imMessageChanged:function(im,msg,changed_keys){if(im.id!==TS.model.active_im_id)return;setTimeout(function(){TS.view.rebuildMsg(msg,changed_keys)},0)},imMarked:function(im){TS.client.channel_pane.rebuild("ims","starred");if(im.id!==TS.model.active_im_id)return;TS.client.msg_pane.assignLastReadMsgDiv(im);TS.view.reClassUnreads(im.last_read)},imUnreadCountChanged:function(im,msg){if(!im)return;if(TS.client.channel_pane.maybeRebuildBecauseUnreadCntChanged(im))return;var member=TS.members.getMemberById(im.user);var selector="."+TS.templates.makeMemberDomId(member);var $im=$(selector);var highlight_selector="."+TS.templates.makeUnreadHighlightDomId(member);if(im.unread_cnt===0){$im.removeClass("unread mention");$(highlight_selector).html(im.unread_cnt).addClass("hidden")}else{if(im.unread_cnt<10){$im.addClass("unread mention");$(highlight_selector).html(im.unread_cnt).removeClass("hidden")}else{$im.addClass("unread mention");$(highlight_selector).html("9+").removeClass("hidden")}}var $im_link=$im.find(".im_name");if($im_link.length){$im_link.attr("aria-label",TS.templates.builders.makeMemberLinkAriaLabelSafe({member:member,im:im}))}TS.client.ui.checkUnseenChannelsImsGroupsWithUnreads();TS.client.msg_pane.maybeInsertUnreadDividerAndNewMsgsBar(im);TS.client.msg_pane.maybeResetAndAutoScroll(im)},imUnreadHighlightCountChanged:function(im,msg){if(!im)return;var selector="."+TS.templates.makeUnreadHighlightDomId(im);$(selector).html(im.unread_highlight_cnt);TS.client.ui.checkUnseenChannelsImsGroupsWithUnreads()},imMsgNotsent:function(im,msg,imsg){if(im.id!==TS.model.active_im_id)return;TS.view.showUnSentControlsForMsg(msg,im,imsg)}})})();(function(){"use strict";TS.registerModule("view.members",{onStart:function(){TS.members.presence_changed_sig.add(TS.view.members.memberPresenceChanged,TS.view.members);TS.members.status_changed_sig.add(TS.view.members.memberStatusChanged,TS.view.members);TS.members.joined_team_sig.add(TS.view.members.memberJoinedTeam,TS.view.members);TS.members.members_for_user_changed_sig.add(TS.view.members.memberChangeVisibilityToUser,TS.view.members);TS.members.changed_name_sig.add(TS.view.members.memberChangedName,TS.view.members);TS.members.changed_real_name_sig.add(TS.view.members.memberChangedRealName,TS.view.members);TS.members.changed_self_sig.add(TS.view.members.somethingChangedOnUser,TS.view.members);TS.members.changed_deleted_sig.add(TS.view.members.memberChangedDeleted,TS.view.members);TS.members.changed_profile_sig.add(TS.view.members.memberChangedProfile,TS.view.members);TS.members.changed_tz_sig.add(TS.view.members.memberChangedTZ,TS.view.members);TS.members.changed_account_type_sig.add(TS.view.members.memberAccountTypeChanged,TS.view.members);TS.members.changed_admin_perms_sig.add(TS.view.members.memberAdminPermsChanged,TS.view.members);TS.typing.started_sig.add(TS.view.members.memberTypingStarted,TS.view.members);TS.typing.ended_sig.add(TS.view.members.memberTypingEnded,TS.view.members);TS.stars.member_stars_fetched_sig.add(TS.view.members.memberStarsFetched,TS.view.members)},memberPresenceChanged:function(member){if(!member)return;var selector,$selected,presence;if(member.is_self){if(TS.model.ms_connected)TS.view.ms.maybeChangeConnectionDisplay();var menu_presence_toggle=$("#menu").find("#member_presence").find(".menu_item_label");if(member.presence=="away"){menu_presence_toggle.text("[Away] Set yourself to active")}else{menu_presence_toggle.text("Set yourself away")}}else{selector="."+TS.templates.makeMemberDomId(member);$selected=$(selector).not(".call_icon");if(member.presence=="away"){$selected.addClass("away")}else{$selected.removeClass("away")}}selector="."+TS.templates.makeMemberPresenceDomClass(member.id);presence=TS.templates.makeMemberPresenceStateClass(member);$(selector).removeClass("away active dnd").addClass(presence).attr("title",member.presence);var im=TS.ims.getImByMemberId(member.id);if(im){$(selector).closest(".im_name").attr("aria-label",TS.templates.builders.makeMemberLinkAriaLabelSafe({member:member,im:im}))}TS.view.last_team_list_html=null},memberStatusChanged:function(member){if(!member)return;if(member.is_self)$(".user_status_label").text(member.status||"");var selector="."+TS.templates.makeMemberStatusDomClass(member.id);$(selector).html(member.status?member.status:"-");TS.view.updateTeamListCache()},memberJoinedTeam:function(member){TS.view.rebuildTeamList(true)},member_changed_visibility_to_user_tim:0,memberChangeVisibilityToUser:function(){clearTimeout(TS.view.members.member_changed_visibility_to_user_tim);TS.view.members.member_changed_visibility_to_user_tim=setTimeout(function(){TS.client.channel_pane.rebuild("ims","starred");TS.view.rebuildTeamList(true)},1e3)},memberChangedName:function(member){if(member.id==TS.model.user.id){TS.view.members.updateUserDisplayName();TS.prefs.setHighlightWords(TS.model.prefs.highlight_words)}TS.view.updateTitleWithContext();TS.client.ui.rebuildAll();TS.view.rebuildTeamMember(member);if(member.id!=TS.model.previewed_member_id)return;TS.client.ui.previewMember(member.id)},memberChangedRealName:function(member){TS.view.rebuildTeamList(true)},somethingChangedOnUser:function(member){TS.view.showProperTeamPaneFiller()},memberChangedDeleted:function(member){TS.client.channel_pane.rebuild("ims","starred");TS.client.msg_pane.rebuildChannelMembersList();TS.view.rebuildTeamList(true)},memberChangedProfile:function(member){var bg_img_urls=[];if(!TS.members.is_in_bulk_upsert_mode){TS.client.ui.rebuildAllButMsgs();TS.view.rebuildMsgsIncludingMember(member)}if(member.id==TS.model.user.id){TS.view.members.updateUserDisplayName();if(TS.boot_data.feature_user_custom_status)TS.view.members.updateUserCurrentStatus();if(member.is_restricted){if(TS.environment.is_retina){bg_img_urls.push("url("+cdn_url+"/0180/img/avatar_overlays_@2x.png"+")")}else{bg_img_urls.push("url("+cdn_url+"/0180/img/avatar_overlays.png"+")")}}bg_img_urls.push("url("+member.profile.image_72+")");$('a[data-member-id="'+TS.model.user.id+'"] .member_image, a[data-member-id="'+TS.model.user.id+'"].member_image').attr("style","background-image: "+bg_img_urls.join(","));$('#menu a[data-member-id="'+TS.model.user.id+'"].member_image').attr("style","background-image: "+TS.templates.builders.makeMemberPreviewCardLinkImageBackground(TS.model.user.id))}if(TS.viewmodel&&TS.viewmodel.teamdirectory&&!member._submodel){}else{TS.view.rebuildTeamMember(member)}if(member.id!=TS.model.previewed_member_id)return;TS.client.ui.previewMember(member.id)},memberChangedTZ:function(member){if(!TS.members.is_in_bulk_upsert_mode)TS.client.ui.rebuildAll();TS.view.rebuildTeamMember(member);if(member.id!=TS.model.previewed_member_id)return;TS.client.ui.previewMember(member.id)},member_account_changed_tim:0,memberAccountTypeChanged:function(member){if(member&&member.id==TS.model.user.id)return;clearTimeout(TS.view.members.member_account_changed_tim);TS.view.members.member_account_changed_tim=setTimeout(function(){TS.view.rebuildTeamList(true);if(member.id!=TS.model.previewed_member_id)return;TS.client.ui.previewMember(member.id)},1e3)},memberAdminPermsChanged:function(member){if(member&&member.id==TS.model.user.id)TS.ui.admin_invites.maybeShowInviteLink();$("#team_list_admin_link").toggleClass("hidden",!member.is_admin)},updateUserDisplayName:function(){if(TS.boot_data.feature_name_tagging_client){$(".current_user_name").html(TS.members.getMemberDisplayName(TS.model.user,true));$(".current_user_full_name").html(TS.utility.htmlEntities(TS.members.getMemberFullName(TS.model.user)))}else{$(".current_user_name").html(TS.members.getMemberDisplayName(TS.model.user,true))}},updateUserCurrentStatus:function(){if(!TS.boot_data.feature_user_custom_status)return;var current_status=TS.members.getMemberCurrentStatus(TS.model.user);$(".current_user_current_status").text(current_status);$("#current_user_name_and_current_status").attr("title",TS.utility.htmlEntities(current_status))},getUserPresenceStr:function(){var user=TS.model.user;if(user.manual_presence==="away"){return user.presence+" (manual)"}else{return user.presence}},memberTypingStarted:function(model_ob,member){if(!TS.model.prefs.show_typing)return;var active_model_ob=TS.shared.getActiveModelOb();if(active_model_ob&&model_ob.id==active_model_ob.id)TS.view.updateTypingText();if(member.is_self)return;var selector=TS.view.members.getSelectorForTypingIndicator(model_ob,member);if(selector)$(selector).addClass("typing")},memberTypingEnded:function(model_ob,member){var active_model_ob=TS.shared.getActiveModelOb();if(active_model_ob&&model_ob.id==active_model_ob.id)TS.view.updateTypingText();var selector=TS.view.members.getSelectorForTypingIndicator(model_ob,member);if(selector)$(selector).removeClass("typing")},getSelectorForTypingIndicator:function(model_ob,member){var selector;var active_model_ob=TS.shared.getActiveModelOb();if(model_ob.is_im){selector=".channels_list_holder ul li."+TS.templates.makeMemberDomId(member)}else if(active_model_ob&&model_ob.id===active_model_ob.id){selector="#"+TS.templates.makeChannelListDomId(model_ob)+" ."+TS.templates.makeMemberDomId(member)}return selector},memberStarsFetched:function(err,member){TS.view.toggleStarsError(!!err);if(err)return;if(!member||!member.is_self)return;TS.view.rebuildStars()}})})();(function(){"use strict";TS.registerModule("view.mpim",{onStart:function(){TS.mpims.switched_sig.add(TS.view.mpim.mpimSwitched,TS.view.mpim);TS.mpims.history_fetched_sig.add(TS.view.mpim.mpimHistoryFetched,TS.view.mpim);TS.mpims.history_being_fetched_sig.add(TS.view.mpim.mpimHistoryBeingFetched,TS.view.mpim);TS.mpims.message_received_sig.add(TS.view.mpim.mpimMessageReceived,TS.view.mpim);TS.mpims.message_removed_sig.add(TS.view.mpim.mpimMessageRemoved,TS.view.mpim);TS.mpims.message_changed_sig.add(TS.view.mpim.mpimMessageChanged,TS.view.mpim);TS.mpims.joined_sig.add(TS.view.mpim.mpimJoined,TS.view.mpim);TS.mpims.opened_sig.add(TS.view.mpim.mpimOpened,TS.view.mpim);TS.mpims.closed_sig.add(TS.view.mpim.mpimClosed,TS.view.mpim);TS.mpims.marked_sig.add(TS.view.mpim.mpimMarked,TS.view.mpim);TS.mpims.unread_changed_sig.add(TS.view.mpim.mpimUnreadCountChanged,TS.view.mpim);TS.mpims.unread_highlight_changed_sig.add(TS.view.mpim.mpimUnreadHighlightCountChanged,TS.view.mpim);TS.mpims.msg_not_sent_sig.add(TS.view.mpim.mpimMsgNotsent,TS.view.mpim)},mpimSwitched:function(){TS.view._maybeUpdateOnboarding();var skip_rebuild_msgs=TS.boot_data.feature_prevent_msg_rebuild&&!TS.model.ms_logged_in_once;TS.view.switchedHelper(skip_rebuild_msgs);if(!TS.newxp.inOnboarding())TS.view.unAdjustForWelcomeSlideShow();TS.view.updateTitleWithContext();TS.view.updateTypingText()},mpimHistoryFetched:function(mpim){if(mpim.id!==TS.model.active_mpim_id)return;TS.client.ui.afterHistoryFetch(mpim)},mpimHistoryBeingFetched:function(mpim){if(mpim.id!==TS.model.active_mpim_id)return;TS.client.msg_pane.updateEndMarker();mpim=TS.mpims.getMpimById(TS.model.active_mpim_id);if(!mpim||!mpim.msgs.length)return;if(TS.model.ms_connected){if(mpim.history_changed){TS.model.ui.last_top_msg=null}else{var displayed_msgs=TS.utility.msgs.getDisplayedMsgs(mpim.msgs);TS.model.ui.last_top_msg=displayed_msgs[displayed_msgs.length-1]}}else{TS.model.ui.last_top_msg=null}$("html").unbind("mousemove.monkeyScroll")},mpimMessageReceived:function(mpim,msg){if(!mpim.is_open){TS.client.channel_pane.rebuild("ims","starred")}if(mpim.id!==TS.model.active_mpim_id)return;if(!msg){TS.error("no msg?");return}if(TS.boot_data.feature_message_replies&&TS.utility.msgs.isMsgHidden(msg))return;if(mpim.msgs.length===1||mpim.msgs[0]!==msg){TS.client.msg_pane.rebuildMsgsWithReason("mpimMessageReceived")}else{TS.view.addMsg(msg,mpim.unread_cnt);if(TS.client&&TS.client.msg_pane)TS.client.msg_pane.maybeClearUnreadDivider(mpim,msg)}},mpimMessageRemoved:function(mpim,msg){if(mpim.id!==TS.model.active_mpim_id)return;if(!msg){TS.error("no msg?");return}TS.view.removeMsg(mpim,msg)},mpimMessageChanged:function(mpim,msg,changed_keys){if(mpim.id!==TS.model.active_mpim_id)return;setTimeout(function(){TS.view.rebuildMsg(msg,changed_keys)},0)},mpimJoined:function(){TS.client.channel_pane.rebuild("ims","starred")},mpimOpened:function(){TS.client.channel_pane.rebuild("ims","starred")},mpimClosed:function(){TS.client.channel_pane.rebuild("ims","starred")},mpimMarked:function(mpim){TS.client.channel_pane.rebuild("ims","starred");if(mpim.id!==TS.model.active_mpim_id)return;TS.client.msg_pane.assignLastReadMsgDiv(mpim);TS.view.reClassUnreads(mpim.last_read)},mpimUnreadCountChanged:function(mpim,msg){if(!mpim)return;if(TS.client.channel_pane.maybeRebuildBecauseUnreadCntChanged(mpim))return;var $mpim=$("#im-list, #starred-list").find("."+TS.templates.makeMpimDomId(mpim));$mpim.replaceWith(TS.templates.mpim({model_ob:mpim}));TS.client.ui.checkUnseenChannelsImsGroupsWithUnreads();TS.client.msg_pane.maybeInsertUnreadDividerAndNewMsgsBar(mpim);TS.client.msg_pane.maybeResetAndAutoScroll(mpim)},mpimUnreadHighlightCountChanged:function(mpim,msg){},mpimMsgNotsent:function(mpim,msg,imsg){if(mpim.id!==TS.model.active_mpim_id)return;TS.view.showUnSentControlsForMsg(msg,mpim,imsg)}})})();(function(){"use strict";TS.registerModule("view.ms",{onStart:function(){TS.ms.connected_sig.add(TS.view.ms.socketConnected,TS.view.ms);TS.ms.trouble_sig.add(TS.view.ms.socketTroubled,TS.view.ms);TS.ms.disconnected_sig.add(TS.view.ms.socketDisconnected,TS.view.ms);TS.ms.pong_sig.add(TS.view.ms.ponged,TS.view.ms);TS.ms.reconnecting_sig.add(TS.view.ms.socketReconnecting,TS.view.ms)},ever_connected:false,socketConnected:function(was_fast_reconnect){if(TS.view.ms.ever_connected){TSConnLogger.log("ms_connection_complete","TS.view.ms.socketConnected subsequent time")}else{TSConnLogger.log("ms_connection_complete","TS.view.ms.socketConnected first time");if(TS.metrics.getLatestMark("start_load")){TS.metrics.measure("client_load","start_load");if(TS.model.is_our_app){if(TS.didWeBootWithCache()){TS.metrics.measure("client_load_with_cache","start_load")}else{TS.metrics.measure("client_load_without_cache","start_load")}}}if(TS.boot_data.http_chunk_head_bucket=="chunked"){TS.metrics.measure("client_load_with_chunking_v2","start_nav")}else if(TS.boot_data.http_chunk_head_bucket=="control"){TS.metrics.measure("client_load_without_chunking_v2","start_nav")}TS.metrics.measure("client_total_load","start_nav");if(TS.boot_data.exp_cdn=="control"){TS.metrics.measure("exp_cdn_total_load_control","start_nav")}else if(TS.boot_data.exp_cdn=="cdn_shard_evenly"){TS.metrics.measure("exp_cdn_total_load_shard_evenly","start_nav")}else if(TS.boot_data.exp_cdn=="cdn_shard_fixed"){TS.metrics.measure("exp_cdn_total_load_cdn_shard_fixed","start_nav")}else if(TS.boot_data.exp_cdn=="cdn_h2"){TS.metrics.measure("exp_cdn_total_load_cdn_h2","start_nav")}else if(TS.boot_data.exp_cdn=="cdn_shard_js"){TS.metrics.measure("exp_cdn_total_load_cdn_shard_js","start_nav")}TS.metrics.logPerfTimingSections()}TSConnLogger.setConnecting(false);if(TS.view.ms.ever_connected){TS.utility.msgs.removeAllEphemeralMsgsByType("disconnected_feedback");TS.client.ui.rebuildAllButMsgs();TS.client.ui.rebuildMemberListToggle();TS.mentions.maybeUpdateMentions();if(was_fast_reconnect){var model_ob=TS.shared.getActiveModelOb();if(model_ob)TS.shared.maybeDealWithAllSentTempMsgs(model_ob,TS.shared.getControllerForModelOb(model_ob))}}else{_countAssetNodes()}TS.view.ms.ever_connected=true;TS.client.msg_input.setOnline();TS.info("Hiding the reconnection banner because we are connected");_cancelDelayedReconnectingBanner();$("#connection_div").html("").addClass("hidden");TS.client.msg_pane.topMessagesBannerHidden();TS.view.ms.changeConnectionStatus("online");TS.view.prefs.toggleSpellcheck();TS.view.checkIfInputShouldBeDisabledAndPopulate();TS.ui.a11y.annouceCurrentChannelOrImOrGroup()},socketTroubled:function(){TS.view.ms.changeConnectionStatus("trouble");TS.client.msg_input.setOffline();TS.info("Hiding the reconnection banner because we are troubled");_cancelDelayedReconnectingBanner()},socketDisconnected:function(){TS.view.ms.changeConnectionStatus("offline");TS.client.msg_input.setOffline();TS.info("Hiding the reconnection banner because we are disconnected");_cancelDelayedReconnectingBanner()},ponged:function(){var $icon=$("#presence");if($icon.css("opacity")==1){$icon.css("opacity",.98)}else{$icon.css("opacity",1)}},socketReconnecting:function(secs){if(TS.model.window_unloading){TS.info("Hiding the reconnection banner because we are unloading");_cancelDelayedReconnectingBanner();$("#connection_div").html("").addClass("hidden");TS.client.msg_pane.topMessagesBannerHidden()}else if($("#connection_div").hasClass("hidden")){_showReconnectingBannerAfterDelay(secs)}else{_showReconnectingBannerImmediately(secs)}},current_connection_status:null,changeConnectionStatus:function(status){TS.view.ms.current_connection_status=status;TS.view.maybeChangeFavIco();TS.view.ms.maybeChangeConnectionDisplay()},maybeChangeConnectionDisplay:function(){var $presence=$("#presence");var status_for_class_name="";var label;switch(TS.view.ms.current_connection_status){case"online":TSSSB.call("setConnectionStatus","online");if(TS.model.user.presence==="away"){label="away";status_for_class_name="away"}else{label="active";status_for_class_name="active"}if(TS.members.isMemberInDnd(TS.model.user))status_for_class_name+=" dnd";break;case"trouble":TSSSB.call("setConnectionStatus","connecting");label="connecting...";status_for_class_name="connecting";break;default:TSSSB.call("setConnectionStatus","offline");label="away";status_for_class_name="away"}TS.tips.updateTipTitle($("#presence_container"),label);$presence.removeClass("active away connecting dnd");$presence.addClass(status_for_class_name)}});var _countAssetNodes=function(){var style_nodes=Array.prototype.slice.call(document.getElementsByTagName("style"));var link_nodes=Array.prototype.slice.call(document.getElementsByTagName("link"));var script_nodes=Array.prototype.slice.call(document.getElementsByTagName("script"));var inline_script_nodes=script_nodes.filter(function(script_node){return!script_node.src&&script_node.type!=="text/x-handlebars-template"});var external_script_nodes=script_nodes.filter(function(script_node){return!!script_node.src});var template_nodes=script_nodes.filter(function(script_node){return!script_node.src&&script_node.type==="text/x-handlebars-template"});link_nodes=link_nodes.filter(function(link_node){return link_node.rel==="stylesheet"});TS.metrics.store("inline_script_nodes",inline_script_nodes.length,{is_count:true});TS.metrics.store("inline_template_nodes",template_nodes.length,{is_count:true});TS.metrics.store("inline_style_nodes",style_nodes.length,{is_count:true});if(TS.boot_data.feature_no_rollups){TS.metrics.store("external_script_nodes_no_rollups",external_script_nodes.length,{is_count:true});TS.metrics.store("external_link_nodes_no_rollups",link_nodes.length,{is_count:true})}else{TS.metrics.store("external_script_nodes",external_script_nodes.length,{is_count:true});TS.metrics.store("external_link_nodes",link_nodes.length,{is_count:true})}};var RECONNECT_BANNER_DELAY_MS=5e3;var _reconnect_banner_delay_tim;var _reconnect_banner_timeout_secs;var _showReconnectingBannerAfterDelay=function(secs){
TS.info("Will show reconnection banner after delay");_reconnect_banner_timeout_secs=secs;if(_reconnect_banner_delay_tim)return;_reconnect_banner_delay_tim=setTimeout(function(){_reconnect_banner_delay_tim=undefined;_showReconnectingBannerImmediately(_reconnect_banner_timeout_secs)},RECONNECT_BANNER_DELAY_MS)};var _showReconnectingBannerImmediately=function(secs){TS.info("Showing reconnection banner immediately");_cancelDelayedReconnectingBanner();var txt="Reconnecting";if(secs){txt+=" in "+secs+" second"+(secs==1?"":"s...");if(secs>2)txt+=' <a onclick="TS.ms.manualReconnectNow()">Retry now?</a>'}else{txt+="..."}$("#connection_div").html(txt).removeClass("hidden");TS.client.msg_pane.topMessagesBannerShown()};var _cancelDelayedReconnectingBanner=function(){if(!_reconnect_banner_delay_tim){TS.info("Would cancel pending reconnection banner, but there is none");return}clearTimeout(_reconnect_banner_delay_tim);_reconnect_banner_delay_tim=undefined}})();(function(){"use strict";TS.registerModule("view.prefs",{onStart:function(){TS.prefs.webapp_spellcheck_changed_sig.add(TS.view.prefs.toggleSpellcheck,TS.view.prefs);TS.prefs.highlight_words_changed_sig.add(TS.client.msg_pane.rebuildMsgs,TS.view.prefs);TS.prefs.emoji_mode_changed_sig.add(TS.view.prefs.farReachingDisplayPrefChanged,TS.view.prefs);if(!TS.boot_data.feature_name_tagging_client){TS.prefs.team_require_at_for_mention_changed_sig.add(TS.view.prefs.farReachingDisplayPrefChanged,TS.view.prefs)}TS.prefs.expand_inline_imgs_changed_sig.add(TS.client.msg_pane.rebuildMsgs,TS.view.prefs);TS.prefs.expand_internal_inline_imgs_changed_sig.add(TS.client.msg_pane.rebuildMsgs,TS.view.prefs);TS.prefs.expand_non_media_attachments_changed_sig.add(TS.client.msg_pane.rebuildMsgs,TS.view.prefs);TS.prefs.obey_inline_img_limit_changed_sig.add(TS.client.msg_pane.rebuildMsgs,TS.view.prefs);TS.prefs.messages_theme_changed_sig.add(TS.ui.setThemeClasses,TS);TS.prefs.dtop_notif_changed_sig.add(TS.view.prefs.dTopNotificationChanged,TS.view.prefs);TS.prefs.muted_channels_changed_sig.add(TS.view.prefs.mutedChannelsChanged,TS.view.prefs);TS.prefs.sidebar_behavior_changed_sig.add(TS.view.prefs.sidebarBehaviorPrefChanged,TS.view.prefs);TS.prefs.team_hide_referers_changed_sig.add(TS.client.msg_pane.rebuildMsgs,TS.view.prefs);TS.prefs.team_perms_pref_changed_sig.add(TS.view.prefs.teamPermsPrefChanged,TS.view.prefs);TS.prefs.display_real_names_override_changed_sig.add(TS.view.prefs.farReachingDisplayPrefChanged,TS.view.prefs);TS.prefs.team_display_real_names_changed_sig.add(TS.view.prefs.farReachingDisplayPrefChanged,TS.view.prefs);if(TS.boot_data.feature_name_tagging_client){TS.prefs.display_preferred_names_changed_sig.add(TS.view.prefs.farReachingDisplayPrefChanged,TS.view.prefs)}TS.prefs.time24_changed_sig.add(TS.view.prefs.time24PrefChanged,TS.view.prefs);TS.prefs.sidebar_theme_changed_sig.add(TS.view.prefs.sidebarThemePrefChanged,TS.view.prefs);TS.prefs.mentions_exclude_at_channels_changed_sig.add(TS.view.prefs.rebuildMentionOptions,TS.view.prefs);TS.prefs.mentions_exclude_at_user_groups_changed_sig.add(TS.view.prefs.rebuildMentionOptions,TS.view.prefs);if(TS.boot_data.feature_prev_next_button){TS.prefs.prev_next_btn_changed_sig.add(TS.client.channel_pane.rebuildFooter,TS.view.prefs);TS.prefs.no_omnibox_in_channels_changed_sig.add(TS.client.channel_pane.rebuildFooter,TS.view.prefs)}else{TS.prefs.no_omnibox_in_channels_changed_sig.add(TS.client.channel_pane.updateQuickSwitcherBtnVisibility,TS.view.prefs);TS.prefs.k_key_omnibox_auto_hide_count_changed_sig.add(_maybeHideQuickSwitcherBtn,TS.view.prefs)}TS.prefs.separate_private_channels_changed_sig.add(_separatePrivateChannelsChanged);TS.prefs.team_display_email_addresses_changed_sig.add(TS.view.prefs.farReachingDisplayPrefChanged,TS.view.prefs)},toggleSpellcheck:function(){$("textarea").attr("autocorrect","off");$("textarea").attr("autocomplete","off");if(TS.model.prefs.webapp_spellcheck){$("textarea").attr("spellcheck",true)}else{$("textarea").attr("spellcheck",false)}},farReachingDisplayPrefChanged:function(){TS.client.msg_pane.rebuildMsgsWithReason("farReachingDisplayPrefChanged");TS.search.view.renderResults();TS.view.rebuildMentions();TS.view.rebuildStars();TS.view.files.throttledRebuildList();TS.view.members.updateUserDisplayName();if(TS.boot_data.feature_user_custom_status)TS.view.members.updateUserCurrentStatus();TS.client.channel_pane.rebuild("ims","starred");TS.client.msg_pane.displayTitle();TS.client.msg_pane.rebuildChannelMembersList();TS.view.rebuildPreviewedMember();if(!TS.boot_data.feature_name_tagging_client){if(TS.members.shouldDisplayRealNames()){$("#col_channels").addClass("real_names")}else{$("#col_channels").removeClass("real_names")}}if(TS.model.previewed_file_id)TS.client.ui.files.rebuildFilePreview(TS.files.getFileById(TS.model.previewed_file_id))},dTopNotificationChanged:function(){TS.utility.msgs.reCalcAndCountAllUnreads();TS.client.channel_pane.rebuild("starred","channels")},mutedChannelsChanged:function(){if(TS.model.newly_unmuted_channels&&TS.model.newly_unmuted_channels.length){TS.log(389,"mutedChannelsChanged: recalculating unreads for newly-unmuted channel(s): "+TS.model.newly_unmuted_channels.join(", "));TS.utility.msgs.reCalcAndCountSomeUnreads(TS.model.newly_unmuted_channels)}else{TS.log(389,"mutedChannelsChanged: No newly-unmuted channels, no need to recalculate unreads.")}TS.model.newly_muted_channels=[];TS.model.newly_unmuted_channels=[];TS.client.channel_pane.rebuild("starred","channels","ims");TS.client.msg_pane.displayTitle()},sidebarBehaviorPrefChanged:function(){TS.utility.msgs.reCalcAndCountAllUnreads()},teamPermsPrefChanged:function(pref_name){if(pref_name=="who_can_at_channel"||pref_name=="who_can_at_everyone"||pref_name=="who_can_post_general"){TS.utility.msgs.reCalcAndCountAllUnreads()}if(pref_name=="who_can_edit_user_groups"||pref_name=="who_can_create_delete_user_groups"){TS.view.userGroupPrefUpdated()}TS.client.channel_pane.rebuild("channels","starred");TS.view.checkIfInputShouldBeDisabledAndPopulate()},time24PrefChanged:function(){TS.client.msg_pane.rebuildMsgs();TS.search.view.renderResults();TS.view.rebuildMentions();TS.view.rebuildStars();TS.view.files.throttledRebuildList();TS.client.channel_pane.rebuild("ims","starred");if(TS.model.previewed_file_id)TS.client.ui.files.rebuildFilePreview(TS.files.getFileById(TS.model.previewed_file_id))},sidebarThemePrefChanged:function(remove_last_theme_selected){remove_last_theme_selected=remove_last_theme_selected!==false;if(TS.model.prefs.sidebar_theme){if(TS.prefs.last_theme_selected_in_UI&&TS.model.prefs.sidebar_theme!==TS.prefs.last_theme_selected_in_UI){return}else if(TS.prefs.last_theme_selected_in_UI&&remove_last_theme_selected){TS.prefs.last_theme_selected_in_UI=null;TS.model.prefs.sidebar_theme_custom_values=TS.sidebar_themes.default_themes[TS.model.prefs.sidebar_theme]}if(TS.model.prefs.sidebar_theme=="arctic_theme")TS.model.prefs.sidebar_theme="hoth_theme";var $client_ui=$("#client-ui");var prefix="sidebar_theme_";var el=$client_ui[0];var classes=el.className.split(" ").filter(function(c){return c.lastIndexOf(prefix,0)!==0});el.className=classes.join(" ");$client_ui.addClass(prefix+TS.model.prefs.sidebar_theme)}if(TS.model.prefs.sidebar_theme=="default"||TS.model.prefs.sidebar_theme=="default_theme"||TS.model.prefs.sidebar_theme=="basic_theme"){$("#sidebar_theme_css").remove()}else if(TS.model.prefs.sidebar_theme_custom_values){var sidebar_theme=JSON.parse(TS.model.prefs.sidebar_theme_custom_values);if(TS.environment.supports_custom_scrollbar){_.forEach(sidebar_theme,function(value,key){sidebar_theme[key+"_rgb"]=TS.utility.hex2rgb(value)})}var stylesheet=TS.templates.sidebar_theme_css({theme:sidebar_theme});if($("#sidebar_theme_css").length){$("#sidebar_theme_css").replaceWith(stylesheet)}else{$("head").append(stylesheet)}}TS.view.updateTitleBarColor();TSSSB.call("refreshTileColors")},rebuildMentionOptions:function(){var include_text;var exclude_at_channels=TS.model.prefs.mentions_exclude_at_channels;var exclude_at_user_groups=TS.model.prefs.mentions_exclude_at_user_groups;if(exclude_at_channels&&exclude_at_user_groups){include_text="mentions and reactions, no @channel or User Groups"}else if(!exclude_at_channels&&exclude_at_user_groups){include_text="mentions, reactions, and @channel mentions"}else if(exclude_at_channels&&!exclude_at_user_groups){include_text="mentions, reactions, and User Group mentions"}else{include_text="everything"}var html=TS.templates.mentions_options({include_text:include_text});$("#mentions_options").html(html);$(".mentions_filter_menu_target").click(TS.menu.startWithMentionsFilter)},userGroupPrefUpdated:function(){var $user_group_edit_tab=$("#user_group_edit.tab_action");var show_user_groups_edit=TS.members.canUserEditUserGroups();var show_user_groups_add=TS.members.canUserCreateAndDeleteUserGroups();$('[data-action="admin_user_groups_modal"]').toggleClass("hidden",show_user_groups_edit);$('[data-action="admin_user_groups_modal_new"]').toggleClass("hidden",show_user_groups_add);$user_group_edit_tab.toggleClass("hidden",!(show_user_groups_edit||show_user_groups_add))}});var _maybeHideQuickSwitcherBtn=function(){if(TS.model.prefs.k_key_omnibox_auto_hide_count===5&&!TS.model.prefs.no_omnibox_in_channels){TS.prefs.setPrefByAPI({name:"no_omnibox_in_channels",value:true});TS.clog.track("QUICKSWITCHER_ACTION",{trigger:"keyboard_shortcut",action:"button_hidden"})}};var _separatePrivateChannelsChanged=function(){TS.client.channel_pane.rebuild("starred","channels")}})();(function(){"use strict";TS.registerModule("client.windows",{open_log:"WINDOWS OPENED:",win_became_key_sig:new signals.Signal,win_resigned_key_sig:new signals.Signal,win_crashed_sig:new signals.Signal,win_will_close_sig:new signals.Signal,win_began_loading_sig:new signals.Signal,win_estimated_progress_changed_sig:new signals.Signal,win_finished_loading_sig:new signals.Signal,onStart:function(){TS.client.login_sig.add(TS.client.windows.onLogin);TS.ui.window_unloaded_sig.add(_clientWindowUnloaded);_storeLastWindowSizeByApiThrottled=TS.utility.throttleFunc(_storeLastWindowSizeByApi,2e3)},onLogin:function(ok,data){var wins;var win;var token;var got_existing_win=false;var windows_str=TSSSB.call("listWindows");TS.log(438,"listWindows windows_str:"+windows_str);if(windows_str){wins=JSON.parse(windows_str);TS.dir(438,wins,"listWindows wins:");for(token in wins){win=_wins[token]=wins[token];win.token=token;if(win["windowType"]!="screenhero"&&win["windowType"]!=="calls"){got_existing_win=true}win.no_spinner=true;_setUpWindow(win)}}if(got_existing_win){_storeWins();return}var LS_wins=TS.storage.fetchClientWindows();var LS_wins_cnt=Object.keys(LS_wins).length;if(!LS_wins_cnt)return;var delay_ms=3e3;setTimeout(function(){var reopen=function(){for(token in LS_wins){win=LS_wins[token];TS.client.windows.openWindow(win)}};TS.generic_dialog.start({unique:"reopen_windows",title:"You previously had "+LS_wins_cnt+" other "+(LS_wins_cnt>1?"windows":"window")+" open",body:"Would you like to re-open "+(LS_wins_cnt>1?"them":"it")+"?",show_cancel_button:true,show_go_button:true,go_button_text:"Yes, re-open "+(LS_wins_cnt>1?"them":"it")+" please",go_button_class:"btn_success",cancel_button_text:"No thanks",onGo:_.once(function(){setTimeout(reopen,1e3)}),onCancel:function(){TS.storage.storeClientWindows({})}})},delay_ms)},openFileWindow:function(file_id,qs){if(!TS.model.supports_spaces_in_windows)return false;var file=TS.files.getFileById(file_id);if(!file){return TS.files.fetchFileInfo(file_id).then(function(file){return _openFileWindow(file,qs)})}return _openFileWindow(file,qs)},openWindow:function(win){if(isNaN(win.x)||isNaN(win.y)||isNaN(win.width)||isNaN(win.height)){var default_coords={x:0,y:0,w:1024,h:768};var sizer_win=_fetchLastWindowSize();TS.dir(438,sizer_win,"sizer_win");if(sizer_win){default_coords.x=sizer_win.x;default_coords.y=sizer_win.y;default_coords.w=sizer_win.width;default_coords.h=sizer_win.height}if(isNaN(win.width)||isNaN(win.height)){win.width=default_coords.w;win.height=default_coords.h}if(isNaN(win.x)||isNaN(win.y)){win.x=default_coords.x+22;win.y=default_coords.y+22}}if(!win.no_spinner){if(!win.destination_url){if(win.url){win.destination_url=win.url}}if(window.winssb){win.url="data:text/html;charset=utf-8,"+_getSpinnerHtml(win)}else{}}TS.dir(438,win,"calling openWindow");var win_for_log=_.cloneDeep(win);win_for_log.url=win_for_log.url&&win_for_log.url.substr(0,100);TS.client.windows.open_log+="\n\n"+JSON.stringify(win_for_log,null,2);win.token=TSSSB.call("openWindow",win);_wins[win.token]=win;_storeWins(win.token);TS.log(438,"new window:"+win.token);window.last_win=win;return win.token},closeFileWindow:function(file_id){var win=TS.client.windows.getWinByProp("file_id",file_id);if(!win)return;TSSSB.call("closeWindow",win.token)},getWinByToken:function(token){return _wins[token]},getWinByProp:function(name,value){if(!name)return null;var win;for(var token in _wins){win=_wins[token];if(win[name]==value)return win}return null},distributeMsgToWins:function(imsg){var win;for(var token in _wins){win=_wins[token];if(!win)continue;if(win.windowType!="screenhero"&&win.windowType!=="calls")continue;if(TS.boot_data.feature_calls){if(TS.utility.calls.isSupportedMessage(imsg.type)){TS.ssb.distributeMsgToWin(token,imsg)}}}},closeAll:function(){for(var token in _wins){TSSSB.call("closeWindow",token)}},windowWithTokenBecameKey:function(token){TS.log(438,"windowWithTokenBecameKey token:"+token);var win=TS.client.windows.getWinByToken(token);if(!win){TS.error("windowWithTokenBecameKey: no win for token:"+token);return}_storeWins(win.token);TS.client.windows.win_became_key_sig.dispatch(token)},windowWithTokenResignedKey:function(token){TS.log(438,"windowWithTokenResignedKey token:"+token);var win=TS.client.windows.getWinByToken(token);if(!win){TS.error("windowWithTokenResignedKey: no win for token:"+token);return}TS.client.windows.win_resigned_key_sig.dispatch(token)},windowWithTokenCrashed:function(token){TS.log(438,"windowWithTokenCrashed token:"+token);TS.client.windows.win_crashed_sig.dispatch(token)},windowWithTokenWillClose:function(token){TS.log(438,"windowWithTokenWillClose token:"+token);var win=TS.client.windows.getWinByToken(token);if(!win){TS.error("windowWithTokenWillClose: no win for token:"+token);return}delete _wins[token];_storeWins();TS.client.windows.win_will_close_sig.dispatch(token)},windowWithTokenBeganLoading:function(token){TS.log(438,"windowWithTokenBeganLoading token:"+token);var win=TS.client.windows.getWinByToken(token);if(!win){TS.error("windowWithTokenBeganLoading: no win for token:"+token);return}TS.client.windows.win_began_loading_sig.dispatch(token)},windowWithTokenEstimatedProgressChanged:function(token,progress){TS.log(438,"windowWithTokenEstimatedProgressChanged token:"+token+" progress:"+progress);var win=TS.client.windows.getWinByToken(token);if(!win){TS.error("windowWithTokenEstimatedProgressChanged: no win for token:"+token);return}TS.client.windows.win_estimated_progress_changed_sig.dispatch(token,progress)},windowWithTokenDidChangeGeometry:function(token,dims){_storeWins(token)},windowWithTokenFinishedLoading:function(token,doc){TS.log(438,"windowWithTokenFinishedLoading token:"+token+" doc:"+doc);var win=TS.client.windows.getWinByToken(token);if(!win){TS.error("windowWithTokenFinishedLoading: no win for token:"+token);return}if(win.document){TS.warn("windowWithTokenFinishedLoading: win already has document? token:"+token)}var go=function(){_setUpWindow(win,doc);TS.client.windows.win_finished_loading_sig.dispatch(token,doc)};if(win.no_spinner){go()}else{setTimeout(go,50)}}});var _no_file_spinners=true;var _wins={};var _setUpWindow=function(win,doc){if(window.macgap){doc=doc||TSSSB.call("getDomForWindowWithToken",win.token);_setUpWindowForMacgapSSB(win,doc)}else{_setUpWindowForAtomSSB(win)}};var _setUpWindowForAtomSSB=function(win){TS.log(438,"_setUpWindowForAtomSSB: win.token: "+win.token);TS.ssb.setUpAtomSSBWin(win)};var _setUpWindowForMacgapSSB=function(win,doc){TS.log(438,"_setUpWindowForMacgapSSB: win.token: "+win.token);if(!doc){TS.error("_setUpWindowForMacgapSSB called with !doc");return}win.document=doc;win.window=doc.defaultView;doc.ssb_main=doc.ssb_main||{};doc.ssb_main.TS=TS;win.window.is_in_ssb=true;if(!win.no_spinner){var html=_getSpinnerHtml(win);win.document.write(html)}win.no_spinner=true;if(win&&win.window&&win.window.addEventListener){win.window.addEventListener("unload",_macSSBWinUnloaded);win.window.addEventListener("resize",_macSSBWinResized)}};var _openFileWindow=function(file,qs){if(!file&&!file.id)return;var file_id=file.id;if(file.mode!="space"&&file.mode!="multnomah")return false;var win=TS.client.windows.getWinByProp("file_id",file_id);if(win){if(!TSSSB.call("focusWindow",win.token)){TS.generic_dialog.alert("window already open; but you need to get a new build of the app. ask in #triage-mac-ssb ")}return true}qs=(qs?"?"+qs.substr(1):"?")+TS.getQsArgsForUrl();var team_name=TS.model.team&&TS.model.team.name;var file_title=TS.utility.unHtmlEntities(file.title);var title=team_name?team_name+": "+file_title:file_title;win={file_id:file_id,title:title,destination_url:file.permalink+qs,url:file.permalink+qs,worth_saving:true};if(_no_file_spinners){win.no_spinner=true}var token=TS.client.windows.openWindow(win);if(!token){TS.error("no window token!");return false}return token};var _macSSBWinUnloaded=function(e){var win=TS.client.windows.getWinByProp("window",e.currentTarget);if(!win){TS.warn("unknown win in _macSSBWinUnloaded");return}win.window=null;win.document=null};var _macSSBWinResized=function(e){var win=TS.client.windows.getWinByProp("window",e.currentTarget);if(win){_storeWins(win.token)}else{TS.warn("unknown win in _macSSBWinResized");_storeWins()}};var _clientWindowUnloaded=function(){var win;for(var token in _wins){win=_wins[token];if(!win.window)continue;delete win.document.ssb_main.TS;win.window.removeEventListener("unload",_macSSBWinUnloaded);win.window.removeEventListener("resize",_macSSBWinResized)}_storeWins()};var _getSpinnerHtml=function(win){var style_text="";var style_html="";var i;if(!win.skip_css){for(i=0;i<document.styleSheets.length;i++){if(!document.styleSheets[i])continue;if(document.styleSheets[i].cssRules){for(var m=0;m<document.styleSheets[i].cssRules.length;m++){style_text+=document.styleSheets[i].cssRules[m].cssText}}else if(document.styleSheets[i].href){style_html+='<LINK href="'+document.styleSheets[i].href+'" rel="stylesheet" type="text/css">'}}}var onload=win.destination_url?"document.location.href = '"+win.destination_url+"'":"";var content_html=win.content_html?win.content_html:'<div class="loading_hash_animation">'+'<img onload="'+onload+'" src="data:image/gif;base64,R0lGODlhUABQAPdqAOn38njO398JXN4GWarg6////7Xk7fP7++mmGvjI2mnI27Di0v326P7///XXmEi9lzC0ieiiD94DV/POgPTSjD65kaHd6Du4kDK1iupck/jjt+mnHffdp2TH2uARYJTYwvOfv+H0+GvJ2+Msc+ijE////jW2jP/+/d8NXje3jfSpxlLAnOEeaYnU4/768W/LrTq4j/WzzeU4e//+/4DRt/LJdNnx9vzi7OmoIOT18PrV47/o8G/L3u/BX27K3OAVYzO1i+v49P7//vzq8fDEaef2+ehTjHfOsu+9VWzJ3OtlmfD69v/+++IkbeikFv76/J/cyOyzO/3w9v/8/edJhvzy3OZAgPCNtMbq8f74+t/z7WTHp++Fru22RKngztLv5tfx6crs4eqqJc/u9MLp3Pf8/HLN4H/Q4WbH2u35+7jl11rEoYnVvO5+qZbZ5ve90+uvM/StyfGVuP789/n9/f3+/vv+/eqsKu1zovrpxkC7kvvu0uEZZu65TPz+/mzK3P70+C6ziP/9/vCKseEVZc7x5eAQY+qrIGrH2DpraOGmILmbHiaaieEVaCmihTUON27G0WWKKza+kV6AEla6wfFMim/O5r4UWtdDfr65beL3/qU8bdEfEf2hw8qCojemnm24p+cVZS+jkPKzOGWCEx+XgF6DHDq8kWWFHOF7GBqSfGWvluqvHvOwMPT3827I1UwPPTWui+uxIecPYWjK4uaXGT22kM0NC9ikIuigH+2pINwSTuMVZNMPJz6/lGXF0z2cgskKVz6qpZ+TGj1WXmaPOSSggrJYgekVZfGqIDSoh4CMG23J2d0UVTqJd9QKWdLDetcRO12/yj7DluWFSOWnIFC2uTcxSdUUYHUQSNlMFGmfZKURU8+hHm3EyvCoGucKXtQxEnvKx+I1aqyrU9wHTpHgxbqSpvFclOmpFemSWtknQzrAk9k1djS8j6jGotufE+HCbGPUrvJTj5Tc8NnCzOqtJ32Jj+yqc+6rjNMHWOJcWLzx3/CfkQAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh+QQFFABqACwAAAAAUABQAAAI/wALCBxIsKDBgwgTKlzIsKHDhxAjSpxIsaLFixgzatzIsaPHjyBDihxJsqTJkyhTqlzJsqXLlzBjyrwoREuYMABEHghho0iDkV9eVEiR4gGNIB6LWAigQAGPFjZCkqkA5EKFChcwrMjBMUSADiJ8iEWjAMtHAA9SXF1bAcILji0UiJ3rQwSPIh0bQIHAti+YjA1ChKU7twMBjy9M9F2LwYvGHWgIz1XQwuMWtYupfnjcQbJYyh6PAMlcobHGMXI9d7CQdwHfxRcu/M1Y5kxquklERO24ZIXivhBo/DwNlq6IDgZAhnmAweoFGBC2LNn4E4uZDmjQdAiwQ6QWGg+srv+AcqCExzQ7CFjAcmA4yAZCloDR0j5kA/cz8+vfz7+///8ABijggAQWaOCBCCao4IIMNujggxBGKOGEFFbYoBQ3DCGSCxpMMAEHDIyUQAYjsNCEETF8pEEUJLRIghgOhBTDDxJ4YKMAAnDRkQYbOIHDjzggEAEFH93QBAo/JJmkBwOocIJGLkThI5A/boBDFeZxdMUASnaJggxPZHSCBiRQSSUJRHZkhABdtqmDRhOUaeaPTvTgERVstrlkAnDKOacTSHikBJd6JvlmRhz4aSYJNXikAqFtCmDFkxlVIYaVf2rg0RRUSNAmCk1yNEEEc0Zgp0cnDEHFADgKIEETIHQ4xEQNLSKAgBOmuhBSFiooQYURXNwAkgZEdBFFDxwwMdIMM5h0grIWRivttNRWa+212Gar7bYVBQQAIfkEBQUAAAAsDgARADQAMgAACP8AAQgcSLCgwYMICR4YI1BEwocQIwpscMBCgA4SER7JCPHAmQ5JfHAseEFPjpEI3XTwIRIlQSALhLgkGIIly5kDTbzAORDLyps8S57kuQONTYgFvAA5WKECEDU8AYwxevRhDj0VDDbF4EUmzgMBRNhsmfCFiaYAmqp9GhXAjg5/xvpQgHABBrVpmwptC8CAiA4K0HTg4WbHwSAPUqhVG+gDX4EhCLgpXKRBQjJ6MFyocCEFhCNlLD8G0EA0RDBHHlTQs8aLndE4l4DJQacE7Nu4c+vezbu379/AgwsfTry48ePIkytfzry58+fG52igMIEDgxPH83RxQoJEhDsUbCennHIjgY4ssPOIcYKjPQ4EESYg1HHFCh8UP2TImcKXSR/27rW3AQ57GETFDwOg4MEPP6AwgBLi8ZQHgAG2RwIFBXkwAIMcciiBHG05QIJ7BOHgRB8RHtQhCiOgx5MDEbSH0B4FPNThDzpEpQF7bTHoQQJRMQAHAlH5yMcNUZVABF8/CEAFXxoU2aQHb/AlJJEueSDAADJUidwALBgBAiDJZQDicjMgFxAAIfkEBQIADAAsDwARADIAMgAACP8AGQgcSLCgwYMIC7pJyLChQ4EHsAhEg+ZhwRcWE4awEKCiiIwEK8D4ArLgmD8dRPgoWRDDhwIsGRw4o2BlTIIw1vhh2QBLBx9ALZpAKJIkSwtogNpsuIChy5hIlT4E8AAGwhRr6LA08FNqwwZHElZIYRRkCJVKlzL4U9EgkIMVKmCA0oAlgQ5/0to0w0AiTIIXDMYFwiamHwIiOlDswKNvmr8Fj5iIyyCu5bl1Y4YgYMHCjjQMMh9Ug4Gy5bhkbw5sIJphmTVATseFEFY1SzArIMC4cCEFhC1BbMcEwGZFBT0roBwoITxmiQNatJRpTr269evYs2vfzr279+/gw4vyH0++vPnzGV1ooEBBgwvzGqKQmB8BDofxJTQgcIKjPw4EEdwXngtw8OdffwiIUUVDJUihww1PqFYCByQceCAJDiBUwBAqZNAEIXzIcEUWN9VQYX8E4eAEEswRNEQcHgoggAc/eICCBEZIEZOJKB604EBKNCHjQD8UWaQEeJzAkgMVJuQAEwL9wIAHBxnpAR86sLQHDhswBFlCRv4ggAox9YEAdUUOAEJMTDKUoUNGChCDICxVIUaXqlnJwhA3IeGEbUV6IAEXqr150w83snCFkjdVwWVJiE5pxSA3MDqeB1ZwoQOd5RnRRgJ0zjBDeV+OFxAAIfkEBQIASAAsDwARADIAMgAACP8AkQgcSLCgwYMIC1pAoiChw4cQkYwR2KFDxIJHLiI8MFEgGo0FYTwAAHJgEQsB0HwsaRDIApYhAnQQ4YPlQRMvCoCk0wKNj5oggSC8oCcHyDEdfgK96MWhS40NCCT9CTKHngoIceq8aMEnVY0FXiQkajRiHQNTlxr00TCol60QbShQ+nVgQx5IdiBpMLBsVrEX61hIq7ShmRY7ivA1CPggWSEXy7jpgEaBgqQtkBQpANfgAqEHKzzV6GeMmxZuDGyOCOABDIMVKmD4YHPv4ohCjpiIzZs3hqa1S6rBEBtJ7wopvgQH2SDIgxTHK0BovFyjGhO7Y1+AsMJv9Yh8yaz/gYFdDw2S31naAaOGTI4Gt9PLn0+/vv37+PPr38+/v80qFPTQwwR5+FeQA2JE4IQTJDhRwxwGIsEBCQjgYKGFEdRQgn8M3FHhhRZugEMV/k0IIogkOHBCfxOQcCFBODjRh0ZT6PBGAkPMUBIFLuJgkIh7PHSCDldY8YMAKLCAxxAanaCBEz4iRAFCMxBJxQ8DoPDDlh5IIMMQK0bU4QYJ9dEZElZiicQPa27p5gAZaFQCEQ8FOdCVA6x5kJtb6qCRBg9RsJUHeibE5wAqaMQAHAg4tKFGbgoAAkhEkJAQmSBF+oacTzo0JaQ/oDCCFCAt2uh3W6IgaUkFVJqeAAOMNRBDmCB1WpsHsCJhBAik2uQCoyXhigQfuyJxJktTYnoRH1TIccMMOlb3KEhX3BAhQifQ6l9AACH5BAUCABAALA8AEQAzADIAAAj/ACEIHEiwoMGDCAu6gSAiocOHEAViEYgGTUSDLy5G7KDRYAUYYDoKPDBGJEQMHzqGsBCgokmHKbbUuWjDTAcRPl5CMIHw45eIZc4o8JHz5YKHKSFiQUO06MsHMBCmWOMHIgGmRHUKOZLQJ0QLWJ06tCgSJUQDHZpCNANhYkEAMNfQeRgCp9qDPBamKYCQa08YPx8S6PCnaVYIPASmadAgoRA1Ds06bEDHgoIOFdO22KHz4NQyEW0QcOPGQJECfDXyBfI3zEXGnQWyPlhBcuyIqS94rACExu2OXCsMrECcN5vfFwuoAVK8eW3IyCMeWGHCeQUTa8qUiB4xjB4gF4hf/8DwIDD3iGBeXK/+Qsv5jkK0kCGjpfH7+/jzD9xDoUcPClXo9xAFG0TghBMR4ECBgAeVQEEEG+AgIQ4bkLAggwTtQeGEEyIgBgMnYAiBgwlyOCEJDogoEBEkTFiQE0ikxmAJLEp4kBgqQuBAgg7J2NEQCegwxEUabpAQEh0VMEQcGTTxgyFNKHFDRH044VAVIfa4pBJNQCCABx784MEATegAkQMkJBRBiggVIEUcXAowgAcC/WCnnQNYkcVDexziEBJZEiRFDHFCQKdBd/4wQBwPFVBlQn4WpMQIAhgKEZ54nPmQAzMM9IOlEd05QKYOnVAFhT3qJCoXgR5pJUI4dGd2JwoJQFQAmg6xKZKdHkigxEVViGFkQtt19OkAfLSx50VIvHrbpxD8QIUcN7R6ZpqyohCtFVfoIIggnXYU7LDGauuBFVzoMMVtE0AQa0ceyMBFAoL4qJO9F7WRwBMQoJajQf7+C0FAACH5BAUCAAQALA4AEQA0ADEAAAj/AAkIHEiwoMGDCA1aCKAgocOHEAeOEdihQ8SDR4Rc3MiR4AU9WjqK5OilQYGTKFOmPDBx5EaVME+GWIgGjcuBQCro3Knzo5aYKcfw6CDCx00CGh9CAXoyDUMfRo8K1MOzqoktTAsY6AA16tECLxyCZNpCQdezaNP6aDhyacwGZbtu5OFmxwGYOR5ifesGjdyHXh2GTVgBDNCtaA9GLVLgYYEFSoGWOeMXrYIOPFoYkGpwb8wQZzooEHH5TwuBJrO+PWKialXDQA8YaHFGc4gGnB1CSc10Bm/VqgE4vJo099EKF74AX768+MEKJtwynw40yIMLrnUCYUO9e0zW2StA/5DuvbyanNlNhPnNvIoDIkQo7Jm+ZEXrqkC21PHuQEwEEiREgAAFJzBHRgVAYIccBCv81J0DTiCAw4Q4bBDBBNN98QJ0JuhBQw7dncDAHRJSOOEGYlQxnR9akBEGiOU5QIKJJpLgQHcNsEddDTPSOKETSJQnZAE1OOHjiSmWMCR1J3Awo3FSVSHGBg4VuCR1SDiREA6cTaFDDDHoIEhWHECkpHcn6DCIFT8IIMAPVCTAlJQO9dHdDDpcQcUPA6Dww59t8vEGUz2Q4NB8y+W55wBvAuooCiNIERMTZR51gxyL+unopn8OoIKVKlVhT51npnTCpVQQwiinrP4pAB6EOnrEpUFGqNpoq62+CqpKlSZEQWMDeTAArsR2egVQJYz4UAmc/enBDzpk1YNDVDaLwgBtqNYrQhRIJcAATYAAnLIOAcuRBwKxYAQIki43LZQC8bHuDd1te9O3fFAhB73ljYiAS9/Cue8J8HL0gxVXRHsCwQVfNIiYDT8UEAAh+QQFAgAaACwPABEAMwAxAAAI/wA1CBxIsKDBgwgLutEgIqHDhxAFYhGIBk3EghheNLjIsePACim+eBzJ8UMBkigdrrHz8MCYgR1S0khYAUaYhCEsBLCYcqAahxg+HGwwRkQHET56DgTw4ALCFGvKGCzCQ4GPpEoHHgGS0KZBAh2uYu34h2fBnw7ZGGyB9CrHJBbNaJhYMMjDqAVbWHUbEQ2PuQ6POExxk6AbNGIh8liYRsPJhGpMJASiluCOsIkPyt2RZmNEu04PwlghdSCdFpjFYk26Q0MJj0JocEVoorDABmlQo1GgIKzAIo9RSkZIObhAOljctHBjIIRxlEs0wEA4+gDCBp6zCpSdsLYQ7Q/rkP8ZfhBCZY4lqlAgQsQBg4vRu6448DpiCQobIpAgEeEOByYRcXdQBSaQwdEEEWyAw4I4IEACBxGNh1AFGJz3UB4bKMjgggjA8V5E0xVUAYEvRDQDghtu+GCAJowo0IgjAkHDdxAh4QSDBOHgRA8RAlGBBjDCCMECF9m44EF3fOiQH1tgEOSIJqwQH0QUkIBDQv9BBMYDGFww4gVA6CHSRXkgcKVSORyhRwom6PGCFtlBxEQXCCR0h2P2ARBGGDmMVMAED0EI3kN7mOnQcyg9kYAcV8QxREElnNBFQjiIkVUCbcjgwQADCMCCHCcUVOVDiEIkSAJcaDoAChr84KoHErTUQdAJeyiYEBIdTYGqFR4Y5OqrKCQgyECS1omQGFVANIUGXPCqAasH/frDAEoQVAAFDpHg0Ak6DOJsRL+iYEVBe5yJEBLPFaDDFVb88CxH4VJhUB8OIVsQFe5C29Gv1IZKELYOOTDorwLEUFAB5TqErnb5SoBHfQXRS2kVEKPUqwAjgDDsQQAnJHBPAmigRBxSOFSFuYMK1EQGjkL0msRZ9aoBCxmoMIS/F32ckswsGAGCBoLM4FF6OGwwksx8+JyyR4RQIccNQZe69EFX4DmD0FMfFBAAIfkEBQIAEwAsDgARADQAMQAACP8AJwgcSLCgwYMIDVpIyLChQ4JlxjxkCGFCgYkHywxUgAYjwgpgPArUKHIilAYTSU5QUPLhFiENVU7o2FLgEYYXQmaUeGZmTYINFlCEYrAIgQBoaP4smENPwxkEbQTooMDH0oMlJphImHPggTNofFit6YPlQaEMPww00EHsWI9lJ/CYsGMCyoENADCEMcGOXTdhxYrsYKZF3Z8XvghsUVXwRB8tJhR5uABIQgxqGwB269CqgSIXJ+pNmGJNHbodknA+mGSCAbslCxzZihDGlwZfA7sdK0JgiLs/LSPE7HuqAhEiOojo2Rd4FQc1iDiogjHIhAsIS9Oxe4BAiwAtCIT/8NMA+AQHYiKQWC/GAcbZCfmGnjCDjp3y5s9HQICjPw4EEbjnUANqCHcQcQ6VUIUY/PnXHwJ3MPCQdaStQcd8CVFAgoMOksDBCQ/dFF8YDxGxYX8E4eAEEhOpkcJVE5iIYkEbiEHdQw9UKBNCGuKAUAQeGVhQBSmQ2NAeOGyQEIsPqUGbQRUAoVZDJfTBkI0PLfEAdkNGSQOM52GYEA1AVFCBQGaaCQQbDyGp5FVkYJDmnFGSkVVDBfThREJiPFQCHWuYQGcFGGyxnUMnCJiQog198QAGF5h5AQQr6ESQIDqoAMIbgKT4JkJ3OqTFEXqkAIMeNORA0Ak6XGHFDwII/4DCCCpYlGdCn2KUQxhhUGhRq1T8MAEKPxT7AwoDXCEQo2AOVIAOcgQ7gQAEGfuDBx4kMEMVSSZkpUfPRisstQdZOwAeFiGxJ0I+gtjQCTdEy8e0DhkrABUTlMBsQUAyVEC8RsxL7kPGokAFiDd6exC8IAQ8rQciGTuAEgMxeVB/exjksAAQtyRxDAPtWxAFB3X807ESUDzQggx92+wEHggwQBNXTFGQxQjtIWZNMrOQgQpDHCQyQSRfNQALRoAwhLsI9fmyQMJOwEfSNzh0Ec5XRf0DFXLcIAhUE3EA47ETbC2HDgXsjOcETpdE9g9WXIH20x55YAUXOpygNt0JcQiRgCC28o1QQAAh+QQFAgAEACwOABEANAAxAAAI/wAJCBxIsKDBgwgNuknIsKFDggewPJxIseCBgWg6VDyY4stGAhc/PvxQYGJIAmhEOlxjp+FJAhpVCjSREMYXIQdDBoApc2AJNQwxfLA4xkLPhAAewGBIR6ANCwHQoBFx9GADAkBqhpmxI6MIH0f/SD2oBkPDEAq+glWZROrOMQRKbmyhwIfdijx4iCUQwA2WlxtTSDNjd21DHpYsSbVE7+/VhkATAhFG+O5hAqu2LSMXbw/FIAxhMGLGozBDWpC2LYL3LVkEBBRKUMx6UI8xSpUNF+RBYEefCN906cKBY0MEBxRp1o4lrHRhuwoI+GhBoEgBDk50bSDOHcEdBg4bLP8hsPRgBVs80ChY3yEJAQPWCxQoQYQE9/s4SHCYSIP2wQtqGNDCGW4YEEID8slFQB9OcEcQDk708JCCCJnAhkANZIgQg8QZtAFF49W0wgGyMTSBfQxRmBANDKVAhkN5IIBDQhI+RIZyB2U1Q0NzdOFEQt+d8NAKIgJ20AQMkVCRWRW+2FAe29FYIkMNOLmiQyd00RB4Q5ZnEAwrhGhiQxwwcVQFJliJ0I4yVkVACghVAAQbODHEhJZVHbCClwNVUEEKWxz0RAJXtCGHDgSkk1AE+z3EBgZ+CuSnnya8UCcBg7YhAwoDdNqIESQckqKNJkxqqpzmECBIApp6MAAKP8T/+oMHAoSDgKg90bFGqZPq4cs0etTDhRUeGCTrD41Eo40suMoUhh5AVPArDMAQswkyBKCAkKyG7BLOjAghQREY8rgDTCLXPMINCsUyFCshhvRSS7MFiRGXQwXowMUm3GTDDTahPCQrH9HMi5CSDM2gwxVU/CAAOLPMgkzAAsdqyDiH0FsQElMOlC/DPwgUMgGE8MILRbJKcEWNB31YhUENi3zUD5waIQgBETDkQMcyH+WqACPI8UQJe4DrJkUCEKBEDFIQ1EdDVQjppgBNEBDHQVLrfHQGKtybkNFHE9AuCwIN4ZBsT4ctEB9GgBBXATPs6BByVSXNh0A3yAT2RkkTEUCFHGp/FPIVXgdeEaKGNxQQACH5BAUCAAYALA4AEQA0ADEAAAj/AA0IHEiwoMGDCA1aSMiwocOCYx5KnFiwzEAFaCgavFABjEYDFj8+hDIxpAEFIh1uKdDQpIGMKQUCSdiRpUGTGGMObLCgIUmCLnUezKHnQsItDUBGPCmRBw+KBV6YSKiHDIEALx/ysGTJKdeCPgx0OLhg6kE9yoTRShLWoVNQ24oV2waqqw8FHZ5iMZB0YIEcCPUAUcXIx1O3kLaRIoVqsalttJ7uSNNwZkE9xlSpmshDMWNUpkyhWpYpjZ++CXsatFVKs0RLoBiHRmVgWDcErRg8BGAABkE9rF0fZmhp26TRw3DpMpBMFwkOE80ODK5ZWsOM22zrSmYAh0AcTnpM/7Q8ELPmzWaGCxRhQMQZA5qQfPvWveAGA1UcFghiwGj5WOcxkgQPPvjA3h9nEBBCHQJREIF3Qh1hEFrnUcJDBwokaIMfBe2xAYQIleCQEAZI919mwrRAgA102FQQEw7l5xB/Z+lhwhpluIgQBQ7N8JCECV3whUN74HAfQkhIpAZDGHyAGkIF9MGQGFXoeFBSDySUwhp0OMRjQk44MJ6WYRBpZEJIWHlQAUsmBMEH+knJkIwOPeDfQTiKyJCYe6qp0QUplMlQCVXIIsshQpXYkJ8CCaIDCPukUsshiB6kZ0INLMEQDCsEZUABOhhgxQ8D9HLLLdpsUOlAJPDpEA00Bf9K4qc6XEHFDwag8AMhzZx6SziUGnQppgxV4I45oMpxqwECEPTDD6aemoosKS2xgm8DVSCQL8Dcs2yzCfnKyZEFDZsQDUBou60BiVzzSDbgNMSruJMWJKdDZLgzjS8EPeJvNrPwwtCuBviay6rf7THiAau06+/D/mIjsLwF/ypSATeAMA83EEPMDTIPzYsqtQbdS9AJQ4BgBAu5IsMNLBDD8rFEhBjyq6oIKVxQBiwb4MFAyPDCDTfZXIINyA55IIAAI+xzcEIUqPmzQaEgY3UoEzPUbBMZxAEIA/YkhIAB5iZqwAAsZKDCEAQlydAejH6EthEgIAQdQ1+mhKsBfNBLfUNDYphd0N58UCHH34saIJ7gA/1geKifxk3Q3UKhYMAPVlyhg48alcDAHWOLZLkHVgxigCA6lT3Rz22czrhIbSQwxQwnnPA6QwEBACH5BAUCAAAALA4AEQAzADEAAAj/AAEIHEiwoMGDCBEqSMiwocOCHTo8LIgBQIOJBw8MjIjRYAUTXzoK1Cjy4QchE0kCQFPS4Ro6DVUCkNgSAA2GKcIgVMlyIA9Llnj8tPSwgBqGQNgQvMiQB4BV24oV2+YtqMMgDxLCWFOmBE+EPCAVI0UWFSlUq8w4FEIDyEE9ekx4eSh0LKq7d8muIirwz0qDRw3qieVI1ScAIhpaWnUWL15SkV7xQINGLYAyBZcAgEFQjzJVqgQicmjJLl4AeCftBYBFZkEaJgYOBh0aAKWGPJgVc5yxQIGEQsjEFqjHGO2JTu0WXITrGwAXDjVfEGir1HHRirdNMiVwUTeBunA4/9FQwmFb6tZBD7zNkBaoZQJxGCRB5KFw9NcBHPZRcOGfFgDkEAUAyRyEABwMRLcCZ8XlB8BoAi0kQgsGWCRQDSQwpMFDNwEQF221ETQhACHUUVAeTiREn0MFkCFbLCCGdphAfhxUwhxRIIDQgQnGtCBxJjhSypDG6JGGQxNE0NBvDNWhlGx6yJaCiwyVkAcC8h20okNUIgQEDUwmhKOOCN3RY0JeraDVCppVOUFDHDz0JEImkIESQ1dmeVAPa4WRQkIYdMjQHF2QeZCZDh3wI0IPLBEmQm/KIqmkhxAUp0NzegRAYAkxsQcOqWgjaioAsDIQnw75yRAN5SH0RAJtcP9yy6yzclJLpQAgylABmCV0wQNBGDQFrDJ4AEA0AtE6660CXdoQG27RqQaTw3JR7ECN7DKQsuHIIlAPjx5UgKoISULDCQBwYYWxKDCkLLMAnJlQGWv8qWkimMwCQLsOKZuKtwA4yxAbFQ1UAUGPcINMQ9omS2sqpgKAxENhnJLQI9l4QAhDPxBEay64moluQiNfDAsAvDDUSC8O36JNxABEIPBBV1SSDUKPPAJLyhPVWosYBCERriA3yEFFyuBwkzPCOWO8cEPt3sKJNtXgOpAYVRRkRMcAdMxLKLA0LXbOl4QyUSq1yAIzQQ4YxLVAvCBzydhNK9yQEjFIscchVhd05ITQDsmdjdiwcIPNQQIIFEdBfTCE9UNmcyO54aFsXFAGKohLQUNtT4RMKI3wkrKxArAg0BCClFzQpyrWNJARIGDUuOsM3SCIIDNMtDntBFEhBwDhPjRDFThs4HrHVwAwQ+41Bd8RFwCozntJ0APv2/QPBQQAIfkEBQIAAQAsDwARADMAMgAACP8AAwgcSLCgwYMID4pIyLChw4Jo0DwsCCFAgYkHywxUIBGjQRhgPAZoQEfgGVq0RDK86BHUtmLFtnnjwUNlQRgB/DTUKPDXNlKTTKEiRWqVpZoNj5hIeOELQp4BFAT4s20SKVRYsRZFynABQwwfCLI0aGnV1axaSUWCxBVhjgA4D6bIWQCq1IKWfp7FGgBVgKKWGjZQmtCWV4Y0i50t6HebwQ4GDw/Uo8fWQGEOeRTja9CvN4GQBR4YGwBAgAsC9cRyVIpgEsR5rz5Mk/BIamWqVIm0BMpvQnIjGzBUA0R1bt0imSEcNpCBQ9MBSh03uNDjMFwCkwUgwYE0wiOBjiP/tylQl0EnPR6qwT29IGaErwOE6CIQh8ENdwKUaBjElviGC/1xhkB+CDdBQxw8dMR/CSkwoA3BEYRAQuh5d5AaxjBI0HsMMUEfQvg9tMQDGYqXm0APBDCDQyQ0tB9DDdBggjKlSFeKI7FYBkMYDZ2wR0PpPVRcALakYAtlA7HhkIdOJCRGFYKNmJoeBx3QkIUFtfgQDQ5hSdCPDCHhUB1kLJWQkgyVcEIATQZwiCyyHMJKnAFA2dCIqCG0wgEvJkRBm7mkok044aRSSzoBrNkQlwyRcWUAuQh0y6SUcpLKRGUyxEYdCQHyhhIGUTrppUzcyRAMKyxhkKd4jICCAAhR/xqOA1s2RIZwAbDqKkHNHCRqFII4lOlBp7jDxhMJtPqqBxNReqlDB6wQV2rTEOkMMe2gEACzHjlLq5ACVRvAteQRNCknEWAkibXEHITMDypNqg0rONiZkBBZANNuQtg0REg0BU0aTi6HkPDtQVMkwIUMDT3CTSjdWurmQIoOVIDCVjA7S8PZIONRKjiwQpB9BWUsgLYBhAJvQo/AAvFB2qLA8MR0GlTqQLASBG82CD3ySDa8GDQACiPgkcAMDMjCUB8OIXOJzwT57HPHBRX9RhYqztAnQjiA2RAsUoft8yUbCzCCEm8AYlAJB5cbytNi+8wNOE0oEYMUBRSwokFViFJBoX5NXwK21LBwg04cUkwkZrkDIeNBMNxwc4wKQ+TtpUFt2+QBrCwYAcIQdXDq0UV+q7S5AHx4fkPejJPHBxUgrN4643LcsObes5N3QsW5TxQQACH5BAUCAAAALA4AEQA0ADIAAAj/AAEIHEiwoMGDCBEqSMiwocE5Gogg6UGBQYMyWAR26ODwIAYADToKZICEBIlvJCIsemdJZMMUYUS66EMimaJFw1CZmgSqpcuEbEQ6gIdTpylUqEgV88Hj58EUAMowDImFHClTR5ECQEqqZ0c2HxHCDGnwwMBfWJGiMrjNUtOpZEwkBBJ0IFmCf5gVI7W2INJirzouWZEQxgqpZgWiKWhpG9++BkF1LEADiEE9Ak14aWgJFF+RSQAsNkgGqkDMA40B+NSQB6RICZW++iM6gIUxZe4CKHFgBQw9emwBUE0QEUMfHUEFADAmMcKgsYyVckqQFMNMAAoU0G0wjCNVqqgP/3x9cJEiAKPmdMRSCjzCUsZ/LgKQDIAuAE40OPTT4lN48aINtAguB5FQg0NFmEHJfwixhhByO+QwCgA4HIQAHC4UwJANfyDCiEsL+dACAEVoB8CBCeXXUBF/mCFMQ9YIlEQLBhTRgIkC6ZeQgQ35cQYPCzLEmgEhcCdQAXNEkdCFLjSERQceMliQIxVk11ANTqSogYYJ1WEALf6BJ2WVKZDR0Ax5ZIlQBChOZYM4qpRSiiOxVEkQDQ4liQBCTJbQUAFlrCDXUwAs0dAJDanY0QdhHQSEGg6ladAhrMiSTg1MOFRAGDDMhWdDeg7ECoWpaGOqHDc4ZMcaph30wBJcJv80AQmjVggAJ7fkeks5LKgww1SMJmQCpAxlCkAttxaUay+GCBBHQ1+0ehANQiQ0RQJchMPQLT+gMIIUDNHBakIPBGHQFDpwYYUhA/SybTSNCBBDQx8w9CiXgugwiBUeELRLQ700MoAc0HZ6EGY0FKDDFVb8MAAKTt3iwQAg9LhGQRX4AoAewCSCCS8AQIyQuwndEo0hCQhCb1gac5yIS41se0svVKgMLTsA+NLxQf0CqGsCxiZUAB2rvIzQIw41QrKynGgTgY4IFXCDHJUASFDMBmmTSi6W9uBnQSfcAIIRfAAAziUOheKStrkAwMohAt3BgEFkDyBAv7yAzNAjlyDOwzMAAowgELIIcRCrQAP0LJDee3PjN0ECCNBEBnEMsQfcCfVgNUGPZEPQACxkoMIQ2RVwQhd7IiT31wnxonZCj8DyDOhGgEC6QRQ0xEFHyHBzdOy1pyrQrwXtYWuBRIh0ySNID8T8NYmAYqRBJfSx+UC8ZMP884kAcwo7hYiU+/XdBvMI9MDoMc0pGEAhEqLHO9Vt4lYMksAR7KQARAorqFGtSKyjDgqs0AYdCKIBfgCAFtSwgDA453oOaUMCnjCDEyAKguKZwQxwhEGXBAQAIfkEBQIAAQAsDAAOADgANwAACP8AAwgcSLCgwYMEmbhwgbChw4cQA7ig0AUOnB4aImrcaHBPlAhOECAg4aTGiYINynBcWdBFFCc4YsbcEIHCQJUBzohgyfKEgwgyZer61srVmJwK0PAkCCFAgYhIYMbUlSyZogDDQNFaivACGIgnoiCgGqCawGUCt3FtCEUIxD7frgpEFcCUwEje1ho0scVtwwINMg1Di3AVyyMmGsL48tSgSgJnQE2C6GNjgQVAHH4g+NQG0gC0XjkkFQnSyhwPGqZYMyMAHc9nFLA0zFEIYoMVBNpSk1MvwcodHi7AMDD3QEcBhEFkVowUQlSovPFQ0IGHGywH/gJ4cEFgd+S/fa//shRgRxqNRzKDNygtIt2G5NI0aND4YRFxqvT6KHZwGK4ArTCwERY8tOcQI0msNEwAugSQTAAkcBBRAzaIkIQZEBmI0FYCDdPNQU70oFELClRmzUPKGbTTTgaE0IWDB21wBwMlODRDGjz44AMPv5Ty0E4C7SQbASHYMd8EDkUIkQ1J6FjZJw9RIpACZxBggx0CNSBQHhs0FCJEITjpgxknOqSclXQgdEIXTiAko4AO0aGTjjz6iJAxqUFEAQkNRVhjQzPs0IGTGCJkSwAXhPEQE3t0iZATSEDkhwUdlEhmAPkZE8ChBLEBERNsuilGFfUhFOgZPOToiDKcFgRDADg1/1SCTX1KGJEfaRThBw2JIZRCGH41tAcCB8kSQC3UKEEFFXjoIAhEavSKkKeL9tGmQLKwkotAnNxSDgooSODBIBAtwV1DKxzwZ0M2GbutQdE08sMPHgwgx0MF0JBZQ4o+VEUAqThEyLw/oNDEEA+RIe1BbJRaECBv4MHJQ80MPK8AMZzU0BIrvIpQugZBjMcIAgQQTUQE2wsRDQ6ZQMZAWUQ8AgoBeCBQMxAR/MMAIECkMEKnSMLGEwngIQPNNq9U8bwe6FDuCgXpMc2mzhBz9EMnPySvBEZEVAcbmekhUAVVb0QIzg+hMAAVN2hEhiQBkE3MQcj4Ng4IWWgkRBbAzP+NECwQEZI1Qqk4oNEUOrRhRUR1N0RIQ4cEwEofDheEOBdW2DwLNxA1HpE2AeAgi7ECibGHQ5kHgMIPAYTC+kPY8HIQzQHIINC7Bzmg8UECvC6Q7zyNoMQbgDAgCw4N9eHbQaEMJEATSsQAiEAzlBBVQzjsUXlDP2Dz0CMBPK9EHFLk7lAEhq+UjUOPHBMHwk5VXoUYXorIETKcN6QMtQ4VEOnyAuHFDwBXkFhMYxqSWIOWHpI+AHoAHOsTiDKm5osKVCAFW4DIU+jnm5L9oBKeUIYvpuELPVjQghhgmQaXx7p7NYAOWzDBCU94ARP0C4AOGYQOSlCAHgYgDDCQIQ0xA/GBOuDwL5XTEhlWgIEmYqACUPDDEZdyADV8gA1e0MJ8priU+fTwi2AMoxjHOMaAAAAh+QQFBQAhACwKAAsAPQA9AAAI/wBDCBxIsKDBgwWZuGBSAqHDhxAjEizBYEIXOFGI5JHIsSPEPHciOEGAgAQCBx5TqqxyxwmOly83RNCgsqbEGhFg6nTShaHNnwVLzImCQKdOBBsJFjgAtCaDOxteFsRBYsJApm4CNFXpAk5RhKOWCAyAZmtBDCEaRCRCAgfEDmYPpggD8YQGlwMVCUQVNyKbAhBdtCpoKgTfEMVe9TWYYg2dhyXK7HUIqikNIA7nImRqIcSqxQaFkDHxkE3BA2NCaIULKdLhg4mBLlmRAiGMFZJRqy6bsrJBBRwbXDaoR6AJL6r7igiB5kzH0QOLDzQW4lPE1q8LkioG6Q8aNAEs2P8oA1ji7IG2QlAniGgrqDMWxpRpoNYjGwjqEVKSSMrhsExMlddRA2XYYNYrkRB02CKKIDCKCyk1YIMFASgA10OltOcRg8mEoEsITtDkkQUdlOWDRPsh5N1AHBpEQg0eGdCBDzQKlKJD1v0WAg9u7ADAKB4ehAAcLgj4UBpmiFCjQIgwApGGIQDnQ49pFGAljA6FyNEYMy4pkDAQWSOQDy3sUEQBapWnAQIOkUAERzug4aWNEH3ihgFnIjQUm0ISKREWctJ4IpNOIuRICEFEVIMTWYoIURE+JCEoQWAeVEEIJpAB0Qx58HmQmxyRKOiSNx4q3UA0RLQnQkMyINEBbnT/oEASSYjQgQhnxBLLpYyFINZDJ1jVaAhPJNBGBka0kYBBdBjQghlmnEGADQV88BAQahh5UB6MTsUKiOoMIgMKAwggwAAo4DGFQX4ckMZjaYVRm0OpQrRqCDiwIksItQw0QAg/BCywBHhIRMca8x70wBLaGmTVt26FEA5CAv/ggQfLQlTHB2g5pAZEJeyBQL8TH9TIQBUPwIVEYcDwEA1COCSIDlyU7FDAKAcsgBISlYEwQhc8kGhBM+gwiBUn9+KRwAMULBHHDmE7UNFXUPFDCCh0dLJATIMgSERCfOHyQXq4Q0MBOshhdQgCAKVzE0NwZMfPA1XgSwi+AJMIJnyw/+2Q0hL9gIIETbzRUbVo8Zp3IlrvEpEhWMvQxg0pfXEK3nof5AEhTY2ARwJZqNQAHaswjtAjETUCOGgF3ADCPBKF8tDWB+XCSjo9eNQ6CEawEAI4l0Qk+82QCzSx7d8O5CpHGfgugAch8CLRJchoLtAIAvWLr0EcMMHRANAPJL1NAzSRQRxD7HHIIQiRkDtoBcGCzPgDsJCBCkOcEIKVfTwkRhU/4cX4HAKLYISABUYAwQ0EoT+CUOAhJOAA/AqyiU5QziF7iNin9mcT6QXPIY44gkT6N0GBDJAgwCiOL/SQg4g8sIQnDEEKCVIBDCygLtsDTdY8YAUZ2uJuvBJIBXpM8IKINESHMuBCAqbwtYTVrQJB+1UJD6KsJxAEChgIYggqwMXbSHGKU5tBaLQARS5ycYtD3AIYPfICIJjxjRC44Ro5ooUHuNGMF4CACOfYETBswQQYAAIGLsCGMhyRj0akQxg+wAYvgAGRolNLA6xEyUpa8pKYxGRAAAAh+QQFMgAgACwGAAgAQwBDAAAI/wBBCBxIsKDBgwhLzGGCsKHDhxAhunDQB06XGntORNzIsWOVKCScIEAQAYGDjihTGnQBEodLlxtIcFBJEyWFCC9zIogyp6ZPiH2c5MzpRMPPowddwEHgsiAOEjWQSh3IpIvQgwjguCgw1WCDHF++LNlYgAgJHAiLGiwDIkQarjXBHNEDAwYINmMhariKsEYJgWwtgPAhAoSbmmH0YBgIA8KaIA//QnSF8E8HEWNSLllhwiCEI0IgRoWIJslBBWbShN5Yx4vDL5EbLuNoAOWRxQg/RBxVEBUIUyBQRYLkEI0bPxyFvOjc0I7DAs67bsR90C5CtgRAgArukIfD7B3VAP9piEE3wTI2QJwBgQYEIhCkGg5HKOJPCJQAHlg3mGINHRBsqQdCB0gVtkMDKR1xUAUCpbCAegpI9ceAAWBBk3gDMTiQIyAIA9ErDgnnjXcdmOEGFgfUFMQDBXFIUGE/rWLJiW/BVRMNArkoHQizvYUUHfchVQxBwAmECwitMPDTfwSs98tDjKQ0DC66gICWTDWF0CQaBILgXU0+RCjQMN0c5AQRNO0gwmUFWfOQhwgl0YIBIUQBQjIHbXCHkihhgYYIPvhgUCkcFabAnCHUAQITEziEZUd0nKFAoAd98hAlAilwhgE2IIegQHk40ZATPXTUgA2TUmqQmw+1QIANdnz/SlAJDDWkJ58b+RmooAcRipAxtqT40AQkNCSTjRCNgQalvBZkaUMwhPEQsmaWetAJGhVUhA9/7HoQqwNdUBAbij5kFUJ6gpAtCEPEoYQVVigRA0ENWNDBrviypwAPoihjS3UgCNsQtQalM5MUMSjRhAACoIDCAAIoAchAB7RwWaAioIFGABaMUQcbGOiBkAlkRISAQYfIAkIt1OCxsAAe/CDzzBIocR4BARAWwIkHICgEGczRVEBVA6UsUCoDlWOIQTP/4EECBZURQggCD7TZfgatsJETKuciECcQNT0AFx2xMV5DJT8HQi5Ig30QIQfNPAAeHQE9bUNZvIGH2w01/9MI0zIP0AZHJRywAtYG5UXQE3rLgIIA0ag0swDzlu1Q0CBkkQAejhO0C0RwFySzBFZk0VEBdh90yl1TJNBG5ygc9cPDVuiQkuFY6zENCLY4Q0w7HkgQO0KRczSAB1bI8QRNZoMgsvO+cxT6Q7EjD4IO66oUhiQgMEjMQbz88NM4gwsCwgwz1FTAE8B8XxMhxe9YkCA6cGFFRMg4NP1BKiMhmUr0G4QVxLeR/DWEEMMDgTYEIguVDaQKNaGC+FBAQGxABBu8+IkDCAaRN/ABBAQ8igBAIC9AVIEVo+pDSobgk2yETyACaAII4iCFgpwMIWjJHkTkcEALOuQR+hBIBv9UMIQCIIuDBTlJRzLwk2Owq1wHgSBaEEKE/0XECA35QSgiIiuVkMBaHRlhFhGyO3Y8AABdPIgSETIBK0KkcgjxgEF8UZCzqU0MDckDSmaARYT8gAoCOcXuDgKaaVEABBswCJpQwhUsDmAgyBuEDqCzBofoIQcQKcEERCUQEpBgkSqZwryMkAEu2I4g5lkQEB4UkTxEpQtEMIpPjGhEbBGkAF+AgYYKUgETKCgiJXCj/ATihzWkYEH9ic4wafIBDOyyexWoAAzWAMVlpgQMuoymNqOJARxZkyYNeIEzt1mBC5hAWt+kiRYeMM5owiAQH1hNOlUChi2YAAMYAIIeoJAdxnmihA5hgAIUFgAAfyKlAQ2gpUIXytCGOpSWAQEAIfkEBQUAAAAsBgAIAEMAQwAACP8ACwgcSLCgwYMImQBYyLChw4cQI0qcKJEBhYVRiORByLGjx48c90SJwJCEEwogU6pUySBiBA4nKMqcSZOmkyguVurcSbALAhxAgwIlUbOo0aNIkyqdeIKn05Q1JhJ9+LRqwTwUiQz0k6ZIGasfZc6JEhHHt1YuQhhoYYZHAAtFwAr0A4ZMmCADZzoRiiNZMhzdFprpoODPHxEdeIwBG2bLhRQmHrBZAjLPz75/AwNAJVFBgDRVF0CuQBpGoDV4Pc5ZCHjYsoakAHiD2MFAA6da9MAgzbsChCMgoblGZcrUw1UQFbR4ygZDb94XLoBB2EBtCwDFjSp3KmRLColQClb/X/unAy1mxSjOdojGjVM6a75H3HK7jvXyCooiZ79YIFITEtlCxg4t4LfUQkl0YEFoEFVggiOlLJSfRD4Ug8qFGGbIGUM8EFBHVTk0VAEQyjjkw0Q81NTCDgcydIQJsZQIkTQzbRgROS0uVABXOaYI0TDdfJNjA0WsxQONFPlIkXEMaZZMi0W24ANhPpghE5IR0eIQDhD14JQBU054IGIinGGADX3I1JRKDWDRQRIQ/SITnA2VSUAIfjTQwEU5MnRAACIohSUABNhgRwF6CrTHBhSVsNIYaCwlzBkL0ZFQH05MVMVKLE4k50QPHDDDbRzxOdEMKmGBlDGx2FIBDF94/1TCHjgwGhESCAkiiEEh+HCiTKosZEtDGHwgxEdpSiTGpg2pkIEMMmQQxxQEuRERna840pAevaWwhqUemfqQrQAMEUcGLAzAkAADZCDFQGlQylASaKBhhhtY0EGDCc91G8ZHtJILkRIAqCvRmgUcsJAIIlgJAGgCqTERBB+AhKlDtSx0y0wovFHQASGEkAZED1ww0VfhpsNKQxsX1cZKNEyUwr8eVcFQy0YJQHCfALDRESBv7EwRIRPhweYSE8GwAsoDlQC0EiMIkKMKOsUs0czHFgA0HlEL4MFCzcj0w9hkkz2ADIDwrAcA5jzxBtdS5+gBuzIghTRFI3gwwNctsv/LhxEgAMJTHQxVMM00wxoV9kyEGCHHDVaRIawzESFT9uVjE02RFY9Ta5UQaU8Ey1LhAFCLAycg7NQUCbRRN88YcwlAskkJpIIMes/CDeymsyLLIQzhsEdVcggQNwA/UDR6RCgMgIIVCx0iy8oPoeSUDj94UDZSKBgvQxsJFOCCLAI7hKtTbRjc0O4UWd49CiPgkQAggqBaAhJ78QWUE304utMJRhDA5UKRPNE9QwDxewMgUlcQB0iEBF5yChWOZxQFzgBVB2GAGC7DFxJw4ClKGADmkME+h1zjGs4IhM8+QoEIbIAvEUCC6nQSAwpOhHILOcUDKCOrCTiBBAhAgBOrItAHBvjPKRmQAEViMQ2HmEANIDlBHojQhSgggQNzAAsglNA8dg2ABeg4BxMP1y8gWI0iBShBCZiQRTXKpQAJ4IIS8ACCG2wrIjt8I1hq8kQ9vrEBYUhBv3iDARr48Y10SNoamHbIpzRgIib4ViPB8gVBDhIIRyDVJKuyBSBckgybBAsY9MAv6KgwlHL5whqAgIFW6uEDfuCdLAFABiiwYQE5OCIqwaLJXQYEACH5BAUCAA4ALAoACwA8AD0AAAj/AB0IHEiwoMGDCAcWSMiwocOHAhFEYQKxosWHCPJc3Mix4IQCIEOKHEmypMmTIOdEQZAwyhyUMGPKLECEoZM8M3PqBMmhYY2dQGMygINQl4NRrjSFOBC06ciaBI06ULRIoKUkASykcepUgxMcUqk6QGWKoIgOAUJwDeqi1dSqqATGFfhqIJoWdJz60UKGTI6ZdjKNNWVqLkFQBDuMaQrmxQUTJvQc0XKyzBgLZ1ZNMnzQko/PHQg02CkkTAUMFypUuIDhAZiRdC6fUaCA1qtIqHLr3h0Jkl0LQJesMKG6eAUgW+wUsIwZDRoRFhEL7LBjtE4vEBCa8EJg9vOOAhUE/9i684iJgrZiOVL1iVYShpBw757fm5YCLEFfpNCjJ72jgtAl5ANEZywWFBsQqIcQJQ+RwlAmB1inEx02gEeQbwctgstRLkxoA2YK/OIQIg9NMpCGAumCgxMazBQCiN89xGBCaBCEi1QFETGTCGi8RxAlqgQp5JDsHaRABz60sEMOoySEABwMLMQRiQ1R6cCRSbRgQBENjFZDQxpY6NCMImgZQh0jaYAADmy22SYJUHUEJJFEftICAWeapNKabrb5pAvgIcIIQ7YIBNMEETQkpZgDORJLBXrAQIZDefDZJ5twWjhnKQJVQBAQNMS0Z0J3RBmSFDEo0VCAAYgSy0DGVf8AwwpLwHTCBGAWAEiqIwiQEI9oZDVGCWykEKtxQKgRU6U4IJQoHr06JGwZIJVm7LGqmRAqTHN0wRJBuQjEiUAePBShhAUcsAIMCT1Q66EkyELQuIwKxEZDyqJUwh7f0mtQI+CFkQJDNJRwUhYJ4OGQBz9wVEIZayR0wQNBkIQwHjKgMEC9DN2bkAn5FvBEAm1kPAAKAu3iEMAdCYxtBadIQoMgJGfM8Q8oPwTxwAT54kAFwDiAySwn16uxBzLIIZMQH2AAqc8OBG2Ryg0ZIgAKMrSRwBQ5FXLKz1IbxPAPZJdtdsMNjaD1EzudcMAqDD2yci+31G133eOm4kBTOlT/8lAoHKUSrgM/AZUACxJc4hDgD93igOCssCIQnEA9YYWvDslNyNlkeyCAACMIVIsshxziJgkTGKxTDAL8wAtHngvQRAZxSLEHK6ZfehNQXGws0CWPBC/88I/A4gAvng/AQgYqDCESERFcGoGOOwnSxgBkv+5QMMpnAILzJLnQQwROIIAACST00CFQckhg0Sad3GArBz1EEUUPHDDB9w/l/k688A5IhCOOoJM5vGQtbZBA/w6SiJ4BAF1rkckT2qAxzA0EGHooCBAWEEGgzIBkRnCAJ4BxAQf44lgmeEEHudKALVwLW3r4ywqbAgWGYMALHAMPGFLzshTOsCktZMgKH5TzQ6DUECE8y2FHwOCphBQxKHV4gRKnKJAvUBEhAQEAIfkEBQIAAQAsCgALADwAPQAACP8AAwgcSLCgwYMIB55IyLChw4cCnURxAbGixYckNFzcyLFgjQIgQ4ocSbKkyZMgmXRxkhAOA5QwY8o8MYFhRpk4c47Mg4AhEZ1Acc6JghBHADgugipFOYEEjqdPkyXDgQueBiZLs+5EEHVqt2HLUJEKYKCM1rMqA+D4uszUQFQBvLVI0+BsVmhgTek1uIpWi7p2c9YJYaAFqL0M0YwJHNMP4RZJOtBKUowUqsuYL4/11oEA4wM5ctARObiwiA4KLPa1YBcAmxV69KzxQqdI4cgKfOjWzUMgXIa0DJwF8wDDBT0VAhj79EpB6oQ8KmeejsqbJq1L1qSoYKLgJzO7w+//7u3w3VkvgRJKe/j74LAeSxuE2PGp40BLCIcJvPMyp/zCPnTASEPkNeSWQPoJNBUJHOBkWwsB5lagesAR1M1BJMAnE24FWaPKhyCGqIowZvAg3mkinGGAJn0ktMEdVdj3i0M+DITiGQSEUEcDDVDQEAf2PbReAArgaIMfI+2BwwZQNYmDEz0s1JGHIooojJGjlVRCH044CdWLMXb0SykMPVAGYCdRQEJDMwRpkDEB2ILcFzEpyaSXTyIRJJWqCGQLQRh8gOZJXCYkRhUiDaFCBg0lIdArjigzEHIVVJrCGnQ45MCPBQwRRwZNMJQEGmiY4cYYdNBgQqWstgpDGHUu/4lQLQEo0cQAD7mBxQEF1KXGqq22CsQHMhVKEK0B3CKQIQ+lQdISD1wQLKuX0lECTJsWpKybA9HA0KsOVZGLQNsaRIh9ZAA7bQUYsIESIG8o4VAz527UwBIrJFQtSfAqMYIAAnDbkLf6wgoSvHj8K4AHAjXj0A8dNZDuuhXo4Y45T7yRMMDmchTwQ/jCUNA009jiDDEycCywAAMQQgUIONEARKXTCOSMRY043BAKA3hAxRU66JRuyTcfhMwPSCet9A/1JtSLFYPocAJQJRywQtEHwfJQNAzhc9Y9DiHDC0eHsJLHtUtJsUnYDRnSyy2cCISDLKxEUAPaS6kgQUOwYMfDy9JIoyAACiPgkU8u6bBCAgkITDCHVnW0AY59hb+RxQwFVEFBDz1MsAfeWeEBDjcNZXO0QAKMoMQbgMyAuZagLyUHONg49IwATSgRgxSMyXQDC7M4dMzuU/eO0xWjI0RMAMq4azxQcvBxkDK+CLTCEs/rNMMN9xCzvDI1F0RG9tqHIQk7JE8LBA2Dko9SCWWsoe/17uf0AQQUc6eGwEGGkQJDNKgfTuggP4TsS4AwacAH+MdAg3zhfw2MYAG2EMEKgqGCCAkIACH5BAUCAA4ALAoACwA8ADsAAAj/AB0IHEiwoMGDCAcWSMiwocOHBOdAnEjxoZM8Jypq3DjQCcePCKMgSBhlTgmQKAsQYTgSpUsNJBjWcImSAZyECKLQREnE40BdQHXh8Lhw50YNHnUJVOQAV7VkJGoUKGqUootWDhQtcoCq67JhG0a5mEq1qkM7mbgKRCXQlKllTjSQNduwzBgLZ1ZNQmhqWI0SU+ketItXgQIHryLxRYVrbFmQZMsSPoMGjQiIphbJfbwx8ty7ASpfJuhDICmEkxZJ5VzRsx0bBAIosMwQUiS2BjO3YsB6Ilk6NixAktaBB4/SCZEffIuDhAaUdmN/KiWQkTBExx2eJmgKVTddJFZq/2wAHO8faYwMMvrlENLBbslwIIDjgmL5M7P/+BCFUFSSh3sJtMhTOODgQFwZORRCYbT5YIY1DFHC0GEC4pLMQeI5dNloAjkoDEOfOKCcQIfx0MIOAIzigFIGzccARz7wECJDiAw0mw8nFkHWTAn59NGHEf4hYgsG6FhQHk4YeFB4ve1EZAislTCHSAi5+FGNCTmixwEzNDSBQ01u5IgDFTiQAhkO5YGAkgf1QBN1ZBIEBA1hOjBlSwfd8eJAUsSAR0OXJRGAMrGUGedAMKywREMlfIkQm4D4OYIDAyB0mQJnWGBDAWwwZAIZQjSkJpsFkaAOHiOgMAAKDGU6Bh0OLP+EZkIY0MAoE13gKVAuAnFCURkGHbACDAjB8MASdU7gBCsE+bpTpwkBMStDe2zQK0KNfBRGCtHS0EBCTyTwp0PZalQAsAldcKxBUyTQhgweCFYQG0AkZIIaA4X7rgerCrQLudpye1AFktCZABfwVlrQDw1F0wjDBLH6ELoEVeALmcAk0g4vCm8UDSEQs+qBDHJAxAYGAlnsCzAUEfJvQs0QIhAKMrSRwBQThQFDBRVMo8xBhjRU7kHRrCoDHglkoVEZa6QwDTDXGPSIQ4Q00otBvYyAxxuAgPQBBL4Qk1AoEB/0Q9W7XN3LOhlwPUNgHDUQxiksj83QDx4IIEATSsS4IAVgc31UAB1rOJPQ1DIbFO/efUshyNuRQVZAA+YkotEATWQQxxALeQa35IUYfvdAA7CQgQqc9/a54AXYsULUCD0SjAMsGAHCDTN0KS9BZFXO0Cad3FCnYFMVMo3lBUXtyBG7P9T6GuzEkojYDtTtwAM5NN/QVB8A4Ysv0xy0gPbbg3EBz4YSZMILw+9egO4IVaBH9uQ3ZAKtXtSfUAnmM/SC/gmpwxbud5BE2QGACIECAjfSv/oFBAAh+QQFAgAAACwKAAsAOwA7AAAI/wABCBxIsKDBgwgHnkjIsKHDhwNdQJxI8aGGAhUzahRIYqPHjHAkfhxZg6GTkSgBIGBIJKVHF1EYwnHpsUbHgThy4hhYgqZHHLp06czppKXPinNGAcChSJGuZDoRwGFwdGKJOtAALEO1bNmioDlvVm3oJwSBFqAGmlo7rJpQEkbHGixroEUSNAKLEWQLVSpVuQLpthDRAW9DXEJPMhkrOEkHBRBNLYIK92idEAbO/HnMkFkxUnu/4thwx+XluiIAKPChUTJUgRw+nh782Idt2w9RqV3mlGiPjAUaYLZb2wcPM2Z43G7ITC2AyTkBkP77UDhqzraRI5ImTURy3BCh7//kyAFjwyJ1N0MGcNvML2GlSgFgJAyRGdYIaQ0cJjD6QCe/OZSEagVlJw0jBjHyS0KpGRBCFwmRBkBPGRmHCIIHiaKcQIRBRkAIdjQAwAQMiVWhGdY0xINqZxBgQx0GbZAQgBv5YMYnDrnox0EFMAEhQhJqZJwoCRnzQBrmfUQhTbYAAEMYDc2wh4wImfiRMQA0SRAbDvl4EkJiVEHQECpkwNCACrwiijJaHlSGQxQ8NEQcGTQBgAAHDYhGAG6M4QcNAOiBUApQNrQHQ7VQo0QTAgjgQUJ8YnGAQDAyBASXDvXx5UC1CHTLRGkYtMQDFyS0wgFLIkQBCbKMBWhCKTj/hFEunh5FhgkMsVHpQYC8oURDvRDyg0ZLMATDqQYBEgMeI6DgUDSNDKvRqwmRMVCvzDo7UDMM7SKsRgXcitApALAhyBvZ4lkQIdEgBO0P0mY0qUEV+AKAM8QAMAsAjx4Eb7sF9QIvvAX9YMVDMwAAxEAVVDCNMxMN3EwvFPeySyPCEsyvFVzoIAhEZMQKQMO+AFMQMg3BSwjGPzQS7Q/aAsAFAB9TdMAKMDRc7zUEweLQwECjMAAKMrSRwBMesYEBySYbhDJDA3sw9AhGZzGSEACk0PA0iRz0NENT4/FGFoIkjNLNOT+MEC8MjQDAG4AUkGRKBbABRL0QQyTACErEmQAIYACEobUeFfBsUCgDCdCEEnFIAbhAJdDhpMN5F/TMAE1kEMcQcj++5d2UGz7QMQAM4TlCgjeshy+xOJNIvgBQe7pBb2qtui++TAOAvUHMfhDWS+vcMEFq+H6Q4AkBcYTxBkme0AUP9M58QRgkr4aI0wNQQBgwMLR89oGt0T1Ca7wJfgEfJIQr+AN9MT5CDcgt//z0119/QAAh+QQFAgAAACwKAAsAPgA8AAAI/wABCBxIsKDBgwgHFkjIsKHDhwW7MIFIsSJFBHksatx4cALHjwjnNIzCZCHIkwBKEGGIEaVLDk4YenR5kgEchlFE0gS5MiFGkzs1niCIA0fBCDODbnRxE0DRogRzllCq0U48eDiSPYUKwElGqhDp2BhIatmiarq2CqwBFOxBsQTOKOgAwFskU6aWoX0qMKdbg3DlohFx0NSwtHwB5Bn6N7ACAIQb4kJsFEANt3ABPI6MEFIkVABMLaIMAEEUF0EdQ7YoWitXBBpcquZMkVTo0YlJXP44W6CP3z4ges67t3Lp0xp7+wbOnOIi1wWdxKYYIu7mgsyzB0/4GMBzrgR1V/8kTHtgdh5mzPAAjjD4DlejEBgniACOi7YbmaNHJE3ar/TbaQZAcAYUUUAJJeyGkHQoAWcGIsIwIlApn/z3WBItGBACfhogkJBujH30mxm/SFhQKdIAoGEdIUXhk30n/caDKAmV4VANMS04nYhmUHJQBQCkQIZDeXiYUE88CiOQIwAASRANDs0RhZEG1ccAR4Sh0YI1AFxwUAoALNHQCUkhtCMALAzQEGcWpAQFBk4aBIQa+BmUR44IqSOQmg4lAYAFY9iYUhhgJgRlQ1JSaVA0AnhA0QGArVHoQQ8sUWdBE+Ap0C0DRdPIDyAJ8QEGCZmgBpEMeUAIqCAVMulBNAj/kZAUAq2DkKc/sMqbpAhd8EAQBU31hhIACDCAAL0sumquKI2a0JwHCdAoAD8QQsguvWTbSzOf5qorR0J8AQNCFWBwqEDGGpSrtdU20i2z0VZkB68FAckOMJgI4JC3/H47kL6EUAECADM8VICzBFVQgS/KVNSvtwZRcQXBBVP0hZcDKVzBNMQI5Oi+zMLrsRWD6DBFxRUVUAe9TVagRywCPfKRB1YAoIMgzQIhkMa+AENQKBChIJAMAglSwAwoc1TAxTsr3PPPDaGgLwBtJPBEAZd+5AevGuthC0GXIHOQ0ELjkYBASe9UwpstK8zxQ3i8kQXSfwkEhpdAOm3LNQLBioIMLwONAEAMgNBdt0AFCLEFmBovrEzHsAQDDgBKxEDr4Qix3bbLPTtzzhuYO3R3012f4o48oTvUwBYmZNy4lzmkzlABUDCEwQKyMwRGBRgbZMILuSdUAOsJ6RF78AfVnhAGXmQtuxBa8J4Q8MgbNHzrCK1gR/UGKf8l9wdpoUfv1oNPUAMvkJp6QAAh+QQFAgAUACwKAAsAPgA8AAAI/wApCBxIsKDBgwgHlkjIsKHDhwWjzIFIsSJFJxosatx4sAbHjwiZNITjAqTJgQUcZjx5cmVCjyxBnijJkGRMkzARYrz5cSFDEjl5ckSQ0KZQiwVK1CBBAQdCl0cdNqDToIAGJziyOi1IJGrDOhQMtDjTgoCWUQi0bh1o1CtBPyEotBDRAY0IBR0oZCKh1qAGn17rxG2RhIICg7QoLErWd6CTrlEFG6DwB42CPwl/LVO7ViAcBjzhyhVh2CEPgd10aS3IlKVkCkksY67YbcNqroA1NgghljTHPyJwfbtN8LNGyXNLf0RDbwLWzgQ5WBRb+LBJBT405UmbEDLE6g59iP/30TCAjQZzoiTccAf0zfHwyRf0nabqiQk/pceMH580aQIUNFBQHk4k5EQPKZ0UHw9mmOGDZWcQYIMfB+V2EHvumTQeg79II80rBoRAh0MTtHYQCRwk+NGGv3zCiEAPsLGEigjReJATQXFEFw+/iKJMCgJdAMEKWjzURYEn1mAjBUpQpEAAFoyxBpAFYbCFHQ0tSRAJDqioRBMUDFDRAQWQYUJCZDy0wQYGsUJBHjEIJICYDZHmBgUHCFRAAWxg8NGeNURw0D4jCKBbQQUccSZCKzw0h0duCsRJLxII0MgPJvHZUJpZAtIPBZP2Uk4jl/6AqUmcMqSlQIBQgMcIhsT/Gmuppp5UwgErwIBQCissgahAeAzkAamkmmrsTWwAAdETA6FAJwXGRlvrTWFQmdCeOlBBgQAeHFTrsQ2hMGauCMHwwAFDyPAsSOJ6IIMcFKxqULIHVVCBCfzgIQFLKMjARQKCyHtQtfVW4A4oI8zCUbf9tpHAEwInVAa5BNlbwQPAfITCCHgkkMUMJrFhkMW+ZIwMRN1SwPEbWVBrrUAWnwIBBQoz1K2hSrzRqlBljGzxNMQ8w8tBNzehRJzxRuXHBz5XcIoym4BzkNFxSLGnWwIRXLHFkoAyjwcDiNlEBioMcTXWA9GxRtMXB6EDCHLEMQTaCTHdNBALnE03QjMUR6KrzyYcsbdDar9sEAACDl43Q8oqztAXMFTg+EZ2TJnQA5PX3fhBeGduUAGQS8654J4XVIflpVNkd+oQgRE56w8VsMXmdAcEACH5BAUCABQALAoACwA7ADwAAAj/ACkIHEiwoMGDCAcWSMiwocOHArswgUixokMEeSxq3DgwwgSOIAvOaRhlZMiTDjOiBMmh4YQTKzcWYEDSZEyNRBhiLHHTIsyeQB9GobAwqEOeORMiMOqwgFOBJBjWYHrQzwE6TguUcAGH4VCqAunYoHAmwBk3NrJObVgUqFiyaCiImItGgQGtGpzgQEhi7U2xBCgo6CDCR8E/HbAU4Lo0oYuVb88okMtQxBk/J2qQ2HvQyUnAggkbfhiiQF7OB/1WBCx5o4i0jBk+hsh6sgiOPIo41cxQA0QCrW+D7OAma96Enh/eFh4SjZnSTmcjRADHxU+wAs9AX1hAtUEnvqlO/za84wCFBgQ1ND5IwgHPmD7iD/bRwoDug235OsgPUn6HJC0IxF9qyOVxHUgidKBAfSHU8dRDTmzwnUQDWmSZASHY0UBWDzLUXQQSDhRhHiVUmEFDHZBFgA1+NLBhCWUcIERWTX1Ewo0kRJEHjQOdKIAACCl4xop0EOVUA2S8sMIKW0BxwHseFlCFAzVMoIELJZQ4BAUnUgBkQmdYYEORChVgBw0YmAADDCZAsEYOD3GYZQlSxKFEExSVMaBTHwRiEAZbkBmlU1LEcOePHvwQUgFa6HHBQUCoAZGhTSD6g6InFbAABgxBiZASXgqQ6KUr8cnpQRc8EIRBT1AAqpcUXP9Kak9QUOTUDVT8iB1RFMCQkAlHCFgAIFYMsOtAdKyRAkKPBpGVHBKs9IMVDzXwwamQquFUCbmG5AG1OlD0ha8IAesUICN4YBEKA3FBgSAW2aEssw8AUMATI7BbkQxtUPBEhQ9di1AFQCzgVAZfQpTAux1qNO7AQBxRwAkxGIvQAOziQUEWN9nBUKr2FoCHBPoSNAIFbxgFsEAVmGCwU3LkSwEKJ8cACFhfPFruETOem0AMb0jhKVMr90pByDweKxAUECTEKXpKF9QAGDoj9ELUB9VhNEJ65FA0drVibREYFYhdUQFbJFSBHmYXBAW2f3rR9kBk/3r13ESljbdDYe8NzZAWFVTtt0FC3I1dQAAh+QQFAgA3ACwKAAsAOwA8AAAI/wBvCBxIsKDBgwgHlkjIsKHDhwKjzIFIsaJDJxosatw4kESNAiBDihxJsqTJkwWYNITjAqXLly9P1GCIEabNmyI1kGA4k6NPhS5WtsRJ9GVPhDWLKjX5s2nFDQlZllhKVeTRgzudNnXCkMjUqlVdRGEIhwFYmDNIam1ax4aBFi3cGDgw8kSehkTOjvQTgkALER0UKEDT4YwNkREbmj3L18AZwAoMogmQZqRDDlUbn0kSmGEHAg1E3u2qlK9fERQVnKETMjHCDXcWwzT9F42CPxSTBDgQOuQEhyodvk1ie6OI1SJL5EGQkMQEmJzR/PzcO+TE5s8LrE2ogDLJE78Rkv/QoH07wjMhTO5BALWgE6nlzUMWSLfk1AkR2gt0klR+h+MG2OBHdSdRIEYEJCQIhwYntLbWGQQISOBLVThQwwQcMPBVfBzZBqENrFVVwoYgHRSHEg1Jd4MFIOqlVkExoMgQGpNZMEZBLpIkRYwPBWBjGTmetKMSI1BUn0sNHLBEHUoBEgMeRa4Vkh8LbLHCCltAASRMUrwBpQADoLAdSAccAYEJMMBgAgRbAIDSFF4KFKZ5AoFEAwQV5KknBC9MGNIQGYBJJ45fwJAQGX4+QYUEgxrUABR46ikpEDSUJAejjeLIBgaSSgrDCktMSIUAP3kgg1YpDBQSICOIqREKMrTXkcAUNoVhQqeT0kAiqx5A1KtAeCSQBU4llLGCoQktIdIJRpDK0K8j4PEGIFSxAQRDaoykwgAJCeDstGeFkQKueppQp0hKSPCrQN6OoEQMUjSol7EwkFsBDA8oK9ITXLDgrQBNvCtFkCGxwRAQ2ZI0RAwgxDAEwSOFUa+9QBwB8U3FMnTBA0FcfNMHB6shhMcwicuQxSS/RMcaqSL0gJspo9QAyJlq9UXLCB0xcswnrZwQvjDzbBLNCS0g9EmFnny0SX6sgWzNPxENtU+FVjC1TwVscfUNAQEAIfkEBQIADgAsCQALADoAPAAACP8AHQgcSLCgwYMICRZIyLChw4cOupSASLFiww17JlrcyDEChQIgQ4ocSbKkyZNzGDrpwuSky5cwQZYgwhBHnpg4c4bk4IQhhRk6g75koJKl0KMmaSZEcBOpU5AnHE54SpUBHAQJu8yh+lQpQqYcwx4kwXAqV6RWGUZpedZlWLBiGZZp4LKEhoZm29KxIfBMCwJp6II0CEft1qcN9hI4g0agCAUdzIwxGZUhU6eKGXcQ4aOzZwU8ipi8y5CD0MwKHHawILJgYYQkTONEvdmz7ds+RJwpY7LG0j0nXjYIsRgyZ9zIO4sIcGA0CRzQo+Mg0afEwoYiaiffnvsMnZNEImz/kO7E5uC4DTsQOFliTg0EJOKTiNL0OnqEHc40f7mHQo0aHMxhXUj3GYRGBy2IFlMJA7ZW4ECQ+dDCDt899WCELRigIFX3QfZHhiG05ZAKGTDUgQIg1vFgQ3GUmNBmZxgQgh0NrJhQHA4lcQYBNvjRgGBtjVSZA00IMIBDdgR5khQOKGGjQE9N8YaTDgjggY1PSZHBAANc+aQDIy2xRJIxZSDBlwOF1AAZLzzwwBofBPHSGwKgCSVIfrABgQkwwJACBCuAcdIJeBxpJ5gFQBHIBRU02qgJaxzQ4EhG1GlnAQ0A8AAMjnYKgUEhnZCBpRVxoZMaGHTaqQlHnDSIoQ+1t5HAE0FBgQFDAJh0AwsoHNTrQAlkAZRQC9ya0AInqeABqQ7A6kAWBcwwrFBgqKoqEAeJ9AYVfKDw6xuABLlFCtY2esEDObgkiA5vJIAmFA0hq6ROWlTAaLkmvDBvUFuYkJAe6e6LExTYHntoQ0JooccFCekrME5bMATwwzDV4UVDXlAMk8IMI+SwxifV8YIJ5TaqhxYgu+TFpwllnLJJHDf88kkjHyxWA14UbDNHOeixs1gvGGtnQAAh+QQFAgASACwKAAwAPAA7AAAI/wAlCBxIsKDBgwgFRpmTsKHDhxAHOslzIqLFixAnFNjIsaPHjyBDitzIpCGChSVGqlzJ0iECDSxjyvSogUTDGgUw6tw58KQLnkAPOknoBObMoytLPMSJtKnInw3hQA1K1WHRqlWHJqyR0qlXjiWmIpSKtaxQo1/TPnSQdmbDDQhJOOjatkERA25auNlRJmnDonXvtvCBRoHhDmdCrMxj06CThV+L7BjcQYGPy5jRBEgzsgSTGhHg9nzpVDJlNJhTY+5AoIHKORMQkJhNAo4GujHTGKBsWbVvHyLO0FFZosQeCkRqcGCAOybh3r9/J9ncNqaI6Nh9TO/r1GzCDha+ev8/qMBMEaTjEYroEMDGxvRA1ys4QyANfJ4iCp+xYIPO/Z1ooLHfGP79VxALAzQUYAAWjMFddSINEUcGEInA4BgHQChSCVLEMZAAER3QgGsafgSIQE0IkKCBF210gxUrsojRRlNQESOLTcVx431fKQGigV/NYIQAPxRp5JFIFvmjRR0JsUQQw8WUAZFJVqkiH1SAgJQfC2zxwANrfLDESjPIsSNCP1Ahhw5NlXEEBCZccEEKEKyhxUpDjEAlkigM8IMVV+gwg1dsBFLBoYgCsUaUI72BoAeQCuSBFVzoIEhaWsiJ6KYYqCHESjooMQIfLMjARQInQOgFBptuaoJDHQl2IsUNNzxRYgEfYNAQADKdUJGMBHV6K1JfwFBBQkd8OqxMdqyRQquIwvAAr8vKlCus1cZU7LHA7uTHGjAk9EC3CeHaEAYLZBsTGBdwS+5FMzjbUA7qsgRFQ0C8e1AD7LqrL0QNbJHCvxdBoSvBEbGLsEVb5CtjQAAh+QQFAgABACwKAAwAPAA7AAAI/wADCBxIsKDBgwgDkEBSIKHDhxAjCtyAY09DiRgzPiThoIDHjyBDihxJsqTHOQ6d9DHJsqXLAiUcbhBj8aXNmwU4OHHo4ITGn0AHqrwYtGhBEjiSKk1KsSbOpyWZQKQAtSpJBin7xDTKFWLFrl2RLl3qRIPVsyCxJiRhFizXCGOZVkRLt4QGsWMX0t3LBAlcsjQ/ug1QByqDHk5IKCYRJc9ej3RsEGhxxs0OOjhP5JlApAYHF3sjEziDRqAINB1apHlaokRoyaQ7iPBBu3ZqzI9thhitQHbt37Z35LYpwjfw4z7QuBn+Mgny5wpagBw8WLlg6m47YLmOnWsHN7i7c/9VgKbFAY/ig/b20QKLH6LpMa5vYaAI/PgBlDQRkLD3H/r2MTeSFDEoIdAADv1nQAiFCSjSGz816GBIU+CBIH5AfdSGBBhm6NENfHjQ4U8eCQLChSNmpCGKKUYE0iAD/CDjjDTSiEJRZ70hQI08ojCABzLIMaFJU1DBYkEoyNBGAlMMyZIOI0jgwQ8eeDBAkngkkMVeDSwBQBlQ3aDflCPg8QYguanxwgMPrMCGFlANoYMOaA7HBgYmXHBBChA8EMZTM8wgIBQQGGTCA0s04KRLSzwAA0ILLOoSGSYk9IKkLDWwABAIXaBHDpiaRAanDgkR6kgN5KDHBS2S+EIKCek60epBmpJ6EBBenEoSAI7OquILlSYEp64iLRDsQRh40YCvBPHKKrMuHnEstKWqYSu1DjmLLURHFNphQAAh+QQFAgAAACwJAAsAPAA8AAAI/wABCBxIsKDBgwgJlkjIsKHDhwKdRJkDsaJFhzic5DlxsaNHgjU+ijTIhCGCKC5GqgRQgCEOBBpWqtRAgmGNljJzFtwAJ6XOj04Qvtz48yJOhg6KdvSJkASHo0ofngh5cAOAPVCjOszjxGrBCD0KZNXKsMCECAgIRoBTRSzZigUc3CFBFwGStm7fOhRbgIEGBw72nOCrFyLfEiX4Ev6Z16hixTofL4YrWWaDIgbcuCFgowFkx5Yxt/CBRoGCDmjcHPhceGAB0T4AKDDYwY3nxq0Fkp6dsAOWybkBiHCYGnhwhwpaGD/OsPZy5gg7GHgOvSCaM2VwVzc4/EwR7dsFiv8ofYbAgeAZWAxIOP66BRt0CmcBkAHAAAEMRZyxMCZ+4QJSGLEeROe1xpcSEoRX1gk6eKBgQnzJMeCDBSnWxoQUEsTXFRhmKJBYMySAgocV8mVEggbh94MV1Sl2gxUSoOCBgwB4YMUgOizUIl9SDCJDE01YwYUOU8jEmkWPPTHEEFOcwNFKko310JFGRillQ+BBaSV1wSkGBhtbbHGEGnRceRxfUFyAQQopAAHBFkE8KFYDC0BwQUEYbOFfeAUs8QAMB2GghoIFCEEGEAgBcQSFUGCQ0ANyeuFoQgs8+MUFFZBoUB1rpMBQDg9+gGiilfJ5aaaaElTHFgytQYeOLX4RMKlBJmQIBqYJNUDhFqO+FRAAIfkEBQUAAQAsCQALAD0APAAACP8AAwgcSLCgwYMICRZIyLChw4cE+yyESLGiww049ky0yLHjQAoFQoocSbKkyZMoRc5h6ERiypcwYxYo0RBHFZk4c4rk4ASHz58/neQ54bGoRaEbjSoNQALoTwR3GOicGpNmBKc+SdSgyvVliR4RMP6M0MXFjK5oTc6ZIIaE2w1EpKadW7IKBwocNNLda7IE37+AAwseTLiw4cOIE4ukY4NAixYWbDRQ/LJBCAJnFAgUgUaBBTojlxoV0UGEj9OoO1gILdpjEtSwTycJIbK17YEdDNS+bRvN6pC8beeenDT4aBu7jRtVnVx5wThKHKJRDVrxGyVNBDBU0IFHizFCKA/PQjGA4esWO4pQDgligAeHRRrIX59FBgrnRUXOSHAff/6QcWjnn0civSHggByJNAQL7yFY0UiCtCGBgwmGBIgREqDggQfkeSDDFeullMUVMvDBhwxtJPBEiDBlcUMAK7IY01ky1mjjjTjmqKNJDdSxY0lafLDFGi9AcYBfOy6gBwQmpGACBGuAsSMZKcBQkAkrLJHjDGuYcBAEXuQIxgUUdlSAGl4mpAWOVCaEQZg35vAAmWVaVMALDK1gB44LAIFQCnUmBMADViKk4xEQIBgQACH5BAUUAAAALAkADAA9ADsAAAj/AAEIHEiwoMGDCAd2YZKwocOHEAfiQADgRMSLGCE64ZCxo0eDGj6KzLhBTJUCKFOqXMmypcuXKjWQwEGzJo4IRErA3MmzZ8oTNSJssEkCzkmfSJOuZDJBDImnCJAcVUpVaRUOFBzkOVG1q9evYMOKHUu2rNmzaNOqXcu2rdu3cOPKXVnEgAULBoqsHMm3oA80gDv4MKCyr2GDIjoQTnm4scAkPvSidOxYMWPKh9FYKIy5LxoClzvzRTNmLsopcTI47ODGNEolEhombnHA9ZXYCEWIOGOgjGspTVA0DEHHNco3wkWPVBlHgHK+Kd84fy4S5Qngyal3VDkIt/aMKqfgdBkgwIOH7xdVnohjZMQIK3KM8wQkRZD8+/jz69/Pv7///wAGWJUQdgQIBg1brPGCF7XxB0UFGKSQggkQrJGDEPkJoQYQF1TgoYdArNHgfQeskMKHKEKAnkMNhGHCih8tgAGMHqlBo0daVHDBjRgJ8QIQ3wUEACH5BAUFAAEALAcACABCAEMAAAj/AAsIHEiwoMGDCBMqXMiwocOHECNKnEix4kAmLpiUsMjRYQkGE7rAiUIkT8eTCfPcieAEAQISCBygnDmwyh0nOHLm3EBCA82ZNSLoHOqkz8afFkvMiYJgqNMqSDkyuLPBqU4neU5EpVjCBZymVnFg3WoRCU6rCO4wIFuRg1CrJGqwrViiR4SqOiN0cTFjLsU5E8SQGLyByFq/FqtwoMBhD+KZRx9Lnky5suXLmDNrLtBgDIEWLSzYaLBZoYUOHRSIQKPAAp3SBw108EG7dgcLsAumMSOitu8kIXIPHDPbt20DwgXuQGO8NhrcybEwb+6jgwHSwov4SEJdhI3kAk83/78NXuABN6mTJEFz+7XkBG0yGGmTYCEdAy3MmGkxRsjkQSgMIIAAA6CAxxQL+bHEAZWBMIAHP0QYoQR4lJeFDChIKKEHHtQn3AwJZKihhANwAV4cAowooQBKgPdGiir+MECFyQ3BAoQqDgCCIMkJ0oYEKgrQxBDlAWKEBChw6MEATbzRl4VXyMAHH03gcUN5BWVxgw5SYOnll2CGKeaYEdVRx5iF0LDFGkeoYYeXDXyQAgYppGACBC8sgSUUgVxQwZ9/4lleDnr4CSigQIQB3gIYHHooBmwkJ8QHjTr6pwkvgAcFBJZemqlwDZBhQqcVQPABeGWskIKlF1wARnlq1CN5KAwQQOElGStgoCsGD3jhH5YNLKHGB2wsAACZyCarLGUBAQAh+QQFAgAAACwKAAsAPQA8AAAI/wALCBxIsKDBgwgTKlzIsKHDhxAjSpxI8SATFy4qamzogkIXOHB6aNhI0uCeKBGcIEBAwkmNEyVLuojiBIdNmxsiOIAZs+IJBxFuCkUAJ2PPikhqCr3pJA+ToxNPREGw9CYJB1Ap9lFalQSHrBNrkKiKYwOOPWAl5kFgdmmEHmknTohA9WYEOFXiTnRwh4RfBEjy6p3IQIMDB3t4Dp5YosTix5AjC5yRxoAbNwRsNJDcEAuPDgoUdEDj5gDnhA1siBDho3XrDm42nz7YQoHr2x2wzC5Imcft26R3F7SR5LdrBS2EEwxh3DVs5QPpnGFtvIMB6JN3dDCO5kwZ7AL9WP8A3VpEhzNFwA+cseOM7zMETKsn6CdNke+Ds6jIYIUKHh2CzFeAFEZIIAAKKAzgwSACKiHBDxBC6MEAcoB3gg4eRKghCk0MAZ4cA2iooQAxKCZcGyGKCCGF4F2RoooDgIDdDAmgoKKEOqhXoIoSGDHfDVZIgIIHHiRIxQ0CSjGIDE00YQUITwg40BNDDDGFlFhmqR4YbGyxxRFq0CElFBdgkEIKQECwRRDqNbAABBdUIKecGGxhB3hLPADDnHwCoQZ2QpABBJ990gAeFBgQOmcKa4DnRaKKVpDCFuB9kUKkFWBgKHZ1rGGCoheYEIZ6YcDw6ZwXBPJBHfORsQIGsCYWCoUfUh6gxgdseKFFA7IJyKuWwCoXEAAh+QQFAgAZACwMAA4AOAA3AAAI/wALCBxIsKDBgwgTKlzIsKHDhxAjSpy4kIkLFxQzJizBYEKUO3B6aNBIcmAeOBEQbEBAwsmEkhk5wnGCo2bNDRE4wKQ4IYLNn06iMCmxEyKTLjR/2kSwpyhEF3AQKLVJQgMTpw7nRJE6FYeTkVgdEiHRdYOYKmEdaiA7NUKNtA9rpLSJMwoDoiQb1JlYgsIdEoA3EGFQ0oaFFmfc7KAjkYEGBxya4s1oAE0HBSIst0gD1yEWNH98iBbdoQXjzgrrtFAwunWHHagVFgndejQaN7ET2hBRe7SCFrkRzu4t+nbwg37OsO7dAcvxg1g6MHdz+nlBAmjQiMiMpsUB6wjHuP8JEKAFFj/gFdIpMyO9+/cOE7RRokTODfgDp+ARMEAA/yYqnIBfGxL8YKCBKAgQB3w38OHBgQeiMIIU7gkCwgAQQihADO+1gWGGBg4gx3uDfAjiACC894YAICKYgCDuTUGFiQcOYAWM7+kwggQPeuCBBCPoICCDSjRhYBNtDFHSFzRssQUNZFA0hA46KNleRnZ8kAIQKaSAgQk0lCHRDIIMSdIHgVxQwZprBkIDfFpUoCaba14AAxjvQYEBnXRiAIUQ7tEABJ9sAnHEe2wMSmgFhronhBqKEgoBFO8F8QAMhMKghxbweYEBpmzCAIEX+BWwwAMYAAEEBg940UADpQYQ4QUbbHgBQKm45qrrrgsFBAAh+QQFAgAAACwQABEAMQAwAAAI/wALCBxIsKDBgwgTKlzIsKHDhxAjSjTIhIGLExMzEnRBocsdOH04YNQYsUSVKBGcIEDgJAKROSQhzulCAofNmxEmjIy5kAmHCDeDIhDDgGfDHjWD3iTBwSjDPk6U3nRCwelCJFGl4iDhIGIIAm5aWBjjpyEFoFoR5IG4Q0EHNArQdHBzoMHCPTg2SCWBBOIYNEl8CPaRZG4dhg5IIAhKAs6ehw1aoBlMuQOWhhyikNiMAEkVyEUoi0bjxqGLPA447Nnp0IYI0YMVtHhYQmOIwLB9kLaqkM4ZBbk77OCdsMGODrA7tKBDvLiFDgr+/HHbIk1zhQ2wtDDDo4UB5tcX1v9Jk8ZO+PPo06tf3xCQCiVUMsgZwn7gDSsSBKAQMKDJm/pTUDHADwQSiMIPCbAXx4AFFigAFewpIUCDBXrAxw2CpDeDERNSaGCCEQmxRBDgNZRBhx56AKJDfiywxQMPrPHBEgzNIAeDFKIwghQPlXEEBCZccEEKEKyhBUNDjIBigRK0McVDbARSwZRUArFGiQm9wcIAHnTJXwaAPKSFkFSWCYQaDemgxAh8sGCFCqwx5AUGZZpJg0OCSHHDDU9G9AGddU5pwhYQnRCnQ1AAGmgKL6z3RQqBTgkBFEKoJ8QWQAQKgx45sPeFHplSaUIKalS6XglabAEDEECksAYZ9Q0QVAcYCywQRhmx5qrrrgsFBAAh+QQFAgAAACwSABQALAAqAAAI/wALCBxIsKDBgwgTKlzIsKHDhxAjIpzDwMUJiRhPMJgQ5c4dJBxKYIS4B04EBBs2OCFRg0nEOmUaNGQAhwSOmzc3RKDwMISFFmdaEEgjMyGFCDiTIoDjQuRCLCI6KBChoIOZMQr7OEmalEQehiFEiPBBlqwCHkUQMomCgCtOEhxcKnTToazdDhYQltDq9ibchWXOjLVLVsSZMghr2HS7AUeVGQkbHAiQhHDhAAcQ5kHpNgIRhnQEW/ZhmI7Rk0kjRGHgVKGFupY7EFBYggOclTaJsG4YgocCwh3OZF7oIo8DDVWYlGi9cAwPqVQ7tEjL0OlyiUUInAm6w/RIiDJn2P/5Tr68+fPo06tfz179lARc8LSJAah9QSkZBAzYL8CKDkEQ1bHEEnU4lIEEPySY4ABN6OBQGV5s8cADW3hBB3MGvSGAghwOkAGGBwWxBQQmXHCBCYG8sERCJ+AxAIcKesDHDQy9AEEFOOYYyBEKGbEhjAmikACACZFhQo5IVpACGAidkB+QQSawEBtAJJkjBlAkNMiLQHrQxBAXJXTEkVZWAAQNCd3AAgpASqAEQzSQaSUQbCikggc//oCCBFbQSJsaGJRZAQZqLPQGFYSggMIIXNTH0BIPpGClCSscAGJBJ+jwRgJSQOaQGinIaWYFYdg3EBlrmIABBils8YUQpgoRVAIdYXjhxRfexarrrrxCFBAAIfkEBQIAKgAsFQAXACYAJAAACP8ACwgcSLCgwYMIEypcyBDhjIYQDxYh0KKFGwMHGs5hwIBJwzE+OihQgKbDGRsKXUzoIuZOFwdzFIbwIcKHTZtoAqRBWCVKBAQbNjiJgMRFQgsdbirtQKCBQSZ9SOCYSjUCEYRlztRUalPBGToGOUSgSjZolYMHAmzlmiTAAacEiUglS5WEg4Nl1HK1KeKrQSRO6NadgNANmr0hmxqUK3gqCQoHZ4QQsbarzoMOxjYmkSchFhEdRCRRYDIEQgZ3EAgm0YdJCYQNQrg5E+AMRoUcnASue2dPQzoH/DTU0AUBCRIbkFQ5ETEikzwcOOx53by69evYs2vfDvvAkjrcEfr2WbBlxYotUMqEJ3jgCAQTMGCYgLAFgEIpIJRkwBPjyUIaEFQg4IAQvICQIDqMMIAAAixIxQ0JfQHDgBRWYEIYBw2h4A8ccjiADFIwV1ADUARYoYAYfGDQDFxI0OGLEnCBEBsYnCigCUcIYZAVArzYIQoy+DfiBzXaiKNBUozggY8cetDEEAeRYYKNFUDgBXUDZaEkkz84GaJBZawwZYUpPGCfQRkMwKUAVCRExgVj3piCGgglgMKSPkoAgkJhrGECBhiYsAYZDhVwBYNLesAgHiImREcYXngRRhlYIhQDFXz8wAcVMaxnkCA3JHDDFJ4q9FCp1QUEACH5BAUCAA8ALBYAGAAkACIAAAj/AAsIHEiwAJ0DdgoqXMiwoA03ZwKcsVCkoUWGdXagQSOiYwceYy6KHGiDo4+TJ0X4KNJg5EU3aFDK7GDBpcUDAZLIRCniDJ2WCl0wYMDkYpqcO1MGOKCQQY0oYu50cVCUIZ0zCpL6UHAG6MA9cCIg2LDBSYQeLhpa6KC1gwGCJVxEIYGjrt0INRoW4ZF1ZosyBR1EsEt4wx0GJRiOMdNBgQI0HdykUYjECWHCTjhYTEOgRQs3WOx4HdjH8uW6JBzMuNhgNGXTp1PbbEhh8OkNCPbMXliiCg4Ep8/ubujACewNEeBU4X2A6WwNURCQoEuEgcIyXrasWPFCjR+bc/Jw8dBQpURiggC2QDABAwYQDEcAD1dY5wWECvjzB2IzX6EaDPkFeEEFOfRHEA1ABBggBgsYKFB9JiiYHwYfLJRFAoO0IYcOFx2RoIQVUOjaDVQIMMCJHighxQkMQXEfiECQUVAWVkjww403SkBFFgzloMeACpqwBh3nCSSHjTjiKMEVDXkBRAoBmqBHGAWVUGKSOKIgA4sMqbHCexiksMUXCgEyggdY3uhBE0OsxhwZUHgRBh0LPTECCmn+sOYQDgqUgQB5omBFnwWcEMMAeS5JqEB4SIDnjShIYASPixYgx50CoDCCHE9UOhAgCcTwhhQWBQQAIfkEBQIAAAAsFQAXACYAJQAACP8ACwgcSLBgAzoNCipcyHBhEQMtzrSwEKKhxYs2AnRAI0JBhz87LooseOAMGh8oUYpAM2akSwMdUspU0CKhS4sN3JyUKbPIzYstFPBMKcLGz4Y5dw714fMowx0dkgxF46aO04UNSipFKbTiwhMnnIbQqKBjhwA2bA4soYFIly5ENJS4mZVAiwAtDKRRK3AOERIkEDgBTGTO0Rl07DTgK7BGBByQI0eocZVhHgQbIkfesKGKwgZlysy9OYGEZs0kHIwu4GfBixUrXiywM7LE39ORSVAWuOQFBhMpYJiA8OLA6oaOcUPWPfAIhArQoweiMdKBaeUkOAgMkyK69wswwIj1ZCAGAW4EcBgUaPABg3fvGKBUj2A+smDtAo+YeB8dCPWRHNwBGGBw4CcQDUDwBx0GbNRWAgMcTDABBy4UtECCCmKwQGUKBfFAd++ZsMISHCqkBnDemQADGYwNAQIeSlyhQ1gjNVAHGSuYgMFva4RR0AlvNDGAAAIM4AEeWdB1ABlQQEFGGQrpQAgKP1T5gwcSKFFiQYJkMICVYAoQw5YDDcGCB2BaOYASx1U2gw5oplmlAFSQKZCUcs5JxQx2AiIDlXIOgIedAl0hgZweoJAAoQU8kYEEgP4gAApXMCrQE1eMkOgPVLxhKUFS6JDAjJ/+SKNLAQEAIfkEBQIAAAAsFAAWACgAJgAACP8ACwgcSLAgwTJpDhhcyLBhQRtuzpgJ4GaMw4sOG4xJgkZEEhFoFBDASLJgETOIfKhc2QFLyZcEOqycKeKMnZckW4iYybNIA5wXWyjguTKJDaAX3aAh6iOJmTRIHe6QSRSNm6gO6bSguhJNAKhYGTZIszUkmg4tioS9SAeLmxZusND5GbVBGTprSZbxsmXFmiNk1jJhwjDHFggmYMAAAoSNEKBMOPSI0oWIhoJ0tmCowLlzICiPS7pAQsIJAgQkSNQgLHDB5s6dYTwI8rJHBBy4c0eYMPAIENiwTZCpQ1IDidzIN9xhUELIlhTAO0OAQvJEjePIc5PgIPDF7+gVMFD1J4nESXbtvBt8eB09RZiSPcyfx0GCgkAwMC5EB7LlJkkK2J1HwmUCfQABDLABoccXL+2BwwbnORHFHAR58QAGGJqwBYM4URABAsiZRiBBQagBBRRh4IWUA3eklloUeTTUAF1YMcDBBBRo4EIJJQA1QxYJyHFFHEM4xGOPUelghQADDCAAC3KckNdCN4wwwA9Y/uCBBG1MaZASV2aJpQcoJCCIlwJJ0YQHYmY5gBJoCqRDm2KiYEWcBcxJJ5YoUIEnICOgsOebUsbZhgR7ChADngVIQYUEbPIpAR5I4jkEHnwIIAAKI4BwJqMCnXBDHCq8IQVSAQEAIfkEBQIAAAAsEwAVACoAKAAACP8ACwgcSLCgQYF1Dtg5yLChw4EhCJwJcMaCjYcYH47h0UFBEhEdd9TJSJJgmgAKfKhUCXJMyZcGOqycqaBFg5ckW6ScObMITowNdPJcKSLEzZ8NG7hBM9RHEh5pkD6M2bSDG6kPy5xhStOMT5x0Fj4McaajCAUdzhgtaUfNizVrjpB5eMBAizMtdhx4ueQFBBMpUgDBQEOswxkFGhzNKOQIhAqQI0Ngg9UhGSCRM1/Qk6PywTpsMGTOjGGB54MvTIyOjIHy6YJHVK+uAOQDViZMDkIRPRuImp8lNPSIEgUJh9wCheTQA2N1ihV7X86pQYIEAgROSCBxQXB388gmLszxxVkjAo7z6CP0KLjgAYb3QNaE+blnwwb0+BHkKRhEzQcoZBxQwk8UkIAffiRQcMJrBFF3IHokEMEgQRMY+CAOEQ444QkaWPhgBA5MOJALcDjxIAJ3MKChiBw4gUB+JHCwIkY3qNBGGyoMgVhDGsBRXXVwcPASCCwMYOQATYDgUAkuaEDBBBpwV1IMKKDww5U/oDAACAs2VMKAX5b0hAwCYIklCizcIKJACVhpJpYDyLHmCSqU+eaVA+CxZgFx2HlnnnvqcCecSu6ZgQR3oqnmnjeMIIEHV3oggAcq7DnQDUqwUOUPRiRgaUE3vPGGDp4FBAAh+QQFAgAAACwRABQALAAqAAAI/wALCBxIsKBBgw3KFElj56DDhxAJhrAQgAePMzvoRNwYcUYIHh1E+EiioIObMhxTGixzRoGPlzA7WFBJUyCWDjBzJuFRpKZKAjhzwkSDxWdKC2iEDt1hlKOBoEoV2GiQ0k4dlSFEKkXTws/GMl5erFlD40sJjkD/5HQ5NWKOLRBMwEiBIQWUjQ3oWCiJBk2HMza+rsFQoXDhCxC8pLRBwI0bLCg3eoFguHKKFZHxUlX5wkRly2GaQixRZg2Mz4aBKBb9UMiaFKgLY1jA+uEJNoRjw/hS+2EYz6iBbOn9sAGbQBcqA3kAhvhDPx/0YJhuYgsYIc4h5vDyAUoYjdk5NvoY73zOnPARmXBAEiVKDw5M0Bt00SOCEwQInJDo4UL+wBJERIDDgARGUIN/AuVBAoEMbrDBHv6dMMGCDBJIggMI9kBhhTiQcKB/RGxYYQQTIMiBgBx2yAFHgCQAAggJZLEREwzcgQCHCMDRX0RvyIDCAAOgIMMbG5Vw4o0E3qfBRgkQIsAPUP4gAAoxRHQWB3CQoKUTUSy5ERUDRBklCk0MwZELGlBAgQbnRSSIDh6IKeYAIHBUwlk0qfCknFAOgMcM/sWxJ59+Iggnn33KIYh8gILJZ5w6IFiADiyEOeYAV0g6wxQ6UPHjAALIEIekA83whItyvAEIcQEBACH5BAUCAEAALBEAEwAuACwAAAj/AAsIHEiwoMGDA+2kOdAAocOHEAUCIXAmQIAWWOpE3BgxRIAOIpKIQNPBAh2OKA3SaYHGh0uXfzoQSElT4JgOL3Mm4ZGmJsoGBHDmfNlhTMQDOXKcpGmh5VCXaHY8BMBmhR49a6As3VjHgNCnaGw4BPMAA4wKFVJAeHGgBEcbCp76UHCGTsOCJQ6sMIG2bwUINFDWsfDVpQIRYhF6geC37wU9OVCWcdMBjQIFHQKMaXDX4Au+jdGaWJDSzxg3LdwYOABxS4rQaDF88FmAc8TPsCtg8EKbIxQMuVN86b0xh56zjdcS56jGBOgKFyCsiLwcYkMya2A410MDQHWUdsCo/yGTw/b38+jTq1/Pvr379/BrzpnjNj5BDT3gROnjgH58JjWQ4AQCCDgRQRcMxDdBBDg06GAEfTDxXhU4bODghSRo8J4DJFyIYQ3vTdChhw06gQREN6jAxRVvPEETBSOS6EQP9R10BR8D5IiCFQmgNEMeTpDYYAQUOCSHBB78oOQPArDQI0dzRBGkhwiIUcVBM9zAQpJLKikAFSdwxEQeG0zZYIEOOATCAF12icKTG5WQRxdOkGAnHBw8hAebbXoJAkpuuZCHAxRo4AJEbfDZpwB/0lRCjRCpoGibb74nxQgCLCrDFPDF4EGmSw7AB5zvJWDFp5lmoEMBM8A3wwxTJAcQRxyrrhcQACH5BAUCAAEALBAAEgAwAC4AAAj/AAsIHEiwoMGDB9OEKEIHocOHEAnacGMmiY8zBspE3MhxjI8Of3z4UNChxQGOKBEeOKNApMuPFh6WOJAjSJ2UBRtg6fDSpcUiCLXQWKHnwRY1QnAOtICmp0s0WA6S0QMBxoULJiCwuamUqVORUA3meJCigtmzEKAoLWCA51cFNgyygXC2booVGnGGEPEVTQuDftaUrXs2xZekOAmAfInGTAiDS1bAIHwWg5q1fgiI6ICmQ8nHBukIpmzWBJkGawuEIGDBwpiGCGlgIH1BD4DUA1FDDJPiAmWtXHFz/ABhcIULgbYsEY5zwYoUQEzoYbOcecqZYdSQuW09dQPd3cOL/x9Pvrz58+jTq1/Pvr379/DjCyzhwoV8JhyQwIGDxMEc9y70EIETCCDgRARIMMDeCTVEgMODEEbQA3t5ILABhBg6kYdDgCSgQhw3CEeBgxhGSAFCcYzggQAC/JDBDSesVQMJJUJIAhElFDRDHCig8MOPHkgwQog4lTABjTXicKNBQ4zg449QDmCEIEppgGSNEThQ0AkqDADllz94kECRLsDhRI0IwKFgQW14CeaPA4CwlgZOnAlhnRrESNAMbb75owByzhmFEySQ4EQUGuRoEAhuvinAG7jNkYcDDmjw30EnDNHEk1+iMAIguJUgakQzgCAApz+cqkJ7JagwggADDBAggBWQvidFHFdc8UYW6QUEACH5BAUCACwALA8AEQAyADEAAAj/AAsIHEiwoMGDCAfSSZOGTsKHECMWaHCAwBkzPM4QOPCwDIAgdSSKPHCmg4g/f0R0OFPkIAA2Kx482LIgpMiHbjr42MmzQ4sGBb88gADjwgUTEGg4vHkwBM+nO9GMIRhkhYkKWLMG+sD0IBadUKMSIAgFQtazMB4sAdp14A40YaNaILjl6tmsJsi0JTgGbtwOOxSuSXE3KwYvbPceCCAirAgzaegSLlwByIK9BHd0+PNUBJrABD+YLWwUDGaCBlQqQNPBDJbEAsEYLQzhyOmCIQi4cWMg8kEoQCZXuABhTY7bBhvAPqhmRQogQCrQAIAc84EwC9TkELK8uvfv4MOL/x9Pvrz58+jTq1/Pvr379/Djy59Pv7598C5cMJGvAQmcO11QwIB7J9RAghMIbOBEBFHsgdANKsihgg7gURABDhhmSEIXLhSURRt8CDCAAD8oMQRyJzAgxgYZthgBBwXhIYEHP9TogQRWSFHCbRyQ0GKLJBCxo0BvkFjjkT9IgMdtJzhw4Y8YOtEHQXgMgOSRHjSh42kO+AglDlISRIWRV9aYwG17sPglCROIiUKZNp55Wx9etsiigwNVCWeWJ6IpRp04IECCAwUl4AGNV0qQgXd79CHogXDAaBAXM2IpwQg3fMfEHg44oEGHCMnRhAAilnhDCSd8NyREJUgRAwgT0gZ3QqrsBQQAIfkEBQIABgAsDQAQADUAMgAACP8ACwgceCDIkoEIEypcyFBgGhs20jTUQmPFgwcvyDTcyLFACDdmFCgw46aIQjJ6MMC4cAGIiQ8dYyIMEaDDHx8+kqAxEwKhFj0pKggVegHDApkyWyjAydQHmjN2BtKAMLRqijV1kG5sEEJE06YdxggsswJG1bNahGhtuAPNV6YdCBRoAODBhbNDTWhcy3BHh7c44wo8UBav0BRh+DIcsxRwBywNCgg5AsQwjAcHFSssc6ZxUwUBDgwkQxUvBDaaF3fwylRBErECGwhhE8gsUQhbRKdOGBmLmQ5ogp+xodAPlAcmgADRwybz7oVpdhAgMKYMwwZLyCxQk+M5xwbgI3v/H0++vPnz6NOrX8++vfv38OPLn0+/vv37+PPr38+/v///AAYo4AkuuMDERoAkEEMCUqh3Agd9wHFHFxS4sBAII3ggAApNcJHFeXMQEYETG2zgRARdVJHQIBKg8MOLHkhgxIfl1RABDjjmSEIfBwqkgwcevCjkDxJwUd4eOGyQ45IkaCCQIG0MMKSQKIzQ4HgOkLAkkzUMZIQAUwrpgQ6CjDeBllvi6AQSA1EBZpg/eJAAeRSgmaYTPQyEh5RhesDHDeTl4USaOEZAgUAnvPHmlAMYQV4JTHQx6JYI3MEAQnhIEKSQAvCRwAzl5YGDnTg44QQHBZSAaBZt/DDAqwJQITHneXn0gQAJJDgRhZML6SBHG1y88YR6TOTBgQN5WDhQQAAh+QQFAgBjACwNABAANQAzAAAI/wDHCBQoREuYMAAGKlzIsKHDMQdCjCnSwOGXFxVSpHhAI8jDjyCLWAggkEcLGw0rALlQocIFDCtygJzpUIRAH2MUYFEI4AHDChBe0Bz6UASPIgIbQHHYEgzRpwwJCCzwwoRDDF4KQN2qoMWYAgW2pHAI5MNWrl6/HgFy1cvZrRa0NlgAoeGFC07fDk0iAqXAJSusMqRRUe9MER0MDAQb5gGGC2MuwPhreGaHADsYFtBC4wHLFVAOlKj80QKWA4UZClkCRgtq0iDBwp5Nu7bt27hz697Nu7fv38CDCx9OvLjx48iTK1/OvLnz59CjwwYr+2EBKTeGaMVdwIWGCRM4MMnYvjBBhhEsmhiJQX52AQ1RSMgnIcZB+zExfkjwwF+AAC73VabBBk4ohEAEFJB3QxMoLOTBACqcMJsLURS40AY4VDFaAVc8JMMTsJ2gwUcU0PTDV731INwEHyExkBIO/fCDDrNxQIJDJNQwlQoDNCSAFRKSVkAVYmzAEA5OjCjQFFSMceJAKEAYoF4TRICDQjhEoCJ5Q1AxgH8CSNAECLYxUYN8CCAwhpYuMJSFCkpQYQQXN+SmARFdRNEDB0w4NMMMv53ABHXUBQQAOw==" alt="Loading" /><br />'+"loading..."+"</div>";
var html='<base href="https://'+document.location.hostname+'" target="_blank">\n'+"<style>"+style_text+"</style>"+"\n"+style_html+"\n"+content_html;TS.dir(439,win,"_getSpinnerHtml html: "+html);return html};var _storeLastWindowSize=function(win){TS.dir(438,win,"_storeLastWindowSize token: "+win.token);TS.model.prefs.ssb_space_window=JSON.stringify({token:win.token,x:win.x,y:win.y,width:win.width,height:win.height});_storeLastWindowSizeByApiThrottled()};var _storeLastWindowSizeByApi=function(){TS.prefs.setPrefByAPI({name:"ssb_space_window",value:TS.model.prefs.ssb_space_window})};var _storeLastWindowSizeByApiThrottled=function(){_storeLastWindowSizeByApi()};var _fetchLastWindowSize=function(){return TS.utility.parseJSONOrElse(TS.model.prefs.ssb_space_window,null)};var _updateWin=function(win,callback){if(window.macgap){_updateWinForMacgapSSB(win,callback)}else{_updateWinForAtomSSB(win,callback)}};var _updateWinForAtomSSB=function(win,callback){var dims;try{dims=TSSSB.call("getGeometryForWindow",win.token)}catch(e){TS.warn('TSSSB method getGeometryForWindow threw error with token of "'+win.token+'"',e)}if(dims){win.x=dims.x;win.y=dims.y;win.height=dims.height;win.width=dims.width;setTimeout(callback,0)}};var _updateWinForMacgapSSB=function(win,callback){if(win.window){win.x=win.window.screenX+22;win.y=win.window.screenY-23+22;win.width=win.window.innerWidth;win.height=win.window.innerHeight}if(win.document){win.title=win.document.title}callback()};var _storeWins=function(last_window_size_token){var LS_wins={};if(!Object.keys(_wins).length){TS.storage.storeClientWindows(LS_wins);return}var win;for(var token in _wins){win=_wins[token];if(!win.worth_saving)continue;_updateWin(win,function(token){return function(){var win=_wins[token];if(!win)return;LS_wins[token]={token:token,x:win.x,y:win.y,width:win.width,height:win.height,file_id:win.file_id,title:win.title,destination_url:win.destination_url,url:win.url,no_spinner:win.no_spinner,worth_saving:win.worth_saving};TS.dir(438,LS_wins[token],"_storeWins LS_win token: "+token);TS.storage.storeClientWindows(LS_wins);if(token==last_window_size_token){_storeLastWindowSize(LS_wins[token])}}}(token))}if(!Object.keys(LS_wins).length){TS.storage.storeClientWindows("");return}}})();(function(){"use strict";TS.registerModule("client.ui",{test:function(){return{}},CLIENT_HEADER_OVERHANG:8,$msgs_scroller_div:$("#msgs_scroller_div"),$msgs_div:$("#msgs_div"),$msg_input:TS.boot_data.feature_new_msg_input?$("#msg_input"):$("#message-input"),$msg_preview_msg:$("#msg_preview_msg"),$msg_preview:$("#msg_preview"),$messages_input_container:TS.boot_data.feature_new_msg_input?null:$("#messages-input-container"),$emo_menu:null,$banner:$("#banner"),$msgs_unread_divider:null,file_dropped_sig:new signals.Signal,file_pasted_sig:new signals.Signal,onStart:function(){TS.channels.data_updated_sig.add(_channelDataUpdated);TS.ui.window_focus_changed_sig.add(TS.client.ui.windowFocusChanged);TS.channels.switched_sig.add(TS.client.ui.channelOrImOrGroupDisplaySwitched);TS.ims.switched_sig.add(TS.client.ui.channelOrImOrGroupDisplaySwitched);TS.groups.switched_sig.add(TS.client.ui.channelOrImOrGroupDisplaySwitched);TS.mpims.switched_sig.add(TS.client.ui.channelOrImOrGroupDisplaySwitched);TS.prefs.color_names_in_list_changed_sig.add(TS.client.ui.prefColorNamesInListChanged);TS.prefs.msg_preview_changed_sig.add(TS.client.ui.prefMsgPreviewChanged);TS.prefs.sidebar_behavior_changed_sig.add(TS.client.ui.checkUnseenChannelsImsGroupsWithUnreads);TS.rooms.added_sig.add(_roomAdded);TS.rooms.changed_name_sig.add(_roomNameChanged);TS.rooms.changed_participants_sig.add(_roomParticipantsChanged);TS.rooms.changed_date_end_sig.add(_roomEndedChanged);TS.rooms.changed_channels_sig.add(_roomChannelsChanged);if(TS.boot_data.feature_hide_email_pref)TS.prefs.team_display_email_addresses_changed_sig.add(_onDisplayEmailAddressesPrefChanged);if(TS.boot_data.feature_electron_memory_logging)TS.prefs.show_memory_instrument_changed_sig.add(_onMemoryInstrumentPrefChanged);if(boot_data.feature_calls){TS.prefs.team_allow_calls_changed_sig.add(_maybeUpdateCallAction)}TS.client.ui.$msgs_scroller_div.bind("mousedown mouseup",function(e){TS.client.msg_pane.checkUnreads()});var $mouse_down_el=null;$("html").bind("mousedown",function(e){TS.model.ui.is_mouse_down=true;TS.client.ui.maybeTickleMS();$mouse_down_el=$(e.target)});$("html").bind("dragend",function(e){TS.model.ui.is_mouse_down=false});$("html").bind("mouseup",function(e){TS.model.ui.is_mouse_down=false;setTimeout(function(){if($mouse_down_el&&$mouse_down_el.closest(".monkey_scroll_handle").length){if(TS.model.archive_view_is_showing){TS.client.archives.maybeLoadScrollBackHistory()}else{if(!TS.model.showing_welcome_2)TS.client.ui.maybeLoadScrollBackHistory()}}$mouse_down_el=null},10)});TS.client.ui.$msgs_scroller_div.scroll(TS.client.ui.onMsgsScroll);TS.client.channel_pane.$scroller.scroll(TS.client.ui.onChannelsScroll);TS.client.login_sig.add(TS.client.ui.loggedIn,TS.ui);TS.client.msg_input.bind(TS.client.ui.$msg_input);TSSSB.call("inputFieldCreated",TS.client.ui.$msg_input.get(0));function _bindUI(){TS.client.ui.enhanceComponents();TS.client.ui.bindCommentInput();$(window.document).keydown(TS.client.ui.onWindowKeyDown).keyup(TS.client.ui.onWindowKeyUp);$("#team_menu .notifications_menu_btn").bind("click",function(e){if(TS.client.ui.shouldIgnoreClick(e))return false;TS.menu.startWithNotificationsMenu(e)});$("#team_menu").bind("click",function(e){if(TS.client.ui.shouldIgnoreClick(e))return false;if($(e.target).closest(".notifications_menu_btn").length)return false;TS.menu.startWithTeamAndUser(e)});$("#file_preview_container").on("textchange","#file_comment",function(e){TS.client.ui.files.storeLastCommentInputForPreviewedFile($(this).val());TS.ui.utility.updateClosestMonkeyScroller($("#file_preview_scroller"))});$("#file_comment").css("overflow","hidden").autogrow();$("#file_comment_form").bind("submit",function(e){TS.client.ui.files.submitFileComment();return false});$(window).on("click",_updateUserActive);if(!TS.qs_args["ignore_mm"]){$("#header, #footer, #col_channels, #client_body, #col_flex").on("mouseenter",_updateUserActive)}var is_touch="ontouchstart"in document.documentElement;if(is_touch){$("html").addClass("touch")}else{$("html").addClass("no_touch")}TS.client.archives.$scroller.scroll(function(){TS.model.ui.cached_archive_scroll_result=null});TS.client.ui.$msgs_scroller_div.scroll(function(){TS.model.ui.cached_msgs_scroll_result=null});$(window).on("copy cut",function(e){if(TS.utility.isFocusOnInput()){if(!TS.boot_data.feature_texty)return;var input=document.activeElement;if(!TS.utility.contenteditable.isContenteditable(input))return}try{var selection=window.getSelection();var selection_html;var selection_text=TS.format.formatSelection(selection,{customFn:function(node){if(node.hasAttribute("data-member-name")){return"@"+node.getAttribute("data-member-name")}}});if(TS.boot_data.feature_texty){selection_html=TS.format.formatSelectionAsHTML(selection)}if(selection_text){var mime_types={"text/plain":selection_text,text:selection_text,"public.utf8-plain-text":selection_text,Text:selection_text};if(TS.boot_data.feature_texty&&selection_html){mime_types["text/html"]=selection_html}TS.clipboard.writeTextFromEvent(e,mime_types)}}catch(err){TS.error("window copy handler error: "+err)}})}TS.log(82,"deferring UI bind until login_sig");TS.client.login_sig.add(function(){TS.utility.queueRAF(_bindUI)})},spaces_tooltip:{state:"hide",pending_change:null},loggedIn:function(){if(TS.isPartiallyBooted()&&!TS.model.ms_connected){TS.ms.connected_sig.addOnce(function(){TS.client.ui.loggedIn()});if(TS.model.ui_state.flex_name){TS.client.ui.flex.showFlex()}$("#main_emo_menu").removeClass("hidden").bind("click.incremental_boot",function(e){e.preventDefault();TS.incremental_boot.userDidInteractWithUI()});return}TS.client.ui.flex.setFlexStateFromHistory(TS.model.ui_state.flex_name,TS.model.ui_state.flex_extra,true);if(TS.model.ui_state.flex_name){TS.client.flexDisplaySwitched(TS.model.ui_state.flex_name,TS.model.ui_state.flex_extra,true);TS.client.ui.flex.showFlex()}$("#main_emo_menu").removeClass("hidden").off("click.incremental_boot").bind("click.open_dialog",function(e){TS.menu.emoji.start({e:e,input_to_fill:TS.client.ui.$msg_input})});if(window.extraCmds)window.extraCmds();TS.shared.checkDisplayEmailAddressPref();if(TS.boot_data.feature_electron_memory_logging&&TS.model.prefs.show_memory_instrument&&TS.model.is_electron){_setMemoryInstrumentInterval()}},rebuildAllButMsgs:function(){TS.client.channel_pane.rebuild("channels","ims","starred");TS.client.msg_pane.rebuildChannelMembersList();TS.client.msg_pane.displayTitle();TS.client.channel_pane.makeSureActiveChannelIsInView();if(TS.boot_data.feature_unread_view&&TS.client.unread.isEnabled()){TS.client.ui.unread.updateSidebarLink()}if(TS.boot_data.feature_message_replies_threads_view){TS.client.ui.threads.updateChannelPaneActiveState()}},rebuildAll:function(){TS.client.ui.rebuildAllButMsgs();TS.client.msg_pane.rebuildMsgsWithReason("rebuildAll")},windowFocusChanged:function(has_focus){if(has_focus){TS.client.ui.startUnreadCheckingTimer();TS.client.ui.maybeTickleMS();if(TS.view)TS.view.updateTitleBarColor();TS.model.ui.is_mouse_down=false}else{clearTimeout(TS.client.ui.unread_checking_tim)}},cal_key_checker:{tim:null,tim_ms:200,prevent_enter:false,space_pressed_last:false,reset:function(){clearTimeout(TS.client.ui.cal_key_checker.tim);TS.client.ui.cal_key_checker.space_pressed_last=false;TS.client.ui.cal_key_checker.prevent_enter=false},check:function(key_code){if(TS.client.ui.cal_key_checker.space_pressed_last&&key_code!=32){TS.client.ui.cal_key_checker.reset();if(key_code==73){TS.client.ui.cal_key_checker.prevent_enter=true;TS.client.ui.cal_key_checker.tim=setTimeout(TS.client.ui.cal_key_checker.reset,TS.client.ui.cal_key_checker.tim_ms)}}else if(key_code==32){TS.client.ui.cal_key_checker.reset();TS.client.ui.cal_key_checker.space_pressed_last=true;TS.client.ui.cal_key_checker.tim=setTimeout(TS.client.ui.cal_key_checker.reset,TS.client.ui.cal_key_checker.tim_ms)}else{TS.client.ui.cal_key_checker.reset()}}},keyPressIsValidForFocusOnNextOrPreviousMessage:function(e){if(!e)return false;var keymap=TS.utility.keymap;var uses_correct_key=[keymap.left_square_bracket,keymap.right_square_bracket,keymap.minus_sign,keymap.equals_sign].indexOf(e.which)!==-1;var uses_correct_modifiers=e.altKey&&TS.utility.cmdKey(e);return uses_correct_key&&uses_correct_modifiers&&TS.client.ui.isUserAttentionOnChat()&&!TS.client.activeChannelIsHidden()},keyPressIsValidForGotoNextOpenChannelOrIM:function(e){var keymap=TS.utility.keymap;if(!e)return false;if(!e.altKey)return false;if(e.which!=keymap.up&&e.which!=keymap.down)return false;if(!TS.client.ui.isUserAttentionOnChat())return false;if(TS.utility.isFocusOnInput()){var $input=$(document.activeElement);var val=$input.val()||"";var p=$input.getCursorPosition();if(val){var selection=window.getSelection&&window.getSelection().toString();if(selection){return false}if(e.which==keymap.up&&p!==0){return false}if(e.which==keymap.down&&p!=val.length){return false}}}return true},page_scroll_dest:null,onWindowKeyDown:function(e){if(TS.isPartiallyBooted()){if(TS.utility.cmdKey(e)){e.preventDefault();e.stopPropagation()}return}var start=Date.now();var keymap=TS.utility.keymap;TS.model.last_key_down_e=e;TS.client.ui.cal_key_checker.check(e.which);var kt=TS.key_triggers[e.which.toString()];if(TS.client.ui.isUserAttentionOnChat()&&kt&&(!kt.isDisabled||!kt.isDisabled(e))&&(e.metaKey&&(!e.ctrlKey||!TS.model.is_mac)||e.ctrlKey&&!e.altKey&&!TS.model.is_mac)&&(!kt.no_shift&&(e.shiftKey||kt.shift_optional)||kt.no_shift&&!e.shiftKey)){e.preventDefault();e.stopPropagation();if(TS.model.ms_logged_in_once&&TS.model.prefs&&!$("body").hasClass("loading")){kt.func(e)}}else if(TS.boot_data.feature_a11y_keyboard_shortcuts&&TS.client.ui.keyPressIsValidForFocusOnNextOrPreviousMessage(e)){e.preventDefault();e.stopPropagation();switch(e.which){case keymap.left_square_bracket:TS.ui.a11y.focusOnPreviousMessage();break;case keymap.right_square_bracket:TS.ui.a11y.focusOnNextMessage();break;case keymap.minus_sign:TS.ui.a11y.focusOnOldestUnreadMessage();break;case keymap.equals_sign:TS.ui.a11y.focusOnMessageInput()}}else if(TS.client.ui.isUserAttentionOnChat()&&!TS.client.activeChannelIsHidden()&&!TS.utility.isFocusOnInput()&&TS.utility.cmdKey(e)&&!e.altKey&&e.which==keymap.up){TS.client.ui.maybeEditLast(e)}else if(TS.client.ui.isUserAttentionOnChat()&&(e.which==keymap.left_square_bracket||e.which==keymap.right_square_bracket||e.which==keymap.left||e.which==keymap.right)){if(TS.client.activeChannelIsHidden()&&(e.which==keymap.left||e.which==keymap.right)&&(TS.model.is_mac&&e.metaKey||!TS.model.mac&&e.ctrlKey)){e.preventDefault();e.stopPropagation()}_handleHistoryNavigationOnDesktop(e)}else if(TS.client.ui.keyPressIsValidForGotoNextOpenChannelOrIM(e)){var went=false;if(e.which==keymap.up){went=TS.client.ui.gotoNextOpenChannelOrIM(e.shiftKey,true)}else if(e.which==keymap.down){went=TS.client.ui.gotoNextOpenChannelOrIM(e.shiftKey,false)}if(went){TS.utility.queueRAF(function checkInputBlurRAF(){if(TS.utility.contenteditable.isActiveElement(TS.client.ui.$msg_input)){TS.client.ui.$msg_input.blur()}})}e.preventDefault()}else if((TS.client.ui.isUserAttentionOnChat()||TS.ui.shortcuts_dialog.showing)&&e.which==191&&!e.altKey&&!e.shiftKey&&TS.utility.cmdKey(e)){if(TS.ui.shortcuts_dialog.showing){TS.ui.shortcuts_dialog.cancel()}else{TS.ui.shortcuts_dialog.start()}e.preventDefault()}else if(TS.client.ui.isUserAttentionOnChat()&&e.which==190&&!e.altKey&&TS.utility.cmdKey(e)){if(TS.boot_data.feature_clog_whats_new&&TS.model.ui_state.flex_name=="whats_new"){TS.clog.track("WHATSNEW_ACTION",{action:"close_pane",trigger:"keyboard_cmd_dot"})}TS.client.ui.flex.toggleFlex();e.preventDefault()}else if(TS.client.ui.isUserAttentionOnChat()&&TS.utility.cmdKey(e)&&e.shiftKey&&(e.which==75||e.which==84&&TS.model.is_our_app)){if(TS.ui.fs_modal.is_showing){TS.ui.fs_modal.close()}else{TS.ui.im_browser.start();e.preventDefault()}}else{if(e.which==keymap.shift||e.which==keymap.space){if(TS.model.prefs&&TS.model.prefs.pagekeys_handled){if(TS.utility.isFocusOnInput()){if(e.which==keymap.space&&e.shiftKey&&!TS.utility.contenteditable.value(TS.client.ui.$msg_input)&&TS.utility.contenteditable.isActiveElement(TS.client.ui.$msg_input)){TS.client.ui.$msg_input.blur();e.preventDefault()}}else{if(TS.model.is_FF)TS.client.ui.$msgs_scroller_div.focus()}}}else if(e.which==keymap.esc){TS.client.ui.onEscKey(e)}else if(TS.utility.isPageKey(e.which)&&TS.model.prefs&&TS.model.prefs.pagekeys_handled&&!e.shiftKey&&!e.ctrlKey&&!e.altKey&&!e.metaKey){var msg_input_focused=TS.client.ui.$msg_input.is(document.activeElement);var other_input_focused=!msg_input_focused&&TS.utility.isFocusOnInput();var in_archives=TS.model.archive_view_is_showing;var $scroller=in_archives?TS.client.archives.$scroller:TS.client.ui.$msgs_scroller_div;var st=$scroller[0].scrollTop;var sh=$scroller[0].scrollHeight;var h=$scroller.height();start=st;if(TS.client.ui.page_scroll_dest!==null){start=TS.client.ui.page_scroll_dest}var scroll_msgs=true;var $ae=$(document.activeElement);var dont_scroll_if_text_in_input=false;if(e.which==keymap.pageup){if(other_input_focused){scroll_msgs=false}else if(dont_scroll_if_text_in_input&&msg_input_focused&&$ae.val()){scroll_msgs=false}else{TS.client.ui.page_scroll_dest=start-h}}else if(e.which==keymap.pagedown){if(other_input_focused){scroll_msgs=false}else if(dont_scroll_if_text_in_input&&msg_input_focused&&$ae.val()){scroll_msgs=false}else{TS.client.ui.page_scroll_dest=start+h}}else if(e.which==keymap.home){if(other_input_focused||msg_input_focused&&$ae.val()){if(TS.model.is_mac){if(e.shiftKey){}else{$ae.setCursorPosition(0);e.preventDefault()}}scroll_msgs=false}else{TS.client.ui.page_scroll_dest=0}}else if(e.which==keymap.end){if(other_input_focused||msg_input_focused&&$ae.val()){if(TS.model.is_mac){if(e.shiftKey){}else{$ae.setCursorPosition(1e6);e.preventDefault()}}scroll_msgs=false}else{TS.client.ui.page_scroll_dest=sh}}if(scroll_msgs){TS.client.ui.slowScrollMsgsToPosition(TS.client.ui.page_scroll_dest,true,function(){TS.client.ui.page_scroll_dest=null});e.preventDefault()}}else if(!TS.utility.isFocusOnInput()&&TS.client.ui.isUserAttentionOnChat()&&!TS.client.activeChannelIsHidden()&&!TS.utility.isArrowKey(e.which)&&!TS.utility.isPageKey(e.which)&&!e.metaKey&&!e.ctrlKey&&!e.altKey&&!TS.menu.emoji.is_showing){if(!TS.boot_data.feature_a11y_tab){TS.view.focusMessageInput();if(e.which==keymap.tab&&!TS.utility.cmdKey(e)){e.preventDefault()}}if(e.which==keymap.enter){e.preventDefault();if(TS.model.archive_view_is_showing){TS.client.archives.tryToJoin()}}}else if((window.macgap||window.winssb)&&!TS.utility.isFocusOnInput()&&TS.client.ui.isUserAttentionOnChat()&&!TS.client.activeChannelIsHidden()&&e.which==keymap.V&&!e.altKey&&TS.utility.cmdKey(e)){var paste_txt;var paste_img;var ssb_api=window.macgap||window.winssb;if(ssb_api.clipboard&&ssb_api.clipboard.readString&&ssb_api.clipboard.readImage){paste_txt=ssb_api.clipboard.readString();if(paste_txt){TS.client.msg_input.populate(TS.utility.contenteditable.value(TS.client.ui.$msg_input)+paste_txt);e.preventDefault()}else{paste_img=ssb_api.clipboard.readImage();if(paste_img){TS.ui.paste.startUploadFromMacSSBReadImage(paste_img,e.shiftKey);e.preventDefault()}}}TS.view.focusMessageInput()}else if(TS.model.archive_view_is_showing&&e.which==keymap.enter&&!e.metaKey&&!e.ctrlKey&&!e.altKey){}}if(TS.model.profiling_keys)TS.model.addProfilingKeyTime("onWindowKeyDown",Date.now()-start);if(e.which==keymap.shift||e.shiftKey){TS.model.shift_key_pressed=true}if(e.which==keymap.insert){TS.model.insert_key_pressed=true}if(e.which==keymap.alt||e.altKey){TS.model.alt_key_pressed=true}if(e.shiftKey&&e.metaKey&&e.which!=keymap.V){TS.model.shift_key_pressed=false}},onWindowKeyUp:function(e){TS.model.last_key_down_e=null;var keymap=TS.utility.keymap;if(e.which==keymap.shift){TS.model.shift_key_pressed=false}if(e.which==keymap.insert){TS.model.insert_key_pressed=false}if(e.which==keymap.alt){TS.model.alt_key_pressed=false;if(!TS.utility.isFocusOnInput()&&!TS.selection.isAnyTextSelected()){TS.view.focusMessageInput()}}},onEscKey:function(e){try{e.stopPropagation()}catch(err){}try{e.preventDefault()}catch(err){}if(!TS.client.ui.isUserAttentionOnChat()){return}if(TS.model.unread_view_is_showing){return}if(TS.model.archive_view_is_showing){TS.client.archives.userWantsToCancel();return}if(TS.msg_edit.editing){return}if(TS.menu.emoji.is_showing){return}var all_channels=e.shiftKey;if(all_channels){var clearAll=function(){TS.client.ui.forceMarkAllRead(TS.model.marked_reasons.esc_all,all_channels);var channels=TS.model.channels;var groups=TS.model.groups;var i;var include_users_counts_latest=true;for(i=channels.length-1;i>-1;i--){channels[i]._show_in_list_even_though_no_unreads=false;TS.channels.markMostRecentReadMsg(channels[i],TS.model.marked_reasons.muted,include_users_counts_latest);TS.channels.unread_changed_sig.dispatch(channels[i],true)}for(i=groups.length-1;i>-1;i--){groups[i]._show_in_list_even_though_no_unreads=false;TS.groups.markMostRecentReadMsg(groups[i],TS.model.marked_reasons.muted,include_users_counts_latest);TS.groups.unread_changed_sig.dispatch(groups[i],true)}if(TS.boot_data.feature_message_replies){TS.replies.markAllThreads()}};if(TS.model.prefs.confirm_clear_all_unreads===false||TS.model.all_unread_cnt===0){clearAll()}else{var cb_html='<p class="no_bottom_margin float_right"><label class="checkbox overlay_pref block"><input id="confirm_clear_all_unreads_cb" type="checkbox" /> Don\'t ask me again, please</label><p>';TS.generic_dialog.start({title:"Clear all unreads?",body:"<p><b>Shift+esc</b> will clear all unread messages and notifications. Are you sure you want to do this? It's liberating … but there's no going back.</p>"+cb_html,show_cancel_button:true,show_go_button:true,go_button_text:"Yes, clear all!",onGo:function(){clearAll();var no_more=!!$("#confirm_clear_all_unreads_cb").prop("checked");if(no_more){TS.prefs.setPrefByAPI({name:"confirm_clear_all_unreads",value:false})}}})}}else if(!TS.client.activeChannelIsHidden()){TS.client.ui.forceMarkAllRead(TS.model.marked_reasons.esc,all_channels)}else if(TS.boot_data.feature_message_replies_threads_view&&TS.model.threads_view_is_showing){TS.client.threads.markAllNewThreads()}},checkForEditing:function(e){if(!TS.msg_edit.editing)return false;if(!e||!e.target||$(e.target).closest("#message_edit_form").length===0){if(!TS.msg_edit.editing_in_msg_pane)return false;if(TS.msg_edit.cancelEditingINothingHasChanged()){return false}TS.sounds.play("beep");TS.msg_edit.promptEdit()}return true},maybeTickleMS:function(){if(!TS.model.user)return;if(!TS.model.ms_connected)return;if(TS.model.user.manual_presence=="away")return;var elsapsed=Date.now()-TS.model.last_net_send;var limit=1e3*20;if(elsapsed<limit&&TS.model.user.presence=="active"){return}TS.client.ui.tickleMS()},tickleMS:function(){TS.ms.sendTickle()},forceMarkAllRead:function(reason,all_channels){TS.client.msg_pane.dont_check_unreads_til_switch=false;TS.client.ui.markMostRecentReadMsgInActive(reason,true);if(all_channels){var channels=TS.model.channels;var ims=TS.model.ims;var groups=TS.model.groups;var mpims=TS.model.mpims;var i;var include_users_counts_latest=true;for(i=channels.length-1;i>-1;i--){if(channels[i].unread_cnt)TS.channels.markMostRecentReadMsg(channels[i],reason,include_users_counts_latest)}for(i=ims.length-1;i>-1;i--){if(ims[i].unread_cnt)TS.ims.markMostRecentReadMsg(ims[i],reason,include_users_counts_latest)}for(i=groups.length-1;i>-1;i--){if(groups[i].unread_cnt)TS.groups.markMostRecentReadMsg(groups[i],reason,include_users_counts_latest)}for(i=mpims.length-1;i>-1;i--){if(mpims[i].unread_cnt)TS.mpims.markMostRecentReadMsg(mpims[i],reason,include_users_counts_latest)}}TS.client.markLastReadsWithAPI()},maybePromptForSetActive:function(){var user=TS.model.user;if(user.manual_presence!="away")return;if(TS.model.ui.is_window_focused){TS.client.ui.promptForSetActive()}else{TS.ui.window_focus_changed_sig.addOnce(TS.client.ui.promptForSetActive)}},promptForSetActive:function(){if(TS.model.prefs.confirm_user_marked_away){var user=TS.model.user;var cb_html='<p class="no_bottom_margin float_right"><label class="checkbox overlay_pref block"><input id="confirm_user_marked_away" type="checkbox" /> Don\'t ask me again, please</label><p>';setTimeout(function(){if(user.manual_presence!="away")return;TS.generic_dialog.start({unique:"set_active_prompt",title:'You are marked as "away"',body:"<p>Would you like to switch to appear active?</p>"+cb_html,show_cancel_button:true,show_go_button:true,go_button_text:"Yes, set me to active",go_button_class:"btn_success",cancel_button_text:"No, still away",onGo:function(){if(user.manual_presence=="away")TS.members.toggleUserPresence();var no_more=!!$("#confirm_user_marked_away").prop("checked");if(no_more){TS.prefs.setPrefByAPI({name:"confirm_user_marked_away",value:false})}},onCancel:function(){var no_more=!!$("#confirm_user_marked_away").prop("checked");if(no_more){TS.prefs.setPrefByAPI({name:"confirm_user_marked_away",value:false})}}})},2e3)}},enhanceComponents:function(){$("#flexpane_tabs li a").on("shown",function(e){TS.view.resizeManually("TS.client.ui.enhanceComponents")})},shouldEventTriggerMaybeEditLast:function(e,$input){var value=TS.utility.contenteditable.value($input);return!value&&(TS.utility.cmdKey(e)||TS.model.prefs&&!TS.model.prefs.arrow_history)&&!e.altKey&&e.which==TS.utility.keymap.up},maybeEditLast:function(e){e.preventDefault();e.stopPropagation();var model_ob=TS.shared.getActiveModelOb();var msg,msgs;if(model_ob){msgs=model_ob.msgs;if(TS.boot_data.feature_message_replies){msgs=TS.utility.msgs.getDisplayedMsgs(msgs)}msg=TS.utility.msgs.getEditableMsgByProp("user",TS.model.user.id,msgs);if(msg){TS.msg_edit.startEdit(msg.ts,TS.shared.getActiveModelOb());return true}}TS.sounds.play("beep");return false},bindCommentInput:function(){$("#file_comment").bind("focus",function(){var parent_scroller=$(this).closest(".flex_content_scroller");var scroll_height=parent_scroller[0]&&parent_scroller[0].scrollHeight;parent_scroller.scrollTop(scroll_height)})},showRepliesFromHistory:function(flex_extra){var replace_history_state=false;var no_history_add=true;TS.client.flexDisplaySwitched("convo",flex_extra,replace_history_state,no_history_add)},showSearchFromHistory:function(qry){if(!qry){TS.client.ui.flex.openFlexTab("mentions");return}qry=TS.search.truncateQuery(qry);qry=qry.replace(/%23/g,"#");$("#search_terms").val(qry).data("textchange_lastvalue",qry);$("#header_search_form").submit();TS.client.flexDisplaySwitched("search",qry,false,true)},showTeamFromHistory:function(member_id){if(!member_id){TS.client.ui._displayTeamList();TS.client.flexDisplaySwitched("team",null,false,true);return}var member=TS.members.getMemberByName(member_id);var user_group=TS.user_groups.getUserGroupsById(member_id);if(member){TS.client.ui._displayMember(member.id).then(function(){TS.client.flexDisplaySwitched("team",member.name,false,true)},_.noop)}else if(user_group){TS.client.ui._displayUserGroup(user_group.id);TS.client.flexDisplaySwitched("team",user_group.id,false,true)}else{TS.client.ui._displayTeamList();TS.client.flexDisplaySwitched("team",null,true)}},showView:function(view_id){switch(view_id){case"Vall_unreads":TS.client.unread.showUnreadView(false,true);break;default:TS.warn('Unknown view "'+view_id+'" passed to TS.client.ui.showView()');break}},onSubmit:function(txt,e){try{var trimmed=$.trim(txt);if(!trimmed)return;var cmd_ok_for_archived=trimmed=="/unarchive"||trimmed=="/leave"||trimmed=="/part"||trimmed=="/close";var model_ob=TS.shared.getActiveModelOb();if(!cmd_ok_for_archived&&model_ob&&model_ob.is_archived){TS.generic_dialog.alert("This channel has been archived; you cannot send messages to it.");TS.client.msg_input.populate(trimmed);return}TS.view.clearMessageInput();if(txt.substr(0,1)=="/"&&txt.substr(0,2)!="//"){TS.client.ui.sendSlashCommand(model_ob,txt,e)}else{TS.client.ui.sendMessage(model_ob,txt)}}catch(err){TS.error(err)}},sendSlashCommand:function(model_ob,txt,e,in_reply_to_msg){TS.chat_history.add(txt);var args=TS.cmd_handlers.parseArgs(txt);var edit_last_shortcut;if(TS.cmd_handlers[args.cmd]&&TS.cmd_handlers[args.cmd].type=="client"){setTimeout(function(){TS.cmd_handlers.runCommand(args.cmd,args.rest,args.words,e,in_reply_to_msg,model_ob)},10)}else if(edit_last_shortcut=TS.utility.msgs.getEditLastShortcutCmd(txt)){TS.utility.msgs.removeAllEphemeralMsgsByType("temp_slash_cmd_feedback",model_ob.id);TS.utility.msgs.tryToEditLastMsgFromShortcut(edit_last_shortcut)}else{if(args.cmd=="/me"&&TS.model.prefs.convert_emoticons&&TS.model.prefs.emoji_mode!="as_text"){args.rest=TS.format.doEmoticonConversion(args.rest)}TS.api.call("chat.command",{command:args.cmd,text:TS.format.cleanCommandText(args.rest),channel:model_ob.id,disp:args.disp},function(ok,data,api_args){TS.client.ui.onAPICommand(ok,data,api_args,args.rest)})}_afterSendMsg(model_ob)},sendMessage:function(model_ob,txt,in_reply_to_msg,should_broadcast_reply){TS.chat_history.add(txt);if(model_ob.is_channel){TS.channels.sendMsg(model_ob.id,txt,in_reply_to_msg,should_broadcast_reply)}else if(model_ob.is_mpim){TS.mpims.sendMsg(model_ob.id,txt,in_reply_to_msg,should_broadcast_reply)}else if(model_ob.is_group){TS.groups.sendMsg(model_ob.id,txt,in_reply_to_msg,should_broadcast_reply)}else if(model_ob.is_im){TS.ims.sendMsg(model_ob.id,txt,in_reply_to_msg,should_broadcast_reply)}else{return}if(model_ob.id===TS.model.active_cid){TS.utility.msgs.removeAllEphemeralMsgsByType("temp_slash_cmd_feedback",TS.model.active_cid)}_afterSendMsg(model_ob)},prefMsgPreviewChanged:function(){if(!TS.model.prefs.msg_preview&&TS.model.msg_preview_showing){TS.client.ui.$msg_preview.addClass("hidden");TS.model.msg_preview_showing=false}else if(TS.model.prefs.msg_preview&&!TS.model.msg_preview_showing){TS.client.ui.$msg_input.trigger("textchange")}if(TS.model.prefs.msg_preview&&!TS.model.prefs.msg_preview_persistent&&TS.model.msg_preview_showing){TS.client.ui.$msg_input.trigger("textchange")}TS.view.measureInput();TS.view.resizeManually()},prefColorNamesInListChanged:function(){if(TS.model.prefs.color_names_in_list){$(".nuc").removeClass("nuc").addClass("user_colored")}else{$(".user_colored").removeClass("user_colored").addClass("nuc")}},onAPICommand:function(ok,data,args,display_text){var active_cid=TS.model.active_cid;if(!ok){if(!TS.utility.contenteditable.value(TS.client.ui.$msg_input)){TS.utility.populateInput(TS.client.ui.$msg_input,args.disp+" "+display_text)}var err_txt;var cmd_txt="*"+TS.utility.htmlEntities(args.disp)+(display_text?" "+TS.utility.htmlEntities(display_text):"")+"*";if(data.error&&data.error=="restricted_action"){err_txt=""+cmd_txt+" failed because you are not allowed to perform that action. Talk to your Team Owner."}else if(data.error&&(data.error!="Unknown command"&&data.error!="unknown_command")){err_txt=""+cmd_txt+' failed with the error "'+data.error+'".'}else if(data.error){err_txt=""+cmd_txt+" is not a valid command. "+'In Slack, all messages that start with the "/" character are interpreted as commands.\n\n'+'If you are trying to send a message and not run a command, try preceding the "/" with an empty space.'}else{err_txt=""+cmd_txt+" failed with an unknown error."}var ephemeral_msg={text:err_txt,ephemeral_type:"temp_slash_cmd_feedback",channel:active_cid,slackbot_feels:"sad_surprise"};TS.client.ui.addOrFlashEphemeralBotMsg(ephemeral_msg)}if(data.response){if(data.open_url){var target="_"+Math.random();TS.info("gonna try to launch a new tab/window with target: "+target+" url: "+data.open_url);TS.utility.openInNewTab(data.open_url,target)}if(data.keep_input){if(!TS.utility.contenteditable.value(TS.client.ui.$msg_input)){TS.utility.populateInput(TS.client.ui.$msg_input,args.command+" "+display_text)}}var c_id=active_cid;if(args.channel&&args.channel!=c_id){if(TS.channels.getChannelById(args.channel)){c_id=args.channel}else if(TS.ims.getImById(args.channel)){c_id=args.channel}else if(TS.groups.getGroupById(args.channel)){c_id=args.channel}}if(data.is_temp){TS.client.ui.addOrFlashEphemeralBotMsg({text:data.response,ephemeral_type:"temp_slash_cmd_feedback",channel:c_id})}else{TS.utility.msgs.removeAllEphemeralMsgsByType("temp_slash_cmd_feedback",TS.model.active_cid);TS.client.ui.addEphemeralBotMsg({text:data.response,channel:c_id})}}else if(ok){TS.utility.msgs.removeAllEphemeralMsgsByType("temp_slash_cmd_feedback",TS.model.active_cid)}},is_limited_div_tim:0,checkScrollBack:function(){var $el=$(".is_limited_div");if(!$el.length||$el.hasClass("hidden"))return;var scroller_rect=TS.client.ui.getCachedDimensionsRect("cached_msgs_scroller_rect",TS.client.ui.$msgs_scroller_div);if(TS.client.ui.isElInView($el,5,scroller_rect)){if($el.hasClass("been_seen"))return;$el.addClass("been_seen");$el.css("background-color","#fcc");TS.client.ui.is_limited_div_tim=setTimeout(function(){$el.css("background-color","")},2e3)}else{clearTimeout(TS.client.ui.is_limited_div_tim);$el.removeClass("been_seen")}},checkInlineImgsAndIframesEverywhere:function(log){TS.utility.queueRAF(function checkInlineImgsAndIframesEverywhereRAF(){TS.client.ui.checkInlineImgsAndIframes("main",log);TS.client.ui.checkInlineImgsAndIframes("search",log);TS.client.ui.checkInlineImgsAndIframes("archives",log);TS.client.ui.checkInlineImgsAndIframes("file_preview",log);TS.client.ui.checkInlineImgsAndIframes("file_list",log);if(TS.boot_data.feature_message_replies)TS.client.ui.checkInlineImgsAndIframes("replies",log);if(TS.boot_data.feature_message_replies_threads_view)TS.client.ui.checkInlineImgsAndIframes("threads",log);if(TS.boot_data.feature_unread_view)TS.client.ui.checkInlineImgsAndIframes("unread",log)})},checkInlineImgsAndIframesMain:function(){TS.client.ui.checkInlineImgsAndIframes("main")},getCachedDimensionsRect:function(cache_name,$element){
var dimensions;if(TS.model.ui[cache_name]){return TS.model.ui[cache_name]}if(!$element||!$element[0]){return{top:0,bottom:0,left:0,right:0,width:0,height:0}}dimensions=$element.dimensions_rect();if(dimensions.width&&dimensions.width!==0){TS.model.ui[cache_name]=dimensions}return dimensions},checkInlineImgsAndIframes:function(which,log){var $container;var scroller_rect;if(which=="main"){$container=TS.client.ui.$msgs_div;scroller_rect=TS.client.ui.getCachedDimensionsRect("cached_msgs_scroller_rect",TS.client.ui.$msgs_scroller_div)}else if(which=="search"){$container=$("#search_results");scroller_rect=TS.client.ui.getCachedDimensionsRect("cached_search_scroller_rect",$container)}else if(which=="archives"){$container=TS.client.archives.$scroller;scroller_rect=TS.client.ui.getCachedDimensionsRect("cached_archives_scroller_rect",$container)}else if(which=="file_preview"){$container=$("#file_preview_container");scroller_rect=TS.client.ui.getCachedDimensionsRect("cached_file_preview_scroller_rect",$container)}else if(which=="file_list"){$container=$("#file_list");scroller_rect=TS.client.ui.getCachedDimensionsRect("cached_file_list_scroller_rect",$container)}else if(which=="replies"){$container=$("#convo_scroller");scroller_rect=TS.client.ui.getCachedDimensionsRect("cached_convo_scroller_rect",$container)}else if(which=="unread"&&TS.boot_data.feature_unread_view){$container=TS.client.ui.unread.$scroller;scroller_rect=TS.client.ui.getCachedDimensionsRect("cached_unread_scroller_rect",$container)}else if(which=="threads"&&TS.boot_data.feature_message_replies_threads_view){$container=TS.client.ui.threads.$scroller;scroller_rect=TS.client.ui.getCachedDimensionsRect("cached_threads_scroller_rect",$container)}else{TS.info("unknown which in checkInlineImgsAndIframes(which)");return}if(log)TS.info("checkInlineImgsAndIframes which:"+which);var $hidden_inline_img=$container.find(".msg_inline_holder:not(.hidden) .msg_inline_child.hidden, .msg_inline_file_preview_toggler:not(.collapsed) + .image_container .image_bg");var rect;var $figure;var $img;var $holder;var loaded_data="loaded_bg";if(log)$("#active_channel_name").find(".topic").html($hidden_inline_img.length);$hidden_inline_img.each(function(index){$figure=$(this);$holder=$figure.closest(".msg_inline_holder, .image_container");if(!$holder.length)return;if($holder.data(loaded_data))return;rect=$holder.dimensions_rect();if(log)TS.dir(0,rect);if(log)TS.dir(0,scroller_rect);if(TS.utility.doRectsOverlap(scroller_rect,rect)){if(log)TS.info("yes");if($figure.data("real-background-image")){$figure.removeClass("hidden");$figure.css("background-image",'url("'+$figure.data("real-background-image")+'")');$img=$figure.find("img")}else{$img=$figure;$img.removeClass("hidden")}$img.attr("src",$img.data("real-src"));$img.error(function(){$(this).closest(".msg_inline_holder, .image_container").addClass("hidden")});$holder.data(loaded_data,true)}else{if(log)TS.warn("no")}$figure=null;$img=null;$holder=null});$container.find(".iframe_placeholder").each(function(index){var $iframe_placeholder=$(this);var $holder=$iframe_placeholder.closest(".msg_inline_holder");if(!$holder.length)return;var rect=$holder.dimensions_rect();if(TS.utility.doRectsOverlap(scroller_rect,rect)){var iframe_html=TS.utility.getIframeHTMLFromPlaceholder($iframe_placeholder[0].outerHTML);$iframe_placeholder.replaceWith($(iframe_html))}})},logUnreads:function(){var remaining=[];var model_ob=TS.shared.getActiveModelOb();var unreads=model_ob.unreads;if(!model_ob)return;for(var i=0;i<unreads.length;i++){if(TS.model.client.reads.indexOf(unreads[i])==-1){remaining.push(unreads[i])}}TS.info(remaining)},markMostRecentReadMsgInActive:function(reason,get_rid_of_line){var model_ob=TS.shared.getActiveModelOb();if(TS.pri)TS.log(999,"TS.client.ui.markMostRecentReadMsgInActive: reason = "+reason+(get_rid_of_line?", get_rid_of_line = "+get_rid_of_line:""));if(TS.model.active_channel_id){TS.channels.markMostRecentReadMsg(model_ob,reason)}else if(TS.model.active_group_id){TS.groups.markMostRecentReadMsg(model_ob,reason)}else if(TS.model.active_mpim_id){TS.mpims.markMostRecentReadMsg(model_ob,reason)}else{TS.ims.markMostRecentReadMsg(model_ob,reason)}if(get_rid_of_line){if(TS.pri)TS.log(999,"markMostRecentReadMsgInActive, #"+model_ob.name+', reason = "'+reason+'": calling TS.client.msg_pane.clearUnreadDividerAndHideNewMsgsBar()');TS.client.msg_pane.clearUnreadDividerAndHideNewMsgsBar();if(TS.boot_data.feature_pin_update)TS.ui.pins.clearUnreadPinState(model_ob)}if(model_ob&&(model_ob._temp_unread_cnt||model_ob._temp_last_read)){if(TS.pri)TS.log(58,"markMostRecentReadMsgInActive: Nulling _temp_unread_cnt and _temp_last_read on #"+model_ob.name);model_ob._temp_unread_cnt=null;model_ob._temp_last_read=null}},isMsgInView:function(msg_id){var model_ob=TS.shared.getActiveModelOb();if(model_ob){var msg=TS.utility.msgs.getMsg(msg_id,model_ob.msgs);if(msg&&msg._jl_rolled_up_in)msg_id=msg._jl_rolled_up_in}var msg_div=TS.client.msg_pane.getCanonicalDivForMsg(msg_id);if(!msg_div.length){return false}if(msg_div.hasClass("hidden"))return true;var scroller_rect=TS.client.ui.getCachedDimensionsRect("cached_msgs_scroller_rect",TS.client.ui.$msgs_scroller_div);return TS.client.ui.isElInView(msg_div,5,scroller_rect)},isUnreadDividerInView:function(tolerance){tolerance=tolerance||5;var scroller_rect=TS.client.ui.getCachedDimensionsRect("cached_msgs_scroller_rect",TS.client.ui.$msgs_scroller_div);return TS.client.ui.isElInView(TS.client.ui.$msgs_unread_divider,tolerance,scroller_rect)},isElInView:function(el,tolerance,scroller_rect){if(!el||!el.length){return false}tolerance=tolerance||0;var el_rect=el.dimensions_rect();if(el_rect.height>scroller_rect.height){return TS.utility.doesRectContainRect(el_rect,scroller_rect,tolerance,true)}else if(TS.utility.doesRectContainRect(scroller_rect,el_rect,tolerance,true)){return true}return false},scrollSoTopUnseenChannelIsInView:function(channels_scroll_clicked){var $lis=_findScrollTargetForChannelScroller(TS.client.channel_pane.$scroller,$(channels_scroll_clicked));if($lis.length){$lis.first().scrollintoview({offset:"top",px_offset:50,scroller:TS.environment.supports_custom_scrollbar?TS.client.channel_pane.$scroller:null})}else{var $starred_div=$("#starred_div");if($starred_div.length&&$starred_div.length&&!$starred_div.hasClass("hidden")){$("#starred_section_header").scrollintoview({scroller:TS.environment.supports_custom_scrollbar?TS.client.channel_pane.$scroller:null})}else{$("#channels_header").scrollintoview({scroller:TS.environment.supports_custom_scrollbar?TS.client.channel_pane.$scroller:null})}}},scrollSoBottomUnseenChannelIsInView:function(channels_scroll_clicked){var $lis=_findScrollTargetForChannelScroller(TS.client.channel_pane.$scroller,$(channels_scroll_clicked));if($lis.length){$lis.last().scrollintoview({offset:"bottom",px_offset:-50,scroller:TS.environment.supports_custom_scrollbar?TS.client.channel_pane.$scroller:null})}else{TS.client.channel_pane.$scroller.children().last().scrollintoview({scroller:TS.environment.supports_custom_scrollbar?TS.client.channel_pane.$scroller:null})}},onChannelsScroll:function(e){TS.model.ui.cached_channels_scroller_rect=null;TS.client.ui.checkUnseenChannelsImsGroupsWithUnreads();TS.client.channel_pane.checkScrolledAtAll()},checkUnseenChannelsImsGroupsWithUnreads:TS.utility.immediateDebounce(function(){TS.utility.queueRAF(TS.client.ui.actuallyCheckUnseenChannelsImsGroupsWithUnreads)}),actuallyCheckUnseenChannelsImsGroupsWithUnreads:function(){TS.client.ui.getCachedDimensionsRect("cached_channels_scroller_rect",TS.client.channel_pane.$scroller);var unseen_above,unseen_below,unseen_above_has_mention,unseen_below_has_mention=false;var $unreads;$unreads=TS.client.channel_pane.$scroller.find("li.unread:not(.muted_channel):not(.all_unreads):not(.all_threads)");$unreads.each(function(){var $li=$(this);if(!TS.client.ui.isElInView($li,10,TS.model.ui.cached_channels_scroller_rect)){var top=$li.closest(".section_holder").position().top+$li.position().top;if(top<TS.model.ui.cached_channels_scroller_rect.top){unseen_above=true;if($li.hasClass("mention"))unseen_above_has_mention=true}else{unseen_below=true;if($li.hasClass("mention"))unseen_below_has_mention=true}}});var $channel_scroll_up=$("#channel_scroll_up");if(unseen_above){$channel_scroll_up.removeClass("hidden unseen_have_mentions");if(unseen_above_has_mention){$channel_scroll_up.addClass("unseen_have_mentions").find("span").html("unread mentions")}else{$channel_scroll_up.find("span").html("more unreads")}}else{$channel_scroll_up.addClass("hidden").removeClass("unseen_have_mentions")}var $channel_scroll_down=$("#channel_scroll_down");if(unseen_below){$channel_scroll_down.removeClass("hidden unseen_have_mentions");if(unseen_below_has_mention){$channel_scroll_down.addClass("unseen_have_mentions").find("span").html("unread mentions")}else{$channel_scroll_down.find("span").html("more unreads")}}else{$channel_scroll_down.addClass("hidden").removeClass("unseen_have_mentions")}},onMsgsScrollThrottled:function(){TS.client.ui.markScrollTop();if(TS.client.ui.$msgs_unread_divider&&TS.shared.getActiveModelOb().unread_cnt){if(TS.client.ui.isUnreadDividerInView()){$("#messages_unread_status").addClass("quiet");$("#messages_unread_status").off("click mouseenter mouseleave");TS.client.msg_pane.hideNewMsgsJumpLink();$("#messages_unread_status").click(function(e){e.preventDefault();TS.client.ui.forceMarkAllRead(TS.model.marked_reasons.clicked)});$("#messages_unread_status .new_msgs_arrow").addClass("hidden")}else{$("#messages_unread_status").removeClass("quiet");$("#messages_unread_status").off("click mouseenter mouseleave");TS.client.msg_pane.hideNewMsgsJumpLink();$("#messages_unread_status .new_msgs_arrow").removeClass("hidden");$("#messages_unread_status").click(function(e){e.preventDefault();TS.client.ui.scrollMsgsSoFirstUnreadMsgIsInView()});$("#messages_unread_status").hover(TS.client.msg_pane.showNewMsgsJumpLink,TS.client.msg_pane.hideNewMsgsJumpLink);TS.client.msg_pane.showNewMsgsBar();TS.client.msg_pane.startNewMsgsTimer()}}if(TS.model.ui.msgs_are_auto_scrolling){return}TS.client.msg_pane.checkUnreads()},onMsgsScroll:function(e){TS.utility.throttle.method(TS.client.ui.onMsgsScrollThrottled,"ts_ui_on_msgs_scroll",250)},markScrollTop:function(){var scroll_top;if(TS.client.ui.areMsgsScrolledToBottom()){scroll_top=-1}else{scroll_top=TS.client.ui.$msgs_scroller_div[0].scrollTop}var marked=false;if(TS.model.active_channel_id){marked=TS.channels.markScrollTop(TS.model.active_channel_id,scroll_top)}else if(TS.model.active_mpim_id){marked=TS.mpims.markScrollTop(TS.model.active_mpim_id,scroll_top)}else if(TS.model.active_im_id){marked=TS.ims.markScrollTop(TS.model.active_im_id,scroll_top)}else if(TS.model.active_group_id){marked=TS.groups.markScrollTop(TS.model.active_group_id,scroll_top)}if(scroll_top===0&&TS.shared.getActiveModelOb()&&TS.shared.getActiveModelOb().id==TS.model.welcome_model_ob.id&&TS.model.cancelled_welcome_2_this_session){TS.model.cancelled_welcome_2_this_session=false;TS.view.adjustForWelcomeSlideShow();return}if(marked){TS.client.ui.maybeLoadScrollBackHistory()}},maybeLoadScrollBackHistory:function(){if(TS.client.ui.active_highlight_count||TS.model.ui.is_mouse_down)return;TS.client.ui.doLoadScrollBackHistory()},doLoadScrollBackHistory:function(force){if(TS.model.active_channel_id){TS.channels.maybeLoadScrollBackHistory(TS.model.active_channel_id,force)}else if(TS.model.active_mpim_id){TS.mpims.maybeLoadScrollBackHistory(TS.model.active_mpim_id,force)}else if(TS.model.active_im_id){TS.ims.maybeLoadScrollBackHistory(TS.model.active_im_id,force)}else if(TS.model.active_group_id){TS.groups.maybeLoadScrollBackHistory(TS.model.active_group_id,force)}},areMsgsScrolledToBottom:function(allowance){var cache=TS.model.archive_view_is_showing?TS.model.ui.cached_archive_scroll_result:TS.model.ui.cached_msgs_scroll_result;if(cache!==null){return cache}allowance=!isNaN(allowance)?allowance:50;var $div=TS.model.archive_view_is_showing?TS.client.archives.$scroller:TS.client.ui.$msgs_scroller_div;var div=$div[0];if(!div)return;var ret=parseInt($div.css("height"))+div.scrollTop+allowance>=div.scrollHeight;if(TS.model.archive_view_is_showing){TS.model.ui.cached_archive_scroll_result=ret}else{TS.model.ui.cached_msgs_scroll_result=ret}return ret},instaScrollMsgsToBottom:function(and_check){if(TS.model.prefs&&TS.model.prefs.start_scroll_at_oldest){var model_ob=TS.shared.getActiveModelOb();if(model_ob&&model_ob.unread_cnt&&TS.model.ui.msgs_are_auto_scrolling){if(TS.model.ui.is_window_focused){if(TS.pri)TS.log(888,"instaScrollMsgsToBottom: exiting early because unread_cnt = "+model_ob.unread_cnt+", and TS.model.ui.msgs_are_auto_scrolling = true");return}else{if(TS.pri)TS.log(888,"instaScrollMsgsToBottom: allowing scroll despite msgs_are_auto_scrolling = true and unread_cnt = "+model_ob.unread_cnt+", because window is blurred.")}}}if(TS.pri)TS.log(888,"instaScrollMsgsToBottom: and_check = "+and_check);TS.client.ui.instaScrollMsgsToPosition(TS.client.ui.$msgs_scroller_div[0].scrollHeight,and_check,true)},slowScrollMsgsToBottom:function(){var in_archives=TS.model.archive_view_is_showing;if(in_archives){TS.client.archives.$scroller.animate({scrollTop:TS.client.archives.$scroller[0].scrollHeight},"500")}else{TS.client.ui.$msgs_scroller_div.animate({scrollTop:TS.client.ui.$msgs_scroller_div[0].scrollHeight},"500")}},instaScrollMsgsToPosition:function(scroll_top,and_check,set_btm_result){if(TS.pri)TS.log(888,"instaScrollMsgsToPosition: scroll_top = "+scroll_top+", and_check = "+and_check+", set_btm_result = "+set_btm_result);TS.model.ui.msgs_are_auto_scrolling=true;TS.client.ui.$msgs_scroller_div.scrollTop(scroll_top);var model_ob_then=TS.shared.getActiveModelOb();setTimeout(function(){if(TS.pri)TS.log(888,"instaScrollMsgsToPosition -> timeout(): scroll_top = "+scroll_top+", set_btm_result = "+set_btm_result+"... resetting msgs_are_auto_scrolling.");TS.model.ui.msgs_are_auto_scrolling=false;if(set_btm_result!==null){var model_ob_now=TS.shared.getActiveModelOb();if(model_ob_then.id!==model_ob_now.id){if(TS.pri)TS.log(888,"instaScrollMsgsToPosition -> timeout(): active model_ob changed from #"+model_ob_then.name+" to #"+model_ob_now.name);if(TS.pri)TS.log(888,"instaScrollMsgsToPosition -> timeout(): NOT setting TS.client.ui.cached_msgs_scroll_result = "+set_btm_result);return}if(TS.pri)TS.log(888,"instaScrollMsgsToPosition -> timeout(): set TS.client.ui.cached_msgs_scroll_result = "+set_btm_result+", previously "+TS.client.ui.cached_msgs_scroll_result);TS.client.ui.cached_msgs_scroll_result=set_btm_result}},100);if(and_check){if(TS.pri)TS.log(888,"instaScrollMsgsToPosition: and_check, so checking unreads as well.");TS.client.msg_pane.checkUnreads()}},slowScrollMsgsToPosition:function(scroll_top,and_check,onComplete){var in_archives=TS.model.archive_view_is_showing;and_check=and_check&&!in_archives;var $scroller;if(in_archives){TS.client.archives.msgs_are_auto_scrolling=true;$scroller=TS.client.archives.$scroller}else{TS.model.ui.msgs_are_auto_scrolling=true;$scroller=TS.client.ui.$msgs_scroller_div}$scroller.stop().animate({scrollTop:scroll_top},"500",function(){setTimeout(function(){if(in_archives){TS.client.archives.msgs_are_auto_scrolling=false}else{TS.model.ui.msgs_are_auto_scrolling=false}},100);if(and_check){TS.client.msg_pane.checkUnreads()}if(onComplete)onComplete()})},scrollMsgsSoMsgIsInView:function(ts,fade_older_in,highlight,duration,is_retry){duration=isNaN(duration)?1e3:duration;var div;var in_archives=TS.model.archive_view_is_showing;if(in_archives){div=TS.client.msg_pane.getDivForArchiveMsg(ts)}else{div=TS.client.msg_pane.getCanonicalDivForMsg(ts)}if(!div.length){if(!is_retry){TS.utility.rAF(function(){is_retry=true;TS.client.ui.scrollMsgsSoMsgIsInView(ts,fade_older_in,highlight,duration,is_retry)})}return}var prev;if(fade_older_in){prev=div.prevAll().slice(0,20);prev.css("opacity",0);div.next().scrollintoview({duration:0,offset:"top"})}var highlight_ms=2500;if(!in_archives&&highlight){TS.client.ui.active_highlight_count++}if(in_archives){TS.client.archives.msgs_are_auto_scrolling=true}else{TS.model.ui.msgs_are_auto_scrolling=true}TS.model.ui.scrolled_to_msg_ts=ts;clearTimeout(_scrolled_to_msg_timeout);_scrolled_to_msg_timeout=setTimeout(function(){TS.model.ui.scrolled_to_msg_ts=null},1e4);div.scrollintoview({duration:duration,offset:"center_vertical",complete:function(){if(highlight){div.highlight(highlight_ms,"msg_highlighter");if(!in_archives){setTimeout(function(){TS.client.ui.active_highlight_count--},highlight_ms)}}setTimeout(function(){if(fade_older_in&&prev){prev.transition({opacity:1},300)}},100);if(in_archives){TS.client.archives.msgs_are_auto_scrolling=false;TS.client.archives.onMsgsScroll()}else{TS.model.ui.msgs_are_auto_scrolling=false;TS.client.ui.onMsgsScroll()}}})},active_highlight_count:0,scrollMsgsSoFirstUnreadMsgIsInView:function(onComplete){var log=false;if(log){TS.info("scrollMsgsSoFirstUnreadMsgIsInView called");TS.info("TS.client.ui.$msgs_unread_divider="+TS.client.ui.$msgs_unread_divider)}if(!TS.client.ui.$msgs_unread_divider)return;if(log)TS.info("TS.client.ui.$msgs_unread_divider.length="+TS.client.ui.$msgs_unread_divider.length);var which=TS.client.ui.$msgs_unread_divider;TS.model.ui.msgs_are_auto_scrolling=true;which.scrollintoview({duration:200,offset:"top",px_offset:50,complete:function(){setTimeout(function(){if(log)TS.info("scrollMsgsSoFirstUnreadMsgIsInView animation complete");TS.model.ui.msgs_are_auto_scrolling=false;TS.client.ui.onMsgsScroll();if(onComplete)onComplete()},1)}})},afterHistoryFetch:function(model_ob){TS.client.msg_pane.rebuildMsgsWithReason("afterHistoryFetch for "+(model_ob?"#"+model_ob.name:"unspecified"));TS.view.resizeManually("TS.client.ui.afterHistoryFetch");if(TS.client.ui.record_content_visible_metric_after_fetching_model_ob==model_ob.id){TS.metrics.mark("content_visible");TS.metrics.measure("client_content_visible_4","start_nav","content_visible");delete TS.client.ui.record_content_visible_metric_after_fetching_model_ob}if(model_ob.scroll_top!==0)return;if(!TS.model.ui.last_top_msg)return;TS.client.ui.scrollMsgsSoMsgIsInView(TS.model.ui.last_top_msg.ts,true);TS.model.ui.last_top_msg=null;setTimeout(function(){if(model_ob.scroll_top===0){TS.info("TS.client.ui.afterHistoryFetch: we're still scrolled to the top, so we'll try to fetch more messages now");TS.client.ui.maybeLoadScrollBackHistory()}},1e3)},rebuildMemberListToggle:function(){if(TS.model.active_channel_id||TS.model.active_group_id||TS.model.active_mpim_id){var model_ob=TS.shared.getActiveModelOb();var display_member_count=0;var online_count=0;if(TS.isPartiallyBooted()){display_member_count=_.get(model_ob,"_incremental_boot_counts.member_count_display",0)}else if(TS.lazyLoadMembersAndBots()){display_member_count=TS.flannel.getMemberCountForModelOb(model_ob)}else{var member;for(var i=0;i<model_ob.members.length;i++){member=TS.members.getMemberById(model_ob.members[i]);if(member&&!member.deleted){display_member_count++;if(member.presence==="active")online_count++}}}var $member_count=$("#channel_members_toggle_count");TS.utility.queueRAF(function rebuildMemberListToggleRAF(){if(TS.boot_data.feature_pin_update){$member_count.html('<ts-icon class="ts_icon_user ts_icon_inherit channel_members_icon"></ts-icon> '+display_member_count)}else{$member_count.text(TS.i18n.t("{member_count,plural,=1{{member_count} member}other{{member_count} members}}","client")({member_count:display_member_count}))}var tooltip_text;if(TS.lazyLoadMembersAndBots()){tooltip_text="View member list"}else{tooltip_text="View member list ("+online_count+"/"+display_member_count+" online)"}$member_count.append('<span class="ts_tip_tip">'+tooltip_text+"</span>");$member_count.removeClass("hidden")})}else{$("#channel_members_toggle").addClass("hidden")}},maybePromptForClosingGroup:function(id){var group=TS.groups.getGroupById(id);if(group.unread_cnt){TS.generic_dialog.start({title:"You have unread messages",body:"You have unread messages in the "+TS.model.group_prefix+group.name+" private channel. Are you sure you want to close it?",show_cancel_button:true,show_go_button:true,go_button_text:"Yes",cancel_button_text:"No",onGo:function(){TS.groups.markMostRecentReadMsg(group,TS.model.marked_reasons.closed);TS.client.markLastReadsWithAPI();if(group.is_open){TS.groups.closeGroup(group.id)}else{TS.groups.closeGroup(group.id)}}})}else{TS.groups.closeGroup(group.id)}},maybePromptForClosingIm:function(id){var im=TS.ims.getImById(id);if(im.unread_cnt){TS.generic_dialog.start({title:"You have unread messages",body:"You have unread messages from "+im.name+". Are you sure you want to close the DM?",show_cancel_button:true,show_go_button:true,go_button_text:"Yes",cancel_button_text:"No",onGo:function(){TS.ims.markMostRecentReadMsg(im,TS.model.marked_reasons.closed);TS.client.markLastReadsWithAPI();TS.ims.closeIm(im.id)}})}else{TS.ims.closeIm(im.id)}},unread_checking_tim:0,channelOrImOrGroupDisplaySwitched:function(){TS.client.msg_pane.dont_check_unreads_til_switch=false;TS.model.client.reads.length=0;TS.client.ui.startUnreadCheckingTimer();TS.client.ui.rebuildMemberListToggle();TS.shared.maybeFetchHistoryAndThenCheckConsistency(TS.shared.getActiveModelOb());if(TS.model.ui_state.flex_name==="files"&&TS.model.ui_state.flex_extra){var $back=$("#back_from_file_preview");var origin=$back.data("origin");if(origin==="channel_page"||origin==="group_page"){TS.client.ui.files._rebuildBackFromFilePreview("")}}},startUnreadCheckingTimer:function(){clearTimeout(TS.client.ui.unread_checking_tim);var immediate_ms=0;var default_ms=1e3;var ms=default_ms;if(TS.model.prefs&&TS.model.prefs.mark_msgs_read_immediately)ms=immediate_ms;TS.client.ui.unread_checking_tim=setTimeout(TS.client.msg_pane.checkUnreads,ms)},isUserAttentionOnChat:function(){if(!TS.model.ui.is_window_focused)return false;if(TS.model.dialog_is_showing)return false;if(TS.model.menu_is_showing)return false;if(TS.model.coachmark_is_showing)return false;if(TS.model.overlay_is_showing)return false;if(TS.ui.msg_tab_complete.isShowing())return false;if(TS.ui.fs_modal.is_showing)return false;return true},unfurlPlaceholders:function($preview){$preview.find(".unfurl-placeholder:not(.unfurled)").each(function(i,elem){var $elem=$(elem);$elem.addClass("unfurled");var id="pending_unfurl_"+_pending_unfurl_id++;$elem.attr("id",id);try{var url=$elem.attr("href");TS.api.call("chat.unfurlLink",{url:url}).then(function(resp){if(resp&&resp.data&&resp.data.attachments&&resp.data.attachments[url]){var attachment=resp.data.attachments[url];var $el=$("#"+id);if(!$el.length)return;if(TS.boot_data.feature_a11y_pref_no_animation){if(TS.model.prefs.a11y_animations===false){if(attachment["file_type"]==="gif"){return}}}var unfurled_html=TS.inline_attachments.renderStandaloneAttachment(attachment);var was_at_bottom=TS.client.ui.areMsgsScrolledToBottom();$el.replaceWith(unfurled_html);if(was_at_bottom){if(TS.pri)TS.log(888,"unfurlPlaceholders: Insta-scrolling back to bottom after unfurl of attachment #"+id);TS.client.ui.instaScrollMsgsToBottom(false)}_throttledFilePreviewInline()}else{throw"No unfurl data"}}).catch(function(err){$("#"+id).addClass("hidden")})}catch(err){$elem.addClass("hidden")}});_throttledFilePreviewInline()},previewMember:function(id,origin){return TS.client.ui._displayMember(id,origin).then(function(member_name){TS.client.flexDisplaySwitched("team",member_name);return null},_.noop)},_displayMember:function(id,origin){if(TS.viewmodel&&TS.viewmodel.teamdirectory){return new Promise(function(resolve,reject){TS.viewmodel.teamdirectory.withActiveSubmodel(function(submodel){var member=submodel.getMemberById(id);if(!member)return void reject(new Error("wtf: no member to display"));if(!TS.client.ui.flex._displayFlexTab("team"))return void reject(new Error("wtf: failed to open team tab"));_renderMember(member,origin);resolve(member.name)})})}return new Promise(function(resolve,reject){var member=TS.members.getMemberById(id);if(!member)return void reject(new Error("wtf: no member to display"));if(!TS.client.ui.flex._displayFlexTab("team"))return void reject(new Error("wtf: failed to open team tab"));var complete=function(){_renderMember(member,origin);resolve(member.name)};if(member.profile&&member.profile.fields){TS.team.ensureTeamProfileFields().then(complete)}else{complete()}})},showTeamList:function(){if(!TS.client.ui._displayTeamList())return;TS.client.flexDisplaySwitched("team")},_displayTeamList:function(){if(!TS.client.ui.flex._displayFlexTab("team"))return false;TS.model.previewed_member_name="";TS.model.previewed_member_id="";TS.model.previewed_user_group_id="";$("#user_group_preview_container").hideWithRememberedScrollTop();$("#member_preview_container").hideWithRememberedScrollTop();$("#team_list_container").unhideWithRememberedScrollTop();TS.view.resizeManually("TS.client.ui._displayTeamList");if(TS.boot_data.feature_searchable_member_list){var searchable_member_list=new TS.SearchableMemberList({$container:$("#team_list_container"),namespace:"team_list"});searchable_member_list.showInitial()}else{TS.view.triggerInitialTeamListLazyLoad()}return true},showGroupsList:function(){if(!TS.client.ui._displayGroupsList())return;TS.client.flexDisplaySwitched("groups")},_displayGroupsList:function(){if(!TS.client.ui.flex._displayFlexTab("groups"))return false;$("#user_groups_container").unhideWithRememberedScrollTop();return true},previewUserGroup:function(id,origin){if(!origin&&TS.boot_data.feature_searchable_member_list){origin="groups"}if(!TS.client.ui._displayUserGroup(id,origin))return;var user_group=TS.user_groups.getUserGroupsById(id);if(TS.boot_data.feature_searchable_member_list){TS.client.flexDisplaySwitched("groups",user_group.id)}else{TS.client.flexDisplaySwitched("team",user_group.id)}},_displayUserGroup:function(id,origin){if(_displayUserGroupInFlight)return;_displayUserGroupInFlight=true;var user_group=TS.user_groups.getUserGroupsById(id);if(!user_group)return false;if(TS.boot_data.feature_searchable_member_list){if(!TS.client.ui.flex._displayFlexTab("groups"))return false}else{if(!TS.client.ui.flex._displayFlexTab("team"))return false}if(TS.view.user_groups_members_list_lazyload){TS.view.user_groups_members_list_lazyload.detachEvents();TS.view.user_groups_members_list_lazyload=null}TS.model.previewed_user_group_id=user_group.id;TS.info("TS.model.previewed_user_group_id:"+TS.model.previewed_user_group_id);if(TS.boot_data.feature_searchable_member_list){$("#user_groups_container").hideWithRememberedScrollTop()}else{$("#team_list_container").hideWithRememberedScrollTop();$("#member_preview_container").hideWithRememberedScrollTop()}var i;var selected_members;var work=function(){$("#user_group_preview_container").unhideWithRememberedScrollTop();selected_members=user_group.users;var populate_members_p;if(TS.lazyLoadMembersAndBots()){populate_members_p=TS.members.ensureMembersArePresent(selected_members)}else{populate_members_p=Promise.resolve()}populate_members_p.then(function(){var members=[];for(i=0;i<selected_members.length;i++){members.push(TS.members.getMemberById(selected_members[i]))}members.sort(function(a,b){var a_name=a._real_name_lc||a._name_lc;var b_name=b._real_name_lc||b._name_lc;return a_name>b_name?1:b_name>a_name?-1:0});var selected_channels=user_group.prefs.channels;var channels=[];for(i=0;i<selected_channels.length;i++){channels.push(TS.channels.getChannelById(selected_channels[i]))}var selected_groups=user_group.prefs.groups;var groups=[];for(i=0;i<selected_groups.length;i++){groups.push(TS.groups.getGroupById(selected_groups[i]))}channels=channels.concat(groups);var is_user_group_deleted=user_group.date_delete===-1;var show_user_groups_edit=TS.members.canUserEditUserGroups()||TS.members.canUserCreateAndDeleteUserGroups();var html=TS.templates.user_group_preview({user_group:user_group,members:members,channels:channels,show_user_groups_edit:show_user_groups_edit,is_user_group_deleted:is_user_group_deleted});var $user_group_preview_scroller=$("#user_group_preview_scroller");$user_group_preview_scroller.html(html);TS.utility.makeSureAllLinksHaveTargets($user_group_preview_scroller);$("#user_group_menu_toggle").on("click",function(e){TS.menu.startWithUserGroupMenu(e,user_group.id)});$("#edit_default_channels").on("click",function(e){TS.ui.admin_user_groups.editInfo(user_group)});TS.ui.tabs.create($("#user_group_tabs"));if(TS.model.last_previewed_user_group_id!=TS.model.previewed_user_group_id){$user_group_preview_scroller.scrollTop(0)}TS.model.last_previewed_user_group_id=user_group.id;var $member_list=$("#user_group_members");$member_list.bind("click.view",TS.view.onMemberListClick);$member_list.on("click.toggle_list_item",".team_list_item",TS.members.view.onTeamDirectoryItemClick);TS.utility.makeSureAllLinksHaveTargets($member_list);$user_group_preview_scroller.find(".user_group_member_list").monkeyScroll();TS.view.user_groups_members_list_lazyload=$member_list.find(".lazy").lazyload({container:$(".user_group_member_list"),ignore_when_hidden_element:$("#user_group_members"),all_images_same_size:true});$(".user_group_member_list").trigger("resize-immediate");var $back_from_user_group_preview=$("#back_from_user_group_preview");_rebuildBackFromMemberorUserGroupPreview(origin,$back_from_user_group_preview);TS.client.flex_pane.stopLocalTimeInterval();TS.view.resizeManually("TS.client.ui._displayUserGroup");_displayUserGroupInFlight=false;return true})};if(user_group.users===undefined){TS.user_groups.getUserGroupMembers(id,function(updated_group){if(updated_group&&updated_group.users){user_group=updated_group;return work()}})}else{return work()}},showStatusForm:function(div_id){if($("#user_status_form").data("last_div_id")){TS.client.ui.removeStatusForm($("#user_status_form").data("last_div_id"))}var html=TS.templates.user_status_form({user:TS.model.user,div_id:div_id});var div=$("#"+div_id);div.addClass("hidden");div.after(html);$("#user_status_form").data("last_div_id",div_id);$("#user_status_input").select()},submitUserStatus:function(div_id){var status=$("#user_status_input").val();TS.members.setUserStatus(status);TS.client.ui.removeStatusForm(div_id);return false},removeStatusForm:function(div_id){var div=$("#"+div_id);div.removeClass("hidden");$("#user_status_form").remove()},getNextOpenChannelOrIMElements:function(with_unreads){var with_unreads_or_starred=false;var with_unreads_or_visible_muted=false;if(!with_unreads&&TS.model.prefs.sidebar_behavior=="hide_read_channels"){with_unreads_or_visible_muted=true}else if(!with_unreads&&TS.model.prefs.sidebar_behavior=="hide_read_channels_unless_starred"){with_unreads_or_starred=true}var lis_selector="LI:not(.public_private_channel_list_separator):not(.hidden)";if(with_unreads){lis_selector="LI.unread:not(.hidden), LI.active"}else if(with_unreads_or_starred){lis_selector="LI.unread:not(.hidden), LI.active, LI.show_in_list_even_though_no_unreads:not(.hidden), UL#starred-list LI"}else if(with_unreads_or_visible_muted){lis_selector="LI.unread:not(.hidden), LI.active, LI.show_in_list_even_though_no_unreads:not(.hidden)"}var $lis=TS.client.channel_pane.$scroller.find(lis_selector);$lis=$lis.filter(":not(.all_unreads):not(.all_threads)");if(!$lis.length){TS.error('no $lis found for "'+lis_selector+'"')}return $lis},getNextOpenChannelOrIM:function(with_unreads,backwards,$current_li){var $lis=TS.client.ui.getNextOpenChannelOrIMElements(with_unreads);if(!$lis.length){return $lis}$current_li=$current_li||$lis.filter(".active");if(!$current_li.length){TS.error("active li not found");return $current_li}if($current_li.length>1){TS.error("too many active $lis found");return $current_li}var $next_li;if(backwards){$next_li=$lis.eq($lis.index($current_li)-1);if(!$next_li.length){$next_li=$lis.last()}}else{$next_li=$lis.eq($lis.index($current_li)+1);if(!$next_li.length){$next_li=$lis.first()}}return $next_li},gotoNextOpenChannelOrIM:function(with_unreads,backwards){var $current_li;
if(TS.client.activeChannelIsHidden()){var $lis=TS.client.ui.getNextOpenChannelOrIMElements(with_unreads);$current_li=backwards?$lis.filter(":first"):$lis.filter(":last")}var $next_li=TS.client.ui.getNextOpenChannelOrIM(with_unreads,backwards,$current_li);if(!$next_li||!$next_li.length)return false;var $next_next_li;if($next_li){$next_next_li=TS.client.ui.getNextOpenChannelOrIM(with_unreads,backwards,$next_li)}function maybePreloadNext(){if(!$next_next_li||!$next_next_li.length)return;var preload_data=getDataFromListItem($next_next_li);if(!preload_data)return;var next_next_id=preload_data.id;if(!next_next_id)return;var model_ob=preload_data.byIdMethod(next_next_id);if(!model_ob||model_ob._history_fetched_since_last_connect||model_ob.history_is_being_fetched)return;TS.api.callFuncWhenApiQisEmpty(function(){if(TS.pri)TS.log(58,'pre-fetching history for next keyboard action "'+model_ob.id+'" "'+model_ob.name+'"');TS.shared.maybeFetchHistory(model_ob)})}function getDataFromListItem($li){var result={};if(!$li||!$li.length)return result;var inner_class_name;var data_attribute;var displayMethod;var byIdMethod;var type;if($li.hasClass("all_unreads")){data_attribute="data-action";inner_class_name="channel_name";type="unread_view"}else if($li.hasClass("channel")){data_attribute="channel-id";inner_class_name="channel_name";type="channel";displayMethod=TS.channels.displayChannel;byIdMethod=TS.channels.getChannelById}else if($li.hasClass("group")){data_attribute="group-id";inner_class_name="group_name";type="group";displayMethod=TS.groups.displayGroup;byIdMethod=TS.groups.getGroupById}else if($li.hasClass("member")){data_attribute="member-id";inner_class_name="im_name";type="im";displayMethod=TS.ims.startImByMemberId;byIdMethod=TS.ims.getImByMemberId}else if($li.hasClass("mpim")){data_attribute="mpim-id";inner_class_name="mpim_name";type="mpim";displayMethod=TS.mpims.displayMpim;byIdMethod=TS.mpims.getMpimById}var $inner_node=$li.find("."+inner_class_name);if(!$inner_node||!$inner_node.length)return result;result={id:$inner_node.data(data_attribute),type:type,displayMethod:displayMethod,byIdMethod:byIdMethod};return result}var data=getDataFromListItem($next_li);if(data.type==="unread_view"){TS.client.unread.showUnreadView();return}if(!data.id||!data.type||!data.displayMethod){TS.warn("WTF no result from getDataFromListItem for $next_li?",$next_li);return false}data.displayMethod(data.id);maybePreloadNext();return true},tryToJump:function(c_id,ts){var model_ob=TS.shared.getModelObById(c_id);if(!model_ob){TS.error("NO CHANNEL NO IM GROUP");return false}if(TS.ims.isImWithDeletedMember(model_ob))return false;var existing_msg=TS.utility.msgs.getMsg(ts,model_ob.msgs);if(TS.boot_data.feature_message_replies){if(existing_msg&&TS.utility.msgs.isMsgReply(existing_msg)){TS.ui.replies.openConversation(model_ob,existing_msg.thread_ts,existing_msg.ts);return true}}TS.view.displayMsgInModelOb(model_ob,ts);return true},sendChannelMsgThroughSlackBot:function(c_id,msg_id,member_ids_str,ephemeral_msg_ts){var model_ob=TS.channels.getChannelById(c_id);if(!model_ob)return;var member_idsA=member_ids_str.split(",");if(!member_idsA.length)return;var msg=TS.utility.msgs.getMsg(msg_id,model_ob.msgs);if(!msg){TS.client.ui.addEphemeralBotMsg({channel:model_ob.id,text:"Darn, it looks like that message no longer exists.",slackbot_feels:"sad_surprise"});return}var names_text="";for(var i=0;i<member_idsA.length;i++){if(i!==0){if(i==member_idsA.length-1){if(member_idsA.length>2)names_text+=",";names_text+=" and "}else{names_text+=", "}}names_text+="<b>"+TS.members.getMemberDisplayName(TS.members.getMemberById(member_idsA[i]),true)+"</b>"}TS.generic_dialog.start({title:"Send message to users not in #"+model_ob.name+"",body:"<p>Would you like to have slackbot send "+names_text+" your message?</p>"+TS.templates.builders.buildMsgHTML({msg:msg,model_ob:model_ob,standalone:true}),go_button_text:"Yes, send it",onGo:function(){for(var i=0;i<member_idsA.length;i++){TS.api.call("chat.sendMention",{channel:c_id,user:member_idsA[i],ts:msg.ts})}if(ephemeral_msg_ts){if(c_id.charAt(0)==="C"){TS.channels.removeMsg(c_id,TS.utility.msgs.getMsg(ephemeral_msg_ts,model_ob.msgs))}else if(c_id.charAt(0)==="G"){TS.groups.removeMsg(c_id,TS.utility.msgs.getMsg(ephemeral_msg_ts,model_ob.msgs))}}}})},promptForGroupOrChannelInvite:function(c_id,member_ids_str,ephemeral_msg_ts){var model_ob=TS.groups.getGroupById(c_id)||TS.channels.getChannelById(c_id);if(!model_ob)return;var member_idsA=member_ids_str.split(",");if(!member_idsA.length)return;if(model_ob.is_group){TS.ui.invite.showInviteMembersPreSelected(c_id,member_idsA,ephemeral_msg_ts);return}var names_text="";for(var i=0;i<member_idsA.length;i++){if(i!==0){if(i==member_idsA.length-1){if(member_idsA.length>2)names_text+=",";names_text+=" and "}else{names_text+=", "}}names_text+="<b>"+TS.members.getMemberDisplayName(TS.members.getMemberById(member_idsA[i]),true)+"</b>"}TS.generic_dialog.start({title:"Invite new members to #"+model_ob.name+"",body:"<p>Would you like to invite "+names_text+" to #"+model_ob.name+"?</p>",go_button_text:"Yes, invite them",onGo:function(){for(var i=0;i<member_idsA.length;i++){TS.api.call("channels.invite",{channel:c_id,user:member_idsA[i]})}if(ephemeral_msg_ts){TS.channels.removeMsg(c_id,TS.utility.msgs.getMsg(ephemeral_msg_ts,model_ob.msgs))}}})},addEphemeralBotMsg:function(ob){var c_id=ob.channel||TS.shared.getActiveModelOb().id;var text=ob.text;if(!text)return;var msg;if(ob.username){msg={type:"message",subtype:"bot_message",icons:ob.icons||null,is_ephemeral:true,username:ob.username,ts:ob.ts,text:text}}else{msg={type:"message",user:"USLACKBOT",is_ephemeral:true,ts:ob.ts,text:text}}if(ob.slackbot_feels){msg.slackbot_feels=ob.slackbot_feels}var ts=_addEphemeralMsg(c_id,msg,ob.ephemeral_type);TS.info(ts)},addOrFlashEphemeralBotMsg:function(ob){var c_id=ob.channel||TS.shared.getActiveModelOb().id;var ephemeral_type=ob.ephemeral_type;var msgs=ephemeral_type?TS.utility.msgs.getEphemeralMsgsByCidAndType(c_id,ephemeral_type):null;if(msgs&&msgs.length){var model_ob=TS.shared.getActiveModelOb();var existing_msg=msgs[0];if(TS.boot_data.feature_texty){existing_msg.text=TS.format.cleanInternalMsg(ob.text)}else{existing_msg.text=ob.text}if(model_ob.is_im){TS.ims.message_changed_sig.dispatch(model_ob,existing_msg)}else if(model_ob.is_channel){TS.channels.message_changed_sig.dispatch(model_ob,existing_msg)}else if(model_ob.is_mpim){TS.mpims.message_changed_sig.dispatch(model_ob,existing_msg)}else if(model_ob.is_group){TS.groups.message_changed_sig.dispatch(model_ob,existing_msg)}}else{TS.client.ui.addEphemeralBotMsg(ob)}},maybeHandleSingleEmoji:function(val){if(TS.model.prefs.seen_single_emoji_msg)return;var model_ob=TS.shared.getActiveModelOb();var msg=model_ob.msgs[0];if(!_isMsgGoodForReaction(msg))return;var colon_cnt=val.match(/:/g)&&val.match(/:/g).length;if(colon_cnt<2){return}var match=val.match(/^\s*(:[a-zA-Z0-9-_+]+:(:skin-tone-[2-6]:)?)\s*$/);if(!match){return}var name=TS.emoji.isValidName(match[1]);if(!name){return}var rxn_key=TS.rxns.getRxnKeyByMsgType(msg);if(!rxn_key){return}if(TS.rxns.doesRxnsHaveRxnFromUser(TS.rxns.getExistingRxnsByKey(rxn_key),name)){return}if(model_ob.is_slackbot_im){return}var cmd_key=TS.model.is_mac?"cmd":"ctrl";TS.client.ui.addEphemeralBotMsg({channel:model_ob.id,ts:TS.utility.date.makeTsStamp(),text:"Hey! Looks like you just posted an emoji response. Did you know you can also react to messages directly with emojis? Click *Add reaction ...* on any message to try it. You can also type `+:emoji_name:` or `"+cmd_key+"+shift+\\` to react without leaving the comfort of your keyboard. Enjoy! :sparkles:"});TS.model.prefs.seen_single_emoji_msg=true;TS.prefs.setPrefByAPI({name:"seen_single_emoji_msg",value:true})},maybeHandleReactionCmd:function(msg,val,callback_if_reacted){if(!msg)return false;var colon_cnt=val.match(/:/g)&&val.match(/:/g).length;if(colon_cnt<2){return false}var match=val.match(/^(\+|-) {0,1}(:[a-zA-Z0-9-_+]+:(:skin-tone-[2-6]:)?)\s*$/);if(!match){return false}var prefix=match[1];var name=match[2];if(prefix!="+"&&prefix!="-"){return false}var rxn_key=TS.rxns.getRxnKeyByMsgType(msg);if(!rxn_key){TS.sounds.play("beep");return true}var adding=prefix=="+";if(!_isMsgGoodForReaction(msg)||!TS.emoji.isValidName(name)||TS.rxns.doesRxnsHaveRxnFromUser(TS.rxns.getExistingRxnsByKey(rxn_key),name)==adding){TS.sounds.play("beep");return true}if(adding&&TS.boot_data.feature_thanks){var handy_rxns_dd=TS.rxns.getHandyRxnsDisplayDataByRxnKey(rxn_key);if(handy_rxns_dd.restrict){if(!handy_rxns_dd.items[TS.emoji.stripWrappingColons(name)]){TS.sounds.play("beep");return true}}}TS.rxns.changeRxnsFromUserAction(rxn_key,name,adding);if(callback_if_reacted)callback_if_reacted();return true},sendMsgFromUserFromSSB:function(c_id,text,in_reply_to_msg_ts){if(!c_id)return false;if(!text)return false;var sent=false;var model_ob=TS.shared.getModelObById(c_id);var in_reply_to_msg=model_ob&&TS.utility.msgs.getMsg(in_reply_to_msg_ts,model_ob.msgs);if(in_reply_to_msg&&TS.client.ui.maybeHandleReactionCmd(in_reply_to_msg,text))return true;if(TS.boot_data.feature_message_replies&&in_reply_to_msg&&!in_reply_to_msg.thread_ts){in_reply_to_msg=null}if(c_id.indexOf("C")==0&&TS.channels.getChannelById(c_id)){sent=TS.channels.sendMsg(c_id,text,in_reply_to_msg)}else if(c_id.indexOf("G")==0&&TS.groups.getGroupById(c_id)){sent=TS.groups.sendMsg(c_id,text,in_reply_to_msg)}else if(c_id.indexOf("G")==0&&TS.mpims.getMpimById(c_id)){sent=TS.mpims.sendMsg(c_id,text,in_reply_to_msg)}else if(TS.ims.getImById(c_id)){sent=TS.ims.sendMsg(c_id,text,in_reply_to_msg)}if(!sent){TSSSB.warn("TSSSB.sendMsgFromUser failed, invalid c_id or possible permission failure");return false}return true},shouldIgnoreClick:function(e){if(TS.isPartiallyBooted()){e.preventDefault();TS.incremental_boot.userDidInteractWithUI();return true}if(TS.newxp.inOnboarding())return true;return false}});var _afterSendMsg=function(model_ob){if(model_ob!==TS.model.active_cid)return;if(TS.client.ui.isUnreadDividerInView()){TS.client.ui.forceMarkAllRead(TS.model.marked_reasons.sent)}if(TS.model.overlay_is_showing){TS.view.overlay.cancelFromSendingMessage()}if(TS.model.showing_welcome_2){TS.model.cancelled_welcome_2_this_session=true;TS.view.unAdjustForWelcomeSlideShow();TS.client.ui.instaScrollMsgsToBottom(true)}};var _toggleCroppedMemberImage=function(img){var $member_details=$(img).closest(".member_details");if($member_details.hasClass("cropped_preview")){$member_details.removeClass("cropped_preview");TS.model.ui_state.expand_member_images_in_flexpane=true}else{$member_details.addClass("cropped_preview");TS.model.ui_state.expand_member_images_in_flexpane=false}TS.storage.storeUIState(TS.model.ui_state);TS.view.resizeManually("TS.client.ui._displayMember")};var _addEphemeralMsg=function(c_id,msg,ephemeral_type){if(TS.boot_data.feature_texty){msg.text=TS.format.cleanInternalMsg(msg.text)}msg.ts=msg.ts||TS.utility.date.makeTsStamp();var imsg=TS.utility.msgs.processImsg(msg,c_id);var model_ob=TS.shared.getModelObById(c_id);if(model_ob&&model_ob.is_channel){TS.channels.addMsg(c_id,imsg)}else if(model_ob&&model_ob.is_mpim){TS.mpims.addMsg(c_id,imsg)}else if(model_ob&&model_ob.is_group){TS.groups.addMsg(c_id,imsg)}else if(model_ob&&model_ob.is_im){TS.ims.addMsg(c_id,imsg)}TS.utility.msgs.ephemeral_msgs_map[msg.ts]={c_id:c_id,ephemeral_type:ephemeral_type};return msg.ts};var _handleHistoryNavigationOnDesktop=function(e){var is_mac_ssb=TS.model.mac_ssb_version||TS.model.win_ssb_version&&TS.model.is_mac;var is_win_linux_ssb=TS.model.win_ssb_version&&TS.model.is_win||TS.model.lin_ssb_version&&TS.model.is_lin;var has_history_menu_win=TS.model.win_ssb_version&&TS.model.win_ssb_version>2||TS.model.win_ssb_version===2&&TS.model.win_ssb_version_minor>=4;var has_history_menu_linux=TS.model.lin_ssb_version&&TS.model.lin_ssb_version>2||TS.model.lin_ssb_version===2&&TS.model.lin_ssb_version_minor>=4;var supports_history_navigation=TS.model.mac_ssb_version||has_history_menu_win||has_history_menu_linux;var using_command_key=e.metaKey&&!e.shiftKey&&!e.altKey;var using_alt_key=!e.metaKey&&!e.shiftKey&&e.altKey;var keymap=TS.utility.keymap;var using_bracket_keys=e.which==keymap.left_square_bracket||e.which==keymap.right_square_bracket;var using_arrow_keys=e.which==keymap.left||e.which==keymap.right;var input_must_be_empty=using_command_key&&using_arrow_keys;if(is_mac_ssb&&!supports_history_navigation&&using_command_key&&using_bracket_keys){_navigateHistoryUsingKeys(e.which,keymap.left_square_bracket,keymap.right_square_bracket,input_must_be_empty)}else if(is_win_linux_ssb&&!supports_history_navigation&&using_alt_key&&using_arrow_keys){_navigateHistoryUsingKeys(e.which,keymap.left,keymap.right,input_must_be_empty)}else if(using_command_key&&using_arrow_keys){_navigateHistoryUsingKeys(e.which,keymap.left,keymap.right,input_must_be_empty)}else if(using_command_key&&using_bracket_keys){TS.clog.track("HISTORY_NAV_ACTION",{trigger:"keyboard_shortcut",action:"nav_prev_next"})}};var _navigateHistoryUsingKeys=function(pressed_key,back_key,forward_key,input_must_be_empty){var input_is_empty=TS.utility.contenteditable.value(document.activeElement)==="";if(TS.utility.isFocusOnInput()&&(input_is_empty||!input_must_be_empty)||document.activeElement==document.body){TS.clog.track("HISTORY_NAV_ACTION",{trigger:"keyboard_shortcut",action:"nav_prev_next"});if(pressed_key===back_key){window.history.go(-1)}else if(pressed_key===forward_key){window.history.go(1)}}};var _updateUserActive=function(){TS.model.client.last_user_active_timestamp=new Date};var _channelDataUpdated=function(model_ob){if(model_ob.id!=TS.model.active_cid)return;TS.client.msg_pane.displayTitle();TS.client.msg_pane.rebuildChannelMembersList()};var _isMsgGoodForReaction=function(msg){return msg&&!TS.utility.msgs.isTempMsg(msg)&&!msg.is_ephemeral};var _rebuildBackFromMemberorUserGroupPreview=function(origin,$back){$back.unbind();if(origin=="file_list"||origin=="file_preview"){$back.html(TS.templates.builders.filePreviewBackIcon()+" Files").bind("click.back",function(){TS.client.ui.flex.openFlexTab("files")})}else if(origin=="search_results"){$back.html(TS.templates.builders.filePreviewBackIcon()+" Search Results").bind("click.back",function(){TS.client.ui.flex.openFlexTab("search")})}else if(origin=="im_page"){$back.html(TS.templates.builders.filePreviewBackIcon()+" Conversation Details").bind("click.back",function(){TS.client.ui.flex.openFlexTab("details")})}else if(origin=="groups"&&TS.boot_data.feature_searchable_member_list){$back.html(TS.templates.builders.filePreviewBackIcon()+" User Groups").bind("click.back",function(){TS.client.ui.showGroupsList()})}else{$back.html(TS.templates.builders.filePreviewBackIcon()+(TS.boot_data.feature_team_to_org_directory&&TS.boot_data.page_needs_enterprise?" Organization Directory":"Team Directory")).bind("click.back",function(){TS.client.ui.showTeamList()})}};var _roomAdded=function(room){_rebuildRoomAttachments(room)};var _roomNameChanged=function(room){_rebuildRoomAttachments(room)};var _roomParticipantsChanged=function(room){_rebuildRoomAttachments(room)};var _roomEndedChanged=function(room){_rebuildRoomAttachments(room)};var _roomChannelsChanged=function(room){_rebuildRoomAttachments(room)};var _rebuildRoomAttachments=function(room){var $room=$("."+TS.templates.makeSHRoomClass(room.id));if(!$room.length)return;$room.replaceWith(TS.templates.builders.buildSHRoomAttachment(room))};var _findScrollTargetForChannelScroller=function($channels_scroller,$channels_scroll_clicked){if($channels_scroll_clicked.hasClass("unseen_have_mentions")){return $channels_scroller.find("li.mention")}else{return $channels_scroller.find("li.unread:not(.all_unreads)")}};var _maybeUpdateCallAction=function(){if(TS.model.ui.active_tab_id==="team"&&TS.model.previewed_member_id){TS.client.ui._displayMember(TS.model.previewed_member_id)}};var _throttledFilePreviewInline=_.throttle(function(){TS.client.ui.checkInlineImgsAndIframes("file_preview")},150);var _pending_unfurl_id=0;var _displayUserGroupInFlight;var _previous_memory_usage_team_mb=0;var _memory_instrument_interval=null;var _scrolled_to_msg_timeout=null;var _rebuildMemoryInstrument=function(){var combined_stats=TS.metrics.getMemoryUsage();if(!combined_stats||!combined_stats.memory){TS.warn("_rebuildMemoryInstrument: Unable to get memory stats. Clearing interval and exiting.");return _removeMemoryInstrument()}var memory_usage_team_mb=Math.floor(TS.utility.convertKilobytesToMegabytes(combined_stats.memory.privateBytes+combined_stats.memory.sharedBytes));var delta=0;if(_previous_memory_usage_team_mb>0){delta=Math.floor(memory_usage_team_mb-_previous_memory_usage_team_mb)}var html=TS.templates.memory_instrument({memory_usage_team_mb:memory_usage_team_mb,delta:delta});if(!$("ts-memory-instrument").length){$("body").append(html)}else{$("ts-memory-instrument").replaceWith(html)}_previous_memory_usage_team_mb=memory_usage_team_mb};var _setMemoryInstrumentInterval=function(){if(!TS.model.is_electron)return;_memory_instrument_interval=setInterval(function(){_rebuildMemoryInstrument()},5e3)};var _removeMemoryInstrument=function(){clearInterval(_memory_instrument_interval);$("ts-memory-instrument").remove()};var _onMemoryInstrumentPrefChanged=function(){if(!TS.model.is_electron)return;if(TS.model.prefs.show_memory_instrument){_setMemoryInstrumentInterval();_rebuildMemoryInstrument()}else{_removeMemoryInstrument()}};var _onDisplayEmailAddressesPrefChanged=function(){TS.shared.onDisplayEmailAddressesPrefChanged()};var _renderMember=function(member,origin){if(TS.viewmodel&&TS.viewmodel.teamdirectory&&!TS.model.submodel){throw new Error("_renderMember expects to be called with an active submodel")}var $member_preview=$("#member_preview_container");var expanded=TS.model.previewed_member_id===member.id&&!$member_preview.find(".cropped_preview").length||origin=="menu_member_header"||TS.model.ui_state.expand_member_images_in_flexpane;TS.model.previewed_member_name=member.name;TS.model.previewed_member_id=member.id;TS.info("TS.model.previewed_member_name:"+TS.model.previewed_member_name);var html;var can_invite_to_group=!member.is_slackbot;if(member.is_ultra_restricted||TS.model.user.is_ultra_restricted){can_invite_to_group=false}var can_invite_to_channel=!member.is_slackbot;if(member.is_ultra_restricted||TS.model.user.is_ultra_restricted){can_invite_to_channel=false}else if(!TS.model.user.is_admin&&member.is_restricted){can_invite_to_channel=false}var im=TS.ims.getImByMemberId(member.id);var show_bot_configuration=member.is_bot&&TS.model.user.is_admin;var bot_configure_url;if(show_bot_configuration){bot_configure_url="/services/"+member.profile.bot_id;bot_configure_url=TS.bots.configureUrl(member)}var template_args={member:member,show_bot_configuration:show_bot_configuration,hide_more_menu:!im&&!member._has_files_or_we_dont_know&&!can_invite_to_channel&&!can_invite_to_group&&!can_invite_to_group,bot_configure_url:bot_configure_url,show_call_action:TS.boot_data.feature_calls&&TS.utility.calls.isEnabled()&&!member.is_bot&&member.id!="USLACKBOT"};if(TS.boot_data.page_needs_enterprise){var team=TS.model.team;if(team&&team.id!==member.team_id)template_args.show_call_action=false;if(!member.is_self){var shared_teams=TS.enterprise.getTeamsForMember(member,true);template_args.teams=shared_teams}}html=TS.templates.team_member_preview(template_args);if(member.deleted){TS.api.callImmediately("im.list").then(function(response){if(response.data.ims){if(_.find(response.data.ims,function(im){return im.user==member.id})){$("#member_deleted_view_archives_btn").removeClass("hidden")}}})}$("#user_group_preview_container").hideWithRememberedScrollTop();$("#team_list_container").hideWithRememberedScrollTop();$member_preview.unhideWithRememberedScrollTop();var $member_preview_scroller=$("#member_preview_scroller");$member_preview_scroller.html(html);TS.utility.makeSureAllLinksHaveTargets($member_preview_scroller);if(TS.model.last_previewed_member_id!=TS.model.previewed_member_id){$("#member_preview_scroller").scrollTop(0)}TS.model.last_previewed_member_id=member.id;var $back_from_member_preview=$("#back_from_member_preview");_rebuildBackFromMemberorUserGroupPreview(origin,$back_from_member_preview);TS.view.resizeManually("TS.client.ui._displayMember");$member_preview_scroller.find(".member_details .member_image").click(function(e){_toggleCroppedMemberImage(this);return false});$member_preview_scroller.find(".member_preview_menu_target").click(function(e){TS.menu.member.startWithMemberPreview(e,member.id,false,true)});if(expanded)_toggleCroppedMemberImage($member_preview.find(".member_image"));if(TS.boot_data.feature_user_custom_status){if(member.is_self){TS.client.ui.current_status_input.bindEvents()}}}})();(function(){"use strict";TS.registerModule("client.ui.files",{$file_btn:null,onStart:function(){TS.files.team_file_comment_added_sig.add(TS.client.ui.files.teamFileCommentAdded);TS.files.team_file_comment_edited_sig.add(TS.client.ui.files.teamFileCommentEdited);TS.files.team_file_comment_deleted_sig.add(TS.client.ui.files.teamFileCommentDeleted);TS.files.team_file_changed_sig.add(TS.client.ui.files.teamFileChanged);TS.files.team_file_deleted_sig.add(TS.client.ui.files.teamFileDeleted);function _bindUI(){TS.client.ui.files.bindUploadUI();TS.client.ui.files.bindFileUI();TS.files.media.bindVideoElements({container:"#msgs_div",onError:_onVideoError})}TS.log(82,"deferring UI bind until login_sig");TS.client.login_sig.add(function(){TS.utility.queueRAF(_bindUI)})},preview_file_waiting_on:null,showFilesFromHistory:function(file_id){if(!file_id){TS.client.ui.files._displayFileList();TS.client.flexDisplaySwitched("files",null,false,true);return}var file=TS.files.getFileById(file_id);if(file){TS.client.ui.files._displayFile(file.id);TS.client.flexDisplaySwitched("files",file.id,false,true);TS.files.fetchFileInfo(file_id)}else{TS.client.ui.files.preview_file_waiting_on=file_id;TS.files.fetchFileInfo(file_id,function(id,file){if(id!=TS.client.ui.files.preview_file_waiting_on)return;TS.client.ui.files.preview_file_waiting_on=null;if(file){TS.client.ui.files._displayFile(file.id);TS.client.flexDisplaySwitched("files",file.id,false,true)}else{TS.client.ui.files._displayFileList();TS.client.flexDisplaySwitched("files",null,true)}})}},_displayFile:function(id,origin,channel_id){var file=TS.files.getFileById(id);if(!file)return false;if(!TS.client.ui.flex._displayFlexTab("files"))return false;TS.client.ui.files._rebuildBackFromFilePreview(origin);TS.model.previewed_file_id=id;if(TS.boot_data.feature_fast_files_flexpane)TS.view.files.hideList();$("#file_list_container").hideWithRememberedScrollTop();if(TS.boot_data.feature_share_mention_comment_cleanup){if(channel_id){_displayFileCommentView(file,channel_id)}else{_displayFileDetailView(file)}}else{$("#file_preview_container").unhideWithRememberedScrollTop();TS.client.ui.files.rebuildFilePreview(file);$("#file_preview_scroller").scrollTop(0)}$("#file_comment_form").css("visibility","");TS.view.resizeManually("TS.client.ui.files._displayFileList");return true},_displayFileList:function(){if(!TS.client.ui.flex._displayFlexTab("files",true))return false;TS.model.previewed_file_id="";$("#file_preview_container").hideWithRememberedScrollTop();$("#file_list_container").unhideWithRememberedScrollTop();if(TS.boot_data.feature_fast_files_flexpane)TS.view.files.unHideList();TS.view.resizeManually("TS.client.ui.files._displayFileList");return true},rebuildFilePreview:function(file){var member;if(file.user&&file.user==="USLACKBOT"&&file.bot_id){member=TS.bots.getBotById(file.bot_id);member.is_bot=true;member.is_service=true}else{member=TS.members.getMemberById(file.user)}var template_args=TS.files.getFileActions(file);template_args.file=file;template_args.member=member;template_args.user=TS.model.user;template_args.show_open_public_link=!TS.model.team.prefs.disallow_public_file_urls;template_args.show_revoke_public_link=!TS.model.team.prefs.disallow_public_file_urls&&template_args.revoke_public_link;if(file.mode=="email"){template_args.to_more_count=file.to.length-1;template_args.cc_more_count=file.cc.length-1}if(file&&file.id){if(file.mode=="snippet"||file.mode=="post"||file.mode=="space"){if(!file.content&&!file.content_html&&!file.content_highlight_html){TS.files.fetchFileInfo(file.id)}}}$.extend(template_args,TS.files.getFileTemplateArguments(file));var $file_preview_scroller=$("#file_preview_scroller").find("#file_preview_head_section");if(template_args.video_height)template_args.video_height=TS.model.native_video_embed_height_flexpane;var preview_title_html=TS.templates.file_preview_title(template_args);var preview_file_html=TS.templates.file_preview_file(template_args);var preview_meta_html=TS.templates.file_preview_meta(template_args);var is_inline_media_and_has_state=false;if(TS.boot_data.feature_inline_media_playback&&TS.files.fileIsHostedSupportedMedia(file)&&file.id===TS.model.previewed_file_id){var $media_jq_element;if(TS.files.fileIsSupportedAudio(file)){$media_jq_element=$file_preview_scroller.find("audio")}else if(TS.files.fileIsSupportedVideo(file)){$media_jq_element=$file_preview_scroller.find("video")}if($media_jq_element.length){var media_element=$media_jq_element[0];var is_playing=!media_element.paused;var is_at_start=media_element.currentTime===0;var is_at_end=media_element.currentTime===media_element.duration;if(is_playing||!is_at_start&&!is_at_end){is_inline_media_and_has_state=true}}}if(is_inline_media_and_has_state){$file_preview_scroller.find(".file_preview_title").replaceWith(preview_title_html);$file_preview_scroller.find(".file_preview_meta").replaceWith(preview_meta_html)}else{var preview_head_html=preview_title_html+preview_file_html+preview_meta_html;$file_preview_scroller.html(preview_head_html)}TS.utility.makeSureAllLinksHaveTargets($file_preview_scroller);if(file.mode=="space")TS.client.ui.unfurlPlaceholders($file_preview_scroller);template_args={file:file};var file_preview_comments_section=$("#file_preview_scroller").find("#file_preview_comments_section");file_preview_comments_section.html(TS.templates.comments(template_args));TS.utility.makeSureAllLinksHaveTargets(file_preview_comments_section);if(file.id!=TS.model.last_previewed_file_id)$("#file_comment_form #file_comment").val(TS.storage.fetchLastCommentInput(file.id)).trigger("keyup");if(file.mode=="email"){}TS.model.last_previewed_file_id=file.id;if(file.content&&file.mode=="snippet"){$("#truncated_message").addClass("hidden");var wrap_long_lines=!!TS.model.code_wrap_long_lines;var $control_for_wrap=$("#snippet_wrap");var $el_to_wrap=$control_for_wrap.closest("label").prevAll(".snippet_container");$control_for_wrap.bind("change",function(e){TS.model.code_wrap_long_lines=$(this).prop("checked");if(TS.model.code_wrap_long_lines){$el_to_wrap.addClass("snippet_wrap")}else{$el_to_wrap.removeClass("snippet_wrap")}});if(wrap_long_lines){$control_for_wrap.prop("checked","checked");$el_to_wrap.addClass("snippet_wrap")}}TS.ui.utility.updateClosestMonkeyScroller($("#file_preview_scroller"));_displayFileCommentHelpText(file);if($("#file_comment").is(":focus")||TS.utility.getActiveElementProp("id")=="file_comment"){$("#file_comment_submit_btn").scrollintoview({offset:"bottom",px_offset:-50,duration:0})}},cleanFilePreview:function(){$("#file_preview_head_section").empty();$("#file_preview_comments_section").empty()},_rebuildBackFromFilePreview:function(origin){var $back=$("#back_from_file_preview");$back.unbind();if(origin=="member_preview"){$back.html(TS.templates.builders.filePreviewBackIcon()+" Team Member");$back.bind("click.back",function(){TS.client.ui.previewMember(TS.model.last_previewed_member_id)});$back.data("origin",origin)}else if(origin=="starred_items"){$back.html(TS.templates.builders.filePreviewBackIcon()+" Starred Items");$back.bind("click.back",function(){TS.client.ui.flex.openFlexTab("stars")});$back.data("origin",origin)}else if(origin=="search_results"){$back.html(TS.templates.builders.filePreviewBackIcon()+" Search Results");$back.bind("click.back",function(){TS.search.view.showResults();TS.search.view.maybeRebuildResults()});$back.data("origin",origin)}else if(origin=="channel_page"){$back.html(TS.templates.builders.filePreviewBackIcon()+" Channel Details");$back.bind("click.back",function(){TS.client.ui.flex.openFlexTab("details")});$back.data("origin",origin)}else if(origin=="group_page"){$back.html(TS.templates.builders.filePreviewBackIcon()+" Channel Info");$back.bind("click.back",function(){TS.client.ui.flex.openFlexTab("details")});$back.data("origin",origin)}else if(origin=="im_page"){$back.html(TS.templates.builders.filePreviewBackIcon()+" Conversation Details");$back.bind("click.back",function(){TS.client.ui.flex.openFlexTab("details")});$back.data("origin",origin)}else{$back.html(TS.templates.builders.filePreviewBackIcon()+" Files");$back.bind("click.back",function(){TS.client.ui.files.showFileList();TS.client.flex_pane.maybeFetchFileList()});$back.data("origin",origin)}},previewFile:function(id,origin,no_refetch,focus_comment_input,channel_id){var file=TS.files.getFileById(id);if(TS.model.ui_state.flex_visible&&TS.model.previewed_file_id===id&&!$("#file_preview_scroller").is(":hidden")){$("#file_preview_scroller").highlight(1500,"flex_highlight",false,0)}if(!file){TS.client.ui.files.preview_file_waiting_on=id;TS.files.fetchFileInfo(id,function(id,file){if(id!=TS.client.ui.files.preview_file_waiting_on)return;TS.client.ui.files.preview_file_waiting_on=null;if(file){TS.client.ui.files.previewFile(file.id,origin,true,channel_id)}else{TS.generic_dialog.alert("This file can't be found.","Sorry, that didn't work")}});return}if(!TS.client.ui.files._displayFile(id,origin,channel_id))return;TS.client.flexDisplaySwitched("files",id);if(focus_comment_input)$("#file_comment").focus();if(!no_refetch)TS.files.fetchFileInfo(id)},teamFileCommentAdded:function(file,comment){if(_isFileOpen(file))TS.client.ui.files.appendFileComment(file,comment);if(TS.boot_data.feature_share_mention_comment_cleanup)TS.files.resetFileCommentsGroup(file)},teamFileCommentEdited:function(file,comment){if(_isFileOpen(file))TS.client.ui.files.updateFileComment(file,comment);if(TS.boot_data.feature_share_mention_comment_cleanup)TS.files.resetFileCommentsGroup(file)},teamFileCommentDeleted:function(file,comment_id){if(_isFileOpen(file)){TS.ui.comments.removeFileComment(file,comment_id,function(){TS.ui.utility.updateClosestMonkeyScroller($("#file_preview_scroller"))})}if(TS.boot_data.feature_share_mention_comment_cleanup)TS.files.resetFileCommentsGroup(file)},teamFileChanged:function(file){if(TS.model.ui.active_tab_id=="files"&&TS.model.previewed_file_id==file.id)TS.client.ui.files.rebuildFilePreview(file);if(TS.boot_data.feature_share_mention_comment_cleanup)TS.files.resetFileCommentsGroup(file)},teamFileDeleted:function(file){if(TS.model.ui.active_tab_id=="files"&&TS.model.previewed_file_id==file.id)TS.client.ui.files.showFileList();if(TS.boot_data.feature_share_mention_comment_cleanup)TS.files.resetFileCommentsGroup(file)},storeLastCommentInputForPreviewedFile:function(txt){if(!TS.model.previewed_file_id)return;TS.storage.storeLastCommentInput(TS.model.previewed_file_id,txt)},bindFileUI:function(){$("#file_list_heading").bind("click.show_menu",function(e){e.preventDefault();TS.menu.file.startWithFileFilter(e)});$("#file_list_clear_filter").bind("click.clear_filter",function(e){e.stopPropagation();TS.view.files.clearFilter()});$("#file_list_toggle_all").bind("click.toggleList",function(){TS.client.ui.files.toggleFileList("all")});$("#file_list_toggle_user").bind("click.toggleList",function(e){if(e.isDefaultPrevented())return;var filter_user=$("#file_list").data("filter-user");if(filter_user){TS.client.ui.files.toggleFileList(filter_user)}else{TS.client.ui.files.toggleFileList(TS.model.user.id)}});$("#file_list_toggle_users").bind("click.show_menu",function(e){e.preventDefault();if(TS.boot_data.page_needs_enterprise){
TS.menu.file.startWithFileMemberPromiseFilter(e)}else{TS.menu.file.startWithFileMemberFilter(e)}})},showFileList:function(){if(!TS.client.ui.files._displayFileList())return;$("#search_tabs").hide();TS.client.flexDisplaySwitched("files")},filterFileList:function(filter){if(filter=="all"){TS.model.active_file_list_filter=filter;TS.view.files.clearFilter()}else if(filter=="user"){TS.view.files.clearFilter();TS.client.ui.files.toggleFileList(TS.model.user.id)}else if(TS.utility.strLooksLikeAMemberId(filter)){TS.client.ui.files.toggleFileList(filter)}else{TS.model.active_file_list_filter=filter;TS.view.file_list_heading=TS.model.file_list_type_map[filter];TS.model.file_list_types=[filter];TS.view.files.filterSet();$("#file_list_clear_filter").removeClass("hidden")}},toggleFileList:function(id){var $file_list=$("#file_list"),$file_list_toggle_all=$("#file_list_toggle_all"),$file_list_toggle_user=$("#file_list_toggle_user"),$file_list_toggle_users=$("#file_list_toggle_users");if($file_list.data("list")==id)return;$file_list.data("list",id);if(id=="all"){TS.model.active_file_list_member_filter="all";$file_list_toggle_user.removeClass("active").find("a").text("Just You");$file_list_toggle_users.removeClass("active");$file_list_toggle_all.addClass("active");$file_list.data("filter-user",TS.model.user.id)}else{var member=TS.members.getMemberById(id);if(member){TS.model.active_file_list_member_filter=id;$file_list_toggle_all.removeClass("active");$file_list_toggle_user.addClass("active");$file_list_toggle_users.addClass("active");if(member.id==TS.model.user.id){$file_list_toggle_user.find("a").text("Just You")}else{$file_list_toggle_user.find("a").text(TS.members.getMemberDisplayName(member))}$file_list.data("filter-user",id)}else{TS.error(id+" is not valid?")}}TS.view.files.filterSet()},submitFileComment:function(bypass_at_warning_check){var $file_comment=$("#file_comment_form #file_comment");var comment_unclean=$file_comment.val();var comment=TS.format.cleanMsg(comment_unclean);if(!$.trim(comment)){TS.sounds.play("beep");return}var file_id=TS.model.previewed_file_id;var c_id=$file_comment.closest("[data-model-ob-id]").attr("data-model-ob-id");if(TS.ui.fs_modal_file_viewer.is_showing){file_id=TS.ui.fs_modal_file_viewer.getCurrentFileId()}var file=TS.files.getFileById(file_id);if(!file){TS.error("no file to submit comment");return}var key_word=TS.ui.needToBlockAtChannelKeyword(comment_unclean,file);if(key_word){TS.generic_dialog.alert("<p>A Team Owner has restricted the use of <b>"+TS.utility.htmlEntities(key_word)+"</b> messages.</p>");return}if(!bypass_at_warning_check){var channels_and_groups_shared_to=file.channels.concat(file.groups);var channels_and_groups_included_in_dialog=channels_and_groups_shared_to.filter(function(channel_id){return TS.ui.needToShowAtChannelWarning(channel_id,comment_unclean)});if(channels_and_groups_included_in_dialog.length>0){TS.ui.at_channel_warning_dialog.startInFlexPane(file,channels_and_groups_included_in_dialog,comment_unclean);return}}$("#file_comment_form #file_comment").val("").trigger("keyup");TS.files.addComment(file_id,comment,c_id,function(ok,data,args){if(ok){TS.storage.storeLastCommentInput(args.file,"")}else{alert("error: comment not added to file");if(args.file==TS.model.last_previewed_file_id){$("#file_comment_form #file_comment").val(TS.storage.fetchLastCommentInput(args.file)).trigger("keyup")}}})},appendFileComment:function(file,comment){var $div=$(".file_comments_"+file.id);$div.append(TS.templates.builders.buildCommentHTML({file:file,comment:comment,show_comment_actions:true}));TS.utility.makeSureAllLinksHaveTargets($div);if(comment.user==TS.model.user.id){$("#file_comment_submit_btn").scrollintoview({offset:"bottom",px_offset:-50,duration:0})}var $scroller;if(TS.boot_data.feature_share_mention_comment_cleanup){$scroller=$(".file_comments_scroller")}else{$scroller=$("#file_preview_scroller")}TS.ui.utility.updateClosestMonkeyScroller($scroller)},updateFileComment:function(file,comment){var $comment_divs=$('.comment[data-comment-id="'+comment.id+'"]');if(!$comment_divs.length)return;$comment_divs.replaceWith(TS.templates.builders.buildCommentHTML({file:file,comment:comment,show_comment_actions:true}));$comment_divs.each(function(){TS.utility.makeSureAllLinksHaveTargets($(this))});TS.ui.utility.updateClosestMonkeyScroller($("#file_preview_scroller"))},validateFiles:function(upload_files,immediate_upload,validateCallback){if(!upload_files)return;immediate_upload=!!immediate_upload;var good_files=[];var selected_file_count=0;var expected_file_count=0;var files_dispatched=false;var files_checked=false;var unsupported_types={};var excluded_files=[];function updateExpectedFileCount(quantity){expected_file_count=Math.max(0,expected_file_count+quantity)}function resetFiles(){good_files=[];expected_file_count=0;selected_file_count=0;files_dispatched=false;files_checked=false}if(!TS.client.ui.resetFiles)TS.client.ui.resetFiles=resetFiles;function dispatchFiles(){if(!files_dispatched){if(good_files.length){files_dispatched=true;TS.client.ui.file_dropped_sig.dispatch(good_files,immediate_upload)}}}function checkFiles(){if(files_checked)return false;if(selected_file_count>0&&(good_files.length>=expected_file_count||expected_file_count<=0)){files_checked=true;if(excluded_files.length){maybeShowSupportDialog(upload_files,function(){if(validateCallback){validateCallback(good_files,dispatchFiles)}else{dispatchFiles()}})}else{if(validateCallback){validateCallback(good_files,dispatchFiles)}else{dispatchFiles()}}}}function fileHasLoaded(file){good_files.push(file)}function resetReader(reader){reader.onload=reader.onerror=null;return null}function directoryFallbackTest(file,callback){var reader,result;result={isFile:null,isDirectory:null};if(file.size<16384&&window.FileReader){reader=new FileReader;reader.onload=function(e){reader=resetReader(e.currentTarget);result.isFile=true;callback(result)};reader.onerror=function(e){reader=resetReader(e.currentTarget);result.isDirectory=true;callback(result)};try{reader.readAsDataURL(file)}catch(err){reader=resetReader(reader);result.isDirectory=true;callback(result)}}else{callback(result)}}function isUnsupportedType(file_object,entry_object,callback){var unsupported_item,result,period,extension,file_name;result=false;file_name=file_object.name||entry_object.name;if(!file_name)return false;period=file_name.lastIndexOf(".");if(period!==-1)extension=file_name.substr(period);if(extension)unsupported_item=unsupported_types[extension]&&unsupported_types[extension].enabled?unsupported_types[extension]:null;if(entry_object&&(entry_object.isFile||entry_object.isDirectory)){if(entry_object.isDirectory||entry_object.isFile&&unsupported_item&&unsupported_item.applyToFile){result=true;return callback(result)}else{result=false;return callback(result)}}else{directoryFallbackTest(file_object,function(test_result){if(test_result.isDirectory){result=true}else{if(unsupported_item&&unsupported_item.applyToFile){result=true}}return callback(result)})}}function maybeShowSupportDialog(file_list,onGoCallback){var i,j,file_names,good_files,title,file_html,suggestions_html,dont_worry_html;if(excluded_files.length){file_names=[];title="File unsupported";file_html="";dont_worry_html="";for(i=0,j=excluded_files.length;i<j;i++){file_names.push("<li><b>"+TS.utility.htmlEntities(excluded_files[i].name)+"</b></li>")}if(excluded_files.length>1){title=excluded_files.length===selected_file_count?"All files unsupported":"Some files unsupported";file_html="<ul>"+file_names.join("\n")+"</ul>"}good_files=selected_file_count-excluded_files.length;suggestions_html="<p>"+(excluded_files.length===1?"Try uploading a .zip version of this file instead.":"Try uploading .zip versions of these files instead.")+"</p>";if(good_files)dont_worry_html="<p>(Don't worry, your other "+(good_files>1?"files are next.":"file is next.")+")</p>";TS.generic_dialog.start({title:title,body:"<p>Sorry, "+(excluded_files.length===1?"<b>"+TS.utility.htmlEntities(excluded_files[0].name)+"</b> is a type of file not ":excluded_files.length===selected_file_count?" none of those file types are":" some of those file types are not")+" supported by Slack.</p>"+file_html+suggestions_html+dont_worry_html,show_cancel_button:false,esc_for_ok:true,onGo:function(){TS.generic_dialog.end();if(onGoCallback)onGoCallback()}})}return excluded_files.length}function loadFiles(files){selected_file_count=files.length;updateExpectedFileCount(files.length);var file,entry,file_object,entry_object;for(var i=0;i<files.length;i++){file=files[i];file_object=file;entry_object=file;if(file.isFile||file.isDirectory){entry=file;entry_object=file}if(file.getAsEntry){entry=file.getAsEntry();entry_object=entry}else if(file.webkitGetAsEntry){entry=file.webkitGetAsEntry();entry_object=entry}if(typeof file.getAsFile==="function"){file_object=file.getAsFile()}else if(File&&file instanceof File){file_object=file}if(!entry_object||!file_object)updateExpectedFileCount(-1);(function(local_file,local_entry){isUnsupportedType(local_file,local_entry,function(unsupported){if(unsupported){if(local_entry.name){excluded_files.push(local_entry)}else{excluded_files.push(local_file)}updateExpectedFileCount(-1);checkFiles()}else{if(local_file.size===0){updateExpectedFileCount(-1)}else{fileHasLoaded(local_file)}checkFiles()}})})(file_object,entry_object)}}loadFiles(upload_files);checkFiles()},bindUploadUI:function(){if(!TS.client.ui.files.$upload)TS.client.ui.files.$upload=TS.boot_data.feature_new_msg_input?$("#file_upload"):$("#file-upload");$(".file_upload_btn").bind("click.file_menu",function(e){if(TS.client.ui.shouldIgnoreClick(e))return false;TS.menu.file.startWithNewFileOptions(e,$(this));return false});TS.client.ui.files.$upload.bind("change",function(){if(!$(this).val())return;var files=$(this)[0].files;if(files){if(!files.length)return;TS.view.filesSelected(files);TS.client.ui.files.$upload.val("")}});$("body").bind("drop",function(e){window.focus();e.preventDefault();$("body").removeClass("drop-target");if(TS.boot_data.feature_take_profile_photo){if($("body").find("#edit_member_profile_container").length>0){var files;var data_transfer=e.originalEvent.dataTransfer;if(data_transfer)files=data_transfer.files||data_transfer.items;if(!files)return;TS.ui.edit_member_profile.handleDrop(files);return}}if(TS.client.ui.checkForEditing(e))return;if(TS.model.team.prefs.disable_file_uploads==="disable_all"){TS.generic_dialog.start({title:"Upload failed",body:"At the request of your administrator, file uploads have been disabled on this team.",show_cancel_button:false,onGo:function(){TS.files.uploadOver(false)}});return}var files;var shift_key=e&&e.shiftKey;if(window.winssb&&window.winssb.app.getModifierKeys){var modifiers=window.winssb.app.getModifierKeys();shift_key=modifiers&&modifiers.shift}var model_ob=TS.shared.getActiveModelOb();if(model_ob&&model_ob.is_general&&!TS.members.canUserPostInGeneral()){TS.generic_dialog.start({title:"Cannot Post To General",body:"An Owner of your team has limited who can post to #<strong>general</strong>. Nothing personal! You can share your file in another channel.",show_cancel_button:false,go_button_text:"Okay!"});return false}if(model_ob&&TS.boot_data.page_needs_enterprise&&!TS.permissions.members.canPostInChannel(model_ob)&&model_ob.is_shared){TS.generic_dialog.start({title:"Cannot Post To #"+model_ob.name+' <ts-icon class="ts_icon_org_shared_channel"></ts-icon>',body:"An Owner of your team has limited who can post to <strong>#"+model_ob.name+'<ts-icon class="ts_icon_shared_channel"></ts-icon></strong>. Nothing personal! You can share your file in another channel.',show_cancel_button:false,go_button_text:"Okay!"});return false}if(TS.model.archive_view_is_showing&&TS.client.archives.current_model_ob.is_archived){shift_key=false}var data_transfer=e.originalEvent.dataTransfer;if(data_transfer)files=data_transfer.files||data_transfer.items;if(!files)return;TS.client.ui.files.validateFiles(files,shift_key)});$("#drop-zone").unbind("click.dismiss").bind("click.dismiss",function(){$("body").removeClass("drop-target")});$(window).draghover().on({draghoverstart:function(e,dragenter_e,winssb_file){if(window.winssb)TS.info("draghoverstart winssb_file:"+winssb_file);if(TS.model.ui.is_mouse_down)return;var has_files=false;if(dragenter_e&&dragenter_e.originalEvent&&dragenter_e.originalEvent.dataTransfer&&dragenter_e.originalEvent.dataTransfer.types){var types=dragenter_e.originalEvent.dataTransfer.types;for(var i=0;i<types.length;i++){if(types[i].toLowerCase()=="files"){has_files=true;break}}}if(!has_files)has_files=!!winssb_file;if(!has_files)return;if(TS.boot_data.feature_take_profile_photo){if($("body").find("#edit_member_profile_container").length>0){$("body").addClass("drop-target");TS.ui.edit_member_profile.handleDrag(true);return}}if($("body").hasClass("file_snippet"))return;if(TS.model.team.prefs.disable_file_uploads==="disable_all")return;if(TS.msg_edit.editing)return false;var model_ob=TS.shared.getActiveModelOb();if(model_ob&&model_ob.is_general&&!TS.members.canUserPostInGeneral())return false;$("body").addClass("drop-target");if(TS.ui.fs_modal.is_showing)TS.ui.fs_modal.deactivate()},draghoverend:function(){$("body").removeClass("drop-target");if(TS.boot_data.feature_take_profile_photo){if($("body").find("#edit_member_profile_container").length>0){TS.ui.edit_member_profile.handleDrag(false);return}}if(TS.ui.fs_modal.is_showing){TS.ui.fs_modal.activate()}}})}});Object.defineProperty(TS.client.ui.files,"$file_btn",{get:function(){delete TS.client.ui.files.$file_btn;TS.client.ui.files.$file_btn=$("#primary_file_button");return TS.client.ui.files.$file_btn}});var _isFileOpen=function(file){var is_file_open_in_flexpane=TS.model.ui.active_tab_id=="files"&&TS.model.previewed_file_id==file.id;var is_file_open_in_fsfv=file.id===TS.ui.fs_modal_file_viewer.getCurrentFileId();return is_file_open_in_flexpane||is_file_open_in_fsfv};var _displayFileDetailView=function(file){$(".file_comments_container").hideWithRememberedScrollTop();$(".file_details_container").unhideWithRememberedScrollTop();_rebuildFileDetailsView(file);$(".file_details_scroller").scrollTop(0)};var _displayFileCommentView=function(file,channel_id){$(".file_details_container").hideWithRememberedScrollTop();$(".file_comments_container").unhideWithRememberedScrollTop();_rebuildFileCommentsView(file,channel_id);$(".file_comments_scroller").scrollTop(0)};var _displayFileCommentHelpText=function(file){$(".file_comment_tip").text(TS.templates.builders.makeFileCommentHelpText(file))};var _rebuildFileDetailsView=function(file){var template_args=$.extend(TS.files.getFileDetailsMetaTemplateArguments(file),TS.files.getFileTemplateArguments(file));if(template_args.video_height)template_args.video_height=TS.model.native_video_embed_height_flexpane;var file_details_meta_html=TS.templates.file_details_meta(template_args);var $file_details_meta=$(".file_details_scroller").find(".file_details_meta");$file_details_meta.html(file_details_meta_html);TS.utility.makeSureAllLinksHaveTargets($file_details_meta);if(file.mode=="space"){TS.client.ui.unfurlPlaceholders($file_details_meta)}TS.files.createFileCommentsGroup(file);var file_details_share_to_html=TS.templates.file_details_share_to(file);var $file_details_share_to=$(".file_details_scroller").find(".file_details_share_to");$file_details_share_to.html(file_details_share_to_html);TS.utility.makeSureAllLinksHaveTargets($file_details_share_to);TS.model.last_previewed_file_id=file.id;TS.ui.utility.updateClosestMonkeyScroller($(".file_details_scroller"))};var _rebuildFileCommentsView=function(file,c_id){TS.files.createFileCommentsGroup(file);var massaged_file=jQuery.extend(true,{},file);var comment_group=massaged_file._comments_grouped[c_id];massaged_file.comments=comment_group.comments;var template_args={file:massaged_file,comment_group:comment_group,c_id:c_id};$.extend(template_args,TS.files.getFileTemplateArguments(file));var $file_comments_scroller=$(".file_comments_scroller");var file_comments_html=TS.templates.file_comments(template_args);var $file_comments=$file_comments_scroller.find(".file_comments");$file_comments.html(file_comments_html);$(".back_from_file_comments").attr("data-file-id",massaged_file.id);$file_comments_scroller.attr("data-model-ob-id",c_id);var monkey_scroll=$file_comments_scroller.data("monkeyScroll");if(monkey_scroll){monkey_scroll.updateFunc()}};var _onVideoError=function($el){$el.addClass("hidden")}})();(function(){"use strict";TS.registerModule("client.ui.flex",{onStart:function(){TS.client.flexpane_display_switched_sig.add(_flexpaneDisplaySwitched);function _bindUI(){TS.client.ui.flex.bindFlexUI()}TS.log(82,"deferring UI bind until login_sig");TS.client.login_sig.add(function(){TS.utility.queueRAF(_bindUI)})},bindFlexUI:function(){var $header=$("#client_header");$("#col_flex").delegate(".close_flexpane","click",function(){if(TS.model.ui_state.flex_visible){if(TS.model.ui_state.flex_name==="search"){TS.clog.track("SEARCH_CLOSE",{})}else if(TS.boot_data.feature_clog_whats_new&&TS.model.ui_state.flex_name==="whats_new"){TS.clog.track("WHATSNEW_ACTION",{action:"close_pane",trigger:"close_flexpane"})}TS.client.ui.flex.hideFlex()}});$header.delegate("#flex_menu_toggle","click",function(e){if(TS.client.ui.shouldIgnoreClick(e))return false;TS.menu.startWithFlexMenu(e);TS.client.downloads.maybeShowFlexMenuProgBar()});$header.delegate("#details_toggle","click",function(e){if(TS.client.ui.shouldIgnoreClick(e))return false;if(TS.boot_data.feature_clog_whats_new&&TS.model.ui_state.flex_name==="whats_new"){TS.clog.track("WHATSNEW_ACTION",{action:"close_pane",trigger:"details_toggle"})}_toggleFlexTab("details")});$header.delegate("#recent_mentions_toggle","click",function(e){if(TS.client.ui.shouldIgnoreClick(e))return false;_toggleFlexTab("mentions")});$header.delegate("#stars_toggle","click",function(e){if(TS.client.ui.shouldIgnoreClick(e))return false;_toggleFlexTab("stars")});$header.delegate("#channel_members_toggle_count","click",_toggleMembersView);$header.delegate("#pinned_item_count","click",_togglePinsList);$header.delegate("#whats_new_toggle","click",function(e){if(TS.client.ui.shouldIgnoreClick(e))return false;if(TS.boot_data.feature_clog_whats_new){TS.clog.track("WHATSNEW_ACTION",{action:"open_pane_badged",trigger:"whats_new_toggle"})}$("#client-ui").removeClass("whats_new_showing");_toggleFlexTab("whats_new")});if(TS.boot_data.feature_sli_recaps){$header.delegate("#sli_recap_toggle","click",function(e){var $sli_toggle_ts_tip_tip=$("#sli_recap_toggle").find(".ts_tip_tip");if($(this).hasClass("active")){$(this).removeClass("active");$sli_toggle_ts_tip_tip.text("Turn highlight messages on");$(".recap_highlight").addClass("invisible")}else{var model_ob=TS.shared.getActiveModelOb();$(".recap_highlight").removeClass("invisible");_resetFlexpaneToggles(model_ob)}})}},cleanupFlexExcluding:function(exclude){if(exclude!=="files"){TS.view.files.cleanList();TS.client.ui.files.cleanFilePreview()}if(exclude!=="team"){if(TS.boot_data.feature_user_custom_status){TS.client.ui.current_status_input.unbindEvents()}}if(exclude!=="stars"){TS.view.cleanStars()}if(exclude!=="mentions"){TS.view.cleanMentions()}if(exclude!=="search"){TS.search.view.cleanResults()}},toggleFlex:function(){if(TS.model.ui_state.flex_visible){TS.client.ui.flex.hideFlex()}else{if(!TS.model.ui.active_tab_id){TS.client.ui.flex.openFlexTab(TS.model.default_flex_name)}else{var fade_in=TS.model.ui.active_tab_id=="list";TS.client.ui.flex.showFlex(fade_in);TS.client.flexDisplaySwitched(TS.model.ui.active_tab_id||"",TS.model.ui.last_flex_extra||"")}}},hideFlex:function(no_history,replace_state){TS.client.ui.flex.cleanupFlexExcluding();if(TS.model.ui_state.flex_visible){if(TS.model.ui_state.flex_name==="details"){if(!no_history)TS.model.ui_state.details_tab_active=false}else if(TS.model.ui_state.details_tab_active&&!TS.client.activeChannelIsHidden()){TS.client.ui.flex.openFlexTab("details",TS.boot_data.feature_message_replies&&replace_state);return}}var done=function(){TS.model.ui.last_flex_extra=TS.model.flex_extra_in_url;if(TS.model.ui_state.flex_visible&&TS.model.prefs.flex_resize_window&&TS.model.is_our_app){TS.client.ui.flex.adjustWindowSizeForFlexPane("hide")}$("#client-ui").removeClass("flex_pane_showing");TS.model.ui_state.flex_visible=false;if(!TS.boot_data.feature_message_replies){TS.model.ui_state.flex_name="";TS.model.ui_state.flex_extra="";TS.storage.storeUIState(TS.model.ui_state)}TS.view.resizeManually("TS.client.ui.flex.hideFlex");if(TS.model.ui.scrolled_to_msg_ts){TS.client.ui.scrollMsgsSoMsgIsInView(TS.model.ui.scrolled_to_msg_ts,false,true,200);TS.model.ui.scrolled_to_msg_ts=null}TS.client.flex_pane.stopLocalTimeInterval();$(".messages_banner").removeClass("flex_pane_showing");TS.client.flexDisplaySwitched("","",replace_state,no_history);TS.client.ui.flex.adjustIFramesInSpecialFlexPanes();if(document.activeElement&&$(document.activeElement).closest("#col_flex").length>0)TS.view.focusMessageInput();if(!TS.boot_data.feature_texty){TS.client.ui.$msg_input.trigger("autosize").trigger("autosize-resize")}};if(TS.model.ui.active_tab_id=="list"){$("#flex_contents").transition({opacity:0},100,done)}else{done()}},last_window_width_diff:392,last_window_width_diff_default:392,adjustWindowSizeForFlexPane:function(which){var ww=window.outerWidth;var wh=window.outerHeight;if(which=="show"){var diff=TS.client.ui.flex.last_window_width_diff;if(ww+diff>=1441){diff+=100}else if(ww+diff>=1367){diff+=50}window.resizeTo(ww+diff,wh);var actual_diff=window.outerWidth-ww;TS.client.ui.flex.last_window_width_diff=actual_diff;if(window.outerWidth==ww){return false}return true}else if(which=="hide"){window.resizeTo(ww-TS.client.ui.flex.last_window_width_diff,wh);TS.client.ui.flex.last_window_width_diff=TS.client.ui.flex.last_window_width_diff_default;return true}},showFlex:function(fade_in,no_resize){var was_at_bottom=TS.client.ui.areMsgsScrolledToBottom();$("#client-ui").addClass("flex_pane_showing");if(!TS.model.ui_state.flex_visible&&TS.model.prefs.flex_resize_window&&TS.model.is_our_app){TS.client.ui.flex.adjustWindowSizeForFlexPane("show")}TS.model.ui_state.flex_visible=true;TS.storage.storeUIState(TS.model.ui_state);if(!no_resize)TS.view.resizeManually("TS.client.ui.flex.showFlex");if(was_at_bottom)TS.client.ui.instaScrollMsgsToBottom(false);$(".messages_banner").addClass("flex_pane_showing");if(fade_in){$("#flex_contents").css("opacity",0).transition({opacity:100},150)}else{$("#flex_contents").css("opacity",100)}if(TS.model.ui.active_tab_id=="files"&&TS.model.ui.last_flex_extra!==""){TS.ui.utility.updateClosestMonkeyScroller($("#file_preview_scroller"),true)}if(TS.model.ui.active_tab_id=="downloads"){TS.ui.utility.updateClosestMonkeyScroller($("#downloads_scroller"),true)}if(TS.model.ui.active_tab_id=="team"&&!TS.model.previewed_member_id){TS.client.flex_pane.startLocalTimeInterval()}if(TS.model.ui.active_tab_id==="files"||!TS.model.ui.active_tab_id&&TS.model.default_flex_name==="files"){TS.view.files.maybeRebuildList()}else if(TS.model.ui.active_tab_id==="search"){TS.search.search_filter_set_sig.dispatch()}if(TS.model.ui.active_tab_id==="team"){window.setTimeout(function(){TS.view.maybeRebuildUserGroupList()},1)}TS.client.ui.flex.adjustIFramesInSpecialFlexPanes();if(!TS.boot_data.feature_texty){TS.client.ui.$msg_input.trigger("autosize").trigger("autosize-resize")}},_displayFlexTab:function(flex_name,no_resize){var $t=$("#"+flex_name+"_tab");if(!$t.length)return false;if(!TS.model.ui_state.flex_visible)TS.client.ui.flex.showFlex(false,true);if(TS.isPartiallyBooted()){_deferred_flex_name=flex_name;_deferred_no_resize=no_resize;_maybeEnqueueDeferredFlexTabHandler();return true}if(flex_name==="stars"){if(TS.model.user&&TS.model.user.stars&&!TS.stars.fetched_once){$("#member_stars_list").html(loader_html);TS.stars.fetchUserStarredItems()}else if(TS.model.user.stars&&TS.model.user.stars.length){TS.view.rebuildStars(true)}}else if(flex_name==="downloads"){TS.client.downloads.maybeBuild()}else if(flex_name==="mentions"){if(TS.model.user&&TS.model.user.mentions&&!TS.mentions.fetched_once){TS.view.rebuildMentionsLoading();TS.mentions.fetchMentions()}else if(TS.model.user.mentions&&TS.model.user.mentions.length){TS.view.rebuildMentionsImmediately(true)}}else if(flex_name==="files"){if(TS.boot_data.feature_fast_files_flexpane)TS.view.files.unHideList()}else if(flex_name==="team"){TS.client.flex_pane.startLocalTimeInterval()}else if(flex_name==="details"){TS.model.ui_state.details_tab_active=true}if(flex_name!=="team")TS.client.flex_pane.stopLocalTimeInterval();TS.client.ui.flex.cleanupFlexExcluding(flex_name);$("#flex_contents > .panel").removeClass("active");$t.addClass("active");$t.find(".heading").focus();TS.model.ui.active_tab_id=flex_name;TS.model.ui.active_tab_ts=Date.now();if(flex_name==="search"){TS.ui.utility.updateClosestMonkeyScroller($("#search_results"))}else{if(!no_resize)TS.view.resizeManually("TS.client.ui.flex._displayFlexTab flex_name:"+flex_name)}TS.client.ui.flex.adjustIFramesInSpecialFlexPanes();return true},adjustIFramesInSpecialFlexPanes:function(){if(!TS.boot_data.special_flex_panes)return;var flex_name=TS.model.ui.active_tab_id;var src;var special;var $t;var $iframe;for(var k in TS.boot_data.special_flex_panes){special=TS.boot_data.special_flex_panes[k];TS.log(82,"special_flex_pane: "+flex_name);$t=$("#"+special.flex_name+"_tab");if(!$t.length)continue;$iframe=$t.find("iframe");if(!$iframe.length)continue;src="about:blank";if(TS.model.ui_state.flex_visible&&special.flex_name===flex_name){src=$iframe.data("src")}if($iframe.attr("src")===src)continue;TS.log(82,"loading src: "+src);$iframe.attr("src",src)}},openFlexTab:function(flex_name,replace_state){if(!TS.client.ui.flex._displayFlexTab(flex_name))return;var flex_extra;if(flex_name==="files"){flex_extra=TS.model.previewed_file_id}else if(flex_name==="team"){flex_extra=TS.model.previewed_member_name;if(!flex_extra)flex_extra=TS.model.previewed_user_group_id}else if(flex_name==="search"){flex_extra=TS.search.last_search_query}TS.client.flexDisplaySwitched(flex_name,flex_extra,replace_state)},setFlexStateFromHistory:function(flex_name,flex_extra,force){if(TS.isPartiallyBooted()){_deferred_flex_state_args=arguments;_maybeEnqueueDeferredSetFlexStateFromHistoryHandler();return}if(!flex_name){if(TS.model.ui_state.flex_name||force)TS.client.ui.flex.hideFlex(true);return}flex_extra=flex_extra||"";var is_flex_extra=TS.model.ui_state.flex_extra||"";if(!force&&(flex_name==TS.model.ui_state.flex_name&&flex_extra==is_flex_extra)){return}if(flex_name=="list")flex_name="files";if(!TS.client.ui.flex._displayFlexTab(flex_name))return;if(flex_name=="files"){TS.client.ui.files.showFilesFromHistory(flex_extra)}else if(flex_name=="team"){TS.client.ui.showTeamFromHistory(flex_extra)}else if(flex_name=="search"){TS.client.ui.showSearchFromHistory(flex_extra)}else if(flex_name=="convo"&&TS.replies&&TS.boot_data.feature_message_replies&&flex_extra){TS.client.ui.showRepliesFromHistory(flex_extra)}else{TS.client.flexDisplaySwitched(flex_name,null,false,true)}},openConversationFlex:function(model_ob,thread_ts){var replies_enabled=TS.replies&&TS.replies.isEnabled();if(!replies_enabled)return;var flex_extra=model_ob.id+"-"+thread_ts;var should_change_flexpane=!TS.model.ui_state.flex_visible||TS.model.ui_state.flex_name!="convo"||TS.model.ui_state.flex_extra!=flex_extra;if(!should_change_flexpane)return;TS.client.ui.flex._displayFlexTab("convo");TS.client.flexDisplaySwitched("convo",flex_extra)}});var _deferred_flex_name;var _deferred_no_resize;var _clearDeferredDisplayFlexTabState=function(){_deferred_flex_name=undefined;_deferred_no_resize=undefined};var _maybeEnqueueDeferredFlexTabHandler=_.once(function(){TS.ms.connected_sig.addOnce(function(){var flex_name=_deferred_flex_name;var no_resize=_deferred_no_resize;_clearDeferredDisplayFlexTabState();if(!TS.model.ui_state.flex_visible||!TS.model.ui_state.flex_name){return}if(!flex_name){return}TS.client.ui.flex._displayFlexTab(flex_name,no_resize)})});var _deferred_flex_state_args;var _maybeEnqueueDeferredSetFlexStateFromHistoryHandler=_.once(function(){TS.ms.connected_sig.addOnce(function(){var args=_deferred_flex_state_args;_deferred_flex_state_args=undefined;return TS.client.ui.flex.setFlexStateFromHistory.apply(window,args)})});var loading_text=TS.i18n.t("Loading...","flexpane")();var loader_html='<div class="loading_hash_animation"><img src="'+cdn_url+"/f85a/img/loading_hash_animation_@2x.gif"+'" alt="'+loading_text+'" /><br />'+loading_text+"</div>";var _toggleFlexTab=function(flex_name){if(TS.model.ui_state.flex_visible&&TS.model.ui_state.flex_name===flex_name){TS.client.ui.flex.hideFlex()}else{TS.client.ui.flex.openFlexTab(flex_name)}};var _toggleMembersView=function(e){if(TS.client.ui.shouldIgnoreClick(e))return false;TS.client.ui.flex.openFlexTab("details");TS.client.channel_page.showMembersSection();$("#channel_page_scroller .channel_page_members").highlight(null,"channel_page_members_highlighter")};var _togglePinsList=function(e){if(TS.client.ui.shouldIgnoreClick(e))return false;TS.client.ui.flex.openFlexTab("details");TS.client.channel_page.showPinsSection();$("#channel_page_scroller .channel_page_pinned_items").highlight(null,"channel_page_members_highlighter")};var _flexpaneDisplaySwitched=function(){var visible=TS.model.ui_state.flex_visible;var name=TS.model.ui_state.flex_name;var model_ob=TS.shared.getActiveModelOb();_resetFlexpaneToggles(model_ob);if(name!=="team"||!TS.model.ui_state.flex_extra){TS.model.previewed_member_id=null;TS.model.previewed_member_name=null;TS.model.previewed_user_group_id=null}if(!visible)return;var $details_toggle=$("#details_toggle");var $details_toggle_ts_tip_tip=$details_toggle.find(".ts_tip_tip");var $recent_mentions_toggle=$("#recent_mentions_toggle");var $stars_toggle=$("#stars_toggle");if(model_ob&&name==="details"){$details_toggle.addClass("active");if(model_ob.is_im||model_ob.is_mpim){$details_toggle_ts_tip_tip.text(TS.i18n.t("Hide Conversation Details","flexpane")())}else if(model_ob.is_group||model_ob.is_channel){$details_toggle_ts_tip_tip.text(TS.i18n.t("Hide Channel Details","flexpane")())}$("#client-ui").addClass("details_showing")}else if(name==="mentions"){$recent_mentions_toggle.addClass("active");if(TS.boot_data.feature_message_replies){$recent_mentions_toggle.find(".ts_tip_tip").text(TS.i18n.t("Hide Activity","flexpane")())}else{$recent_mentions_toggle.find(".ts_tip_tip").text(TS.i18n.t("Hide Mentions & Reactions","flexpane")())}}else if(name==="stars"){$stars_toggle.addClass("active");$stars_toggle.find(".ts_tip_tip").text(TS.i18n.t("Hide Starred Items","flexpane")())}};var _resetFlexpaneToggles=function(model_ob){var $details_toggle_ts_tip_tip=$("#details_toggle .ts_tip_tip");$("#client-ui").removeClass("details_showing");$(".channel_header_icon.active").removeClass("active");if(TS.boot_data.feature_sli_recaps){$("#sli_recap_toggle").addClass("active");$("#sli_recap_toggle .ts_tip_tip").text("Turn highlight messages off")}if(model_ob){if(model_ob.is_im||model_ob.is_mpim){$details_toggle_ts_tip_tip.text(TS.i18n.t("Show Conversation Details","flexpane")())}else{$details_toggle_ts_tip_tip.text(TS.i18n.t("Show Channel Details","flexpane")())}}if(TS.boot_data.feature_message_replies){$("#recent_mentions_toggle .ts_tip_tip").text(TS.i18n.t("Show Activity","flexpane")())}else{$("#recent_mentions_toggle").addClass("ts_tip_rightish");$("#recent_mentions_toggle .ts_tip_tip").text(TS.i18n.t("Show Mentions & Reactions","flexpane")())}$("#stars_toggle .ts_tip_tip").text(TS.i18n.t("Show Starred Items","flexpane")())}})();(function(){"use strict";TS.registerModule("component_manager",{add:function(component_name,instance_name,instance){if(!refs[component_name])refs[component_name]={};if(refs[component_name][instance_name]){TS.warn(component_name,".",instance_name,"already exists! Not overwriting.");return}refs[component_name][instance_name]=instance;
},get:function(component_name,instance_name){if(refs[component_name]){return refs[component_name][instance_name]}return},remove:function(component_name,instance_name){if(refs[component_name]){delete refs[component_name][instance_name]}}});var refs={}})();(function(){"use strict";TS.registerComponent("SearchableMemberList",{_constructor:function(options){this._MINIMUM_MEMBERS_FOR_SEARCH=10;this._MAXIMUM_MEMBERS_BEFORE_NO_INITIAL=100;this._PAGE_SIZE=10;this._LOAD_MORE_AT_PIXELS_FROM_BOTTOM=100;this._RESIZE_THROTTLE_MS=33;this._SCROLL_DEBOUNCE_MS=100;this._namespace=options.namespace;this._approx_item_height=92;this._approx_divider_height=40;this.$_container=options.$container;this.$_long_list_view;this._search_input_id=options.search_input_id||"#team_filter";this._long_list_view_id=options.long_list_view_id||"#team_list_scroller";this._current_filter="everyone";this._next_marker="";this._members_in_view=[];this._have_all_members=false;this._fetch_more_members_p=null;TS.component_manager.add("SearchableMemberList",this._namespace,this)},destroy:function(){TS.warn("SearchableMemberList destroy not currently implemented");TS.component_manager.remove("SearchableMemberList",this._namespace);return},showInitial:function(){var self=this;this._startLoadingState();if(TS.lazyLoadMembersAndBots()&&TS.team.getBestEffortTotalTeamSize()<=self._MAXIMUM_MEMBERS_BEFORE_NO_INITIAL){return TS.team.ensureEntireTeamLoaded().then(function(){self._stopLoadingState();self._loadSearchBar();self._loadLocalMembersIntoLongListView();return null})}if(TS.lazyLoadMembersAndBots()){return Promise.resolve().then(function(){self._loadSearchBar();return self._fetchMoreMembers().then(function(){self._stopLoadingState();self._loadLongListView({items:self._members_in_view})})})}return Promise.resolve().then(function(){self._stopLoadingState();self._loadSearchBar();self._loadLocalMembersIntoLongListView();return null})},resetInitialState:function(){var self=this;if(!TS.lazyLoadMembersAndBots()||TS.team.getBestEffortTotalTeamSize()<=this._MAXIMUM_MEMBERS_BEFORE_NO_INITIAL){this._loadLocalMembersIntoLongListView();return}self._fetchMoreMembers().then(function(){self.$_long_list_view.longListView("setItems",self._members_in_view,true,true)})},showNoResults:function(query){var $no_results=this.$_container.find(".no_results");if($no_results.length!=0)return;var this_searchable_member_list=this;var no_results=TS.templates.team_searchable_no_results({query:query,everyone_filter_selected:this._current_filter=="everyone",members_filter_selected:this._current_filter=="active_members",restricted_filter_selected:this._current_filter=="restricted_members",deactivated_filter_selected:this._current_filter=="disabled_members"});this.$_long_list_view.hide().before(no_results);this.$_container.find(".clear_members_filter").on("click",function(){this_searchable_member_list.$_container.find(this_searchable_member_list._search_input_id+" input").val("");this_searchable_member_list.maybeClearNoResults();this_searchable_member_list.resetInitialState()})},maybeClearNoResults:function(){var $no_results=this.$_container.find(".no_results");if($no_results.length==0)return;$no_results.remove();this.$_long_list_view.show()},getLongListView:function(){return this.$_long_list_view},getCurrentFilter:function(){return this._current_filter},_loadLocalMembersIntoLongListView:function(options){var members_for_user=TS.members.allocateTeamListMembers(TS.members.getMembersForUser());if(this.$_long_list_view){this.$_long_list_view.longListView("setItems",options.items,true,true)}else{this._loadLongListView({items:members_for_user.members})}},_loadSearchBar:function(){var self=this;if(TS.team.getBestEffortTotalTeamSize()>=self._MINIMUM_MEMBERS_FOR_SEARCH&&self.$_container.find(".team_tabs_container").length==0){self.$_container.find(self._long_list_view_id).before(TS.templates.team_search_bar({show_search:true,show_filters:true,everyone_filter_selected:self._current_filter=="everyone",members_filter_selected:self._current_filter=="active_members",restricted_filter_selected:self._current_filter=="restricted_members",deactivated_filter_selected:self._current_filter=="disabled_members",everyone_count:100,members_count:80,guests_count:20,is_enterprise:TS.boot_data.feature_team_to_org_directory&&TS.boot_data.page_needs_enterprise}));var search_full_profiles=true;var is_long_list_view=true;var include_bots=true;var include_deleted=true;TS.members.view.bindTeamFilter(self._search_input_id,self._long_list_view_id,search_full_profiles,is_long_list_view,include_bots,include_deleted);self.$_container.delegate(".searchable_member_list_filter","click.searchable_member_list",function(menu_event){menu_event.preventDefault();TS.menu.startWithSearchableMemberListFilter(menu_event,function(e){var $action=$(e.target).closest("[data-filter]");if(!$action.length)return;self._current_filter=$action.data("filter");$(menu_event.target).val(_.trim($action.text()));TS.members.view.filterTeam($(self._search_input_id).find("input").val(),self._search_input_id,self._long_list_view_id,search_full_profiles)})})}},_loadLongListView:function(options){var self=this;self.$_long_list_view=self.$_container.find(self._long_list_view_id);self.$_long_list_view.longListView({items:options.items,approx_item_height:self._approx_item_height,approx_divider_height:self._approx_divider_height,preserve_dom_order:true,makeElement:function(data){return $(TS.templates.team_list_item({is_long_list_view:true}))},makeDivider:function(data){return $("<div></div>")},renderItem:function($el,item,data){$el.toggleClass("inactive",item.deleted).data("member-id",item.id).data("item",item);$el.html(TS.templates.team_list_item_member_details({member:item,is_long_list_view:true}));TS.utility.makeSureAllLinksHaveTargets($el)},renderDivider:function($el,item,data){$el.data("item",item).html(TS.templates.team_list_item_divider(item))},calcItemHeight:function($el){var outer_height=$el.outerHeight();if(!outer_height)return self._approx_item_height;return Math.max(outer_height,self._approx_item_height)},calcDividerHeight:function($el){var outer_height=$el.outerHeight();if(!outer_height)return self._approx_divider_height;return outer_height}});if(TS.lazyLoadMembersAndBots()){var container_height=self.$_long_list_view.height();var list_height=self.$_long_list_view.find(".list_items").height();TS.view.resize_sig.add(_.throttle(function(){container_height=self.$_long_list_view.height();list_height=self.$_long_list_view.find(".list_items").height()},self._RESIZE_THROTTLE_MS));var recursivelyFillListToHeight=function(){if(list_height<container_height&&!self._have_all_members){self._fetchMoreMembers().then(function(){self.$_long_list_view.longListView("setItems",self._members_in_view,true,true);list_height=self.$_long_list_view.find(".list_items").height();recursivelyFillListToHeight()})}};recursivelyFillListToHeight();self.$_long_list_view.on("scroll",_.debounce(function(e){var distance_from_bottom=list_height-($(e.target).scrollTop()+container_height);if(distance_from_bottom<self._LOAD_MORE_AT_PIXELS_FROM_BOTTOM){self._fetchMoreMembers().then(function(){self.$_long_list_view.longListView("setItems",self._members_in_view,true,true)})}},self._SCROLL_DEBOUNCE_MS))}},_fetchMoreMembers:function(){var self=this;if(self._have_all_members)return new Promise.resolve([]);if(self._fetch_more_members_p)return self._fetch_more_members_p;self._fetch_more_members_p=TS.flannel.fetchAndUpsertObjectsWithQuery({limit:self._PAGE_SIZE,marker:self._next_marker}).then(function(response){self._fetch_more_members_p=null;self._members_in_view=_.concat(self._members_in_view,response.objects);if(response.next_marker){self._next_marker=response.next_marker}else{self._have_all_members=true;self._next_marker=""}return response.objects});return self._fetch_more_members_p},_startLoadingState:function(){this.$_container.find(this._long_list_view_id).before(TS.templates.infinite_spinner({color:"white",size:"medium"}))},_stopLoadingState:function(){this.$_container.find(".infinite_spinner").remove()}})})();(function(){"use strict";TS.registerModule("client.ui.user_groups",{onStart:function(){if(TS.boot_data.feature_searchable_member_list){TS.client.login_sig.addOnce(_renderUserGroupContainer)}},clearUserGroupFilter:function(){var $div=$_container.find("#user_group_filter");var $input=$div.find("input.member_filter");var $icon_close=$div.find(".icon_close");_user_group_query=undefined;TS.view.rebuildUserGroupList();setTimeout(function(){$input.focus()},0);$input.val("");$icon_close.addClass("hidden")},getUserGroupQuery:function(){return _user_group_query}});var _renderUserGroupContainer=function(){$_container=$("#user_groups_container");$_container.html(TS.templates.user_groups_flexpane_tab({can_user_edit_user_groups:TS.members.canUserEditUserGroups(),can_user_create_and_delete_user_groups:TS.members.canUserCreateAndDeleteUserGroups()}));_addEventListeners()};var _addEventListeners=function(){var $div=$_container.find("#user_group_filter");var $input=$div.find("input.member_filter");var $icon_close=$div.find(".icon_close");$input.bind("keyup update-user-group-filter",function(e){_user_group_query=$input.val().trim().toLocaleLowerCase();TS.view.rebuildUserGroupList();$icon_close.toggleClass("hidden",!_user_group_query.trim())});$_container.delegate("#user_groups_list .clear_members_filter","click",function(){TS.client.ui.user_groups.clearUserGroupFilter()});$icon_close.bind("click",TS.client.ui.user_groups.clearUserGroupFilter)};var _user_group_query;var $_container})();(function(){"use strict";TS.registerModule("client.msg_input",{$input:$(),onStart:function(){_$snippet_prompt=$("#snippet_prompt");_$snippet_prompt_warning=_$snippet_prompt.find(".warning");_$notification_bar=$("#notification_bar");_$chat_input_tab_ui=$("#chat_input_tab_ui");TS.channels.renamed_sig.add(TS.client.msg_input.setPlaceholder);TS.groups.renamed_sig.add(TS.client.msg_input.setPlaceholder);TS.members.changed_name_sig.add(TS.client.msg_input.setPlaceholder);TS.members.changed_real_name_sig.add(TS.client.msg_input.setPlaceholder);TS.prefs.display_preferred_names_changed_sig.add(TS.client.msg_input.setPlaceholder);TS.prefs.display_real_names_override_changed_sig.add(TS.client.msg_input.setPlaceholder);TS.prefs.team_display_real_names_changed_sig.add(TS.client.msg_input.setPlaceholder)},bind:function($input){TS.client.msg_input.$input=$input;if(TS.boot_data.feature_texty){TS.utility.contenteditable.create($input,{placeholder:$input.data("placeholder"),onSend:function(){_tryToSubmit({},$input)},onTextChange:function(){_maybeResize()},tabcomplete:{menuTemplate:TS.templates.tabcomplete_menu,completers:[TS.tabcomplete.members,TS.tabcomplete.channels],appendMenu:function(menu){document.querySelector("#msg_form").appendChild(menu)},positionMenu:function(menu){menu.style.bottom="100%";menu.style.left="42px";menu.style.width="90%"}}})}TS.utility.contenteditable.enable($input);if(!TS.boot_data.feature_texty&&TS.boot_data.feature_you_autocomplete_me){$input.TS_tabCompleteNew({complete_cmds:true,complete_channels:true,complete_user_groups:true,complete_emoji:true,complete_member_specials:true,no_tab_out:true,onComplete:function(txt,new_cp){TS.utility.populateInput($input,txt,new_cp);TS.client.msg_input.storeLastMsgForActiveModelOb(TS.utility.contenteditable.value($input))},ui_initer:TS.ui.msg_tab_complete.start,suspended:true,sort_by_membership:true,include_self:!!TS.boot_data.feature_name_tagging_client})}else if(!TS.boot_data.feature_texty){$input.TS_tabComplete({complete_cmds:true,complete_channels:true,complete_user_groups:true,complete_emoji:true,complete_member_specials:true,no_tab_out:true,onComplete:function(txt,new_cp){TS.utility.populateInput($input,txt,new_cp);TS.client.msg_input.storeLastMsgForActiveModelOb(TS.utility.contenteditable.value($input))},ui_initer:TS.ui.msg_tab_complete.start,suspended:true,sort_by_membership:true,include_self:!!TS.boot_data.feature_name_tagging_client})}if(!TS.boot_data.feature_texty)_bindResize();if(!TS.boot_data.feature_texty)$input.on("textchange",_onTextChange);$input.on("keydown.msg_input",function(e){if(TS.boot_data.feature_texty)return;var start=Date.now();var keymap=TS.utility.keymap;var val=TS.utility.contenteditable.value($input);var val_trimmed=$.trim(val);var user_typing=false;if(val){if(val.indexOf("/")!==0&&val_trimmed.length>0){TS.typing.userStarted(TS.shared.getActiveModelOb());user_typing=true}}if(TS.client.ui.keyPressIsValidForGotoNextOpenChannelOrIM(e)){e.preventDefault();if(TS.model.profiling_keys)TS.model.addProfilingKeyTime("input keydown",Date.now()-start);return}if(e.which==keymap.enter&&e.metaKey&&e.shiftKey){TS.client.msg_input.startSnippet()}else if(e.which==keymap.enter&&(!e.shiftKey&&!e.altKey&&!e.ctrlKey)){if(e.which==keymap.enter&&e.metaKey){TS.client.msg_input.startSnippet()}else if(val_trimmed!==""&&!TS.client.ui.cal_key_checker.prevent_enter){if(_$chat_input_tab_ui.length&&!_$chat_input_tab_ui.hasClass("hidden")&&TS.model.prefs.tab_ui_return_selects){e.preventDefault();return}if(TS.model.prefs.enter_is_special_in_tbt&&TS.utility.isCursorWithinTBTs($input)){return}_tryToSubmit(e,$input)}e.preventDefault();if(TS.model.profiling_keys)TS.model.addProfilingKeyTime("input keydown",Date.now()-start);return}else if(e.which==keymap.enter&&(!TS.model.is_mac&&e.shiftKey&&!e.altKey&&e.ctrlKey)){TS.client.msg_input.startSnippet()}else{if(e.which==keymap.shift){}else if(e.which==keymap.enter&&(e.ctrlKey||e.altKey)){if(!TS.model.is_mac||(TS.model.is_FF||TS.model.is_electron||TS.model.is_chrome_desktop)){var p=$input.getCursorPosition();TS.utility.contenteditable.value($input,val.substr(0,p)+"\n"+val.substr(p));$input.trigger("autosize").trigger("autosize-resize");$input.setCursorPosition(p+1)}}else if(TS.model.prefs&&TS.model.prefs.enter_is_special_in_tbt&&e.which==keymap.enter&&e.shiftKey&&TS.utility.isCursorWithinTBTs($input)){_tryToSubmit(e,$input)}if(_$chat_input_tab_ui.length&&!_$chat_input_tab_ui.hasClass("hidden")){if(TS.model.is_our_app&&TS.model.is_electron){if(e.which==keymap.up||e.which==keymap.left||e.which==keymap.down||e.which==keymap.right){e.preventDefault()}}}else if(TS.client.ui.shouldEventTriggerMaybeEditLast(e,$input)){TS.client.ui.maybeEditLast(e)}else if(val==""&&!e.altKey&&!TS.utility.cmdKey(e)&&e.which==TS.utility.keymap.left){e.preventDefault();TS.menu.file.startWithNewFileOptions(e,$("#primary_file_button"));$input.blur()}else if(!e.shiftKey&&(e.which==keymap.up||e.which==keymap.down)){var selection=TS.utility.getCursorPosition(TS.client.msg_input.$input);if(!selection||selection.length===0){if(e.which==keymap.up&&selection.start<1){TS.chat_history.onArrowKey(e,TS.client.msg_input.$input)}else if(e.which==keymap.down&&selection.end>=val.length){TS.chat_history.onArrowKey(e,TS.client.msg_input.$input)}}}}if(TS.model.profiling_keys)TS.model.addProfilingKeyTime("input keydown",Date.now()-start);if(!user_typing)TS.typing.userEnded(TS.shared.getActiveModelOb())});if(TS.client.ui.$messages_input_container){$input.on("focus",function(){TS.client.ui.$messages_input_container.addClass("focus")}).on("blur",function(){TS.client.ui.$messages_input_container.removeClass("focus")})}},setOffline:function(){if(TS.client.ui.$messages_input_container){TS.client.ui.$messages_input_container.addClass("offline")}else{TS.client.msg_input.$input.addClass("offline")}},setOnline:function(){if(TS.client.ui.$messages_input_container){TS.client.ui.$messages_input_container.removeClass("offline")}else{TS.client.msg_input.$input.removeClass("offline")}},resized:function(original,height){var start=Date.now();if(!TS.client.ui.$emo_menu)TS.client.ui.$emo_menu=$(".emo_menu");TS.view.measureInput();if(!TS.boot_data.feature_texty&&!TS.boot_data.feature_new_msg_input){TS.client.ui.files.$file_btn.css("height",TS.view.last_input_height+"px")}TS.view.resizeManually("TS.client.msg_input.resized original:"+original+" height:"+height);if(TS.model.is_FF){if(TS.view.last_input_height>=115){TS.client.ui.$msg_input.removeClass("with-emoji-menu");TS.client.ui.$emo_menu.addClass("hidden")}else if(TS.view.last_input_height<96){TS.client.ui.$msg_input.addClass("with-emoji-menu");TS.client.ui.$emo_menu.removeClass("hidden")}}if(TS.model.profiling_keys)TS.model.addProfilingKeyTime("inputResized "+original+" "+height,Date.now()-start)},reset:function(){if(TS.boot_data.feature_texty){TS.view.measureInput();return}TS.utility.queueRAF(function resetMessageInputRAF(){var font_size=TS.boot_data.feature_a11y_pref_text_size?TS.model.prefs.a11y_font_size:"normal";var default_msg_input_height=font_size==="large"?38:16;TS.client.ui.$msg_input.height(default_msg_input_height);TS.view.measureInput()});TS.client.ui.$msg_input.blur()},storeLastMsgForActiveModelOb:function(txt){var model_ob=TS.shared.getActiveModelOb();if(TS.model.input_history_index>-1){if(TS.model.input_history[TS.model.input_history_index]!=txt){TS.chat_history.resetPosition("storeLastMsgInputForActive "+txt)}}if(!model_ob)return;if(model_ob.last_msg_input==txt)return;model_ob.last_msg_input=txt;TS.storage.storeLastMsgInput(model_ob.id,model_ob.last_msg_input)},populate:function(txt){TS.utility.populateInput(TS.client.ui.$msg_input,txt);TS.client.msg_input.storeLastMsgForActiveModelOb(txt);if(!TS.boot_data.feature_texty){TS.client.msg_input.$input.trigger("autosize").trigger("autosize-resize")}},populateWithLast:function(){var model_ob=TS.shared.getActiveModelOb();if(!model_ob)return;var should_populate=!TS.boot_data.feature_name_tagging_client_extras||TS.model.ms_logged_in_once||TS.format.hasOnlyValidMemberIds(model_ob.last_msg_input);if(!should_populate)return;TS.chat_history.resetPosition("populateChatInputWithLast");if(!TS.boot_data.feature_texty){if(TS.boot_data.feature_you_autocomplete_me){TS.client.ui.$msg_input.TS_tabCompleteNew("suspend")}else{TS.client.ui.$msg_input.TS_tabComplete("suspend")}}TS.client.msg_input.populate(model_ob.last_msg_input);if(!TS.boot_data.feature_texty){if(TS.boot_data.feature_you_autocomplete_me){TS.client.ui.$msg_input.TS_tabCompleteNew("unsuspend");TS.client.ui.$msg_input.TS_tabCompleteNew("changeoption","member_prefix_required",model_ob.is_slackbot_im)}else{TS.client.ui.$msg_input.TS_tabComplete("unsuspend");TS.client.ui.$msg_input.TS_tabComplete("changeoption","member_prefix_required",model_ob.is_slackbot_im)}}},startSnippet:function(){var prompted=_click_snippet_prompt;TS.ui.snippet_dialog.startCreate(TS.utility.contenteditable.value(TS.client.ui.$msg_input),prompted);TS.view.clearMessageInput();_click_snippet_prompt=false},createSnippetFromPrompt:function(){if(_snippet_prompt_text_showing){_click_snippet_prompt=true;TS.client.msg_input.startSnippet()}},setPlaceholder:function(){TS.utility.contenteditable.placeholder(TS.client.ui.$msg_input,_getPlaceholderText());if(!TS.boot_data.feature_texty){TS.client.msg_input.$input.trigger("autosize").trigger("autosize-resize")}},test:function(){return{_maybeHandleReactionCmdInMsgInput:_maybeHandleReactionCmdInMsgInput,_maybeShareFilesInMessage:_maybeShareFilesInMessage,_shareFiles:_shareFiles}}});var _$snippet_prompt;var _$snippet_prompt_warning;var _$notification_bar;var _$chat_input_tab_ui;var _snippet_prompt_text_showing;var _click_snippet_prompt=false;var _onTextChange=function(e,prev_txt){var start=Date.now();var val=TS.utility.contenteditable.value(TS.client.msg_input.$input);var val_formatted=TS.format.cleanMsg(val);TS.client.msg_input.storeLastMsgForActiveModelOb(val);if(TS.model.profiling_keys)TS.model.addProfilingKeyTime("input textchange",Date.now()-start);var show_snippet_prompt=val_formatted.length>TS.model.input_maxlength;if(show_snippet_prompt&&!_snippet_prompt_text_showing){_maybePromptForSnippet(show_snippet_prompt)}else if(!show_snippet_prompt&&_snippet_prompt_text_showing){_maybePromptForSnippet(show_snippet_prompt)}var show_special_formatting=val.length>2;if(show_special_formatting&&!_special_formatting_text_showing){_maybeToggleSpecialFormatting(show_special_formatting)}else if(!show_special_formatting&&_special_formatting_text_showing){_maybeToggleSpecialFormatting(show_special_formatting)}_change_count++;if(val_formatted===""){_resize_count=0;_change_count=0}if(TS.boot_data.feature_texty)_maybeResize();if(TS.model.prefs.msg_preview)_updateMsgPreview(val)};var _last_height=0;var _maybeResize=function(){var height=TS.client.msg_input.$input.height();if(height!==_last_height){TS.utility.rAF(function(){TS.client.ui.files.$file_btn.height(height);TS.client.ui.files.$file_btn.height("")});TS.client.msg_input.resized(_last_height,height);_last_height=height}};var _change_count=0;var _resize_count=0;var _bindResize=function(){var resize_threshold=.66;var did_report;if(TS.channels&&TS.channels.switched_sig){TS.channels.switched_sig.add(function(){_resize_count=0;_change_count=0})}TS.client.msg_input.$input.autosize({boxOffset:18*TS.utility.getA11yFontSizeMultiplier(),placeholder:false,callback:function(){_resize_count++;TS.client.msg_input.resized.apply(this,arguments);var text=TS.utility.contenteditable.value(TS.client.msg_input.$input);if(text===""){_resize_count=0;_change_count=0}else if(!did_report&&text&&text.length>20&&_change_count>20&&_resize_count>5&&_resize_count/_change_count>resize_threshold){var message=document.querySelectorAll("#msgs_div .message").length+" messages in current channel. Resize vs. change count: "+_resize_count+" / "+_change_count+" ("+_resize_count/_change_count+")";TS.logError(message,"Excessive message input resize events","Message Input Error");did_report=true}}})};var _maybePromptForSnippet=function(show){if(show){_$snippet_prompt_warning.removeClass("hidden");_$snippet_prompt.removeClass("hidden");_$notification_bar.addClass("showing_snippet_prompt");_snippet_prompt_text_showing=true}else{_$snippet_prompt.addClass("hidden");_$notification_bar.removeClass("showing_snippet_prompt");_snippet_prompt_text_showing=false;_click_snippet_prompt=false}};var _$special_formatting_text;var _special_formatting_text_showing;var _maybeToggleSpecialFormatting=function(show){if(!_$special_formatting_text)_$special_formatting_text=$("#special_formatting_text");if(show){_$special_formatting_text.addClass("showing",show);_special_formatting_text_showing=true}else{_$special_formatting_text.removeClass("showing",show);_special_formatting_text_showing=false}};var _last_preview_html="";var _updateMsgPreview=function(val){var preview_html;if(val.substr(0,4)=="/me "&&val.length>4){preview_html="<i>"+TS.format.formatDefault(TS.format.cleanMsg(val.substr(3)))+"</i>"}else if(val.substr(0,7)=="/shrug "){preview_html=TS.format.formatDefault(TS.format.cleanMsg(val.substr(6)))+" ¯\\_(ツ)_/¯"}else if(val.substr(0,1)=="/"){preview_html=""}else{preview_html=TS.format.formatDefault(TS.format.cleanMsg(val))}preview_html=preview_html||(TS.model.prefs.msg_preview_persistent?"&nbsp;":"");var text_changed=preview_html!=_last_preview_html;_last_preview_html=preview_html;if(text_changed){TS.client.ui.$msg_preview_msg.html(preview_html)}if(preview_html&&!TS.model.msg_preview_showing){TS.model.msg_preview_showing=true;TS.client.ui.$msg_preview.removeClass("hidden");TS.client.msg_input.$input.data("$tab_complete_ui_y_positioner",TS.client.ui.$msg_preview)}else if(!preview_html&&TS.model.msg_preview_showing){TS.model.msg_preview_showing=false;TS.client.ui.$msg_preview.addClass("hidden");TS.client.msg_input.$input.data("$tab_complete_ui_y_positioner",null)}else if(!text_changed){return}var prev_height=TS.boot_data.feature_texty?TS.view.last_input_height:TS.view.last_input_container_height;TS.view.measureInput();var new_height=TS.boot_data.feature_texty?TS.view.last_input_height:TS.view.last_input_container_height;if(prev_height!=new_height){TS.view.resizeManually()}if(TS.ui.msg_tab_complete.isShowing()){TS.ui.msg_tab_complete.positionUI()}};var _maybeHandleReactionCmdInMsgInput=function(val){var msg;var model_ob=TS.shared.getActiveModelOb();var potential_msgs=[];if(TS.boot_data.feature_message_replies){potential_msgs=TS.utility.msgs.getDisplayedMsgs(model_ob.msgs)}else{potential_msgs=model_ob.msgs}if(potential_msgs.length){msg=_(potential_msgs).take(5).find(function(msg){return!msg.is_ephemeral})}var handled=TS.client.ui.maybeHandleReactionCmd(msg,val,function(){TS.chat_history.add($.trim(val));TS.view.clearMessageInput()});return handled};var _maybeShareFilesInMessage=function(msg,dest_ob,callback){var urls_in_msg=TS.utility.findUrls(msg);var file_ids=urls_in_msg.map(TS.utility.getFileIDFromURL);var files=_.compact(file_ids.map(TS.files.getFileById));var shareable_files=[];var private_files_to_reshare=[];files.forEach(function(file){if(TS.files.isFilePrivate(file)&&file.bot_id){shareable_files.push(file)}else if(dest_ob&&dest_ob.is_im&&file.user===dest_ob.user){shareable_files.push(file)}else if(TS.files.isFilePrivate(file)&&file.user===TS.model.user.id){shareable_files.push(file)}else if(TS.files.isFilePrivate(file)&&file.user!==TS.model.user.id){private_files_to_reshare.push(file)}});if(!shareable_files.length&&!private_files_to_reshare.length){callback(false);return}if(shareable_files.length&&private_files_to_reshare.length){_sharePrivateFiles(private_files_to_reshare,msg,dest_ob,function(){_shareFiles(shareable_files,msg,dest_ob,callback)})}else if(shareable_files.length){_shareFiles(shareable_files,msg,dest_ob,callback)}else if(private_files_to_reshare.length){_sharePrivateFiles(private_files_to_reshare,msg,dest_ob,callback)}};var _shareFiles=function(files,msg,dest_ob,callback){var file=files[0];var remaining_files=files.slice(1);var shared_from_msg=true;var comment="";TS.files.shareFile(file.id,dest_ob.id,comment,shared_from_msg,function(){if(remaining_files.length>0){_shareFiles(remaining_files,msg,dest_ob,callback)}else{callback(true)}})};var _sharePrivateFiles=function(files,msg,dest_ob,callback){TS.files.reShareConfirmation(files,function(){_shareFiles(files,msg,dest_ob,callback)})};var _getPlaceholderText=function(){var model_ob=TS.shared.getActiveModelOb();if(!model_ob||!TS.permissions.members.canPostInModelOb(TS.model.user,model_ob)||!model_ob.is_im&&!model_ob.is_mpim&&!model_ob.is_channel&&!model_ob.is_group){return""}var placeholder="Message ";if(model_ob.is_self_im){placeholder+="yourself"}else if(model_ob.is_im){if(TS.boot_data.feature_name_tagging_client){placeholder+=TS.members.getMemberFullName(model_ob.user)}else{placeholder+=TS.members.getMemberDisplayNameById(model_ob.user,false,true)}}else if(model_ob.is_mpim){placeholder+=TS.mpims.getDisplayName(model_ob,false,false,3)}else if(model_ob.is_group){placeholder+=model_ob.name}else if(model_ob.is_channel){placeholder+="#"+model_ob.name}return placeholder};var _tryToSubmit=function(e,$input){var val=TS.format.cleanMsg(TS.utility.contenteditable.value($input));if(val.length>TS.model.input_maxlength){_$snippet_prompt.highlight(600,"",null,0);e.preventDefault();return}var submitter=function(){if(TS.view.submit(e)){if(!TS.ui.at_channel_warning_dialog.showing)TS.client.msg_input.reset();TS.chat_history.resetPosition("enter key")}else if(!TS.model.is_msg_rate_limited){TS.client.ui.addOrFlashEphemeralBotMsg({channel:TS.model.active_cid,icons:{emoji:":electric_plug:"},username:"connectbot",text:"Hmm, your computer seems to be *offline*, so sending messages won’t work at the moment.",ephemeral_type:"disconnected_feedback"})}};if(_maybeHandleReactionCmdInMsgInput(val))return;_maybeShareFilesInMessage(val,TS.shared.getActiveModelOb(),function(did_share){submitter()})}})();(function(){"use strict";TS.registerModule("client.channel_pane",{$scroller:$("#channels_scroller"),$nav:$("#channels_nav"),$unread_nav:$(".channels_nav_unread"),$threads_nav:$("#col_channels .all_threads"),onStart:function(){_dm_members=TS.presence_manager.createList();_starred_members=TS.presence_manager.createList();_rebuildCustomListThrottled=TS.utility.throttleFunc(_rebuildCustomListThrottled,10);TS.client.login_sig.add(_onLogin);TS.prefs.hotness_changed_sig.add(_toggleHotness);TS.shared.model_ob_hotness_changed_sig.add(_updateHotnessDisplay);TS.prefs.channel_sort_changed_sig.add(_toggleCustomSort);TS.client.channel_pane.$scroller.delegate("li a","dragstart",function(e){e.preventDefault()})},rebuild:function(){$("#col_channels").toggleClass("no_unread_msgs_badges",!TS.model.channel_sort.is_custom_sorted||!_sortingByUnreadMessagesCount());TS.client.channel_pane.rebuildFooter();if(TS.model.channel_sort.is_custom_sorted){_rebuildCustomListThrottled();return}var i,section;for(var i=0;i<arguments.length;i++){section=arguments[i];if(section=="starred"){_rebuildStarredList()}else if(section=="channels"){_rebuildChannelsList()}else if(section=="ims"){_rebuildDmList()}else{TS.error("unknown channel_pane section:"+section)}}},rebuildFooter:function(){if(TS.boot_data.feature_prev_next_button){$("#col_channels_footer").empty();if(!$("#history_nav_btn").length){$("#col_channels_footer").append('<div id="history_nav_btn" class="clearfix"></div>');$("#history_nav_btn").html(TS.templates.builders.buildHistoryNavBtnHtml());$("#left_arrow_btn").off().on("click",function(){if(TS.newxp.inOnboarding())return false;window.history.go(-1)});$("#right_arrow_btn").off().on("click",function(){if(TS.newxp.inOnboarding())return false;window.history.go(1)});$("#quickswitcher_btn").off().on("click",function(){if(TS.newxp.inOnboarding())return false;TS.ui.jumper.start()})}_updateChannelPaneFooterVisibility()}else{_rebuildQuickSwitcherBtn()}},maybeRebuildBecauseUnreadCntChanged:function(model_ob){if(!TS.model.channel_sort.is_custom_sorted)return false;if(!_sortingByUnread())return false;if(model_ob.id==TS.model.active_cid)return false;TS.client.channel_pane.rebuild();return true},updateQuickSwitcherBtnVisibility:function(){var $quick_switcher_btn=$("#quick_switcher_btn");if(TS.model.prefs.no_omnibox_in_channels){if($quick_switcher_btn.hasClass("hidden"))return}else{if(!$quick_switcher_btn.hasClass("hidden"))return}$quick_switcher_btn.toggleClass("hidden",!!TS.model.prefs.no_omnibox_in_channels);_updateChannelPaneFooterVisibility()},getPriorityForModelOb:function(model_ob){var priority=0;if(TS.model.channel_sort.priority_type=="sli"){priority=model_ob.priority}return _.clamp(priority,0,1)},getSortedList:function(){if(TS.model.channel_sort.is_custom_sorted)return _getSortedCustomList();return _getSortedNormalList()},makeSureActiveChannelIsInView:function(){if(TS.client.activeChannelIsHidden())return;_makeSureActiveChannelIsInView()},startSortingMode:function(){TS.model.sorting_mode_is_showing=true;$("body").addClass("sorting_mode");$("#channels_header, #direct_messages_header").css("pointer-events","none");$("#channels_scroller").removeClass("show_which_channel_is_active")},stopSortingMode:function(){TS.model.sorting_mode_is_showing=false;$("body").removeClass("sorting_mode");$("#channels_header, #direct_messages_header").css("pointer-events","");$("#channels_scroller").addClass("show_which_channel_is_active")},checkScrolledAtAll:TS.utility.immediateDebounce(function(){TS.utility.queueRAF(function(){if(TS.client.channel_pane.$scroller.scrollTop()<=0){TS.client.channel_pane.$nav.removeClass("has_scrolled");_has_scrolled=false}else if(!_has_scrolled){TS.client.channel_pane.$nav.addClass("has_scrolled");_has_scrolled=true}})})});var _open_im_mpims=0;var _openable_im_mpims=0;var _hotness_interv;var _dm_members;var _starred_members;var _has_scrolled=false;var _onLogin=function(){_toggleCustomSort();_toggleHotness();TS.log(82,"UI bind on login_sig");TS.utility.queueRAF(_bindUI)};var _bindUI=function(){var canDoAnything=function(){if(!TS.model.ms_connected&&!TS.model.change_channels_when_offline)return false;return true};var canSwitchChannels=function(){if(!canDoAnything())return false;if(TS.model.sorting_mode_is_showing)return false;return true};$(".new_channel_btn").on("click",function(e){e.stopPropagation();if(!TS.permissions.members.canCreateChannels()&&!TS.members.canUserCreateGroups())return;if(!canSwitchChannels())return TS.sounds.play("beep");_openCreateChannelDialog();
});$("#direct_messages_header, .new_dm_btn").on("click",function(e){e.stopPropagation();if(!canSwitchChannels())return TS.sounds.play("beep");_openDMBrowser(e)});$("#channels_header").on("click",function(e){if(!canSwitchChannels())return TS.sounds.play("beep");_openChannelBrowser()});TS.client.channel_pane.$nav.find('li[data-action="browse_channels"]').on("click",function(e){e.preventDefault();if(!canSwitchChannels())return TS.sounds.play("beep");_openChannelBrowser(e)});TS.client.channel_pane.$nav.find('li[data-action="browse_dms"]').on("click",function(e){e.stopPropagation();if(!canSwitchChannels())return TS.sounds.play("beep");_openDMBrowser(e)});TS.client.channel_pane.$unread_nav.on("click",function(e){e.preventDefault();if(TS.model.sorting_mode_is_showing)return TS.sounds.play("beep");TS.client.unread.showUnreadView()});if(TS.boot_data.feature_message_replies_threads_view){TS.client.channel_pane.$threads_nav.on("click",function(e){e.preventDefault();if(TS.model.sorting_mode_is_showing)return TS.sounds.play("beep");TS.client.threads.showThreadsView()})}TS.client.channel_pane.$scroller.find(".section_holder ul").on("click",function(e){if(TS.view.maybeFollowLink(e))return;e.preventDefault();e.stopPropagation();if(!canDoAnything())return TS.sounds.play("beep");if(TS.model.sorting_mode_is_showing){if(!TS.stars.checkForStarClick(e)&&!_checkForMutedClick(e)){return TS.sounds.play("beep")}}if(TS.client.ui.checkForEditing(e))return TS.sounds.play("beep");var $el=$(e.target);if(TS.model&&TS.model.team&&TS.boot_data.feature_tinyspeck){TS.info("Channel switch clicked",$el,$el[0]?$el[0].outerHTML:"")}var member_el=$el.closest(".member").find(".im_name");var member_id=member_el.data("member-id");var group_el=$el.closest(".group_name");var group_id=group_el.data("group-id");var channel_el=$el.closest(".channel_name");var channel_id=channel_el.data("channel-id");var $mpim_el=$el.closest(".mpim_name");var mpim_id=$mpim_el.data("mpim-id");if(member_id){if($el.hasClass("im_close")){var im=TS.ims.getImByMemberId(member_id);TS.client.ui.maybePromptForClosingIm(im.id)}else{if(!canSwitchChannels())return TS.sounds.play("beep");TS.ims.startImByMemberId(member_id)}}else if(group_id){if($el.hasClass("group_close")){TS.client.ui.maybePromptForClosingGroup(group_id)}else{if(!canSwitchChannels())return TS.sounds.play("beep");TS.groups.displayGroup(group_id)}}else if(channel_id){if(!canSwitchChannels())return TS.sounds.play("beep");TS.channels.displayChannel(channel_id)}else if(mpim_id){if($el.hasClass("mpim_close")){TS.mpims.closeMpim(mpim_id)}else{if(!canSwitchChannels())return TS.sounds.play("beep");TS.mpims.displayMpim(mpim_id)}}})};var _checkForMutedClick=function(e){var $el=$(e.target);var $muted_icon=$el.closest(".muted_icon");if(!$muted_icon.length)return false;var model_ob=TS.shared.getModelObById($muted_icon.data("c-id"));if(!model_ob)return false;TS.notifs.muteOrUnmuteCorG(model_ob.id);return true};var _rebuildDmHeaderCount=function(){$("#dm_header_count").text(_open_im_mpims+_openable_im_mpims)};var _rebuildChannelHeaderCount=function(){var channel_count=TS.channels.getUnarchivedChannelsForUser().length;var group_count=TS.groups.getUnarchivedGroups().length;var total_count=channel_count+group_count;var $channel_list_header_label=$(".channel_list_header_label");$("#channel_header_count").text(total_count);if($channel_list_header_label.length){var channel_list_aria_label=$channel_list_header_label.attr("aria-label")||"";$channel_list_header_label.attr("aria-label",channel_list_aria_label.replace("[0]",total_count))}};var _openDMBrowser=function(e){TS.ui.im_browser.start();$("#direct_messages_header, .channels_list_new_btn").tooltip("hide")};var _openChannelBrowser=function(e){TS.ui.channel_browser.start();$("#channels_header").find(".channel_list_header_label").tooltip("hide")};var _openCreateChannelDialog=function(e){TS.ui.new_channel_modal.start();$(".channels_list_new_btn").tooltip("hide")};var _toggleHotness=function(){if(TS.model.prefs.hotness){$(".hotness_icon").removeClass("hidden");_hotness_interv=setInterval(TS.shared.updateHotnessForAll,1e4);TS.shared.updateHotnessForAll()}else{$(".hotness_icon").addClass("hidden");clearInterval(_hotness_interv)}};var _toggleCustomSort=function(){TS.client.channel_pane.$scroller.find(".section_holder ul").empty();if(TS.model.channel_sort.is_custom_sorted){$("#col_channels").removeClass("default_sort").addClass("custom_sort");var $nav_browse_lis=TS.client.channel_pane.$nav.find('li[data-action="browse_channels"], li[data-action="browse_dms"]');if(_starredThenTypeArePrimarySort()||_typeIsPrimarySort()){$nav_browse_lis.addClass("hidden")}else{$nav_browse_lis.removeClass("hidden")}}else{$("#col_channels").removeClass("custom_sort").addClass("default_sort");$("#everything, #unread").addClass("hidden")}TS.view.resizeManually("TS.client.channel_pane _toggleCustomSort");TS.client.channel_pane.rebuild("ims","channels","starred")};var _updateHotnessDisplay=function(model_ob){if(!TS.model.prefs.hotness)return;var selector="#"+TS.templates.makeHotnessIconDomId(model_ob);$(selector).attr("class",TS.templates.makeHotnessIconDomClasses(model_ob))};var _getSortStrForName=function(c){if(c.is_im)return TS.ims.getDisplayNameOfUserForImLowerCase(c);if(c.is_mpim)return TS.mpims.getDisplayNameLowerCase(c);return c._name_lc};var _getSortStrForMuted=function(c){return c.is_im||!TS.notifs.isCorGMuted(c.id)?"1:muted -- ":"9:muted -- "};var _getSortStrForHasUnreadMsgs=function(c){return c._sorting_unread_cnt?"1:msgs -- ":"9:msgs -- "};var _getSortStrForHasUnreadMentions=function(c){if(c.is_im||c.is_mpim)return c._sorting_unread_cnt?"1:mntns -- ":"9:mntns -- ";return c._sorting_unread_highlight_cnt?"1:mntns -- ":"9:mntns -- "};var _getSortStrForUnreadMsgsCount=function(c){return _.padStart(1e9-(c._sorting_unread_cnt||0),10,0)+":msgs"};var _getSortStrForUnreadMentionsCount=function(c){if(c.is_im||c.is_mpim)return _.padStart(1e9-(c._sorting_unread_cnt||0),10,0)+":mntns";return _.padStart(1e9-(c._sorting_unread_highlight_cnt||0),10,0)+":mntns"};var _getSortStrForStarred=function(c){return c.is_starred?"1:starred -- ":"9:starred -- "};var _getSortStrForType=function(c){if(c.is_channel)return"1:type -- ";if(c.is_group&&!c.is_mpim)return TS.model.prefs.separate_private_channels?"2:type -- ":"1:type -- ";if(c.is_slackbot_im)return"3:type -- ";if(c.is_self_im)return"4:type -- ";if(c.is_mpim)return"5:type -- ";if(c.is_im)return"6:type -- "};var _getSortStrForTypeAndMuted=function(c){var is_muted=!c.is_im&&TS.notifs.isCorGMuted(c.id);if(is_muted){if(c.is_channel)return"2-9:typemuted -- ";if(c.is_group&&!c.is_mpim)return"2-9:typemuted -- ";if(c.is_slackbot_im)return"3-9:typemuted -- ";if(c.is_self_im)return"4-9:typemuted -- ";if(c.is_mpim)return"7-9:typemuted -- ";if(c.is_im)return"8-9:typemuted -- "}else{if(c.is_channel)return"1-1:typemuted -- ";if(c.is_group&&!c.is_mpim)return TS.model.prefs.separate_private_channels?"2-1:typemuted -- ":"1-1:typemuted -- ";if(c.is_slackbot_im)return"3-1:typemuted -- ";if(c.is_self_im)return"4-1:typemuted -- ";if(c.is_mpim)return"5-1:typemuted -- ";if(c.is_im)return"6-1:typemuted -- "}};var _getSortStrForTypeAndMutedAfterStarred=function(c){var is_muted=!c.is_im&&TS.notifs.isCorGMuted(c.id);if(c.is_starred){if(is_muted){if(c.is_channel)return"9-1:typemuted -- ";if(c.is_group&&!c.is_mpim)return"9-1:typemuted -- ";if(c.is_slackbot_im)return"9-2:typemuted -- ";if(c.is_self_im)return"9-3:typemuted -- ";if(c.is_mpim)return"9-4:typemuted -- ";if(c.is_im)return"9-5:typemuted -- "}else{if(c.is_channel)return"1-1:typemuted -- ";if(c.is_group&&!c.is_mpim)return"1-1:typemuted -- ";if(c.is_slackbot_im)return"1-2:typemuted -- ";if(c.is_self_im)return"1-3:typemuted -- ";if(c.is_mpim)return"1-4:typemuted -- ";if(c.is_im)return"1-5:typemuted -- "}}else{return _getSortStrForTypeAndMuted(c)}};var _getSortStrForPriority=function(c){if(!TS.model.channel_sort.priority_type)return"";var priority=TS.client.channel_pane.getPriorityForModelOb(c);return _.padStart(Math.ceil((1-priority)*1e3),4,0)+":priority -- "};var _maybeAugmentSortStrForPriority=function(srt,c){return _getSortStrForPriority(c)+srt};var _sortingByMuted=function(){return TS.model.channel_sort.sorts.indexOf("muted")>-1};var _typeIsPrimarySort=function(){return TS.model.channel_sort.sorts.indexOf("type")==0};var _hasUnreadMentionsIsPrimarySort=function(){return TS.model.channel_sort.sorts.indexOf("has_unread_mentions")==0};var _hasUnreadMessagesIsPrimarySort=function(){return TS.model.channel_sort.sorts.indexOf("has_unread_msgs")==0};var _unreadMentionsCountIsPrimarySort=function(){return TS.model.channel_sort.sorts.indexOf("unread_mentions_count")==0};var _unreadMessagesCountIsPrimarySort=function(){return TS.model.channel_sort.sorts.indexOf("unread_msgs_count")==0};var _sortingByUnread=function(){return _sortingByHasUnreadMentions()||_sortingByHasUnreadMessages()||_sortingByUnreadMentionsCount||_sortingByUnreadMessagesCount()()};var _sortingByHasUnreadMentions=function(){return TS.model.channel_sort.sorts.indexOf("has_unread_mentions")>-1};var _sortingByHasUnreadMessages=function(){return TS.model.channel_sort.sorts.indexOf("has_unread_msgs")>-1};var _sortingByUnreadMentionsCount=function(){return TS.model.channel_sort.sorts.indexOf("unread_mentions_count")>-1};var _sortingByUnreadMessagesCount=function(){return TS.model.channel_sort.sorts.indexOf("unread_msgs_count")>-1};var _starredIsPrimarySort=function(){return TS.model.channel_sort.sorts.indexOf("starred")==0};var _starredThenTypeArePrimarySort=function(){return TS.model.channel_sort.sorts.indexOf("starred")==0&&TS.model.channel_sort.sorts.indexOf("type")==1};var _buildLI=function(c){var html="";var template_args={model_ob:c,show_muted:!!TS.boot_data.feature_sli_channel_priority,show_starred:!!TS.boot_data.feature_sli_channel_priority};if(c.is_im){template_args.member=TS.members.getMemberById(c.user);template_args.color_names=false;template_args.show_close_link=true;html=TS.templates.member(template_args)}else if(c.is_mpim){html=TS.templates.mpim(template_args)}else if(c.is_group){html=TS.templates.group(template_args)}else{html=TS.templates.channel(template_args)}return html};var _updateCreateChannelButton=function(){var can_create_channels=TS.permissions.members.canCreateChannels()||TS.members.canUserCreateGroups();$(".new_channel_btn").toggleClass("hidden",!can_create_channels)};var _getCustomSorterStr=function(c){var handled=[];var c_srt="";if(_starredThenTypeArePrimarySort()){handled.push("starred");handled.push("type");c_srt+=_getSortStrForStarred(c);if(_sortingByMuted()){handled.push("muted");c_srt+=_getSortStrForTypeAndMutedAfterStarred(c)}else{c_srt+=_getSortStrForType(c)}}else if(_typeIsPrimarySort()){handled.push("type");if(_sortingByMuted()){handled.push("muted");c_srt+=_getSortStrForTypeAndMuted(c)}else{c_srt+=_getSortStrForType(c)}}TS.model.channel_sort.sorts.forEach(function(sort){if(handled.indexOf(sort)>-1)return;if(sort=="starred"){c_srt+=_getSortStrForStarred(c)}else if(sort=="type"){c_srt+=_getSortStrForType(c)}else if(sort=="muted"){c_srt+=_getSortStrForMuted(c)}else if(sort=="sli"||sort=="frecency"){c_srt+=_getSortStrForPriority(c)}else if(sort=="has_unread_msgs"){c_srt+=_getSortStrForHasUnreadMsgs(c)}else if(sort=="unread_msgs_count"){c_srt+=_getSortStrForUnreadMsgsCount(c)}else if(sort=="has_unread_mentions"){c_srt+=_getSortStrForHasUnreadMentions(c)}else if(sort=="unread_mentions_count"){c_srt+=_getSortStrForUnreadMentionsCount(c)}});c_srt+=_getSortStrForName(c);return c_srt};var _customSorter=function(a,b){var a_srt=_getCustomSorterStr(a);var b_srt=_getCustomSorterStr(b);if(a_srt<b_srt)return-1;if(a_srt>b_srt)return 1;return 0};var _imsSorter=function(a,b){if(a.is_slackbot_im)return-1;if(b.is_slackbot_im)return 1;if(a.is_self_im)return-1;if(b.is_self_im)return 1;var a_srt=a.is_mpim?TS.mpims.getDisplayNameLowerCase(a):TS.ims.getDisplayNameOfUserForImLowerCase(a);var b_srt=b.is_mpim?TS.mpims.getDisplayNameLowerCase(b):TS.ims.getDisplayNameOfUserForImLowerCase(b);a_srt=_maybeAugmentSortStrForPriority(a_srt,a);b_srt=_maybeAugmentSortStrForPriority(b_srt,b);if(a_srt<b_srt)return-1;if(a_srt>b_srt)return 1;return 0};var _starredSorter=function(a,b){var a_srt=_getSortStrForName(a);var b_srt=_getSortStrForName(b);var a_muted_srt=!a.is_im&&TS.notifs.isCorGMuted(a.id)?"Z":"";var b_muted_srt=!b.is_im&&TS.notifs.isCorGMuted(b.id)?"Z":"";if(TS.model.prefs.separate_private_channels){if(a.is_channel){a_srt=a_muted_srt+"A"+a_srt}else if(a.is_group&&!a.is_mpim){a_srt=a_muted_srt+"B"+a_srt}else if(a.is_slackbot_im){a_srt=a_muted_srt+"C"+a_srt}else if(a.is_self_im){a_srt=a_muted_srt+"D"+a_srt}else{a_srt=a_muted_srt+"E"+a_srt}if(b.is_channel){b_srt=b_muted_srt+"A"+b_srt}else if(b.is_group&&!b.is_mpim){b_srt=b_muted_srt+"B"+b_srt}else if(b.is_slackbot_im){b_srt=b_muted_srt+"C"+b_srt}else if(b.is_self_im){b_srt=b_muted_srt+"D"+b_srt}else{b_srt=b_muted_srt+"E"+b_srt}}else{if(a.is_channel||a.is_group&&!a.is_mpim){a_srt=a_muted_srt+"A"+a_srt}else if(a.is_slackbot_im){a_srt=a_muted_srt+"B"+a_srt}else if(a.is_self_im){a_srt=a_muted_srt+"C"+a_srt}else{a_srt=a_muted_srt+"D"+a_srt}if(b.is_channel||b.is_group&&!b.is_mpim){b_srt=b_muted_srt+"A"+b_srt}else if(b.is_slackbot_im){b_srt=b_muted_srt+"B"+b_srt}else if(b.is_self_im){b_srt=b_muted_srt+"C"+b_srt}else{b_srt=b_muted_srt+"D"+b_srt}}a_srt=_maybeAugmentSortStrForPriority(a_srt,a);b_srt=_maybeAugmentSortStrForPriority(b_srt,b);if(a_srt<b_srt)return-1;if(a_srt>b_srt)return 1;return 0};var _channelSorter=function compare(a,b){var a_srt=a._name_lc;var b_srt=b._name_lc;a_srt=_maybeAugmentSortStrForPriority(a_srt,a);b_srt=_maybeAugmentSortStrForPriority(b_srt,b);if(TS.model.prefs.separate_private_channels){a_srt=(a.is_channel?"a":"z")+a_srt;b_srt=(b.is_channel?"a":"z")+b_srt}if(a_srt<b_srt)return-1;if(a_srt>b_srt)return 1;return 0};var _makeSureActiveChannelIsInView=function(){TS.utility.queueRAF(_actuallyMakeSureActiveChannelIsInView)};var _actuallyMakeSureActiveChannelIsInView=function(){var $active=TS.client.channel_pane.$scroller.find(".section_holder ul li.active");if(!$active.length)return;$active.scrollintoview({offset:"top",px_offset:50,scroller:TS.client.channel_pane.$scroller})};var _updateModelObSortCountValues=function(c){if(TS.model.sorting_mode_is_showing||c.id!=TS.model.active_cid){c._sorting_unread_highlight_cnt=c.unread_highlight_cnt;c._sorting_unread_cnt=c.unread_cnt}};var _rebuildCustomListThrottled=function(){_rebuildCustomList()};var _rebuildCustomList=function(){var start=Date.now();var all=_getSortedCustomList();if(!all.length){TS.error("no channels at all?");return}var unread_html="";var starred_html="";var everything_html="";var channels_html="";var dms_html="";var unread_mentions_is_primary=_hasUnreadMentionsIsPrimarySort()||_unreadMentionsCountIsPrimarySort();var unread_messages_is_primary=_hasUnreadMessagesIsPrimarySort()||_unreadMessagesCountIsPrimarySort();all.forEach(function(c){var html=_buildLI(c);var has_unread_highlights=c._sorting_unread_highlight_cnt||(c.is_im||c.is_mpim)&&c._sorting_unread_cnt;if(unread_mentions_is_primary&&has_unread_highlights){unread_html+=html}else if(unread_messages_is_primary&&c._sorting_unread_cnt){unread_html+=html}else if(_starredIsPrimarySort()&&c.is_starred){starred_html+=html}else if(_starredThenTypeArePrimarySort()||_typeIsPrimarySort()){if(c.is_im||c.is_mpim){dms_html+=html}else{channels_html+=html}}else{everything_html+=html}});$("#starred-list").html(starred_html);$("#everything-list").html(everything_html);$("#unread-list").html(unread_html);$("#channel-list").html(channels_html);$("#im-list").html(dms_html);$("#starred_div").toggleClass("hidden",!starred_html);$("#everything").toggleClass("hidden",!everything_html);$("#unread").toggleClass("hidden",!unread_html);$("#channels").toggleClass("hidden",!channels_html);$("#direct_messages").toggleClass("hidden",!dms_html);if(everything_html){$("#everything_else").toggleClass("hidden",!starred_html&&!unread_html);$("#everything_at_top").toggleClass("hidden",!!starred_html||!!unread_html)}if(unread_html){$("#unread_msgs").toggleClass("hidden",unread_mentions_is_primary);$("#unread_mntns").toggleClass("hidden",unread_messages_is_primary)}TS.log(91,"after htmling "+(Date.now()-start));_updateCreateChannelButton();_rebuildChannelHeaderCount();_rebuildDmHeaderCount();if(!TS.environment.supports_custom_scrollbar){TS.ui.utility.updateClosestMonkeyScroller($("#everything-list"))}TS.ui.admin_invites.maybeShowInviteLink();TS.client.ui.checkUnseenChannelsImsGroupsWithUnreads();TS.log(91,"after everything "+(Date.now()-start))};var _getSortedStarredList=function(){var channels=TS.channels.getChannelsForUser();var groups=TS.model.groups;var ims=TS.model.ims;var A=[];var i;var channel;var group;var im;var member;for(i=0;i<channels.length;i++){channel=channels[i];if(!channel.is_starred)continue;var display_because_archives=TS.model.archive_view_is_showing&&TS.client.archives.current_model_ob.id==channel.id;if(channel.is_member||channel.was_archived_this_session||display_because_archives){A.push(channel)}}for(i=0;i<groups.length;i++){group=groups[i];if(!group.is_starred)continue;if(group.is_archived&&!group.was_archived_this_session)continue;A.push(group)}_starred_members.clear();for(i=0;i<ims.length;i++){im=ims[i];if(!im.is_starred)continue;member=TS.members.getMemberById(im.user);if(member.deleted)continue;if(!im.is_open&&!im.unread_cnt)continue;A.push(im);_starred_members.add(member.id)}var mpims=TS.model.mpims;var mpim;for(i=0;i<mpims.length;i++){mpim=mpims[i];if(!mpim.is_starred)continue;if(!mpim.is_open&&!mpim.unread_cnt)continue;A.push(mpim)}A.sort(_starredSorter);return A};var _rebuildStarredList=function(){var A=_getSortedStarredList();var html="";$("#starred_div").toggleClass("hidden",!A.length);A.forEach(function(c){html+=_buildLI(c)});$("#starred-list").html(html);if(!TS.environment.supports_custom_scrollbar){TS.ui.utility.updateClosestMonkeyScroller($("#starred-list"))}TS.client.ui.checkUnseenChannelsImsGroupsWithUnreads()};var _getSortedChannelList=function(){var channels=TS.channels.getChannelsForUser();var channel;var display_channels=[];var muted_channels=[];var groups=TS.model.groups;var display_groups=[];var muted_groups=[];for(var i=0;i<channels.length;i++){channel=channels[i];var display_because_archives=TS.model.archive_view_is_showing&&TS.client.archives.current_model_ob.id==channel.id;if(channel.is_starred)continue;if(channel.is_member||channel.was_archived_this_session||display_because_archives){if(TS.notifs.isCorGMuted(channel.id)){muted_channels.push(channel)}else{display_channels.push(channel)}}}$.each(groups,function(i,group){var display_because_archives=TS.model.archive_view_is_showing&&TS.client.archives.current_model_ob.id==group.id;if(group.is_archived&&!group.was_archived_this_session&&!display_because_archives)return;if(group.is_starred)return;if(TS.notifs.isCorGMuted(group.id)){muted_groups.push(group)}else{display_groups.push(group)}});var all_unmuted=display_channels.concat(display_groups);var all_muted=muted_channels.concat(muted_groups);all_unmuted.sort(_channelSorter);all_muted.sort(_channelSorter);return all_unmuted.concat(all_muted)};var _rebuildChannelsList=function(){var all_channels=_getSortedChannelList();var display_total=all_channels.length;_updateCreateChannelButton();if(TS.model.user.is_restricted){if(!TS.permissions.members.canCreateChannels()&&!TS.members.canUserCreateGroups()&&0===display_total){$("#channels").addClass("hidden");return}}$("#channels").removeClass("hidden");if(!TS.model.user.is_ultra_restricted){var $channels_header=$("#channels_header");var header_clickable=!TS.model.user.is_restricted;$channels_header.find(".channel_list_header_label").tooltip("destroy");$channels_header.toggleClass("hoverable",header_clickable);if(header_clickable){var tooltip_title=TS.model.user.is_restricted?"Browse channels":"Browse all channels";$channels_header.find(".channel_list_header_label").tooltip({placement:"top-left",container:"body",delay:{show:400,hide:150},title:tooltip_title})}}var channels_html="";all_channels.forEach(function(c){channels_html+=_buildLI(c)});$("#channel-list").html(channels_html);_rebuildChannelHeaderCount();if(!TS.environment.supports_custom_scrollbar){TS.ui.utility.updateClosestMonkeyScroller($("#channel-list"))}TS.client.ui.checkUnseenChannelsImsGroupsWithUnreads()};var _getSortedDmList=function(){var ims=[];var mpims=TS.mpims.getVisibleMpims();var muted_mpims=[];_open_im_mpims=0;_openable_im_mpims=0;_dm_members.clear();TS.members.getMembersForUser().forEach(function(member){if(member.deleted)return;var im=TS.ims.getImByMemberId(member.id);if(!im||!im.is_open&&!im.unread_cnt){_openable_im_mpims++;return}_open_im_mpims++;if(im.is_starred)return;ims.push(im)});_dm_members.add(_.map(ims,"user"));mpims=mpims.filter(function(mpim){if(!mpim.is_open&&!mpim.unread_cnt){_openable_im_mpims++;return false}_open_im_mpims++;if(mpim.is_starred)return false;if(TS.notifs.isCorGMuted(mpim.id)){muted_mpims.push(mpim);return false}return true});var all_unmuted=ims.concat(mpims);all_unmuted.sort(_imsSorter);muted_mpims.sort(_imsSorter);return all_unmuted.concat(muted_mpims)};var _rebuildDmList=function(){var all_ims=_getSortedDmList();var html="";all_ims.forEach(function(c){html+=_buildLI(c)});$("#im-list").html(html);$("#direct_messages").removeClass("hidden");if(!TS.environment.supports_custom_scrollbar){TS.ui.utility.updateClosestMonkeyScroller($("#im-list"))}_rebuildDmHeaderCount();TS.ui.admin_invites.maybeShowInviteLink();TS.client.ui.checkUnseenChannelsImsGroupsWithUnreads()};var _getSortedCustomList=function(){var all=[];_openable_im_mpims=0;_open_im_mpims=0;TS.channels.getChannelsForUser().forEach(function(model_ob){_updateModelObSortCountValues(model_ob);var display_because_archives=TS.model.archive_view_is_showing&&TS.client.archives.current_model_ob.id==model_ob.id;if(model_ob.is_member||model_ob.was_archived_this_session||display_because_archives){all.push(model_ob)}});TS.model.groups.forEach(function(model_ob){_updateModelObSortCountValues(model_ob);if(model_ob.is_archived&&!model_ob.was_archived_this_session)return;all.push(model_ob)});TS.members.getMembersForUser().forEach(function(member){if(member.deleted)return;var im=TS.ims.getImByMemberId(member.id);if(im)_updateModelObSortCountValues(im);if(!im||!im.is_open&&!im._sorting_unread_cnt){_openable_im_mpims++;return}_open_im_mpims++;all.push(im)});TS.model.mpims.forEach(function(model_ob){_updateModelObSortCountValues(model_ob);if(!model_ob.is_open&&!model_ob._sorting_unread_cnt){_openable_im_mpims++;return}_open_im_mpims++;all.push(model_ob)});all.sort(_customSorter);return all};var _getSortedNormalList=function(){return _getSortedStarredList().concat(_getSortedChannelList(),_getSortedDmList())};var _updateChannelPaneFooterVisibility=function(){var is_footer_hidden=TS.model.prefs.no_omnibox_in_channels;if(TS.boot_data.feature_prev_next_button){is_footer_hidden=is_footer_hidden&&TS.model.prefs.prev_next_btn}var $channel_scroll_down=$("#channel_scroll_down");$("#col_channels_footer").toggleClass("hidden",is_footer_hidden);$channel_scroll_down.toggleClass("no_sidebar_footer",!is_footer_hidden);TS.utility.queueRAF(function(){TS.view.resizeManually("TS.client.channel_pane _updateChannelPaneFooterVisibility")})};var _rebuildQuickSwitcherBtn=function(){$("#quick_switcher_btn").off().html(TS.templates.builders.buildQuickSwitcherBtnHtml()).on("click",function(){if(TS.newxp.inOnboarding())return false;TS.ui.jumper.start();TS.clog.track("QUICKSWITCHER_ACTION",{click_target:"quick_switcher_btn",trigger:"quick_switcher_btn",action:"opened"})});TS.client.channel_pane.updateQuickSwitcherBtnVisibility()}})();(function(){"use strict";TS.registerModule("client.channel_header",{onStart:function(){_member_presence_list=TS.presence_manager.createList();TS.members.presence_changed_sig.add(_memberChanged);TS.members.changed_deleted_sig.add(_memberChanged);TS.dnd.dnd_statuses_changed_sig.add(_dndStatusesChanged);TS.prefs.muted_channels_changed_sig.add(_setMutedDisplay);TS.groups.member_left_sig.add(_CorGChanged);TS.groups.member_joined_sig.add(_CorGChanged);TS.groups.topic_changed_sig.add(_topicChanged);TS.groups.converted_to_shared_sig.add(_convertedToShared);TS.channels.member_left_sig.add(_CorGChanged);TS.channels.member_joined_sig.add(_CorGChanged);TS.channels.topic_changed_sig.add(_topicChanged);TS.channels.joined_sig.add(_getChannelTopic);TS.channels.converted_to_shared_sig.add(_convertedToShared);if(TS.boot_data.feature_pin_update){TS.pins.pinned_status_changed_sig.add(_buildPinnedItemsLink);TS.pins.pinned_message_changed_sig.add(_buildPinnedItemsLink);TS.pins.pinned_message_deleted_sig.add(_buildPinnedItemsLink);TS.pins.pins_fetched_sig.add(_buildPinnedItemsLink);TS.channels.marked_sig.add(_markUnreadPinIcon);TS.groups.marked_sig.add(_markUnreadPinIcon);TS.mpims.marked_sig.add(_markUnreadPinIcon);TS.ims.marked_sig.add(_markUnreadPinIcon)}if(TS.boot_data.feature_message_replies_threads_view){TS.client.threads.reply_count_changed.add(_replyCountChanged)}TS.prefs.a11y_font_size_changed_sig.add(_updateChannelHeader);_$header=$("#client_header .channel_header .messages_header");_$header.bind("mouseover mouseenter",function(e){$("#topic_inline_edit").toggleClass("inline_edit_hover",!!$(e.target).is("#topic_inline_edit"));_$header.toggleClass("hover_topic",!!$(e.target).closest(".inline_edit_inner").length)}).bind("mouseout",function(e){_$header.removeClass("hover_topic")});TS.experiment.loadUserAssignments().then(function(){var group=TS.experiment.getGroup("channel_starring");_star_below_channel_name=group==="star_below_channel_name";TS.client.channel_header.start()})},test:function(){var test_ob={};Object.defineProperty(test_ob,"_$header",{get:function(){return _$header},set:function(v){_$header=v}});return test_ob},start:function(){_model_ob=TS.shared.getActiveModelOb();if(!_model_ob&&!TS.client.activeChannelIsHidden()){TS.warn("TS.client.channel_header.start cannot find channel, im, or group.");return}var is_im;var is_mpim;var is_shared=false;var show_topic=false;var im;var member;var mpim;var name;_member_presence_list.clear();if(_model_ob){if(TS.model.active_im_id){im=TS.ims.getImById(TS.model.active_im_id);member=TS.members.getMemberById(im.user);is_im=true;_member_presence_list.add(member.id)}if(TS.model.active_mpim_id){mpim=TS.mpims.getMpimById(TS.model.active_mpim_id);is_mpim=true;_member_presence_list.add(mpim.members)}if(TS.model.active_channel_id||TS.model.active_group_id){show_topic=true;if(TS.model.user.is_restricted&&(!_model_ob.topic||!_model_ob.topic.value))show_topic=false}is_shared=TS.boot_data.page_needs_enterprise&&_model_ob.is_shared;name=_model_ob.name}var template_args={is_shared:is_shared,name:name,member:member,is_dm_or_mpdm:is_im||is_mpim,show_topic:show_topic,move_star_in_channel_header:_star_below_channel_name,mpim:mpim,details_showing:$("#client-ui").hasClass("details_showing"),is_recap:TS.boot_data.feature_sli_recaps,all_unreads:{is_showing:TS.model.unread_view_is_showing,has_new_messages:TS.model.unread_view_is_showing&&TS.client.unread.new_messages_in_channels.length,messages_loaded:TS.client.unread.messages_loaded,total_unread_count:TS.client.unread.getTotalMessagesCount(),sort_order:TS.client.unread.getSortOrder()},threads:{is_showing:TS.model.threads_view_is_showing,reply_count:TS.boot_data.feature_message_replies_threads_view&&TS.client.threads.getCurrentReplyCount()}};_$header.html(TS.templates.channel_header(template_args));if(TS.model.active_im_id){_makeDMHeaderInfo();if(!TS.boot_data.feature_name_tagging_client)_dealWithDMNames(member)}_getChannelNamePrefix();_buildPinnedItemsLink();_getChannelTopic();_buildChannelMemberList();_buildStars();_setMutedDisplay();_buildCallsUI();_bindChannelMenu();_bindUnreadView()},updateChannelHeaderInfo:function($html){_$header.find("#channel_header_info").html($html)},clearUnreadPinState:function(){_togglePinIconFill(false);$("#pinned_item_count .pin_count_new_pin_message").empty()}});var _model_ob;var _$header;var _member_presence_list;var _star_below_channel_name=false;var _buildChannelMemberList=function(){TS.client.ui.rebuildMemberListToggle()};var _memberChanged=function(member){if(!TS.model.ms_connected)return;if(!member)return;if(_model_ob&&_model_ob.members&&_model_ob.members.indexOf(member.id)>-1){_buildChannelMemberList()}_updateDMMemberStatus(member)};var _buildPinnedItemsLink=function(){if(!TS.boot_data.feature_pin_update)return;if(!_model_ob&&TS.boot_data.feature_unread_view)return;var $pinned_count=$("#pinned_item_count");var $pinned_count_divider=$("#pinned_count_divider");var $pinned_count_number=$("#pinned_item_count_count");var pins=_model_ob.pinned_items;_markUnreadPinIcon(_model_ob);if(!_model_ob.has_pins){if(_model_ob.is_channel){$pinned_count_number.html("0")}else{$pinned_count.hide();$pinned_count_divider.hide()}}else if(!pins){$pinned_count_number.html(" ")}else{$pinned_count_number.html(pins.length);if(!_model_ob.is_channel){$pinned_count.show();$pinned_count_divider.show()}}};var _markUnreadPinIcon=function(model_ob){if(!model_ob)return;var unread_pins=TS.pins.getUnreadPins(model_ob);if(_.isEmpty(unread_pins)){TS.client.channel_header.clearUnreadPinState();return}_togglePinIconFill(true);var pin_tooltip_message;if(unread_pins.length===1){var user_id=unread_pins[0].created_by;if(!user_id)return;var user_display_name=TS.members.getMemberDisplayNameById(user_id);pin_tooltip_message="1 new pin by "+user_display_name}else{pin_tooltip_message=unread_pins.length+" new pins"}var $pin_count_new_pin_message=$("#pinned_item_count .pin_count_new_pin_message");$pin_count_new_pin_message.html(pin_tooltip_message)};var _togglePinIconFill=function(should_be_filled){var $pinned_count_icon=$("#pinned_item_count .pinned_count_icon");if($pinned_count_icon.length===0)return;$pinned_count_icon.toggleClass("is_filled",should_be_filled)};var _CorGChanged=function(changed_model_ob){if(!_model_ob||!changed_model_ob||_model_ob.id!==changed_model_ob.id)return;_buildChannelMemberList()};var _getChannelNamePrefix=function(){if(_model_ob.is_mpim||_model_ob.is_im)return;var prefix;if(_model_ob.is_group||_model_ob.is_private){prefix='<i class="ts_icon ts_icon_lock"></i>';$("#channel_title").prepend(prefix)}else if(TS.model.active_channel_id){prefix="#";$("#channel_title").prepend(prefix)}};var _dealWithDMNames=function(member){var display_name=TS.members.getMemberDisplayName(member);var $status_display=$("#channel_header_info .header_user_status");var alt_name_container='<span class="topic_divider">|</span><span class="member_alt_name_header"></span>';var alt_name;if(display_name!==member.profile.real_name){$("#im_title").prepend("@")}if(display_name!==member.profile.real_name&&member.profile.real_name){alt_name=member.profile.real_name;$status_display.append(alt_name_container);$("#channel_header_info .member_alt_name_header").text(alt_name)}else if(display_name===member.profile.real_name){alt_name="@"+member.name;$status_display.append(alt_name_container);$("#channel_header_info .member_alt_name_header").text(alt_name)}};var _makeDMHeaderInfo=function(){var $user_status=$("#channel_header_info .header_user_status");var im=TS.ims.getImById(TS.model.active_im_id);var member=TS.members.getMemberById(im.user);var presence_state=TS.templates.makeMemberPresenceStateClass(member);var member_presence=TS.templates.makeMemberPresenceDomClass(member.id);var member_dom_id=TS.templates.makeMemberDomId(member);$user_status.addClass(presence_state).addClass(member_presence).addClass(member_dom_id);_updateDMMemberStatus(member)};var _updateDMMemberStatus=function(member){if(!TS.model.active_im_id)return;var im=TS.ims.getImById(TS.model.active_im_id);if(member!=TS.members.getMemberById(im.user)){return}var is_shared=false;var $shared_icon;if(TS.boot_data.page_needs_enterprise&&_model_ob&&_model_ob.is_shared){is_shared=true;$shared_icon=_$header.find(".ts_icon_shared_channel");
$shared_icon.removeClass("away")}var status;var $im_title=$("#im_title");$im_title.removeClass("away");if(member.presence==="active"){status="active"}else if(member.presence==="away"){status="away";$im_title.addClass("away");if(is_shared)$shared_icon.addClass("away")}else{status=member.presence}if(member.is_restricted){if(member.is_ultra_restricted){status="Single-Channel Guest"}else{status=TS.templates.builders.raLabel("Restricted Account")}}if(member._is_in_dnd){status="notifications snoozed"}$("#header_status_message").html(status)};var _dndStatusesChanged=function(members){if(!members||!members.length)return;if(TS.model.active_im_id){var im=TS.ims.getImById(TS.model.active_im_id);var member=TS.members.getMemberById(im.user);var member_ids=_.map(members,"id");var index_of_current_im_in_members=member_ids.indexOf(member.id);if(index_of_current_im_in_members>-1){_updateDMMemberStatus(member)}}};var _buildStars=function(){if(!_model_ob&&TS.boot_data.feature_unread_view)return;var star="";if(TS.model.active_im_id){var im=TS.ims.getImById(TS.model.active_im_id);if(im){star=TS.templates.builders.buildStarWithTip("im",im)}}else if(TS.model.active_channel_id){star=TS.templates.builders.buildStarWithTip("channel",_model_ob)}else if(TS.model.active_group_id){star=TS.templates.builders.buildStarWithTip("group",_model_ob)}else if(TS.model.active_mpim_id){star=TS.templates.builders.buildStarWithTip("mpim",_model_ob)}$("#star_container").html(star)};var _setMutedDisplay=function(){if(!_model_ob&&TS.boot_data.feature_unread_view)return;if(TS.client.activeChannelIsHidden())return;var is_muted=TS.notifs.isCorGMuted(_model_ob.id);var bell='<i class="ts_icon ts_icon_bell_slash muted_icon"></i>';var mute_tip='<span class="ts_tip_tip">Unmute</span>';var $mute_icon=$("#mute_container");var muted_class="muted";var $channel_name=$("#channel_name");if(TS.model.active_im_id){return}if(is_muted){$mute_icon.html(mute_tip+bell);$channel_name.addClass(muted_class);$("#mute_container .muted_icon").bind("click",function(e){e.stopPropagation();TS.notifs.muteOrUnmuteCorG(_model_ob.id)})}else{$mute_icon.empty();$channel_name.removeClass(muted_class)}};var _getChannelTopic=function(){if(!_model_ob&&TS.boot_data.feature_unread_view)return;var can_edit_topic=(_model_ob.is_member||_model_ob.is_group)&&!TS.model.user.is_ultra_restricted&&!TS.model.user.is_restricted&&(!_model_ob.is_general||TS.members.canUserPostInGeneral());var topic_text;var $channel_topic_text=$("#channel_topic_text");if(_model_ob.topic&&_model_ob.topic.value){topic_text=TS.utility.formatTopicOrPurpose(_model_ob.topic.value,true)}$channel_topic_text.html(topic_text);if(can_edit_topic){$("#topic_inline_edit").addClass("inline_edit_editable");var data_attr_name=_model_ob.is_group?"group-id":"channel-id";$channel_topic_text.data(data_attr_name,_model_ob.id);$channel_topic_text.data("inline-edit-unformatted",_model_ob.topic.value)}_maybeAddIEClassname();var _$channel_topic_editable=_$header.find("#topic_inline_edit");_$channel_topic_editable.on("click",function(e){TSSSB.call("updateNoDragRegion",{id:"channel-topic",width:_$channel_topic_editable.outerWidth(),height:_$channel_topic_editable.outerHeight(),top:_$channel_topic_editable.offset().top,left:_$channel_topic_editable.offset().left})})};var _maybeAddIEClassname=function(){var model=TS.model;if(model.is_IE){$("#topic_inline_edit").addClass("in_ie")}};var _topicChanged=function(){if(TS.ui.inline_edit.containsActiveElement(_$header))return;TS.client.channel_header.start()};var _convertedToShared=function(){TS.client.channel_header.start()};var _buildCallsUI=function(){if(!_model_ob&&TS.boot_data.feature_unread_view)return;_destroyCallButton();if(TS.model.active_im_id){var im=TS.ims.getImById(TS.model.active_im_id);var member=TS.members.getMemberById(im.user);TS.client.msg_pane.maybeSetupCalls(member)}else if(TS.model.active_channel_id||TS.model.active_group_id){TS.client.msg_pane.maybeSetupCalls()}else if(TS.model.active_mpim_id){var mpim_ob=TS.mpims.getMpimById(TS.model.active_mpim_id);TS.client.msg_pane.maybeSetupCalls(false,mpim_ob)}$(".channel_calls_button").addClass("blue_hover")};var _bindUnreadView=function(){if(TS.boot_data.feature_unread_view&&TS.model.unread_view_is_showing){$("#channel_header_unread_refresh").on("click",function(){TS.client.unread.reload()});if(TS.model.unread_view_is_showing){_$header.on("click",".channel_header_info_sort_order",TS.menu.startWithAllUnreadsSortOrderMenu)}}};var _bindChannelMenu=function(){if(TS.client.activeChannelIsHidden()&&(TS.boot_data.feature_unread_view||TS.boot_data.feature_message_replies_threads_view))return;if(TS.newxp.inOnboarding())return false;var $actions_toggle=$("#channel_actions_toggle, #channel_name");if(TS.model.active_channel_id){$actions_toggle.on("click.channel_actions",function(e){TS.menu.channel.startWithChannel(e,_model_ob.id)})}else if(TS.model.active_group_id){$actions_toggle.on("click.channel_actions",function(e){TS.menu.group.startWithGroup(e,_model_ob.id)})}else if(TS.model.active_im_id){var im=TS.ims.getImById(TS.model.active_im_id);$actions_toggle.on("click.channel_actions",function(e){if(im)TS.menu.member.startWithMember(e,im.user,false,false,true)})}else if(TS.model.active_mpim_id){$actions_toggle.on("click.channel_actions",function(e){TS.menu.mpim.startWithMpim(e,_model_ob.id)})}};var _destroyCallButton=function(){$(".channel_calls_button").remove()};var _updateChannelHeader=function(){var font_size=TS.model.prefs.a11y_font_size;var $recent_mentions_toggle=$("#recent_mentions_toggle");var is_font_default=font_size=="normal";$recent_mentions_toggle.toggleClass("ts_tip_rightish",!is_font_default)};var _replyCountChanged=function(new_reply_count){var $threads_header_info=$("#channel_header_info.threads_channel_header_info");if(!new_reply_count){$threads_header_info.addClass("hidden");$threads_header_info.empty();return}var text=TS.i18n.t("{new_reply_count,plural,=1{{new_reply_count} new reply}other{{new_reply_count} new replies}}","threads")({new_reply_count:new_reply_count});$threads_header_info.text(text);$threads_header_info.removeClass("hidden")}})();(function(){"use strict";TS.registerModule("client.flex_pane",{onStart:function(){_toaster.init()},startLocalTimeInterval:function(){clearInterval(_local_time_interval);_local_time_interval=setInterval(_updateTimezoneLabels,6e4);_updateTimezoneLabels()},stopLocalTimeInterval:function(){clearInterval(_local_time_interval)},maybeFetchFileList:function(){if(!TS.model.team)return;if(!TS.model.ui_state||!TS.model.ui_state.flex_visible||TS.model.ui_state.flex_name!=="files"||TS.model.ui_state.flex_extra){return}var types_str=(_.isArray(TS.model.file_list_types)&&TS.model.file_list_types||["all"]).sort().join(",");var list_type=$("#file_list").data("list");var key;if(list_type=="all"){key=_makeFileFetchKey("team",types_str);if(!_file_fetch_records[key]){_file_fetch_records[key]=true;TS.files.fetchTeamFiles(types_str,_onFilesFetched)}return}var member_id=$("#file_list").data("filter-user")||"";if(!member_id)return;key=_makeFileFetchKey(member_id,types_str);if(!_file_fetch_records[key]){_file_fetch_records[key]=true;TS.files.fetchMemberFiles(member_id,types_str,_onFilesFetched)}}});var _file_fetch_records={};var _makeFileFetchKey=function(scope,type_str){scope=scope||"team";type_str=type_str||"all";return scope+"_"+type_str};var _onFilesFetched=function(ok,data,args){if(!ok){delete _file_fetch_records[_makeFileFetchKey(args.user,args.types)];return}TS.view.files.throttledRebuildList()};var _local_time_interval;var _updateTimezoneLabels=function(){TS.utility.throttle.method(_updateTimezoneLabelsThrottled,"view_tz_labels",1e3)};var _updateTimezoneLabelsThrottled=function(){var member;var nodes=$(".timezone_label");var times=[];nodes.each(function(index,element){element=$(element);member=TS.members.getMemberById(element.data("member-id"));if(!member){times.push("");return}times.push(TS.utility.date.memberLocalTime(member,true));member=null;element=null});nodes.each(function(index,element){element=$(element);element.find(".timezone_value").text(times[index]);element=null});nodes=null};var _toaster=function(){var _rxn_record;var _hide_timer;var _show_timer;var _show_delay_ms=500;var _show_ms=3e3;var _fade_out_ms=400;var _fade_in_ms=300;var _$rxn_toast_div;var _updateRxnRecordsUI=function(show_toast){TS.view.rebuildMentions();if(!show_toast)return;clearTimeout(_show_timer);_show_timer=setTimeout(function(){if(_rxn_record)return;_maybeShow()},_show_delay_ms)};var _build=function(){$(".flex_header").append('<div id="rxn_toast_div" class="hidden ts_tip ts_tip_bottom"></div>');_$rxn_toast_div=$("#rxn_toast_div");_$rxn_toast_div.on("click",function(){var flex_name="mentions";if(!TS.model.ui_state.flex_visible||TS.model.ui_state.flex_name!==flex_name){TS.client.ui.flex.openFlexTab(flex_name)}_hide()});_$rxn_toast_div.on("mouseenter",function(){$("html").unbind("mousemove.rxn_toast");_cancelHideTimer()});_$rxn_toast_div.on("mouseleave",function(){_startHideTimer()})};var _maybeShow=function(){var rxn_record=TS.rxns.getNextRxnRecordThatNeedsAlert();if(!rxn_record)return;if(!rxn_record.emoji)return TS.error("rxn_record.emoji missing");if(!Object.keys(rxn_record.emoji).length)return TS.error("rxn_record.emoji is empty");_rxn_record=rxn_record;var since=TS.rxns.need_alerts[rxn_record.rxn_key];if(!since)TS.error("WTF no since");var total_needing_toast=0;var oldest_who_when;var emoji_name;for(var name in rxn_record.emoji){rxn_record.emoji[name].forEach(function(who_when){if(who_when.was_toasted)return;if(who_when.when<since)return;who_when.rxn_source=rxn_record.source;total_needing_toast++;if(!oldest_who_when||who_when.when<oldest_who_when.when){oldest_who_when=who_when;emoji_name=name}})}if(!emoji_name){TS.error("WTF no emoji_name");TS.dir(0,rxn_record,"rxn_record")}if(!oldest_who_when)TS.error("WTF no oldest_who_when");oldest_who_when.was_toasted=true;if(total_needing_toast==1){delete TS.rxns.need_alerts[rxn_record.rxn_key]}var rxn_source_ob=TS.shared.getModelObById(oldest_who_when.rxn_source);var rxn_source_info;if(rxn_source_ob.is_im){rxn_source_info="Direct Message"}else if(rxn_source_ob.is_group&&rxn_source_ob.is_mpim){rxn_source_info=TS.mpims.getDisplayName(rxn_source_ob,false)}else if(rxn_source_ob.is_group&&!rxn_source_ob.is_mpim){rxn_source_info=rxn_source_ob.name}else if(rxn_source_ob.is_channel){rxn_source_info="#"+rxn_source_ob.name}var rxn_source_member;if(TS.boot_data.feature_name_tagging_client){rxn_source_member=TS.utility.htmlEntities(TS.members.getMemberFullName(oldest_who_when.id))}else{rxn_source_member=TS.members.getMemberDisplayNameById(oldest_who_when.id,true)}var rxn_tip='<span class="ts_tip_tip"><span>&nbsp;&nbsp;'+rxn_source_member+"&nbsp;&nbsp;</span><br><span>"+rxn_source_info+"</span></span>";var rxn_toast_div_top=_$rxn_toast_div.css("top");var content=TS.emoji.graphicReplace(":"+emoji_name+":")+rxn_tip;var top_pos=-(50+_$rxn_toast_div.height());_$rxn_toast_div.html(content).removeClass("hidden");var class_name=_$rxn_toast_div.find(".ts_tip_tip").outerWidth()>150?"ts_tip_rightish":"";_$rxn_toast_div.addClass(class_name).css({opacity:0,top:top_pos}).transition({opacity:1,top:rxn_toast_div_top},_fade_in_ms);_startHideTimer();if(TS.boot_data.feature_message_replies){$("#client-ui").addClass("rxn_toasting")}$("html").bind("mousemove.rxn_toast",_startHideTimer)};var _startHideTimer=function(){clearTimeout(_hide_timer);_hide_timer=setTimeout(_hide,_show_ms)};var _cancelHideTimer=function(){clearTimeout(_hide_timer);_$rxn_toast_div.css("opacity",1)};var _hide=function(){_cancelHideTimer();_$rxn_toast_div.transition({opacity:0},_fade_out_ms);$("html").unbind("mousemove.rxn_toast");_hide_timer=setTimeout(function(){_$rxn_toast_div.addClass("hidden");if(TS.boot_data.feature_message_replies){$("#client-ui").removeClass("rxn_toasting")}_after()},_fade_out_ms+1)};var _after=function(){_rxn_record=null;_maybeShow()};return{init:function(){_build();TS.rxns.rxn_records_changed_sig.add(TS.utility.throttleFunc(_updateRxnRecordsUI,100,true))}}}()})();(function(){"use strict";TS.registerModule("client.msg_pane",{last_render_time:null,last_rendered_msg:null,last_in_stream_msg:null,dont_check_unreads_til_switch:false,date_change_timer:null,new_msgs_bar_showing:false,onStart:function(){_member_presence_list=TS.presence_manager.createList();TS.team.team_email_domain_changed_sig.add(_updateGeneralChannelMetaInviteAction,TS.client.msg_pane);TS.team.team_domain_changed_sig.add(_updateGeneralChannelMetaInviteAction,TS.client.msg_pane);TS.team.team_name_changed_sig.add(_updateGeneralChannelMetaInviteAction,TS.client.msg_pane);TS.prefs.team_auth_mode_changed_sig.add(_updateGeneralChannelMetaInviteAction,TS.client.msg_pane);TS.prefs.team_allow_calls_changed_sig.add(_updateCallButtonAccordingToPrefs,TS.client.msg_pane);if(TS.boot_data.feature_platform_calls){TS.prefs.team_calling_app_name_changed_sig.add(_updateCallButtonAccordingToPrefs,TS.client.msg_pane);TS.utility.calls.started_platform_call_sig.add(_platformCallsSignalHandler,TS.client.msg_pane)}TS.members.changed_admin_perms_sig.add(_updateGeneralChannelMetaInviteAction,TS.client.msg_pane);TS.prefs.dtop_notif_changed_sig.add(_notifPrefChanged);TS.prefs.team_perms_pref_changed_sig.add(_notifPrefChanged);TS.prefs.muted_channels_changed_sig.add(_notifPrefChanged);TS.ui.growls.permission_changed_sig.add(_notifPrefChanged);TS.channels.converted_to_shared_sig.add(_convertedToShared);TS.groups.converted_to_shared_sig.add(_convertedToShared);TS.channels.shared_teams_updated_sig.add(_sharedTeamsUpdated);TS.groups.shared_teams_updated_sig.add(_sharedTeamsUpdated);TS.client.msg_pane.initDateChange();if(bowser&&bowser.msie&&bowser.version<11&&_msgs_bar_hidden_class_names){_msgs_bar_hidden_class_names+=" hidden"}},initDateChange:function(){var timer_interval_minutes=15;if(!TS.client.msg_pane.date_change_timer){TS.client.msg_pane.date_change_timer=window.setInterval(function(){TS.utility.throttle.method(TS.client.msg_pane.checkForDateChange,"date_change_check",1e3)},1e3*60*timer_interval_minutes)}},checkForDateChange:function(){if(TS.model&&TS.model.active_cid&&TS.client.msg_pane.last_render_time&&TS.client.msg_pane.last_render_time.getDay()!==(new Date).getDay()){TS.client.msg_pane.rebuildMsgs()}},rebuildChannelMembersList:function(){if(TS.members.is_in_bulk_upsert_mode){if(!_will_rebuild_channel_members_list){_will_rebuild_channel_members_list=true;TS.members.batch_upserted_sig.addOnce(function(){_will_rebuild_channel_members_list=false;TS.client.msg_pane.rebuildChannelMembersList()})}return}TS.client.ui.rebuildMemberListToggle()},rebuildMsgsWithReason:function(reason){var call_again;TS.client.msg_pane.rebuildMsgs(call_again,reason)},rebuildMsgs:function(call_again,reason){var model_ob=TS.shared.getActiveModelOb();if(!model_ob){return}TS.client.msg_pane.is_rebuilding=true;var all_unknowns=[];if(typeof call_again==="undefined")call_again=true;var edit_state;if(TS.msg_edit.editing&&TS.msg_edit.editing_in_msg_pane)edit_state=TS.msg_edit.pauseEditing();TS.log(5,"rebuilding msgs for "+TS.model.active_cid);TS.model.ui.msgs_are_auto_scrolling=false;if(TS.pri)TS.log(999,"rebuildMsgs(), #"+model_ob.name+", reason: "+(reason||"not specified"));if(TS.pri)TS.log(999,"rebuildMsgs(), #"+model_ob.name+": calling TS.client.msg_pane.clearUnreadDividerAndHideNewMsgsBar()");TS.client.msg_pane.clearUnreadDividerAndHideNewMsgsBar();var msgs;var last_scroll_top=-1;var html="";TS.client.msg_pane.last_render_time=new Date;TS.client.msg_pane.last_rendered_msg=null;TS.client.msg_pane.last_in_stream_msg=null;last_scroll_top=model_ob.scroll_top;msgs=model_ob.msgs;var msg;var prev_msg;var reset_scroll_for_pending_history;if(TS.boot_data&&TS.boot_data.feature_js_raf_queue){TS.client.ui.$msgs_div.find(".day_divider").remove()}else{TS.client.ui.$msgs_div.empty()}if(model_ob._cached_html){TS.info("using _cached_html");html=model_ob._cached_html;model_ob._cached_html=null}else if(!msgs){html="-"}else{if(!msgs.length){html=""}var jl_rolled_up_msgs=[];var count=0;var visible_msgs=msgs;if(TS.boot_data.feature_message_replies){visible_msgs=_.reject(msgs,TS.utility.msgs.isMsgHidden)}if(TS.boot_data.feature_tinyspeck){TS.metrics.mark("buildMsgHTML")}for(var i=visible_msgs.length-1;i>-1;i--){if(!msg||!TS.utility.msgs.isMsgHidden(msg))prev_msg=msg;msg=visible_msgs[i];if(TS.utility.msgs.isMsgHidden(msg))continue;var rollup=TS.utility.msgs.msgRollUpWorker(i,msg,visible_msgs,jl_rolled_up_msgs);if(rollup=="continue"){msg=prev_msg;continue}else if(rollup=="swap"){msg=jl_rolled_up_msgs[0];jl_rolled_up_msgs.length=0}count++;var any_unknowns;if(TS.boot_data.page_needs_enterprise&&call_again){any_unknowns=TS.utility.msgs.allUnknownUsersInMessage(msg);if(any_unknowns.length){any_unknowns.forEach(function(id){if(all_unknowns.indexOf(id)<0)all_unknowns.push(id)})}}var not_same_day_as_prev_msg=_ifNotSameDayAsLastMsg(msg,prev_msg);if(not_same_day_as_prev_msg){if(prev_msg)html+="</div></div>";html+='<div class="day_container">';html+=TS.templates.messages_day_divider({ts:msg.ts});html+='<div class="day_msgs" data-date="'+TS.utility.date.toCalendarDate(msg.ts)+'" data-ts="'+msg.ts+'">'}html+=TS.templates.builders.buildMsgHTML({msg:msg,model_ob:model_ob,prev_msg:prev_msg,container_id:"msgs_div",enable_slack_action_links:true});if(i===0){html+="</div></div>"}if(!msg.rsp_id){TS.client.msg_pane.last_in_stream_msg=msg;if(!TS.utility.msgs.isMsgHidden(msg))TS.client.msg_pane.last_rendered_msg=msg}}if(TS.boot_data.feature_tinyspeck){var duration=TS.metrics.measureAndClear(TS.boot_data.feature_refactor_buildmsghtml?"buildMsgHTML_refactor":"buildMsgHTML","buildMsgHTML");TS.log(8,"buildMsgHTML duration: "+duration+" ("+(TS.boot_data.feature_refactor_buildmsghtml?"buildMsgHTML_refactor":"buildMsgHTML")+")")}var min_count=20;if(!TS.isPartiallyBooted()&&msgs.length&&count<min_count){if(_did_fetch_extra_history&&_last_rebuild_model_ob_id==model_ob.id){}else{_did_fetch_extra_history=true;var _clearDidFetchExtraHistoryFlag=function(){_did_fetch_extra_history=false;TS.channels.switched_sig.remove(_clearDidFetchExtraHistoryFlag);TS.groups.switched_sig.remove(_clearDidFetchExtraHistoryFlag);TS.ims.switched_sig.remove(_clearDidFetchExtraHistoryFlag);TS.mpims.switched_sig.remove(_clearDidFetchExtraHistoryFlag)};TS.channels.switched_sig.addOnce(_clearDidFetchExtraHistoryFlag);TS.groups.switched_sig.addOnce(_clearDidFetchExtraHistoryFlag);TS.ims.switched_sig.addOnce(_clearDidFetchExtraHistoryFlag);TS.mpims.switched_sig.addOnce(_clearDidFetchExtraHistoryFlag);if(TS.pri)TS.log(888,"rebuildMsgs(): loading more history because count is < "+min_count);if(TS.model.prefs.start_scroll_at_oldest&&!model_ob.is_im){if(TS.pri)TS.log(888,"rebuildMsgs(): loading scrollback, AND, resetting _has_auto_scrolled so we scroll to oldest again when more history loads.");reset_scroll_for_pending_history=true}TS.client.ui.doLoadScrollBackHistory(true)}}_last_rebuild_model_ob_id=model_ob.id}TS.client.ui.$msgs_div.html(html);TS.utility.makeSureAllLinksHaveTargets(TS.client.ui.$msgs_div);TS.client.msg_pane.assignLastReadMsgDiv(model_ob);TS.client.msg_pane.insertUnreadDivider();TS.client.msg_pane.updateEndMarker();TS.client.ui.checkInlineImgsAndIframesMain();if(TS.boot_data.feature_message_menus){TS.attachment_actions.select.decorateNewElements(TS.client.ui.$msgs_div)}TS.client.msg_pane.padOutMsgsScroller();TS.client.ui.instaScrollMsgsToBottom(false);if(last_scroll_top==-1||last_scroll_top===undefined||TS.model.prefs&&TS.model.prefs.start_scroll_at_oldest&&model_ob.unread_cnt){var start_at_oldest=TS.model.prefs&&TS.model.prefs.start_scroll_at_oldest;if(start_at_oldest&&model_ob.unread_cnt&&TS.client.msg_pane.new_msgs_bar_showing&&!model_ob._has_auto_scrolled){if(!TS.model.ui.is_window_focused){if(TS.pri)TS.log(888,"rebuildMsgs(): NOT resetting and applying auto-scroll on #"+model_ob.name+", because window is not in focus.");return}if(TS.pri)TS.log(888,"rebuildMsgs(): resetting has_auto_scrolled on #"+model_ob.name+" and forcing first unread to scroll into view, because new msgs bar is still up and unread_cnt = "+model_ob.unread_cnt);last_scroll_top=-1;_resetHasAutoScrolled(model_ob)}if(!model_ob._has_auto_scrolled||!TS.client.ui.isUserAttentionOnChat()||TS.client.activeChannelIsHidden()){if(TS.pri)TS.log(888,"rebuildMsgs(): insta-scrolling to bottom(false) and then first unread into view because of last_scroll_top = -1 or undefined (actual: "+last_scroll_top+") OR (pref to scroll AND unread), where unread_cnt = "+model_ob.unread_cnt);TS.utility.queueRAF(function instaScrollMsgsToBottomRAF(){TS.client.ui.instaScrollMsgsToBottom(false)});if(TS.model.prefs&&TS.model.prefs.start_scroll_at_oldest){TS.client.ui.scrollMsgsSoFirstUnreadMsgIsInView(function(){})}if(!model_ob.is_im&&!reset_scroll_for_pending_history){(function(local_model_ob){TS.utility.rAF(function(){var current_model_ob=TS.shared.getActiveModelOb();if(!current_model_ob||current_model_ob.id!==local_model_ob.id)return;if(TS.model.prefs&&TS.model.prefs.start_scroll_at_oldest){TS.client.ui.instaScrollMsgsToBottom(false);TS.client.ui.scrollMsgsSoFirstUnreadMsgIsInView(function(){})}if(local_model_ob.msgs.length){if(TS.pri)TS.log(888,"rebuildMsgs(): marking has_auto_scrolled because !is_im and has msgs");local_model_ob._has_auto_scrolled=true}else{if(TS.pri)TS.log(888,"rebuildMsgs(): NOT marking has_auto_scrolled because no msgs yet");local_model_ob._has_auto_scrolled=false}local_model_ob=null})})(model_ob)}}}else{if(TS.pri)TS.log(888,"rebuildMsgs(): insta-scrolling to last_scroll_top of "+last_scroll_top);TS.client.ui.instaScrollMsgsToPosition(last_scroll_top,false)}if(reset_scroll_for_pending_history&&model_ob._has_auto_scrolled){if(TS.pri)TS.log(888,"rebuildMsgs(): resetting scroll state due to pending history call");last_scroll_top=-1;_resetHasAutoScrolled(model_ob)}if(edit_state)TS.msg_edit.resumeEditing(edit_state);if(TS.boot_data.page_needs_enterprise&&call_again&&all_unknowns.length){var model_ob_name=model_ob.name&&model_ob.name.toString()||"unknown";var or_clause={type:"or",clauses:[]};all_unknowns.forEach(function(id){or_clause.clauses.push({type:"id",value:id})});var calling_args={query:JSON.stringify(or_clause)};var current_model_ob_id=model_ob.id;if(TS.boot_data.feature_tinyspeck)TS.log("calling search.enterprise for unknowns in #"+model_ob.name,all_unknowns);TS.api.callImmediately("search.enterprise",calling_args).then(function(response){if(!response.data.items.length)return null;response.data.items.map(function(member){var full_member=TS.members.getMemberById(member.id);if(!full_member){if(member.team_id!==TS.model.team.id){member.is_primary_owner=false;member.is_owner=false;member.is_admin=false}full_member=TS.members.upsertMember(member).member}return full_member}).filter(function(member){if(member.is_self||member.is_slackbot){return false}return true});if(current_model_ob_id===TS.shared.getActiveModelOb().id)TS.client.msg_pane.rebuildMsgs(false,"search.enterprise called");return null}).catch(function(error){if(TS.boot_data.feature_tinyspeck){TS.error("search.enterprise call failed while fetching unknowns in #"+model_ob_name,all_unknowns,error,calling_args)}else{TS.error(error.data.error+" error occured while searching")}throw error})}html=null;msgs=null;model_ob=null;if(TS.boot_data.feature_sli_recaps){TS.recaps_signal.handleUpdateScrollbar()}TS.client.msg_pane.is_rebuilding=false},displayTitle:function(){TS.client.channel_header.start()},clearUnreadDivider:function(){if(!TS.client.ui.$msgs_unread_divider)return;if(TS.pri)TS.log(999,"TS.client.msg_pane.clearUnreadDivider: removing TS.client.ui.$msgs_unread_divider");TS.client.ui.$msgs_unread_divider.remove();TS.client.ui.$msgs_unread_divider=null;$(".day_container.unread_day_container").removeClass("unread_day_container")},maybeHideNewMsgsBar:function(){var do_force=true;TS.client.msg_pane.maybeClearNewMsgsTimer(null,do_force);if(!TS.model.prefs.mark_msgs_read_immediately){if(TS.pri)TS.log(999,"TS.client.msg_pane.maybeHideNewMsgsBar: no mark_read_immediately pref - hiding now");TS.client.msg_pane.hideNewMsgsBar()}else{var model_ob=TS.shared.getActiveModelOb();if(model_ob&&!model_ob._temp_unread_cnt&&!model_ob.unread_cnt){if(TS.pri)TS.log(999,"TS.client.msg_pane.maybeHideNewMsgsBar: no _temp_ or unread_cnt - hiding new msgs bar for #"+model_ob.name);TS.client.msg_pane.hideNewMsgsBar()}}},clearUnreadDividerAndHideNewMsgsBar:function(){TS.client.msg_pane.clearUnreadDivider();TS.client.msg_pane.maybeHideNewMsgsBar()},maybeClearUnreadDivider:function(model_ob,msg){if(!model_ob||!msg)return;if(!model_ob.unread_cnt&&msg.user&&msg.user==TS.model.user.id){if(TS.pri)TS.log(999,"TS.client.msg_pane.maybeClearUnreadDivider: clearing because you sent a message in #"+model_ob.name+" and unread_cnt = "+model_ob.unread_cnt);TS.client.msg_pane.clearUnreadDivider();TS.utility.msgs.maybeClearPrevLastRead()}},assignLastReadMsgDiv:function(model_ob){var msg;if(!model_ob)return;if(!model_ob.msgs.length)return;var last_read=model_ob._prev_last_read||model_ob.last_read;msg=TS.utility.msgs.getMsg(last_read,model_ob.msgs);if(msg&&!TS.utility.msgs.isMsgHidden(msg)&&!TS.utility.msgs.isMsgRolledUp(msg)){_$last_read_msg_div=TS.client.msg_pane.getCanonicalDivForMsg(last_read);return}var oldest_ts_we_have=TS.utility.msgs.getOldestValidTs(model_ob.msgs);if(last_read>oldest_ts_we_have){msg=TS.utility.msgs.getDisplayedMsgBeforeTS(last_read,model_ob.msgs);if(msg){_$last_read_msg_div=TS.client.msg_pane.getCanonicalDivForMsg(msg.ts)}else{_$last_read_msg_div=null;TS.error("WTF nulling out _$last_read_msg_div because we could not find a message to use #1")}}else{_$last_read_msg_div=null}},insertUnreadDivider:function(){if(TS.client.ui.$msgs_unread_divider)return;var model_ob=TS.shared.getActiveModelOb();if(!model_ob){TS.error("insertUnreadDivider no channel, no im, no group");return}if(TS.model.seen_onboarding_this_session&&model_ob.id==TS.model.welcome_model_ob.id||!TS.client.msg_pane.last_in_stream_msg){_updateNewMsgsDisplay();return}var skip_red_line=false;var last_read;if(!TS.model.ui.is_window_focused){TS.client.msg_pane.clearUnreadDivider()}if(TS.model.ui.is_window_focused){last_read=model_ob._prev_last_read||model_ob.last_read}else{last_read=model_ob.last_read}var is_rebuild=TS.client.msg_pane.is_rebuilding;if(model_ob.unread_cnt&&TS.client.msg_pane.last_in_stream_msg&&!TS.client.msg_pane.dont_check_unreads_til_switch){if(is_rebuild||!TS.model.ui.is_window_focused){if(TS.pri)TS.log(888,"TS.view.addMsg() on #"+model_ob.name+": inserting red line because is_rebuild, or window not focused.")}else{if(TS.model.ui.is_window_focused){var msg_in_view=TS.client.ui.isMsgInView(TS.client.msg_pane.last_in_stream_msg.ts);if(msg_in_view){if(model_ob.is_im){if(TS.pri)TS.log(888,"TS.view.addMsg() on #"+model_ob.name+": clearing red line because new msg is in view.");TS.client.msg_pane.clearUnreadDivider()}TS.utility.msgs.maybeClearPrevLastRead();skip_red_line=true}else{if(TS.pri)TS.log(888,"TS.view.addMsg() on #"+model_ob.name+": inserting red line because new msg is out of view.")}}}}if(TS.notifs.isCorGMuted(model_ob.id)){if(TS.pri)TS.log(888,"insertUnreadDivider(): #"+model_ob.name+" is muted - exiting");return}if(last_read==="0000000000.000000"){if(TS.pri)TS.log(888,"insertUnreadDivider(): #"+model_ob.name+" last_read is zero ("+last_read+") - not inserting.");skip_red_line=true}if(TS.boot_data.feature_pin_update&&_$last_read_msg_div){var $curr_last_read_div=TS.client.msg_pane.getCanonicalDivForMsg(model_ob.last_read);if($curr_last_read_div){var $msgs_afer_div=$curr_last_read_div.nextAll();if($msgs_afer_div.length>0){var only_hidden_msgs_after_div=_.every($msgs_afer_div,function(msg){return $(msg).hasClass("hidden")});if(only_hidden_msgs_after_div)skip_red_line=true}}}if(!skip_red_line&&(model_ob.unread_cnt&&last_read<TS.client.msg_pane.last_in_stream_msg.ts||last_read<TS.client.msg_pane.last_in_stream_msg.ts)){var divider_html=TS.templates.messages_unread_divider(last_read);if(_$last_read_msg_div&&_$last_read_msg_div.length){_$last_read_msg_div.after(divider_html)}else{var oldest_ts_we_have=TS.utility.msgs.getOldestValidTs(model_ob.msgs);if(last_read>oldest_ts_we_have){var msg_after_last_read=TS.utility.msgs.getDisplayedMsgAfterTS(last_read,model_ob.msgs);var $first_unread_msg_div;if(msg_after_last_read){$first_unread_msg_div=TS.client.msg_pane.getCanonicalDivForMsg(msg_after_last_read.ts)}if($first_unread_msg_div&&$first_unread_msg_div.length){$first_unread_msg_div.before(divider_html)}else{TS.client.ui.$msgs_div.find(".message").last().before(divider_html)}}else{TS.client.ui.$msgs_div.find(".message").first().before(divider_html)}}TS.client.ui.$msgs_unread_divider=$("#msgs_unread_divider");TS.client.ui.$msgs_unread_divider.data("last_read_ts",last_read);if(model_ob.unread_cnt){$(".unread_divider").removeClass("no_unreads")}else{$(".unread_divider").addClass("no_unreads")}if(TS.client.ui.$msgs_unread_divider.next(".day_divider").length||TS.client.ui.$msgs_unread_divider.is(":last-child")){TS.client.ui.$msgs_unread_divider.addClass("adjacent_to_date");TS.client.ui.$msgs_unread_divider.closest(".day_container").next(".day_container").addClass("unread_day_container")}}var bar_unread_cnt=model_ob._temp_unread_cnt||model_ob.unread_cnt;var bar_last_read=model_ob._temp_last_read||model_ob.last_read;if(bar_last_read<TS.client.msg_pane.last_in_stream_msg.ts&&bar_unread_cnt){_updateNewMsgsDisplay();var $messages_unread_status=$("#messages_unread_status");if(TS.client.ui.isUnreadDividerInView()){$messages_unread_status.addClass("quiet");$messages_unread_status.off("click mouseenter mouseleave");TS.client.msg_pane.hideNewMsgsJumpLink();$messages_unread_status.click(function(e){e.preventDefault();TS.client.ui.forceMarkAllRead(TS.model.marked_reasons.clicked)});$messages_unread_status.find(".new_msgs_arrow").addClass("hidden")}else{$messages_unread_status.removeClass("quiet");$messages_unread_status.off("click mouseenter mouseleave");TS.client.msg_pane.hideNewMsgsJumpLink();$messages_unread_status.find(".new_msgs_arrow").removeClass("hidden");$messages_unread_status.click(function(e){e.preventDefault();TS.client.ui.scrollMsgsSoFirstUnreadMsgIsInView()});$messages_unread_status.hover(TS.client.msg_pane.showNewMsgsJumpLink,TS.client.msg_pane.hideNewMsgsJumpLink)}TS.client.msg_pane.showNewMsgsBar();TS.client.msg_pane.startNewMsgsTimer();$messages_unread_status=null}_updateNewMsgsDisplay()},updateEndMarker:function(){var model_ob=TS.shared.getActiveModelOb();if(!model_ob){TS.error("updateEndMarker no channel, no im, no group");return}_member_presence_list.clear();var end_display_meta=$("#end_display_meta");var end_display_status=$("#end_display_status");var $channel_meta=$("#channel_meta");var $group_meta=$("#group_meta");var status_text="";var show_meta=false;var status;if(model_ob.history_fetch_failed){status_text=TS.i18n.t('Retrieving history failed. <a onclick="TS.client.ui.doLoadScrollBackHistory(true)">Try again?</a>',"client")()}else if(model_ob.history_is_being_fetched){status_text=TS.i18n.t("Retrieving history...","client")()}else{status=TS.utility.msgs.getOlderMsgsStatus(model_ob);if(TS.qs_args["test_is_limited"]==1&&!status.more)status.is_limited=true;if(status.more){if(!(TS.model.seen_onboarding_this_session&&model_ob.id==TS.model.welcome_model_ob.id)){status_text='<a onclick="TS.client.ui.doLoadScrollBackHistory(true)">'+TS.i18n.t("And more...","client")()+"</a>"}}else if(!TS.newxp.shouldShowFirstWelcome()){show_meta=true}}if(show_meta){end_display_meta.removeClass("hidden");if(model_ob.is_channel||model_ob.is_group){var date_str=TS.utility.date.toCalendarDateOrNamedDay(model_ob.created);var date_ob=TS.utility.date.toDateObject(model_ob.created);var on_date;if(TS.utility.date.isYesterday(date_ob)||TS.utility.date.isToday(date_ob)){on_date=$.trim(date_str.toLowerCase())}else{on_date=TS.i18n.t("on {date}","client")({date:date_str})}var creator=TS.members.getMemberById(model_ob.creator);if(model_ob.is_channel){
$channel_meta.removeClass("hidden");$group_meta.addClass("hidden");$("#im_meta").addClass("hidden");$("#slackbot_meta").addClass("hidden");$(".channel_meta_name").html(TS.templates.builders.makeChannelLink(model_ob));$(".channel_meta_name").find("a").bind("click",function(e){e.preventDefault();TS.menu.channel.startWithChannel(e,$(e.target).data("channel-id"))});if(TS.boot_data.page_needs_enterprise){var $channel_meta_shared_info=$channel_meta.find(".channel_meta_shared_info");var $action_integration_li=$channel_meta.find(".end_action_integration").parent();if(model_ob.is_shared){var shared_meta_template_args={model_ob:model_ob};if(!model_ob.shares||TS.model.enterprise_teams.length===model_ob.shares.length){shared_meta_template_args.all_teams=true}else{var number_of_teams_to_show_in_shared_with_meta=3;shared_meta_template_args.and_more_number=model_ob.shares.length-number_of_teams_to_show_in_shared_with_meta;shared_meta_template_args.more_teams=model_ob.shares.slice(3)}var shared_meta_string=TS.templates.shared_channels_channel_meta_info(shared_meta_template_args);$channel_meta_shared_info.html(shared_meta_string).removeClass("hidden");$action_integration_li.addClass("hidden")}else{$channel_meta_shared_info.empty().addClass("hidden");$action_integration_li.removeClass("hidden")}}if(creator&&creator.is_self){$("#channel_creator_name").html("You")}else{$("#channel_creator_name").html(creator?TS.templates.builders.makeMemberPreviewLink(creator):"Unknown")}$("#channel_create_date").html(on_date);if(model_ob.purpose.value){$("#channel_meta_purpose_container").removeClass("hidden");$("#channel_meta_purpose").html(TS.utility.formatTopicOrPurpose(model_ob.purpose.value));$("#channel_meta_purpose_prompt").addClass("hidden");$(".end_action_purpose").closest("li").addClass("hidden")}else{$("#channel_meta_purpose_container").addClass("hidden");$(".end_action_purpose").closest("li").removeClass("hidden")}}else if(model_ob.is_mpim){$channel_meta.addClass("hidden");$group_meta.addClass("hidden");$("#im_meta").removeClass("hidden");$("#slackbot_meta").addClass("hidden");_renderMpimBadge(model_ob)}else if(model_ob.is_group){$channel_meta.addClass("hidden");$group_meta.removeClass("hidden");$("#im_meta").addClass("hidden");$("#slackbot_meta").addClass("hidden");$(".group_meta_name").html(TS.templates.builders.makeGroupLink(model_ob));$(".group_meta_name").find("a").addClass("ocean_teal").bind("click",function(e){e.preventDefault();TS.menu.group.startWithGroup(e,$(e.target).data("group-id"))});if(TS.boot_data.page_needs_enterprise){var $group_meta_shared_info=$group_meta.find(".group_meta_shared_info");var $action_integration_li=$group_meta.find(".end_action_integration").parent();if(model_ob.is_shared){var shared_meta_template_args={model_ob:model_ob};if(model_ob.is_global_shared){shared_meta_template_args.all_teams=true}else{var number_of_teams_to_show_in_shared_with_meta=3;shared_meta_template_args.and_more_number=model_ob.shares.length-number_of_teams_to_show_in_shared_with_meta;shared_meta_template_args.more_teams=model_ob.shares.slice(3)}var shared_meta_string=TS.templates.shared_channels_channel_meta_info(shared_meta_template_args);$group_meta_shared_info.html(shared_meta_string).removeClass("hidden");$action_integration_li.addClass("hidden")}else{$group_meta_shared_info.empty().addClass("hidden");$action_integration_li.removeClass("hidden")}}if(creator&&creator.is_self){$("#group_creator_name").html("You")}else{$("#group_creator_name").html(creator?TS.templates.builders.makeMemberPreviewLink(creator):"Unknown")}$("#group_meta_archived_parent").addClass("hidden");if(model_ob.parent_group){var parent_group=TS.groups.getGroupById(model_ob.parent_group);if(parent_group){$("#group_meta_archived_parent").removeClass("hidden");$("#group_meta_archived_parent_link").attr("href","/archives/"+parent_group.name).text(parent_group.name)}}$("#group_create_date").html(on_date);if(model_ob.purpose.value){$("#group_meta_purpose_container").removeClass("hidden");$("#group_meta_purpose").html(TS.utility.formatTopicOrPurpose(model_ob.purpose.value));$("#group_meta_purpose_prompt").addClass("hidden");$(".end_action_purpose").closest("li").addClass("hidden")}else{$("#group_meta_purpose_container").addClass("hidden");$(".end_action_purpose").closest("li").removeClass("hidden")}}$(".end_action_purpose").off("click").on("click.show_purpose_dialog",function(){TS.ui.purpose_dialog.start(model_ob.name,model_ob)});$(".end_action_integration").attr("href","/apps/new?channel="+model_ob.id);$(".end_action_invite").off("click").on("click.show_invite_dialog",function(){TS.ui.channel_invite_modal.startInviteToChannelModal(model_ob.id)});_updateGeneralChannelMetaInviteAction()}else if(model_ob.is_slackbot_im){$channel_meta.addClass("hidden");$group_meta.addClass("hidden");$("#im_meta").addClass("hidden");$("#slackbot_meta").removeClass("hidden");var member=TS.members.getMemberById(model_ob.user);var compliance_export_start=TS.model.team.prefs.compliance_export_start||0;var compliance_exports_enabled_for_team=compliance_export_start&&!!TS.model.team.prefs.compliance_export_start;$("#slackbot_meta").html(TS.templates.slackbot_badge({member:member,compliance_exports_enabled_for_team:compliance_exports_enabled_for_team,compliance_export_start:compliance_export_start}))}else{$channel_meta.addClass("hidden");$group_meta.addClass("hidden");$("#im_meta").removeClass("hidden");$("#slackbot_meta").addClass("hidden");var member=TS.members.getMemberById(model_ob.user);if(member){_member_presence_list.add(member.id);$("#im_meta").html(TS.templates.dm_badge({member:member,compliance_exports_enabled_for_team:!!TS.model.team.prefs.compliance_export_start,compliance_export_start:TS.model.team.prefs.compliance_export_start||0}))}}}else{end_display_meta.addClass("hidden")}if(status&&status.is_limited){$(".is_limited_copy").removeClass("hidden");$(".not_limited_copy").addClass("hidden")}else{$(".is_limited_copy").addClass("hidden");$(".not_limited_copy").removeClass("hidden")}if(status_text){end_display_status.removeClass("hidden");end_display_status.html(status_text)}else{end_display_status.addClass("hidden")}$(".is_limited_div").removeClass("been_seen")},padOutMsgsScrollerRAF:function(){var end_div=$("#end_div");var end_display_div=$("#end_display_div");var end_display_padder=$("#end_display_padder");var h=end_display_div.outerHeight();var allowed_h;if(TS.newxp.inOnboarding()&&!TS.model.prefs.seen_onboarding_start){allowed_h=TS.view.cached_wh-$("#header").outerHeight()}else{allowed_h=TS.client.ui.$msgs_scroller_div[0].scrollHeight-TS.client.ui.$msgs_div.outerHeight()}allowed_h-=32;if(allowed_h>h){if(!TS.newxp.shouldShowFirstWelcome()){end_display_padder.css("height",allowed_h-h)}end_div.height(allowed_h)}},padOutMsgsScroller:function(){$("#end_div").css("height","");$("#end_display_padder").css("height","");TS.utility.queueRAF(TS.client.msg_pane.padOutMsgsScrollerRAF)},clearBlueBarTimer:function(){if(!_hide_blue_bar_tim)return;if(TS.pri)TS.log(999,"TS.client.msg_pane.clearBlueBarTimer: clearing timer of "+_hide_blue_bar_tim);clearTimeout(_hide_blue_bar_tim);_hide_blue_bar_tim=null},maybeClearNewMsgsTimer:function(related_model_ob,force){if(!_new_msgs_tim)return;var active_model_ob=TS.shared.getActiveModelOb();if(!force&&related_model_ob&&related_model_ob.id!==active_model_ob.id)return;if(TS.pri)TS.log(999,"TS.client.msg_pane.maybeClearNewMsgsTimer: clearing _onNewMsgsTimer of "+_new_msgs_tim);clearTimeout(_new_msgs_tim);_new_msgs_tim=null},maybeStartNewMsgsTimer:function(related_model_ob){if(_new_msgs_tim){if(TS.pri)TS.log(999,"TS.client.msg_pane.maybeClearNewMsgsTimer: NOT clearing msgs timer because one already exists of "+_new_msgs_tim);return}var active_model_ob=TS.shared.getActiveModelOb();if(related_model_ob&&related_model_ob.id!==active_model_ob.id)return;if(TS.pri)TS.log(999,"TS.client.msg_pane.maybeClearNewMsgsTimer: starting _onNewMsgsTimer while on #"+active_model_ob.name);TS.client.msg_pane.startNewMsgsTimer()},startNewMsgsTimer:function(){if(_new_msgs_tim){if(TS.pri)TS.log(999,"startNewMsgsTimer: clearing _new_msgs_tim of "+_new_msgs_tim);clearTimeout(_new_msgs_tim);_new_msgs_tim=null}_new_msgs_tim=setTimeout(_onNewMsgsTimer,1500);if(TS.pri)TS.log(999,"TS.client.msg_pane.startNewMsgsTimer: set timer ID = "+_new_msgs_tim+" while on #"+TS.shared.getActiveModelOb().name)},showNewMsgsBar:function(){if(TS.client.activeChannelIsHidden())return;var active_model_ob=TS.shared.getActiveModelOb();if(active_model_ob&&TS.notifs.isCorGMuted(active_model_ob.id)){if(TS.pri)TS.log(999,"insertUnreadDivider(): #"+active_model_ob.name+" is muted - exiting");return}if(TS.pri)TS.log(999,"TS.client.msg_pane.showNewMsgsBar");_updateNewMsgsDisplay();$("#messages_unread_status").removeClass(_msgs_bar_hidden_class_names);TS.client.msg_pane.new_msgs_bar_showing=true;TS.client.msg_pane.topMessagesBannerShown()},hideNewMsgsBar:function(skip_mark_msgs_read_immediate_check){if(TS.pri)TS.log(999,"TS.client.msg_pane.hideNewMsgsBar");TS.client.msg_pane.clearBlueBarTimer();if(!skip_mark_msgs_read_immediate_check&&TS.model.prefs.mark_msgs_read_immediately){var model_ob=TS.shared.getActiveModelOb();if(model_ob&&(model_ob._temp_unread_cnt||model_ob.unread_cnt)){if(TS.pri)TS.log(999,"TS.client.msg_pane.hideNewMsgsBar: NOT hiding because read state pref is mark_msgs_read_immediately, and the model still has some unreads. _temp_unread_cnt = "+model_ob._temp_unread_cnt+", unread_cnt = "+model_ob.unread_cnt);TS.client.msg_pane.maybeStartNewMsgsTimer(model_ob);return}}$("#messages_unread_status").addClass(_msgs_bar_hidden_class_names);TS.client.msg_pane.new_msgs_bar_showing=false;TS.client.msg_pane.topMessagesBannerHidden()},showNewMsgsJumpLink:function(){$("#messages_unread_status").find(".new_msgs_jump_link").fadeIn(100)},hideNewMsgsJumpLink:function(){$("#messages_unread_status").find(".new_msgs_jump_link").fadeOut(100)},checkUnreads:function(){TS.utility.queueRAF(TS.client.ui.checkInlineImgsAndIframesMain);TS.client.ui.checkScrollBack();if(!TS.client.ui.isUserAttentionOnChat()||TS.model.archive_view_is_showing||TS.client.activeChannelIsHidden())return;var model_ob=TS.shared.getActiveModelOb();if(!model_ob)return;if(!TS.model.prefs)return;if(!model_ob.unread_cnt){if(_$last_read_msg_div&&_$last_read_msg_div.length)TS.client.ui.markMostRecentReadMsgInActive(TS.model.marked_reasons.viewed);_updateNewMsgsDisplay();return}if(TS.client.msg_pane.dont_check_unreads_til_switch){_updateNewMsgsDisplay();return}var ts;var all_unreads_are_seen=true;var unreads=model_ob.unreads;var check_that_all_have_been_viewed=false;var is_muted=TS.notifs.isCorGMuted(model_ob.id);if(TS.model.prefs.mark_msgs_read_immediately){all_unreads_are_seen=true}else if(is_muted){all_unreads_are_seen=true}else if(check_that_all_have_been_viewed){for(var i=0;i<unreads.length;i++){ts=unreads[i];if(TS.model.client.reads.indexOf(ts)>-1){}else if(TS.client.ui.isMsgInView(ts)){TS.model.client.reads.push(ts)}else{var msg=TS.utility.msgs.getMsg(ts,model_ob.msgs);if(!msg||TS.utility.msgs.isMsgHidden(msg)){TS.model.client.reads.push(ts)}else{all_unreads_are_seen=false}}}}else{if(model_ob.oldest_unread_ts){all_unreads_are_seen=TS.client.ui.isMsgInView(model_ob.oldest_unread_ts);if(TS.pri)TS.log(58,"checkUnreads (#"+model_ob.name+"): oldest_unread_ts = "+model_ob.oldest_unread_ts+", isMsgInView (all_unreads_are_seen) = "+all_unreads_are_seen)}else{if(TS.pri)TS.log(58,"checkUnreads (#"+model_ob.name+"): no oldest_unread_ts?")}}if(TS.boot_data.feature_wait_for_all_mentions_in_client){if(!is_muted&&model_ob._mention_count_display_via_users_counts&&model_ob.unread_highlight_cnt_in_client<model_ob._mention_count_display_via_users_counts){if(model_ob.last_read&&TS.utility.msgs.getMsg(model_ob.last_read,model_ob.msgs)){if(TS.pri)TS.warn("checkUnreads (#"+model_ob.name+"): live unread_highlight_cnt = "+model_ob.unread_highlight_cnt_in_client+" and users.counts mention_count_display is "+model_ob._mention_count_display_via_users_counts+", but history has loaded back to last_read. allowing mark-as-read.")}else{if(TS.pri)TS.log(58,"checkUnreads: Preventing auto-mark-as-read because live unread_highlight_cnt = "+model_ob.unread_highlight_cnt_in_client+" and users.counts mention_count_display is "+model_ob._mention_count_display_via_users_counts);all_unreads_are_seen=false}}}if(TS.pri)TS.log(58,"checkUnreads (#"+model_ob.name+"): all_unreads_are_seen = "+all_unreads_are_seen+", last_read_msg_div = "+(_$last_read_msg_div&&_$last_read_msg_div.length)+", last_read = "+model_ob.last_read);if(all_unreads_are_seen&&(_$last_read_msg_div&&_$last_read_msg_div.length||!parseInt(model_ob.last_read)||TS.model.prefs.mark_msgs_read_immediately||is_muted)){if(!TS.model.prefs.mark_msgs_read_immediately){if(TS.pri)TS.log(58,"checkUnreads: All unreads are seen. Marking #"+model_ob.name+" as viewed.");TS.client.ui.markMostRecentReadMsgInActive(TS.model.marked_reasons.viewed)}else{if(TS.pri)TS.log(58,"Maybe marking most recent read msg in active because viewed: #"+model_ob.name);if(model_ob.history_is_being_fetched){if(TS.pri)TS.log(58,"NOT MARKING most recent as read because history being fetched")}else if(TS.client.msg_pane.new_msgs_bar_showing){if(TS.pri)TS.log(58,"NOT MARKING most recent as read because new msgs bar is showing.");if(TS.model.prefs.mark_msgs_read_immediately){if(!model_ob._mark_most_recent_read_timer){if(TS.pri)TS.log(58,"Setting a timer to mark #"+model_ob.name+" as read.");model_ob._mark_most_recent_read_timer=window.setTimeout(function(){model_ob._mark_most_recent_read_timer=null;_clearTempReadState(model_ob);model_ob=null},500)}TS.client.ui.markMostRecentReadMsgInActive(TS.model.marked_reasons.viewed);TS.client.msg_pane.maybeStartNewMsgsTimer(model_ob)}}else{if(TS.pri)TS.log(58,"Marking most recent read msg in active because viewed: #"+model_ob.name);TS.client.ui.markMostRecentReadMsgInActive(TS.model.marked_reasons.viewed)}}}_updateNewMsgsDisplay()},getCanonicalDivForMsg:function(ts){if(TS.boot_data.feature_message_replies&&TS.client.ui.$msgs_div.find("ts-conversation").length){var $non_relatives_msg_el=TS.client.ui.$msgs_div.find('ts-message[data-ts="'+ts+'"]').not("ts-relatives ts-message");if($non_relatives_msg_el.length==1){return $non_relatives_msg_el}return $non_relatives_msg_el.filter(":not(ts-conversation) > ts-message")}return TS.client.ui.$msgs_div.find("#"+TS.templates.makeMsgDomId(ts))},getDivsForMsg:function(ts){if(TS.boot_data.feature_message_replies&&TS.client.ui.$msgs_div.find("ts-conversation").length){return TS.client.ui.$msgs_div.find('ts-message[data-ts="'+ts+'"]')}return TS.client.msg_pane.getCanonicalDivForMsg(ts)},getDivForArchiveMsg:function(ts){return TS.client.archives.$archives_msgs_div.find("#"+TS.templates.makeMsgDomId(ts))},topMessagesBannerShown:function(){if(_$messages_container.hasClass("has_top_messages_banner"))return;_$messages_container.toggleClass("has_top_messages_banner",_getVisibleTopBanners().length>0)},topMessagesBannerHidden:function(){if(!_$messages_container.hasClass("has_top_messages_banner"))return;_$messages_container.toggleClass("has_top_messages_banner",_getVisibleTopBanners().length>0)},cleanMsgDiv:function($msg){},addMaybeClick:function(key,handler){if(!key)return;handler=_.isFunction(handler)?handler:_.noop;_maybe_click_handlers[key]=handler},maybeClick:function(el){var key=$(el).data("maybe-click");if(_maybe_click_handlers[key])_maybe_click_handlers[key]()},areCallsEnabled:function(){if(TS.boot_data.feature_calls){return TS.utility.calls.isEnabled()}return false},maybeSetupCalls:function(member,model_ob){var call_info;var call_button_template_args;if(TS.boot_data.page_needs_enterprise){if(!model_ob)model_ob=TS.shared.getActiveModelOb();if(model_ob&&model_ob.is_shared&&!model_ob.is_org_shared)return}if(!TS.model.team.prefs.allow_calls)return;if(TS.model.active_im_id){if(member&&!member.is_bot&&!member.is_slackbot&&!member.is_self&&TS.client.msg_pane.areCallsEnabled()){call_info={is_dm:true,id:TS.model.active_im_id};call_button_template_args={dm_member:member,name:TS.members.getMemberDisplayName(member,false,true)};_displayCallButton(call_info,call_button_template_args)}}else if(TS.model.active_channel_id||TS.model.active_group_id){model_ob=TS.shared.getActiveModelOb();var can_user_post_in_channel=!model_ob.is_general||TS.permissions.members.canPostInGeneral(TS.model.user);if(TS.client.msg_pane.areCallsEnabled()&&can_user_post_in_channel){if(TS.model.active_channel_id){call_info={id:TS.model.active_channel_id}}else{call_info={id:TS.model.active_group_id}}_displayCallButton(call_info)}}else if(TS.model.active_mpim_id){if(TS.client.msg_pane.areCallsEnabled()){call_button_template_args={names:TS.mpims.getDisplayName(model_ob)};call_info={is_dm:false,is_mpdm:true,id:TS.model.active_mpim_id};_displayCallButton(call_info,call_button_template_args)}}},setUnreadPoint:function(msg_id){var model_ob=TS.shared.getActiveModelOb();var mark_msg_ts=TS.utility.msgs.getMarkMsgTSForUnreadPoint(msg_id,model_ob.msgs,model_ob);if(!mark_msg_ts)return false;if(TS.model.active_channel_id){TS.channels.markReadMsg(TS.model.active_channel_id,mark_msg_ts,TS.model.marked_reasons.back)}else if(TS.model.active_im_id){TS.ims.markReadMsg(TS.model.active_im_id,mark_msg_ts,TS.model.marked_reasons.back)}else if(TS.model.active_group_id){TS.groups.markReadMsg(TS.model.active_group_id,mark_msg_ts,TS.model.marked_reasons.back)}else if(TS.model.active_mpim_id){TS.mpims.markReadMsg(TS.model.active_mpim_id,mark_msg_ts,TS.model.marked_reasons.back)}else{return false}TS.model.client.reads.length=0;TS.client.markLastReadsWithAPI();if(TS.pri)TS.log(999,"setUnreadPoint for #"+model_ob.name+": calling TS.client.msg_pane.clearUnreadDividerAndHideNewMsgsBar()");TS.client.msg_pane.clearUnreadDividerAndHideNewMsgsBar();if(TS.pri)TS.log(58,'setUnreadPoint for "'+model_ob.id+'" "'+model_ob.name+'" - marking dont_check_unreads_til_switch = true.');TS.client.msg_pane.dont_check_unreads_til_switch=true;TS.utility.msgs.maybeClearPrevLastRead();TS.client.msg_pane.insertUnreadDivider();return true},maybeResetUnreadsCheck:function(related_model_ob){if(!TS.client.msg_pane.dont_check_unreads_til_switch)return;var active_model_ob=TS.shared.getActiveModelOb();if(related_model_ob&&active_model_ob&&active_model_ob.id==related_model_ob.id){if(TS.pri)TS.log(58,"resetting dont_check_unreads_til_switch, so unread / banner fade work can be re-done on current model_ob.");TS.client.msg_pane.dont_check_unreads_til_switch=false}},maybeInsertUnreadDividerAndNewMsgsBar:function(model_ob){if(!model_ob)return;var current_model_ob=TS.shared.getActiveModelOb();if(!current_model_ob||model_ob.id!==current_model_ob.id)return;if(TS.pri)TS.log(99,"channelUnreadCountChanged: #"+model_ob.name+" - unread count changed for active model_ob of #"+current_model_ob.name);if(!model_ob.unread_cnt){if(TS.pri)TS.log(99,"channelUnreadCountChanged: #"+model_ob.name+" - unread_cnt is 0. Maybe starting new msgs timer.");TS.client.msg_pane.startNewMsgsTimer();return}if(!TS.model.ui.is_window_focused){if(TS.pri)TS.log(99,"channelUnreadCountChanged: #"+model_ob.name+" - window is not in focus, so removing and re-inserting unread divider so it can be updated.");TS.client.msg_pane.clearUnreadDividerAndHideNewMsgsBar();TS.utility.msgs.maybeClearPrevLastRead()}else{if(TS.model.prefs&&!TS.model.prefs.mark_msgs_read_immediately&&TS.client.ui.$msgs_unread_divider&&!TS.client.ui.isUnreadDividerInView()){if(TS.pri)TS.log(99,"channelUnreadCountChanged: #"+model_ob.name+" - window is in focus, BUT, unread divider is not in view - clearing existing state, will show in new position.");TS.client.msg_pane.clearUnreadDivider();TS.utility.msgs.maybeClearPrevLastRead()}}TS.client.msg_pane.insertUnreadDivider();if(TS.model.ui.is_window_focused){if(TS.pri)TS.log(99,"channelUnreadCountChanged: #"+model_ob.name+" - NOT showing new msgs bar because window is in focus.")}else{if(TS.pri)TS.log(99,"channelUnreadCountChanged: #"+model_ob.name+" - showing new msgs bar.");TS.client.msg_pane.showNewMsgsBar()}},maybeResetAndAutoScroll:function(model_ob){return},setCallButtonState:function(go_online){var is_multiparty_enabled=TS.boot_data.feature_calls?TS.utility.calls.isMultiPartyEnabled():TS.client.msg_pane.areCallsEnabled();if(TS.utility.calls.isEnabled()&&TS.boot_data.feature_platform_calls&&TS.model.team.prefs.calling_app_name!="Slack"){is_multiparty_enabled=true}var is_call_allowed=true;if(!is_multiparty_enabled&&TS.utility.calls.isCurrentContextMultiParty()){is_call_allowed=false}$(".call_icon").toggleClass("call_window_offline",!(go_online&&is_call_allowed))}});var _will_rebuild_channel_members_list=false;var _did_fetch_extra_history;var _last_rebuild_model_ob_id;var _$last_read_msg_div;var _new_msgs_tim;var _hide_blue_bar_tim;var _$messages_container=$("#messages_container");var _maybe_click_handlers={};var _msgs_bar_hidden_class_names="no_pointer_events no_opacity";var _member_presence_list;function _getVisibleTopBanners(){return _$messages_container.find(".messages_banner:not(.messages_banner_bottom)").filter(":visible").filter(function(){var $el=$(this);return!($el.css("visibility")=="hidden"||$el.hasClass("no_opacity"))})}var _convertedToShared=function(){TS.client.msg_pane.updateEndMarker();TS.client.msg_pane.padOutMsgsScroller()};var _sharedTeamsUpdated=function(){TS.client.msg_pane.updateEndMarker();TS.client.msg_pane.padOutMsgsScroller()};var _maybeStoreTempReadState=function(model_ob){if(!model_ob)return};var _clearTempReadState=function(model_ob){if(!model_ob)return;if(!model_ob._temp_unread_cnt&&!model_ob._temp_last_read)return;if(TS.pri)TS.log(58,"_clearTempReadState: Nulling _temp_unread_cnt and _temp_last_read on #"+model_ob.name);model_ob._temp_unread_cnt=null;model_ob._temp_last_read=null};var _updateNewMsgsDisplay=function(){if(!TS.client.ui.$msgs_unread_divider)return;var model_ob=TS.shared.getActiveModelOb();TS.utility.msgs.maybeCalcUnreadCnts(model_ob);if(TS.pri)TS.log(999,"_updateNewMsgsDisplay: #"+model_ob.name+", unread_cnt = "+model_ob.unread_cnt);_maybeStoreTempReadState(model_ob);var unread_cnt=model_ob._temp_unread_cnt||model_ob.unread_cnt;var last_read=model_ob._temp_last_read||model_ob.last_read;if(unread_cnt){var oldest_ts_we_have=TS.utility.msgs.getOldestValidTs(model_ob.msgs);var unread_cnt_output=unread_cnt;var plus="";if(last_read<oldest_ts_we_have&&unread_cnt_output>10){plus="+";unread_cnt_output=Math.floor(unread_cnt_output/10)*10}var new_msg_info_ts;var last_read_ts=TS.client.ui.$msgs_unread_divider.data("last_read_ts");if(!last_read_ts){if(TS.pri)TS.log(999,"_updateNewMsgsDisplay: #"+model_ob.name+" - No last_read_ts - no unread divider? Trying _prev_last_read ("+model_ob._prev_last_read+") || model_ob.last_read ("+model_ob.last_read+")");last_read_ts=model_ob._prev_last_read||model_ob.last_read;if(!last_read_ts){if(TS.pri)TS.log(999,"_updateNewMsgsDisplay: #"+model_ob.name+" - Still no last_read_ts - exiting.");return}}var msg_after_last_read=TS.utility.msgs.getDisplayedMsgAfterTS(last_read_ts,model_ob.msgs);if(msg_after_last_read){new_msg_info_ts=msg_after_last_read.ts}else{new_msg_info_ts=last_read_ts}var date_str=TS.utility.date.toCalendarDateOrNamedDay(new_msg_info_ts,false,true);var date_ob=TS.utility.date.toDateObject(new_msg_info_ts);var i18n_str_func;var unread_str;if(!TS.utility.date.isToday(date_ob)){if(TS.utility.date.isYesterday(date_ob)){i18n_str_func=TS.i18n.t("{unread_message_count}{plus} new {unread_message_count, plural, =1 {message} other {messages}} since {time} {date_string}","client")}else{i18n_str_func=TS.i18n.t("{unread_message_count}{plus} new {unread_message_count, plural, =1 {message} other {messages}} since {time} on {date_string}","client")}}else{i18n_str_func=TS.i18n.t("{unread_message_count}{plus} new {unread_message_count, plural, =1 {message} other {messages}} since {time}","client")}unread_str=i18n_str_func({unread_message_count:unread_cnt_output,plus:plus,time:TS.utility.date.toTime(new_msg_info_ts,true),date_string:date_str});$("#new_msg_info").html(unread_str);TS.ui.a11y.saveUnreadCountMessage(model_ob,unread_str)}else{if(TS.client.msg_pane.new_msgs_bar_showing){if(TS.pri)TS.log(999,"_updateNewMsgsDisplay: #"+model_ob.name+", unread_cnt = "+unread_cnt+" - maybe starting new msgs timer.");TS.client.msg_pane.maybeStartNewMsgsTimer()}}};var _resetHasAutoScrolled=function(model_ob){if(!model_ob)return;if(!TS.model.prefs||!TS.model.prefs.start_scroll_at_oldest)return;model_ob._has_auto_scrolled=false;TS.model.ui.msgs_are_auto_scrolling=false;model_ob.scroll_top=-1};var _onNewMsgsTimer=function(){var model_ob=TS.shared.getActiveModelOb();if(!model_ob)return;if(TS.pri)TS.log(999,"_onNewMsgsTimer: current model is #"+model_ob.name+", unread_cnt = "+model_ob.unread_cnt+", timer ID = "+_new_msgs_tim);_new_msgs_tim=null;if(!model_ob.unread_cnt){if(TS.model.prefs.mark_msgs_read_immediately&&!TS.model.prefs.start_scroll_at_oldest&&!_hide_blue_bar_tim){var delay=1500;_hide_blue_bar_tim=setTimeout(function(){if(TS.pri)TS.log(999,"_onNewMsgsTimer: calling TS.client.msg_pane.hideNewMsgsBar() after "+delay+" msec");_hide_blue_bar_tim=null;TS.client.msg_pane.hideNewMsgsBar();$(".unread_divider").addClass("no_unreads")},delay)}else{if(model_ob.history_is_being_fetched){if(TS.pri)TS.log(999,"_onNewMsgsTimer: not hiding new msgs bar because history is being fetched for current model_ob (#"+model_ob.name+")");return TS.client.msg_pane.startNewMsgsTimer()}if(TS.pri)TS.log(999,"_onNewMsgsTimer: calling TS.client.msg_pane.hideNewMsgsBar() immediately");TS.client.msg_pane.hideNewMsgsBar();$(".unread_divider").addClass("no_unreads")}}else{if(TS.model.prefs.mark_msgs_read_immediately&&!model_ob.history_is_being_fetched){if(TS.pri)TS.log(999,"_onNewMsgsTimer: checking unreads (with intent to mark as read) and exiting, because not fetching history and unread_cnt = "+model_ob.unread_cnt);TS.client.msg_pane.checkUnreads();return}if(TS.pri)TS.log(999,"_onNewMsgsTimer: re-starting new msgs timer because unread_cnt = "+model_ob.unread_cnt);TS.client.msg_pane.startNewMsgsTimer()}};var _updateGeneralChannelMetaInviteAction=function(){var model_ob=TS.shared.getActiveModelOb();if(!model_ob)return void TS.error("updateEndMarker no channel, no im, no group");var $slack_invite_action=$(".end_action_slack_invite");var $slack_invite_action_wrapper=$slack_invite_action.parent();var $team_invite_action_wrapper=$(".end_action_invite").parent();if(model_ob.is_general){var html;if(TS.model.team.prefs.auth_mode=="normal"&&TS.model.team.email_domain){var hostname=location.hostname.replace(/[^\.]*/,TS.utility.htmlEntities(TS.model.team.domain));html=TS.i18n.t('<i class="ts_icon ts_icon_user ts_icon_inherit"></i> Send <a class="underline" href="https://{hostname}/signup">this link</a> to your team to invite them',"client")({hostname:hostname});$slack_invite_action.off("click").html(html).find("a").on("click",function(e){return false})}else if(TS.model.user.is_admin){html=TS.i18n.t('<a><i class="ts_icon ts_icon_user ts_icon_inherit"></i> Invite people to <strong>{teamname}</strong></a>',"client")({teamname:TS.utility.htmlEntities(TS.model.team.name)});$slack_invite_action.off("click").on("click.show_admin_invite_modal",TS.ui.admin_invites.start).html(html)}$slack_invite_action_wrapper.toggleClass("hidden",!html);$team_invite_action_wrapper.toggleClass("hidden",!!html)}else{$slack_invite_action_wrapper.addClass("hidden");$team_invite_action_wrapper.removeClass("hidden")}};var _is_platform_call_loading=false;var _platformCallsSignalHandler=function(sig){_is_platform_call_loading=sig.is_loading;_updateCallButtonAccordingToPrefs()};var _updateCallButtonAccordingToPrefs=function(){_destroyCallButton();if(TS.model.team.prefs.allow_calls){TS.client.msg_pane.displayTitle()}};var _destroyCallButton=function(){$(".channel_calls_button").remove()};var _displayCallButton=function(call_info,additional_template_args){additional_template_args=additional_template_args||{};var model_ob=TS.shared.getActiveModelOb();if(!model_ob)return;if(TS.boot_data.page_needs_enterprise&&model_ob.is_shared&&!model_ob.is_org_shared)return;var is_call_window_ready=TS.boot_data.feature_calls&&(TS.utility.calls.isCallWindowReady()||!TS.utility.calls.platformHasCallsCode());var is_multiparty_enabled=TS.boot_data.feature_calls&&TS.utility.calls.isMultiPartyEnabled();if(TS.utility.calls.isEnabled()&&TS.boot_data.feature_platform_calls&&TS.model.team.prefs.calling_app_name!="Slack"){is_multiparty_enabled=true}var is_channel_preview=model_ob.is_channel&&!model_ob.is_member;var is_call_allowed=true;if(!is_multiparty_enabled&&TS.utility.calls.isCurrentContextMultiParty()){is_call_allowed=false}var calls_is_enabled=is_call_window_ready&&is_call_allowed&&!is_channel_preview;var is_third_party=TS.boot_data.feature_platform_calls&&TS.model.team.prefs.calling_app_name!=="Slack";var icon_classes=["call_icon"];if(!calls_is_enabled){icon_classes.push("call_window_offline")}if(additional_template_args.is_dm_user_offline){icon_classes.push("away")}if(call_info.is_dm){if(additional_template_args.hasOwnProperty("dm_member")){icon_classes.push(TS.templates.makeMemberDomIdById(additional_template_args.dm_member.id))}}if(TS.client.msg_pane.areCallsEnabled()){var $calls_container=$("#channel_calls_container");var voice_tip_text;var call_name;if(is_channel_preview){voice_tip_text=TS.i18n.t("Join this channel to start a call","client")()}else if(is_call_allowed){if(call_info.is_dm||call_info.is_mpdm){if(additional_template_args.is_dm_user_offline){voice_tip_text=TS.i18n.t("{name} is currently offline and unreachable","client")({name:additional_template_args.name})}else{if(call_info.is_mpdm){call_name=additional_template_args.names}else{call_name=additional_template_args.name}if(is_third_party){voice_tip_text=TS.i18n.t("Call {call_name} with {calling_app_name}","client")({call_name:call_name,calling_app_name:TS.model.team.prefs.calling_app_name})}else{voice_tip_text=TS.i18n.t("Call {call_name}","client")({call_name:call_name})}}}else{if(is_third_party){voice_tip_text=voice_tip_text=TS.i18n.t("Start a call with {calling_app_name}","client")({calling_app_name:TS.model.team.prefs.calling_app_name})}else{voice_tip_text=TS.i18n.t("Start a call","client")()}}}else{if(call_info.is_mpdm){voice_tip_text=TS.i18n.t("Only paid teams can call from group conversations.","client")()}else{voice_tip_text=TS.i18n.t("Only paid teams can start calls from channels.","client")()}}var html="";html+=TS.templates.menu_call_button({is_platform_call_loading:_is_platform_call_loading,button_classes:"voice_call",tip_text:voice_tip_text,icon_classes:icon_classes.concat("ts_icon_phone").join(" ")});$calls_container.html(html);$calls_container.removeClass("hidden");if(call_info.id&&is_call_allowed){$(".channel_calls_button.voice_call").on("click.video_call",function(e){if(is_channel_preview)return;var is_platform_call=TS.boot_data.feature_platform_calls&&TS.model.team.prefs.calling_app_name!="Slack";TS.clog.track("CALLS_START_VOICE_BUTTON_CLICKED",{is_platform_call:is_platform_call,calling_app_id:TS.model.team.prefs.calling_app_id});if(is_platform_call){TS.utility.calls.launchPlatformCalls(call_info)}else{TS.utility.calls.startCallInModelOb(call_info)}})}}};var _ifNotSameDayAsLastMsg=function(this_msg,last_msg){if(!last_msg)return true;return!TS.utility.msgs.areMsgsSameDay(this_msg,last_msg)};var _notifPrefChanged=function(){var model_ob=TS.shared.getActiveModelOb();if(!model_ob.is_mpim)return;_renderMpimBadge(model_ob)};var _renderMpimBadge=function(model_ob){var is_muted=TS.notifs.isCorGMuted(model_ob.id);var desktop_setting=TS.notifs.getCalculatedCorGNotifySetting(model_ob.id);var desktop_notifs_enabled=TS.ui.growls.checkPermission();var notifications_impossible=desktop_notifs_enabled===false&&TS.ui.growls.no_notifications;var notifications_not_allowed=desktop_notifs_enabled===false&&TS.ui.growls.getPermissionLevel()=="denied";var notifications_not_yet_allowed=desktop_notifs_enabled===false&&TS.ui.growls.shouldShowPermissionButton();
var _$mpim_notif_prefs;var template_args={members:TS.mpims.getMembersInDisplayOrder(model_ob),compliance_exports_enabled_for_team:!!TS.model.team.prefs.compliance_export_start,compliance_export_start:TS.model.team.prefs.compliance_export_start||0,desktop_setting:desktop_setting,is_muted:is_muted,desktop_notifs_enabled:desktop_notifs_enabled,notifications_impossible:notifications_impossible,notifications_not_allowed:notifications_not_allowed,notifications_not_yet_allowed:notifications_not_yet_allowed};$("#im_meta").html(TS.templates.dm_badge(template_args));_$mpim_notif_prefs=$(".mpim_notif_prefs");_$mpim_notif_prefs.find(".more_options").on("click",function(){TS.ui.channel_prefs_dialog.start(model_ob.id)});_$mpim_notif_prefs.find("#notifications_muted_cb").on("change",function(){if(TS.notifs.isCorGMuted(model_ob.id)){TS.notifs.muteOrUnmuteCorG(model_ob.id)}});_$mpim_notif_prefs.find("#no_notifications_cb").on("change",function(){if(TS.model.prefs.all_channels_loud){TS.notifs.makeCorGDTopEverything(model_ob.id)}else{TS.notifs.makeCorGDTopMentions(model_ob.id)}TS.prefs.setMultiPrefsByAPI({loud_channels:TS.model.loud_channels.join(","),never_channels:TS.model.never_channels.join(","),loud_channels_set:TS.model.loud_channels_set.join(",")})});_$mpim_notif_prefs.find("#all_notifications_rd").on("change",function(){TS.notifs.makeCorGDTopEverything(model_ob.id);TS.prefs.setMultiPrefsByAPI({loud_channels:TS.model.loud_channels.join(","),loud_channels_set:TS.model.loud_channels_set.join(",")})});_$mpim_notif_prefs.find("#mentions_rd").on("change",function(){TS.notifs.makeCorGDTopMentions(model_ob.id);TS.prefs.setMultiPrefsByAPI({loud_channels:TS.model.loud_channels.join(","),loud_channels_set:TS.model.loud_channels_set.join(",")})})}})();(function(){"use strict";TS.registerModule("client.downloads",{onStart:function(){TS.client.login_sig.add(_loggedIn)},startDownload:function(file,always_open_flexpane){if(!TS.model.supports_downloads)return false;if(!file)return false;if(!_fileDownloadUrl(file))return false;var existing_dl=_getDownloadByUrl(_fileDownloadUrl(file));var do_open_flex_pane=always_open_flexpane||!!existing_dl;var delay_ms=0;if(do_open_flex_pane){if(TS.model.ui.active_tab_id!="downloads"||!TS.model.ui_state.flex_visible){delay_ms=TS.model.ui_state.flex_visible?100:300}TS.client.ui.flex.openFlexTab("downloads")}if(existing_dl){if(existing_dl.state=="canceled"||existing_dl.state=="failed"){_retryDownload(existing_dl.token)}setTimeout(_highlightDlDiv,delay_ms,existing_dl.token);return true}var token=TSSSB.call("startDownload",_fileDownloadUrl(file));if(!token){TS.error('startDownload called with url: "'+_fileDownloadUrl(file)+'" but I got no token');return false}_downloads_map[token]={token:token,progress:0,state:"in_progress",href:_fileDownloadUrl(file),http_status:null,file_path:_fileDownloadUrl(file),file_exists:false,mime_type:"",start_ts:Date.now()/1e3,dl_start_ts:Date.now()/1e3,end_ts:0,base64_png:""},_downloads.push(_downloads_map[token]);_sortDownloads();_addDlDiv(_downloads_map[token]);_showProperPaneContent();setTimeout(_highlightDlDiv,50,token);return true},downloadWithTokenDidSelectFilepath:function(token,file_path){var dl=_downloads_map[token];if(!dl){TS.error("downloadWithTokenDidSelectFilepath: no download for token: "+token);return}dl.file_path=file_path;_updateDownload(dl)},downloadWithTokenProgress:function(token,progress){var dl=_downloads_map[token];if(!dl){TS.error("downloadWithTokenProgress: no download for token: "+token);return}var file=_getFileForDl(dl);dl.progress=progress;var $dl=_getDlDiv(dl.token);if(!$dl.length){TS.error("downloadWithTokenProgress: no $dl found for token: "+dl.token)}var visual_perc=Math.max(.02,Math.min(1,dl.progress));$dl.find(".download_progress_bar").css("width",visual_perc*100+"%");$dl.find(".download_estimate").text(_getDlEstimate(dl));if(dl.progress==1){_updateDownload(dl,"completed")}else if(file&&dl.progress>0){$dl.find(".partial_size").html(TS.utility.convertFilesize(dl.progress*file.size)+" of ");_updateProgress()}else if(dl.progress!=-1){TS.error("downloadWithTokenProgress: bad dl: "+dl)}},downloadWithTokenDidFinish:function(token){var dl=_downloads_map[token];if(!dl){TS.error("downloadWithTokenDidFinish: no download for token: "+token);return}_updateDownload(dl,"completed")},downloadWithTokenDidFailWithReasonAndCode:function(token,reason,status){var dl=_downloads_map[token];if(!dl){TS.error("downloadWithTokenDidFailWithReasonAndCode: no download for token: "+token);return}TS.generic_dialog.alert("Download failed: "+reason);_fetchDownloadsDataAndUpdate()},downloadMetadataChanged:function(){if(!_waiting_for_data_change)return;_waiting_for_data_change=false;_fetchDownloadsDataAndUpdate()},maybeBuild:function(){if(!TS.model.supports_downloads)return;$("#downloads_scroller .monkey_scroll_hider").css("width","auto");if(_shown_once)return;_shown_once=true;if(TS.model.ms_logged_in_once)_build()},maybeShowFlexMenuProgBar:function(){if(!TS.model.supports_downloads)return;_updateOverallProgress()},addIndividualDownload:function($el,file_id){_$individual_download=$el;_individual_file_id=file_id;_createSmallCircleProgress(_$individual_download)},removeIndividualDownload:function(){_$individual_download=$();_individual_file_id=""}});var _waiting_for_data_change=false;var _shown_once=false;var _is_built=false;var _downloads=[];var _downloads_map={};var _$downloads_tab=$("#downloads_tab");var _$scroller=$("#downloads_scroller");var _$downloads_empty=$("#downloads_empty");var _$downloads_tab_clear=$("#downloads_tab_clear");var _$downloads_shift_hint=$("#downloads_shift_hint");var _$flex_menu_download_circle;var _$individual_download=$();var _individual_file_id;var _ssb_supports_shift_open=TSSSB.call("supportsOpenFileAtPath");var _loggedIn=function(){_$flex_menu_download_circle=$(".flex_menu_download_circle");if(!TS.model.supports_downloads)return;if(_shown_once)_build();_createSmallCircleProgress(_$flex_menu_download_circle)};var _build=function(){if(!TS.model.supports_downloads)return;if(_is_built)return;_is_built=true;_$downloads_empty.html(TS.emoji.graphicReplace(_$downloads_empty.html()));var getTokenForEl=function(el){return $(el).closest(".download_item").data("token")};_$scroller.on("click.dl","a.download_cancel_link",function(e){_cancelDownload(getTokenForEl(e.target))});_$scroller.on("click.dl",".download_item.completed",function(e){var token=getTokenForEl(e.target);if(e.shiftKey){_openDownload(token)}else{_showDownload(token)}});_$scroller.on("click.dl",".download_item.canceled, .download_item.failed",function(e){_retryDownload(getTokenForEl(e.target))});_$scroller.on("click.dl","i.download_remove_link",function(e){_removeDownload(getTokenForEl(e.target))});if(_ssb_supports_shift_open){$(document).on("keydown",function(e){if(e.which===TS.utility.keymap.shift){_$downloads_tab.addClass("shift_key")}});$(document).on("keyup",function(e){_$downloads_tab.removeClass("shift_key")});TS.ui.window_focus_changed_sig.add(function(has_focus){_$downloads_tab.removeClass("shift_key")})}_$downloads_tab_clear.on("click.dl",function(e){_removeAllDownloads()});if(_ssb_supports_shift_open)_$downloads_tab.addClass("supports_open_file");_fetchDownloadsDataAndRender()};var _cancelDownload=function(token){var ret=TSSSB.call("cancelDownloadWithToken",token);if(ret===false){TS.error("_cancelDownload with token: "+token+" failed");return}_updateDownloadByToken(token,"canceled")};var _showDownload=function(token){var ret=TSSSB.call("revealDownloadWithToken",token);if(ret===false){TS.error("_showDownload with token: "+token+" failed");return}};var _openDownload=function(token){if(!_ssb_supports_shift_open){return}var ret=false;var dl=_downloads_map[token];if(dl){ret=TSSSB.call("openFileAtPath",dl.file_path)}if(ret===false){TS.error("_openDownload with token: "+token+" failed")}};var _retryDownload=function(token){var ret=TSSSB.call("retryDownloadWithToken",token);if(ret===false){TS.error("_retryDownload with token: "+token+" failed");return}var dl=_downloads_map[token];dl.dl_start_ts=Date.now()/1e3;_updateDownloadByToken(token,"in_progress")};var _removeDownload=function(token){var ret=TSSSB.call("pruneTokensFromHistory",JSON.stringify([token]));if(ret===false){TS.error("_removeDownload with token: "+token+" failed")}if(window.winssb){_waiting_for_data_change=true}else{_fetchDownloadsDataAndUpdate()}};var _removeAllDownloads=function(confirmed){if(!confirmed&&_getDownloadByState("in_progress")){TS.generic_dialog.start({title:"Clear all downloads",body:"<p>You have an active download. Are you sure you want to clear them all?</p>",show_cancel_button:true,show_go_button:true,go_button_text:"Yes, clear them all",onGo:function(){_removeAllDownloads(true)}});return}if(TSSSB.call("pruneTokensFromHistory",JSON.stringify(Object.keys(_downloads_map)))===false){TS.error("_removeAllDownloads with tokens: "+JSON.stringify(Object.keys(_downloads_map))+" failed")}if(window.winssb){_waiting_for_data_change=true}else{_fetchDownloadsDataAndRender()}};var _sortDownloads=function(){_downloads.sort(function compare(a,b){if(a.start_ts<b.start_ts)return 1;if(a.start_ts>b.start_ts)return-1;return 0})};var _fetchDownloadsData=function(){var downloads_str=TSSSB.call("metadataForDownloads");var was_downloads_map=_.cloneDeep(_downloads_map);_downloads.length=0;if(downloads_str){_downloads_map=JSON.parse(downloads_str);for(var k in _downloads_map){_downloads_map[k].token=k;_downloads_map[k].start_ts=parseFloat(_downloads_map[k].start_ts);if(_downloads_map[k].start_ts>9999999999){_downloads_map[k].start_ts=_downloads_map[k].start_ts/1e3}if(was_downloads_map[k]){if(!_downloads_map[k].hasOwnProperty("progress")){_downloads_map[k].progress=was_downloads_map[k].progress}_downloads_map[k].dl_start_ts=was_downloads_map[k].dl_start_ts}else{_downloads_map[k].dl_start_ts=_downloads_map[k].start_ts}_downloads.push(_downloads_map[k])}}_sortDownloads()};var _fetchDownloadsDataAndRender=function(){_fetchDownloadsData();_showProperPaneContent();_renderListHtml();_updateOverallProgress()};var _fetchDownloadsDataAndUpdate=function(){_fetchDownloadsData();_showProperPaneContent();_updateListHtml();_updateOverallProgress()};var _showProperPaneContent=function(){if(_downloads.length){_$scroller.removeClass("hidden");_$downloads_empty.addClass("hidden");if(_ssb_supports_shift_open)_$downloads_shift_hint.removeClass("hidden");_$downloads_tab_clear.toggleClass("hidden",_downloads.length<2)}else{_$scroller.empty().addClass("hidden");_$downloads_empty.removeClass("hidden");_$downloads_tab_clear.addClass("hidden");if(_ssb_supports_shift_open)_$downloads_shift_hint.addClass("hidden")}};var _renderListHtml=function(){var html="";for(var i in _downloads){html+=_buildItemHtml(_downloads[i])}_$scroller.html(html);TS.ui.utility.updateClosestMonkeyScroller($("#downloads_scroller"))};var _updateListHtml=function(){var dl;var $dl;if(!_downloads.length){_updateOverallProgress();return}for(var i in _downloads){dl=_downloads[i];$dl=_getDlDiv(dl.token);if($dl.length){_updateDownload(dl)}else{_addDlDiv(dl)}}var hidden_c=0;_$scroller.find(".download_item").each(function(i,dl){hidden_c++;$dl=$(dl);if($dl.hasClass("hidden_with_fade_out_and_shrink"))return;if(_downloads_map[$dl.data("token")])return;$dl.css("height",$dl.outerHeight()+"px");setTimeout(function($dl){return function(){$dl.addClass("hidden_with_fade_out_and_shrink")}}($dl),0)});if(hidden_c){setTimeout(function(){TS.ui.utility.updateClosestMonkeyScroller($("#downloads_scroller"))},550)}};var _updateProgress=function(state){if(_$individual_download.length&&_individual_file_id){_updateIndividualProgress()}_updateOverallProgress()};var _addDlDiv=function(dl){if(!dl){TS.error("_addDlDiv: no dl passed");return}_$scroller.prepend(_buildItemHtml(dl));TS.ui.utility.updateClosestMonkeyScroller($("#downloads_scroller"));_updateProgress()};var _updateDownloadByToken=function(token,state){var dl=_downloads_map[token];if(!dl){TS.error("_updateDownloadByToken: no download for token: "+token);return}_updateDownload(dl,state)};var _updateDownload=function(dl,state){if(!dl){TS.error("_updateDownload: no dl passed");return}if(state)dl.state=state;if(dl.state=="completed"){dl.progress=1}else if(dl.state=="in_progress"){}else{dl.progress=0}_updateProgress(state);var $dl=_getDlDiv(dl.token);if(!$dl.length){TS.error("no $dl found for token: "+dl.token);return}if($dl.hasClass("hidden_with_fade_out_and_shrink")){return}$dl.replaceWith(_buildItemHtml(dl));TS.ui.utility.updateClosestMonkeyScroller($("#downloads_scroller"))};var _buildItemHtml=function(dl){var file=_getFileForDl(dl);if(!file&&!dl.tried_fetch){dl.tried_fetch=true;var rx=new RegExp(TS.utility.regexpEscape(TS.model.team.id)+"-F[A-Z0-9]+");var matches=dl.href.match(rx);var team_and_file;var file_id;if(matches){team_and_file=matches[0];file_id=team_and_file.split("-")[1];TS.warn("_buildItem: fetching file for dl.href: "+dl.href);TS.files.fetchFileInfo(file_id,function(id,file){dl=_downloads_map[dl.token];if(!dl)return;_updateDownload(dl)})}else{TS.error("_buildItem: no file id found in dl.href: "+dl.href)}}var img_src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==";var filetype;var pretty_type;var size=0;var partial_size=0;var file_name;if(file){img_src=file.thumb_160||file.thumb_80;filetype=file.filetype||null;pretty_type=file.pretty_type||null;file_name=file.name||null;size=file.size;if(dl.state=="in_progress"&&dl.progress){partial_size=dl.progress*size}}var template_args={item:dl,img_src:img_src,filetype:filetype,pretty_type:pretty_type,name:dl.file_path.split(/\/|\\/).reverse()[0]||file_name,size:size,partial_size:partial_size,estimate:_getDlEstimate(dl),debug:JSON.stringify(_downloads_map,null,2),perc:dl.state=="completed"?100:Math.max(.02,dl.progress)*100};return TS.templates.download_item(template_args)};var _fileDownloadUrl=function(file){return file.url_private_download};var _updateOverallProgress=function(){var dl;var total_bytes=0;var downloaded_bytes=0;for(var k in _downloads_map){dl=_downloads_map[k];if(dl.state!="in_progress")continue;if(isNaN(dl.progress))continue;if(dl.progress>=1)continue;var file=_getFileForDl(dl);if(!file)continue;if(!file.size)continue;total_bytes+=file.size;downloaded_bytes+=file.size*Math.max(0,dl.progress)}if(total_bytes){var percentage=_getVisualDownloadPercentage(downloaded_bytes,total_bytes);_$flex_menu_download_circle.circleProgress({value:percentage}).addClass("shown_with_fade_in");$("#downloads_menu_progress").removeClass("hidden").find(".download_progress_bar").css("width",percentage*100+"%")}else{_$flex_menu_download_circle.removeClass("shown_with_fade_in");$("#downloads_menu_progress").addClass("hidden")}};var _updateIndividualProgress=function(){var dl;var total_bytes=0;var downloaded_bytes=0;for(var k in _downloads_map){dl=_downloads_map[k];if(dl.state!="in_progress")continue;if(isNaN(dl.progress))continue;if(dl.progress>=1)continue;var file=_getFileForDl(dl);if(!file)continue;if(file.id===_individual_file_id){if(file.size){total_bytes+=file.size;downloaded_bytes+=file.size*Math.max(0,dl.progress)}break}}if(total_bytes){var percentage=_getVisualDownloadPercentage(downloaded_bytes,file.size);_$individual_download.circleProgress({value:percentage}).addClass("shown_with_fade_in")}else{_$individual_download.removeClass("shown_with_fade_in")}};var _createSmallCircleProgress=function($el){$el.circleProgress({value:0,size:9,animation:false,fill:{gradient:["#50acf4","#41a6f5"]},emptyFill:"rgba(211,211,211,1)",thickness:2,lineCap:"round",startAngle:Math.PI/-2})};var _getVisualDownloadPercentage=function(downloaded_bytes,total_bytes){var percentage=downloaded_bytes/total_bytes;return Math.max(.06,Math.min(1,percentage))};var _getFileForDl=function(dl){return TS.files.getFileByDownloadUrlPrivate(dl.href)};var _getDlEstimate=function(dl){if(!dl)return"";if(dl.state!="in_progress")return"";if(dl.progress>=1)return"";if(dl.progress==-1)return"";if(!dl.progress)return"";if(dl.progress<.02)return"...";var secs_so_far=Date.now()/1e3-dl.dl_start_ts;var total_secs_estimate=secs_so_far*(1/dl.progress);var secs_to_go_estimate=total_secs_estimate-secs_so_far;return Math.ceil(secs_to_go_estimate)+"s remaining"};var _getDlDiv=function(token){return _$scroller.find('[data-token="'+token+'"]')};var _highlightDlDiv=function(token){var $dl=_getDlDiv(token);$dl.scrollintoview({duration:100,offset:"center_vertical",complete:function(){$dl.highlight(3e3,"download_item_highlighter",null,0)}})};var _getDownloadByUrl=function(url){return _getDownloadByProp("href",url)};var _getDownloadByState=function(state){return _getDownloadByProp("state",state)};var _getDownloadByProp=function(name,value){if(!name)return null;if(!value&&value!==0)return null;for(var i=0;i<_downloads.length;i++){if(_downloads[i][name]==value)return _downloads[i]}return null}})();(function(){"use strict";TS.registerModule("client.whats_new",{onStart:function(){TS.client.login_sig.add(_onLogin);TS.prefs.whats_new_read_changed_sig.add(_updateEverything);TS.client.flexpane_display_switched_sig.add(_decideIfRead)},updateIcon:function(){_updateIcon()}});var _$whats_new_updates=$("#whats_new_updates");var _$what_new_read_cb=$("#what_new_read_cb");var _$burst;var _newest_id=-1;var _unread_count=0;var _timer;var _ready=false;var _onLogin=function(){_ready=true;_$whats_new_updates.find(".whats_new_content").each(function(){var $el=$(this);if(!$el.hasClass("html")){$el.html(TS.format.formatNoHighlightsNoInlineImgs($el.html()))}});_newest_id=_$whats_new_updates.children().first().data("whats-new-id")||_newest_id;_updateEverything();_$what_new_read_cb.bind("change",function(){_setUserBadgingPref(!!$(this).prop("checked"))});_bindUI()};var _bindUI=function(){if(TS.boot_data.feature_clog_whats_new){_$whats_new_updates.find("a.whats_new_content").on("click",function(e){TS.clog.track("WHATSNEW_ACTION",{action:"view_update",trigger:"heading_link",page_url:$(this).attr("href")})});_$whats_new_updates.find("p.whats_new_content").find("a").on("click",function(e){TS.clog.track("WHATSNEW_ACTION",{action:"view_update",trigger:"description_link",page_url:$(this).attr("href")})});_$whats_new_updates.find("a.whats_new_more").on("click",function(e){TS.clog.track("WHATSNEW_ACTION",{action:"view_update",trigger:"read_more_link",page_url:$(this).attr("href")})})}};var _setUserBadgingPref=function(do_badge){var val=-1;if(do_badge){val=_newest_id||Math.floor(Date.now()/1e3);TS.clog.track("WHATSNEW_ACTION",{action:"opt_in",trigger:"checkbox_whats_new"})}else{TS.clog.track("WHATSNEW_ACTION",{action:"opt_out",trigger:"checkbox_whats_new"})}TS.prefs.onPrefChanged({name:"whats_new_read",value:val});TS.prefs.setPrefByAPI({name:"whats_new_read",value:val});_updateEverything()};var _markItRead=function(){if(TS.model.prefs.whats_new_read==-1)return;TS.prefs.onPrefChanged({name:"whats_new_read",value:_newest_id});TS.prefs.setPrefByAPI({name:"whats_new_read",value:_newest_id});_unread_count=0};var _decideIfRead=function(){if(!_ready)return;var name=TS.model.ui_state.flex_name;if(!TS.model.ui_state.flex_visible||name!="whats_new"){clearTimeout(_timer);return}if(_readEverythingAlready())return;_timer=setTimeout(function(){_markItRead()},1e3)};var _countUnreads=function(){_unread_count=0;_$whats_new_updates.children().each(function(){var $el=$(this);var id=$el.data("whats-new-id");if(id&&TS.model.prefs.whats_new_read<id){_unread_count++}})};var _updateEverything=function(){_countUnreads();_decideIfRead();_updateBurst();_updateCB();_updateIcon()};var _updateCB=function(){_$what_new_read_cb.prop("checked",TS.model.prefs.whats_new_read!==-1)};var _updateBurst=function(){if(!_$burst){_$burst=$("#whats_new_burst")}if(!_$burst)return;if(_readEverythingAlready()||!_showBadges()){TS.experiment.loadUserAssignments().then(function(){var group=TS.experiment.getGroup("whats_new_header_icon");if(group==="treatment"){$("#client-ui").removeClass("whats_new_showing")}else{_$burst.addClass("all_read")}})}else{TS.experiment.loadUserAssignments().then(function(){var group=TS.experiment.getGroup("whats_new_header_icon");if(group==="treatment"){$("#client-ui").addClass("whats_new_showing")}else{_$burst.removeClass("all_read")}});TS.clog.track("WHATSNEW_ACTION",{action:"do_badge"})}};var _updateIcon=function(){var $count=$("#whats_new_count");if(_unread_count&&_showBadges()){$count.removeClass("hidden");$count.text(_unread_count<10?_unread_count:"9+")}else{$count.addClass("hidden")}};var _showBadges=function(){return TS.model.prefs.whats_new_read!==-1&&TS.model.team.prefs.whats_new_badges!==false};var _readEverythingAlready=function(){return TS.model.prefs.whats_new_read>=_newest_id}})();(function(){"use strict";TS.registerModule("client.history_prefetch",{addToHistoryFetchQueue:function(c_id){if(!c_id)return;if(!_history_fetch_queue)_history_fetch_queue=[];if(_history_fetch_queue.indexOf(c_id)!==-1)return false;_history_fetch_queue.push(c_id);return true},processHistoryFetchQueue:function(){if(_history_fetch_queue._being_processed||!_history_fetch_queue.length)return false;_getHistoryFetchFrecency();_sortHistoryQueueByFrecency();_prioritizeIMsAndMPIMsInQueue();_maybeTruncateHistoryQueue();if(TS.pri){var log_str=[];_.each(_history_fetch_queue,function(id){var model_ob=TS.shared.getModelObById(id);var model_ob_name=model_ob.name||"unknown";log_str.push(id+" ("+model_ob_name+")")});TS.log(58,"pre-loading history for "+_history_fetch_queue.length+(_history_fetch_queue.length===1?" item: ":" items: ")+log_str.join(", "))}_history_fetch_queue.being_processed=true;if(_history_fetch_queue.length>1){TS.api.callFuncWhenApiQisEmpty(function(){_processHistoryFetchQueueItem();_processHistoryFetchQueueItem()})}else{TS.api.callFuncWhenApiQisEmpty(_processHistoryFetchQueueItem)}return true},resetHistoryFetchQueue:function(){_history_fetch_queue=[];_history_fetch_frecency_matches=[]}});var _history_fetch_queue=[];var _history_fetch_queue_max_size=20;var _history_fetch_queue_min_frecency=40;var _history_fetch_frecency_matches=[];var _history_fetch_queue_frecency;var _getHistoryFetchFrecency=function(){if(_history_fetch_frecency_matches.length)return;if(TS.frecency&&!_history_fetch_queue_frecency){var frecency=TS.frecency.getExisting("jumper");_history_fetch_queue_frecency=frecency&&frecency.getMostCommon()}if(!_history_fetch_queue_frecency){TS.warn('WTF no TS.frecency module? or no "jumper" frecency?');return}_history_fetch_frecency_matches=_history_fetch_queue_frecency.filter(function(item){return item.score>=_history_fetch_queue_min_frecency}).map(function(item){return item.id})};var _sortHistoryQueueByFrecency=function(){if(!_history_fetch_frecency_matches.length)return;var offset;for(var i=_history_fetch_frecency_matches.length-1;i>=0;i--){offset=_history_fetch_queue.indexOf(_history_fetch_frecency_matches[i]);if(offset!==-1){_history_fetch_queue.unshift(_history_fetch_queue.splice(offset,1)[0])}}};var _prioritizeIMsAndMPIMsInQueue=function(){var ims_and_mpims=_.filter(_history_fetch_queue,function(item){var model_ob=TS.shared.getModelObById(item);return model_ob&&(model_ob.is_im||model_ob.is_mpim)});ims_and_mpims.reverse();_.each(ims_and_mpims,function(imOrMPIM){var offset=_history_fetch_queue.indexOf(imOrMPIM);_history_fetch_queue.unshift(_history_fetch_queue.splice(offset,1)[0])})};var _maybeTruncateHistoryQueue=function(){var minimum_required_offset=0;for(var i=0,j=_history_fetch_queue.length;i<j;i++){var model_ob=TS.shared.getModelObById(_history_fetch_queue[i]);if(model_ob&&(!model_ob.is_im&&!model_ob.is_mpim)){minimum_required_offset=i;if(TS.pri)TS.log(58,"queued "+minimum_required_offset+" required IM/MPIM item(s) for pre-fetch: "+_history_fetch_queue.slice(0,i).join(", "));break}}var before=_history_fetch_queue.length;_history_fetch_queue.length=Math.min(_history_fetch_queue.length,_history_fetch_queue_max_size+minimum_required_offset);if(TS.pri&&before!==_history_fetch_queue.length)TS.log(58,"truncated history fetch queue from "+before+" to "+_history_fetch_queue.length+(minimum_required_offset?", including "+minimum_required_offset+" required IM/MPIM item(s)":""))};var _processHistoryFetchQueueItem=function(){if(!_history_fetch_queue||!_history_fetch_queue.length){if(TS.pri)TS.log(58,"_processHistoryFetchQueue: done.");_history_fetch_queue.being_processed=false;return}var id=_history_fetch_queue.shift();var model_ob=TS.shared.getModelObById(id);if(!model_ob){TS.warn('_processHistoryFetchQueue: could not find model_ob for id "'+id+'"');return}var controller=TS.shared.getControllerForModelOb(model_ob);if(!controller){TS.warn("_processHistoryFetchQueue: could not find controller for model_ob");return _processHistoryFetchQueueItem()}TS.shared.maybeFetchHistory(model_ob);if(model_ob.history_is_being_fetched){controller.history_fetched_sig.addOnce(function(history_model_ob){if(TS.pri)TS.log(58,'fetched history for "'+history_model_ob.id+'" "'+history_model_ob.name+'"');TS.api.callFuncWhenApiQisEmpty(function(){window.setTimeout(_processHistoryFetchQueueItem,250+Math.random()*250)})})}else{if(TS.pri)TS.log(58,'_processHistoryFetchQueue: no history fetch started for "'+model_ob.id+'" "'+model_ob.name+'" - assuming up to date.');_processHistoryFetchQueueItem()}}})();(function(){"use strict";TS.registerModule("key_triggers",{onStart:function(){if(TS.boot_data.special_flex_panes){for(var k in TS.boot_data.special_flex_panes){var special=TS.boot_data.special_flex_panes[k];if(special.keycode){(function(keycode,flex_name){TS.key_triggers[keycode.toString()]={func:function(){TS.client.ui.flex.openFlexTab(flex_name)}}})(special.keycode,special.flex_name)}}}},220:{isDisabled:function(e){return TS.client.activeChannelIsHidden()},shift_optional:false,func:function(e){var model_ob=TS.shared.getActiveModelOb();if(!model_ob)return;var is_reply=TS.boot_data.feature_message_replies&&$(e.target).closest("#reply_container").length>0;var msgs;if(is_reply){var msgs_arr=_.clone(TS.ui.replies.getActiveMessages());msgs=_.reverse(msgs_arr);e.target=$("#reply_container")}else{msgs=TS.utility.msgs.getDisplayedMsgs(model_ob.msgs);e.target=TS.client.ui.$msg_input}var msg=_(msgs).take(5).find(function(msg){return!msg.is_ephemeral});if(!msg)return;if(msg._jl_rolled_up_in){msg=TS.utility.msgs.getMsg(msg._jl_rolled_up_in,model_ob.msgs);if(!msg)return}var rxn_key=TS.rxns.getRxnKeyByMsgType(msg);var actions=TS.utility.msgs.getMsgActions(msg,model_ob);if(!actions||!actions.add_rxn&&!actions.add_file_rxn&&!actions.add_file_comment_rxn){TS.sounds.play("beep");return}TS.menu.emoji.start({e:e,rxn_key:rxn_key})}},77:{isDisabled:function(e){return TS.model.is_chrome_desktop||TS.model.is_chrome_mobile},func:function(){if(TS.model.ui_state.flex_visible&&TS.model.ui_state.flex_name==="mentions"){TS.client.ui.flex.hideFlex()}else{TS.client.ui.flex.openFlexTab("mentions")}}},83:{func:function(){if(TS.model.ui_state.flex_visible&&TS.model.ui_state.flex_name==="stars"){TS.client.ui.flex.hideFlex()}else{TS.client.ui.flex.openFlexTab("stars")}}},85:{isDisabled:function(e){return!!e.altKey||TS.client.activeChannelIsHidden()},no_shift:true,func:function(){TS.client.ui.files.$upload.trigger("click")}},69:{isDisabled:function(e){return!!TS.model.is_FF},func:function(){if(TS.model.ui_state.flex_visible&&TS.model.ui_state.flex_name==="team"){TS.client.ui.flex.hideFlex()}else{TS.client.ui.flex.openFlexTab("team")}}},65:{isDisabled:function(e){if(!TS.boot_data.feature_unread_view||!TS.client.unread.isEnabled())return true;return false},func:function(){if(TS.model.unread_view_is_showing){TS.client.unread.reloadIfPendingMessages()}else{TS.client.unread.showUnreadView()}}},73:{isDisabled:function(e){if(!TS.model.is_our_app)return true;if(window.loadSettings&&window.loadSettings.devMode)return true;if(TS.client.activeChannelIsHidden())return true;return false},func:function(){if(TS.model.ui_state.flex_visible&&TS.model.ui_state.flex_name==="details"){TS.client.ui.flex.hideFlex()}else{TS.client.ui.flex.openFlexTab("details")}}},70:{isDisabled:function(e){return!(TS.model.is_our_app||TS.model&&TS.model.prefs&&TS.model.prefs.f_key_search)},no_shift:true,func:function(){TS.client.ui.flex.openFlexTab("search");TS.view.resizeManually("TS.key_triggers");TS.clog.track("SEARCH_OPEN",{open_method:"key"});var txt="in:"+TS.shared.getActiveModelOb().name+" ";TS.search.setInputVal(txt);var system_find_str=TSSSB.call("readFindString");if(system_find_str){TS.search.appendToInputAndSelect(system_find_str)}}},74:{isDisabled:function(){return!TS.environment.is_apple_webkit},no_shift:true,func:_.noop},75:{isDisabled:function(e){return e.altKey||!TS.client.ui.isUserAttentionOnChat()||!TS.model||!TS.model.is_our_app&&!TS.model.prefs.k_key_omnibox},no_shift:true,func:function(){if(TS.model.prefs.no_omnibox_in_channels){TS.clog.track("QUICKSWITCHER_ACTION",{trigger:"keyboard_shortcut_no_btn",action:"opened"})}TS.clog.track("QUICKSWITCHER_ACTION",{trigger:"keyboard_shortcut",action:"opened"});if(TS.model.prefs.k_key_omnibox_auto_hide_count<5)TS.prefs.setPrefByAPI({name:"k_key_omnibox_auto_hide_count",value:TS.model.prefs.k_key_omnibox_auto_hide_count+1});TS.ui.jumper.start()}},76:{isDisabled:function(e){if(!e.metaKey&&!e.altKey&&!e.shiftKey&&e.ctrlKey&&TS.model.is_mac){e.preventDefault();e.stopPropagation()}return e.altKey||!TS.client.ui.isUserAttentionOnChat()||!TS.model},shift_optional:false,func:function(){TS.ui.channel_browser.start()}},84:{isDisabled:function(e){return e.altKey||!TS.client.ui.isUserAttentionOnChat()||!TS.model||!TS.model.is_our_app},no_shift:true,func:function(){if(TS.model.prefs.no_omnibox_in_channels){TS.clog.track("QUICKSWITCHER_ACTION",{trigger:"keyboard_shortcut_no_btn",action:"opened"})}TS.clog.track("QUICKSWITCHER_ACTION",{trigger:"keyboard_shortcut",action:"opened"});if(TS.model.prefs.k_key_omnibox_auto_hide_count<5)TS.prefs.setPrefByAPI({name:"k_key_omnibox_auto_hide_count",value:TS.model.prefs.k_key_omnibox_auto_hide_count+1});TS.ui.jumper.start()}},188:{isDisabled:function(e){if(!TS.model)true;if(!TS.model.prefs)true;if(!TS.model.is_mac)return true;if(e.shiftKey){if(TS.model.active_im_id){return true}else{return false}}if(TS.model.mac_ssb_version)return true;if(!TS.model.prefs.comma_key_prefs)return true},shift_optional:true,func:function(e){if(e.shiftKey){TS.ui.channel_prefs_dialog.start(TS.model.active_cid)}else{TS.ui.prefs_dialog.start()}}}})})();(function(){"use strict";TS.registerModule("search.view",{latest_msg_search_results:null,added_to_history_last_ms:0,search_results_lazy_load:null,last_terms:"",filter_delay_ms:6e4,onStart:function(){TS.search.search_filter_set_sig.add(TS.search.view.renderResults,TS.search.view);TS.search.search_filetype_filter_set_sig.add(TS.search.searchAll,TS.search);TS.search.search_sort_set_sig.add(_searchSortChanged);TS.prefs.messages_theme_changed_sig.add(TS.search.view.messagesThemeChanged,TS.search.view);TS.search.message_search_results_fetched_sig.add(_messageSearchFetched);TS.search.file_search_results_fetched_sig.add(_fileSearchFetched);if(TS.client){$("#flexpane_tabs a").bind("click.setSearchFilter",function(){if($(this).data("tab-id")=="files"||$(this).data("filetype")){TS.search.setFilter("files")}else{TS.search.setFilter("messages")}});$("#search_results_items").bind("click.view",function(e){if($(e.target).closest("A").length===0)return;if($(e.target).closest(".file_list_item").length==1){TS.search.view.maybeLogSearchInteraction("files")}});$("#search_tabs").html(TS.templates.search_tabs);$("#search_clear").bind("click.switch_to_files",function(){if(TS.search.filter=="files"&&TS.model.ui_state.flex_visible){setTimeout(function(){TS.search.view.switchBackToFiles()},50)}});$("#search_results").scroll(function(){_debouncedScrollEvents();if(TS.menu.search_filter_is_showing){TS.menu.end()}});TS.client.login_sig.add(TS.search.view.loggedIn,TS.search.view)}if(TS.web){TS.web.login_sig.add(TS.search.view.loggedIn,TS.search.view);TS.search.all_search_results_fetched_sig.add(TS.search.view.updateHistory,TS.search.view);
TS.search.search_filter_set_sig.add(TS.search.view.updateHistory,TS.search.view);$(window).bind("popstate",function(e){TS.search.view.onPopState(e.originalEvent)})}},loggedIn:function(ok,data){if(TS.client){if(TS.model.prefs.search_sort==="timestamp"){$("#search_sort_timestamp").addClass("active")}else if(TS.model.prefs.search_sort==="model"&&$("#search_sort_model").length){$("#search_sort_model").addClass("active")}else{$("#search_sort_score").addClass("active")}}if(TS.web){if(TS.boot_data.filter)TS.search.setFilter(TS.boot_data.filter);if(TS.boot_data.query){TS.search.query=TS.search.truncateQuery(TS.boot_data.query);TS.search.searchAll(TS.search.query)}}},pageMessagesForward:function(){var results=TS.search.results[TS.search.query_string];if(!results.messages||TS.search.view.current_messages_page+1>results.messages.paging.pages)return;TS.search.view.current_messages_page++;TS.search.view.renderResults();if(TS.search.separateMessagesAndFiles()&&TS.search.view.current_messages_page<=results.messages.paging.page)return;$("#search_results_team").addClass("hidden");if(TS.search.view.current_messages_page<results.messages.paging.page)return;if(TS.search.separateMessagesAndFiles()){TS.search.getNextPageOfMessageResults(TS.search.query_string,TS.search.view.current_messages_page)}else{TS.search.getNextPageOfSearchResults(TS.search.query_string,TS.search.view.current_messages_page+1)}},pageMessagesBack:function(){if(TS.search.view.current_messages_page-1<1)return;TS.search.view.current_messages_page--;TS.search.view.renderResults()},pageFilesForward:function(){var results=TS.search.results[TS.search.query_string];if(!results.files||TS.search.view.current_files_page+1>results.files.paging.pages)return;TS.search.view.current_files_page++;TS.search.view.renderResults();if(TS.search.separateMessagesAndFiles()&&TS.search.view.current_files_page<=results.files.paging.page)return;$("#search_results_team").addClass("hidden");if(TS.search.view.current_files_page<results.files.paging.page)return;if(TS.search.separateMessagesAndFiles()){TS.search.getNextPageOfFileResults(TS.search.query_string,TS.search.view.current_files_page)}else{TS.search.getNextPageOfSearchResults(TS.search.query_string,TS.search.view.current_files_page+1)}},pageFilesBack:function(){if(TS.search.view.current_files_page-1<1)return;TS.search.view.current_files_page--;TS.search.view.renderResults()},searchFetched:function(results,args){if(args.page==1){TS.search.view.current_messages_page=1;TS.search.view.current_files_page=1;TS.search.view.waiting_on_page=-1;TS.search.view.renderResults();TS.search.view.messageSearchResultsFetched(results,args);TS.search.view.searchMembers()}else if(args.page==TS.search.view.waiting_on_page){TS.search.view.renderResults()}},waiting_on_page:-1,waiting_on_messages_page:-1,waiting_on_files_page:-1,current_messages_page:1,current_files_page:1,renderResults:function(){if(_already_rendering)return;TS.search.view.updateOptions();if(!TS.search.results[TS.search.query_string])return;var results=TS.search.results[TS.search.query_string];var html="";var page=[];var start;var display_paging_in_scroller=true;if(TS.search.filter=="messages"){start=(TS.search.view.current_messages_page-1)*TS.search.per_page;if(results.messages&&results.messages.matches)page=results.messages.matches.slice(start,start+TS.search.per_page);if(!page.length){if(TS.search.separateMessagesAndFiles()){TS.search.view.waiting_on_messages_page=TS.search.view.current_messages_page}else{TS.search.view.waiting_on_page=TS.search.view.current_messages_page}}if(page.length){html=TS.templates.search_message_results({results:results,page:page,current_page:TS.search.view.current_messages_page,paging_html:results.messages&&display_paging_in_scroller?new Handlebars.SafeString(TS.templates.messages_search_paging({current_page:TS.search.view.current_messages_page,pages:results.messages.paging.pages})):"",is_enterprise:TS.boot_data.page_needs_enterprise,search_global:!TS.model.prefs.search_only_current_team})}else if(!results.messages||results.messages.total>0){html+='<div class="loading_hash_animation"><img src="'+cdn_url+"/f85a/img/loading_hash_animation_@2x.gif"+'" alt="Loading" /><br />loading page '+TS.search.view.current_messages_page+"...</div>"}else{html=TS.templates.search_results_none({query_string:TS.search.query_string,filter:"messages",error:results.error})}$("#search_results_message_limit").removeClass("hidden");$("#search_results_file_limit").addClass("hidden")}else if(TS.search.filter=="files"){$("#search_tabs").slideDown(500);start=(TS.search.view.current_files_page-1)*TS.search.per_page;if(results.files&&results.files.matches)page=results.files.matches.slice(start,start+TS.search.per_page);if(!page.length){if(TS.search.separateMessagesAndFiles()){TS.search.view.waiting_on_files_page=TS.search.view.current_files_page}else{TS.search.view.waiting_on_page=TS.search.view.current_files_page}}if(page.length){var paging_html=display_paging_in_scroller?TS.templates.files_search_paging({current_page:TS.search.view.current_files_page,pages:results.files.paging.pages}):"";var file_template_args={for_search:true,is_enterprise:TS.boot_data.page_needs_enterprise};$.each(page,function(index,file){html+=TS.templates.builders.fileHTML(file,file_template_args)});html+=paging_html}else if(!results.files||results.files.total>0){html+='<div class="loading_hash_animation"><img src="'+cdn_url+"/f85a/img/loading_hash_animation_@2x.gif"+'" alt="Loading" /><br />loading page '+TS.search.view.current_files_page+"...</div>"}else{html+=TS.templates.search_results_none({query_string:TS.search.query_string,filter:"files",error:results.error,filetype:TS.search.filetype,filetype_label:TS.model.file_list_type_map[TS.search.filetype]})}$("#search_results_file_limit").removeClass("hidden");$("#search_results_message_limit").addClass("hidden")}$("#search_results_items").find(".search_jump_maybe").tooltip("destroy");$("#search_results_items").html(html);if(TS.view){TS.utility.makeSureAllLinksHaveTargets($("#search_results_items"))}else{TS.utility.makeSureAllExternalLinksAreRefererSafe($("#search_results_items"))}$("#search_results_items").find(".search_jump_maybe").tooltip({delay:{show:450,hide:150},container:"body",placement:"left"});if(TS.client){try{_already_rendering=true;TS.search.view.showResults()}finally{_already_rendering=false}if(start===0)TS.view.resizeManually("TS.search.view.renderResults");$("#search_results").scrollTop(0);TS.client.ui.checkInlineImgsAndIframes("search")}if(TS.search.view.search_results_lazy_load&&TS.search.view.search_results_lazy_load.detachEvents){TS.search.view.search_results_lazy_load.detachEvents()}$("#search_results_container").find(TS.boot_data.feature_files_list?".lazy":"img.lazy").lazyload({container:$("#search_results"),throttle:200});if(TS.search.filter==="messages"){_initializeExtracts(results);if(_cached_msgs_scroll_position){$("#search_results").scrollTop(_cached_msgs_scroll_position)}}else{if(_cached_files_scroll_position){$("#search_results").scrollTop(_cached_files_scroll_position)}}},showResults:function(){var previous_active_tab_id=TS.model.ui.active_tab_id;var previous_active_tab_ts=TS.model.ui.active_tab_ts;var previous_file_id=TS.model.previewed_file_id;if(!TS.model.ui_state.flex_visible||TS.model.ui_state.flex_name!=="search"){TS.client.ui.flex.openFlexTab("search");TS.clog.track("SEARCH_OPEN",{open_method:"search_box"})}$("#header_search_form").addClass("active");if(previous_active_tab_id=="files"&&TS.model.ui.active_tab_ts-TS.search.view.filter_delay_ms<previous_active_tab_ts)TS.search.setFilter("files");if(TS.search.filter=="messages"){$("#search_tabs").show()}else if(TS.search.filter=="files"){$("#search_tabs").slideDown(500);if(previous_active_tab_id=="files"&&!previous_file_id&&TS.model.active_file_list_filter!==TS.search.filetype){TS.search.setFiletypeFilter(TS.model.active_file_list_filter)}}},maybeRebuildResults:function(){var $results=$("#search_message_results");if(!$results.length||!$results.children().length){TS.search.search_filter_set_sig.dispatch()}},cleanResults:function(){if(TS.search.view.search_results_lazy_load&&TS.search.view.search_results_lazy_load.detachEvents){TS.search.view.search_results_lazy_load.detachEvents()}$("#search_results_team").empty();$("#search_results_items").empty()},clearFiletypeFilter:function(){TS.search.setFiletypeFilter("all")},updateOptions:function(){var template_args={search_filter:TS.search.filter,sort_filter:TS.search.sort,search_only_my_channels:TS.model.prefs.search_only_my_channels,menu_is_showing:TS.menu.search_filter_is_showing};var results=TS.search.results[TS.search.query_string];var include_text="everything";var search_only_my_channels=TS.model.prefs.search_only_my_channels;var search_exclude_bots=TS.model.prefs.search_exclude_bots;var search_only_current_team=TS.model.prefs.search_only_current_team;var exclude_bots_ignored=false;if(results&&results.ignored_exclude_bots_pref&&results.messages&&results.messages.total>0)exclude_bots_ignored=true;var name_list="";if(exclude_bots_ignored){var names=_fromNames(TS.search.query_string);name_list=TS.utility.concatNames(names);name_list=TS.utility.htmlEntities(name_list)}var result_type=TS.search.filter==="messages"?"messages":"files";if(search_only_my_channels&&search_exclude_bots){if(exclude_bots_ignored){include_text="only channels I have joined, "+result_type+" from "+name_list}else{include_text="only channels I have joined, no bots or integrations"}}else if(search_only_my_channels&&!search_exclude_bots){include_text="only "+result_type+" from channels I have open"}else if(!search_only_my_channels&&search_exclude_bots){if(exclude_bots_ignored){include_text=result_type+" from "+name_list}else{include_text="only "+result_type+" from people"}}if(TS.boot_data.page_needs_enterprise&&TS.boot_data.feature_enterprise_search_ui){var org_name=TS.model.enterprise.name;var fitler_label_text={org_bots_allchannels:"everything I can access in "+org_name,org_bots_openchannels:"only messages from channels I have open in "+org_name,org_nobots_allchannels:"only messages from people in "+org_name,org_nobots_openchannels:"messages from people in all channels I have open in "+org_name,noorg_bots_allchannels:"everything on this team",noorg_bots_openchannels:"only messages from channels I have open on this team",noorg_nobots_allchannels:"only messages from people on this team",noorg_nobots_openchannels:"messages from people, in only channels I have open, on this team"};if(!search_only_current_team&&!search_only_my_channels&&!search_exclude_bots){include_text=fitler_label_text.org_bots_allchannels}else if(!search_only_current_team&&search_only_my_channels&&!search_exclude_bots){include_text=fitler_label_text.org_bots_openchannels}else if(!search_only_current_team&&!search_only_my_channels&&search_exclude_bots){include_text=fitler_label_text.org_nobots_allchannels}else if(!search_only_current_team&&search_only_my_channels&&search_exclude_bots){include_text=fitler_label_text.org_nobots_openchannels}else if(search_only_current_team&&!search_only_my_channels&&!search_exclude_bots){include_text=fitler_label_text.noorg_bots_allchannels}else if(search_only_current_team&&search_only_my_channels&&!search_exclude_bots){include_text=fitler_label_text.noorg_bots_openchannels}else if(search_only_current_team&&!search_only_my_channels&&search_exclude_bots){include_text=fitler_label_text.noorg_nobots_allchannels}else if(search_only_current_team&&search_only_my_channels&&search_exclude_bots){include_text=fitler_label_text.noorg_nobots_openchannels}}template_args.include_text=include_text;var html=TS.templates.search_options(template_args);$("#search_options").html(html);if(TS.search.results[TS.search.query_string]){var messages_count=results&&results.initial_messages_total?results.initial_messages_total:0;var files_count=results&&results.initial_files_total?results.initial_files_total:0;$("#search_tabs").html(TS.templates.search_tabs({messages_count:TS.utility.numberWithCommas(messages_count),files_count:TS.utility.numberWithCommas(files_count)}))}if(TS.search.filter=="files"){$("#search_heading").html(TS.templates.search_files_heading({filetype:TS.search.filetype,filetype_label:TS.model.file_list_type_map[TS.search.filetype]}));$("#search_file_list_heading").bind("click.show_menu",function(e){e.preventDefault();TS.menu.file.startWithFileFilter(e,true)});$("#search_file_list_clear_filter").bind("click.clear_filter",function(e){e.stopPropagation();TS.search.view.clearFiletypeFilter()})}else{$("#search_heading").html("Search Results")}$(".search_filter_menu_target").click(TS.menu.startWithSearchFilter)},switchBackToFiles:function(){if(TS.search.results[TS.search.query_string]){var time_since_last_search=(Date.now()-TS.search.results[TS.search.query_string]._time_of_search)/1e3;if(time_since_last_search<60){TS.client.ui.files.filterFileList(TS.search.filetype);if(TS.search.member){TS.client.ui.files.toggleFileList(TS.search.member.id)}else{TS.client.ui.files.toggleFileList("all")}}else{TS.client.ui.files.filterFileList("all");TS.client.ui.files.toggleFileList("all")}}$("#search_tabs").slideUp(250,function(){setTimeout(function(){TS.client.ui.files.showFileList()},100)})},searchMembers:function(){var query=TS.search.query_string,$search_results_team=$("#search_results_team"),real_name_regex=new RegExp("\\b"+TS.utility.regexpEscape(query)+"\\b","i");$search_results_team.removeClass("hidden");var query_lc=query.toLowerCase();var members=TS.members.getMembersForUser();var team_matches=$.grep(members,function(member,i){if(!member.deleted){return member._name_lc==query_lc||member.profile.real_name_normalized&&real_name_regex.test(member.profile.real_name_normalized)||member._real_name_lc&&member._real_name_lc==query_lc}});if(team_matches.length===0){var from_regex=/from:@?(\S+)/gi;var from_match;var i;do{from_match=from_regex.exec(query_lc);if(from_match&&from_match.length>1){for(i=0;i<members.length;i++){if(!members[i].deleted&&members[i]._name_lc===from_match[1]){team_matches.push(members[i]);break}}}}while(from_match)}if(team_matches.length>0){$search_results_team.html(TS.templates.search_team_results({matches:team_matches}))}else{$search_results_team.empty()}},updateHistory:function(){var state={filter:TS.search.filter,query:TS.search.query,channel_id:null,member_id:null};if(TS.search.channel)state["channel_id"]=TS.search.channel.id;if(TS.search.group)state["group_id"]=TS.search.group.id;if(TS.search.member)state["member_id"]=TS.search.member.id;var url="/search/";url+=TS.search.filter;url+="?q="+encodeURIComponent(TS.search.query_string);if(TS.qs_args){for(var key in TS.qs_args){if(TS.qs_args.hasOwnProperty(key)){if(key!="q"){url+="&"+key+"="+TS.qs_args[key]}}}}if(url==window.location.pathname+window.location.search){window.history.replaceState(state,null,url)}else{window.history.pushState(state,null,url)}},onPopState:function(e){var state=e.state;if(!state)return;if(state.filter)TS.search.setFilter(state.filter);if(state.query)TS.search.query=state.query;if(state.channel_id){TS.search.channel=TS.channels.getChannelById(state.channel_id)}else{TS.search.channel=null}if(state.group_id){TS.search.group=TS.groups.getGroupById(state.group_id)}else{TS.search.group=null}if(state.member_id){TS.search.member=TS.members.getMemberById(state.member_id)}else{TS.search.member=null}TS.search.searchAll(TS.search.query)},messageSearchResultsFetched:function(results,args){TS.search.view.latest_msg_search_results=results;var now_ms=Date.now();var ms_since_last=now_ms-TS.search.view.added_to_history_last_ms;var replace_history_state=ms_since_last<5e3;TS.search.view.added_to_history_last_ms=now_ms;if(TS.client)TS.client.flexDisplaySwitched("search",args.query,replace_history_state)},search_interactions_logged:{},maybeLogSearchInteraction:function(type){var terms=TS.search.last_search_query;if(!terms)return;if(TS.search.view.search_interactions_logged[type+"__"+terms])return;TS.search.view.search_interactions_logged[type+"__"+terms]=true;TS.search.saveSearch({type:type,terms:terms})},messagesThemeChanged:function(){if(TS.model.ui_state.flex_name==="search"){TS.search.view.renderResults()}},msgHasExtracts:function(msg){if(msg.extracts&&msg.extracts.length>0)return true;var attachment;if(msg.attachments){for(var i=0;i<msg.attachments.length;i++){attachment=msg.attachments[i];if(attachment.extracts&&Object.keys(attachment.extracts).length>0)return true}}return false},resultHasExtracts:function(match){return TS.search.view.msgHasExtracts(match)||match.previous&&TS.search.view.msgHasExtracts(match.previous)||match.previous_2&&TS.search.view.msgHasExtracts(match.previous_2)||match.next&&TS.search.view.msgHasExtracts(match.next)||match.next_2&&TS.search.view.msgHasExtracts(match.next_2)},determineMessageResultType:function(messages,index){if(TS.search.view.msgHasExtracts(messages[index]))return"extract";if(index-1>=0){if(TS.search.view.msgHasExtracts(messages[index-1]))return"context"}if(index+1<messages.length){if(TS.search.view.msgHasExtracts(messages[index+1]))return"context"}return"extra"},getMatchForSearchResult:function($el){var $result=$el.closest(".search_message_result");if(!$result.length)return null;var c_id=$result.data("channel");var ts=$result.data("ts")+"";var match_with_index=TS.search.getMatchByQueryAndChannelAndTs(TS.search.view.latest_msg_search_results.query,c_id,ts);return match_with_index},firstResultWithExtracts:function(match){return _firstResultWithExtracts(match)},toggleExtractsForMatch:function(e,match_with_index){var $target=$(e.target);var match=match_with_index.match;var payload={click_target_type:match.extracts_expanded?"collapse":"expand",click_position:match_with_index.index,click_user_id:match.user,click_channel_id:match.channel.id,click_timestamp:match.ts};var $message=$target.closest("ts-message");if($message.length){payload["click_target_user_id"]=$message.data("memberId");payload["click_target_timestamp"]=$message.data("ts")+""}if(TS.search.last_request_id){payload["request_id"]=TS.search.last_request_id}TS.clog.track("SEARCH_CLICK",payload);if(match.extracts_expanded){_collapseExtractResults(match,$target.closest(".search_result_with_extract, .search_result_for_context, .search_result_for_extra_context"))}else{_expandExtractResults(match,$target.closest(".search_result_with_extract, .search_result_for_context, .search_result_for_extra_context"))}}});var _cached_msgs_scroll_position;var _cached_files_scroll_position;var _already_rendering=false;var _debouncedScrollEvents=function(){if(TS.model.ui_state.flex_name!=="search")return;TS.client.ui.checkInlineImgsAndIframes("search");if(TS.search.filter==="files"){_cached_files_scroll_position=$("#search_results").scrollTop()}else{_cached_msgs_scroll_position=$("#search_results").scrollTop()}};_debouncedScrollEvents=_.debounce(_debouncedScrollEvents,250);var _messageSearchFetched=function(results,args){_cached_msgs_scroll_position=null;if(args.page==1){TS.search.view.current_messages_page=1;TS.search.view.waiting_on_messages_page=-1;if(TS.search.filter=="messages"){TS.search.view.renderResults();TS.search.view.messageSearchResultsFetched(results,args);TS.search.view.searchMembers()}else{TS.search.view.updateOptions()}}else if(args.page==TS.search.view.waiting_on_messages_page){if(TS.search.filter=="messages"){TS.search.view.renderResults()}}};var _fileSearchFetched=function(results,args){_cached_files_scroll_position=null;if(args.page==1){TS.search.view.current_files_page=1;TS.search.view.waiting_on_files_page=-1;if(TS.search.filter=="files"){TS.search.view.renderResults();TS.search.view.messageSearchResultsFetched(results,args);TS.search.view.searchMembers()}else{TS.search.view.updateOptions()}}else if(args.page==TS.search.view.waiting_on_files_page){if(TS.search.filter=="files"){TS.search.view.renderResults()}}};var _searchSortChanged=function(){TS.search.searchAll();if(TS.search.sort==="timestamp"){$("#search_sort_timestamp").addClass("active");$("#search_sort_score").removeClass("active");$("#search_sort_model").removeClass("active")}else if(TS.search.sort==="model"&&TS.experiment.getGroup("search_ranking")==="model"){$("#search_sort_timestamp").removeClass("active");$("#search_sort_score").removeClass("active");$("#search_sort_model").addClass("active")}else{$("#search_sort_timestamp").removeClass("active");$("#search_sort_score").addClass("active");$("#search_sort_model").removeClass("active")}};var _initializeExtracts=function(results){if(!results.messages)return;var messages=[];results.messages.matches.forEach(function(match){messages.push(match);["previous_2","previous","next","next_2"].forEach(function(context){if(match[context]){match[context].channel=match.channel;match[context]._main=match;messages.push(match[context])}})});if(!TS.model.prefs.full_text_extracts){var all_unknowns={};messages.forEach(function(msg){if(TS.boot_data.page_needs_enterprise){var any_unknowns=TS.utility.msgs.allUnknownUsersInMessage(msg);if(any_unknowns.length){any_unknowns.forEach(function(id){if(!all_unknowns[id])all_unknowns[id]=msg})}}_buildSearchMessageExtracts(messages,msg,false)});if(_.keys(all_unknowns).length){TS.members.ensureMembersArePresent(_.keys(all_unknowns)).then(function(){_.keys(all_unknowns).forEach(function(id){var msg=all_unknowns[id];_buildSearchMessageExtracts(messages,msg,true)})})}}};var _buildSearchMessageExtracts=function(messages,msg,replacing_unknowns){if(_.isUndefined(replacing_unknowns))replacing_unknowns=false;var $match;var html;if(!TS.search.view.msgHasExtracts(msg))return;var selector="#search_results_items #"+TS.templates.makeMsgDomId(msg.ts);if(TS.boot_data.feature_message_replies){var main=msg._main||msg;selector="#"+TS.templates.makeMsgDomIdInSearch(msg.ts,main)}$match=$(selector);if($match.length===0)return;html=TS.templates.search_message_extracts({message:msg});if(replacing_unknowns){$match.find(".message_body.extract_content").replaceWith(html)}else{$match.find(".message_body").before(html)}};var _expandExtractResults=function(match,$clicked_msg){match.extracts_expanded=true;var $match=$("#search_results_items").find("#"+TS.templates.makeMSRDomId(match));_animateExtractsExpanding($match,$clicked_msg)};var _collapseExtractResults=function(match,$clicked_msg){match.extracts_expanded=false;var $match=$("#search_results_items").find("#"+TS.templates.makeMSRDomId(match));var reverse=true;_animateExtractsExpanding($match,$clicked_msg,reverse)};var _animateExtractsExpanding=function($match,$clicked_msg,reverse){TS.ui.utility.preventElementFromScrolling($clicked_msg,function(){$match.toggleClass("extracts_expanded",!reverse)})};var _fromNames=function(query){var from_regex=/from:@?(\S+)/gi;var bot_regex=/bot:?(\S+)/gi;var names=[];var from_match;var bot_match;do{from_match=from_regex.exec(query);if(from_match&&from_match.length>1){names.push(from_match[1])}}while(from_match);do{bot_match=bot_regex.exec(query);if(bot_match&&bot_match.length>1){names.push(bot_match[1])}}while(bot_match);return names};var _firstResultWithExtracts=function(match){var msgs=[match.previous_2,match.previous,match,match.next,match.next_2];var msg;for(var i=0;i<msgs.length;i++){msg=msgs[i];if(!msg)continue;if(msg.extracts&&msg.extracts.length)return msg}return match}})();(function(factory){if(typeof define==="function"&&define.amd){define(["jquery"],factory)}else if(typeof exports==="object"){factory(require("jquery"))}else{factory(jQuery)}})(function($){var browserType,textrange={get:function(property){return _textrange[browserType].get.apply(this,[property])},set:function(start,length){var s=parseInt(start),l=parseInt(length),e;if(typeof start==="undefined"){s=0}else if(start<0){s=this.val().length+s}if(typeof length==="undefined"){e=this.val().length}else if(length>=0){e=s+l}else{e=this.val().length+l}_textrange[browserType].set.apply(this,[s,e]);return this},setcursor:function(position){return this.textrange("set",position,0)},replace:function(text){_textrange[browserType].replace.apply(this,[String(text)]);return this},insert:function(text){return this.textrange("replace",text)}},_textrange={xul:{get:function(property){var props={position:this[0].selectionStart,start:this[0].selectionStart,end:this[0].selectionEnd,length:this[0].selectionEnd-this[0].selectionStart,text:this.val().substring(this[0].selectionStart,this[0].selectionEnd)};return typeof property==="undefined"?props:props[property]},set:function(start,end){this[0].selectionStart=start;this[0].selectionEnd=end},replace:function(text){var start=this[0].selectionStart;var end=this[0].selectionEnd;var val=this.val();this.val(val.substring(0,start)+text+val.substring(end,val.length));this[0].selectionStart=start;this[0].selectionEnd=start+text.length}},msie:{get:function(property){var range=document.selection.createRange();if(typeof range==="undefined"){return{position:0,start:0,end:this[0].val().length,length:this[0].val().length,text:this.val()}}var rangetext=this[0].createTextRange();var rangetextcopy=rangetext.duplicate();rangetext.moveToBookmark(range.getBookmark());rangetextcopy.setEndPoint("EndToStart",rangetext);var props={position:rangetextcopy.text.length,start:rangetextcopy.text.length,end:rangetextcopy.text.length+range.text.length,length:range.text.length,text:range.text};return typeof property==="undefined"?props:props[property]},set:function(start,end){var range=this[0].createTextRange();if(typeof range==="undefined"){return this}if(typeof start!=="undefined"){range.moveStart("character",start);range.collapse()}if(typeof end!=="undefined"){range.moveEnd("character",end-start)}range.select()},replace:function(text){document.selection.createRange().text=text}}};$.fn.textrange=function(method){if(typeof this[0]==="undefined"){return this}if(typeof browserType==="undefined"){browserType="selectionStart"in this[0]?"xul":document.selection?"msie":"unknown"}if(browserType==="unknown"){return this}if(document.activeElement!==this[0]){this[0].focus()}if(typeof method==="undefined"||typeof method!=="string"){return textrange.get.apply(this)}else if(typeof textrange[method]==="function"){return textrange[method].apply(this,Array.prototype.slice.call(arguments,1))}else{$.error("Method "+method+" does not exist in jQuery.textrange")}}});(function(d){function getMaxDays(){var tmpDate=new Date(this.toString()),d=28,m=tmpDate.getMonth();while(tmpDate.getMonth()==m){++d;tmpDate.setDate(d)}return d-1}d.addDays=function(n){this.setDate(this.getDate()+n)};d.addMonths=function(n){var day=this.getDate();this.setDate(1);this.setMonth(this.getMonth()+n);this.setDate(Math.min(day,getMaxDays.apply(this)))};d.addYears=function(n){var day=this.getDate();this.setDate(1);this.setFullYear(this.getFullYear()+n);this.setDate(Math.min(day,getMaxDays.apply(this)))};d.getDayOfYear=function(){var now=new Date(this.getFullYear(),this.getMonth(),this.getDate(),0,0,0);var then=new Date(this.getFullYear(),0,0,0,0,0);var time=now-then;return Math.floor(time/24*60*60*1e3)}})(Date.prototype);(function($){var instances_count=0;$.pickmeup=$.extend($.pickmeup||{},{date:new Date,flat:false,first_day:1,prev:"&#9664;",next:"&#9654;",mode:"single",select_year:true,select_month:true,select_day:true,view:"days",calendars:1,format:"d-m-Y",position:"bottom",trigger_event:"click touchstart",class_name:"",separator:" - ",hide_on_select:false,min:null,max:null,render:function(){},change:function(){return true},before_show:function(){return true},show:function(){return true},hide:function(){return true},fill:function(){return true},locale:{days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],daysShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sun"],daysMin:["Su","Mo","Tu","We","Th","Fr","Sa","Su"],months:["January","February","March","April","May","June","July","August","September","October","November","December"],monthsShort:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]}});var views={years:"pmu-view-years",months:"pmu-view-months",days:"pmu-view-days"},tpl={wrapper:'<div class="pickmeup" />',head:function(d){var result="";for(var i=0;i<7;++i){result+="<div>"+d.day[i]+"</div>"}return'<div class="pmu-instance">'+"<nav>"+'<div class="pmu-prev pmu-button">'+d.prev+"</div>"+'<div class="pmu-month pmu-button" />'+'<div class="pmu-next pmu-button">'+d.next+"</div>"+"</nav>"+'<nav class="pmu-day-of-week">'+result+"</nav>"+"</div>"},body:function(elements,container_class_name){var result="";for(var i=0;i<elements.length;++i){result+='<div class="'+elements[i].class_name+' pmu-button">';if(elements[i].class_name.indexOf("pmu-today")!=-1){result+='<span class="pmu-today-border">'+elements[i].text+"</span>"}else{result+=elements[i].text}result+="</div>"}return'<div class="'+container_class_name+'">'+result+"</div>"}};function fill(){var options=$(this).data("pickmeup-options"),pickmeup=this.pickmeup,current_cal=Math.floor(options.calendars/2),actual_date=options.date,current_date=options.current,local_date,header,html,instance,today=(new Date).setHours(0,0,0,0).valueOf(),shown_date_from,shown_date_to,tmp_date;pickmeup.find(".pmu-instance > :not(nav)").remove();for(var i=0;i<options.calendars;i++){local_date=new Date(current_date);instance=pickmeup.find(".pmu-instance").eq(i);if(pickmeup.hasClass("pmu-view-years")){local_date.addYears((i-current_cal)*12);header=local_date.getFullYear()-6+" - "+(local_date.getFullYear()+5)}else if(pickmeup.hasClass("pmu-view-months")){local_date.addYears(i-current_cal);header=local_date.getFullYear()}else if(pickmeup.hasClass("pmu-view-days")){local_date.addMonths(i-current_cal);header=formatDate(local_date,"B Y",options.locale)}if(!shown_date_to){if(options.max){tmp_date=new Date(local_date);if(options.select_day){tmp_date.addMonths(options.calendars-1)}else if(options.select_month){tmp_date.addYears(options.calendars-1)}else{tmp_date.addYears((options.calendars-1)*12)}if(tmp_date>options.max){--i;current_date.addMonths(-1);shown_date_to=undefined;continue}}}shown_date_to=new Date(local_date);if(!shown_date_from){shown_date_from=new Date(local_date);shown_date_from.setDate(1);shown_date_from.addMonths(1);shown_date_from.addDays(-1);if(options.min&&options.min>shown_date_from){--i;current_date.addMonths(1);shown_date_from=undefined;continue}}instance.find(".pmu-month").text(header);html="";var is_year_selected=function(year){return options.mode=="range"&&year>=new Date(actual_date[0]).getFullYear()&&year<=new Date(actual_date[1]).getFullYear()||options.mode=="multiple"&&actual_date.reduce(function(prev,current){prev.push(new Date(current).getFullYear());return prev},[]).indexOf(year)!==-1||new Date(actual_date).getFullYear()==year};var is_months_selected=function(year,month){var first_year=new Date(actual_date[0]).getFullYear(),lastyear=new Date(actual_date[1]).getFullYear(),first_month=new Date(actual_date[0]).getMonth(),last_month=new Date(actual_date[1]).getMonth();return options.mode=="range"&&year>first_year&&year<lastyear||options.mode=="range"&&year==first_year&&year<lastyear&&month>=first_month||options.mode=="range"&&year>first_year&&year==lastyear&&month<=last_month||options.mode=="range"&&year==first_year&&year==lastyear&&month>=first_month&&month<=last_month||options.mode=="multiple"&&actual_date.reduce(function(prev,current){current=new Date(current);prev.push(current.getFullYear()+"-"+current.getMonth());return prev},[]).indexOf(year+"-"+month)!==-1||new Date(actual_date).getFullYear()==year&&new Date(actual_date).getMonth()==month};(function(){var years=[],start_from_year=local_date.getFullYear()-6,min_year=new Date(options.min).getFullYear(),max_year=new Date(options.max).getFullYear(),year;for(var j=0;j<12;++j){year={text:start_from_year+j,class_name:[]};if(options.min&&year.text<min_year||options.max&&year.text>max_year){year.class_name.push("pmu-disabled")}else if(is_year_selected(year.text)){year.class_name.push("pmu-selected")}year.class_name=year.class_name.join(" ");years.push(year);
}html+=tpl.body(years,"pmu-years")})();(function(){var months=[],current_year=local_date.getFullYear(),min_year=new Date(options.min).getFullYear(),min_month=new Date(options.min).getMonth(),max_year=new Date(options.max).getFullYear(),max_month=new Date(options.max).getMonth(),month;for(var j=0;j<12;++j){month={text:options.locale.monthsShort[j],class_name:[]};if(options.min&&(current_year<min_year||j<min_month&&current_year==min_year)||options.max&&(current_year>max_year||j>max_month&&current_year>=max_year)){month.class_name.push("pmu-disabled")}else if(is_months_selected(current_year,j)){month.class_name.push("pmu-selected")}month.class_name=month.class_name.join(" ");months.push(month)}html+=tpl.body(months,"pmu-months")})();(function(){var days=[],current_month=local_date.getMonth(),day;(function(){local_date.setDate(1);var day=(local_date.getDay()-options.first_day)%7;local_date.addDays(-(day+(day<0?7:0)))})();for(var j=0;j<42;++j){day={text:local_date.getDate(),class_name:[]};if(current_month!=local_date.getMonth()){day.class_name.push("pmu-not-in-month")}if(local_date.getDay()==0){day.class_name.push("pmu-sunday")}else if(local_date.getDay()==6){day.class_name.push("pmu-saturday")}var from_user=options.render(local_date)||{},val=local_date.valueOf(),disabled=options.min&&options.min>local_date||options.max&&options.max<local_date;if(from_user.disabled||disabled){day.class_name.push("pmu-disabled")}else if(from_user.selected||options.date==val||$.inArray(val,options.date)!==-1||options.mode=="range"&&val>=options.date[0]&&val<=options.date[1]){day.class_name.push("pmu-selected")}if(val==today){day.class_name.push("pmu-today")}if(from_user.class_name){day.class_name.push(from_user.class_name)}day.class_name=day.class_name.join(" ");days.push(day);local_date.addDays(1)}html+=tpl.body(days,"pmu-days")})();instance.append(html)}shown_date_from.setDate(1);shown_date_to.setDate(1);shown_date_to.addMonths(1);shown_date_to.addDays(-1);pickmeup.find(".pmu-prev").css("visibility",options.min&&options.min>=shown_date_from?"hidden":"visible");pickmeup.find(".pmu-next").css("visibility",options.max&&options.max<=shown_date_to?"hidden":"visible");options.fill.apply(this)}function parseDate(date,format,separator,locale){if(date.constructor==Date){return date}else if(!date){return new Date}var splitted_date=date.split(separator);if(splitted_date.length>1){splitted_date.forEach(function(element,index,array){array[index]=parseDate($.trim(element),format,separator,locale)});return splitted_date}var months_text=locale.monthsShort.join(")(")+")("+locale.months.join(")("),separator=new RegExp("[^0-9a-zA-Z("+months_text+")]+"),parts=date.split(separator),against=format.split(separator),d,m,y,h,min,now=new Date;for(var i=0;i<parts.length;i++){switch(against[i]){case"b":m=locale.monthsShort.indexOf(parts[i]);break;case"B":m=locale.months.indexOf(parts[i]);break;case"d":case"e":d=parseInt(parts[i],10);break;case"m":m=parseInt(parts[i],10)-1;break;case"Y":case"y":y=parseInt(parts[i],10);y+=y>100?0:y<29?2e3:1900;break;case"H":case"I":case"k":case"l":h=parseInt(parts[i],10);break;case"P":case"p":if(/pm/i.test(parts[i])&&h<12){h+=12}else if(/am/i.test(parts[i])&&h>=12){h-=12}break;case"M":min=parseInt(parts[i],10);break}}var parsed_date=new Date(y===undefined?now.getFullYear():y,m===undefined?now.getMonth():m,d===undefined?now.getDate():d,h===undefined?now.getHours():h,min===undefined?now.getMinutes():min,0);if(isNaN(parsed_date*1)){parsed_date=new Date}return parsed_date}function formatDate(date,format,locale){var m=date.getMonth();var d=date.getDate();var y=date.getFullYear();var w=date.getDay();var s={};var hr=date.getHours();var pm=hr>=12;var ir=pm?hr-12:hr;var dy=date.getDayOfYear();if(ir==0){ir=12}var min=date.getMinutes();var sec=date.getSeconds();var parts=format.split(""),part;for(var i=0;i<parts.length;i++){part=parts[i];switch(part){case"a":part=locale.daysShort[w];break;case"A":part=locale.days[w];break;case"b":part=locale.monthsShort[m];break;case"B":part=locale.months[m];break;case"C":part=1+Math.floor(y/100);break;case"d":part=d<10?"0"+d:d;break;case"e":part=d;break;case"H":part=hr<10?"0"+hr:hr;break;case"I":part=ir<10?"0"+ir:ir;break;case"j":part=dy<100?dy<10?"00"+dy:"0"+dy:dy;break;case"k":part=hr;break;case"l":part=ir;break;case"m":part=m<9?"0"+(1+m):1+m;break;case"M":part=min<10?"0"+min:min;break;case"p":case"P":part=pm?"PM":"AM";break;case"s":part=Math.floor(date.getTime()/1e3);break;case"S":part=sec<10?"0"+sec:sec;break;case"u":part=w+1;break;case"w":part=w;break;case"y":part=(""+y).substr(2,2);break;case"Y":part=y;break}parts[i]=part}return parts.join("")}function update_date(){var $this=$(this),options=$this.data("pickmeup-options"),current_date=options.current,new_value;switch(options.mode){case"multiple":new_value=current_date.setHours(0,0,0,0).valueOf();if($.inArray(new_value,options.date)!==-1){$.each(options.date,function(index,value){if(value==new_value){options.date.splice(index,1);return false}return true})}else{options.date.push(new_value)}break;case"range":if(!options.lastSel){options.date[0]=current_date.setHours(0,0,0,0).valueOf()}new_value=current_date.setHours(0,0,0,0).valueOf();if(new_value<=options.date[0]){options.date[1]=options.date[0];options.date[0]=new_value}else{options.date[1]=new_value}options.lastSel=!options.lastSel;break;default:options.date=current_date.valueOf();break}var prepared_date=prepareDate(options);if($this.is("input")){$this.val(options.mode=="single"?prepared_date[0]:prepared_date[0].join(options.separator))}options.change.apply(this,prepared_date);if(options.hide_on_select&&(options.mode!="range"||!options.lastSel)){options.binded.hide();return false}}function click(e){var el=$(e.target);if(!el.hasClass("pmu-button")){el=el.closest(".pmu-button")}if(el.length){if(el.hasClass("pmu-disabled")){return false}var $this=$(this),options=$this.data("pickmeup-options"),instance=el.parents(".pmu-instance").eq(0),root=instance.parent(),instance_index=$(".pmu-instance",root).index(instance);if(el.parent().is("nav")){if(el.hasClass("pmu-month")){options.current.addMonths(instance_index-Math.floor(options.calendars/2));if(root.hasClass("pmu-view-years")){if(options.mode!="single"){options.current=new Date(options.date[options.date.length-1])}else{options.current=new Date(options.date)}if(options.select_day){root.removeClass("pmu-view-years").addClass("pmu-view-days")}else if(options.select_month){root.removeClass("pmu-view-years").addClass("pmu-view-months")}}else if(root.hasClass("pmu-view-months")){if(options.select_year){root.removeClass("pmu-view-months").addClass("pmu-view-years")}else if(options.select_day){root.removeClass("pmu-view-months").addClass("pmu-view-days")}}else if(root.hasClass("pmu-view-days")){if(options.select_month){root.removeClass("pmu-view-days").addClass("pmu-view-months")}else if(options.select_year){root.removeClass("pmu-view-days").addClass("pmu-view-years")}}}else{if(el.hasClass("pmu-prev")){options.binded.prev(false)}else{options.binded.next(false)}}}else if(!el.hasClass("pmu-disabled")){if(root.hasClass("pmu-view-years")){options.current.setFullYear(parseInt(el.text(),10));if(options.select_month){root.removeClass("pmu-view-years").addClass("pmu-view-months")}else if(options.select_day){root.removeClass("pmu-view-years").addClass("pmu-view-days")}else{options.binded.update_date()}}else if(root.hasClass("pmu-view-months")){options.current.setMonth(instance.find(".pmu-months .pmu-button").index(el));options.current.setFullYear(parseInt(instance.find(".pmu-month").text(),10));if(options.select_day){root.removeClass("pmu-view-months").addClass("pmu-view-days")}else{options.binded.update_date()}options.current.addMonths(Math.floor(options.calendars/2)-instance_index)}else{var val=parseInt(el.text(),10);options.current.addMonths(instance_index-Math.floor(options.calendars/2));if(el.hasClass("pmu-not-in-month")){options.current.addMonths(val>15?-1:1)}options.current.setDate(val);options.binded.update_date()}}options.binded.fill()}return false}function prepareDate(options){var result;if(options.mode=="single"){result=new Date(options.date);return[formatDate(result,options.format,options.locale),result]}else{result=[[],[]];$.each(options.date,function(nr,val){var date=new Date(val);result[0].push(formatDate(date,options.format,options.locale));result[1].push(date)});return result}}function show(force){var pickmeup=this.pickmeup;if(force||!pickmeup.is(":visible")){var $this=$(this),options=$this.data("pickmeup-options"),pos=$this.offset(),viewport={l:document.documentElement.scrollLeft,t:document.documentElement.scrollTop,w:document.documentElement.clientWidth,h:document.documentElement.clientHeight},top=pos.top,left=pos.left;options.binded.fill();if($this.is("input")){$this.pickmeup("set_date",parseDate($this.val(),options.format,options.separator,options.locale)).keydown(function(e){if(e.which==9){$this.pickmeup("hide")}})}options.before_show();switch(options.position){case"top":top-=pickmeup.outerHeight();break;case"left":left-=pickmeup.outerWidth();break;case"right":left+=this.offsetWidth;break;case"bottom":top+=this.offsetHeight;break}if(top+pickmeup.offsetHeight>viewport.t+viewport.h){top=pos.top-pickmeup.offsetHeight}if(top<viewport.t){top=pos.top+this.offsetHeight+pickmeup.offsetHeight}if(left+pickmeup.offsetWidth>viewport.l+viewport.w){left=pos.left-pickmeup.offsetWidth}if(left<viewport.l){left=pos.left+this.offsetWidth}if(options.show()==false){return}pickmeup.css({display:"inline-block",top:top+"px",left:left+"px"});$(document).on("mousedown"+options.events_namespace,options.binded.hide).on("resize"+options.events_namespace,[true],options.binded.forced_show)}}function forced_show(){show.call(this,true)}function hide(e){if(!e||!e.target||e.target!=this&&!(this.pickmeup.get(0).compareDocumentPosition(e.target)&16)){var pickmeup=this.pickmeup,options=$(this).data("pickmeup-options");if(options.hide()!=false){pickmeup.hide();$(document).off("mousedown",options.binded.hide).off("resize",options.binded.forced_show);options.date[1]=options.date[0];options.lastSel=false}}}function update(){var options=$(this).data("pickmeup-options");$(document).off("mousedown",options.binded.hide).off("resize",options.binded.forced_show);options.binded.forced_show()}function clear(){var options=$(this).data("pickmeup-options");if(options.mode!="single"){options.date=[];options.lastSel=false;options.binded.fill()}}function prev(fill){if(typeof fill=="undefined"){fill=true}var root=this.pickmeup;var options=$(this).data("pickmeup-options");if(root.hasClass("pmu-view-years")){options.current.addYears(-12)}else if(root.hasClass("pmu-view-months")){options.current.addYears(-1)}else if(root.hasClass("pmu-view-days")){options.current.addMonths(-1)}if(fill){options.binded.fill()}}function next(fill){if(typeof fill=="undefined"){fill=true}var root=this.pickmeup;var options=$(this).data("pickmeup-options");if(root.hasClass("pmu-view-years")){options.current.addYears(12)}else if(root.hasClass("pmu-view-months")){options.current.addYears(1)}else if(root.hasClass("pmu-view-days")){options.current.addMonths(1)}if(fill){options.binded.fill()}}function get_date(formatted){var options=$(this).data("pickmeup-options"),prepared_date=prepareDate(options);if(typeof formatted==="string"){var date=prepared_date[1];if(date.constructor==Date){return formatDate(date,formatted,options.locale)}else{return date.map(function(value){return formatDate(value,formatted,options.locale)})}}else{return prepared_date[formatted?0:1]}}function set_date(date){var options=$(this).data("pickmeup-options");options.date=date;if(typeof options.date==="string"){options.date=parseDate(options.date,options.format,options.separator,options.locale).setHours(0,0,0,0)}else if(options.date.constructor==Date){options.date.setHours(0,0,0,0)}if(!options.date){options.date=new Date;options.date.setHours(0,0,0,0)}if(options.mode!="single"){if(options.date.constructor!=Array){options.date=[options.date.valueOf()];if(options.mode=="range"){options.date.push(new Date(options.date[0]).setHours(0,0,0,0).valueOf())}}else{for(var i=0;i<options.date.length;i++){options.date[i]=parseDate(options.date[i],options.format,options.separator,options.locale).setHours(0,0,0,0).valueOf()}if(options.mode=="range"){options.date[1]=new Date(options.date[1]).setHours(0,0,0,0).valueOf()}}}else{options.date=options.date.constructor==Array?options.date[0].valueOf():options.date.valueOf()}options.current=new Date(options.mode!="single"?options.date[0]:options.date);options.binded.fill()}function destroy(){var $this=$(this),options=$this.data("pickmeup-options");$this.removeData("pickmeup-options");$this.off(options.events_namespace);$(document).off(options.events_namespace);$(this.pickmeup).remove()}$.fn.pickmeup=function(initial_options){if(typeof initial_options==="string"){var data,parameters=Array.prototype.slice.call(arguments,1);switch(initial_options){case"hide":case"show":case"clear":case"update":case"prev":case"next":case"destroy":this.each(function(){data=$(this).data("pickmeup-options");if(data){data.binded[initial_options]()}});break;case"get_date":data=this.data("pickmeup-options");if(data){return data.binded.get_date(parameters[0])}else{return null}break;case"set_date":this.each(function(){data=$(this).data("pickmeup-options");if(data){data.binded[initial_options].apply(this,parameters)}})}return this}return this.each(function(){var $this=$(this);if($this.data("pickmeup-options")){return}var i,option,options=$.extend({},$.pickmeup,initial_options||{});for(i in options){option=$this.data("pmu-"+i);if(typeof option!=="undefined"){options[i]=option}}if(options.view=="days"&&!options.select_day){options.view="months"}if(options.view=="months"&&!options.select_month){options.view="years"}if(options.view=="years"&&!options.select_year){options.view="days"}if(options.view=="days"&&!options.select_day){options.view="months"}options.calendars=Math.max(1,parseInt(options.calendars,10)||1);options.mode=/single|multiple|range/.test(options.mode)?options.mode:"single";if(typeof options.min==="string"){options.min=parseDate(options.min,options.format,options.separator,options.locale).setHours(0,0,0,0)}else if(options.min&&options.min.constructor==Date){options.min.setHours(0,0,0,0)}if(typeof options.max==="string"){options.max=parseDate(options.max,options.format,options.separator,options.locale).setHours(0,0,0,0)}else if(options.max&&options.max.constructor==Date){options.max.setHours(0,0,0,0)}if(!options.select_day){if(options.min){options.min=new Date(options.min);options.min.setDate(1);options.min=options.min.valueOf()}if(options.max){options.max=new Date(options.max);options.max.setDate(1);options.max=options.max.valueOf()}}if(typeof options.date==="string"){options.date=parseDate(options.date,options.format,options.separator,options.locale).setHours(0,0,0,0)}else if(options.date.constructor==Date){options.date.setHours(0,0,0,0)}if(!options.date){options.date=new Date;options.date.setHours(0,0,0,0)}if(options.mode!="single"){if(options.date.constructor!=Array){options.date=[options.date.valueOf()];if(options.mode=="range"){options.date.push(new Date(options.date[0]).setHours(0,0,0,0).valueOf())}}else{for(i=0;i<options.date.length;i++){options.date[i]=parseDate(options.date[i],options.format,options.separator,options.locale).setHours(0,0,0,0).valueOf()}if(options.mode=="range"){options.date[1]=new Date(options.date[1]).setHours(0,0,0,0).valueOf()}}options.current=new Date(options.date[0]);if(!options.select_day){for(i=0;i<options.date.length;++i){options.date[i]=new Date(options.date[i]);options.date[i].setDate(1);options.date[i]=options.date[i].valueOf();if(options.mode!="range"&&options.date.indexOf(options.date[i])!==i){delete options.date.splice(i,1);--i}}}}else{options.date=options.date.valueOf();options.current=new Date(options.date);if(!options.select_day){options.date=new Date(options.date);options.date.setDate(1);options.date=options.date.valueOf()}}options.current.setDate(1);options.current.setHours(0,0,0,0);var cnt,pickmeup=$(tpl.wrapper);this.pickmeup=pickmeup;if(options.class_name){pickmeup.addClass(options.class_name)}var html="";for(i=0;i<options.calendars;i++){cnt=options.first_day;html+=tpl.head({prev:options.prev,next:options.next,day:[options.locale.daysMin[cnt++%7],options.locale.daysMin[cnt++%7],options.locale.daysMin[cnt++%7],options.locale.daysMin[cnt++%7],options.locale.daysMin[cnt++%7],options.locale.daysMin[cnt++%7],options.locale.daysMin[cnt++%7]]})}$this.data("pickmeup-options",options);for(i in options){if(["render","change","before_show","show","hide"].indexOf(i)!=-1){options[i]=options[i].bind(this)}}options.binded={fill:fill.bind(this),update_date:update_date.bind(this),click:click.bind(this),show:show.bind(this),forced_show:forced_show.bind(this),hide:hide.bind(this),update:update.bind(this),clear:clear.bind(this),prev:prev.bind(this),next:next.bind(this),get_date:get_date.bind(this),set_date:set_date.bind(this),destroy:destroy.bind(this)};options.events_namespace=".pickmeup-"+ ++instances_count;pickmeup.on("click touchstart",options.binded.click).addClass(views[options.view]).append(html).on($.support.selectstart?"selectstart":"mousedown",function(e){e.preventDefault()});options.binded.fill();if(options.flat){pickmeup.appendTo(this).css({position:"relative",display:"inline-block"})}else{pickmeup.appendTo(document.body);var trigger_event=options.trigger_event.split(" ");for(i=0;i<trigger_event.length;++i){trigger_event[i]+=options.events_namespace}trigger_event=trigger_event.join(" ");$this.on(trigger_event,options.binded.show)}})}})(jQuery);(function($){"use strict";var UNDERLAY_CLASS="underlay";var might_be_modifier_regex=/^[^:]+:([^:+]+)?$/i;var is_webkit=/webkit/i.test(navigator.userAgent);$.widget("TS.highlighter",{options:{placeholder_class:"ghost_text",global_modifier_highlight_class:"modifier",global_modifier_incomplete_highlight_class:"incomplete",global_keyword_highlightClass:"keyword",modifiers:[]},_ghost_text:"",_ghost_prev_char:"",_$ghost_text:null,_ghost_text_changed_sig:null,_create:function(){if(!this.element.is('input[type="text"]')){throw this.widgetName+": Element is not a text input."}this._renderUI();this._on({keydown:this._onInputKey,keyup:this._onInputKey,change:this._onInputChange,scroll:this._onScroll,focus:this._onFocus,blur:this._onBlur,mouseenter:this._onMouseEnter,mouseleave:this._onMouseLeave});if(_has_scroll_left_bug===null){_testHasScrollLeftBug(this.element.parent())}this._$ghost_text=$("<span>").addClass(this.options.placeholder_class);this._ghost_text_changed_sig=new signals.Signal;this._ghost_text_changed_sig.add(this._onNewGhostText,this);if(this.element.val().trim()){this._updateUnderlay()}},_destroy:function(){_cancelRAF(this._scroll_raf);$(window).unbind("resize.highlighter_resize");TS.client.flexpane_display_switched_sig.remove(this._updateSizing);this.element.off(".highlighter_transition")},_renderUI:function(){var widget_prefix=this.widgetName+"_";var wrapper_class=widget_prefix+"wrapper";var wrapper_selector="."+wrapper_class;var wrapper=$('<div class="'+wrapper_class+'"/>');this._$underlay=$('<div class="'+widget_prefix+UNDERLAY_CLASS+'"/>');this.element.wrap(wrapper);this._$wrapper=this.element.closest(wrapper_selector);this._$wrapper.append(this._$underlay);this.element.addClass("search_input_highlighted");this._updateSizing();$(window).bind("resize.highlighter_resize",TS.utility.debounce($.proxy(this._updateSizing,this),500));TS.client.flexpane_display_switched_sig.add(this._updateSizing,this);var self=this;this._$underlay.closest(".flex_header").on("transitionend.highlighter_transition webkitTransitionEnd.highlighter_transition MozTransitionEnd.highlighter_transition",function(e){self._updateSizing()})},_onInputKey:function(){this.element.trigger("change")},_onInputChange:function(){_rAF($.proxy(this._updateUnderlay,this))},_onScroll:function(){_rAF($.proxy(function(){this._$underlay.scrollLeft(this.element.scrollLeft())},this))},_onFocus:function(){this._has_focus=true;this._updateSizing();if(is_webkit){this._syncScrollLeft()}},_onBlur:function(){this._has_focus=false;this._updateSizing()},_onMouseEnter:function(){this._mouse_over=true;if(is_webkit){this._syncScrollLeft()}},_onMouseLeave:function(){this._mouse_over=false},_replaceAll:function(txt,regex,newStr){if(regex instanceof RegExp){return txt.replace(regex,newStr)}return txt.replace(new RegExp(regex,"gi"),newStr)},highlightStr:function(str,allow_breaks){var words=str.split(" ");words.forEach(function(word,index){if(this._mightBeModifier(word)){var colon_index=word.indexOf(":");var possible_modifier=word.slice(0,colon_index+1);var keyword=word.slice(colon_index+1);var new_word;this.options.modifiers.some(function(modifierDetails){var real_modifier=modifierDetails.modifier;var modifier_span;var keyword_span;if(possible_modifier.toLowerCase()===real_modifier){var mod_class=this.options.global_modifier_highlight_class;var incomplete_class=this.options.global_modifier_incomplete_highlight_class;if(modifierDetails.modifierHighlightClass){mod_class=mod_class+" "+modifierDetails.modifierHighlightClass}new_word="";if(allow_breaks)new_word+='<wbr/><span class="no_wrap">';if(keyword){modifierDetails.keyword_testers.some(function(format_tester){if(format_tester(keyword)){var keywordClass=this.options.global_keyword_highlightClass;if(modifierDetails.keyword_highlight_class){keywordClass=keywordClass+" "+modifierDetails.keyword_highlight_class}keyword_span='<span class="'+keywordClass+'">'+_htmlEntities(keyword)+"</span>";return true}return false},this)}if(keyword_span){modifier_span='<span class="'+mod_class+'">'+_htmlEntities(possible_modifier)+"</span>"}else{modifier_span='<span class="'+mod_class+" "+incomplete_class+'">'+_htmlEntities(possible_modifier)+"</span>"}new_word+=modifier_span;if(keyword_span){new_word+=keyword_span}else{new_word+=_htmlEntities(keyword)}if(allow_breaks)new_word+="</span>";words[index]=new_word;return true}else{words[index]=_htmlEntities(word);return false}},this)}else{words[index]=_htmlEntities(word)}},this);return words.join(" ")},_updateUnderlay:function(){var val=this.element.val();var newTxt;if(this._prevVal===val)return;newTxt=this.highlightStr(val);newTxt=this._replaceAll(newTxt,"\n","<br/>");newTxt=this._replaceAll(newTxt,"  ","  ");this._$underlay.html(newTxt);if(this._ghost_text){if(this._prevVal&&val.length>this._prevVal.length&&val.charAt(val.length-1)===this._ghost_text.charAt(0)){this.setGhostText(this._ghost_text.substring(1))}else if(this._prevVal&&this._ghost_prev_char&&val.length&&val.length===this._prevVal.length-1&&this._ghost_prev_char===this._prevVal.charAt(this._prevVal.length-1)){this.setGhostText(this._ghost_prev_char+this._ghost_text)}else{this.setGhostText("")}}this._$ghost_text.appendTo(this._$underlay);this._prevVal=val;if(_has_scroll_left_bug||TS.model.is_safari_desktop){this._$underlay.scrollLeft(1e4);var underlay_scroll_left=this._$underlay.scrollLeft();if(underlay_scroll_left!==0){this._$underlay.scrollLeft(0);this._$underlay.addClass("hide_highlights")}else{this._$underlay.removeClass("hide_highlights")}}},_mightBeModifier:function(str){return might_be_modifier_regex.test(str)},_syncScrollLeft:function(){var sync=$.proxy(function(){var dprWithZoom=window.devicePixelRatio;var dprWithoutZoom=Math.floor(dprWithZoom)>1?2:1;var zoomLevel=dprWithZoom/dprWithoutZoom;var left=this.element.scrollLeft()*zoomLevel;if(left!==this._prev_left){this._$underlay.scrollLeft(left);this._prev_left=this._$underlay.scrollLeft()}if(this._has_focus||this._mouse_over){this._scroll_raf=_rAF(sync)}},this);_cancelRAF(this._scroll_raf);this._prev_left=null;this._scroll_raf=_rAF(sync)},_updateSizing:function(e){var width=this.element.parent().outerWidth();this._$underlay.width(width);this._$underlay.css("margin-left","-"+width+"px")},_onNewGhostText:function(){if(this._ghost_text){this._$ghost_text.text(this._ghost_text)}else{this._$ghost_text.html("&nbsp;&nbsp;")}},setGhostText:function(text,prev_char){this._ghost_text=text;this._ghost_prev_char=prev_char;this._ghost_text_changed_sig.dispatch(text)}});var _has_scroll_left_bug=null;var _rAF=function(){var vendors=["ms","moz","webkit","o"];var requestAnimationFrame=window.requestAnimationFrame;var x;for(x=0;x<vendors.length&&!requestAnimationFrame;x++){requestAnimationFrame=window[vendors[x]+"RequestAnimationFrame"]}if(!requestAnimationFrame){var last_time=0;return function(callback){var curr_time=Date.now();var time_to_call=Math.max(0,16-(curr_time-last_time));var id=window.setTimeout(function(){callback(curr_time+time_to_call)},time_to_call);last_time=curr_time+time_to_call;return id}}return function(fn){return requestAnimationFrame.call(window,fn)}}();var _cancelRAF=function(){var vendors=["ms","moz","webkit","o"];var cancelAnimationFrame=window.cancelAnimationFrame;var x;for(x=0;x<vendors.length&&!cancelAnimationFrame;x++){cancelAnimationFrame=window[vendors[x]+"CancelAnimationFrame"]||window[vendors[x]+"CancelRequestAnimationFrame"]}if(!cancelAnimationFrame){return function(id){clearTimeout(id)}}return function(id){cancelAnimationFrame.call(window,id)}}();var _htmlEntities=function(str){if(!str)return"";return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")};var _testHasScrollLeftBug=function(append_to){if(/webkit/i.test(navigator.userAgent))return;if(/msie/i.test(navigator.userAgent))return;var ff_ver=/Firefox\/(\d+)\b/.exec(navigator.userAgent);if(ff_ver&&ff_ver.length===2){if(parseInt(ff_ver[1],10)>=31)return}var $input=$('<input type="text">');$input.val("MMMMMMMMMMMMMMMMMMMMMMMMMM");$input.css({position:"absolute",top:"0",right:"9999px"});$input.width(50);$input.appendTo(append_to);$input.focus().setCursorPosition(1e4);setTimeout(function(){$input.focus().setCursorPosition(1e4);_has_scroll_left_bug=$input.scrollLeft()===0;$input.remove()},500)}})(jQuery);(function($){"use strict";var MENU_TYPES={history:"history",modifier:"modifier",user:"user",group:"group",channel:"channel",conversation:"conversation",time_range:"time-range",date:"date",has:"has"};var SECTION_RESULT_LIMIT=5;var USER_RESULT_LIMIT=SECTION_RESULT_LIMIT;var CHANNEL_RESULT_LIMIT=SECTION_RESULT_LIMIT;var GROUP_RESULT_LIMIT=SECTION_RESULT_LIMIT;var HISTORY_RESULT_LIMIT=SECTION_RESULT_LIMIT;var PROFILE_RESULT_LIMIT=SECTION_RESULT_LIMIT;var LIMIT_DEFAULT=100;var REPLACEMENT_ATTR="data-replacement";var MATCHING_KEYWORD_ATTR="data-matching-keyword";var SELECTED_CLASS=null;var MODIFIERS_LIST_CLASS="modifiers";var HISTORY_LIST_CLASS="history";var PROFILE_LIST_CLASS="profiles";var ITEM_WRAPPER_SEL="li";var ITEM_GROUP_WRAPPER_SEL="ol";var CALENDAR_CLASS="autocomplete_calendar";var CALENDAR_VISIBLE_CLASS="calendar_visible";var CALENDAR_FORMAT="Y-m-d";var DEFAULT_CONVERSATION_MODIFIER="in:";var DEFAULT_MENU_HEIGHT=534;var has_token_regex=/\{(.+)\}/i;var might_be_modifier_regex=/^[^:]+:([^:]+)?$/i;$.widget("TS.autocomplete",{options:{hidden_class:"hidden",selected_class:"selected",append_to:"body",disabled:false,data:null},_$popover:null,_$menu:null,_$menu_items:null,_$calendar:null,_$ac_menu:null,_$scrollable:null,_menu_index:null,_calendar_modifier:"",_render_data:{},_last_query:null,_recalc_height:true,_open_menu_on_focus:true,_hide_timer:null,_mouse_in_menu:false,_input_has_focus:false,_block_menu:false,_caret_position:null,_current_history_query:null,_current_history_items:[],_create:function(){if(!this.element.is('input[type="text"]')){throw this.widgetName+": Element is not a text input."}this.options.selected_class="highlighted";SELECTED_CLASS=this.options.selected_class;this._renderUI();this._on(this.element,{keydown:this._onTextInputKeydown,keyup:this._onTextInputKeyup,mousedown:this._onTextInputMouseDown,mouseup:this._onTextInputMouseUp,focus:this._onTextInputFocus,blur:this._onTextInputBlur,cut:this._onTextInputKeyup,paste:this._onTextInputKeyup});this._on(this._$menu,{"click li":this._onMenuClick,"click .delete_history_item_target_area":this._onClickDeleteHistoryItem,"click .footer_tip_action":this._onClickFooterTipAction,mouseenter:this._onMouseEnter,mouseleave:this._onMouseLeave,mousedown:this._onMouseDownMenu});this.options.data=this.options.data||window.DATA;$(window).bind("resize.recalc_autocomplete_height",$.proxy(function(){this._recalc_height=true},this))},_destroy:function(){$(window).unbind("resize.recalc_autocomplete_height")},_show:function(){this._$popover.removeClass(this.options.hidden_class);if(this._recalc_height){this._recalc_height=false;var window_height=$(window).height();var menu_top=this._$menu.offset().top;var available_space=window_height-menu_top-25;var max_height=Math.min(available_space,DEFAULT_MENU_HEIGHT);this._$menu.css("max-height",max_height)}$(window).unbind("mousedown.close_autocomplete").bind("mousedown.close_autocomplete",$.proxy(this._onMouseDownOutsideAutocomplete,this));TS.ui.utility.updateClosestMonkeyScroller(this._$scrollable)},show:function(){this._show()},_hide:function(){$(ITEM_WRAPPER_SEL,this._$menu).removeClass(this.options.selected_class);this._$popover.addClass(this.options.hidden_class);this._mouse_in_menu=false;this._resetMenuIndex();this._clearGhostText();$(window).unbind("mousedown.close_autocomplete");TS.kb_nav.end()},hide:function(){this._hide()},_requestHide:function(){this._cancelHide();this._hide_timer=setTimeout($.proxy(this._hide,this),0)},_cancelHide:function(){clearTimeout(this._hide_timer)},_resetMenuIndex:function(){this._menu_index=null},_renderUI:function(){this._$popover=$("<div/>").addClass("popover_menu popover_search_menu").attr("id","search_autocomplete_popover");this._$popover.append('<span class="arrow"></span><span class="arrow_shadow"></span>');if(this._$menu){this._$menu.empty()}this._$ac_menu=$('<div id="autocomplete_menu" class="content"/>').appendTo(this._$popover);this._$scrollable=$('<div class="autocomplete_menu_scrollable"/>').appendTo(this._$ac_menu);this._$menu=$("<div/>").appendTo(this._$scrollable);this._initCalendar();this._hide();this._$scrollable.append(this._$menu);$(this.options.append_to).append(this._$popover);if(!TS.environment.supports_custom_scrollbar){this._$scrollable.monkeyScroll()}this._$ac_menu.addClass("search_menu")},_syncUI:function(){TS.kb_nav.end();if(this._render_data.header){this._$popover.addClass("showing_header")}else{this._$popover.removeClass("showing_header")}this._render_data.conversations_html=new Handlebars.SafeString(this._conversationsHTML());this._$menu.html(TS.templates.search_menu(this._render_data));this._$menu_items=$(ITEM_WRAPPER_SEL,this._$menu);if(this._render_data.show_calendar){this._$calendar.removeClass(this.options.hidden_class);this._$ac_menu.addClass(CALENDAR_VISIBLE_CLASS);this._$calendar.find(".pmu-selected").removeClass("pmu-selected")}else{this._$calendar.addClass(this.options.hidden_class);this._$ac_menu.removeClass(CALENDAR_VISIBLE_CLASS)}if(this._render_data.footer&&this._render_data.footer.tips){this._$popover.attr("data-qa","search_modifier_tips")}else{this._$popover.removeAttr("data-qa")}this._resetMenuIndex();this._updateGhostText();this._$scrollable.data("disable-scroll",!!this._render_data.show_calendar);TS.ui.utility.updateClosestMonkeyScroller(this._$scrollable);TS.kb_nav.start(this._$menu.find(".results"),"li",".search_menu");TS.kb_nav.setAllowHighlightWithoutBlurringInput(true)},_conversationsHTML:function(){this._combineChannelsAndGroups();var data=this._render_data;data.group_label="private channel";var channels_html,dms_html,groups_html;channels_html=TS.templates.search_menu_channels(data);dms_html=TS.templates.search_menu_dms(data);groups_html=TS.templates.search_menu_groups(data);var regular_matches=[];var archived_matches=[];if(data.channels&&data.channels.length){regular_matches.push(channels_html)}else{archived_matches.push(channels_html)}if(data.dms&&data.dms.length){regular_matches.push(dms_html)}else{archived_matches.push(dms_html);
}if(data.groups&&data.groups.length){regular_matches.push(groups_html)}else{archived_matches.push(groups_html)}return regular_matches.join("")+archived_matches.join("")},_combineChannelsAndGroups:function(){var all_channels=[];if($.isArray(this._render_data.channels)){all_channels=this._render_data.channels}if($.isArray(this._render_data.groups)){all_channels=all_channels.concat(this._render_data.groups)}var all_archived=[];if($.isArray(this._render_data.channels_archived)){all_archived=this._render_data.channels_archived}if($.isArray(this._render_data.groups_archived)){all_archived=all_archived.concat(this._render_data.groups_archived)}all_channels.sort(_cOrGSorter);all_archived.sort(_cOrGSorter);this._render_data.channels=all_channels;this._render_data.channels_archived=all_archived;if(all_archived.length>0&&all_channels.length===0)this._render_data.channels=true;delete this._render_data.groups;delete this._render_data.groups_archived},_initCalendar:function(){if(this._$calendar)this._$calendar.pickmeup("destroy").remove();this._$calendar=$("<div/>").addClass(CALENDAR_CLASS).addClass(this.options.hidden_class).prependTo(this._$ac_menu);this._$calendar.pickmeup({flat:true,first_day:0,format:CALENDAR_FORMAT,change:$.proxy(this._onCalendarChange,this),max:Date.now()})},_setCalendarModifier:function(modifier){this._calendar_modifier=modifier},_onTextInputMouseDown:function(e){if(this._input_has_focus){if(this._hideMenuIfTextSelected())return;setTimeout($.proxy(function(){this._saveCaretPosition();this._showAutocompleteSuggestions()},this),0)}},_onTextInputMouseUp:function(){this._saveCaretPosition();this._hideMenuIfTextSelected()},_onMenuClick:function(e){var $clicked_item=$(e.target).closest(ITEM_WRAPPER_SEL);if(!$clicked_item.length){return this._hide()}var replacement=$clicked_item.attr(REPLACEMENT_ATTR);if(this._isProfileItemElement($clicked_item)){this._handleProfileItem($clicked_item);return}if(this._isRevealHiddenElement($clicked_item)){this._revealHiddenItems($clicked_item);return}if(this._shouldAppendSpaceToItem($clicked_item)){replacement+=" "}this._open_menu_on_focus=false;if(this._isHistoryItemElement($clicked_item)){this._replaceEntireInput(replacement)}else{this._replaceCurrentWord(replacement)}this._cancelDelayedSearch();if(this._isModifierItemElement($clicked_item)){if(this._isModifierItemElementWithoutKeyword($clicked_item)){this._showKeywordAutocompleteMenu();return}else{if(this.options.data.triggerSearch)this.options.data.triggerSearch()}}else{if(this.options.data.triggerSearch)this.options.data.triggerSearch();if(!this._isHistoryItemElement($clicked_item)){this._showAutocompleteSuggestions();return}}this._hide()},_onClickDeleteHistoryItem:function(e){e.stopPropagation();var $target=$(e.target).closest("li");var query=$target.attr(REPLACEMENT_ATTR);if(this.options.data.deleteHistoryItem)this.options.data.deleteHistoryItem(query);this._current_history_items=this._current_history_items.filter(function(item){return item.text!==query});this._render_data.history=this._current_history_items;this._syncUI()},_onClickFooterTipAction:function(e){var $target=$(e.target).closest(".footer_tip_action");var replacement=$target.data("replacement");if(!replacement)return;this._replaceCurrentWord(replacement);this._showAutocompleteSuggestions()},_onMouseDownOutsideAutocomplete:function(e){if(!$.contains(this.element[0],e.target)&&!$.contains(this._$popover[0],e.target)&&this.element[0]!==e.target&&this._$popover[0]!==e.target){this._hide()}},_onMouseDownMenu:function(e){e.preventDefault()},_onMouseEnter:function(){this._mouse_in_menu=true},_onMouseLeave:function(){this._mouse_in_menu=false},preventMenuOnNextFocus:function(){this._open_menu_on_focus=false},_onTextInputFocus:function(){this._block_menu=false;this._cancelHide();setTimeout($.proxy(function(){this._input_has_focus=true;this._saveCaretPosition();if(this._open_menu_on_focus)this._showAutocompleteSuggestions(true);this._open_menu_on_focus=true},this),0)},_onTextInputBlur:function(){this._input_has_focus=false;if(!this._mouse_in_menu){this._requestHide()}},_onCalendarChange:function(formatted_date){var modifier_and_keyword=this._calendar_modifier+formatted_date+" ";this._open_menu_on_focus=false;this._replaceCurrentWord(modifier_and_keyword);if(this.options.data.triggerSearch)this.options.data.triggerSearch();this._hide()},_onTextInputKeydown:function(e){if(e.keyCode===_key_codes.enter){this._cancelCurrentHistoryQuery();this._block_menu=true}else{this._block_menu=false}var showing=this._menuShowing();if(showing&&e.keyCode===_key_codes.tab&&this._$menu_items.length===1){setTimeout(_.bind(function(){this._highlightModifierAndKeywordInSearchField();this._handleEnterKey(e)},this),0);return}if((e.keyCode===_key_codes.up||e.keyCode===_key_codes.down||e.keyCode===_key_codes.tab)&&showing){setTimeout(_.bind(function(){this._highlightModifierAndKeywordInSearchField()},this),0)}if(e.keyCode===_key_codes.right&&this.element.val().length===this._getCaretPosition()&&showing&&!TS.kb_nav.getHighlightedItem()){setTimeout(_.bind(function(){TS.kb_nav.highlightFirstItem();this._highlightModifierAndKeywordInSearchField()},this),0)}if(e.keyCode===_key_codes.enter&&showing){this._onMenuClick($.Event("keydown",{target:$("."+this.options.selected_class,this._$menu)}))}else if(e.keyCode===_key_codes.escape&&showing){this._handleEscKey(e)}else{this._last_query=this.element.val()}},_isSpecialControlKey:function(e){return e.keyCode===_key_codes.up||e.keyCode===_key_codes.down||e.keyCode===_key_codes.tab||e.keyCode===_key_codes.right||e.keyCode===_key_codes.enter||e.keyCode===_key_codes.escape||e.keyCode===_key_codes.shift},_onTextInputKeyup:function(e){if(e.keyCode===_key_codes.escape)return;this._saveCaretPosition();if(this._block_menu)return;if(this._hideMenuIfTextSelected())return;if(!this._isSpecialControlKey(e)){this._showAutocompleteSuggestions();this._last_query=this.element.val()}},_handleEscKey:function(e){if(this._menuShowing()){e.preventDefault();this._hide()}},_handleEnterKey:function(e){var $selected_item=$("."+this.options.selected_class,this._$menu);if(this._menuShowing()){if($selected_item.length>0){e.preventDefault();if(this._isProfileItemElement($selected_item)){this._handleProfileItem($selected_item);return}if(this._isRevealHiddenElement($selected_item)){this._revealHiddenItems($selected_item);return}if(this._shouldAppendSpaceToItem($selected_item)){var query=this.element.val();var caret_pos=this._getCaretPosition();query=query.substring(0,caret_pos)+" "+query.substring(caret_pos);this.element.val(query).trigger("change");this.element.textrange("setcursor",caret_pos+1)}if(this._modifierAutocompleteShowing()||this._isModifierItemElementWithoutKeyword($selected_item)){this._showKeywordAutocompleteMenu();return}if(this.options.data.triggerSearch)this.options.data.triggerSearch();this._hide()}else{this._hide()}}},_handleBackspaceKey:function(e){var mod_str_info=this._getCurrentModifyingStrDetails();if(mod_str_info){var text=this.element.val();var slug_to_delete=null;if(mod_str_info.caret_in_keyword&&this._keywordIsValid(mod_str_info.keyword.keyword,mod_str_info.modifier.modifier)){slug_to_delete=mod_str_info.keyword}else if(!mod_str_info.caret_in_keyword&&this._modifierIsValid(mod_str_info.modifier.modifier)){slug_to_delete=mod_str_info.modifier}if(slug_to_delete){this.element.val(this._replaceRange(text,slug_to_delete.start,slug_to_delete.start+slug_to_delete.length,"")).trigger("change");e.preventDefault();this.element.setCursorPosition(slug_to_delete.start)}}},_modifierIsValid:function(modifier){return!!modifier&&this.options.data.modifiers_by_name[modifier]},_keywordIsValid:function(keyword,modifier){var modifier_details=this.options.data.modifiers_by_name[modifier];if(!modifier_details){return false}for(var i=0;i<modifier_details.keyword_testers.length;i++){if(modifier_details.keyword_testers[i](keyword))return true}return false},_showAutocompleteSuggestions:function(from_focus){var query=this.element.val();this._cancelDelayedSearch();if(!query)this._initCalendar();if(query&&this._hasNonWhiteSpace(query)){var current_word=this._getWordAtCaretPosition();var current_word_up_to_caret=this._getCurrentWordUpToCaret();if(current_word_up_to_caret&&this._startsWith(current_word_up_to_caret,"+")){this._showModifierAutocompleteMenu(current_word_up_to_caret)}else if(current_word_up_to_caret&&might_be_modifier_regex.test(current_word)){var mod_str_info=this._getCurrentModifyingStrDetails();var modifier=mod_str_info.modifier.modifier;if(mod_str_info.caret_in_keyword||mod_str_info.caret_is_modifier_adjacent){this._showKeywordAutocompleteMenu()}else{this._showModifierAutocompleteMenu(modifier)}}else{var results=this._getResultsForQueryObj({current_word_up_to_caret:current_word_up_to_caret,current_word:current_word,query:query});this._render_data=results;this._$popover.addClass("showing_query_header");this._render_data.header={query:query};this._render_data.show_modifier=true}if(this._resultSetIsEmpty(this._render_data)){this._hide()}else{this._syncUI();this._show()}}else if(from_focus){this._$popover.removeClass("showing_query_header");this._render_data={modifier_groups:true,header:true};this._syncUI();this._show()}},_showKeywordAutocompleteMenu:function(){var mod_str_info=this._getCurrentModifyingStrDetails();if(!mod_str_info){throw this.widgetName+": Lawdy how did you get here?"}var keyword=mod_str_info.keyword.keyword;if(this._startsWith(keyword,"+")){this._showSpecialKeywordsAutocompleteMenu(keyword,mod_str_info);return}switch(mod_str_info.modifier.modifier){case"from:":this._showUserAutocompleteMenu(keyword);break;case"to:":this._showConversationAutocompleteMenu(keyword,"to:");break;case"in:":this._showConversationAutocompleteMenu(keyword,"in:");break;case"during:":case"on:":this._showDateAutocompleteMenu(keyword,mod_str_info.modifier.modifier);this._setCalendarModifier(mod_str_info.modifier.modifier);break;case"after:":case"before:":this._showDateAutocompleteMenu(keyword,mod_str_info.modifier.modifier);this._setCalendarModifier(mod_str_info.modifier.modifier);break;case"has:":this._showHasAutocompleteMenu(keyword);break;default:this._render_data={footer:true};this._syncUI();break}},_showSpecialKeywordsAutocompleteMenu:function(query,mod_str_info){var modifier=this.options.data.modifiers_by_name[mod_str_info.modifier.modifier];var rest_of_query=query.substring(1);var exact_match;var keywords=modifier.keywords.filter(function(keyword){if(keyword===rest_of_query)exact_match=keyword;return query==="+"||this._startsWith(keyword,rest_of_query)},this);if(exact_match){this._replaceCurrentWord(mod_str_info.modifier.modifier+exact_match);this._showAutocompleteSuggestions();return}this._render_data={};this._render_data.modifiers=keywords.map(function(keyword){return $.extend({},modifier,{matching_keyword:keyword})});return},_showConversationAutocompleteMenu:function(query,modifier){if(!query){this._render_data={menu_type:MENU_TYPES.conversation,conversation_modifier:modifier,special:this.options.data.conversationsStarred(),special_section_header:"Starred",channels:this.options.data.channelsOpen(),dms:this.options.data.usersOpen(),groups:this.options.data.groupsOpen()}}else{var exclude_self=false;this._render_data={menu_type:MENU_TYPES.conversation,conversation_modifier:modifier,dms:this._getUsersForQuery(query,null,exclude_self),dms_deleted:this._getUsersForQuery(query,null,exclude_self,true),channels:this._getChannelsForQuery(query,null),channels_archived:this._getChannelsForQuery(query,null,true),groups:this._getGroupsForQuery(query,null),groups_archived:this._getGroupsForQuery(query,null,true)};if(this._render_data.dms.length===0&&this._render_data.dms_deleted.length>0){this._render_data.dms=true}if(this._render_data.channels.length===0&&this._render_data.channels_archived.length>0){this._render_data.channels=true}if(this._render_data.groups.length===0&&this._render_data.groups_archived.length>0){this._render_data.groups=true}}this._syncUI()},_showDateAutocompleteMenu:function(query,modifier_str){var not_number=query.length>0&&/^\D/.test(query);var modifier=this.options.data.modifiers_by_name[modifier_str];var keywords;if(not_number){this._render_data={show_calendar:false};keywords=modifier.keywords.filter(function(keyword){return this._startsWith(keyword,query)},this);this._render_data.modifiers=keywords.map(function(keyword){return $.extend({},modifier,{matching_keyword:keyword})})}else{this._render_data={menu_type:MENU_TYPES.date,show_calendar:true,footer:{calendar_tip:true}}}this._syncUI()},_showChannelAutocompleteMenu:function(query){this._render_data={menu_type:MENU_TYPES.channel,conversation_modifier:DEFAULT_CONVERSATION_MODIFIER,channels:_getChannelsForQuery(query,CHANNEL_RESULT_LIMIT)};this._syncUI()},_showGroupAutocompleteMenu:function(query){this._render_data={menu_type:MENU_TYPES.group,conversation_modifier:DEFAULT_CONVERSATION_MODIFIER,groups:_getGroupsForQuery(query,GROUP_RESULT_LIMIT)};this._syncUI()},_showUserAutocompleteMenu:function(query){this._render_data={menu_type:MENU_TYPES.user};if(!query||query.length===1&&query.charAt(0)==="@"){this._render_data.conversation_modifier="from:";this._render_data.special=this.options.data.usersStarred().concat(this.options.data.usersOpen());this._render_data.special_section_header="Starred and recent";var modifier=this.options.data.modifiers_by_name["from:"];this._render_data.modifiers=modifier.keywords.map(function(keyword){return $.extend({},modifier,{matching_keyword:keyword})})}else{this._render_data.users=this._getUsersForQuery(query,null);this._render_data.users_deleted=this._getUsersForQuery(query,null,false,true);if(this._render_data.users.length===0&&this._render_data.users_deleted.length>0){this._render_data.users=true}}this._syncUI()},_showHasAutocompleteMenu:function(query){this._render_data={menu_type:MENU_TYPES.has,has:[]};this.options.data.modifiers_by_name["has:"].keywords.forEach($.proxy(function(keyword){if(query===""||this._startsWith(keyword,query)){this._render_data.has.push({name:keyword})}},this));this._syncUI()},_showModifierAutocompleteMenu:function(query){var by_name=this.options.data.modifiers_by_name;if(query&&this._startsWith(query,"+")){query=query.substring(1);if(by_name[query]){this._replaceCurrentWord(query);this._showAutocompleteSuggestions();return}}if(!query){this._$popover.removeClass("showing_query_header");this._render_data={modifier_groups:true,header:true}}else{this._render_data={modifiers:this._getModifiersForQuery(query,true),menu_type:MENU_TYPES.modifier}}this._syncUI()},_getCurrentModifyingStrDetails:function(){var caret_pos=this._getCaretPosition();var modifying_str_range=this._getWordRangeAtCaretPosition(caret_pos);if(!modifying_str_range||modifying_str_range.length===0){return null}var modifying_str=this._getWordAtCaretPosition();var word_colon_index=modifying_str.indexOf(":");var query_colon_index=this.element.val().indexOf(":",modifying_str_range.start);var modifier_str=modifying_str.slice(0,word_colon_index+1);return{modifier:{start:modifying_str_range.start,length:word_colon_index+1,modifier:modifier_str},keyword:{start:modifying_str_range.start+word_colon_index+1,length:modifying_str.length-modifier_str.length,keyword:modifying_str.slice(word_colon_index+1)},caret_in_keyword:caret_pos>query_colon_index+1,caret_is_modifier_adjacent:caret_pos===query_colon_index+1}},_highlightModifierAndKeywordInSearchField:function(){var $highlighted_item=TS.kb_nav.getHighlightedItem();if(!$highlighted_item||!$highlighted_item.length)return;var replacement=$highlighted_item.attr(REPLACEMENT_ATTR);if(replacement)this._replaceCurrentWord(replacement)},_handleVerticalArrowKey:function(e){e.preventDefault();var is_up_arrow=e.keyCode===_key_codes.up||e.keyCode===_key_codes.tab&&e.shiftKey;var is_down_arrow=!is_up_arrow&&(e.keyCode===_key_codes.down||e.keyCode===_key_codes.tab);var $next_selection=null;if(!this._$menu_items.length){return}var prev_menu_index=this._menu_index;var $prev_selection=prev_menu_index?$(this._$menu_items.get(prev_menu_index)):null;this._$menu_items.removeClass(SELECTED_CLASS);$next_selection=this._getNextSelection(is_up_arrow);$next_selection.addClass(SELECTED_CLASS).scrollintoview({offset:"bottom",px_offset:0,duration:0});var replacement=$next_selection.attr(REPLACEMENT_ATTR);if(this._isProfileItemElement($next_selection))return;if(this._isRevealHiddenElement($next_selection))return;if(this._historyAutocompleteShowing()){this.element.val(replacement).trigger("change")}else{if(this._isHistoryItemElement($next_selection)){this.element.val(replacement).trigger("change")}else if(this._last_query&&$prev_selection&&this._isHistoryItemElement($prev_selection)){this.element.val(this._last_query);this.element.val(this._replaceWordAtIndex(this._last_query,this._getCaretPosition()-1,replacement)).trigger("change")}else{this._replaceCurrentWord(replacement)}}},_getNextSelection:function(up){var is_up_arrow=up;var is_down_arrow=!up;var $next_selection;var cur_index=this._menu_index;var $visible=this._$menu_items.filter(":not(."+this.options.hidden_class+")");if($visible.length===0)return null;if(cur_index===null){if(is_down_arrow){$next_selection=this._$menu_items.first();cur_index=0}else if(is_up_arrow){$next_selection=this._$menu_items.last();cur_index=this._$menu_items.length-1}}else{if(is_up_arrow){if(--cur_index<0){cur_index=this._$menu_items.length-1}}else if(is_down_arrow){if(++cur_index>this._$menu_items.length-1){cur_index=0}}$next_selection=$(this._$menu_items.get(cur_index))}this._menu_index=cur_index;if($next_selection.hasClass(this.options.hidden_class))return this._getNextSelection(up);return $next_selection},_handleProfileItem:function($item){var id=$item.data("member-id");TS.search.autocomplete.clearInput();this.options.data.openProfile(id);this._hide()},_revealHiddenItems:function($item){var $to_reveal=$item.nextAll("."+this.options.hidden_class);$item.addClass(this.options.hidden_class);$to_reveal.removeClass(this.options.hidden_class)},_deduplicateModifiers:function(modifiers){var deduped_modifiers=[];var unique_modifier_names=[];modifiers.forEach(function(modifier_details){if(unique_modifier_names.indexOf(modifier_details.modifier)===-1){deduped_modifiers.push(modifier_details);unique_modifier_names.push(modifier_details.modifier)}});return deduped_modifiers},_getUsersForQuery:function(query,limit,exclude_self,just_deleted){if(TS.boot_data.feature_name_tagging_client){var full_name_matches=[];var preferred_name_matches=[];if(query.charAt(0)==="@")query=query.substring(1);var name_regexp=new RegExp("\\b"+_regexpEscape(query),"i");if(!limit)limit=LIMIT_DEFAULT;this.options.data.users().some(function(user){if(exclude_self&&user.is_self)return false;if(just_deleted&&!user.deleted)return false;if(!just_deleted&&user.deleted)return false;if(name_regexp.test(user._full_name_normalized_lc)){full_name_matches.push(user);if(limit&&full_name_matches.length>=limit)return true}else if((!limit||preferred_name_matches.length<limit)&&name_regexp.test(user._preferred_name_normalized_lc)){preferred_name_matches.push(user)}return false},this);var results=full_name_matches.concat(preferred_name_matches)}else{var username_matches=[];var realname_matches=[];if(query.charAt(0)==="@")query=query.substring(1);var real_name_regexp=new RegExp("\\b"+_regexpEscape(query),"i");var user_name_regexp=new RegExp("^@?"+_regexpEscape(query),"i");if(!limit)limit=LIMIT_DEFAULT;this.options.data.users().some(function(user){if(exclude_self&&user.is_self)return false;if(just_deleted&&!user.deleted)return false;if(!just_deleted&&user.deleted)return false;if(user_name_regexp.test(user.name)){username_matches.push(user);if(limit&&username_matches.length>=limit)return true}else if((!limit||realname_matches.length<limit)&&real_name_regexp.test(user._real_name_normalized_lc)){realname_matches.push(user)}return false},this);var results=username_matches.concat(realname_matches)}if(limit&&results.length>=limit)results=results.slice(0,limit);return results},_getModifiersForQuery:function(query,exclude_keywords){var results=[];this.options.data.modifiers.forEach(function(modifier){if(this._startsWith(modifier.modifier,query)){results.push($.extend({},modifier))}},this);this.options.data.modifiers.forEach(function(modifier){if(!exclude_keywords){modifier.keywords.forEach(function(keyword){if(this._startsWith(keyword,query)){results.push($.extend({},modifier,{matching_keyword:keyword}))}},this);if(modifier.dynamic_keywords&&modifier.dynamic_keywords.length>0){modifier.dynamic_keywords.forEach(function(dynamic_keyword){if(dynamic_keyword(query)){results.push($.extend({},modifier,{matching_keyword:query}))}})}}},this);results=this._deduplicateModifiers(results);return results},_getChannelsForQuery:function(query,limit,just_archived){var prefix_matches=[];var suffix_matches=[];if(query.charAt(0)==="#")query=query.substring(1);var channel_name_regex=new RegExp("^#?"+_regexpEscape(query),"i");var suffix_regex=new RegExp("(_|-)"+_regexpEscape(query),"i");if(!limit)limit=LIMIT_DEFAULT;if(_.isFunction(this.options.data.willSearchChannelsWithQuery)){this.options.data.willSearchChannelsWithQuery(query)}this.options.data.channels().some(function(channel){if(just_archived&&!channel.is_archived)return false;if(!just_archived&&channel.is_archived)return false;if(channel_name_regex.test(channel.name)){prefix_matches.push(channel);if(limit&&prefix_matches.length>=limit)return true}else if((!limit||prefix_matches.length<limit)&&suffix_regex.test(channel.name)){suffix_matches.push(channel)}return false},this);var results=prefix_matches.concat(suffix_matches);if(limit&&results.length>=limit)results=results.slice(0,limit);return results},_getGroupsForQuery:function(query,limit,just_archived){var prefix_matches=[];var suffix_matches=[];var suffix_regex=new RegExp("(_|-)"+_regexpEscape(query),"i");if(!limit)limit=LIMIT_DEFAULT;if(_.isFunction(this.options.data.willSearchGroupsWithQuery)){this.options.data.willSearchGroupsWithQuery(query)}this.options.data.groups().some(function(group){if(just_archived&&!group.is_archived)return false;if(!just_archived&&group.is_archived)return false;if(this._startsWith(group.name,query)){prefix_matches.push(group);if(limit&&prefix_matches.length>=limit)return true}else if((!limit||prefix_matches.length<limit)&&suffix_regex.test(group.name)){suffix_matches.push(group)}return false},this);var results=prefix_matches.concat(suffix_matches);if(limit&&results.length>=limit)results=results.slice(0,limit);return results},_getHistoryForQuery:function(query){if(query===this._current_history_query)return this._current_history_items;this._current_history_query=query;this._current_history_items=[];this.options.data.history(query,$.proxy(this._historyFetched,this));return this._current_history_items},_getResultsForQueryObj:function(query_obj){var results={conversation_modifier:DEFAULT_CONVERSATION_MODIFIER};var is_at=false;var is_hash=false;if(!query_obj){return results}if(query_obj.current_word_up_to_caret){var current_word_up_to_caret=query_obj.current_word_up_to_caret.toLowerCase();is_hash=current_word_up_to_caret==="#";is_at=current_word_up_to_caret==="@";results.modifiers=this._getModifiersForQuery(current_word_up_to_caret);results.users=this._getUsersForQuery(current_word_up_to_caret,is_at?null:USER_RESULT_LIMIT);results.channels=this._getChannelsForQuery(current_word_up_to_caret,is_hash?null:CHANNEL_RESULT_LIMIT);results.groups=this._getGroupsForQuery(current_word_up_to_caret,GROUP_RESULT_LIMIT)}if(!is_at)results.profiles=this._getUsersForQuery(query_obj.query,PROFILE_RESULT_LIMIT);if(!is_at&&!is_hash)results.history=this._getHistoryForQuery(query_obj.query);return results},_getCurrentWordUpToCaret:function(){var caret_pos=this._getCaretPosition();var text=this.element.val();var pre_caret_text=text.substring(0,caret_pos);var wurds=pre_caret_text.split(" ");var current_word=wurds[wurds.length-1];if(current_word){return current_word}return null},_getCaretPosition:function(){return this._caret_position},_getRealCaretPosition:function(){return this.element.textrange("get","position")},_saveCaretPosition:function(){this._caret_position=this._getRealCaretPosition()},_replaceCurrentWord:function(word){if(!word){throw this.widgetName+": A replacement word must be provided."}var word_range=this._getWordRangeAtCaretPosition();var text=this.element.val();var new_text=this._replaceRange(text,word_range.start,word_range.start+word_range.length,word);this.element.val(new_text).textrange("setcursor",word_range.start+word.length).trigger("change").scrollLeft(1e4);this._saveCaretPosition()},_replaceEntireInput:function(str){this.element.val(str).textrange("setcursor",str.length).trigger("change").scrollLeft(1e4);this._saveCaretPosition()},_replaceWordAtIndex:function(str,replace_index,replacement){var word_range=this._getWordRangeAtCaretPosition(replace_index+1);return this._replaceRange(str.slice(),word_range.start,word_range.start+word_range.length,replacement)},_startsWith:function(str,prefix){if(!str||!prefix||str.length<prefix.length){return false}return str.indexOf(prefix)===0},_getWordAtCaretPosition:function(caret_pos){if(typeof caret_pos==="undefined"){caret_pos=this._getCaretPosition()}var range=this._getWordRangeAtCaretPosition(caret_pos);var word=this.element.val().slice(range.start,range.start+range.length);return word||null},_getWordRangeAtCaretPosition:function(caret_pos){if(typeof caret_pos==="undefined"){caret_pos=this._getCaretPosition()}var preceeding_char_index=caret_pos-1;var words=this.element.val().split(" ");var range={start:0,length:words[0].length||0};var caret_pos_in_word_range=words.some(function(word,index){if(preceeding_char_index>=range.start&&preceeding_char_index<range.start+range.length){return true}if(preceeding_char_index===range.start-1){range.start=caret_pos;range.length=0;return true}if(index+1<words.length){range.start=range.start+word.length+1;range.length=words[index+1].length}return false});if(caret_pos_in_word_range){return range}range.start=caret_pos;range.length=0;return range},_replaceRange:function(str,start,end,what){var prefix=str.substring(0,start);var suffix=str.substring(end);var new_str;if(suffix===str){new_str=what}else{new_str=prefix+what+suffix}return new_str},_menuShowing:function(){return this._$menu.is(":visible")},_hasNonWhiteSpace:function(str){return str&&/\S/.test(str)},_historyAutocompleteShowing:function(){return this._render_data.menu_type===MENU_TYPES.history},_modifierAutocompleteShowing:function(){return this._render_data.menu_type===MENU_TYPES.modifier},_resultSetIsEmpty:function(results){if(results.show_calendar)return false;if(results.modifier_groups)return false;var replacements=null;if(results.modifiers){if(results.modifiers.length>1)return false;if(results.modifiers.length===1){if(replacements)return false;replacements=[results.modifiers[0].modifier+results.modifiers[0].matching_keyword]}}if(results.has){if(results.has.length>1)return false;if(results.has.length===1){if(replacements)return false;replacements=["has:"+results.has[0].name]}}if(results.users){if(results.users.length>1)return false;if(results.users.length===1){if(replacements)return false;replacements=["from:"+results.users[0].name,"from:@"+results.users[0].name]}}if(results.users_deleted){if(results.users_deleted.length>1)return false;if(results.users_deleted.length===1){if(replacements)return false;replacements=["from:"+results.users_deleted[0].name,"from:@"+results.users_deleted[0].name]}}if(results.dms){if(results.dms.length>1)return false;if(results.dms.length===1){if(replacements)return false;replacements=[results.conversation_modifier+results.dms[0].name,results.conversation_modifier+"@"+results.dms[0].name]}}if(results.dms_deleted){if(results.dms_deleted.length>1)return false;if(results.dms_deleted.length===1){if(replacements)return false;replacements=[results.conversation_modifier+results.dms_deleted[0].name,results.conversation_modifier+"@"+results.dms_deleted[0].name]}}if(results.channels){if(results.channels.length>1)return false;if(results.channels.length===1){if(replacements)return false;replacements=[results.conversation_modifier+results.channels[0].name,results.conversation_modifier+"#"+results.channels[0].name]}}if(results.channels_archived){if(results.channels_archived.length>1)return false;if(results.channels_archived.length===1){if(replacements)return false;replacements=[results.conversation_modifier+results.channels_archived[0].name,results.conversation_modifier+"#"+results.channels_archived[0].name]}}if(results.groups){if(results.groups.length>1)return false;if(results.groups.length===1){if(replacements)return false;replacements=[results.conversation_modifier+results.groups[0].name]}}if(results.groups_archived){if(results.groups_archived.length>1)return false;if(results.groups_archived.length===1){if(replacements)return false;replacements=[results.conversation_modifier+results.groups_archived[0].name]}}if(results.history){if(results.history.length>1)return false;if(results.history.length===1){if(replacements)return false;replacements=[results.history[0].text]}}if(replacements){var current_word=this._getWordAtCaretPosition();var any=replacements.some(function(r){return r===current_word});return any}return true},_isHistoryItemElement:function(element){if(!element){throw this.widgetName+": You must pass an AC result list item element to test."}return element&&$(element).closest(ITEM_GROUP_WRAPPER_SEL).hasClass(HISTORY_LIST_CLASS)},_isModifierItemElement:function(element){if(!element){throw this.widgetName+": You must pass an AC result list item element to test."}return element&&$(element).closest(ITEM_GROUP_WRAPPER_SEL).hasClass(MODIFIERS_LIST_CLASS)},_isProfileItemElement:function($element){if(!$element){throw this.widgetName+": You must pass an AC result list item element to test."}return $element.closest(ITEM_GROUP_WRAPPER_SEL).hasClass(PROFILE_LIST_CLASS)},_isRevealHiddenElement:function($element){return $element.hasClass("reveal_hidden_items")},_modifierItemElementHasKeyword:function(element){if(!element){throw this.widgetName+": You must pass an AC result list item element to test."}return!!$(element).attr(MATCHING_KEYWORD_ATTR)},_isModifierItemElementWithoutKeyword:function(element){return this._isModifierItemElement(element)&&!this._modifierItemElementHasKeyword(element)},_shouldAppendSpaceToItem:function(element){if(!element){throw this.widgetName+": You must pass an AC result list item element to test."}if(this._modifierAutocompleteShowing())return false;if(this._isModifierItemElement(element))return this._modifierItemElementHasKeyword(element);if(this._isHistoryItemElement(element))return false;return true},_historyFetched:function(query,suggestions){if(this._block_menu)return;if(query!==this._current_history_query)return;if(query!==this.element.val())return;if(this._menu_index)return;if(suggestions.length===1&&suggestions[0]===query)return;var highlighter_plugin=this.element.data("TS-highlighter");this._current_history_items=suggestions.map(function(history_str){return{text:history_str,html:new Handlebars.SafeString(highlighter_plugin?highlighter_plugin.highlightStr(history_str,true):history_str)}});this._render_data.history=this._current_history_items;if(!this._resultSetIsEmpty(this._render_data)){this._render_data.noResults=false;this._syncUI();this._show()}},_cancelCurrentHistoryQuery:function(){this._current_history_query=null},_hideMenuIfTextSelected:function(){var range=this.element.textrange();if(range.start!==range.end){this._hide();return true}return false},_cancelDelayedSearch:function(){this.options.data.cancelSearch()},_updateGhostText:function(){var val=this.element.val();var last_char=val.charAt(val.length-1);var caret_pos=this._getCaretPosition();var highlighter_plugin=this.element.data("TS-highlighter");var current_word=this._getCurrentWordUpToCaret();var modifier=this.options.data.modifiers_by_name[current_word];
if(!highlighter_plugin)return this._clearGhostText();if(caret_pos!==val.length)return this._clearGhostText();if(modifier){var keyword_placeholder=modifier.keyword_placeholder;if((modifier.modifier==="in:"||modifier.modifier==="to:")&&$(window).width()<1368)keyword_placeholder="channel or DM";highlighter_plugin.setGhostText(keyword_placeholder,last_char);return}if(this._$menu_items.length===0)return this._clearGhostText();var first=this._$menu_items[0];var replacement=$(first).data("replacement");if(!current_word||!replacement)return this._clearGhostText();if(current_word===replacement)return this._clearGhostText();if(val==="+"){highlighter_plugin.setGhostText(replacement);return}var current_word_suffix=_getSuffix(replacement,current_word);if(current_word_suffix){highlighter_plugin.setGhostText(current_word_suffix,last_char);return}var entire_input_suffix=_getSuffix(replacement,val);if(entire_input_suffix){highlighter_plugin.setGhostText(entire_input_suffix,last_char);return}},_clearGhostText:function(){var highlighter_plugin=this.element.data("TS-highlighter");if(!highlighter_plugin)return;highlighter_plugin.setGhostText("")}});var _key_codes={backspace:8,tab:9,enter:13,shift:16,escape:27,up:38,right:39,down:40};var _regexpEscape=function(text){text=text||"";if(text.length>50){text=text.substring(0,50)}return text.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")};var _getSuffix=function(str,prefix){prefix=_regexpEscape(prefix);var fuzzy_prefix=prefix.replace(/:/g,":(@|#)?");var starts_with=new RegExp("^"+fuzzy_prefix+"(.+)","i");var match=starts_with.exec(str);if(match&&match.length>0)return match[match.length-1];return false};var _cOrGSorter=function(a,b){var a_srt=a._name_lc;var b_srt=b._name_lc;if(a_srt<b_srt)return-1;if(a_srt>b_srt)return 1;return 0}})(jQuery);(function(){"use strict";TS.registerModule("search.autocomplete",{last_input_blur_logged:"",onStart:function(){TS.search.search_dispatched_sig.add(TS.search.autocomplete.startSpinner,TS.search.autocomplete);TS.search.all_search_results_fetched_sig.add(_onAllSearchResultsFetched);TS.search.message_search_results_fetched_sig.add(_onMessagesFetched);TS.search.file_search_results_fetched_sig.add(_onFilesFetched);if(TS.client){TS.search.search_channel_set_sig.add(TS.search.autocomplete.updateInput,TS.search.autocomplete);TS.search.search_group_set_sig.add(TS.search.autocomplete.updateInput,TS.search.autocomplete);TS.search.search_member_set_sig.add(TS.search.autocomplete.updateInput,TS.search.autocomplete);TS.client.flexpane_display_switched_sig.add(_cancelDelayedSearchOnFlexpaneChange);TS.client.login_sig.add(function(){if(_$input.val().trim()){_ensureInputSetup()}})}if(TS.web){TS.search.quick_search_results_fetched_sig.add(TS.search.autocomplete.stopSpinner,TS.search.autocomplete)}TS.search.autosuggest_search_results_fetched_sig.add(_historyFetched);TS.search.autocomplete.bindUI();_updateSearchNoDragRegion()},search:function(term,submit){_inputAutocomplete("preventMenuOnNextFocus");_$input.val(term).removeClass("placeholder").focus();if(submit){_$input.closest("form").submit()}},bindUI:function(){_$form=$("#header_search_form");_$input=$("#search_terms");_$input.one("focus",_ensureInputSetup);TS.search.autocomplete.bindForm()},bindForm:function(){var $input=_$input;var $form=_$form;var $client_ui=$("#client-ui");var input_focused=false;var input_blurred=false;if(TS.client){$form.bind("submit",function(e){_performSearch(true);$input.trigger("change");return false});$input.bind("focus",function(){if($.trim($input.val())!==""){if(TS.model.ui_state.flex_name!=="search")_inputAutocomplete("preventMenuOnNextFocus");TS.search.view.showResults();TS.search.view.maybeRebuildResults()}$("#active_channel_name").tooltip("hide");$input.setCursorPosition($input.val().length)})}$input.bind("keyup",function(e){if(e.which==TS.utility.keymap.esc){$input.blur();return}});$input.on("transitionend",function(){if(input_focused||input_blurred||TS.model.ui_state.flex_visible){_updateSearchNoDragRegion()}});$("#search_clear").bind("click.clear_input",function(){TS.search.autocomplete.clearInput()}).bind("mousedown.clear_input",function(e){e.preventDefault()});$input.bind("focus.set_cursor",function(){$input.setCursorPosition($input.val().length)});$input.bind("keyup change focus blur",function(){if($(this).val()){$form.addClass("active")}else{$form.removeClass("active")}});$input.bind("blur",TS.search.autocomplete.maybeLogSearchInputBlur);$input.bind("focus",function(){$client_ui.addClass("search_focused");input_focused=true;input_blurred=!input_focused}).bind("blur",function(){$client_ui.removeClass("search_focused");input_blurred=true;input_focused=!input_blurred});$input.hover(function(){$client_ui.addClass("search_hover")},function(){$client_ui.removeClass("search_hover")})},maybeLogSearchInputBlur:function(e){var terms=TS.search.last_search_query;if(!terms)return;if(TS.search.autocomplete.last_input_blur_logged==terms)return;TS.search.autocomplete.last_input_blur_logged=terms;TS.search.saveSearch({terms:terms})},clearInput:function(){_cancelDelayedSearch();_$input.val("").trigger("change");_inputAutocomplete("hide");_inputAutocomplete("preventMenuOnNextFocus");_$input.focus()},updateInput:function(){if(TS.search.query)_$input.val(TS.search.query_string).trigger("change")},startSpinner:function(){clearTimeout(_start_spinner_timer);_start_spinner_timer=setTimeout(function(){if(!$("#search_spinner").length){_$form.find(".icon_search").addClass("hidden");var $search_icon=$("#header_search_form .icon_search");var inline_search_spinner='<svg id="search_spinner" class="ts_icon ts_icon_spin ts_icon_spinner"><use xlink:href="/img/starburst.svg#starburst_svg"/></svg>';$search_icon.after(inline_search_spinner)}},200)},stopSpinner:function(){clearTimeout(_start_spinner_timer);$("#search_spinner").remove();_$form.find(".icon_search").removeClass("hidden");if(_spinner)_spinner.stop()}});var _$input;var _$form;var _spinner;var _start_spinner_timer;var _history_fetched_callback;var _pending_query="";var _performSearch=function(from_enter_key){_cancelDelayedSearch();var query=$.trim(_$input.val());if(!from_enter_key&&query===TS.search.query)return;if(_pending_query===query){TS.search.view.showResults();return}if(query===""){if(TS.search.filter=="files"){TS.search.view.switchBackToFiles()}}else{if(query.length>=2||from_enter_key){_pending_query=query;TS.search.searchAll(query)}}};var _cancelDelayedSearch=function(){clearTimeout(TS.search.autocomplete.key_tim)};var _updateSearchNoDragRegion=function(){if(!_$input)return;TSSSB.call("updateNoDragRegion",{id:"search",width:_$input.outerWidth(),height:_$input.outerHeight(),top:_$input.offset().top,left:_$input.offset().left})};var _historyFetched=function(data,args){var query=args.query;var suggestions=data.suggestions;var callback=_history_fetched_callback;if(!callback)return;callback(query,suggestions)};var _onAllSearchResultsFetched=function(){_pending_query=null;TS.search.autocomplete.stopSpinner()};var _date_keywords=["monday","tuesday","wednesday","thursday","friday","saturday","sunday","yesterday"];var _date_range_keywords=["january","february","march","april","may","june","july","august","september","october","november","december"];var _date_current_keywords=["today","week","month","year"];var _date_and_date_range_keywords=_date_keywords.concat(_date_current_keywords,_date_range_keywords);var _dynamicYearKeyword=function(str){return _matchDate(str)};var _beforeDynamicYearKeyword=function(str){return _matchDate(str,true)};var _modifiers=[{modifier:"after:",keywords:_date_keywords.concat(_date_range_keywords),dynamic_keywords:[_dynamicYearKeyword],keyword_placeholder:"a date"},{modifier:"before:",keywords:_date_and_date_range_keywords,dynamic_keywords:[_beforeDynamicYearKeyword],keyword_placeholder:"a date"},{modifier:"during:",keywords:_date_and_date_range_keywords,dynamic_keywords:[_dynamicYearKeyword],keyword_placeholder:"a month or year"},{modifier:"from:",keywords:["me"],keyword_placeholder:"team member"},{modifier:"to:",keywords:["me"],keyword_placeholder:"a channel, group or direct message"},{modifier:"has:",keywords:["star","link","reaction"],keyword_placeholder:"star, link, or reaction"},{modifier:"in:",keywords:["me"],keyword_placeholder:"a channel, group or direct message"},{modifier:"on:",keywords:_date_and_date_range_keywords,dynamic_keywords:[_dynamicYearKeyword],keyword_placeholder:"a date"}];var _ac_data;var _getAcData=function(){if(!_ac_data){var prev_channels_query="";var prev_groups_query="";var min_query_length_before_upserting_deferreds=5;_ac_data={modifiers:_modifiers,modifiers_by_name:{},users:function(){return TS.members.getMembersForUser()},usersStarred:function(){var starred=[];var member,im,i;for(i=0;i<TS.model.ims.length;i++){im=TS.model.ims[i];if(im.is_slackbot_im||!im.is_open)continue;member=TS.members.getMemberById(im.user);if(!member||member.deleted||member.is_self)continue;if(im.is_starred)starred.push(im)}starred.sort(_imSorter);return starred.map(function(im){return TS.members.getMemberById(im.user)})},usersOpen:function(){var open_ims=[];var member,im,i;for(i=0;i<TS.model.ims.length;i++){im=TS.model.ims[i];if(im.is_slackbot_im||!im.is_open)continue;member=TS.members.getMemberById(im.user);if(!member||member.deleted||member.is_self)continue;if(!im.is_starred)open_ims.push(im)}open_ims.sort(_imSorter);return open_ims.map(function(im){return TS.members.getMemberById(im.user)})},willSearchChannelsWithQuery:function(query){if(!TS.model.deferred_archived_channels||!TS.model.deferred_archived_channels.length)return;if(query&&query.length>=min_query_length_before_upserting_deferreds){if(prev_channels_query&&prev_channels_query.indexOf(query)>=0){}else{prev_channels_query=query;TS.model.deferred_archived_channels.filter(function(channel){if(channel.name.indexOf(query)>=0){TS.channels.getChannelById(channel.id)}})}}},channels:function(query){return TS.channels.getChannelsForUser()},channelsOpen:function(){var all_channels=TS.channels.getChannelsForUser();var open_channels=[];var i,channel;for(i=0;i<all_channels.length;i++){channel=all_channels[i];if(channel.is_starred)continue;if(channel.is_archived)continue;if(!channel.is_member)continue;open_channels.push(channel)}open_channels.sort(_cOrGSorter);return open_channels},willSearchGroupsWithQuery:function(query){if(!TS.model.deferred_archived_groups||!TS.model.deferred_archived_groups.length)return;if(query&&query.length>=min_query_length_before_upserting_deferreds){if(prev_groups_query&&prev_groups_query.indexOf(query)>=0){}else{prev_groups_query=query;TS.model.deferred_archived_groups.filter(function(group){if(group.name.indexOf(query)>=0){TS.groups.getGroupById(group.id)}})}}},groups:function(query){return TS.model.groups},groupsOpen:function(){var all_groups=TS.model.groups;var open_groups=[];var group,i;for(i=0;i<all_groups.length;i++){group=all_groups[i];if(group.is_archived)continue;if(group.is_starred)continue;open_groups.push(group)}open_groups.sort(_cOrGSorter);return open_groups},conversationsStarred:function(){var channels=[];var users=_ac_data.usersStarred();var groups=[];TS.channels.getChannelsForUser().forEach(function(channel){if(!channel.is_archived&&channel.is_starred&&channel.is_member)channels.push(channel)});TS.model.groups.forEach(function(group){if(!group.is_archived&&group.is_starred)groups.push(group)});var all_starred=channels.concat(users,groups);all_starred.sort(TS.client.channel_pane.modelObSortByStarredOrder);return all_starred},history:function(query,callback){query=query||"";_history_fetched_callback=callback;TS.search.searchSuggest(query)},deleteHistoryItem:function(query){TS.api.call("search.delete",{terms:query})},triggerSearch:function(){_performSearch(true)},triggerDelayedSearch:function(time){TS.search.autocomplete.key_tim=setTimeout(function(){_performSearch()},time||3e3)},cancelSearch:function(){_cancelDelayedSearch()},openProfile:function(member_id){TS.client.ui.previewMember(member_id)}};_ac_data.modifiers.forEach(function(modifier){modifier.keyword_testers=[];if(modifier.keywords.length>0){var keywords_re=new RegExp("^("+modifier.keywords.join("|")+")$","i");modifier.keyword_testers=[function(str){return keywords_re.test(str)}]}switch(modifier.modifier){case"from:":modifier.keyword_testers.push(_matchUser);modifier.keyword_testers.push(_matchBot);break;case"before:":modifier.keyword_testers.push(function(str){return _matchDate(str,true)});break;case"after:":case"during:":case"on:":modifier.keyword_testers.push(_matchDate);break;case"in:":case"to:":modifier.keyword_testers.push(_matchUser);modifier.keyword_testers.push(_matchChannel);modifier.keyword_testers.push(_matchGroup);modifier.keyword_testers.push(_matchMpim);modifier.keyword_placeholder="channel or direct message";break;default:break}_ac_data.modifiers_by_name[modifier.modifier]=modifier})}return _ac_data};var _imSorter=function(a,b){var a_name=TS.ims.getDisplayNameOfUserForImLowerCase(a);var b_name=TS.ims.getDisplayNameOfUserForImLowerCase(b);return a_name>b_name?1:b_name>a_name?-1:0};var _cOrGSorter=function(a,b){var a_srt=a._name_lc;var b_srt=b._name_lc;if(a_srt<b_srt)return-1;if(a_srt>b_srt)return 1;return 0};var _matchUser=function(str){if(str.charAt(0)==="@")str=str.substring(1);return TS.members.getMemberByName(str)};var _matchChannel=function(str){if(str.charAt(0)==="#")str=str.substring(1);return TS.channels.getChannelByName(str)};var _matchGroup=function(str){return TS.groups.getGroupByName(str)};var _matchBot=function(str){var bot_names=_uniqueBots().name_map;str=_.toLower(str);return bot_names[str]};var _matchMpim=function(str){if(str.indexOf(",")===-1)return false;var names=str.split(",");return _.every(names,function(name){if(name.charAt("0")==="@")name=name.substring(1);return!!TS.members.getMemberByName(name)})};var _bot_cache;var _bot_cache_ts=0;var _uniqueBots=function(){if(TS.lazyLoadMembersAndBots&&TS.lazyLoadMembersAndBots()){}if(Date.now()-_bot_cache_ts>3e4){var names={};var bots=[];TS.model.bots.forEach(function(bot){var name=_.toLower(bot.name);if(!bot.deleted&&!names[name]&&name!=="slackbot"){names[name]=true;bots.push(bot)}});_bot_cache={bots:bots,name_map:names}}return _bot_cache};var _us_date=/^(\d\d?)[-\/](\d\d?)[-\/](\d\d\d\d)$/;var _intl_date=/^(\d\d\d\d)[-\/](\d\d?)[-\/](\d\d?)$/;var _ambiguous_date=/^(\d\d)[-\/](\d\d?)[-\/](\d\d?)$/;var _just_year=/^\d\d\d\d$/;var _year_month=/^(\d\d\d\d)[-\/](\d\d?)$/;var _min_year=1900;var _max_year=2999;var _matchDate=function(str,allow_future){var year,month,day;var matches;var today=new Date;if(_just_year.test(str)){year=parseInt(str,10);if(!allow_future&&year>today.getFullYear())return false;if(year<_min_year)return false;if(allow_future&&year>_max_year)return false;return true}matches=_us_date.exec(str);if(matches){year=matches[3];month=matches[1];day=matches[2]}matches=!year&&_intl_date.exec(str);if(matches){year=matches[1];month=matches[2];day=matches[3]}matches=!year&&_ambiguous_date.exec(str);if(matches){year=matches[1];month=matches[2];day=matches[3]}matches=!year&&_year_month.exec(str);if(matches){year=matches[1];month=matches[2];day="1"}if(!year)return false;year=parseInt(year,10);month=parseInt(month,10);day=parseInt(day,10);if(year<1||month<1||day<1)return false;if(year<100)year+=2e3;if(!allow_future&&year>today.getFullYear())return false;if(year<_min_year)return false;if(allow_future&&year>_max_year)return false;if(month>12)return false;if(!allow_future&&year===today.getFullYear()&&month>today.getMonth()+1)return false;if(day>31)return false;if(!allow_future&&year===today.getFullYear()&&month===today.getMonth()+1&&day>today.getDate())return false;if(day>30&&(month===4||month===6||month===9||month===11))return false;if(month===2&&day>29)return false;if(month===2&&day===29){if(year%4!==0){return false}else if(year%100!==0){return true}else if(year%400!==0){return false}}return true};var _onMessagesFetched=function(){if(TS.search.filter=="messages")TS.search.autocomplete.stopSpinner()};var _onFilesFetched=function(){if(TS.search.filter=="files")TS.search.autocomplete.stopSpinner()};var _cancelDelayedSearchOnFlexpaneChange=function(){if(!TS.model.ui_state.flex_visible||TS.model.ui_state.flex_name!=="search"){_cancelDelayedSearch()}};var _inputAutocomplete=function(){_ensureInputSetup();_$input.autocomplete.apply(_$input,arguments)};var _ensureInputSetup=_.once(function(){var data=_getAcData();_$input.highlighter({modifiers:data.modifiers});_$input.autocomplete({append_to:"#header_search_form",data:data})})})();(function(){"use strict";TS.registerModule("ui.group_create_dialog",{div:null,showing:false,auto_name:false,auto_name_str:null,start_member_id:null,onStart:function(){},onKeydown:function(e){if(e.which==TS.utility.keymap.enter){if(TS.utility.getActiveElementProp("NODENAME")=="BODY"){TS.ui.group_create_dialog.go();e.preventDefault()}}else if(e.which==TS.utility.keymap.esc){if(TS.utility.getActiveElementProp("NODENAME")=="BODY"){TS.ui.group_create_dialog.cancel()}}},start:function(group_title,preselected_member_idsA,auto_name){if(TS.client.ui.checkForEditing())return;if(!TS.members.canUserCreateGroups())return;group_title=TS.utility.cleanChannelName(group_title||"");preselected_member_idsA=preselected_member_idsA||[];TS.ui.group_create_dialog.auto_name=!!auto_name;if(!TS.ui.group_create_dialog.div)TS.ui.group_create_dialog.build();var div=TS.ui.group_create_dialog.div;var members_an_admin_could_invite;var members_you_can_invite;if(TS.model.user.is_admin){members_you_can_invite=members_an_admin_could_invite=TS.groups.getActiveMembersForInviting()}else{members_an_admin_could_invite=TS.groups.getActiveMembersForInviting(true);members_you_can_invite=TS.groups.getActiveMembersForInviting()}var invite_members=TS.channels.makeMembersWithPreselectsForTemplate(members_you_can_invite,preselected_member_idsA);var html=TS.templates.generic_dialog({title:"Create a private group",body:TS.templates.group_create({title:group_title,invite_members:invite_members,show_ra_tip:members_you_can_invite.length!=members_an_admin_could_invite.length,compliance_exports_enabled_for_team:!!TS.model.team.prefs.compliance_export_start})});div.empty();div.html(html);div.find(".dialog_cancel").html("Cancel").removeClass("hidden").click(TS.ui.group_create_dialog.cancel);div.find(".dialog_go").html("Create Group").click(TS.ui.group_create_dialog.go);TS.ui.group_create_dialog.bindCreateInvite();div.modal("show")},bindCreateInvite:function(){$("#select_create_invite_group_members").hide().lazyFilterSelect();if(TS.ui.group_create_dialog.auto_name){TS.ui.group_create_dialog.auto_name_str=$("#group_create_title").val();$("#select_create_invite_group_members").bind("change.auto_name",function(){if(TS.ui.group_create_dialog.auto_name_str!=$("#group_create_title").val()){$(this).unbind("change.auto_name");return}var member_idsA=$(this).val()||[];$("#group_create_title").val(TS.groups.createSuggestedName(member_idsA));TS.ui.group_create_dialog.auto_name_str=$("#group_create_title").val()})}$("#select_create_invite_group_members_holder").css("min-height",145);$(".modal-body").css("overflow-y","visible")},showNameTakenAlert:function(){var div=TS.ui.group_create_dialog.div;div.find(".modal_input_note").addClass("hidden");div.find(".name_taken_warning").removeClass("hidden");$("#group_create_title").select()},showExistingGroupsAlert:function(existing_groups_with_same_membersA){$(".modal-body").css("overflow-y","");var div=TS.ui.group_create_dialog.div;var existing_groups_html=TS.templates.existing_groups({existing_groups:existing_groups_with_same_membersA});div.find(".modal_input_note").addClass("hidden");div.find(".existing_groups_warning").html(existing_groups_html).removeClass("hidden").data("has-been-shown",true)},showNoInvitesAlert:function(){var div=TS.ui.group_create_dialog.div;div.find(".modal_input_note").addClass("hidden");div.find(".no_invites_warning").removeClass("hidden")},showNoTitleAlert:function(){var div=TS.ui.group_create_dialog.div;div.find(".modal_input_note").addClass("hidden");div.find(".name_missing_warning").removeClass("hidden")},go:function(){if(!TS.ui.group_create_dialog.showing){TS.error("not showing?");return}if(TS.ui.group_create_dialog.validateAndSubmit()){TS.ui.group_create_dialog.div.modal("hide")}},useExistingGroup:function(group_id){var group=TS.groups.getGroupById(group_id);if(!group)return;if(group.is_archived){TS.api.call("groups.unarchive",{channel:group_id})}TS.groups.displayGroup(group_id);TS.ui.group_create_dialog.div.modal("hide")},validateAndSubmit:function(){var div=TS.ui.group_create_dialog.div;var title=$("#group_create_title").val();var purpose=$.trim($("#group_purpose_input").val());var clean_title=TS.utility.cleanChannelName(title);while(title.substr(0,1)=="#")title=title.substr(1);if(!title){TS.ui.group_create_dialog.showNoTitleAlert();return false}$("#group_create_title").val(clean_title);if(clean_title!=title){alert("You entered some disallowed characters in the group name, which we've fixed. Make sure it looks good to you, and try again!");return false}if(TS.channels.getChannelByName(title)||TS.groups.getGroupByName(title)||TS.members.getMemberByName(title)){TS.ui.group_create_dialog.showNameTakenAlert();return false}var and_invite_members_idsA=$("#select_create_invite_group_members").val()||[];if(!div.find(".existing_groups_warning").data("has-been-shown")){$("#create_invite_group_members_holder").addClass("hidden");var existing_groups_with_same_membersA=TS.groups.getGroupsWithTheseActiveMembers(and_invite_members_idsA.concat(TS.model.user.id));if(existing_groups_with_same_membersA.length){TS.ui.group_create_dialog.showExistingGroupsAlert(existing_groups_with_same_membersA);return false}}if(TS.model.created_groups[title]){return false}TS.groups.create(title,and_invite_members_idsA,function(ok,data,args){if(!ok){if(data.error=="name_taken"){TS.ui.group_create_dialog.showNameTakenAlert()}else if(data.error=="restricted_action"){TS.generic_dialog.alert("<p>You don't have permission to create new groups.</p><p>Talk to your Team Owner.</p>")}else{alert("failed! "+data.error)}return}if(purpose)TS.groups.setPurpose(data.group.id,purpose);div.modal("hide")});return false},reset:function(){TS.ui.group_create_dialog.auto_name=false;TS.ui.group_create_dialog.auto_name_str=null;TS.ui.group_create_dialog.start_member_id=null},cancel:function(){TS.ui.group_create_dialog.reset();TS.ui.group_create_dialog.div.modal("hide")},end:function(){TS.ui.group_create_dialog.div.empty();TS.ui.group_create_dialog.showing=TS.model.dialog_is_showing=false;TS.ui.group_create_dialog.reset();$(window.document).unbind("keydown",TS.ui.group_create_dialog.onKeydown)},build:function(){$("body").append('<div id="group_create_dialog" class="modal hide fade"></div>');var div=TS.ui.group_create_dialog.div=$("#group_create_dialog");div.on("hide",function(e){if(e.target!=this)return;TS.ui.group_create_dialog.end()});div.on("show",function(e){if(e.target!=this)return;TS.ui.group_create_dialog.showing=TS.model.dialog_is_showing=true});div.on("shown",function(e){if(e.target!=this)return;setTimeout(function(){$("#group_create_title").select();$(window.document).bind("keydown",TS.ui.group_create_dialog.onKeydown)},100)})}})})();(function(){"use strict";TS.registerModule("ui.channel_create_dialog",{div:null,showing:false,is_edit:false,model_ob:null,ladda:null,onStart:function(){},onKeydown:function(e){if(e.which==TS.utility.keymap.enter){TS.ui.channel_create_dialog.go();e.preventDefault()}else if(e.which==TS.utility.keymap.esc){TS.ui.channel_create_dialog.cancel()}},start:function(title,model_ob){if(TS.client.ui.checkForEditing())return;if(model_ob){if(TS.model.user.is_restricted)return;TS.ui.channel_create_dialog.is_edit=true;TS.ui.channel_create_dialog.model_ob=model_ob}else{if(!TS.permissions.members.canCreateChannels())return;TS.ui.channel_create_dialog.is_edit=false;TS.ui.channel_create_dialog.model_ob=null}title=TS.utility.cleanChannelName(title||"").substr(0,TS.model.channel_name_max_length);if(!TS.ui.channel_create_dialog.div)TS.ui.channel_create_dialog.build();var div=TS.ui.channel_create_dialog.div;var html=TS.templates.channel_create_dialog({title:title,is_edit:TS.ui.channel_create_dialog.is_edit,is_group:TS.ui.channel_create_dialog.model_ob&&TS.ui.channel_create_dialog.model_ob.is_group,hide_private_group_option:!TS.members.canUserCreateGroups()});div.empty();div.html(html);div.find(".dialog_cancel").click(TS.ui.channel_create_dialog.cancel);div.find(".dialog_go").click(TS.ui.channel_create_dialog.go);div.modal("show")},switchToGroup:function(){var title=TS.ui.channel_create_dialog.div.find(".title_input").val();TS.ui.channel_create_dialog.cancel();setTimeout(function(){TS.ui.group_create_dialog.start(title)},350)},showNameTakenAlert:function(){var div=TS.ui.channel_create_dialog.div;TS.channels.ui.channelCreateDialogShowNameTakenAlert(div)},go:function(){if(!TS.ui.channel_create_dialog.showing){TS.error("not showing?");return}var div=TS.ui.channel_create_dialog.div;var validated=TS.channels.ui.channelCreateDialogValidateInput(div);if(!validated)return;var title=div.find(".title_input").val();var purpose=$.trim(div.find("#channel_purpose_input").val());if(TS.ui.channel_create_dialog.ladda)TS.ui.channel_create_dialog.ladda.start();if(TS.ui.channel_create_dialog.is_edit){var method=TS.ui.channel_create_dialog.model_ob.is_channel?"channels.rename":"groups.rename";TS.api.callImmediately(method,{name:title,channel:TS.ui.channel_create_dialog.model_ob.id},function(ok,data,args){if(TS.ui.channel_create_dialog.ladda)TS.ui.channel_create_dialog.ladda.stop();if(!ok){if(data.error=="name_taken"){TS.ui.channel_create_dialog.showNameTakenAlert()}else{alert("failed! "+data.error)}return}div.modal("hide")})}else{TS.channels.join(title,function(ok,data,args){if(TS.ui.channel_create_dialog.ladda)TS.ui.channel_create_dialog.ladda.stop();if(!ok){if(data.error=="name_taken"){TS.ui.channel_create_dialog.showNameTakenAlert()}else if(data.error=="restricted_action"){}else{alert("failed! "+data.error)}return}if(purpose)TS.channels.setPurpose(data.channel.id,purpose);div.modal("hide")})}},cancel:function(){TS.ui.channel_create_dialog.div.modal("hide")},end:function(){TS.ui.channel_create_dialog.showing=TS.model.dialog_is_showing=false;$(window.document).unbind("keydown",TS.ui.channel_create_dialog.onKeydown)},build:function(){$("body").append('<div id="channel_create_dialog" class="modal hide fade"></div>');var div=TS.ui.channel_create_dialog.div=$("#channel_create_dialog");div.on("hide",function(e){if(e.target!=this)return;TS.ui.channel_create_dialog.end();div.removeAttr("data-qa")});div.on("show",function(e){if(e.target!=this)return;TS.ui.channel_create_dialog.showing=TS.model.dialog_is_showing=true});div.on("shown",function(e){if(e.target!=this)return;setTimeout(function(){div.find(".title_input").select();$(window.document).bind("keydown",TS.ui.channel_create_dialog.onKeydown);div.attr("data-qa","channel_create_dialog_ready")},100);TS.ui.channel_create_dialog.ladda=Ladda.create(div.find(".dialog_go")[0])})}})})();(function(){"use strict";TS.registerModule("ui.purpose_dialog",{div:null,showing:false,model_ob:null,onStart:function(){},onKeydown:function(e){if(e.which==TS.utility.keymap.enter){TS.ui.purpose_dialog.go();e.preventDefault()}else if(e.which==TS.utility.keymap.esc){TS.ui.purpose_dialog.cancel()}},start:function(title,model_ob){if(TS.client.ui.checkForEditing())return;TS.ui.purpose_dialog.model_ob=model_ob;TS.ui.purpose_dialog.is_group=TS.ui.purpose_dialog.model_ob.is_group;if(!TS.ui.purpose_dialog.div)TS.ui.purpose_dialog.build();var div=TS.ui.purpose_dialog.div;var html=TS.templates.purpose_dialog({model_ob:TS.ui.purpose_dialog.model_ob,is_group:TS.ui.purpose_dialog.is_group});div.empty();div.html(html);div.find(".dialog_cancel").click(TS.ui.purpose_dialog.cancel);div.find(".dialog_go").click(TS.ui.purpose_dialog.go);div.modal("show")},go:function(){if(!TS.ui.purpose_dialog.showing){TS.error("not showing?");return}var div=TS.ui.purpose_dialog.div;var purpose=$.trim(div.find("#purpose_input").val());if(TS.ui.purpose_dialog.is_group){TS.groups.setPurpose(TS.ui.purpose_dialog.model_ob.id,purpose)}else{TS.channels.setPurpose(TS.ui.purpose_dialog.model_ob.id,purpose)}div.modal("hide")},cancel:function(){TS.ui.purpose_dialog.div.modal("hide")},end:function(){TS.ui.purpose_dialog.showing=TS.model.dialog_is_showing=false;$(window.document).unbind("keydown",TS.ui.purpose_dialog.onKeydown)},build:function(){$("body").append('<div id="purpose_dialog" class="modal hide fade"></div>');var div=TS.ui.purpose_dialog.div=$("#purpose_dialog");div.on("hide",function(e){if(e.target!=this)return;TS.ui.purpose_dialog.end();div.removeAttr("data-qa")});div.on("show",function(e){if(e.target!=this)return;TS.ui.purpose_dialog.showing=TS.model.dialog_is_showing=true});div.on("shown",function(e){if(e.target!=this)return;setTimeout(function(){div.find("#purpose_input").select();$(window.document).bind("keydown",TS.ui.purpose_dialog.onKeydown);div.attr("data-qa","purpose_dialog_ready")},100)})}})})();(function(){"use strict";TS.registerModule("ui.growls",{no_notifications:false,permission_changed_sig:new signals.Signal,onStart:function(){TS.ui.growls.updateTotalUnreadDisplaysSSBThrottled=TS.utility.throttleFunc(TS.ui.growls.updateTotalUnreadDisplaysSSB,500,true);TS.channels.unread_changed_sig.add(TS.ui.growls.updateTotalUnreadDisplays,TS.ui.growls);TS.channels.unread_highlight_changed_sig.add(TS.ui.growls.updateTotalUnreadDisplays,TS.ui.growls);TS.groups.unread_changed_sig.add(TS.ui.growls.updateTotalUnreadDisplays,TS.ui.growls);TS.groups.unread_highlight_changed_sig.add(TS.ui.growls.updateTotalUnreadDisplays,TS.ui.growls);TS.ims.unread_changed_sig.add(TS.ui.growls.updateTotalUnreadDisplays,TS.ui.growls);TS.ims.unread_highlight_changed_sig.add(TS.ui.growls.updateTotalUnreadDisplays,TS.ui.growls);TS.mpims.unread_changed_sig.add(TS.ui.growls.updateTotalUnreadDisplays,TS.ui.growls);TS.mpims.unread_highlight_changed_sig.add(TS.ui.growls.updateTotalUnreadDisplays,TS.ui.growls);TS.client.login_sig.add(TS.ui.growls.updateTotalUnreadDisplays,TS.ui.growls);TS.prefs.mac_ssb_bullet_changed_sig.add(TS.ui.growls.updateTotalUnreadDisplays,TS.ui.growls);TS.ui.window_focus_changed_sig.add(TS.ui.growls.windowFocusChanged,TS.ui.growls);if(window.macgap){}else if(window.Notification||window.webkitNotifications){}else if(window.winssb){}else{TS.ui.growls.no_notifications=true;return}TS.channels.message_received_sig.add(TS.ui.growls.channelOrGroupMessageReceived,TS.ui.growls);TS.groups.message_received_sig.add(TS.ui.growls.channelOrGroupMessageReceived,TS.ui.growls);TS.mpims.message_received_sig.add(TS.ui.growls.channelOrGroupMessageReceived,TS.ui.growls);TS.ims.message_received_sig.add(TS.ui.growls.imMessageReceived,TS.ui.growls)},shouldShowPermissionButton:function(){if(TS.ui.growls.no_notifications)return false;if(TS.ui.growls.checkPermission())return false;if(TS.ui.growls.getPermissionLevel()=="denied")return false;return true},checkPermission:function(){if(TS.ui.growls.no_notifications)return false;if(window.macgap)return true;if(window.winssb)return true;return TS.ui.growls.getPermissionLevel()==="granted"},perm_map:{0:"granted",1:"default",2:"denied"},getPermissionLevel:function(){if(TS.ui.growls.no_notifications)return"na";if(window.macgap)return"na";if(window.winssb)return"na";if(window.webkitNotifications&&window.webkitNotifications.checkPermission){return TS.ui.growls.perm_map[window.webkitNotifications.checkPermission()]}else if(window.Notification){return window.Notification.permission}},promptForPermission:function(callback){if(TS.ui.growls.no_notifications){if(callback){callback(false,-9999999)}return}var local_callback=function(){if(callback){callback(TS.ui.growls.checkPermission(),TS.ui.growls.getPermissionLevel())}TS.ui.growls.permission_changed_sig.dispatch(TS.ui.growls.checkPermission(),TS.ui.growls.getPermissionLevel())};if(window.webkitNotifications&&window.webkitNotifications.requestPermission&&window.webkitNotifications.checkPermission){
window.webkitNotifications.requestPermission(local_callback)}else if(window.Notification){window.Notification.requestPermission(local_callback)}},show:function(title,txt,onclick,options){options=options||{};var msg=options.msg;var c_id=options.channelId;var subtitle=options.subtitle;var launch_uri=options.launchUri;var sound_url=options.soundUrl;var ssb_filename=TS.sounds.filenameForSoundName(options.sound_name||"new_message");var image_uri=options.imageUri;var avatar_image=options.avatarImage;if(!TS.ui.growls.checkPermission())return;var args;if(window.winssb){args={title:title,subtitle:subtitle,content:txt,launchUri:launch_uri,imageUri:image_uri,channel:c_id||"",msg:msg&&msg.ts||"",avatarImage:avatar_image,ssbFilename:ssb_filename};if(TS.boot_data.feature_message_replies&&msg.thread_ts)args.thread_ts=msg.thread_ts;TSSSB.call("notify",args)}else if(window.macgap){var local_onclick=function(x){window.focus();if(onclick)onclick()};if(window.macgap.growl){window.macgap.growl.notify({title:title,content:txt,onclick:local_onclick,channel:c_id||""})}else if(window.macgap.notice){TSSSB.call("notify",{title:title,subtitle:subtitle,content:txt,soundUrl:sound_url,ssbFilename:ssb_filename,onclick:local_onclick,channel:c_id||"",msg:msg&&msg.ts||""})}}else{var growl;if(window.webkitNotifications){growl=window.webkitNotifications.createNotification(TS.boot_data.img.app_icon,title,txt)}else if(window.Notification){growl=new Notification(title,{body:txt,icon:TS.boot_data.img.app_icon,tag:"tag_"+(msg?msg.id||msg.ts||Date.now():Date.now())})}if(!growl)return;try{growl.onclick=function(){window.focus();if(onclick){onclick()}if(this.cancel){this.cancel()}else if(this.close){this.close()}}}catch(err){}var growlFinished=function(){setTimeout(function(){if(growl.cancel){growl.cancel()}else if(growl.close){growl.close()}},txt&&txt.length>80?1e4:5e3)};if(growl){try{growl.onshow=growlFinished;setTimeout(growlFinished,1e3)}catch(err){growlFinished()}}if(growl.show){growl.show()}}},updateTotalUnreadDisplays:function(model_ob,allow_throttle){if(window.macgap||window.winssb){if(allow_throttle&&allow_throttle===true){TS.ui.growls.updateTotalUnreadDisplaysSSBThrottled()}else{TS.ui.growls.updateTotalUnreadDisplaysSSB()}}if(TS.model.all_unread_highlights_cnt){TS.view.changeUnreadStatus("mentions")}else if(TS.model.all_unread_cnt){TS.view.changeUnreadStatus("unreads")}else{TS.view.changeUnreadStatus("")}},updateTotalUnreadDisplaysSSBThrottled:_.noop,updateTotalUnreadDisplaysSSB:function(){var all_unread_highlights_cnt=TS.model.all_unread_highlights_cnt;var all_unread_cnt=TS.model.all_unread_cnt;if(TS.boot_data.page_needs_enterprise&&TS.model.team&&TS.model.team.enterprise_id&&TS.boot_data.other_accounts){if(TS.model.all_unread_highlights_cnt_to_exclude){if(TS.pri)TS.log(67,"updateTotalunreadDisplaysSSB: TS.model.all_unread_highlights_cnt_to_exclude = "+TS.model.all_unread_highlights_cnt_to_exclude);all_unread_highlights_cnt=Math.max(0,all_unread_highlights_cnt-TS.model.all_unread_highlights_cnt_to_exclude)}if(TS.model.all_unread_cnt_to_exclude){if(TS.pri)TS.log(67,"updateTotalunreadDisplaysSSB: TS.model.all_unread_cnt_to_exclude = "+TS.model.all_unread_cnt_to_exclude);all_unread_cnt=Math.max(0,all_unread_cnt-TS.model.all_unread_cnt_to_exclude)}}if(TS.pri)TS.log(67,"TSSSB.call('setBadgeCount') - all_unread_highlights_cnt = "+all_unread_highlights_cnt+", all_unread_cnt = "+all_unread_cnt+", bullet = "+((window.macgap||window.winssb?!!TS.model.prefs.mac_ssb_bullet:false)?"true":"false"));TSSSB.call("setBadgeCount",{all_unread_highlights_cnt:all_unread_highlights_cnt,all_unread_cnt:all_unread_cnt,bullet:window.macgap||window.winssb?!!TS.model.prefs.mac_ssb_bullet:false})},getGrowlableTxtFromAttachments:function(attachments){for(var i=0;i<attachments.length;i++){var attachment=attachments[i];if(attachment.fallback){return attachment.fallback}else if(attachment.text){return attachment.text}else if(attachment.pretext){return attachment.pretext}else if(attachment.footer){return attachment.footer}}return null},no_growl_subtypes:["channel_leave","channel_join","group_leave","group_join"],channelOrGroupMessageReceived:function(model_ob,msg){if(!msg){TS.error("no msg?");return}if(msg.no_display){return}if(!model_ob){TS.error("no channel/group?");return}if(TS.boot_data.feature_message_replies){_ensureSubscriptionsForReplies(model_ob,msg).then(function(){TS.ui.growls.growlchannelOrGroupMessage(model_ob,msg,true)})}else{TS.ui.growls.growlchannelOrGroupMessage(model_ob,msg,true)}},growlchannelOrGroupMessage:function(model_ob,msg,change_title,force){if(!msg){TS.error("no msg?");return}if(msg.no_display){return}if(!model_ob){TS.error("no channel/group?");return}var channel_mentions_can_growl=TS.notifs.canCorGHaveChannelMentions(model_ob.id);var contains_mention;var mentions_data;var thread_subscribed=true;if(TS.boot_data.feature_message_replies&&TS.utility.msgs.isMsgReply(msg)){var subscription=TS.replies.getSubscriptionState(model_ob.id,msg.thread_ts);thread_subscribed=subscription&&subscription.subscribed}if(channel_mentions_can_growl){var ignore_at_here_mentions=TS.model.user.presence=="away";if(TS.boot_data.feature_message_replies&&TS.utility.msgs.isMsgReply(msg)){ignore_at_here_mentions=ignore_at_here_mentions||!thread_subscribed}contains_mention=TS.utility.msgs.msgContainsMention(msg,ignore_at_here_mentions);if(contains_mention)TS.mentions.maybeUpdateMentions()}else{mentions_data=TS.utility.msgs.getMsgMentionData(msg);contains_mention=mentions_data.non_channel_mentions;if(mentions_data.mentions)TS.mentions.maybeUpdateMentions()}if(!force&&msg.subtype&&TS.ui.growls.no_growl_subtypes.indexOf(msg.subtype)!=-1){return}var is_muted=TS.notifs.isCorGMuted(model_ob.id);var can_be_unread=TS.utility.msgs.msgCanCountAsUnread(msg);var is_hidden_reply=TS.boot_data.feature_message_replies&&msg._hidden_reply;var qualifies_as_mention=(can_be_unread||is_hidden_reply)&&contains_mention;var contains_cmd=TS.ui.growls.containsCmd(msg.text);TS.log(66,"qualifies_as_mention:"+qualifies_as_mention);TS.log(66,"can_be_unread:"+can_be_unread);TS.log(66,"contains_mention:"+contains_mention);var setting=TS.notifs.getCalculatedCorGNotifySetting(model_ob.id);TS.log(66,"setting:"+setting);if(!force&&msg.subtype=="bot_message"&&setting!="everything"&&!contains_mention){return}if(change_title&&can_be_unread&&!TS.model.ui.is_window_focused){if(qualifies_as_mention&&document.title.indexOf("!")==-1){document.title="! "+document.title}else if(!is_muted&&document.title.indexOf("*")==-1){document.title="* "+document.title}}if(!force&&setting=="nothing")return;if(TS.boot_data.feature_message_replies&&TS.utility.msgs.isMsgReply(msg)&&!force&&setting=="everything"&&!thread_subscribed){setting="mentions"}if(!TS.ui.growls.checkPermission())return;var is_in_active_channel=model_ob.id==TS.model.active_channel_id||model_ob.id==TS.model.active_group_id||model_ob.id==TS.model.active_mpim_id;var is_in_active_thread=TS.boot_data.feature_message_replies&&msg.thread_ts&&model_ob.id===TS.ui.replies.activeConvoModelId()&&msg.thread_ts===TS.ui.replies.activeConvoThreadTs();var display=false;if(qualifies_as_mention){display=true}if(setting=="everything")display=true;if(display&&(is_in_active_channel||is_in_active_thread)&&TS.model.ui.is_window_focused&&!contains_cmd){display=false}if(display&&!channel_mentions_can_growl&&mentions_data&&mentions_data.mentions&&!mentions_data.non_channel_mentions){display=false}if(display&&(msg.user==TS.model.user.id||msg.comment&&msg.comment.user==TS.model.user.id)){display=false}if(display&&msg.no_notifications){display=false}if(display&&is_muted){if(TS.boot_data.feature_message_replies&&TS.utility.msgs.isMsgReply(msg)){if(!thread_subscribed)display=false}else{display=false}}if(display&&TS.members.isMemberInDnd(TS.model.user)&&!msg._ignore_dnd){display=false}if(TS.shared.isSharedModelOb(model_ob)){var is_relevant_team=TS.shared.isRelevantTeamForSharedModelOb(model_ob);if(!is_relevant_team){if(TS.pri)TS.log(67,"Shared channel #"+model_ob.name+" is not relevant; suppressing notification.");display=false}else{if(TS.pri)TS.log(67,"Shared channel #"+model_ob.name+" is relevant; allowing notification.")}}if(!display&&!force)return;var from_name=TS.ui.growls.extractFromNameFromCorGMessage(msg);var onclick=function(){if(TS.boot_data.feature_message_replies){if(msg.thread_ts&&msg.ts!=msg.thread_ts){TS.ui.replies.openConversation(model_ob,msg.thread_ts,msg.ts);return}}if(model_ob.is_channel){TS.channels.displayChannel(model_ob.id)}else if(model_ob.is_mpim){TS.mpims.displayMpim(model_ob.id)}else{TS.groups.displayGroup(model_ob.id)}};var msg_txt=TS.ui.growls.extractTxtFromMsg(msg,true);msg_txt=msg_txt.replace(":simple_smile:",":)");var growl_txt=TS.model.prefs.no_text_in_notifications?from_name?"a message from "+from_name:"":from_name?from_name+": ":"";growl_txt+=msg_txt;var ssbFilename;var soundUrl;if(TSSSB.call("shouldAttachSoundToNotification")){var sound=TS.sounds.soundForName("new_message");if(sound){ssbFilename=sound.ssbFilename;soundUrl=sound.url}}else{TS.sounds.play("new_message")}TS.ui.growls.maybeBounceDockIcon();var title;var subtitle;var model_ob_name="#"+model_ob.name;if(model_ob.is_mpim){model_ob_name=TS.mpims.getDisplayName(model_ob)}if(TS.getOtherAccountsCount()>0&&(TS.ui.growls.canSpeak()||window.winssb)){if(TS.model.supports_growl_subtitle){title=TS.model.team.name;subtitle=model_ob_name}else{title="["+TS.model.team.domain+"] in "+model_ob_name}}else{title="New message in "+model_ob_name}var avatar_image=TS.ui.growls.getProfileImageFromUserId(msg.user);TS.ui.growls.show(title,TS.format.formatNotification(growl_txt,msg),onclick,{msg:msg,channelId:model_ob.id,subtitle:subtitle,soundUrl:soundUrl,ssbFilename:ssbFilename,launchUri:TS.ui.growls.getLaunchUriForChannel(model_ob.id,msg.ts),imageUri:TS.ui.growls.getAttachmentUri(msg),avatarImage:avatar_image});if(TS.model.prefs.speak_growls){TS.ui.growls.speakchannelOrGroupMessage(model_ob,msg,msg_txt,from_name)}},getLaunchUriForChannel:function(channel_id,msg_id){return channel_id?"slack://channel?id="+channel_id+"&message="+msg_id+"&team="+TS.model.team.id:null},getAttachmentUri:function(msg){var has_attached_image=msg.attachments&&msg.attachments.length>0&&msg.attachments[0].image_url;return has_attached_image&&TS.model.prefs.expand_inline_imgs?msg.attachments[0].image_url:null},speakchannelOrGroupMessage:function(model_ob,msg,msg_txt,from_name){if(!TS.ui.growls.canSpeak())return;if(!msg){TS.error("no msg?");return}msg_txt=msg_txt||TS.ui.growls.extractTxtFromMsg(msg,true);from_name=from_name||TS.ui.growls.extractFromNameFromCorGMessage(msg);var title;var model_type="channel";if(model_ob.is_group){if(model_ob.is_mpim){model_type="conversation"}else{model_type="private channel"}}if(TS.getOtherAccountsCount()>0){title="On team "+TS.model.team.name+", a message in "+model_type+' "'+model_ob.name+'" from "'+from_name+'": '}else{title="message in "+model_type+' "'+model_ob.name+'" from "'+from_name+'": '}var spoken_txt=title+TS.format.formatNotification(msg_txt,msg);TS.ui.growls.speak(spoken_txt)},voices:null,speakQ:[],getVoices:function(txt,asap,voice,speed){if(!TS.ui.growls.canSpeak())return null;if(TS.ui.growls.voices)return TS.ui.growls.voices;TS.ui.growls.voices=[];var v=macgap.app.availableVoices();for(var i=0;i<v.length;i++){TS.ui.growls.voices.push({label:v[i].substr(v[i].lastIndexOf(".")+1),value:v[i]})}return TS.ui.growls.voices},canSpeak:function(){if(window.macgap&&macgap.app&&macgap.app.speakStringWithVoiceAndRateAndCallback)return true;return false},speak:function(txt,asap,voice,speed){if(!TS.ui.growls.canSpeak())return;var Q=TS.ui.growls.speakQ;var ob={txt:txt||"no text??",voice:voice,speed:speed,asap:asap||false};if(asap&&Q.length){var eob;for(var i=Q.length-1;i>-1;i--){eob=Q[i];if(eob.asap||i===0){Q.splice(i+1,0,ob);break}}}else{Q.push(ob)}if(Q.length==1)TS.ui.growls._speakNext()},_speakNext:function(){if(!TS.ui.growls.speakQ.length)return;var ob=TS.ui.growls.speakQ[0];if(ob.speaking)return;ob.speaking=true;var voices=TS.ui.growls.getVoices();macgap.app.speakStringWithVoiceAndRateAndCallback(ob.txt,ob.voice||TS.model.prefs.mac_speak_voice||_.sample(voices).value,ob.speed||TS.model.prefs.mac_speak_speed||_.random(100,300),function(){setTimeout(function(){TS.ui.growls.speakQ.shift();TS.ui.growls._speakNext()},100)})},imMessageReceived:function(model_ob,msg){if(!msg){TS.error("no msg?");return}if(msg.no_display){return}if(TS.boot_data.feature_message_replies){_ensureSubscriptionsForReplies(model_ob,msg).then(function(){TS.ui.growls.growlImMessage(model_ob,msg,true)})}else{TS.ui.growls.growlImMessage(model_ob,msg,true)}},growlImMessage:function(im,msg,change_title,force){if(!msg){TS.error("no msg?");return}if(msg.no_display){return}if(change_title&&!TS.model.ui.is_window_focused&&document.title.indexOf("!")==-1){document.title="! "+document.title}if(!force&&!TS.model.prefs.growls_enabled)return;if(!TS.ui.growls.checkPermission())return;var display=false;if(TS.boot_data.feature_message_replies){var is_in_active_im=im.id===TS.model.active_im_id;var is_reply=TS.utility.msgs.isMsgReply(msg);var is_in_active_thread=is_reply&&im.id===TS.ui.replies.activeConvoModelId()&&msg.thread_ts===TS.ui.replies.activeConvoThreadTs();var thread_subscribed=true;if(is_reply){var subscription=TS.replies.getSubscriptionState(im.id,msg.thread_ts);thread_subscribed=subscription&&subscription.subscribed}if(!TS.model.ui.is_window_focused)display=true;if(!display&&!is_in_active_im&&!is_in_active_thread)display=true;if(!display&&is_in_active_im&&is_reply&&!is_in_active_thread)display=true;if(display&&is_reply&&!thread_subscribed)display=false}else{if(im.id!=TS.model.active_im_id||!TS.model.ui.is_window_focused){display=true}}if(msg.user==TS.model.user.id||msg.comment&&msg.comment.user==TS.model.user.id){display=false}var bot_name=TS.templates.builders.getBotName(msg);if(msg.no_notifications){display=false}if(display&&TS.members.isMemberInDnd(TS.model.user)&&!msg._ignore_dnd){display=false}if(TS.shared.isSharedModelOb(im)){var is_relevant_team=TS.shared.isRelevantTeamForSharedModelOb(im);if(!is_relevant_team){if(TS.pri)TS.log(67,"Shared channel #"+im.name+" is not relevant; suppressing notification.");display=false}else{if(TS.pri)TS.log(67,"Shared channel #"+im.name+" is relevant; allowing notification.")}}if(!display&&!force)return;var onclick=function(){if(TS.boot_data.feature_message_replies){if(msg.thread_ts&&msg.ts!=msg.thread_ts){TS.ui.replies.openConversation(im,msg.thread_ts);return}}TS.ims.startImByMemberId(im.user)};var from_name=bot_name||TS.ims.getDisplayNameOfUserForIm(im);var msg_txt=TS.ui.growls.extractTxtFromMsg(msg,true);msg_txt=msg_txt.replace(":simple_smile:",":)");var growl_txt="";growl_txt+=msg_txt;var ssbFilename;var soundUrl;if(TSSSB.call("shouldAttachSoundToNotification")){var sound=TS.sounds.soundForName("new_message");if(sound){ssbFilename=sound.ssbFilename;soundUrl=sound.url}}else{TS.sounds.play("new_message")}TS.ui.growls.maybeBounceDockIcon();var title;var subtitle;if(TS.getOtherAccountsCount()>0&&(TS.ui.growls.canSpeak()||window.winssb)){if(TS.model.supports_growl_subtitle){title=TS.model.team.name;subtitle=from_name;if(msg._ignore_dnd)subtitle=from_name+" is trying to reach you"}else{title="["+TS.model.team.domain+"] from "+from_name;if(msg._ignore_dnd)title=from_name+" is trying to reach you"}}else{title="New message from "+from_name;if(msg._ignore_dnd)title=from_name+" is trying to reach you"}var avatar_image=TS.ui.growls.getProfileImageFromUserId(im.user);TS.ui.growls.show(title,TS.format.formatNotification(growl_txt,msg),onclick,{msg:msg,channelId:im.id,subtitle:subtitle,soundUrl:soundUrl,ssbFilename:ssbFilename,launchUri:TS.ui.growls.getLaunchUriForChannel(im.id,msg.ts),imageUri:TS.ui.growls.getAttachmentUri(msg),avatarImage:avatar_image});if(TS.model.prefs.speak_growls){TS.ui.growls.speakImMessage(im,msg,msg_txt)}},speakImMessage:function(im,msg,msg_txt){if(!TS.ui.growls.canSpeak())return;if(!msg){TS.error("no msg?");return}var bot_name=TS.templates.builders.getBotName(msg);msg_txt=msg_txt||TS.ui.growls.extractTxtFromMsg(msg,true);var from_name=bot_name||TS.ims.getDisplayNameOfUserForIm(im);var title;if(TS.getOtherAccountsCount()>0){title="On team "+TS.model.team.name+', a direct message from "'+from_name+'": '}else{title='DM message from "'+from_name+'": '}var spoken_txt=title+TS.format.formatNotification(msg_txt,msg);TS.ui.growls.speak(spoken_txt)},extractFromNameFromCorGMessage:function(msg){var member=TS.members.getMemberById(msg.user);return(member?TS.members.getMemberDisplayName(member):msg.user)||TS.templates.builders.getBotName(msg)||""},getProfileImageFromUserId:function(user_id){if(!user_id)return null;var user=TS.members.getMemberById(user_id);if(!user||!user.profile)return null;var avatar_image=user.profile.image_512||user.profile.image_192;if(avatar_image&&avatar_image.match(/^\//)){avatar_image="https://"+window.location.hostname+avatar_image}return avatar_image},extractTxtFromMsg:function(msg,obey_pref){if(obey_pref&&TS.model.prefs.no_text_in_notifications)return"";var msg_txt=msg.type+" "+msg.subtype+" (message missing text)";if(msg.text){msg_txt=msg.text}else if(msg.attachments&&msg.attachments.length){msg_txt=TS.ui.growls.getGrowlableTxtFromAttachments(msg.attachments)||msg_txt}return msg_txt},containsCmd:function(txt){var contains_everyone_cmd=txt&&TS.model.everyone_regex.test(txt);var contains_channel_cmd=txt&&TS.model.channel_regex.test(txt);var contains_group_cmd=txt&&TS.model.group_regex.test(txt);return contains_everyone_cmd||contains_channel_cmd||contains_group_cmd},windowFocusChanged:function(has_focus){if(has_focus){if((document.title.charAt(0)=="!"||document.title.charAt(0)=="*")&&TS.model.active_cid){document.title=document.title.slice(2)}}if(!has_focus&&TS.model.all_unread_highlights_cnt&&TS.model.prefs&&TS.model.prefs.mac_ssb_bounce=="long"){setTimeout(TS.ui.growls.maybeBounceDockIcon,100)}},maybeBounceDockIcon:function(){var ssb_api;if(window.macgap){ssb_api=window.macgap}else if(window.winssb&&TS.model.is_mac){ssb_api=window.winssb}if(!ssb_api)return;if(!ssb_api.dock)return;if(!TS.model.prefs.mac_ssb_bounce)return;if(TS.model.prefs.mac_ssb_bounce=="long"){if(ssb_api.dock.bounceIndefinitely)ssb_api.dock.bounceIndefinitely()}else{if(ssb_api.dock.bounceOnce)ssb_api.dock.bounceOnce()}}});var _ensureSubscriptionsForReplies=function(model_ob,msg){if(!TS.utility.msgs.isMsgReply(msg))return Promise.resolve();var subscription=TS.replies.getSubscriptionState(model_ob.id,msg.thread_ts);if(subscription)return Promise.resolve();return TS.replies.promiseToGetSubscriptionState(model_ob.id,msg.thread_ts).then(function(){subscription=TS.replies.getSubscriptionState(model_ob.id,msg.thread_ts);if(!subscription){throw new Error("promiseToGetSubscriptionState resolved but subscription is missing for "+msg.thread_ts)}})}})();(function(){"use strict";TS.registerModule("chat_history",{onStart:function(){TS.model.input_history=TS.storage.fetchInputHistory()},add:function(txt){if(TS.model.prefs&&!TS.model.prefs.arrow_history&&(!txt||txt.indexOf("/")!==0))return;var hist=TS.model.input_history;var i=hist.indexOf(txt);if(i!=-1){hist.splice(i,1)}if(hist.length&&hist[0]===""){hist.splice(0,1)}hist.unshift(txt);TS.storage.storeInputHistory(hist);TS.log(23,txt);TS.dir(23,hist)},resetPosition:function(why){TS.model.input_history_index=-1},onArrowKey:function(e,input){if(TS.model.prefs&&!TS.model.prefs.arrow_history)return;if(!TS.model.input_history.length)return;var txt=input.val();var hist_txt="";if(TS.model.input_history_index<0){TS.chat_history.add(txt);TS.model.input_history_index++}if(e.which==TS.utility.keymap.up){TS.model.input_history_index++;if(TS.model.input_history_index>=TS.model.input_history.length){TS.model.input_history_index=TS.model.input_history.length-1;return}}else if(e.which==TS.utility.keymap.down){TS.model.input_history_index--;if(TS.model.input_history_index<0){TS.model.input_history_index=-1;return}}else{return}hist_txt=TS.model.input_history[TS.model.input_history_index];e.preventDefault();TS.utility.populateInput(TS.client.ui.$msg_input,hist_txt);if(e.which==TS.utility.keymap.up){TS.utility.setCursorPosition(input,0)}else{var value=TS.utility.contenteditable.value(input);TS.utility.setCursorPosition(input,value.length)}}})})();(function(){"use strict";TS.registerModule("ui.paste",{catcher_div:null,onStart:function(){if(!window.Clipboard){TS.ui.paste.catcher_div=document.createElement("div");TS.ui.paste.catcher_div.setAttribute("contenteditable","");TS.ui.paste.catcher_div.setAttribute("class","offscreen");document.body.appendChild(TS.ui.paste.catcher_div)}var vKey=86;$(window.document).keydown(function(e){if(!TS.ui.paste.okToGo())return;if(TS.utility.cmdKey(e)&&e.which==vKey){if(!TS.ui.paste.catcher_div)return;if(e.altKey)return;if(!TS.utility.isFocusOnInput()){TS.ui.paste.catcher_div.focus()}}});$(window).bind("paste",TS.ui.paste.handler)},okToGo:function(){if(!TS.client.ui.$msg_input)return false;if(!TS.utility.isFocusOnInput()||document.activeElement==TS.client.ui.$msg_input[0]){return true}return false},handler:function(e){if(!TS.ui.paste.okToGo())return;TS.info("TS.ui.paste.handler");e=e.originalEvent||e;var immediate_upload=TS.model.shift_key_pressed;if(window.desktop&&window.desktop.app.getModifierKeys){var modifiers=window.desktop.app.getModifierKeys();immediate_upload=immediate_upload||modifiers&&modifiers.shift}var dont_make_snippet=true;if(!TS.model.is_FF&&e.clipboardData){TS.info("clipboardData!");TS.info(e.clipboardData.types);var i;var blob;var img_found=false;var items=e.clipboardData.items;var found_types={};if(items){for(i=0;i<items.length;i++){if(items[i]){found_types[items[i].type]=true}}for(i=0;i<items.length;i++){if(items[i].type.indexOf("image")!==-1){if(TS.model.is_mac&&found_types["text/plain"]&&found_types["text/html"]&&found_types["text/rtf"]){TS.info("Ignoring pasted image data, likely from Office/Word for Mac.")}else if(TS.model.is_win&&found_types["text/plain"]&&found_types["text/html"]&&found_types["image/png"]){TS.info("Ignoring pasted image data from Windows, which should render as text")}else{blob=items[i].getAsFile();e.preventDefault();if(blob!==null){TS.client.ui.file_pasted_sig.dispatch(blob,immediate_upload)}img_found=true}}}if(!img_found&&TS.client){if(immediate_upload&&!TS.model.insert_key_pressed&&!dont_make_snippet){setTimeout(TS.client.msg_input.startSnippet,100)}else if(!TS.utility.isFocusOnInput()){TS.view.focusMessageInput()}}}else{TS.warn("no clipboardData.items");var clipboard_types=e.clipboardData.types||[];for(i=0;i<clipboard_types.length;i++){if(clipboard_types[i]){found_types[clipboard_types[i]]=true}}var ssb_api=window.macgap||window.winssb;if(ssb_api&&ssb_api.clipboard&&ssb_api.clipboard.readImage){if(!found_types["text/rtf"]&&ssb_api.clipboard.readImage()){var paste_img=ssb_api.clipboard.readImage();TS.ui.paste.startUploadFromMacSSBReadImage(paste_img,immediate_upload);img_found=true;e.preventDefault()}}if(!img_found&&immediate_upload&&TS.client&&!TS.model.v_key_pressed&&!dont_make_snippet){setTimeout(TS.client.msg_input.startSnippet,100)}}}else{var types=e.clipboardData&&e.clipboardData.types;var pasted_text;if(types&&_.includes(types,"text/plain")){pasted_text=e.clipboardData.getData("text")}setTimeout(TS.ui.paste.checkCatcher,0,immediate_upload,pasted_text)}},startUploadFromMacSSBReadImage:function(str,immediate_upload){var canvas=document.getElementById("converter_canvas");if(!canvas){$("body").append('<canvas id="converter_canvas" class="offscreen"></canvas>');canvas=document.getElementById("converter_canvas")}var ctx=canvas.getContext("2d");var image=new Image;image.src="data:image/tiff;base64,"+str;image.onload=function(){canvas.width=image.width;canvas.height=image.height;ctx.clearRect(0,0,canvas.width,canvas.height);ctx.drawImage(image,0,0);var str=TS.utility.base64StrFromDataURI(canvas.toDataURL("image/png"));TS.client.ui.file_pasted_sig.dispatch(str,immediate_upload)}},checkCatcher:function(immediate_upload,pasted_text){var div=TS.ui.paste.catcher_div;if(!div)return;var child=div.childNodes[0];var current_str=TS.utility.contenteditable.value(TS.client.ui.$msg_input);var paste_str=pasted_text;if(!paste_str){paste_str="textContent"in div?div.textContent:div.innerText;paste_str=$.trim(paste_str)}var str;var range;var img_found=false;if(child){if(child.tagName==="IMG"){img_found=true;TS.client.ui.file_pasted_sig.dispatch(TS.utility.base64StrFromDataURI(child.src),immediate_upload)}else{if(current_str){range=TS.client.ui.$msg_input.getCursorRange();var l=range.l;var s=range.s;var str_start=current_str.substr(0,s);var str_end=current_str.substr(s+l);str=str_start+paste_str+str_end}else{str=paste_str}TS.client.msg_input.populate(str)}}div.innerHTML="";if(range){TS.client.ui.$msg_input.setCursorPosition(range.s+range.l+paste_str.length)}if(!img_found&&immediate_upload&&TS.client){}}})})();(function(){"use strict";TS.registerModule("ui.channel_prefs_dialog",{showing:false,onStart:function(){TS.prefs.push_changed_sig.add(_setPushNotificationRadioState);TS.prefs.dtop_notif_changed_sig.add(_setNotificationRadioState);TS.prefs.team_perms_pref_changed_sig.add(_teamPermsPrefChanged);TS.prefs.muted_channels_changed_sig.add(_setMutedCheckboxState)},start:function(c_id){if(!_div)_build();if(TS.ui.channel_prefs_dialog.showing)return;var model_ob=TS.shared.getModelObById(c_id);if(!model_ob||model_ob.is_im){alert(c_id+" ???");return}var c_or_g="";var display_name="";var is_mpim=false;if(model_ob.is_channel){c_or_g="channel";display_name="#"+model_ob.name}else if(model_ob.is_mpim){is_mpim=true;c_or_g="group";display_name=TS.mpims.getDisplayName(model_ob)}else if(model_ob.is_group){c_or_g="group";display_name=model_ob.name}_c_id=c_id;var html=TS.templates.channel_prefs_dialog({c_or_g:c_or_g,is_mpim:is_mpim,display_name:display_name,show_one_suppressed_cb:true,show_two_suppressed_cbs:false,is_muted:TS.notifs.isCorGMuted(c_id),model_ob:model_ob});_div.html(html);_setPushNotificationRadioState();_setNotificationRadioState();_setSuppressedCheckboxState();_setMutedCheckboxState();$("#notifications_not_working").addClass("hidden");$("#notifications_impossible").addClass("hidden");$("#notifications_not_yet_allowed").addClass("hidden");$("#notifications_not_enabled").addClass("hidden");$("#notifications_not_allowed").addClass("hidden");$("#notifications_working").removeClass("hidden");if(TS.ui.growls.shouldShowPermissionButton()){$("#notifications_working").addClass("hidden");$("#notifications_not_working").removeClass("hidden");$("#notifications_not_yet_allowed").removeClass("hidden")}else{if(!TS.ui.growls.checkPermission()){$("#notifications_working").addClass("hidden");$("#notifications_not_working").removeClass("hidden");if(TS.ui.growls.no_notifications){$("#notifications_impossible").removeClass("hidden")}else if(TS.ui.growls.getPermissionLevel()=="denied"){$("#notifications_not_allowed").removeClass("hidden")}}}_div.modal("show");_div.find(".dialog_cancel").click(_cancel);_div.find(".dialog_go").click(_go)},showMainPrefs:function(which){_cancel();setTimeout(function(){TS.ui.prefs_dialog.start(which)},500)}});var _div=null;var _c_id=null;var _onKeydown=function(e){if(!TS.ui.channel_prefs_dialog.showing)return;if(e.which==TS.utility.keymap.enter){if(TS.utility.getActiveElementProp("NODENAME")=="BODY"){_go();e.preventDefault()}}else if(e.which==TS.utility.keymap.esc){_cancel()}};var _teamPermsPrefChanged=function(pref_name){if(pref_name!="who_can_at_channel"&&pref_name!="who_can_at_everyone"&&pref_name!="who_can_post_general"){return}_setNotificationRadioState();_setPushNotificationRadioState();_setSuppressedCheckboxState()};var _setSuppressedCheckboxState=function(){if(!_c_id)return;var $cb=$("#single_suppressed_cb");var $label=$("#single_suppressed_label");var $disabled_explain=$("#single_suppressed_disabled_explain");var $container=$("#single_suppressed_div");var $tip_link=$("#single_suppressed_disabled_explain_tip_link");var is_suppressed=TS.notifs.hasUserSuppressedCorGChannelMentions(_c_id)||TS.notifs.hasUserSuppressedCorGPushChannelMentions(_c_id);var push_setting=TS.notifs.getCalculatedCorGPushNotifySetting(_c_id);var desktop_setting=TS.notifs.getCalculatedCorGNotifySetting(_c_id);var show_it=push_setting=="mentions"||desktop_setting=="mentions";_setSuppressedLabelState(is_suppressed,"both",show_it,$cb,$label,$disabled_explain,$container,$tip_link);if(!show_it)return;if(push_setting=="mentions"&&desktop_setting=="everything"){$("#single_suppressed_mobile_qualifier").removeClass("hidden");$("#single_suppressed_desktop_qualifier").addClass("hidden")}else if(desktop_setting=="mentions"&&push_setting=="everything"){$("#single_suppressed_desktop_qualifier").removeClass("hidden");$("#single_suppressed_mobile_qualifier").addClass("hidden")}else{$("#single_suppressed_desktop_qualifier").addClass("hidden");$("#single_suppressed_mobile_qualifier").addClass("hidden")}if(push_setting=="mentions"){$("#single_suppressed_mobile_disclaimer").removeClass("hidden")}else{$("#single_suppressed_mobile_disclaimer").addClass("hidden")}};var _setNotificationRadioState=function(){if(!_c_id)return;var setting=TS.notifs.getCalculatedCorGNotifySetting(_c_id);$("#all_everything_default").addClass("hidden");$("#all_mentions_default").addClass("hidden");$("#all_nothing_default").addClass("hidden");if(TS.model.prefs.growls_enabled&&TS.model.prefs.all_channels_loud){$("#all_everything_default").removeClass("hidden")}else if(TS.model.prefs.growls_enabled){$("#all_mentions_default").removeClass("hidden")}else{$("#all_nothing_default").removeClass("hidden")}$('input:radio[name="channel_loud_rd"]').filter('[value="'+setting+'"]').prop("checked",true);$('input:radio[name="channel_loud_rd"]').unbind("change").bind("change",function(){var val=$(this).val();if(val=="everything"){TS.notifs.makeCorGDTopEverything(_c_id)}else if(val=="mentions"){TS.notifs.makeCorGDTopMentions(_c_id)}else{TS.notifs.makeCorGDTopNothing(_c_id)}TS.prefs.setMultiPrefsByAPI({loud_channels:TS.model.loud_channels.join(","),never_channels:TS.model.never_channels.join(","),loud_channels_set:TS.model.loud_channels_set.join(",")});_setNotificationRadioState();_setSuppressedCheckboxState()});var $cb=$("#suppressed_cb");var $label=$("#suppressed_label");var $disabled_explain=$("#suppressed_disabled_explain");var $container=$("#suppressed_span");var $tip_link=$("#suppressed_disabled_explain_tip_link");var show_it=setting=="mentions";_setSuppressedLabelState(TS.notifs.hasUserSuppressedCorGChannelMentions(_c_id),"at_channel_suppressed_channels",show_it,$cb,$label,$disabled_explain,$container,$tip_link);_setSuppressedCheckboxState()};var _setSuppressedLabelState=function(is_suppressed,pref_name,show_it,$cb,$label,$disabled_explain,$container,$tip_link){if(!_c_id)return;if(show_it){$container.removeClass("hidden")}else{$container.addClass("hidden")}var model_ob=TS.channels.getChannelById(_c_id)||TS.groups.getGroupById(_c_id)||TS.mpims.getMpimById(_c_id);var prefs=TS.model.team.prefs;var suppressed_cb_disabled=false;if(prefs.who_can_at_channel=="admin"||prefs.who_can_at_channel=="owner"){suppressed_cb_disabled=true}else if(model_ob.is_general&&(prefs.who_can_at_everyone=="admin"||prefs.who_can_at_everyone=="owner"||prefs.who_can_post_general=="admin"||prefs.who_can_post_general=="owner")){suppressed_cb_disabled=true}if(suppressed_cb_disabled){$label.addClass("subtle_silver");$label.css("cursor","default");$disabled_explain.removeClass("hidden");$("#single_suppressed_mobile_disclaimer").addClass("hidden");$cb.prop("disabled",true);$cb.prop("checked",false);var c_or_g=_c_id.charAt(0)==="C"?"channel":"group";var tip_html;if(c_or_g=="group"){tip_html="A Team Owner has restricted the use of <b>@channel</b> to admins and/or owners, which renders you powerless to ignore those notifications."}else{if(model_ob.is_general){tip_html="A Team Owner has restricted who can post to general and/or restricted the use of <b>@channel</b> and/or <b>@everyone</b> to admins and/or owners, which renders you powerless to ignore those notifications.";
}else{tip_html="A Team Owner has restricted the use of <b>@channel</b> to admins and/or owners, which renders you powerless to ignore those notifications."}}$tip_link.tooltip("destroy").attr("title",tip_html).tooltip({html:true,container:"#channel_prefs_dialog"})}else{$label.removeClass("subtle_silver");$label.css("cursor","");$disabled_explain.addClass("hidden");$cb.prop("disabled",false);$cb.prop("checked",is_suppressed);$cb.unbind("change").bind("change",function(){var val=!!$(this).prop("checked");if(pref_name=="both"||pref_name=="at_channel_suppressed_channels"){if(val){TS.notifs.makeCorGSuppressed(_c_id)}else{TS.notifs.makeCorGNOTSuppressed(_c_id)}TS.prefs.setPrefByAPI({name:"at_channel_suppressed_channels",value:TS.model.at_channel_suppressed_channels.join(",")})}if(pref_name=="both"||pref_name=="push_at_channel_suppressed_channels"){if(val){TS.notifs.makeCorGPushSuppressed(_c_id)}else{TS.notifs.makeCorGNOTPushSuppressed(_c_id)}TS.prefs.setPrefByAPI({name:"push_at_channel_suppressed_channels",value:TS.model.push_at_channel_suppressed_channels.join(",")})}})}};var _setMutedCheckboxState=function(){if(!_c_id)return;var is_muted=TS.notifs.isCorGMuted(_c_id);var $cb=$("#muting_cb");var $non_muting_prefs=$("#non_muting_prefs");var $muting_info=$("#muting_info");$cb.prop("checked",is_muted);$cb.unbind("change").bind("change",function(){TS.notifs.muteOrUnmuteCorG(_c_id)});if(is_muted){$non_muting_prefs.slideUp(150);$muting_info.removeClass("hidden")}else{$non_muting_prefs.slideDown(150);$muting_info.addClass("hidden")}};var _setPushNotificationRadioState=function(){if(!_c_id)return;var setting=TS.notifs.getCalculatedCorGPushNotifySetting(_c_id);$("#all_push_everything_default").addClass("hidden");$("#all_push_mentions_default").addClass("hidden");$("#all_push_nothing_default").addClass("hidden");if(TS.model.prefs.push_everything){$("#all_push_everything_default").removeClass("hidden")}else if(TS.model.prefs.push_mention_alert){$("#all_push_mentions_default").removeClass("hidden")}else{$("#all_push_nothing_default").removeClass("hidden")}$('input:radio[name="channel_push_loud_rd"]').filter('[value="'+setting+'"]').prop("checked",true);$('input:radio[name="channel_push_loud_rd"]').unbind("change").bind("change",function(){var val=$(this).val();if(val=="everything"){TS.notifs.makeCorGPushEverything(_c_id)}else if(val=="mentions"){TS.notifs.makeCorGPushMentions(_c_id)}else{TS.notifs.makeCorGPushNothing(_c_id)}TS.prefs.setMultiPrefsByAPI({push_loud_channels:TS.model.push_loud_channels.join(","),push_mention_channels:TS.model.push_mention_channels.join(","),push_loud_channels_set:TS.model.push_loud_channels_set.join(",")});_setPushNotificationRadioState();_setSuppressedCheckboxState()});var $cb=$("#push_suppressed_cb");var $label=$("#push_suppressed_label");var $disabled_explain=$("#push_suppressed_disabled_explain");var $container=$("#push_suppressed_span");var $tip_link=$("#push_suppressed_disabled_explain_tip_link");var show_it=setting=="mentions";_setSuppressedLabelState(TS.notifs.hasUserSuppressedCorGPushChannelMentions(_c_id),"push_at_channel_suppressed_channels",show_it,$cb,$label,$disabled_explain,$container,$tip_link);_setSuppressedCheckboxState()};var _go=function(){if(!TS.ui.channel_prefs_dialog.showing){TS.error("not showing?");return}_div.modal("hide")};var _cancel=function(){_div.modal("hide")};var _end=function(){_c_id=null;TS.ui.channel_prefs_dialog.showing=TS.model.dialog_is_showing=false;$(window.document).unbind("keydown",_onKeydown)};var _build=function(){$("body").append('<div id="channel_prefs_dialog" class="modal hide fade"></div>');_div=$("#channel_prefs_dialog");_div.on("hide",function(e){if(e.target!=this)return;_end()});_div.on("show",function(e){if(e.target!=this)return;TS.ui.channel_prefs_dialog.showing=TS.model.dialog_is_showing=true});_div.on("shown",function(e){if(e.target!=this)return;setTimeout(function(){$(window.document).bind("keydown",_onKeydown)},100)})}})();(function(){var debug=false;var root=this;var EXIF=function(obj){if(obj instanceof EXIF)return obj;if(!(this instanceof EXIF))return new EXIF(obj);this.EXIFwrapped=obj};if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=EXIF}exports.EXIF=EXIF}else{root.EXIF=EXIF}var ExifTags=EXIF.Tags={36864:"ExifVersion",40960:"FlashpixVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",37121:"ComponentsConfiguration",37122:"CompressedBitsPerPixel",37500:"MakerNote",37510:"UserComment",40964:"RelatedSoundFile",36867:"DateTimeOriginal",36868:"DateTimeDigitized",37520:"SubsecTime",37521:"SubsecTimeOriginal",37522:"SubsecTimeDigitized",33434:"ExposureTime",33437:"FNumber",34850:"ExposureProgram",34852:"SpectralSensitivity",34855:"ISOSpeedRatings",34856:"OECF",37377:"ShutterSpeedValue",37378:"ApertureValue",37379:"BrightnessValue",37380:"ExposureBias",37381:"MaxApertureValue",37382:"SubjectDistance",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37396:"SubjectArea",37386:"FocalLength",41483:"FlashEnergy",41484:"SpatialFrequencyResponse",41486:"FocalPlaneXResolution",41487:"FocalPlaneYResolution",41488:"FocalPlaneResolutionUnit",41492:"SubjectLocation",41493:"ExposureIndex",41495:"SensingMethod",41728:"FileSource",41729:"SceneType",41730:"CFAPattern",41985:"CustomRendered",41986:"ExposureMode",41987:"WhiteBalance",41988:"DigitalZoomRation",41989:"FocalLengthIn35mmFilm",41990:"SceneCaptureType",41991:"GainControl",41992:"Contrast",41993:"Saturation",41994:"Sharpness",41995:"DeviceSettingDescription",41996:"SubjectDistanceRange",40965:"InteroperabilityIFDPointer",42016:"ImageUniqueID"};var TiffTags=EXIF.TiffTags={256:"ImageWidth",257:"ImageHeight",34665:"ExifIFDPointer",34853:"GPSInfoIFDPointer",40965:"InteroperabilityIFDPointer",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",274:"Orientation",277:"SamplesPerPixel",284:"PlanarConfiguration",530:"YCbCrSubSampling",531:"YCbCrPositioning",282:"XResolution",283:"YResolution",296:"ResolutionUnit",273:"StripOffsets",278:"RowsPerStrip",279:"StripByteCounts",513:"JPEGInterchangeFormat",514:"JPEGInterchangeFormatLength",301:"TransferFunction",318:"WhitePoint",319:"PrimaryChromaticities",529:"YCbCrCoefficients",532:"ReferenceBlackWhite",306:"DateTime",270:"ImageDescription",271:"Make",272:"Model",305:"Software",315:"Artist",33432:"Copyright"};var GPSTags=EXIF.GPSTags={0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude",5:"GPSAltitudeRef",6:"GPSAltitude",7:"GPSTimeStamp",8:"GPSSatellites",9:"GPSStatus",10:"GPSMeasureMode",11:"GPSDOP",12:"GPSSpeedRef",13:"GPSSpeed",14:"GPSTrackRef",15:"GPSTrack",16:"GPSImgDirectionRef",17:"GPSImgDirection",18:"GPSMapDatum",19:"GPSDestLatitudeRef",20:"GPSDestLatitude",21:"GPSDestLongitudeRef",22:"GPSDestLongitude",23:"GPSDestBearingRef",24:"GPSDestBearing",25:"GPSDestDistanceRef",26:"GPSDestDistance",27:"GPSProcessingMethod",28:"GPSAreaInformation",29:"GPSDateStamp",30:"GPSDifferential"};var StringValues=EXIF.StringValues={ExposureProgram:{0:"Not defined",1:"Manual",2:"Normal program",3:"Aperture priority",4:"Shutter priority",5:"Creative program",6:"Action program",7:"Portrait mode",8:"Landscape mode"},MeteringMode:{0:"Unknown",1:"Average",2:"CenterWeightedAverage",3:"Spot",4:"MultiSpot",5:"Pattern",6:"Partial",255:"Other"},LightSource:{0:"Unknown",1:"Daylight",2:"Fluorescent",3:"Tungsten (incandescent light)",4:"Flash",9:"Fine weather",10:"Cloudy weather",11:"Shade",12:"Daylight fluorescent (D 5700 - 7100K)",13:"Day white fluorescent (N 4600 - 5400K)",14:"Cool white fluorescent (W 3900 - 4500K)",15:"White fluorescent (WW 3200 - 3700K)",17:"Standard light A",18:"Standard light B",19:"Standard light C",20:"D55",21:"D65",22:"D75",23:"D50",24:"ISO studio tungsten",255:"Other"},Flash:{0:"Flash did not fire",1:"Flash fired",5:"Strobe return light not detected",7:"Strobe return light detected",9:"Flash fired, compulsory flash mode",13:"Flash fired, compulsory flash mode, return light not detected",15:"Flash fired, compulsory flash mode, return light detected",16:"Flash did not fire, compulsory flash mode",24:"Flash did not fire, auto mode",25:"Flash fired, auto mode",29:"Flash fired, auto mode, return light not detected",31:"Flash fired, auto mode, return light detected",32:"No flash function",65:"Flash fired, red-eye reduction mode",69:"Flash fired, red-eye reduction mode, return light not detected",71:"Flash fired, red-eye reduction mode, return light detected",73:"Flash fired, compulsory flash mode, red-eye reduction mode",77:"Flash fired, compulsory flash mode, red-eye reduction mode, return light not detected",79:"Flash fired, compulsory flash mode, red-eye reduction mode, return light detected",89:"Flash fired, auto mode, red-eye reduction mode",93:"Flash fired, auto mode, return light not detected, red-eye reduction mode",95:"Flash fired, auto mode, return light detected, red-eye reduction mode"},SensingMethod:{1:"Not defined",2:"One-chip color area sensor",3:"Two-chip color area sensor",4:"Three-chip color area sensor",5:"Color sequential area sensor",7:"Trilinear sensor",8:"Color sequential linear sensor"},SceneCaptureType:{0:"Standard",1:"Landscape",2:"Portrait",3:"Night scene"},SceneType:{1:"Directly photographed"},CustomRendered:{0:"Normal process",1:"Custom process"},WhiteBalance:{0:"Auto white balance",1:"Manual white balance"},GainControl:{0:"None",1:"Low gain up",2:"High gain up",3:"Low gain down",4:"High gain down"},Contrast:{0:"Normal",1:"Soft",2:"Hard"},Saturation:{0:"Normal",1:"Low saturation",2:"High saturation"},Sharpness:{0:"Normal",1:"Soft",2:"Hard"},SubjectDistanceRange:{0:"Unknown",1:"Macro",2:"Close view",3:"Distant view"},FileSource:{3:"DSC"},Components:{0:"",1:"Y",2:"Cb",3:"Cr",4:"R",5:"G",6:"B"}};function addEvent(element,event,handler){if(element.addEventListener){element.addEventListener(event,handler,false)}else if(element.attachEvent){element.attachEvent("on"+event,handler)}}function imageHasData(img){return!!img.exifdata}function base64ToArrayBuffer(base64,contentType){contentType=contentType||base64.match(/^data\:([^\;]+)\;base64,/im)[1]||"";base64=base64.replace(/^data\:([^\;]+)\;base64,/gim,"");var binary=atob(base64);var len=binary.length;var buffer=new ArrayBuffer(len);var view=new Uint8Array(buffer);for(var i=0;i<len;i++){view[i]=binary.charCodeAt(i)}return buffer}function objectURLToBlob(url,callback){var http=new XMLHttpRequest;http.open("GET",url,true);http.responseType="blob";http.onload=function(e){if(this.status==200||this.status===0){callback(this.response)}};http.send()}function getImageData(img,callback){function handleBinaryFile(binFile){var data=findEXIFinJPEG(binFile);var iptcdata=findIPTCinJPEG(binFile);img.exifdata=data||{};img.iptcdata=iptcdata||{};if(callback){callback.call(img)}}if(img.src){if(/^data\:/i.test(img.src)){var arrayBuffer=base64ToArrayBuffer(img.src);handleBinaryFile(arrayBuffer)}else if(/^blob\:/i.test(img.src)){var fileReader=new FileReader;fileReader.onload=function(e){handleBinaryFile(e.target.result)};objectURLToBlob(img.src,function(blob){fileReader.readAsArrayBuffer(blob)})}else{var http=new XMLHttpRequest;http.onload=function(){if(this.status==200||this.status===0){handleBinaryFile(http.response)}else{throw"Could not load image"}http=null};http.open("GET",img.src,true);http.responseType="arraybuffer";http.send(null)}}else if(window.FileReader&&(img instanceof window.Blob||img instanceof window.File)){var fileReader=new FileReader;fileReader.onload=function(e){if(debug)console.log("Got file of length "+e.target.result.byteLength);handleBinaryFile(e.target.result)};fileReader.readAsArrayBuffer(img)}}function findEXIFinJPEG(file){var dataView=new DataView(file);if(debug)console.log("Got file of length "+file.byteLength);if(dataView.getUint8(0)!=255||dataView.getUint8(1)!=216){if(debug)console.log("Not a valid JPEG");return false}var offset=2,length=file.byteLength,marker;while(offset<length){if(dataView.getUint8(offset)!=255){if(debug)console.log("Not a valid marker at offset "+offset+", found: "+dataView.getUint8(offset));return false}marker=dataView.getUint8(offset+1);if(debug)console.log(marker);if(marker==225){if(debug)console.log("Found 0xFFE1 marker");return readEXIFData(dataView,offset+4,dataView.getUint16(offset+2)-2)}else{offset+=2+dataView.getUint16(offset+2)}}}function findIPTCinJPEG(file){var dataView=new DataView(file);if(debug)console.log("Got file of length "+file.byteLength);if(dataView.getUint8(0)!=255||dataView.getUint8(1)!=216){if(debug)console.log("Not a valid JPEG");return false}var offset=2,length=file.byteLength;var isFieldSegmentStart=function(dataView,offset){return dataView.getUint8(offset)===56&&dataView.getUint8(offset+1)===66&&dataView.getUint8(offset+2)===73&&dataView.getUint8(offset+3)===77&&dataView.getUint8(offset+4)===4&&dataView.getUint8(offset+5)===4};while(offset<length){if(isFieldSegmentStart(dataView,offset)){var nameHeaderLength=dataView.getUint8(offset+7);if(nameHeaderLength%2!==0)nameHeaderLength+=1;if(nameHeaderLength===0){nameHeaderLength=4}var startOffset=offset+8+nameHeaderLength;var sectionLength=dataView.getUint16(offset+6+nameHeaderLength);return readIPTCData(file,startOffset,sectionLength);break}offset++}}var IptcFieldMap={120:"caption",110:"credit",25:"keywords",55:"dateCreated",80:"byline",85:"bylineTitle",122:"captionWriter",105:"headline",116:"copyright",15:"category"};function readIPTCData(file,startOffset,sectionLength){var dataView=new DataView(file);var data={};var fieldValue,fieldName,dataSize,segmentType,segmentSize;var segmentStartPos=startOffset;while(segmentStartPos<startOffset+sectionLength){if(dataView.getUint8(segmentStartPos)===28&&dataView.getUint8(segmentStartPos+1)===2){segmentType=dataView.getUint8(segmentStartPos+2);if(segmentType in IptcFieldMap){dataSize=dataView.getInt16(segmentStartPos+3);segmentSize=dataSize+5;fieldName=IptcFieldMap[segmentType];fieldValue=getStringFromDB(dataView,segmentStartPos+5,dataSize);if(data.hasOwnProperty(fieldName)){if(data[fieldName]instanceof Array){data[fieldName].push(fieldValue)}else{data[fieldName]=[data[fieldName],fieldValue]}}else{data[fieldName]=fieldValue}}}segmentStartPos++}return data}function readTags(file,tiffStart,dirStart,strings,bigEnd){var entries=file.getUint16(dirStart,!bigEnd),tags={},entryOffset,tag,i;for(i=0;i<entries;i++){entryOffset=dirStart+i*12+2;tag=strings[file.getUint16(entryOffset,!bigEnd)];if(!tag&&debug)console.log("Unknown tag: "+file.getUint16(entryOffset,!bigEnd));tags[tag]=readTagValue(file,entryOffset,tiffStart,dirStart,bigEnd)}return tags}function readTagValue(file,entryOffset,tiffStart,dirStart,bigEnd){var type=file.getUint16(entryOffset+2,!bigEnd),numValues=file.getUint32(entryOffset+4,!bigEnd),valueOffset=file.getUint32(entryOffset+8,!bigEnd)+tiffStart,offset,vals,val,n,numerator,denominator;switch(type){case 1:case 7:if(numValues==1){return file.getUint8(entryOffset+8,!bigEnd)}else{offset=numValues>4?valueOffset:entryOffset+8;vals=[];for(n=0;n<numValues;n++){vals[n]=file.getUint8(offset+n)}return vals}case 2:offset=numValues>4?valueOffset:entryOffset+8;return getStringFromDB(file,offset,numValues-1);case 3:if(numValues==1){return file.getUint16(entryOffset+8,!bigEnd)}else{offset=numValues>2?valueOffset:entryOffset+8;vals=[];for(n=0;n<numValues;n++){vals[n]=file.getUint16(offset+2*n,!bigEnd)}return vals}case 4:if(numValues==1){return file.getUint32(entryOffset+8,!bigEnd)}else{vals=[];for(n=0;n<numValues;n++){vals[n]=file.getUint32(valueOffset+4*n,!bigEnd)}return vals}case 5:if(numValues==1){numerator=file.getUint32(valueOffset,!bigEnd);denominator=file.getUint32(valueOffset+4,!bigEnd);val=new Number(numerator/denominator);val.numerator=numerator;val.denominator=denominator;return val}else{vals=[];for(n=0;n<numValues;n++){numerator=file.getUint32(valueOffset+8*n,!bigEnd);denominator=file.getUint32(valueOffset+4+8*n,!bigEnd);vals[n]=new Number(numerator/denominator);vals[n].numerator=numerator;vals[n].denominator=denominator}return vals}case 9:if(numValues==1){return file.getInt32(entryOffset+8,!bigEnd)}else{vals=[];for(n=0;n<numValues;n++){vals[n]=file.getInt32(valueOffset+4*n,!bigEnd)}return vals}case 10:if(numValues==1){return file.getInt32(valueOffset,!bigEnd)/file.getInt32(valueOffset+4,!bigEnd)}else{vals=[];for(n=0;n<numValues;n++){vals[n]=file.getInt32(valueOffset+8*n,!bigEnd)/file.getInt32(valueOffset+4+8*n,!bigEnd)}return vals}}}function getStringFromDB(buffer,start,length){var outstr="";for(n=start;n<start+length;n++){outstr+=String.fromCharCode(buffer.getUint8(n))}return outstr}function readEXIFData(file,start){if(getStringFromDB(file,start,4)!="Exif"){if(debug)console.log("Not valid EXIF data! "+getStringFromDB(file,start,4));return false}var bigEnd,tags,tag,exifData,gpsData,tiffOffset=start+6;if(file.getUint16(tiffOffset)==18761){bigEnd=false}else if(file.getUint16(tiffOffset)==19789){bigEnd=true}else{if(debug)console.log("Not valid TIFF data! (no 0x4949 or 0x4D4D)");return false}if(file.getUint16(tiffOffset+2,!bigEnd)!=42){if(debug)console.log("Not valid TIFF data! (no 0x002A)");return false}var firstIFDOffset=file.getUint32(tiffOffset+4,!bigEnd);if(firstIFDOffset<8){if(debug)console.log("Not valid TIFF data! (First offset less than 8)",file.getUint32(tiffOffset+4,!bigEnd));return false}tags=readTags(file,tiffOffset,tiffOffset+firstIFDOffset,TiffTags,bigEnd);if(tags.ExifIFDPointer){exifData=readTags(file,tiffOffset,tiffOffset+tags.ExifIFDPointer,ExifTags,bigEnd);for(tag in exifData){switch(tag){case"LightSource":case"Flash":case"MeteringMode":case"ExposureProgram":case"SensingMethod":case"SceneCaptureType":case"SceneType":case"CustomRendered":case"WhiteBalance":case"GainControl":case"Contrast":case"Saturation":case"Sharpness":case"SubjectDistanceRange":case"FileSource":exifData[tag]=StringValues[tag][exifData[tag]];break;case"ExifVersion":case"FlashpixVersion":exifData[tag]=String.fromCharCode(exifData[tag][0],exifData[tag][1],exifData[tag][2],exifData[tag][3]);break;case"ComponentsConfiguration":exifData[tag]=StringValues.Components[exifData[tag][0]]+StringValues.Components[exifData[tag][1]]+StringValues.Components[exifData[tag][2]]+StringValues.Components[exifData[tag][3]];break}tags[tag]=exifData[tag]}}if(tags.GPSInfoIFDPointer){gpsData=readTags(file,tiffOffset,tiffOffset+tags.GPSInfoIFDPointer,GPSTags,bigEnd);for(tag in gpsData){switch(tag){case"GPSVersionID":gpsData[tag]=gpsData[tag][0]+"."+gpsData[tag][1]+"."+gpsData[tag][2]+"."+gpsData[tag][3];break}tags[tag]=gpsData[tag]}}return tags}EXIF.getData=function(img,callback){if((img instanceof Image||img instanceof HTMLImageElement)&&!img.complete)return false;if(!imageHasData(img)){getImageData(img,callback)}else{if(callback){callback.call(img)}}return true};EXIF.getTag=function(img,tag){if(!imageHasData(img))return;return img.exifdata[tag]};EXIF.getAllTags=function(img){if(!imageHasData(img))return{};var a,data=img.exifdata,tags={};for(a in data){if(data.hasOwnProperty(a)){tags[a]=data[a]}}return tags};EXIF.pretty=function(img){if(!imageHasData(img))return"";var a,data=img.exifdata,strPretty="";for(a in data){if(data.hasOwnProperty(a)){if(typeof data[a]=="object"){if(data[a]instanceof Number){strPretty+=a+" : "+data[a]+" ["+data[a].numerator+"/"+data[a].denominator+"]\r\n"}else{strPretty+=a+" : ["+data[a].length+" values]\r\n"}}else{strPretty+=a+" : "+data[a]+"\r\n"}}}return strPretty};EXIF.readFromBinaryFile=function(file){return findEXIFinJPEG(file)};if(typeof define==="function"&&define.amd){define("exif-js",[],function(){return EXIF})}}).call(this);(function(){"use strict";TS.registerModule("ui.upload_dialog",{div:null,filesQ:[],file:null,showing:false,last_share_cb_checked:null,selection:null,onStart:function(){},onKeydown:function(e){if(!TS.ui.upload_dialog.showing)return;if(e.which==TS.utility.keymap.enter){if(TS.utility.getActiveElementProp("NODENAME")!="TEXTAREA"){TS.ui.upload_dialog.go();e.preventDefault()}}else if(e.which==TS.utility.keymap.esc){}else if(e.which==TS.utility.keymap.tab){if($(document.activeElement).hasClass("dialog_go")){e.preventDefault();TS.ui.upload_dialog.div.find("[tabindex]").first().focus()}}},start:function(files){if(!files||!files.length){TS.info("no files");return}var added_cnt=0;var file;for(var i=0;i<files.length;i++){file=files[i];if(file.size>TS.model.upload_file_size_limit_bytes){continue}added_cnt++;TS.ui.upload_dialog.filesQ.push(file)}if(added_cnt<files.length){var alert_txt="";if(files.length==1){alert_txt="That file is too large and cannot be uploaded. The limit is "+TS.utility.convertFilesize(TS.model.upload_file_size_limit_bytes)+"."}else if(!added_cnt){alert_txt="All of those file are too large and cannot be uploaded. The limit is "+TS.utility.convertFilesize(TS.model.upload_file_size_limit_bytes)+"."}else{alert_txt="We'll upload what we can, but one or more of those files is too large and cannot be uploaded. The limit is "+TS.utility.convertFilesize(TS.model.upload_file_size_limit_bytes)+"."}alert(alert_txt)}if(!added_cnt)return;if(!TS.ui.upload_dialog.div)TS.ui.upload_dialog.build();if(!TS.ui.upload_dialog.showing){TS.ui.upload_dialog.pullFromQ(true)}},startWithCommentFromChatInput:function(files){_text_from_input=TS.utility.contenteditable.value(TS.client.ui.$msg_input);TS.ui.upload_dialog.start(files);TS.view.clearMessageInput()},pullFromQ:function(first){if(TS.ui.upload_dialog.filesQ.length){TS.ui.upload_dialog._startWithFile(TS.ui.upload_dialog.filesQ.shift(),first);return true}if(TS.client.ui.resetFiles){TS.client.ui.resetFiles()}else if(console&&console.warn){console.warn("TS.client.ui.resetFiles undefined")}return false},_startWithFile:function(file,first){_submitting=false;TS.ui.upload_dialog.file=file;var html=TS.templates.file_upload_dialog({filename:TS.files.makeFileNameFromFile(file),title:_initialTitle(file),has_name:!!file.name,sharing_html:TS.templates.builders.buildFileSharingControls(file,null,_initialComment(),null,TS.ui.upload_dialog.selection),over_storage_limit:TS.model.team.over_storage_limit,more_in_queue:TS.ui.upload_dialog.filesQ.length>0,file_retention_type:parseInt(TS.model.team.prefs.file_retention_type),file_retention_duration:TS.utility.date.daysToYearsPretty(TS.model.team.prefs.file_retention_duration)});var div=TS.ui.upload_dialog.div;div.html(html);var displayImg=function(str){$("#upload_image_preview").removeClass("hidden").find("img").attr("src",str)};if(typeof file=="string"){displayImg("data:image/png;base64,"+file)}else{if(window.FileReader){try{if(EXIF){var exif_reader=new FileReader;exif_reader.onload=function(e){var exif=EXIF.readFromBinaryFile(e.target.result);if(exif.Orientation&&typeof exif.Orientation==="number"&&exif.Orientation!==1){$("#upload_image_preview").find("img").addClass("orientation_"+exif.Orientation)}};exif_reader.readAsArrayBuffer(file)}var reader=new FileReader;reader.onload=function(e){var str=e.target.result;if(str.indexOf("data:image/")!==0)return;displayImg(str)};reader.onloadstart=function(e){if(e.total>1024*1024*32){TS.info("skipping image preview for large file: "+e.total);reader.abort()}};reader.readAsDataURL(file)}catch(err){TS.info(err)}}}var $file_comment_textarea=$("#file_comment_textarea");TS.ui.comments.bindInput($file_comment_textarea,TS.ui.upload_dialog.go);$file_comment_textarea.autogrow();$file_comment_textarea=null;var already_showing=TS.ui.upload_dialog.showing;div.modal("show");if(TS.ui.upload_dialog.filesQ.length){div.find(".file_count").text(" (and "+TS.ui.upload_dialog.filesQ.length+" more...)")}if(first){div.find("#share_cb").prop("checked",true)}else{div.find("#share_cb").prop("checked",TS.ui.upload_dialog.last_share_cb_checked===true)}div.find(".modal-header > .close").click(_closeModal);div.find(".dialog_cancel_all").click(TS.ui.upload_dialog.cancelAll);div.find(".dialog_cancel").click(TS.ui.upload_dialog.cancel);div.find(".dialog_go").click(TS.ui.upload_dialog.go);TS.ui.file_share.bindFileShareDropdowns();TS.ui.file_share.bindFileShareShareToggle();TS.ui.file_share.bindFileShareCommentField();var data_key="TS-lazyFilterSelect";if(!first&&TS.ui.upload_dialog.selection){div.find("#select_share_channels").data(data_key).instance.setValue(TS.ui.upload_dialog.selection)}TS.ui.upload_dialog.div.find(".lfs_input_container").attr("tabindex","2");TS.ui.upload_dialog.div.find("#select_share_channels").data(data_key).instance.onKeyDown=function(e){if(e.which==TS.utility.keymap.tab){e.preventDefault();if(e.shiftKey){div.find("#share_cb").focus()}else{div.find("#file_comment_textarea").focus()}}};if(already_showing){_setFocusOnInput(div)}},go:function(){if(_submitting){TS.info("TS.ui.upload_dialog.go stopped because already uploading");return false}if(!TS.ui.upload_dialog.showing){TS.error("not showing?");return}if(!TS.ui.upload_dialog.file){TS.error("no file?");return}if(TS.ui.file_share.shouldBlockUploadDialogSubmission())return;var div=TS.ui.upload_dialog.div;var do_share=!!div.find("#share_cb").prop("checked");TS.ui.upload_dialog.last_share_cb_checked=!!do_share;TS.ui.upload_dialog.selection=$("#share_model_ob_id").val();var share_channels=do_share?TS.ui.upload_dialog.selection:null;var initial_comment=TS.format.cleanMsg($("#file_comment_textarea").val());if($.trim(initial_comment)==="")initial_comment="";var filename=div.find(".filename_input").val();var title=div.find(".title_input").val();if(TS.ui.upload_dialog.file.is_dropbox||TS.ui.upload_dialog.file.is_box){var link=TS.ui.upload_dialog.file.link;TS.shared.getShareModelObId(share_channels,function(model_ob_id){TS.files.upload({link:link,filename:filename,title:title,channels:model_ob_id,initial_comment:initial_comment,is_dropbox:TS.ui.upload_dialog.file.is_dropbox,is_box:TS.ui.upload_dialog.file.is_box});_switchToSharedInChannel(share_channels)})}else{var file=TS.ui.upload_dialog.file;TS.shared.getShareModelObId(share_channels,function(model_ob_id){TS.files.upload({file:file,filename:filename,title:title,channels:model_ob_id,initial_comment:initial_comment});_switchToSharedInChannel(share_channels)})}_submitting=true;TS.ui.upload_dialog.maybeGoAway()},maybeGoAway:function(){_text_from_input="";if(!TS.ui.upload_dialog.pullFromQ()){TS.ui.upload_dialog.div.modal("hide");TS.ui.upload_dialog.selection=null;return true}return false},cancel:function(){TS.ui.upload_dialog.selection=$("#share_model_ob_id").val();var text_from_input=_text_from_input;var went_away=TS.ui.upload_dialog.maybeGoAway();if(text_from_input){TS.client.msg_input.populate(text_from_input)}if(went_away&&text_from_input){setTimeout(TS.view.focusMessageInput,10)}},cancelAll:function(){TS.ui.upload_dialog.filesQ=[];TS.ui.upload_dialog.cancel()},end:function(){TS.ui.upload_dialog.showing=TS.model.dialog_is_showing=false;TS.ui.upload_dialog.file=null;_text_from_input="";TS.ui.comments.unbindInput($("#file_comment_textarea"));TS.ui.upload_dialog.div.empty();$(window.document).unbind("keydown",TS.ui.upload_dialog.onKeydown)},build:function(){$("body").append('<div id="upload_dialog" class="modal hide fade" data-keyboard="false" data-backdrop="static"></div>');var div=TS.ui.upload_dialog.div=$("#upload_dialog");div.on("hidden",function(e){if(e.target!=this)return;TS.ui.upload_dialog.end()});div.on("show",function(e){if(e.target!=this)return;TS.ui.upload_dialog.showing=TS.model.dialog_is_showing=true});div.on("shown",function(e){if(e.target!=this)return;setTimeout(function(){_setFocusOnInput(div);$(window.document).bind("keydown",TS.ui.upload_dialog.onKeydown)},100)})}});var _text_from_input="";var _max_chars_to_pre_fill_title=50;var _submitting=false;var _setFocusOnInput=function(div){if(_text_from_input&&_text_from_input.length>_max_chars_to_pre_fill_title){div.find("#file_comment_textarea").focus().select()}else{div.find("#upload_file_title").focus().select()}};var _initialTitle=function(file){if(_text_from_input&&_text_from_input.length<=_max_chars_to_pre_fill_title){return _text_from_input}return TS.files.makeFileTitleFromFile(file)};var _initialComment=function(){if(_text_from_input&&_text_from_input.length>_max_chars_to_pre_fill_title){return _text_from_input}return""};var _closeModal=function(e){e.preventDefault();TS.ui.upload_dialog.cancelAll()};var _switchToSharedInChannel=function(share_channels){if(TS.channels.getChannelById(share_channels)){TS.channels.displayChannel(share_channels)}else if(TS.ims.getImByMemberId(share_channels)){TS.ims.startImByMemberId(share_channels)}else if(TS.mpims.getMpimById(share_channels)){TS.mpims.displayMpim(share_channels)}else if(TS.groups.getGroupById(share_channels)){TS.groups.displayGroup(share_channels)}else{TS.error("no valid shared channel/im/mpim/group to display")}}})();(function(){"use strict";TS.registerModule("ui.snippet_dialog",{editor:null,text_from_input:null,edit_file_id:null,div:null,showing:false,onStart:function(){},startCreate:function(text,prompted){if(TS.ui.snippet_dialog.showing)return;TS.ui.snippet_dialog.showing=true;TS.ui.snippet_dialog.text_from_input=text||null;TS.ui.snippet_dialog.edit_file_id=null;TS.ui.snippet_dialog.start(text,null,TS.model.prefs.last_snippet_type||"text")},startEdit:function(file_id){if(TS.ui.snippet_dialog.showing)return;var file=TS.files.getFileById(file_id);if(!file)return;TS.files.fetchFileInfo(file_id,function(id,file){TS.ui.snippet_dialog.edit_file_id=file_id;TS.ui.snippet_dialog.text_from_input=null;TS.ui.snippet_dialog.start(file.content,file.title,file.filetype)})},start:function(text,title,filetype){_current_text=text||"";_current_title=title||"";_current_filetype=filetype||"";if(!window.CodeMirror){if(_loading_scripts){}else{_loading_scripts=true;TS.utility.getCachedScript(cdn_url+"/cb0fd/js/libs/codemirror.js").done(function(){TS.utility.getCachedScript(cdn_url+"/7adb/js/libs/codemirror/addon/simple.js").done(function(){TS.utility.getCachedScript(cdn_url+"/8df80/js/codemirror_load.js").done(function(){TS.ui.snippet_dialog.start(text,title,filetype)})})})}return}if(!TS.ui.snippet_dialog.div)TS.ui.snippet_dialog.build();var template_args={codemirror_types:TS.boot_data.codemirror_types,wrap_lines:TS.model.prefs.snippet_editor_wrap_long_lines};if(TS.ui.snippet_dialog.edit_file_id){template_args["mode"]="Edit"}else{template_args["mode"]="Create";template_args["sharing_html"]=TS.templates.builders.buildFileSharingControls()}var html=TS.templates.snippet_dialog(template_args);var div=TS.ui.snippet_dialog.div;div.html(html);div.modal("show");div.find(".modal-footer-action > .cancel, .modal-header > .close").click(TS.ui.snippet_dialog.cancelPrompt);div.find(".dialog_cancel").click(TS.ui.snippet_dialog.cancel);div.find(".dialog_cancel_decline").click(TS.ui.snippet_dialog.cancelDecline);div.find(".dialog_go").click(TS.ui.snippet_dialog.go);TS.ui.snippet_dialog.editor=CodeMirror.fromTextArea(document.getElementById("client_file_snippet_textarea"),{lineNumbers:true,matchBrackets:true,indentUnit:4,indentWithTabs:true,enterMode:"keep",tabMode:"shift",viewportMargin:10,autofocus:false,lineWrapping:TS.model.prefs.snippet_editor_wrap_long_lines});$("#client_file_snippet_select").change(function(evt){CodeMirror.switchSlackMode(TS.ui.snippet_dialog.editor,$(this).val());TS.prefs.setPrefByAPI({name:"last_snippet_type",value:$(this).val()})}).change();$("#client_file_wrap_cb").bind("change",function(e){var wrap=$(this).is(":checked");TS.ui.snippet_dialog.editor.setOption("lineWrapping",wrap);TS.prefs.setPrefByAPI({name:"snippet_editor_wrap_long_lines",value:wrap})});var focus_title=false;if(TS.ui.snippet_dialog.edit_file_id){TS.ui.snippet_dialog.editor.setValue(text);if(title){title=TS.format.unFormatMsg(title)}$("#client_file_snippet_title_input").val(title||"")}else{TS.ui.snippet_dialog.editor.setValue(text||"");$("#client_file_snippet_title_input").val("");TS.ui.file_share.bindFileShareDropdowns();TS.ui.file_share.bindFileShareShareToggle();TS.ui.file_share.bindFileShareCommentField();focus_title=!!text}var $file_comment_textarea=$("#file_comment_textarea");TS.ui.comments.bindInput($file_comment_textarea,TS.ui.snippet_dialog.go);
$file_comment_textarea.autogrow();$("#client_file_snippet_select").val(filetype).trigger("change");setTimeout(function(){if(focus_title){$("#client_file_snippet_title_input").focus()}else{TS.ui.snippet_dialog.editor.focus()}TS.ui.snippet_dialog.editor.refresh()},350);$(window.document).on("keydown",TS.ui.snippet_dialog.onKeyDown);$(window.document).on("keyup",_showSaveSnippetTip);TS.ui.snippet_dialog.editor.on("change",_showSaveSnippetTip)},go:function(){if(!TS.ui.snippet_dialog.showing){TS.error("not showing?");return}var val=TS.ui.snippet_dialog.editor.getValue();if(!$.trim(val)){return}if(TS.ui.file_share.shouldBlockUploadDialogSubmission())return;if(TS.ui.snippet_dialog.edit_file_id){TS.api.call("files.edit",{file:TS.ui.snippet_dialog.edit_file_id,title:$("#client_file_snippet_title_input").val(),content:val,filetype:$("#client_file_snippet_select").val()})}else{var do_share=!!$("#share_cb").prop("checked");var share_channels=do_share?$("#share_model_ob_id").val():null;var initial_comment=TS.format.cleanMsg($("#file_comment_textarea").val());var title=$("#client_file_snippet_title_input").val();var filetype=$("#client_file_snippet_select").val();if($.trim(initial_comment)==="")initial_comment="";TS.shared.getShareModelObId(share_channels,function(model_ob_id){TS.files.upload({text:val,title:title,filetype:filetype,channels:model_ob_id,initial_comment:initial_comment});if(TS.client){var model_ob=TS.shared.getModelObById(model_ob_id);if(!model_ob)return;TS.client.displayModelOb(model_ob)}})}TS.ui.snippet_dialog.div.modal("hide");TS.ui.snippet_dialog.end()},cancelPrompt:function(e){if(e){e.preventDefault();e.stopPropagation()}var dialog=TS.ui.snippet_dialog;var title_val=$("#client_file_snippet_title_input").val();var snippet_val=TS.ui.snippet_dialog.editor.getValue();var filetype_val=$("#client_file_snippet_select").val();if(TS.ui.snippet_dialog.edit_file_id){if(_current_title===title_val&&_current_text===snippet_val&&_current_filetype===filetype_val){return dialog.cancel()}}else if(!snippet_val&&!title_val){return dialog.cancel()}var div=TS.ui.snippet_dialog.div;div.find(".modal-footer-confirm").removeClass("hidden");div.find(".modal-footer-action").addClass("hidden")},cancelDecline:function(){var div=TS.ui.snippet_dialog.div;div.find(".modal-footer-confirm").addClass("hidden");div.find(".modal-footer-action").removeClass("hidden")},cancel:function(e){if(e){e.preventDefault()}if(TS.ui.snippet_dialog.text_from_input){TS.client.msg_input.populate(TS.ui.snippet_dialog.editor.getValue());TS.ui.snippet_dialog.text_from_input=""}setTimeout(TS.view.focusMessageInput,10);TS.ui.snippet_dialog.end();TS.ui.snippet_dialog.div.modal("hide")},end:function(){$(window.document).off("keydown",TS.ui.snippet_dialog.onKeyDown);$(window.document).off("keyup",_showSaveSnippetTip);TS.ui.snippet_dialog.showing=TS.model.dialog_is_showing=false;TS.ui.comments.unbindInput($("#file_comment_textarea"));if(TS.ui.snippet_dialog.editor&&TS.ui.snippet_dialog.editor.cleanup){TS.ui.snippet_dialog.editor.cleanup()}TS.ui.snippet_dialog.editor=null;TS.ui.snippet_dialog.div.empty()},onKeyDown:function(e){var dialog=TS.ui.snippet_dialog;if(e.which==TS.utility.keymap.esc){if(dialog.div.find(".modal-footer-confirm").is(":visible")){dialog.cancelDecline()}else{dialog.cancelPrompt()}e.preventDefault()}else if(e.which==TS.utility.keymap.enter){if(!TS.utility.isFocusOnInput()||!document.activeElement||TS.utility.getActiveElementProp("id")=="client_file_snippet_title_input"){if(dialog.div.find(".modal-footer-confirm").is(":visible")){dialog.cancel()}else{dialog.go()}e.preventDefault()}}},build:function(){$("body").append('<div id="snippet_dialog" class="modal hide fade" data-backdrop="static" data-keyboard="false"></div>');var div=TS.ui.snippet_dialog.div=$("#snippet_dialog");div.on("hidden",function(e){if(e.target!=this)return;TS.ui.snippet_dialog.end()});div.on("show",function(e){if(e.target!=this)return;TS.ui.snippet_dialog.showing=TS.model.dialog_is_showing=true})}});var _loading_scripts=false;var _current_title="";var _current_text="";var _current_filetype="";var _showSaveSnippetTip=function(){var $dialog=TS.ui.snippet_dialog;var editor_value=$dialog.editor.getValue();if($.trim(editor_value)){$dialog.div.find(".ts_tip").addClass("ts_tip_hide")}else{$dialog.div.find(".ts_tip").removeClass("ts_tip_hide")}}})();(function(){"use strict";TS.registerModule("view.overlay",{onStart:function(){_$msgs_overlay=$("#msgs_overlay_div");$(window.document).keydown(function(e){if(!TS.model.overlay_is_showing)return;if(e.which==TS.utility.keymap.enter||e.which==TS.utility.keymap.esc){if(_performCancel){_performCancel()}else{_cancel(true)}}})},startWithJoinedChannel:function(channel){_start();_show_another_interstitial_after=true;_$msgs_overlay.html(TS.templates.channel_join_overlay({invited:false,channel:channel}));_performCancel=function(e){channel.needs_joined_message=false;_cancel(true);_performCancel=null};_setupScrollingAndEvents($("#channel_joined"))},startWithInvitedChannel:function(channel){_start();_show_another_interstitial_after=true;_$msgs_overlay.html(TS.templates.channel_join_overlay({invited:true,channel:channel}));_performCancel=function(e){channel.needs_invited_message=false;_cancel(true);_performCancel=null};_setupScrollingAndEvents($("#channel_joined"))},startWithCreatedChannel:function(channel){_start();_show_another_interstitial_after=true;_$msgs_overlay.html(TS.templates.channel_create_overlay({channel:channel}));_performCancel=function(e){channel.needs_created_message=false;_cancel(true);_performCancel=null};_$msgs_overlay.find("a.invite_link").bind("click.invite_and_clear_overlay",function(e){TS.ui.channel_invite_modal.startInviteToChannelModal(channel.id);_performCancel(e)});_setupScrollingAndEvents($("#channel_created"))},startWithInvitedGroup:function(group){_start();_show_another_interstitial_after=true;_$msgs_overlay.html(TS.templates.group_join_overlay({invited:true,group:group}));_performCancel=function(e){group.needs_invited_message=false;_cancel(true);_performCancel=null};_setupScrollingAndEvents($("#group_joined"))},startWithCreatedGroup:function(group){_start();_show_another_interstitial_after=true;_$msgs_overlay.html(TS.templates.group_create_overlay({group:group}));$(window).trigger("resize");_performCancel=function(e){group.needs_created_message=false;_cancel(true);_performCancel=null};_setupScrollingAndEvents($("#group_created"))},startWithGrowlPromptDisplay:function(){_start();_show_another_interstitial_after=true;var $msgs_overlay=_$msgs_overlay;$msgs_overlay.html(TS.templates.growl_prompt_overlay({}));$msgs_overlay.find(".prompt_allow").bind("click",function(e){_onGrowlsPermissionClick(e)});$msgs_overlay.find(".prompt_cancel_forever").bind("click",function(e){createCookie("no_growl_prompt","1",365*10);$("#growl_prompt_div").addClass("hidden");_cancel()});$msgs_overlay.find(".see-apps").bind("click",function(e){createCookie("no_growl_prompt","1",.5);$("#growl_prompt_div").addClass("hidden");_cancel()});$msgs_overlay.find(".prompt_cancel").bind("click",function(e){$("#growl_prompt_div").addClass("hidden");_cancel()});$msgs_overlay.find(".prompt_test").bind("click",function(e){$("#growl_prompt_div").addClass("hidden");TS.sounds.play("new_message");TS.ui.growls.show("Test Notification","Hey! it works")});if(TS.ui.growls.no_notifications){$("#growl_prompt_overlay_impossible").removeClass("hidden")}else{$("#growl_prompt_overlay_start").removeClass("hidden")}},fadeInAndOut:function(){_start();_cancel()},cancelFromSendingMessage:function(){if(!TS.model.overlay_is_showing)return;if(_performCancel){_performCancel()}else{_cancel(true)}}});var _$msgs_overlay=null;var _show_another_interstitial_after=false;var _performCancel=null;var _setupScrollingAndEvents=function($el){_$msgs_overlay.find("a.btn").bind("click.clear_overlay",_performCancel);$el.wrap('<div id="overlay_wrapper">');$("#overlay_wrapper").monkeyScroll()};var _onGrowlsPermissionClick=function(){$("#growl_prompt_overlay_start").addClass("hidden");$("#growl_prompt_overlay_tell_to_allow").removeClass("hidden");TS.ui.growls.promptForPermission(function(allowed,permission_level){$("#growl_prompt_overlay_tell_to_allow").addClass("hidden");if(permission_level=="granted"&&allowed){$("#growl_prompt_overlay_success").removeClass("hidden");TS.prefs.setPrefByAPI({name:"growls_enabled",value:true})}else if(permission_level=="default"){$("#growl_prompt_overlay_start").removeClass("hidden")}else if(permission_level=="denied"){$("#growl_prompt_overlay_disallowed").removeClass("hidden")}else{alert("huh allowed:"+allowed+" permission_level:"+permission_level)}})};var _start=function(fade_in){if(TS.model.overlay_is_showing)return;_$msgs_overlay.stop();_$msgs_overlay.empty();_$msgs_overlay.removeClass("hidden");if(fade_in){_$msgs_overlay.css("opacity",0);_$msgs_overlay.transition({opacity:1},250)}else{_$msgs_overlay.css("opacity",1)}TS.model.overlay_is_showing=true};var _cancel=function(and_check){var was_showing=TS.model.overlay_is_showing;TS.model.overlay_is_showing=false;var $no_joined_overlays_cb=_$msgs_overlay.find("#no_joined_overlays_cb");if($no_joined_overlays_cb.length&&$no_joined_overlays_cb.prop("checked")){TS.prefs.setPrefByAPI({name:"no_joined_overlays",value:true})}var $no_created_overlays_cb=_$msgs_overlay.find("#no_created_overlays_cb");if($no_created_overlays_cb.length&&$no_created_overlays_cb.prop("checked")){TS.prefs.setPrefByAPI({name:"no_created_overlays",value:true})}_$msgs_overlay.transition({opacity:0},250,function(){_end()});if(_show_another_interstitial_after){_show_another_interstitial_after=false;TS.view.showInterstitialAfterChannelOrImShown()}if(was_showing&&and_check){TS.client.msg_pane.checkUnreads()}};var _end=function(){_$msgs_overlay.addClass("hidden");TS.model.overlay_is_showing=false}})();(function(){"use strict";TS.registerModule("ui.invite",{onStart:function(){},showInviteMembersPreSelected:function(group_id,preselected_idsA,ephemeral_msg_ts){_showInviteMembersDialogWorker(group_id,preselected_idsA,ephemeral_msg_ts)},showInviteMemberToChannelDialog:function(member_id){var member=TS.members.getMemberById(member_id);var invite_channels=TS.members.getMyChannelsThatThisMemberIsNotIn(member.id);if(TS.model.user.is_ultra_restricted){TS.generic_dialog.start({title:"Invite "+TS.members.getMemberDisplayName(member,true)+" to a channel",body:"You are not allowed to invite other members to channels.",show_cancel_button:false})}else if(member.is_ultra_restricted){TS.generic_dialog.start({title:"Invite "+TS.members.getMemberDisplayName(member,true)+" to a channel",body:TS.members.getMemberDisplayName(member,true)+" cannot be invited to any new channels.",show_cancel_button:false})}else if(member.is_restricted&&!TS.model.user.is_admin){TS.generic_dialog.start({title:"Invite "+TS.members.getMemberDisplayName(member,true)+" to a channel",body:"Only a Team Admin can invite "+TS.members.getMemberDisplayName(member,true)+" into new channels.",show_cancel_button:false})}else if(invite_channels.length){TS.generic_dialog.start({title:"Invite "+TS.members.getMemberDisplayName(member,true)+" to a channel",body:TS.templates.channel_invite_list({channels:invite_channels}),show_cancel_button:true,show_go_button:true,go_button_text:"Invite",onGo:function(){var channels=$("#select_invite_channels").lazyFilterSelect("value");if(!channels[0])return false;var channel_id=channels[0].id;TS.api.call("channels.invite",{channel:channel_id,user:member.id})}});var filter_select_css={width:"230px",display:"inline-block"};$("#select_invite_channels").hide().lazyFilterSelect({placeholder_text:"Select a channel",css:filter_select_css,classes:"select_invite_channels",data:invite_channels,template:function(channel){var html="#"+TS.utility.htmlEntities(channel.name);if(TS.boot_data.page_needs_enterprise&&channel.is_shared)html+=' <ts-icon class="ts_icon_org_shared_channel"></ts-icon>';return new Handlebars.SafeString(html)}});$("#generic_dialog").find(".modal-body").css("overflow","visible")}else{TS.generic_dialog.start({title:""+TS.members.getMemberDisplayName(member,true)+" is already in all the channels you are in",body:"Since "+TS.members.getMemberDisplayName(member,true)+" is already in all the channels you are in, there is nothing to invite them to!",show_cancel_button:false,show_go_button:true,go_button_text:"OK",esc_for_ok:true})}}});var _showInviteMembersDialogWorker=function(group_id,preselected_idsA,ephemeral_msg_ts){preselected_idsA=preselected_idsA||[];var group=TS.groups.getGroupById(group_id);var members_an_admin_could_invite=TS.groups.getActiveMembersNotInThisGroupForInviting(group.id,true);var members_you_can_invite=TS.model.user.is_admin?members_an_admin_could_invite:TS.groups.getActiveMembersNotInThisGroupForInviting(group.id);var invite_members=TS.channels.makeMembersWithPreselectsForTemplate(members_you_can_invite);if(invite_members.length){var on_second_step=false;var showMemberSelect=function(allow_archive_access){on_second_step=true;$("#archive_access_cb").prop("checked",allow_archive_access);$("#generic_dialog").find(".dialog_secondary_go").addClass("hidden");$("#generic_dialog").find(".dialog_go").text("Invite New Members").removeClass("btn_success");$("#group_invite_archives_prompt").addClass("hidden");$("#group_invite_member_chooser").removeClass("hidden");if(TS.model.user.is_admin){var footer_html='<span class="mini float_left small_top_margin">Or, <a data-action="admin_invites_modal" onclick="TS.generic_dialog.cancel();">invite a new person to your team</a></span>';$("#generic_dialog").find(".modal-footer").prepend(footer_html)}return};var doWork=function(allow_archive_access,selected_idsA){if(ephemeral_msg_ts){TS.groups.removeMsg(group.id,TS.utility.msgs.getMsg(ephemeral_msg_ts,group.msgs))}if(allow_archive_access){for(var i=0;i<selected_idsA.length;i++){TS.api.call("groups.invite",{channel:group.id,user:selected_idsA[i]})}return true}TS.groups.createChild(group.id,selected_idsA,function(ok,data,args){if(!ok){if(data&&data.error=="restricted_action"){setTimeout(function(){TS.generic_dialog.alert("<p>You don't have permission to create new groups.</p><p>Talk to your Team Owner.</p>")},500)}else{alert("failed! "+data.error)}return}})};var who_text="new members";if(preselected_idsA.length){who_text="";for(var i=0;i<preselected_idsA.length;i++){if(i!==0){if(i==preselected_idsA.length-1){if(preselected_idsA.length>2)who_text+=",";who_text+=" and "}else{who_text+=", "}}who_text+="<b>"+TS.members.getMemberDisplayName(TS.members.getMemberById(preselected_idsA[i]),true)+"</b>"}}TS.generic_dialog.start({title:"Invite "+who_text+" to "+TS.model.group_prefix+group.name,body:TS.templates.group_member_invite_list({invite_members:invite_members,group:group,show_ra_tip:members_you_can_invite.length!=members_an_admin_could_invite.length}),show_cancel_button:true,show_go_button:true,go_button_text:"Yes, show channel history",show_secondary_go_button:true,secondary_go_button_text:"No, start new private channel",secondary_go_button_class:"btn_info",onGo:function(){if(!on_second_step){if(preselected_idsA.length){return doWork(true,preselected_idsA)}showMemberSelect(true);return false}else{var archive_access=!!$("#archive_access_cb").prop("checked");var val=$("#select_invite_group_members").val();if(!val)return false;return doWork(archive_access,val)}},onSecondaryGo:function(){if(preselected_idsA.length){return doWork(false,preselected_idsA)}showMemberSelect(false);return false},onEnd:function(){$(".modal-body").css("overflow-y","auto")}});$("#select_invite_group_members").hide().lazyFilterSelect();$("#select_invite_group_members_holder").css("min-height",235);$(".modal-body").css("overflow-y","visible")}else{TS.generic_dialog.start({title:"Everyone is already in this private channel",body:"Since everyone is already in this private channel, there is no one to invite!",show_cancel_button:false,show_go_button:true,go_button_text:"OK",esc_for_ok:true})}}})();(function(){"use strict";TS.registerModule("ui.banner",{show_hide_sig:new signals.Signal,onStart:function(){TS.client.login_sig.add(TS.ui.banner.loggedIn,TS.ui.banner);TS.ui.growls.permission_changed_sig.add(TS.ui.banner.growlsPermissionChanged,TS.ui.banner)},loggedIn:function(){if(TS.qs_args["show_notifications_banner"]=="1"||TS.qs_args["show_banner"]=="1"){TS.ui.banner.show("notifications");return}if(TS.qs_args["show_macssb1_banner"]=="1"){TS.ui.banner.show("macssb1");return}if(TS.qs_args["show_macssb2_banner"]=="1"){TS.ui.banner.show("macssb2");return}if(TS.qs_args["show_winssb1_banner"]=="1"){TS.ui.banner.show("winssb1");return}var show_notifications_banner=!TS.model.is_iOS&&!TS.ui.growls.no_notifications&&TS.ui.growls.shouldShowPermissionButton()&&TS.ui.growls.getPermissionLevel()!="denied"&&readCookie("no_growl_banner")!="1";if(show_notifications_banner){TS.ui.banner.show("notifications");return}var deprecated_osx_versions=[10.6,10.7,10.8];var show_macssb_osx_deprecated_banner=TS.model.is_our_app&&TS.model.is_mac&&deprecated_osx_versions.indexOf(TS.model.mac_version)>=0;var is_app_store=_isLegacyAppStoreBuild();var show_macelectron1_banner=TS.boot_data.feature_macelectron1_banner&&TS.model.is_mac&&!deprecated_osx_versions.indexOf(TS.model.mac_version)>=0&&!TS.model.is_electron&&!("macgap"in window)&&!TS.model.prefs.no_macelectron_banner;var show_macelectron2_banner=TS.boot_data.feature_macelectron2_banner&&TS.model.is_mac&&"macgap"in window&&!is_app_store&&!TS.model.prefs.no_macelectron_banner;var show_macssb1_banner=TS.boot_data.feature_macssb1_banner&&TS.model.is_mac&&!TS.model.mac_ssb_version&&!TS.model.prefs.no_macssb1_banner;var show_macssb2_banner=TS.boot_data.feature_macssb2_banner&&TS.model.is_mac&&TS.model.mac_ssb_version&&TS.model.mac_ssb_version<2&&!TS.model.prefs.no_macssb2_banner;var show_winssb1_banner=TS.model.is_win_7_plus&&!TS.model.win_ssb_version&&!TS.model.prefs.no_winssb1_banner;if(show_macssb_osx_deprecated_banner){TS.ui.banner.show("macssb_osx_deprecated");return}if(show_macelectron1_banner){TS.ui.banner.show("macelectron1");return}if(show_macelectron2_banner){TS.ui.banner.show("macelectron2");return}if(show_macssb1_banner){TS.ui.banner.show("macssb1");return}if(show_macssb2_banner){TS.ui.banner.show("macssb2");return}if(show_winssb1_banner){TS.ui.banner.show("winssb1");return}},showSSBUpdateBanner:function(version_number,can_update,learn_more_url){if(_prev_ssb_update_version_shown&&TS.utility.compareSemanticVersions(version_number,_prev_ssb_update_version_shown)<=0){return}_prev_ssb_update_version_shown=version_number;var $banner=$("#ssb_new_version_available");if(!$banner.length)return;$banner.find(".old_version_number").text(TS.model.desktop_app_version.major+"."+TS.model.desktop_app_version.minor+"."+TS.model.desktop_app_version.patch);$banner.find(".new_version_number").text(version_number);$banner.find(".can_update").toggleClass("hidden",!can_update);$banner.find(".can_not_update").toggleClass("hidden",can_update);$banner.find(".update_link").off("click").on("click",function(e){e.preventDefault();TSSSB.call("quitAndInstallUpdate")});$banner.find(".learn_link").attr("href",learn_more_url);TS.ui.banner.show("ssb_new_version_available")},closeSSBUpdateBanner:function(){TS.ui.banner.close()},growlsPermissionChanged:function(allowed,permission_level){if(permission_level!="default"){TS.ui.banner.close()}},growlsPermissionPrompt:function(){TS.ui.growls.promptForPermission(function(allowed,permission_level){if(permission_level=="granted"&&allowed){TS.sounds.play("new_message");TS.ui.growls.show("A Notification from Slack","Nice, notifications are enabled!");if(!TS.model.prefs.growls_enabled){TS.prefs.setPrefByAPI({name:"growls_enabled",value:true});TS.model.prefs.growls_enabled=true}}})},show:function(which){_last_which=which=which||_last_which;var $banner=TS.client.ui.$banner;$banner.removeClass("hidden");$("body").addClass("banner_showing");$banner.css("display","block");$banner.children(".banner_content").addClass("hidden");TS.ui.banner.show_hide_sig.dispatch("show");if(which=="notifications_dismiss"){$("#notifications_dismiss_banner").removeClass("hidden");$banner.unbind("click").bind("click",function(e){TS.ui.banner.close()})}else if(which=="notifications"){$("#notifications_banner").removeClass("hidden");$banner.unbind("click").bind("click",function(e){if($(e.target).closest(".dismiss").length===0){TS.ui.banner.growlsPermissionPrompt()}else{$("#notifications_banner").addClass("hidden");TS.ui.banner.show("notifications_dismiss");return}TS.ui.banner.close()})}else if(which=="macelectron1"){$("#macelectron1_banner").removeClass("hidden");$banner.unbind("click").bind("click",function(e){if($(e.target).closest(".dismiss").length){var $dismiss_link=$(this).find(".dismiss");$("#macelectron1_banner").addClass("hidden");TS.ui.banner.close();$dismiss_link.click()}else{if(!$(e.target).hasClass("mac_downloads_page_link")){var $downloads_page_link=$(this).find(".mac_downloads_page_link");TS.utility.openInNewTab($downloads_page_link.attr("href"),$downloads_page_link.attr("target"));$downloads_page_link.click()}}});TS.prefs.setPrefByAPI({name:"no_macelectron_banner",value:true})}else if(which=="macelectron2"){$("#macelectron2_banner").removeClass("hidden");$banner.unbind("click").bind("click",function(e){if($(e.target).closest(".dismiss").length){var $dismiss_link=$(this).find(".dismiss");$("#macelectron2_banner").addClass("hidden");TS.ui.banner.close();$dismiss_link.click()}else{if(!$(e.target).hasClass("update_link")){var $update_link=$(this).find(".update_link");$update_link.click()}}});TS.prefs.setPrefByAPI({name:"no_macelectron_banner",value:true})}else if(which=="macssb1"){$("#macssb1_banner").removeClass("hidden");$banner.unbind("click").bind("click",function(e){if($(e.target).closest(".dismiss").length){$("#macssb1_banner").addClass("hidden");TS.ui.banner.show("macssb1_dismiss")}else{if(!$(e.target).hasClass("apps_page_link")){var $apps_page_link=$(this).find(".apps_page_link");TS.utility.openInNewTab($apps_page_link.attr("href"),$apps_page_link.attr("target"));$apps_page_link.click()}}})}else if(which=="macssb1_dismiss"){$banner.unbind("click").bind("click",function(e){if($(e.target).closest("a").length===0){var $apps_page_link=$(this).find(".apps_page_link");TS.utility.openInNewTab($apps_page_link.attr("href"),$apps_page_link.attr("target"))}});$("#macssb1_dismiss_banner").removeClass("hidden")}else if(which=="macssb2"){$("#macssb2_banner").removeClass("hidden");$banner.unbind("click").bind("click",function(e){if($(e.target).closest(".dismiss").length){$("#macssb2_banner").addClass("hidden");TS.ui.banner.close();TS.prefs.setPrefByAPI({name:"no_macssb2_banner",value:true})}else{if(!$(e.target).hasClass("apps_page_link")){var $apps_page_link=$(this).find(".apps_page_link");TS.utility.openInNewTab($apps_page_link.attr("href"),$apps_page_link.attr("target"));$apps_page_link.click()}}})}else if(which=="winssb1"){$("#winssb1_banner").removeClass("hidden");$banner.unbind("click").bind("click",function(e){if($(e.target).closest(".dismiss").length){$("#winssb1_banner").addClass("hidden");TS.ui.banner.show("winssb1_dismiss")}else{if(!$(e.target).hasClass("apps_page_link")){var $apps_page_link=$(this).find(".apps_page_link");TS.utility.openInNewTab($apps_page_link.attr("href"),$apps_page_link.attr("target"));$apps_page_link.click()}}})}else if(which=="winssb1_dismiss"){$banner.unbind("click").bind("click",function(e){if($(e.target).closest("a").length===0){var $apps_page_link=$(this).find(".apps_page_link");TS.utility.openInNewTab($apps_page_link.attr("href"),$apps_page_link.attr("target"))}});$("#winssb1_dismiss_banner").removeClass("hidden")}else if(which=="macssb_osx_deprecated"){$("#macssb_osx_deprecated_banner").removeClass("hidden");$banner.unbind("click").bind("click",function(e){TS.ui.banner.close()})}else if(which=="ssb_new_version_available"){var $generic_banner=$banner.find("#"+which);if(!$generic_banner.length){TS.error("Tried to show a banner called "+which+", but can't find an element with that as its ID");return}$generic_banner.removeClass("hidden");$generic_banner.find("a.dismiss").unbind("click").bind("click",function(e){TS.ui.banner.close();TSSSB.call("closeAllUpdateBanners")})}else{var $generic_banner=$banner.find("#"+which);if(!$generic_banner.length){TS.error("Tried to show a banner called "+which+", but can't find an element with that as its ID");return}$generic_banner.removeClass("hidden");$generic_banner.find("a.dismiss").unbind("click").bind("click",function(e){TS.ui.banner.close()})}TS.view.resizeForBanner("TS.ui.banner.show")},onClickedMacElectronLink:function(elem,close){if(!TS.boot_data.feature_macelectron1_banner&&!TS.boot_data.feature_macelectron2_banner)return;if(close)TS.ui.banner.close();var $elem=$(elem);if(!$elem.parent().hasClass("hidden")){TS.clog.track("WEBSITE_CLICK",{click_target:"get_mac_electron_banner",trigger:$elem.parent().attr("id"),action:"banner_click"})}},onDismissedMacElectronLink:function(elem){if(!TS.boot_data.feature_macelectron1_banner&&!TS.boot_data.feature_macelectron2_banner)return;var $elem=$(elem);if(!$elem.parent().hasClass("hidden")){TS.clog.track("WEBSITE_CLICK",{click_target:"get_mac_electron_banner",trigger:$elem.parent().attr("id"),action:"banner_dismiss"})}},onClickedMacSSB1Link:function(elem,close){if(close)TS.ui.banner.close();TS.prefs.setPrefByAPI({name:"no_macssb1_banner",value:true});var $elem=$(elem);if(!$elem.parent().hasClass("hidden")){TS.clog.track("WEBSITE_CLICK",{click_target:"get_mac_ssb_banner",target_url:$elem.attr("href"),action:"banner_click"})}},onClickedWinSSB1Link:function(elem,close){if(close)TS.ui.banner.close();TS.prefs.setPrefByAPI({name:"no_winssb1_banner",value:true});var $elem=$(elem);if(!$elem.parent().hasClass("hidden")){TS.clog.track("WEBSITE_CLICK",{click_target:"get_win_ssb_banner",target_url:$elem.attr("href"),action:"banner_click"})}},onClickedMacSSB2Link:function(close){if(close)TS.ui.banner.close();TS.prefs.setPrefByAPI({name:"no_macssb2_banner",value:true})},closeNagAndSetCookie:function(){TS.ui.banner.close();createCookie("no_growl_banner","1",365*10)},closeNagAndOpenPrefs:function(){TS.ui.banner.close();setTimeout(function(){TS.ui.prefs_dialog.start("notifications")},500)},close:function(){var $banner=TS.client.ui.$banner;$banner.slideUp(200,function(){$banner.addClass("hidden");$("body").removeClass("banner_showing");var was_at_bottom=TS.client&&TS.client.ui.areMsgsScrolledToBottom();TS.view.resizeForBanner("TS.ui.banner.close");TS.ui.banner.show_hide_sig.dispatch("hide");if(was_at_bottom)TS.client.ui.instaScrollMsgsToBottom(false)})}});var _last_which="notifications";var _prev_ssb_update_version_shown;function _isLegacyAppStoreBuild(){if(!("macgap"in window))return false;if(!("isAppStoreBuild"in macgap.app))return false;try{return macgap.app.isAppStoreBuild()==="1"}catch(err){TS.logError(err,"macgap.app.isAppStoreBuild() failed","macgap error");return false}}})();(function(){"use strict";TS.registerModule("coachmark",{$coachmark:null,context:null,is_showing:false,is_small:false,onStart:function(){},start:function(context){if(!context)return;if(TS.coachmark.is_showing)TS.coachmark.end();if(!TS.coachmark.$coachmark)_createCoachmark();_populateCoachmark(context);var $coachmark=TS.coachmark.$coachmark;if(!$("#"+context.coachmark_el_id).length){TS.error(["Cannot show coachmark ",context.id," because there is no element ",context.coachmark_el_id,""].join('"'));$coachmark.addClass("hidden");return}TS.coachmark.clean();TS.coachmark.context=context;TS.coachmark.is_showing=TS.model.coachmark_is_showing=true;$coachmark.removeClass("hidden");$coachmark.css("left","").css("right","").css("top","").css("bottom","").css("height","auto").css("width","auto");$("#coachmark_callout").css("left","").css("right","").css("top","").css("bottom","");$coachmark.addClass(context.coachmark_el_id);$("#"+context.coachmark_el_id).removeClass("hidden");if(!context.reject)$("#coachmark_footer > .coachmark_footer_text").addClass("hidden");$(window.document).bind("keydown",TS.coachmark.onKeyDown);$("html").bind("mousedown",TS.coachmark.onMouseDown);$coachmark.css("opacity",1);if(context.place&&context.placeSmall){$coachmark.addClass("small_coachmark");TS.coachmark.is_small=true}_place();$(window).on("resize.coachmark_placement",_place);if(TS.boot_data.feature_update_coachmarks_cta&&TS.newxp.canIncludeInviteCTA()){if(TS.coachmark.context.ui_click){$(".coachmark_got_it").removeClass("hidden");$(".coachmark_next_tip").addClass("hidden");$(".coachmark_invite_people").addClass("hidden")}}if(!TS.coachmark.context.no_bg_on_small)$("#coachmark_bg").removeClass("hidden")},placeRightOf:function($placement_el,top_offset,left_offset,callout_top_offset){if(!TS.coachmark.context||!TS.coachmark.$coachmark)return;top_offset=top_offset||0;left_offset=left_offset||0;callout_top_offset=callout_top_offset||0;var $coachmark=TS.coachmark.$coachmark;var coachmark_callout_h=30;var coachmark_callout_edge_allow=18;var offset=$placement_el.offset();$coachmark.css("top",offset.top+top_offset);$coachmark.css("left",offset.left+$placement_el.width()+left_offset);TS.coachmark.keepInBounds();var rect=$coachmark.dimensions_rect();$("#coachmark_callout").css("top",Math.round(_.clamp(offset.top-rect.top+($placement_el.height()-coachmark_callout_h)/2+callout_top_offset,coachmark_callout_edge_allow,rect.height-(coachmark_callout_edge_allow+coachmark_callout_h)))).css("left",-10)},placeBelowOf:function($placement_el,top_offset,left_offset,callout_left_offset){if(!TS.coachmark.context||!TS.coachmark.$coachmark)return;top_offset=top_offset||0;left_offset=left_offset||0;callout_left_offset=callout_left_offset||0;var $coachmark=TS.coachmark.$coachmark;var coachmark_callout_h=30;var coachmark_callout_edge_allow=18;var offset=$placement_el.offset();$coachmark.css("top",offset.top+$placement_el.height()+top_offset);$coachmark.css("left",offset.left+left_offset);TS.coachmark.keepInBounds();var rect=$coachmark.dimensions_rect();$("#coachmark_callout").css("left",Math.round(_.clamp(offset.left-rect.left+($placement_el.width()-coachmark_callout_h)/2+callout_left_offset,coachmark_callout_edge_allow,rect.width-(coachmark_callout_edge_allow+coachmark_callout_h)))).css("top",-10)},placeAboveOf:function($placement_el,top_offset,left_offset,callout_left_offset){if(!TS.coachmark.context||!TS.coachmark.$coachmark)return;top_offset=top_offset||0;left_offset=left_offset||0;callout_left_offset=callout_left_offset||0;var $coachmark=TS.coachmark.$coachmark;var coachmark_callout_h=30;var coachmark_callout_edge_allow=18;var offset=$placement_el.offset();$coachmark.css("top",offset.top-coachmark_callout_h-$coachmark.height()+top_offset);$coachmark.css("left",offset.left+left_offset);TS.coachmark.keepInBounds();var rect=$coachmark.dimensions_rect();$("#coachmark_callout").css("left",Math.round(_.clamp(offset.left-rect.left+($placement_el.width()-coachmark_callout_h)/2+callout_left_offset,coachmark_callout_edge_allow,rect.width-(coachmark_callout_edge_allow+coachmark_callout_h)))).css("bottom",-10)},placeLeftOf:function($placement_el,top_offset,left_offset,callout_top_offset){if(!TS.coachmark.context||!TS.coachmark.$coachmark)return;top_offset=top_offset||0;left_offset=left_offset||0;callout_top_offset=callout_top_offset||0;var $coachmark=TS.coachmark.$coachmark;var coachmark_callout_h=30;var coachmark_callout_edge_allow=18;var offset=$placement_el.offset();$coachmark.css("top",offset.top+top_offset);$coachmark.css("left",offset.left-$coachmark.width()+left_offset);TS.coachmark.keepInBounds();var rect=$coachmark.dimensions_rect();$("#coachmark_callout").css("top",Math.round(_.clamp(offset.top-rect.top+($placement_el.height()-coachmark_callout_h)/2+callout_top_offset,coachmark_callout_edge_allow,rect.height-(coachmark_callout_edge_allow+coachmark_callout_h)))).css("right",-10)},keepInBounds:function(){if(!TS.coachmark.context||!TS.coachmark.$coachmark)return;var $coachmark=TS.coachmark.$coachmark;
var context=TS.coachmark.context;var allowance=4;var rect=$coachmark.dimensions_rect();var allow_rect={top:0+allowance,right:$(window).width()-allowance,bottom:$(window).height()-allowance,left:0+allowance};if(!context.place)$coachmark.css("left","").css("right","").css("top","").css("bottom","");if(TS.utility.doesRectContainRect(allow_rect,rect))return;if(rect.left<allow_rect.left){$coachmark.css("left",allow_rect.left)}else if(rect.right>allow_rect.right){$coachmark.css("left",Math.max(allow_rect.left,allow_rect.right-rect.width))}if(rect.top<allow_rect.top){$coachmark.css("top",allow_rect.top)}else if(rect.bottom>allow_rect.bottom){$coachmark.css("top",Math.max(allow_rect.top,allow_rect.bottom-rect.height))}},clean:function(){$("#coachmark_footer > .coachmark_footer_text").removeClass("hidden");if(TS.coachmark.context)TS.coachmark.$coachmark.removeClass(TS.coachmark.context.coachmark_el_id).removeClass("small_coachmark");TS.coachmark.is_small=false;TS.coachmark.context=null},reject:function(e){var context=TS.coachmark.context;if(context&&context.reject)context.reject();TS.coachmark.end();TS.clog.track("GROWTH_ONBOARDING",{action:"skip_tutorial_step",step:TS.newxp.getCurrentStepName()});if(e)e.stopPropagation()},resolve:function(e){var context=TS.coachmark.context;if(context&&context.resolve)context.resolve();TS.coachmark.end();if(e)e.stopPropagation()},expand:function(e){var $coachmark=TS.coachmark.$coachmark;var $coachmark_interior=$coachmark.find("#coachmark_interior");if(TS.coachmark.is_small){TS.coachmark.is_small=false;$coachmark_interior.css("opacity",0);$coachmark.removeClass("small_coachmark");_place();$("#coachmark_bg").removeClass("hidden");window.setTimeout(function(){$coachmark_interior.css("opacity",1)},100)}if(e)e.stopPropagation()},end:function(){TS.coachmark.is_showing=TS.model.coachmark_is_showing=false;var $coachmark=TS.coachmark.$coachmark;$coachmark.css("opacity",0);TS.coachmark.$coachmark.find(".coachmark_div").remove();TS.coachmark.clean();$coachmark.addClass("hidden");$("#coachmark_bg").addClass("hidden");$(window.document).off("keydown",TS.coachmark.onKeyDown);$("html").off("mousedown",TS.coachmark.onMouseDown);$(window).off("resize.coachmark_placement")},onKeyDown:function(e){if(e.which==TS.utility.keymap.esc){TS.coachmark.reject(e)}else if(e.which==TS.utility.keymap.enter){if(TS.coachmark.is_small){TS.coachmark.expand(e)}else{TS.coachmark.resolve(e)}}},onMouseDown:function(e){if(TS.coachmark.is_small){TS.coachmark.expand(e)}else if(!$(e.target).closest("#coachmark").length){TS.coachmark.resolve(e)}},onClickInvite:function(e){if(!$(".coachmark_invite_people").is(":visible")||$(e.target).is("#coachmark_bg"))return TS.coachmark.resolve(e);if(TS.ui.admin_invites.canInvite())TS.ui.admin_invites.start();return TS.coachmark.resolve(e)}});var _place=function(){var context=TS.coachmark.context;if(context.placeSmall&&TS.coachmark.is_small){context.placeSmall()}else if(context.place){context.place()}else{TS.coachmark.keepInBounds()}};var _createCoachmark=function(){var $ui_wrapper=$("#client-ui");if(!$ui_wrapper.length&&TS.calls){$ui_wrapper=$("#calls_conference_content")}$ui_wrapper.append(TS.templates.coachmark({can_include_invite_cta:TS.newxp.canIncludeInviteCTA()}));var $coachmark=TS.coachmark.$coachmark=$("#coachmark");$coachmark.css("opacity",0);$coachmark.on("click",".coachmark_skip_link",TS.coachmark.reject);$coachmark.on("click",".coachmark_got_it",TS.coachmark.resolve);if(TS.boot_data.feature_update_coachmarks_cta&&TS.newxp.canIncludeInviteCTA()){$coachmark.on("click",".coachmark_close",TS.coachmark.reject);$coachmark.on("click",".coachmark_next_tip",TS.coachmark.resolve);$coachmark.on("click",".coachmark_done",TS.coachmark.resolve);$coachmark.on("click",".coachmark_invite_people",TS.coachmark.onClickInvite);$coachmark.on("click",".coachmark_ok",TS.coachmark.resolve)}};var _populateCoachmark=function(context){if(context.content&&TS.coachmark.$coachmark)TS.coachmark.$coachmark.find("#coachmark_interior").prepend(context.content())}})();(function(){"use strict";TS.registerModule("coachmarks",{coachmarks:{channels:{id:"channels_coachmark",coachmark_el_id:"channels_coachmark_div",place:function(){TS.coachmark.placeRightOf($("#channels_header"),-26,10,5)},content:function(){var channels_count=TS.channels.getChannelsForUser().length;var groups_count=TS.groups.getUnarchivedGroups().length;var template_args={channels_count:channels_count,groups_count:groups_count,total_count:channels_count+groups_count,in_single_private_channel:!channels_count&&groups_count===1};return TS.templates.channels_coachmark(template_args)}},invites:{id:"invites_coachmark",coachmark_el_id:"invites_coachmark_div",place:function(){TS.coachmark.placeRightOf($("#channel_list_invites_link"),-26,63,9)},content:function(){return TS.templates.invites_coachmark()}},direct_messages:{id:"direct_messages_coachmark",coachmark_el_id:"direct_messages_coachmark_div",place:function(){TS.coachmark.placeRightOf($("#direct_messages_header"),-26,10,5)},content:function(){var template_args={channels_count:TS.channels.getChannelsForUser().length,groups_count:TS.groups.getUnarchivedGroups().length};return TS.templates.direct_messages_coachmark(template_args)}},search:{id:"search_coachmark",coachmark_el_id:"search_coachmark_div",no_bg_on_small:true,place:function(){var $placement_el=$("#search_container .highlighter_wrapper");var current_width=$placement_el.outerWidth(true);if(current_width>280){TS.coachmark.placeBelowOf($placement_el,23,-125,-126)}else if(current_width>250){TS.coachmark.placeBelowOf($placement_el,23,-100,-110)}else if(current_width>230){TS.coachmark.placeBelowOf($placement_el,23,-100,-101)}else if(current_width>200){TS.coachmark.placeBelowOf($placement_el,23,-100,-86)}else if(current_width>180){TS.coachmark.placeBelowOf($placement_el,23,-100,-76)}else if(current_width>160){TS.coachmark.placeBelowOf($placement_el,23,-100,-66)}},placeSmall:function(){var $placement_el=$("#search_container .highlighter_wrapper");var current_width=$placement_el.outerWidth(true);if(current_width>280){TS.coachmark.placeBelowOf($placement_el,23,-55,-126)}else if(current_width>250){TS.coachmark.placeBelowOf($placement_el,23,-30,-110)}else if(current_width>230){TS.coachmark.placeBelowOf($placement_el,23,-30,-101)}else if(current_width>200){TS.coachmark.placeBelowOf($placement_el,23,-30,-86)}else if(current_width>180){TS.coachmark.placeBelowOf($placement_el,23,-30,-76)}else if(current_width>160){TS.coachmark.placeBelowOf($placement_el,23,-30,-66)}},content:function(){return TS.templates.search_coachmark()}},recent_mentions:{id:"recent_mentions_coachmark",coachmark_el_id:"recent_mentions_coachmark_div",no_bg_on_small:true,place:function(){TS.coachmark.placeBelowOf($("#recent_mentions_toggle"),25,-340,1)},placeSmall:function(){TS.coachmark.placeBelowOf($("#recent_mentions_toggle"),25,-240,1)},content:function(){return TS.templates.recent_mentions_coachmark()}},starred_items:{id:"starred_items_coachmark",coachmark_el_id:"starred_items_coachmark_div",no_bg_on_small:true,place:function(){TS.coachmark.placeBelowOf($("#stars_toggle"),25,-340,3)},placeSmall:function(){TS.coachmark.placeBelowOf($("#stars_toggle"),25,-220,8)},content:function(){return TS.templates.starred_items_coachmark()}},private_groups:{id:"private_groups_coachmark",coachmark_el_id:"private_groups_coachmark_div",no_bg_on_small:true,place:function(){TS.coachmark.placeRightOf($("#groups_header"),-26,10,5)},placeSmall:function(){TS.coachmark.placeRightOf($("#groups_header"),-18,10,7,0)},content:function(){var template_args={channels_count:TS.channels.getChannelsForUser().length,groups_count:TS.groups.getUnarchivedGroups().length};return TS.templates.private_groups_coachmark(template_args)}},replies:{id:"replies_coachmark",coachmark_el_id:"replies_coachmark_div",place:function(){TS.coachmark.placeLeftOf($("#convo_tab_header"),-27,-20,6)},content:function(){return TS.templates.replies_coachmark()}},unread_view:{id:"unread_view_coachmark",coachmark_el_id:"unread_view_coachmark_div",place:function(){TS.coachmark.placeRightOf($("#all-unreads-list"),-16)},content:function(){return TS.templates.unread_view_coachmark()}},calls_video_beta:{id:"calls_video_beta_coachmark",coachmark_el_id:"calls_video_beta_coachmark_div",place:function(){TS.coachmark.placeAboveOf($("#camera"),15,-64,19)},content:function(){return TS.templates.calls_video_beta_coachmark()}},gdrive:{id:"gdrive_coachmark",coachmark_el_id:"gdrive_coachmark_div",place:function(){TS.coachmark.placeAboveOf($("#primary_file_button"),13,-6,0)},content:function(){return TS.templates.gdrive_coachmark()}}},onStart:function(){}})})();(function(){"use strict";TS.registerModule("newxp",{onboarding:{cancel:{step_name:"onboarding_cancelled",pref_name:"onboarding_cancelled",show:"#unskip_messaging, #mute_container, #star_container, #channel_header_info, #client_header .channel_title_info, #client_header .flex_header",hide:"#footer_overlay, #team_menu_overlay, #col_channels_overlay, #active_channel_name_overlay, #explore_btn_container > .btn, #pre_skip_messaging, #in_skip_messaging, #onboarding_video",unstyle:"#client_header .channel_header, #client_body, #details_toggle, #channel_actions_toggle, #recent_mentions_toggle, #stars_toggle, #flex_menu_toggle, #search_container, #channel_members_toggle, #rxn_toast_div, #whats_new_burst, #col_channels_footer, #groups_header",promiseTo:function(){return new Promise(function(){$("#end_display_onboarding").on("click.cancel_onboarding",".skip_tutorial_link",_deferredCancel)}).finally(function(){TS.view.unAdjustForWelcomeSlideShow();TS.client.ui.slowScrollMsgsToBottom();TS.client.ui.$msg_input.focus();_goToStep(TS.newxp.onboarding.cancel);$("#unskip_messaging > .take_tutorial_link").off("click.take_onboarding").on("click.take_onboarding",_startOnboarding);$("#end_display_onboarding").off("click.cancel_onboarding");return TS.prefs.setPrefByAPI({name:"onboarding_cancelled",value:true})})}},loading:{step_name:"onboarding_loading",pref_name:"",show:"#footer_overlay, #team_menu_overlay, #col_channels_overlay, #active_channel_name_overlay, #explore_btn_container, #pre_skip_messaging",hide:"#banner, #in_skip_messaging, #unskip_messaging, #mute_container, #star_container, #channel_header_info, #client_header .channel_title_info, #client_header .flex_header, #onboarding_video",style:"#client_header .channel_header, #client_body, #details_toggle, #channel_actions_toggle, #recent_mentions_toggle, #stars_toggle, #flex_menu_toggle, #search_container, #channel_members_toggle, #rxn_toast_div, #whats_new_burst, #col_channels_footer, #groups_header",promiseTo:function(){return new Promise(function(resolve){TS.view.adjustForWelcomeSlideShow();TS.client.msg_pane.padOutMsgsScroller();_goToStep(TS.newxp.onboarding.loading)})}},start:{step_name:"onboarding_start",pref_name:"seen_onboarding_start",show:"#footer_overlay, #team_menu_overlay, #col_channels_overlay, #active_channel_name_overlay, #explore_btn_container > .btn, #pre_skip_messaging",hide:"#in_skip_messaging, #unskip_messaging, #mute_container, #star_container, #channel_header_info, #client_header .channel_title_info, #client_header .flex_header, #onboarding_video",style:"#client_header .channel_header, #client_body, #details_toggle, #channel_actions_toggle, #recent_mentions_toggle, #stars_toggle, #flex_menu_toggle, #search_container, #channel_members_toggle, #rxn_toast_div, #whats_new_burst, #col_channels_footer, #groups_header",promiseTo:function(){return new Promise(function(resolve){TS.view.adjustForWelcomeSlideShow();TS.client.msg_pane.padOutMsgsScroller();_goToStep(TS.newxp.onboarding.start);$("#explore_btn_container > .btn").on("click",function(){TS.metrics.mark("onboarding_btn_click");TS.clog.track("GROWTH_ONBOARDING",{action:"onboarding_btn_click",step:_current_step_name})});$("#explore_btn_container > .btn").on("click.start_onboarding",resolve)}).then(function(){return TS.prefs.setPrefByAPI({name:"seen_onboarding_start",value:true})}).finally(function(){$("#explore_btn_container > .btn").off("click.start_onboarding");return TS.prefs.setPrefByAPI({name:"seen_welcome_2",value:true})})}},video_start:{step_name:"onboarding_start_with_video",pref_name:"seen_onboarding_start",show:"#footer_overlay, #team_menu_overlay, #col_channels_overlay, #active_channel_name_overlay, #explore_btn_container > .btn, #pre_skip_messaging, #onboarding_video",hide:"#in_skip_messaging, #unskip_messaging, #mute_container, #star_container, #channel_header_info, #client_header .channel_title_info, #client_header .flex_header",style:"#client_header .channel_header, #client_body, #details_toggle, #channel_actions_toggle, #recent_mentions_toggle, #stars_toggle, #flex_menu_toggle, #search_container, #channel_members_toggle, #rxn_toast_div, #whats_new_burst, #col_channels_footer, #groups_header",promiseTo:function(){return new Promise(function(resolve){TS.view.adjustForWelcomeSlideShow();TS.client.msg_pane.padOutMsgsScroller();_goToStep(TS.newxp.onboarding.video_start);TS.clog.track("GROWTH_ONBOARDING",{action:"onboarding_video_shown",step:_current_step_name});$("#onboarding_video_play, #onboarding_video").on("click",function(){TS.ui.fs_modal.start({body:'<iframe width="1000" height="563" src="https://www.youtube.com/embed/9RJZMSsH7-g?rel=0&amp;controls=0&amp;showinfo=0;autoplay=1" frameborder="0" allowfullscreen></iframe>',show_go_button:false,show_cancel_button:false,modal_class:"newxp_video_fs_modal",clog_name:"GROWTH_ONBOARDING"});TS.clog.track("GROWTH_ONBOARDING",{action:"onboarding_video_pressed_play",step:_current_step_name})});$("#explore_btn_container > .btn").on("click",function(){TS.metrics.mark("onboarding_btn_click");TS.clog.track("GROWTH_ONBOARDING",{action:"onboarding_btn_click",step:_current_step_name})});$("#explore_btn_container > .btn").on("click.start_onboarding",resolve)}).then(function(){return TS.prefs.setPrefByAPI({name:"seen_onboarding_start",value:true})}).finally(function(){$("#explore_btn_container > .btn").off("click.start_onboarding");return TS.prefs.setPrefByAPI({name:"seen_welcome_2",value:true})})}},complete:{step_name:"onboarding_complete",pref_name:"seen_onboarding_complete",show:"#mute_container, #star_container, #channel_header_info, #client_header .channel_title_info, #client_header .flex_header, .coachmark_ok",hide:"#footer_overlay, #team_menu_overlay, #col_channels_overlay, #active_channel_name_overlay, #explore_btn_container > .btn, #pre_skip_messaging, #in_skip_messaging, #unskip_messaging, .coachmark_done",hide_admin:".coachmark_invite_people",unstyle:"#client_header .channel_header, #client_body, #details_toggle, #channel_actions_toggle, #recent_mentions_toggle, #stars_toggle, #flex_menu_toggle, #search_container, #channel_members_toggle, #rxn_toast_div, #whats_new_burst, #col_channels_footer, #groups_header",promiseTo:function(){return(new Promise.resolve).then(function(){_goToStep(TS.newxp.onboarding.complete);$("#end_display_onboarding").off("click.cancel_onboarding");$("#unskip_messaging > .take_tutorial_link").off("click.take_onboarding");TS.client.ui.slowScrollMsgsToBottom();TS.client.ui.$msg_input.focus();if(TS.ims.message_received_sig.has(_restartOnGo,TS.newxp))TS.ims.message_received_sig.remove(_restartOnGo,TS.newxp);return TS.prefs.setPrefByAPI({name:"newxp_slackbot_step",value:"A2"})})}},slackbot:{step_name:"onboarding_slackbot_conversation",pref_name:"seen_onboarding_slackbot_conversation",show:"#footer_overlay, #team_menu_overlay, #col_channels_overlay, #active_channel_name_overlay, #in_skip_messaging",hide:"#explore_btn_container > .btn, #pre_skip_messaging, #unskip_messaging, #mute_container, #star_container, #channel_header_info, #client_header .channel_title_info, #client_header .flex_header, #onboarding_video",style:"#client_header .channel_header, #details_toggle, #channel_actions_toggle, #recent_mentions_toggle, #stars_toggle, #flex_menu_toggle, #search_container, #channel_members_toggle, #rxn_toast_div, #whats_new_burst, #col_channels_footer, #groups_header",unstyle:"#client_body",promiseTo:function(){var onSlackbotRebound=null;var onSlackbot=function(resolve,im,msg){if(_isSlackbot(im,msg))resolve()};return Promise.resolve().then(function(){_goToStep(TS.newxp.onboarding.slackbot);TS.view.unAdjustForWelcomeSlideShow();TS.view.focusMessageInput();$("#footer_overlay").css("opacity",0);TS.ims.message_received_sig.add(_onSkipOrStop,TS.newxp)}).delay($("#footer_overlay").css("opacity")*400).then(function(){$("#footer_overlay").addClass("hidden");TS.client.ui.slowScrollMsgsToBottom()}).then(function(){if(!TS.model.prefs.onboarding_slackbot_conversation_step)return Promise.resolve();if(_restart_was_on_go)return Promise.resolve();return new Promise(function(resolve){onSlackbotRebound=onSlackbot.bind(null,resolve);TS.ims.message_received_sig.add(onSlackbotRebound,TS.newxp);return TS.prefs.setPrefByAPI({name:"greeting_step",value:"go"})}).finally(function(){TS.ims.message_received_sig.remove(onSlackbotRebound,TS.newxp)})}).then(function(){if(TS.model.prefs.onboarding_slackbot_conversation_step>1)return Promise.resolve();return new Promise(function(resolve){onSlackbotRebound=onSlackbot.bind(null,resolve);TS.ims.message_received_sig.add(onSlackbotRebound,TS.newxp);TS.metrics.measure("sending_api_call_to_queue_slackbot","onboarding_btn_click");TS.metrics.mark("onboarding_api_call");return TS.prefs.setPrefByAPI({name:"greeting_step",value:"start"})}).then(function(){TS.utility.contenteditable.placeholder(TS.client.ui.$msg_input,"Type something");return TS.prefs.setPrefByAPI({name:"onboarding_slackbot_conversation_step",value:1})}).finally(function(){TS.metrics.measure("received_first_slackbot_msg_from_onboarding_button","onboarding_btn_click");TS.metrics.measure("received_first_slackbot_msg_from_api_call","onboarding_api_call");TS.metrics.clearMarks("onboarding_btn_click");TS.metrics.clearMarks("onboarding_api_call");TS.ims.message_received_sig.remove(onSlackbotRebound,TS.newxp)})}).then(function(){var slackbot=Promise.resolve().then(function(){var ms=TS.model.prefs.onboarding_slackbot_conversation_step>1?0:3e4;return Promise.delay(ms).then(function(){return new Promise(function(resolve){onSlackbotRebound=onSlackbot.bind(null,resolve);TS.ims.message_received_sig.add(onSlackbotRebound,TS.newxp);return TS.prefs.setPrefByAPI({name:"intro_step",value:"notyping_1"})}).then(function(){TS.utility.contenteditable.placeholder(TS.client.ui.$msg_input,"Type something");TS.client.ui.$msg_input.addClass("onboarding");TS.client.ui.files.$file_btn.addClass("onboarding");return TS.prefs.setPrefByAPI({name:"onboarding_slackbot_conversation_step",value:2})}).delay(2e3).finally(function(){TS.ims.message_received_sig.remove(onSlackbotRebound,TS.newxp);TS.client.ui.$msg_input.removeClass("onboarding");TS.client.ui.files.$file_btn.removeClass("onboarding")})})}).delay(6e5).then(function(){return new Promise(function(resolve){onSlackbotRebound=onSlackbot.bind(null,resolve);TS.ims.message_received_sig.add(onSlackbotRebound,TS.newxp);return TS.prefs.setPrefByAPI({name:"intro_step",value:"notyping_2"})}).then(function(){_deferredCancel();user.cancel()}).finally(function(){TS.ims.message_received_sig.remove(onSlackbotRebound,TS.newxp)})});var onSlackbotReceipt=function(resolve,im,msg){if(_isSlackbot(im,msg)&&msg.text.indexOf("Let me show you a couple things about Slack")!=-1)resolve()};var onUserReceipt=function(im,msg){if(_acceptIMMessage(im,msg))slackbot.cancel()};var user=new Promise(function(resolve){TS.ims.message_received_sig.add(onUserReceipt,TS.newxp);onSlackbotReceipt=onSlackbotReceipt.bind(null,resolve);TS.ims.message_received_sig.add(onSlackbotReceipt,TS.newxp);return TS.prefs.setPrefByAPI({name:"greeting_step",value:"expecting"})}).then(function(){TS.utility.contenteditable.placeholder(TS.client.ui.$msg_input,"");return TS.prefs.setMultiPrefsByAPI({onboarding_slackbot_conversation_step:10,seen_onboarding_slackbot_conversation:true})}).finally(function(){TS.ims.message_received_sig.remove(onSlackbotReceipt,TS.newxp);TS.ims.message_received_sig.remove(onUserReceipt,TS.newxp)});return Promise.any([user,slackbot]).finally(function(){if(user)user.cancel();if(slackbot)slackbot.cancel()})}).finally(function(){TS.utility.contenteditable.placeholder(TS.client.ui.$msg_input,"");TS.client.ui.$msg_input.removeClass("onboarding");TS.client.ui.files.$file_btn.removeClass("onboarding");TS.ims.message_received_sig.remove(_onSkipOrStop,TS.newxp);TS.ims.message_received_sig.add(_restartOnGo,TS.newxp);setTimeout(function(){if(TS.ims.message_received_sig.has(_restartOnGo,TS.newxp))TS.ims.message_received_sig.remove(_restartOnGo,TS.newxp)},18e4);return TS.prefs.setMultiPrefsByAPI({intro_step:"",greeting_step:""})})}},channels:{step_name:"onboarding_channels",pref_name:"seen_onboarding_channels",show:"#active_channel_name_overlay, #in_skip_messaging, .coachmark_next_tip",hide:"#footer_overlay, #team_menu_overlay, #col_channels_overlay, #explore_btn_container > .btn, #pre_skip_messaging, #unskip_messaging, .coachmark_ok",style:"#details_toggle, #recent_mentions_toggle, #stars_toggle, #flex_menu_toggle, #search_container, #channel_members_toggle, #rxn_toast_div, #whats_new_burst, #groups_header",unstyle:"#col_channels_footer",promiseTo:function(){var $siblings=$("#starred_div, #direct_messages, #channel_list_invites_link");return new Promise(function(resolve){TS.client.ui.$msg_input.blur();_goToStep(TS.newxp.onboarding.channels);TS.coachmark.start($.extend({},TS.coachmarks.coachmarks.channels,{resolve:resolve,reject:_deferredCancel}));$siblings.addClass("translucent")}).then(function(){TS.prefs.setPrefByAPI({name:"seen_onboarding_channels",value:true});return null}).finally(function(){$siblings.removeClass("translucent")})}},direct_messages:{step_name:"onboarding_direct_messages",pref_name:"seen_onboarding_direct_messages",show:"#active_channel_name_overlay, #in_skip_messaging",show_member:".coachmark_done",show_admin:".coachmark_next_tip",hide:"#footer_overlay, #team_menu_overlay, #col_channels_overlay, #explore_btn_container > .btn, #pre_skip_messaging, #unskip_messaging, .coachmark_ok, .coachmark_invite_people",hide_member:".coachmark_next_tip, .coachmark_skip_link",hide_admin:".coachmark_done",style:"#details_toggle, #recent_mentions_toggle, #stars_toggle, #flex_menu_toggle, #search_container, #channel_members_toggle, #rxn_toast_div, #whats_new_burst, #groups_header",unstyle:"#col_channels_footer",promiseTo:function(){var $siblings=$("#starred_div, #channels, #channel_list_invites_link");return new Promise(function(resolve){_goToStep(TS.newxp.onboarding.direct_messages);TS.coachmark.start($.extend({},TS.coachmarks.coachmarks.direct_messages,{resolve:resolve,reject:_deferredCancel}));$siblings.addClass("translucent")}).then(function(){TS.prefs.setPrefByAPI({name:"seen_onboarding_direct_messages",value:true});return null}).finally(function(){$siblings.removeClass("translucent")})}},invites:{step_name:"onboarding_invites",pref_name:"seen_onboarding_invites",show:"#active_channel_name_overlay, #in_skip_messaging",show_admin:".coachmark_invite_people, .coachmark_close",hide:"#footer_overlay, #team_menu_overlay, #col_channels_overlay, #explore_btn_container > .btn, #pre_skip_messaging, #unskip_messaging, .coachmark_next_tip, .coachmark_done, .coachmark_ok",style:"#details_toggle, #recent_mentions_toggle, #stars_toggle, #flex_menu_toggle, #search_container, #channel_members_toggle, #rxn_toast_div, #whats_new_burst, #groups_header",unstyle:"#quick_switcher_btn",promiseTo:function(){var $siblings=$("#starred_div, #channels, #direct_messages");return new Promise(function(resolve){_goToStep(TS.newxp.onboarding.invites);TS.coachmark.start($.extend({},TS.coachmarks.coachmarks.invites,{resolve:resolve,reject:_deferredCancel}));$siblings.addClass("translucent")}).then(function(){TS.prefs.setPrefByAPI({name:"seen_onboarding_invites",value:true});return null}).finally(function(){$siblings.removeClass("translucent")})}},search:{step_name:"onboarding_search",pref_name:"seen_onboarding_search",promiseTo:function(){var $target,$starburst,$wrapper,$parent;return new Promise(function(resolve,reject){$target=$("#search_container .highlighter_wrapper");_addClickTickStarburst($target);$starburst=$target.find(".starburst");$wrapper=$target.find(".starburst_wrapper");$parent=$("#search_container");_addClickTickInteractions(TS.coachmark.start.bind(null,$.extend({},TS.coachmarks.coachmarks.search,{resolve:resolve,reject:reject.bind(null,new Error("Click-tick onboarding cancelled"))})),$target,$starburst,$wrapper,$parent)}).then(function(){TS.prefs.setPrefByAPI({name:"seen_onboarding_search",value:true});return null}).finally(function(){_removeClickTickInteractions($target,null,$wrapper);_removeClickTickStarburst($target)})}},recent_mentions:{step_name:"onboarding_recent_mentions",pref_name:"seen_onboarding_recent_mentions",promiseTo:function(){var $target,$starburst;return new Promise(function(resolve,reject){$target=$("#recent_mentions_toggle");_addClickTickStarburst($target);$starburst=$target.find(".starburst");_addClickTickInteractions(TS.coachmark.start.bind(null,$.extend({},TS.coachmarks.coachmarks.recent_mentions,{resolve:resolve,reject:reject.bind(null,new Error("Click-tick onboarding cancelled"))})),$target,$starburst)}).then(function(){TS.prefs.setPrefByAPI({name:"seen_onboarding_recent_mentions",value:true});return null}).finally(function(){_removeClickTickInteractions($target,$starburst);_removeClickTickStarburst($target)})}},starred_items:{step_name:"onboarding_starred_items",pref_name:"seen_onboarding_starred_items",promiseTo:function(){var $target,$starburst;return new Promise(function(resolve,reject){$target=$("#stars_toggle");_addClickTickStarburst($target);$starburst=$target.find(".starburst");_addClickTickInteractions(TS.coachmark.start.bind(null,$.extend({},TS.coachmarks.coachmarks.starred_items,{resolve:resolve,reject:reject.bind(null,new Error("Click-tick onboarding cancelled"))})),$target,$starburst)}).then(function(){TS.prefs.setPrefByAPI({name:"seen_onboarding_starred_items",value:true});return null}).finally(function(){_removeClickTickInteractions($target,$starburst);_removeClickTickStarburst($target)})}},private_groups:{step_name:"onboarding_private_groups",pref_name:"seen_onboarding_private_groups",promiseTo:function(){var $target,$wrapper;return new Promise(function(resolve,reject){$target=$("#groups_header");$wrapper=$target.find(".starburst_wrapper");_addClickTickInteractions(TS.coachmark.start.bind(null,$.extend({},TS.coachmarks.coachmarks.private_groups,{resolve:resolve,reject:reject.bind(null,new Error("Click-tick onboarding cancelled"))})),$target,null,$wrapper)}).then(function(){TS.prefs.setPrefByAPI({name:"seen_onboarding_private_groups",value:true});return null}).finally(function(){_removeClickTickInteractions($target,null,$wrapper);_removeClickTickStarburst($target)})}}},onStart:function(){if(!TS.client)return;TS.client.login_sig.add(TS.newxp.onLogin,TS.newxp,-1);TS.prefs.seen_welcome_2_changed_sig.add(TS.newxp.setSeenWelcome2)},setSeenWelcome2:function(){TS.model.seen_welcome_2=TS.model.prefs.seen_welcome_2},onLogin:function(){if(TS.boot_data.prefs_seen_welcome_2!==undefined){TS.model.seen_welcome_2=TS.boot_data.prefs_seen_welcome_2}else{TS.model.seen_welcome_2=TS.model.prefs.seen_welcome_2}TS.newxp.startOnboarding()},shouldShowFirstWelcome:function(){if(TS.boot_data.incremental_boot_data&&(_.get(TS.boot_data.incremental_boot_data,"self.prefs.seen_welcome_2",undefined)===false||TS.boot_data.prefs_seen_welcome_2===false)){return true}if(TS.model&&TS.model.seen_welcome_2)return false;if(!(TS.model&&TS.model.welcome_model_ob&&TS.model.welcome_model_ob.id))return false;var model_ob=TS.shared.getActiveModelOb();if(!model_ob)return false;if(model_ob.id==TS.model.welcome_model_ob.id)return true;return false},inOnboarding:function(){return _in_onboarding},startOnboarding:function(){if(TS.model.seen_welcome_2)return;_maybeUpdateSeenWelcome2();if(TS.model.seen_welcome_2)return;if(_shouldDirectToSlackbotForOnboarding())TS.ims.startImByMemberName("slackbot");TS.experiment.loadUserAssignments().then(function(){var group=TS.experiment.getGroup("portal_onboarding_v1");if(group==="treatment"){TS.model.seen_onboarding_this_session=true;TS.newxp.cancelOnboarding();_goToStep(TS.newxp.onboarding.cancel,group);$("#unskip_messaging > .take_tutorial_link").off("click.take_onboarding").on("click.take_onboarding",_startOnboarding);$("#onboarding_welcome_text").remove();$("#onboarding_welcome_message").remove();$("#unskip_messaging").remove();_in_onboarding=false;if(_banner_was_visible){TS.ui.banner.show();TS.client.ui.$banner.removeClass("hidden")}TS.model.seen_welcome_2=true;$("#end_display_onboarding").addClass("hidden");TS.client.msg_pane.updateEndMarker();TS.client.msg_pane.padOutMsgsScroller();_disableScrollFadeOut();return}_setupCoachmarkExperiment()});if(TS.model.prefs.onboarding_cancelled){_goToStep(TS.newxp.onboarding.cancel);$("#unskip_messaging > .take_tutorial_link").off("click.take_onboarding").on("click.take_onboarding",_startOnboarding);$("#end_display_onboarding").removeClass("hidden")}else{TS.model.seen_onboarding_this_session=true;_banner_was_visible=!TS.client.ui.$banner.hasClass("hidden");_goToStep(TS.newxp.onboarding.loading);_startOnboarding()}},cancelOnboarding:function(){if(!TS.newxp.shouldShowFirstWelcome()){$("#end_display_onboarding").addClass("hidden")}_deferredCancel()},getCurrentStepName:function(){return _current_step_name},canIncludeInviteCTA:function(){return _canIncludeInviteCTA()},test:function(){return{deferredCancel:_deferredCancel,startOnboarding:_startOnboarding,goToStep:_goToStep,getBaseSteps:_getBaseSteps,getUserSteps:_getUserSteps,composeUserOnboarding:_composeUserOnboarding,composeCancelOnboarding:_composeCancelOnboarding,acceptIMMessage:_acceptIMMessage,isSlackbot:_isSlackbot,onSkipOrStop:_onSkipOrStop,restartOnGo:_restartOnGo,waitAllOrCancel:_waitAllOrCancel,enableScrollFadeOut:_enableScrollFadeOut,disableScrollFadeOut:_disableScrollFadeOut,addClickTickStarburst:_addClickTickStarburst,removeClickTickStarburst:_removeClickTickStarburst,addClickTickInteractions:_addClickTickInteractions,removeClickTickInteractions:_removeClickTickInteractions,shouldDirectToSlackbotForOnboarding:_shouldDirectToSlackbotForOnboarding}}});var _in_onboarding=false;var _click_tick=null;var _user_onboarding=null;var _cancel_onboarding=null;var _restart_was_on_go=false;var _banner_was_visible=false;var _current_step_name="";var _can_include_invite_cta=false;var _deferredCancel=function(){if(_user_onboarding){_user_onboarding.finally(function(){if(_user_onboarding.isCancelled()&&_cancel_onboarding)_cancel_onboarding.cancel()});_user_onboarding.cancel()}else{if(_cancel_onboarding)_cancel_onboarding.cancel()}};var _startOnboarding=function(){_deferredCancel();if(TS.model.ui_state.flex_visible)TS.client.ui.flex.hideFlex();if(TS.model.prefs.onboarding_cancelled)TS.prefs.setPrefByAPI({name:"onboarding_cancelled",value:false});TS.prefs.onPrefChanged({name:"onboarding_cancelled",value:false});_enableScrollFadeOut();_user_onboarding=_composeUserOnboarding();_cancel_onboarding=_composeCancelOnboarding();if(!TS.model.user.is_restricted&&!_click_tick)_click_tick=_composeClickTickOnboarding();$("#end_display_onboarding").removeClass("hidden")};var _goToStep=function(step,group){_current_step_name=step.step_name;$(step.show).removeClass("hidden");$(step.hide).addClass("hidden");$(step.style).addClass("onboarding");$(step.unstyle).removeClass("onboarding");if(TS.boot_data.feature_update_coachmarks_cta&&TS.newxp.canIncludeInviteCTA()){if(TS.ui.admin_invites.canInvite()&&TS.members.getActiveMembersWithSelfAndNotSlackbot().length<26){$(step.hide_admin).addClass("hidden");$(step.show_admin).removeClass("hidden")}else{$(step.hide_member).addClass("hidden");$(step.show_member).removeClass("hidden")}}if(group==="treatment"){TS.clog.track("GROWTH_ONBOARDING",{action:"enter_step",
step:_current_step_name})}};var _getBaseSteps=function(){var group=TS.experiment.getGroup("onboarding_video");if(group==="treatment"){var user_steps=["video_start","slackbot","channels","direct_messages","complete"]}else{var user_steps=["start","slackbot","channels","direct_messages","complete"]}if(TS.ui.admin_invites.canInvite()&&TS.members.getActiveMembersWithSelfAndNotSlackbot().length<26)user_steps.splice(4,0,"invites");return user_steps};var _getUserSteps=function(){return _getBaseSteps().filter(function(step_name){return!TS.model.prefs[TS.newxp.onboarding[step_name].pref_name]})};var _composeUserOnboarding=function(){_in_onboarding=true;return TS.experiment.loadUserAssignments().then(function(){var promise;_getUserSteps().forEach(function(step_name){promise=!promise?TS.newxp.onboarding[step_name].promiseTo():promise.then(TS.newxp.onboarding[step_name].promiseTo)});if(promise){if(!_user_onboarding)TS.client.ui.$banner.addClass("hidden");TS.ui.banner.close();promise.finally(function(){_in_onboarding=false;if(_banner_was_visible){TS.ui.banner.show();TS.client.ui.$banner.removeClass("hidden")}if(promise.isCancelled())return;TS.model.seen_welcome_2=true;$("#end_display_onboarding").addClass("hidden");TS.client.msg_pane.updateEndMarker();TS.client.msg_pane.padOutMsgsScroller();_disableScrollFadeOut()})}else{_in_onboarding=false}return promise})};var _composeCancelOnboarding=function(){return TS.newxp.onboarding.cancel.promiseTo()};var _composeClickTickOnboarding=function(){var promises=["search","recent_mentions","starred_items"].filter(function(step_name){return!TS.model.prefs[TS.newxp.onboarding[step_name].pref_name]}).map(function(step_name){return TS.newxp.onboarding[step_name].promiseTo()});return _waitAllOrCancel(promises)};var _acceptIMMessage=function(im,msg){return im.id==TS.model.active_im_id&&TS.members.getMemberById(im.user).is_slackbot&&msg&&TS.members.getMemberById(msg.user).is_self};var _isSlackbot=function(im,msg){return im&&msg&&im.user==msg.user&&TS.members.getMemberById(im.user).is_slackbot};var _onSkipOrStop=function(im,msg){if(_isSlackbot(im,msg)&&msg.text.indexOf("Okay, we can skip this conversation")!=-1)_deferredCancel()};var _restartOnGo=function(im,msg){if(_isSlackbot(im,msg)&&msg.text.indexOf("Lovely, where were we? Ah, yes...")!=-1){TS.ims.message_received_sig.remove(_restartOnGo,TS.newxp);if(TS.model.prefs.onboarding_cancelled&&TS.newxp.shouldShowFirstWelcome()){_startOnboarding();_restart_was_on_go=true}}};var _waitAllOrCancel=function(promises){return Promise.all(promises).then(_.noop,function(){promises.forEach(function(promise){promise.cancel()})})};var _enableScrollFadeOut=function(){var $fade_out=$("#onboarding_fade_out_mask").removeClass("hidden");TS.client.ui.$msgs_scroller_div.on("scroll.onboarding",function(){if(TS.client.ui.$msgs_scroller_div[0].scrollTop>300){if(!$fade_out.hasClass("hidden"))$fade_out.addClass("hidden")}else{if($fade_out.hasClass("hidden"))$fade_out.removeClass("hidden")}})};var _disableScrollFadeOut=function(){TS.client.ui.$msgs_scroller_div.off("scroll.onboarding");$("#onboarding_fade_out_mask").addClass("hidden")};var _addClickTickStarburst=function($placement_el){$placement_el.append($("<div class='starburst_wrapper'><span class='starburst'></span></div>"))};var _removeClickTickStarburst=function($placement_el){$placement_el.find("> .starburst_wrapper").remove()};var _addClickTickInteractions=function(event,$target,$starburst,$wrapper,$parent){$target=$target||$();$starburst=$starburst||$();$parent=$parent||$target;$wrapper=$wrapper||$starburst;$target.on("mouseenter.onboarding",function(){if($parent.hasClass("onboarding"))return;$starburst.css("opacity",1);if(event)event()}).on("mouseleave.onboarding",function(){if($target.hasClass("onboarding"))return;if(TS.coachmark.is_showing&&TS.coachmark.is_small){TS.coachmark.end();$starburst.css("opacity",0)}}).addClass("jquery_hover");if($wrapper!=$starburst)$wrapper.css("height",$target.outerHeight(true)).css("width",$target.outerWidth(true));$wrapper.on("click.onboarding",function(e){if(e)e.stopPropagation();TS.coachmark.expand()})};var _removeClickTickInteractions=function($target,$starburst,$wrapper){$starburst=$starburst||$();$wrapper=$wrapper||$starburst;$target.off("mouseenter.onboarding mouseleave.onboarding").removeClass("jquery_hover");$wrapper.off("click.onboarding")};var _shouldDirectToSlackbotForOnboarding=function(){return!TS.newxp.shouldShowFirstWelcome()&&!TS.model.prefs.onboarding_cancelled};var _maybeUpdateSeenWelcome2=function(){var shouldShow=TS.newxp.shouldShowFirstWelcome();var flip=!shouldShow&&(TS.model.prefs.onboarding_cancelled||TS.model.prefs.seen_onboarding_start)||shouldShow&&(TS.model.prefs.onboarding_cancelled||TS.model.prefs.seen_onboarding_start)&&!TS.model.seen_onboarding_this_session;if(flip){TS.model.seen_welcome_2=true;TS.client.msg_pane.updateEndMarker();TS.client.msg_pane.padOutMsgsScroller()}};var _setupCoachmarkExperiment=function(){if(!TS.boot_data.feature_update_coachmarks_cta)return;var group=TS.experiment.getGroup("update_invite_coachmarks_cta");if(group==="invite_cm_invite_people"){var additional_show_hide={complete:{show:".coachmark_got_it"},invites:{hide:".coachmark_got_it"}};_can_include_invite_cta=true;for(var step in additional_show_hide){for(var prop in additional_show_hide[step]){TS.newxp.onboarding[step][prop]+=", "+additional_show_hide[step][prop]}}}};var _canIncludeInviteCTA=function(){return _can_include_invite_cta}})();(function(){"use strict";TS.registerModule("ui.msg_tab_complete",{$input:null,onStart:function(){},start:function($input){if(_initialized)return;_initialized=true;TS.ui.msg_tab_complete.$input=$input;$input.tab_complete_ui({id:"chat_input_tab_ui"})},positionUI:function(){if(!_initialized)return;TS.ui.msg_tab_complete.$input.tab_complete_ui("positionUI")},isShowing:function(){return _initialized&&TS.ui.msg_tab_complete.$input.tab_complete_ui("isShowing")}});var _initialized=false})();(function(){"use strict";TS.registerModule("typing",{typing_self_lasts_ms:3e3,typing_lasts_ms:6e3,started_sig:new signals.Signal,ended_sig:new signals.Signal,map:{},onStart:function(){setInterval(TS.typing.checkMap,1e3)},userStarted:function(model_ob){if(!TS.model.ms_connected)return;if(!model_ob)return;var member=TS.model.user;var key=model_ob.id+"_"+member.id;if(TS.typing.map[key])return;TS.ms.sendTyping(model_ob.id);TS.typing.memberStarted(model_ob,TS.model.user)},memberStarted:function(model_ob,member){var key=model_ob.id+"_"+member.id;var now=Date.now();if(TS.typing.map[key]){TS.typing.map[key].started=now;TS.log(47,"updated "+key)}else{TS.typing.map[key]={started:now,model_ob:model_ob,member:member};TS.log(47,"added "+key);TS.typing.started_sig.dispatch(model_ob,member)}},userEnded:function(model_ob){if(!model_ob)return;var member=TS.model.user;TS.typing.memberEnded(model_ob,member)},memberEnded:function(model_ob,member){var key=model_ob.id+"_"+member.id;TS.typing.expungeMember(model_ob,member);TS.log(47,"removed "+key)},expungeMember:function(model_ob,member){var key=model_ob.id+"_"+member.id;delete TS.typing.map[key];TS.typing.ended_sig.dispatch(model_ob,member)},checkMap:function(){var now=Date.now();var record;for(var key in TS.typing.map){record=TS.typing.map[key];var lasts_ms=record.member.is_self?TS.typing.typing_self_lasts_ms:TS.typing.typing_lasts_ms;var elapsed_ms=now-record.started;if(elapsed_ms>=lasts_ms){TS.typing.memberEnded(record.model_ob,record.member);TS.log(47,"removed "+key+" after "+elapsed_ms)}}},getTypersInChannel:function(c_id){var A=[];var record;for(var key in TS.typing.map){record=TS.typing.map[key];if(record.model_ob.id==c_id&&!record.member.is_self){A.push(record.member)}}A.sort(function(a,b){if(TS.members.getMemberDisplayNameLowerCase(a)<TS.members.getMemberDisplayNameLowerCase(b))return-1;if(TS.members.getMemberDisplayNameLowerCase(a)>TS.members.getMemberDisplayNameLowerCase(b))return 1;return 0});return A}})})();(function(){"use strict";TS.registerModule("ui.shortcuts_dialog",{$div:null,showing:false,is_space:false,onStart:function(){},onKeydown:function(e){if(!TS.ui.shortcuts_dialog.showing)return;if(e.which==TS.utility.keymap.enter||e.which==TS.utility.keymap.esc){TS.ui.shortcuts_dialog.cancel();e.preventDefault()}if(e.which==70&&TS.utility.cmdKey(e)){e.preventDefault()}},start:function(){TS.ui.shortcuts_dialog.is_space=TS.web&&TS.web.space;if(!TS.ui.shortcuts_dialog.$div)TS.ui.shortcuts_dialog.build();var html=TS.templates.shortcuts_dialog({meta_key:TS.model.is_mac?"Option":"Alt",cmd_key:TS.model.is_mac?"Cmd":"Ctrl",cmd_key_label:TS.model.is_mac?"Command":"Control",can_show_a11y_keyboard_shortcuts:TS.boot_data.feature_a11y_keyboard_shortcuts,can_show_unread_view:TS.boot_data.feature_unread_view&&TS.client&&TS.client.unread.isEnabled(),show_browse_dms_shortcut:true});if(TS.ui.shortcuts_dialog.is_space){html=TS.templates.shortcuts_spaces_dialog({clear_formatting:!TS.model.is_win,meta_key:TS.model.is_mac?"Option":"Alt",cmd_key:TS.model.is_mac?"Cmd":"Ctrl",cmd_key_label:TS.model.is_mac?"Command":"Control"})}var $div=TS.ui.shortcuts_dialog.$div;$div.html(html).modal("show").find(".dialog_cancel").click(TS.ui.shortcuts_dialog.cancel);if(!TS.ui.shortcuts_dialog.is_space)TS.ui.a11y.saveCurrentFocusAndFocusOnElement($div)},cancel:function(){TS.ui.shortcuts_dialog.$div.modal("hide")},end:function(){TS.ui.shortcuts_dialog.showing=TS.model.dialog_is_showing=false;TS.ui.shortcuts_dialog.$div.empty();$(window.document).unbind("keydown",TS.ui.shortcuts_dialog.onKeydown);if(!TS.ui.shortcuts_dialog.is_space)TS.ui.a11y.restorePreviousFocusAndCleanUpElement(TS.ui.shortcuts_dialog.$div)},build:function(){var $div;if(TS.ui.shortcuts_dialog.is_space){$("body").append('<div id="shortcuts_spaces_dialog" class="modal hide fade"></div>');$div=TS.ui.shortcuts_dialog.$div=$("#shortcuts_spaces_dialog")}else{$("body").append('<div id="shortcuts_dialog" class="modal hide fade"></div>');$div=TS.ui.shortcuts_dialog.$div=$("#shortcuts_dialog")}$div.on("hidden",function(e){if(e.target!=this)return;TS.ui.shortcuts_dialog.end()});$div.on("show",function(e){if(e.target!=this)return;TS.ui.shortcuts_dialog.showing=TS.model.dialog_is_showing=true});$div.on("shown",function(e){if(e.target!=this)return;$(window.document).bind("keydown",TS.ui.shortcuts_dialog.onKeydown)})}})})();(function(){"use strict";TS.registerModule("ui.channel_options_dialog",{div:null,showing:false,c_id:null,ladda:null,onKeydown:function(e){if(!TS.ui.channel_options_dialog.showing)return;if(e.which===TS.utility.keymap.esc)TS.ui.channel_options_dialog.cancel()},start:function(c_id){TS.ui.channel_options_dialog.c_id=c_id;_start()},go:function(){if(!TS.ui.channel_options_dialog.showing){TS.error("not showing?");return}var div=TS.ui.channel_options_dialog.div;div.modal("hide")},cancel:function(){TS.ui.channel_options_dialog.div.modal("hide")},end:function(){TS.ui.channel_options_dialog.c_id=null;TS.ui.channel_options_dialog.showing=TS.model.dialog_is_showing=false;$(window.document).unbind("keydown",TS.ui.channel_options_dialog.onKeydown)},build:function(){$("body").append('<div id="channel_options_dialog" class="modal hide fade"></div>');var $div=TS.ui.channel_options_dialog.div=$("#channel_options_dialog");$div.on("hide",function(e){if(e.target!=this)return;TS.ui.channel_options_dialog.end()});$div.on("show",function(e){if(e.target!=this)return;TS.ui.channel_options_dialog.showing=TS.model.dialog_is_showing=true});$div.on("shown",function(e){if(e.target!=this)return;setTimeout(function(){$(window.document).bind("keydown",TS.ui.channel_options_dialog.onKeydown)},100)})},addTempEphemeralFeedback:function(text){TS.client.ui.addOrFlashEphemeralBotMsg({text:text})}});var _$all_options;var _$current_option;var _start=function(){var model_ob=TS.shared.getModelObById(TS.ui.channel_options_dialog.c_id);if(!model_ob||model_ob.is_im){TS.generic_dialog.alert('<p class="no_bottom_margin">Oops! No channel found???</p>');return}var c_or_g=model_ob.is_channel?"channel":"group";var show_convert_btn=false;if(c_or_g==="channel"&&!model_ob.is_general&&TS.model.user.is_admin){show_convert_btn=TS.members.canUserCreateGroups()}var show_archive_btn=false;if(!model_ob.is_general){var do_check=true;if(TS.boot_data.page_needs_enterprise&&model_ob.is_shared){if(TS.boot_data.feature_shared_channels_settings&&!TS.members.canUserManageSharedChannels()){do_check=false}else if(!TS.model.user.enterprise_user.is_owner){do_check=false}}if(do_check)show_archive_btn=c_or_g==="channel"&&TS.permissions.members.canArchiveChannels()||c_or_g==="group"&&TS.permissions.members.canArchiveChannels()&&!TS.model.user.is_restricted}var show_rename_btn=false;if(TS.boot_data.page_needs_enterprise&&model_ob.is_shared&&TS.boot_data.feature_shared_channels_settings&&TS.members.canUserManageSharedChannels()){show_rename_btn=true}else{if(TS.model.user.is_admin||model_ob.creator===TS.model.user.id)show_rename_btn=true}var show_purpose_btn=false;if(!TS.model.user.is_ultra_restricted&&(!model_ob.is_general||TS.members.canUserPostInGeneral()))show_purpose_btn=true;var show_data_retention_link=false;if(TS.model.team.plan!==""&&(TS.model.user.is_owner||c_or_g==="group")&&TS.model.team.prefs.allow_retention_override)show_data_retention_link=true;var show_manage_posting_privilege_btn=false;if(TS.boot_data.feature_shared_channels_settings&&TS.boot_data.page_needs_enterprise&&model_ob.is_shared&&TS.members.canUserManageSharedChannels()){show_manage_posting_privilege_btn=true}var show_convert_to_shared_btn=false;if(TS.boot_data.page_needs_enterprise&&!model_ob.is_shared&&(TS.boot_data.feature_allow_shared_general||!model_ob.is_general)){if(TS.members.canUserCreateConvertSharedChannels())show_convert_to_shared_btn=true}var template_args={c_or_g:c_or_g,model_ob:model_ob,show_convert_btn:show_convert_btn,show_archive_btn:show_archive_btn,show_rename_btn:show_rename_btn,show_purpose_btn:show_purpose_btn,show_data_retention_link:show_data_retention_link,show_convert_to_shared_btn:show_convert_to_shared_btn,show_manage_posting_privilege_btn:show_manage_posting_privilege_btn};var settings={title:"Additional Options for #"+model_ob.name,body_template_html:TS.templates.channel_options_dialog(template_args),onShow:_onShow,onCancel:_onCancel,modal_class:"channel_options_modal"};TS.ui.fs_modal.start(settings)};var _onShow=function(){var model_ob=TS.shared.getModelObById(TS.ui.channel_options_dialog.c_id);TS.ui.channel_options_dialog.div=$(".channel_options_modal");_$all_options=TS.ui.channel_options_dialog.div.find('.channel_options_section[data-section="options"]');_$current_option=TS.ui.channel_options_dialog.div.find('.channel_options_section[data-section="option"]');_$all_options.on("click",".channel_option_item",function(e){var action=$(this).data("action");_updateBackButton();switch(action){case"channel_archive_btn":_showArchiveChannel(model_ob);break;case"group_archive_btn":_showArchiveGroup(model_ob);break;case"channel_convert_btn":_showConvertChannel(model_ob);break;case"shared_channel_convert_btn":_showConvertShared(model_ob);break;case"channel_rename_btn":_showRenameChannel(model_ob);break;case"channel_purpose_btn":_showPurposeChannel(model_ob);break;case"data_retention_btn":_showDataRetention(model_ob);break;case"posting_privilege_btn":_showPostingPrivileges(model_ob);break;default:break}});TS.ui.channel_options_dialog.div.find(".option_cancel").on("click",_showAllOptions);TS.ui.channel_options_dialog.div.find(".option_go").on("click",_optionGo)};var _createChannelNameMarkup=function(model_ob){var channel_name;if(model_ob.is_channel){channel_name="#"+TS.utility.htmlEntities(model_ob.name)}else if(model_ob.is_group){channel_name='<ts-icon class="ts_icon_inherit ts_icon_lock"></ts-icon>'+TS.utility.htmlEntities(model_ob.name)}else{channel_name="this conversation"}var shared=TS.boot_data.page_needs_enterprise&&model_ob.is_shared?' <ts-icon class="ts_icon_org_shared_channel"></ts-icon>':"";return"<strong>"+channel_name+shared+"</strong>"};var _maybeCreateLadda=function(){if(TS.ui.channel_options_dialog.ladda)return;TS.ui.channel_options_dialog.ladda=Ladda.create(TS.ui.channel_options_dialog.div.find(".option_go")[0])};var _onCancel=function(){_updateBackButton(true)};var _current_option_go_callback=_.noop;var _optionGo=function(){_current_option_go_callback()};var _updateBackButton=function(unbind){if(unbind){TS.ui.fs_modal.unbindBackButton();TS.ui.fs_modal.hideBackButton()}else{TS.ui.fs_modal.bindBackButton(_showAllOptions);TS.ui.fs_modal.showBackButton()}};var _showOptionsSection=function(){_$current_option.hide();_$all_options.show()};var _showOptionSection=function(start_ladda){_$all_options.hide();_$current_option.show();if(start_ladda)_maybeCreateLadda()};var _showAllOptions=function(){_updateBackButton(true);_showOptionsSection()};var _setHeaderHtml=function(html){_$current_option.find(".channel_options_header").html(html)};var _setOptionContentHtml=function(html){_$current_option.find(".channel_option_content").html(html)};var _setOptionGoText=function(text){_$current_option.find(".option_go .ladda-label").text(text)};var _toggleOptionGoButton=function(disable){if(!disable)disable=false;_$current_option.find(".option_go").toggleClass("disabled",disable)};var _hideOptionButtons=function(){_$current_option.find(".channel_option_buttons").hide()};var _showOptionButtons=function(){_$current_option.find(".channel_option_buttons").show()};var _showArchiveChannel=function(model_ob){_setHeaderHtml("Archive "+_createChannelNameMarkup(model_ob));var template_args={name:model_ob.name,is_shared:TS.boot_data.page_needs_enterprise&&model_ob.is_shared};_setOptionContentHtml(TS.templates.channel_option_archive_channel(template_args));_setOptionGoText("Yes, archive the channel");_current_option_go_callback=function(){if(TS.ui.channel_options_dialog.ladda)TS.ui.channel_options_dialog.ladda.start();TS.api.call("channels.archive",{channel:model_ob.id},function(ok,data,args){if(TS.ui.channel_options_dialog.ladda)TS.ui.channel_options_dialog.ladda.stop();if(ok){if(TS.web){$("p.alert").addClass("hidden");$("#archive_success").removeClass("hidden");$("#archive_btn").addClass("hidden");$("#unarchive_btn").removeClass("hidden")}TS.ui.fs_modal.close();return}var err_str='Archiving failed with error "'+data.error+'"';if(data.error==="last_ra_channel"){err_str="Sorry, you can't archive this channel because it is the only channel one of the guest account members belongs to.";if(TS.model.user.is_admin){err_str+=" If you first disable the guest account, you will then be able to archive the channel."}}else if(data.error==="restricted_action"){err_str="<p>You don't have permission to archive channels.</p><p>Talk to your Team Owner.</p>"}else if(data.error==="already_archived"){err_str="This channel was already archived."}else if(data.error==="cant_archive_general"){err_str="This channel cannot be archived."}setTimeout(TS.generic_dialog.alert,500,err_str)})};_showOptionSection(true)};var _showArchiveGroup=function(model_ob){_setHeaderHtml("Archive "+_createChannelNameMarkup(model_ob));_setOptionContentHtml(TS.templates.channel_option_archive_group({name:model_ob.name,group_prefix:TS.model.group_prefix,is_shared:TS.boot_data.page_needs_enterprise&&model_ob.is_shared}));_setOptionGoText("Yes, archive the channel");_current_option_go_callback=function(){if(TS.ui.channel_options_dialog.ladda)TS.ui.channel_options_dialog.ladda.start();TS.api.call("groups.archive",{channel:model_ob.id},function(ok,data,args){if(TS.ui.channel_options_dialog.ladda)TS.ui.channel_options_dialog.ladda.stop();if(ok){TS.ui.fs_modal.close();return}var err_str='Archiving failed with error "'+data.error+'"';if(data.error==="last_ra_channel"){err_str="Sorry, you can't archive this channel because it is the only channel one of the guest account members belongs to.";if(TS.model.user.is_admin){err_str+=" If you first disable the guest account, you will then be able to archive the channel."}}else if(data.error==="already_archived"){err_str="This channel was already archived."}else if(data.error==="restricted_action"){err_str="<p>You don't have permission to archive private channels.</p><p>Talk to your Team Owner.</p>"}setTimeout(TS.generic_dialog.alert,500,err_str)})};_showOptionSection(true)};var _showConvertChannel=function(model_ob){_setHeaderHtml("Convert "+_createChannelNameMarkup(model_ob)+" to a private channel?");_setOptionContentHtml(TS.templates.channel_conversion_dialog({name:TS.utility.htmlEntities(model_ob.name)}));_setOptionGoText("Yes, convert the channel");_current_option_go_callback=function(){if(TS.ui.channel_options_dialog.ladda)TS.ui.channel_options_dialog.ladda.start();TS.api.call("channels.convertToGroup",{channel:model_ob.id},function(ok,data,args){if(TS.ui.channel_options_dialog.ladda)TS.ui.channel_options_dialog.ladda.stop();if(ok){TS.ui.fs_modal.close();return}var err_str='converting to private channel failed with error "'+data.error+'"';if(data.error==="restricted_action"){err_str="<p>You don't have permission to create private channels.</p><p>Talk to your Team Owner.</p>"}else if(data.error==="last_ra_channel"){err_str="<p>Sorry, you can't convert this channel because it is the only channel one of the guest account members belongs to. If you first disable the guest account, you will then be able to convert the channel.</p>"}else if(data.error==="name_taken"){err_str='<p>Converting this channel failed because of a naming collision, which should never happen, but did. Please <a href="/help/requests/new">let us know</a> this happened.</p>'}setTimeout(TS.generic_dialog.alert,500,err_str)})};_showOptionSection(true)};var _showConvertShared=function(model_ob){_setHeaderHtml("Convert "+_createChannelNameMarkup(model_ob)+" to a shared channel");var channel_conversion_dialog_args={name:TS.utility.htmlEntities(model_ob.name),purpose:TS.utility.htmlEntities(model_ob.purpose.value)};if(TS.boot_data.page_needs_enterprise)channel_conversion_dialog_args.enterprise_info=TS.model.enterprise;_setOptionContentHtml(TS.templates.shared_channel_conversion_dialog(channel_conversion_dialog_args));_setOptionGoText("Convert to Shared Channel");_current_option_go_callback=function(){if(TS.ui.channel_options_dialog.ladda)TS.ui.channel_options_dialog.ladda.start();var $convert_to_shared=_$current_option.find(".convert_to_shared");var $checked;var validation=TS.ui.validation.validate($convert_to_shared.find('[name="channel_name"]'));if(!validation){if(TS.ui.channel_options_dialog.ladda)TS.ui.channel_options_dialog.ladda.stop();_toggleOptionGoButton(true);return}$convert_to_shared.find('[type="radio"][name="share_with"]').each(function(index,radio){if(radio.checked){$checked=$(radio);return false}});var calling_args={channel_id:model_ob.id};if($checked.val()==="all"){calling_args.all_teams=true}else{var domains=$('[name="domains"]').data("TS-lazyFilterSelect").value();domains=domains.map(function(domain){return domain.team.domain}).join(",");calling_args.target_domains=domains}var new_name=$convert_to_shared.find('[name="channel_name"]').val().trim();calling_args.channel_name=new_name;var purpose=$convert_to_shared.find('[name="purpose"]').val().trim();calling_args.purpose=purpose;var current_model_ob=TS.shared.getActiveModelOb();var api_endpoint=current_model_ob.is_group?"enterprise.groups.createShared":"enterprise.channels.createShared";TS.api.call(api_endpoint,calling_args,function(ok,data,args){if(TS.ui.channel_options_dialog.ladda)TS.ui.channel_options_dialog.ladda.stop();if(ok){TS.ui.fs_modal.close();return}var err_str='converting to private channel failed with error "'+data.error+'"';if(data.error==="restricted_action"){err_str="<p>You don't have permission to create private channels.</p><p>Talk to your Team Owner.</p>"}else if(data.error==="last_ra_channel"){err_str="<p>Sorry, you can't convert this channel because it is the only channel one of the guest account members belongs to. If you first disable the guest account, you will then be able to convert the channel.</p>"}setTimeout(TS.generic_dialog.alert,500,err_str)})};_showOptionSection(true);_bindConvertSharedUI()};var _name_check_wait_time=325;var _name_check_timer;var _bad_channel_name=false;var _bindConvertSharedUI=function(){var $convert_to_shared=_$current_option.find(".convert_to_shared");$convert_to_shared.on("change",'[type="radio"][name="share_with"]',function(e){var $el=$(this);var checked=$el.val();var show_specific=checked==="specific";$convert_to_shared.find(".specific_team").toggleClass("hidden",!show_specific);var dialog_go_disabled=false;if(show_specific)dialog_go_disabled=!($convert_to_shared.find('[name="domains"]').val().trim().length>0);_toggleOptionGoButton(dialog_go_disabled)});$convert_to_shared.find('[name="domains"]').each(function(index,el){var $el=$(el);var teams=TS.boot_data.page_needs_enterprise?_.filter(TS.model.enterprise_teams,function(team){return team.id!==TS.model.team.id}):[];TS.ui.team_picker.make($el,{teams:teams,classes:"normal_style team_picker"});$el.on("change",function(){var value=TS.ui.team_picker.value($el).map(function(item){return item.team.domain}).join(",");$el.val(value)})});$convert_to_shared.on("change",'[name="domains"]',function(e){var $el=$(this);var trimmed_val=$el.val().trim();if(!_bad_channel_name)_toggleOptionGoButton(!(trimmed_val.length>0))});$convert_to_shared.on("click",".current_channel_name a",function(e){e.preventDefault();$convert_to_shared.find(".current_channel_name").addClass("hidden");$convert_to_shared.find(".change_channel_name").removeClass("hidden")});$convert_to_shared.on("click",".current_channel_purpose a",function(e){e.preventDefault();$convert_to_shared.find(".current_channel_purpose").addClass("hidden");$convert_to_shared.find(".change_channel_purpose").removeClass("hidden")});var $channel_name=$convert_to_shared.find('[name="channel_name"]');$channel_name.on("focus",function(e){$(".validation_message").remove()});$channel_name.on("input paste change blur",function(e){e.preventDefault();e.stopPropagation();$(".validation_message").remove();$('label[for="channel_name"]').removeClass("validation_warning");$(this).removeClass("validation_warning");if(_name_check_timer){clearTimeout(_name_check_timer);_name_check_timer=null}_name_check_timer=setTimeout(function(){_toggleChannelNameChecking();_toggleOptionGoButton(true);var validation=TS.ui.validation.validate($(this));if(validation){var $el=$(this);var new_name=$el.val().trim();TS.api.callImmediately("enterprise.nameTaken",{name:new_name,ignore_local_team:true},function(ok,data,args){if(!ok){_toggleChannelNameChecking(true,false);_bad_channel_name=true;TS.generic_dialog.alert("Something failed! "+data.error)}else{if(data.name_taken){_toggleChannelNameChecking(true,false);_bad_channel_name=true;_toggleOptionGoButton(true);return void TS.ui.validation.showWarning($el,'"'+TS.utility.htmlEntities(new_name)+'"'+" is already taken by a channel, username, or user group.",{})}_toggleChannelNameChecking(true,true);_toggleOptionGoButton();_bad_channel_name=false}})}else{_toggleChannelNameChecking(true);_bad_channel_name=true}}.bind(this),_name_check_wait_time)})};var _toggleChannelNameChecking=function(disable,trigger_available){if(!disable)disable=false;if(!trigger_available)trigger_available=false;_$current_option.find(".input_wrapper .spinner").toggleClass("hidden",disable);if(trigger_available)_toggleChannelNameAvailable(!disable)};var _name_available_timer;var _name_available_show_time=1e3;var _toggleChannelNameAvailable=function(disable){if(_name_available_timer){clearTimeout(_name_available_timer);_name_available_timer=null}if(!disable)disable=false;_$current_option.find(".input_wrapper .available").toggleClass("hidden",disable);if(!disable){_name_available_timer=setTimeout(function(){_$current_option.find(".input_wrapper .available").addClass("hidden")},_name_available_show_time)}};var _showRenameChannel=function(model_ob){if(TS.model.user.is_restricted)return;_setHeaderHtml("Rename this channel");var title=TS.utility.cleanChannelName(model_ob.name||"").substr(0,TS.model.channel_name_max_length);_setOptionContentHtml(TS.templates.channel_option_rename_channel({title:title}));var go_text="Rename Channel";if(model_ob.is_group)go_text="Rename private channel";_setOptionGoText(go_text);_current_option_go_callback=function(){var validated=TS.channels.ui.channelCreateDialogValidateInput(_$current_option);if(!validated)return;if(TS.ui.channel_options_dialog.ladda)TS.ui.channel_options_dialog.ladda.start();var new_title=_$current_option.find(".title_input").val();var method=model_ob.is_channel?"channels.rename":"groups.rename";TS.api.callImmediately(method,{name:new_title,channel:model_ob.id},function(ok,data,args){if(TS.ui.channel_options_dialog.ladda)TS.ui.channel_options_dialog.ladda.stop();if(!ok){if(data.error==="name_taken"){TS.channels.ui.channelCreateDialogShowNameTakenAlert(TS.ui.channel_options_dialog.div)}else{TS.generic_dialog.alert("failed! "+data.error)}return}TS.ui.fs_modal.close()})};_showOptionSection(true)};var _showPurposeChannel=function(model_ob){_setHeaderHtml("Set channel purpose");_setOptionContentHtml(TS.templates.channel_option_purpose({model_ob:model_ob,is_group:model_ob.is_group}));_setOptionGoText("Update purpose");_current_option_go_callback=function(){var new_purpose=_$current_option.find("#purpose_input").val().trim();if(model_ob.is_group){TS.groups.setPurpose(model_ob.id,new_purpose)}else{TS.channels.setPurpose(model_ob.id,new_purpose)}TS.ui.fs_modal.close()};_showOptionSection(true)};var _members_lfs_identifier="1.";var _groups_lfs_identifier="0.";var _who_can_post_is_shared_channels_member_searcher={};var _who_can_post_user_group_searcher={count:100,include_dangling:1,items:[]};var _is_posting_privilege_lfs_started=false;var _channel_prefs;var _manage_posting_selected={user:[],subteam:[]};var _formatDataForWhoCanPostTemplate=function(data){var settings=_.merge({},data);if(!settings.type)settings.type=["ra"];if(settings.type&&settings.type[0]==="owner"){if(settings.user&&settings.user.length||settings.subteam&&settings.subteam.length){settings.type[0]="multi"}}return settings};var _promiseToGetListData=function(query,page_number){if(query.charAt(0)==="@")query=query.substring(1);var promises=[_promiseToGetMembers(query,page_number),_promiseToGetUserGroups(query,page_number)];return Promise.all(promises).then(function(responses){var response={_replace_all_items:true,items:[]};var members=responses[0];var groups=responses[1];if(groups._items.length){response.items.push({label:"User Groups",children:groups._items})}if(members.items.length){response.items.push({label:"Members",children:members.items})}return response})};var _promiseToGetMembers=function(query,page_number){if(_who_can_post_is_shared_channels_member_searcher.query!==query){_who_can_post_is_shared_channels_member_searcher=_.merge(_who_can_post_is_shared_channels_member_searcher,{query:query,include_org:TS.boot_data.page_needs_enterprise,include_slackbot:false,include_self:true,full_profile_filter:true,include_bots:false,all_of_org:true,org_team_ids:[]})}return Promise.resolve(_who_can_post_is_shared_channels_member_searcher).then(function(searcher){var users=_manage_posting_selected.user||[];return TS.members.ensureMembersArePresent(users).then(function(){return TS.members.promiseToSearchMembers(searcher).then(function(response){var items=[];if(response.query===""){items=TS.members.getMembersForUser()}else{items=response.items}response.items=items.map(function(item){if(item.member&&typeof item.preselected!=="undefined")return item;return{member:item,lfs_id:_members_lfs_identifier+item.id,preselected:users&&users.indexOf(item.id)>-1}});return response})})})};var _promiseToGetUserGroups=function(query,page_number){if(_who_can_post_user_group_searcher._query!==query){_who_can_post_user_group_searcher._query=query;_who_can_post_user_group_searcher.include_enterprise=true}var full_query=[{type:"is",value:"group"}];var query_terms=query.split(" ");
query_terms.forEach(function(term){if(term==="")return;full_query.push({type:"fuzzy",value:term})});_who_can_post_user_group_searcher.query=JSON.stringify({type:"and",clauses:full_query});var user_groups=_manage_posting_selected.subteam||[];return TS.user_groups.ensureUserGroupsArePresent(user_groups).then(function(){return TS.api.callImmediately("search.enterprise",_who_can_post_user_group_searcher).then(function(response){_who_can_post_user_group_searcher.num_new=response.data.items.length||0;if(!response.data.items.length)return Promise.resolve({_items:[]});var items=[];if(_who_can_post_user_group_searcher._query===""){items=TS.user_groups.getActiveUserGroups(true)||[]}items=_(items).concat(response.data.items).uniqBy(function(group){return group.id}).map(function(item){if(item.user_group&&typeof item.preselected!=="undefined")return item;return{user_group:item,lfs_id:_groups_lfs_identifier+item.id,preselected:user_groups&&user_groups.indexOf(item.id)>-1}}).value();_who_can_post_user_group_searcher._items=items;TS.user_groups.startBatchUpsert();response.data.items.forEach(function(ug){TS.user_groups.upsertUserGroup(ug)});TS.user_groups.finishBatchUpsert();return _who_can_post_user_group_searcher})})};var _posting_privilege_lfs_options={placeholder_text:"Search",approx_item_height:38,data_promise:_promiseToGetListData,template:function(item){var html="";if(item.member){html=TS.templates.enterprise_member_profile_name({member:item.member})}else if(item.user_group){html=TS.templates.enterprise_member_profile_name({user_group:item.user_group})}return new Handlebars.SafeString(html)},tokenTemplate:function(item){var html="";if(item.member){html=TS.templates.enterprise_member_token_sc({member:item.member})}else if(item.user_group){html=TS.templates.enterprise_member_profile_name({user_group:item.user_group})}return new Handlebars.SafeString(html)},tokenClass:function(item){if(item.member){return"lfs_token lfs_token_members"}else if(item.user_group){return"lfs_token lfs_token_user_groups"}return"lfs_token"},noResultsTemplate:function(query){if(!query)return"No match found";return"No match found for <strong>"+TS.utility.htmlEntities(query)+"</strong>"},onItemAdded:function(item){if(item.member){_manage_posting_selected.user.push(item.member.id);_manage_posting_selected.user=_.uniq(_manage_posting_selected.user)}else if(item.user_group){_manage_posting_selected.subteam.push(item.user_group.id);_manage_posting_selected.subteam=_.uniq(_manage_posting_selected.subteam)}},onItemRemoved:function(item){if(item.member){_manage_posting_selected.user=_manage_posting_selected.user.filter(function(id){return id!==item.member.id})}else if(item.user_group){_manage_posting_selected.subteam=_manage_posting_selected.subteam.filter(function(id){return id!==item.user_group.id})}}};var _maybeStartPostingPrivilegeLFS=function(){var val=_$current_option.find(".post_opt_radios:checked").val();if(!_is_posting_privilege_lfs_started&&val==="multi"){_$current_option.find("#lfs_channel_posting").hide().lazyFilterSelect(_posting_privilege_lfs_options);_is_posting_privilege_lfs_started=true}};var _showPostingPrivileges=function(model_ob){_channel_prefs=null;_manage_posting_selected={subteam:[],user:[]};_is_posting_privilege_lfs_started=false;_setHeaderHtml("Manage posting privileges for "+_createChannelNameMarkup(model_ob));_setOptionContentHtml(TS.templates.channel_options_posting_privileges());_hideOptionButtons();_setOptionGoText("Save Changes");_current_option_go_callback=function(){var formatted_value;var val=_$current_option.find(".post_opt_radios:checked").val();var lfs_values=[];if(val==="multi"){val="owner";lfs_values=_$current_option.find("#lfs_channel_posting").lazyFilterSelect("value")}formatted_value="type:"+val;lfs_values.forEach(function(value){if(value.member){formatted_value+=",user:"+value.member.id}else if(value.user_group){formatted_value+=",subteam:"+value.user_group.id}});var calling_args={prefs:JSON.stringify({who_can_post:formatted_value}),channel_id:model_ob.id};if(TS.ui.channel_options_dialog.ladda)TS.ui.channel_options_dialog.ladda.start();TS.api.callImmediately("channels.prefs.set",calling_args,function(ok,data,args){if(TS.ui.channel_options_dialog.ladda)TS.ui.channel_options_dialog.ladda.stop();if(!ok){TS.generic_dialog.alert("failed! "+data.error);return}TS.ui.fs_modal.close()})};_showOptionSection(true);var channel_request_params={pref_name:"who_can_post",channel_id:model_ob.id};TS.api.callImmediately("channels.prefs.get",channel_request_params).then(function(response){_channel_prefs=response.data.pref_value;if(_channel_prefs.user)_manage_posting_selected.user=_channel_prefs.user;if(_channel_prefs.subteam)_manage_posting_selected.subteam=_channel_prefs.subteam;var template_args={who_can_post:_formatDataForWhoCanPostTemplate(_channel_prefs),hide_loading_overlay:true};_setOptionContentHtml(TS.templates.channel_options_posting_privileges(template_args));_bindManagePostingPrivilegeUI();_maybeStartPostingPrivilegeLFS();_showOptionButtons()})};var _bindManagePostingPrivilegeUI=function(){_$current_option.find(".post_opt_radios").on("change",function(){var val=$(this).val();_$current_option.find(".lfs_channel_posting_selector").toggleClass("hidden",val!=="multi");if(val==="multi")_maybeStartPostingPrivilegeLFS()})};var _showDataRetention=function(model_ob){_setHeaderHtml("Edit retention policy for "+_createChannelNameMarkup(model_ob));var html=_retentionLoadingHtml();_setOptionContentHtml(html);_setOptionGoText("Save settings");_hideOptionButtons();_current_option_go_callback=function(){var type=_$current_option.find('select[name="retention_type"]').val();var duration=_$current_option.find("#retention_duration").val();if(type===null||duration===null)return;if(TS.ui.channel_options_dialog.ladda)TS.ui.channel_options_dialog.ladda.start();function retentionAPIHandler(ok,data,args){if(TS.ui.channel_options_dialog.ladda)TS.ui.channel_options_dialog.ladda.stop();if(!ok){TS.error("failed onDataRetentionChanged");if(data.error==="invalid_duration"){_$current_option.find(".invalid_duration_error").removeClass("hidden")}else{TS.generic_dialog.alert('<p class="no_bottom_margin">Oops! Something went wrong. Please try again.</p>')}return}var ephemeral_message="";if(model_ob.is_im){ephemeral_message="Message retention settings updated for your direct messages with @"+model_ob.user.username+"."}else if(model_ob.is_mpim){ephemeral_message="Message retention settings updated for your direct messages with "+model_ob._display_name+"."}else{ephemeral_message="Message retention settings updated for #"+model_ob.name+"."}TS.ui.channel_options_dialog.addTempEphemeralFeedback(ephemeral_message);TS.ui.fs_modal.close();return}if(model_ob.is_channel){TS.channels.setDataRetention(model_ob.id,type,duration,retentionAPIHandler)}else if(model_ob.is_group){TS.groups.setDataRetention(model_ob.id,type,duration,retentionAPIHandler)}else if(model_ob.im){TS.ims.setDataRetention(model_ob.id,type,duration,retentionAPIHandler)}else{TS.mpims.setDataRetention(model_ob.id,type,duration,retentionAPIHandler)}};_showOptionSection();if(model_ob.is_channel){TS.channels.getDataRetention(model_ob.id,_onChannelsGetRetention)}else if(model_ob.is_im){TS.ims.getDataRetention(model_ob.id,_onImGetRetention)}else if(model_ob.is_mpim){TS.mpims.getDataRetention(model_ob.id,_onImGetRetention)}else{TS.groups.getDataRetention(model_ob.id,_onGroupsGetRetention)}};var _retentionLoadingHtml=function(){var url=cdn_url+"/f85a/img/loading_hash_animation_@2x.gif";return'<div class="loading_hash_animation large_margin"><img src="'+url+'" alt="Loading" /><br />loading...</div>'};var _onChannelsGetRetention=function(ok,data,args){if(ok){_replaceRetentionLoading("channel",data.retention.retention_type,data.retention.retention_duration)}else{_replaceRetentionLoadingError("channel",data)}};var _onGroupsGetRetention=function(ok,data,args){if(ok){_replaceRetentionLoading("group",data.retention.retention_type,data.retention.retention_duration)}else{_replaceRetentionLoadingError("group",data)}};var _onImGetRetention=function(ok,data,args){if(ok){_replaceRetentionLoading("conversation",data.retention.retention_type,data.retention.retention_duration)}else{_replaceRetentionLoadingError("conversation",data)}};var _replaceRetentionLoading=function(model_type,retention_type,retention_duration){var team_type=TS.model.team.prefs.retention_type;var team_duration=TS.model.team.prefs.retention_duration;if(model_type==="group"){team_type=TS.model.team.prefs.group_retention_type;team_duration=TS.model.team.prefs.group_retention_duration;model_type="channel"}else if(model_type==="conversation"){team_type=TS.model.team.prefs.dm_retention_type;team_duration=TS.model.team.prefs.dm_retention_duration}var html=TS.templates.channel_data_retention_dialog({model_type:model_type,retention_type:retention_type,retention_duration:retention_duration,team_type:team_type,team_duration:team_duration});_setOptionContentHtml(html);_$current_option.find('select[name="retention_type"]').change(function(){_$current_option.find(".invalid_duration_error").addClass("hidden");if(parseInt(this.value,10)!==1){_$current_option.find("#team_retention_pref").removeClass("hidden");_$current_option.find("#retention_duration_container, #retention_duration_warning").addClass("hidden")}else{_$current_option.find("#team_retention_pref").addClass("hidden");_$current_option.find("#retention_duration_container, #retention_duration_warning").removeClass("hidden");var $retention_duration=_$current_option.find("#retention_duration");if($retention_duration.val()===0){$retention_duration.val("")}$retention_duration.focus()}}).change();_$current_option.find("#retention_duration").change(function(){_$current_option.find(".invalid_duration_error").addClass("hidden")}).change();_showOptionButtons();_maybeCreateLadda()};var _replaceRetentionLoadingError=function(model_type,data){var html;if(data.error==="no_perms"||data.error==="is_archived"||data.error==="not_paid"){if(model_type==="group"){model_type="channel"}html='<p class="no_bottom_margin">Sorry! You can\'t change the retention duration for this '+model_type+".</p>"}else{html='<p class="no_bottom_margin">Oops! Something went wrong. Please try again.</p>'}_setOptionContentHtml(html)}})();(function(){"use strict";TS.registerModule("ui.channel_manage_teams_dialog",{div:null,c_id:null,ladda:null,start:function(c_id){TS.ui.channel_manage_teams_dialog.c_id=c_id;_start()},addTempEphemeralFeedback:function(text){TS.client.ui.addOrFlashEphemeralBotMsg({text:text})}});var _start=function(){var model_ob=TS.shared.getModelObById(TS.ui.channel_manage_teams_dialog.c_id);if(!model_ob||model_ob.is_im){TS.log(1337,"No model_ob found for channel id :"+TS.ui.channel_manage_teams_dialog.c_id);TS.generic_dialog.alert('<p class="no_bottom_margin">Oops! No channel found???</p>');return}var c_or_g=model_ob.is_channel?"channel":"group";var template_args={c_or_g:c_or_g,model_ob:model_ob};var settings={body_template_html:TS.templates.channel_manage_teams_dialog(template_args),onShow:_onShow,onCancel:_onCancel,modal_class:"channel_manage_teams_modal"};TS.ui.fs_modal.start(settings)};var _onShow=function(){TS.ui.channel_manage_teams_dialog.div=$(".channel_manage_teams_modal");var model_ob=TS.shared.getModelObById(TS.ui.channel_manage_teams_dialog.c_id);TS.ui.channel_manage_teams_dialog.div.find(".dialog_cancel").on("click",_dialogCancel);TS.ui.channel_manage_teams_dialog.div.find(".dialog_go").on("click",_dialogGo);TS.ui.channel_manage_teams_dialog.div.on("change",'[type="radio"][name="share_with"]',function(e){var $el=$(this);var checked=$el.val();var show_specific=checked==="specific";TS.ui.channel_manage_teams_dialog.div.find(".specific_team").toggleClass("hidden",!show_specific);var dialog_go_disabled=false;if(show_specific)dialog_go_disabled=!(TS.ui.channel_manage_teams_dialog.div.find('[name="domains"]').val().trim().length>0);_toggleDialogGoButton(dialog_go_disabled)});TS.ui.channel_manage_teams_dialog.div.find('[name="domains"]').each(function(index,el){var $el=$(el);var all_teams=_.filter(TS.model.enterprise_teams,function(team){return team.id!==TS.model.team.id});var preselected_ids=_.map(model_ob.shares,function(team){return team.id}).filter(function(id){return id!==TS.model.team.id});TS.ui.team_picker.make($el,{teams:all_teams,preselected_ids:preselected_ids,classes:"normal_style team_picker",restrict_preselected_item_removal:true});$el.on("change",function(){var value=TS.ui.team_picker.value($el).map(function(item){return item.team.domain}).join(",");$el.val(value)})});TS.ui.channel_manage_teams_dialog.div.on("change",'[name="domains"]',function(e){var $el=$(this);var trimmed_val=$el.val().trim();_toggleDialogGoButton(!(trimmed_val.length>0))})};var _onCancel=function(){};var _dialogCancel=function(){TS.ui.fs_modal.close()};var _dialogGo=function(){var model_ob=TS.shared.getModelObById(TS.ui.channel_manage_teams_dialog.c_id);var something_changed=true;var calling_args={channel_id:model_ob.id};var radio_selected_val=TS.ui.channel_manage_teams_dialog.div.find('[type="radio"][name="share_with"]:checked').val();var is_specific_teams=radio_selected_val==="specific";if(is_specific_teams){var team_ids=TS.ui.team_picker.value(TS.ui.channel_manage_teams_dialog.div.find('[name="domains"]'));team_ids=team_ids.filter(function(item){return item.preselected===false}).map(function(item){return item.team.id});if(team_ids.length===0)something_changed=false;calling_args.team_ids=team_ids.join(",")}else{calling_args.all_teams=true}if(something_changed){TS.api.callImmediately("enterprise.channels.addToShared",calling_args).then(function(ok,data,args){TS.ui.fs_modal.close()})}else{TS.ui.fs_modal.close()}return false};var _toggleDialogGoButton=function(disable){if(!disable)disable=false;TS.ui.channel_manage_teams_dialog.div.find(".dialog_go").toggleClass("disabled",disable)}})();(function($){var colpick=function(){var tpl='<div class="colpick"><div class="colpick_color"><div class="colpick_color_overlay1"><div class="colpick_color_overlay2"><div class="colpick_selector_outer"><div class="colpick_selector_inner"></div></div></div></div></div><div class="colpick_hue"><div class="colpick_hue_arrs"><div class="colpick_hue_larr"></div><div class="colpick_hue_rarr"></div></div></div><div class="colpick_new_color"></div><div class="colpick_current_color"></div><div class="colpick_hex_field"><div class="colpick_field_letter">#</div><input type="text" maxlength="6" size="6" /></div><div class="colpick_rgb_r colpick_field"><div class="colpick_field_letter">R</div><input type="text" maxlength="3" size="3" /><div class="colpick_field_arrs"><div class="colpick_field_uarr"></div><div class="colpick_field_darr"></div></div></div><div class="colpick_rgb_g colpick_field"><div class="colpick_field_letter">G</div><input type="text" maxlength="3" size="3" /><div class="colpick_field_arrs"><div class="colpick_field_uarr"></div><div class="colpick_field_darr"></div></div></div><div class="colpick_rgb_b colpick_field"><div class="colpick_field_letter">B</div><input type="text" maxlength="3" size="3" /><div class="colpick_field_arrs"><div class="colpick_field_uarr"></div><div class="colpick_field_darr"></div></div></div><div class="colpick_hsb_h colpick_field"><div class="colpick_field_letter">H</div><input type="text" maxlength="3" size="3" /><div class="colpick_field_arrs"><div class="colpick_field_uarr"></div><div class="colpick_field_darr"></div></div></div><div class="colpick_hsb_s colpick_field"><div class="colpick_field_letter">S</div><input type="text" maxlength="3" size="3" /><div class="colpick_field_arrs"><div class="colpick_field_uarr"></div><div class="colpick_field_darr"></div></div></div><div class="colpick_hsb_b colpick_field"><div class="colpick_field_letter">B</div><input type="text" maxlength="3" size="3" /><div class="colpick_field_arrs"><div class="colpick_field_uarr"></div><div class="colpick_field_darr"></div></div></div><div class="colpick_submit"></div></div>',defaults={showEvent:"click",onShow:function(){},onBeforeShow:function(){},onHide:function(){},onChange:function(){},onSubmit:function(){},colorScheme:"light",color:"3289c7",livePreview:true,flat:false,layout:"full",submit:1,submitText:"OK",height:156},fillRGBFields=function(hsb,cal){var rgb=hsbToRgb(hsb);$(cal).data("colpick").fields.eq(1).val(rgb.r).end().eq(2).val(rgb.g).end().eq(3).val(rgb.b).end()},fillHSBFields=function(hsb,cal){$(cal).data("colpick").fields.eq(4).val(Math.round(hsb.h)).end().eq(5).val(Math.round(hsb.s)).end().eq(6).val(Math.round(hsb.b)).end()},fillHexFields=function(hsb,cal){$(cal).data("colpick").fields.eq(0).val(hsbToHex(hsb))},setSelector=function(hsb,cal){$(cal).data("colpick").selector.css("backgroundColor","#"+hsbToHex({h:hsb.h,s:100,b:100}));$(cal).data("colpick").selectorIndic.css({left:parseInt($(cal).data("colpick").height*hsb.s/100,10),top:parseInt($(cal).data("colpick").height*(100-hsb.b)/100,10)})},setHue=function(hsb,cal){$(cal).data("colpick").hue.css("top",parseInt($(cal).data("colpick").height-$(cal).data("colpick").height*hsb.h/360,10))},setCurrentColor=function(hsb,cal){$(cal).data("colpick").currentColor.css("backgroundColor","#"+hsbToHex(hsb))},setNewColor=function(hsb,cal){$(cal).data("colpick").newColor.css("backgroundColor","#"+hsbToHex(hsb))},change=function(ev){var cal=$(this).parent().parent(),col;if(this.parentNode.className.indexOf("_hex")>0){cal.data("colpick").color=col=hexToHsb(fixHex(this.value));fillRGBFields(col,cal.get(0));fillHSBFields(col,cal.get(0))}else if(this.parentNode.className.indexOf("_hsb")>0){cal.data("colpick").color=col=fixHSB({h:parseInt(cal.data("colpick").fields.eq(4).val(),10),s:parseInt(cal.data("colpick").fields.eq(5).val(),10),b:parseInt(cal.data("colpick").fields.eq(6).val(),10)});fillRGBFields(col,cal.get(0));fillHexFields(col,cal.get(0))}else{cal.data("colpick").color=col=rgbToHsb(fixRGB({r:parseInt(cal.data("colpick").fields.eq(1).val(),10),g:parseInt(cal.data("colpick").fields.eq(2).val(),10),b:parseInt(cal.data("colpick").fields.eq(3).val(),10)}));fillHexFields(col,cal.get(0));fillHSBFields(col,cal.get(0))}setSelector(col,cal.get(0));setHue(col,cal.get(0));setNewColor(col,cal.get(0));cal.data("colpick").onChange.apply(cal.parent(),[col,hsbToHex(col),hsbToRgb(col),cal.data("colpick").el,0])},blur=function(ev){$(this).parent().removeClass("colpick_focus")},focus=function(){$(this).parent().parent().data("colpick").fields.parent().removeClass("colpick_focus");$(this).parent().addClass("colpick_focus")},downIncrement=function(ev){ev.preventDefault?ev.preventDefault():ev.returnValue=false;var field=$(this).parent().find("input").focus();var current={el:$(this).parent().addClass("colpick_slider"),max:this.parentNode.className.indexOf("_hsb_h")>0?360:this.parentNode.className.indexOf("_hsb")>0?100:255,y:ev.pageY,field:field,val:parseInt(field.val(),10),preview:$(this).parent().parent().data("colpick").livePreview};$(document).mouseup(current,upIncrement);$(document).mousemove(current,moveIncrement)},moveIncrement=function(ev){ev.data.field.val(Math.max(0,Math.min(ev.data.max,parseInt(ev.data.val-ev.pageY+ev.data.y,10))));if(ev.data.preview){change.apply(ev.data.field.get(0),[true])}return false},upIncrement=function(ev){change.apply(ev.data.field.get(0),[true]);ev.data.el.removeClass("colpick_slider").find("input").focus();$(document).off("mouseup",upIncrement);$(document).off("mousemove",moveIncrement);return false},downHue=function(ev){ev.preventDefault?ev.preventDefault():ev.returnValue=false;var current={cal:$(this).parent(),y:$(this).offset().top};$(document).on("mouseup touchend",current,upHue);$(document).on("mousemove touchmove",current,moveHue);var pageY=ev.type=="touchstart"?ev.originalEvent.changedTouches[0].pageY:ev.pageY;change.apply(current.cal.data("colpick").fields.eq(4).val(parseInt(360*(current.cal.data("colpick").height-(pageY-current.y))/current.cal.data("colpick").height,10)).get(0),[current.cal.data("colpick").livePreview]);return false},moveHue=function(ev){var pageY=ev.type=="touchmove"?ev.originalEvent.changedTouches[0].pageY:ev.pageY;change.apply(ev.data.cal.data("colpick").fields.eq(4).val(parseInt(360*(ev.data.cal.data("colpick").height-Math.max(0,Math.min(ev.data.cal.data("colpick").height,pageY-ev.data.y)))/ev.data.cal.data("colpick").height,10)).get(0),[ev.data.preview]);return false},upHue=function(ev){fillRGBFields(ev.data.cal.data("colpick").color,ev.data.cal.get(0));fillHexFields(ev.data.cal.data("colpick").color,ev.data.cal.get(0));$(document).off("mouseup touchend",upHue);$(document).off("mousemove touchmove",moveHue);return false},downSelector=function(ev){ev.preventDefault?ev.preventDefault():ev.returnValue=false;var current={cal:$(this).parent(),pos:$(this).offset()};current.preview=current.cal.data("colpick").livePreview;$(document).on("mouseup touchend",current,upSelector);$(document).on("mousemove touchmove",current,moveSelector);var payeX,pageY;if(ev.type=="touchstart"){pageX=ev.originalEvent.changedTouches[0].pageX,pageY=ev.originalEvent.changedTouches[0].pageY}else{pageX=ev.pageX;pageY=ev.pageY}change.apply(current.cal.data("colpick").fields.eq(6).val(parseInt(100*(current.cal.data("colpick").height-(pageY-current.pos.top))/current.cal.data("colpick").height,10)).end().eq(5).val(parseInt(100*(pageX-current.pos.left)/current.cal.data("colpick").height,10)).get(0),[current.preview]);return false},moveSelector=function(ev){var payeX,pageY;if(ev.type=="touchmove"){pageX=ev.originalEvent.changedTouches[0].pageX,pageY=ev.originalEvent.changedTouches[0].pageY}else{pageX=ev.pageX;pageY=ev.pageY}change.apply(ev.data.cal.data("colpick").fields.eq(6).val(parseInt(100*(ev.data.cal.data("colpick").height-Math.max(0,Math.min(ev.data.cal.data("colpick").height,pageY-ev.data.pos.top)))/ev.data.cal.data("colpick").height,10)).end().eq(5).val(parseInt(100*Math.max(0,Math.min(ev.data.cal.data("colpick").height,pageX-ev.data.pos.left))/ev.data.cal.data("colpick").height,10)).get(0),[ev.data.preview]);return false},upSelector=function(ev){fillRGBFields(ev.data.cal.data("colpick").color,ev.data.cal.get(0));fillHexFields(ev.data.cal.data("colpick").color,ev.data.cal.get(0));$(document).off("mouseup touchend",upSelector);$(document).off("mousemove touchmove",moveSelector);return false},clickSubmit=function(ev){var cal=$(this).parent();var col=cal.data("colpick").color;cal.data("colpick").origColor=col;setCurrentColor(col,cal.get(0));cal.data("colpick").onSubmit(col,hsbToHex(col),hsbToRgb(col),cal.data("colpick").el)},show=function(ev){if(ev){ev.stopPropagation()}var cal=$("#"+$(this).data("colpickId"));cal.data("colpick").onBeforeShow.apply(this,[cal.get(0)]);var pos=$(this).offset();var top=pos.top+this.offsetHeight;var left=pos.left;var viewPort=getViewport();var calW=cal.width();if(left+calW>viewPort.l+viewPort.w){left-=calW}cal.css({left:left+"px",top:top+"px"});if(cal.data("colpick").onShow.apply(this,[cal.get(0)])!=false){cal.show()}$("html").mousedown({cal:cal},hide);cal.mousedown(function(ev){ev.stopPropagation()})},hide=function(ev){if(ev.data.cal.data("colpick").onHide.apply(this,[ev.data.cal.get(0)])!=false){ev.data.cal.hide()}$("html").off("mousedown",hide)},getViewport=function(){var m=document.compatMode=="CSS1Compat";return{l:window.pageXOffset||(m?document.documentElement.scrollLeft:document.body.scrollLeft),w:window.innerWidth||(m?document.documentElement.clientWidth:document.body.clientWidth)}},fixHSB=function(hsb){return{h:Math.min(360,Math.max(0,hsb.h)),s:Math.min(100,Math.max(0,hsb.s)),b:Math.min(100,Math.max(0,hsb.b))}},fixRGB=function(rgb){return{r:Math.min(255,Math.max(0,rgb.r)),g:Math.min(255,Math.max(0,rgb.g)),b:Math.min(255,Math.max(0,rgb.b))}},fixHex=function(hex){var len=6-hex.length;if(len>0){var o=[];for(var i=0;i<len;i++){o.push("0")}o.push(hex);hex=o.join("")}return hex},restoreOriginal=function(){var cal=$(this).parent();var col=cal.data("colpick").origColor;cal.data("colpick").color=col;fillRGBFields(col,cal.get(0));fillHexFields(col,cal.get(0));fillHSBFields(col,cal.get(0));setSelector(col,cal.get(0));setHue(col,cal.get(0));setNewColor(col,cal.get(0))};return{init:function(opt){opt=$.extend({},defaults,opt||{});if(typeof opt.color=="string"){opt.color=hexToHsb(opt.color)}else if(opt.color.r!=undefined&&opt.color.g!=undefined&&opt.color.b!=undefined){opt.color=rgbToHsb(opt.color)}else if(opt.color.h!=undefined&&opt.color.s!=undefined&&opt.color.b!=undefined){opt.color=fixHSB(opt.color)}else{return this}return this.each(function(){if(!$(this).data("colpickId")){var options=$.extend({},opt);options.origColor=opt.color;var id="collorpicker_"+parseInt(Math.random()*1e3);$(this).data("colpickId",id);var cal=$(tpl).attr("id",id);cal.addClass("colpick_"+options.layout+(options.submit?"":" colpick_"+options.layout+"_ns"));if(options.colorScheme!="light"){cal.addClass("colpick_"+options.colorScheme)}cal.find("div.colpick_submit").html(options.submitText).click(clickSubmit);options.fields=cal.find("input").change(change).blur(blur).focus(focus);cal.find("div.colpick_field_arrs").mousedown(downIncrement).end().find("div.colpick_current_color").click(restoreOriginal);options.selector=cal.find("div.colpick_color").on("mousedown touchstart",downSelector);options.selectorIndic=options.selector.find("div.colpick_selector_outer");options.el=this;options.hue=cal.find("div.colpick_hue_arrs");huebar=options.hue.parent();var UA=navigator.userAgent.toLowerCase();var isIE=navigator.appName==="Microsoft Internet Explorer";var IEver=isIE?parseFloat(UA.match(/msie ([0-9]{1,}[\.0-9]{0,})/)[1]):0;var ngIE=isIE&&IEver<10;var stops=["#ff0000","#ff0080","#ff00ff","#8000ff","#0000ff","#0080ff","#00ffff","#00ff80","#00ff00","#80ff00","#ffff00","#ff8000","#ff0000"];if(ngIE){var i,div;for(i=0;i<=11;i++){div=$("<div></div>").attr("style","height:8.333333%; filter:progid:DXImageTransform.Microsoft.gradient(GradientType=0,startColorstr="+stops[i]+", endColorstr="+stops[i+1]+'); -ms-filter: "progid:DXImageTransform.Microsoft.gradient(GradientType=0,startColorstr='+stops[i]+", endColorstr="+stops[i+1]+')";');huebar.append(div)}}else{stopList=stops.join(",");huebar.attr("style","background:-webkit-linear-gradient(top,"+stopList+"); background: -o-linear-gradient(top,"+stopList+"); background: -ms-linear-gradient(top,"+stopList+"); background:-moz-linear-gradient(top,"+stopList+"); -webkit-linear-gradient(top,"+stopList+"); background:linear-gradient(to bottom,"+stopList+"); ")}cal.find("div.colpick_hue").on("mousedown touchstart",downHue);options.newColor=cal.find("div.colpick_new_color");options.currentColor=cal.find("div.colpick_current_color");cal.data("colpick",options);fillRGBFields(options.color,cal.get(0));fillHSBFields(options.color,cal.get(0));fillHexFields(options.color,cal.get(0));setHue(options.color,cal.get(0));setSelector(options.color,cal.get(0));setCurrentColor(options.color,cal.get(0));setNewColor(options.color,cal.get(0));if(options.flat){cal.appendTo(this).show();cal.css({position:"relative",display:"block"})}else{cal.appendTo(document.body);$(this).on(options.showEvent,show);cal.css({position:"absolute"})}}})},showPicker:function(){return this.each(function(){if($(this).data("colpickId")){show.apply(this)}})},hidePicker:function(){return this.each(function(){if($(this).data("colpickId")){$("#"+$(this).data("colpickId")).hide()}})},setColor:function(col,setCurrent){setCurrent=typeof setCurrent==="undefined"?1:setCurrent;if(typeof col=="string"){col=hexToHsb(col)}else if(col.r!=undefined&&col.g!=undefined&&col.b!=undefined){col=rgbToHsb(col)}else if(col.h!=undefined&&col.s!=undefined&&col.b!=undefined){col=fixHSB(col)}else{return this}return this.each(function(){if($(this).data("colpickId")){var cal=$("#"+$(this).data("colpickId"));cal.data("colpick").color=col;cal.data("colpick").origColor=col;fillRGBFields(col,cal.get(0));fillHSBFields(col,cal.get(0));fillHexFields(col,cal.get(0));setHue(col,cal.get(0));setSelector(col,cal.get(0));setNewColor(col,cal.get(0));cal.data("colpick").onChange.apply(cal.parent(),[col,hsbToHex(col),hsbToRgb(col),cal.data("colpick").el,1]);if(setCurrent){setCurrentColor(col,cal.get(0))}}})}}}();var hexToRgb=function(hex){var hex=parseInt(hex.indexOf("#")>-1?hex.substring(1):hex,16);return{r:hex>>16,g:(hex&65280)>>8,b:hex&255}};var hexToHsb=function(hex){return rgbToHsb(hexToRgb(hex))};var rgbToHsb=function(rgb){var hsb={h:0,s:0,b:0};var min=Math.min(rgb.r,rgb.g,rgb.b);var max=Math.max(rgb.r,rgb.g,rgb.b);var delta=max-min;hsb.b=max;hsb.s=max!=0?255*delta/max:0;if(hsb.s!=0){if(rgb.r==max)hsb.h=(rgb.g-rgb.b)/delta;else if(rgb.g==max)hsb.h=2+(rgb.b-rgb.r)/delta;else hsb.h=4+(rgb.r-rgb.g)/delta}else hsb.h=-1;hsb.h*=60;if(hsb.h<0)hsb.h+=360;hsb.s*=100/255;hsb.b*=100/255;return hsb};var hsbToRgb=function(hsb){var rgb={};var h=hsb.h;var s=hsb.s*255/100;var v=hsb.b*255/100;if(s==0){rgb.r=rgb.g=rgb.b=v}else{var t1=v;var t2=(255-s)*v/255;var t3=(t1-t2)*(h%60)/60;if(h==360)h=0;if(h<60){rgb.r=t1;rgb.b=t2;rgb.g=t2+t3}else if(h<120){rgb.g=t1;rgb.b=t2;rgb.r=t1-t3}else if(h<180){rgb.g=t1;rgb.r=t2;rgb.b=t2+t3}else if(h<240){rgb.b=t1;rgb.r=t2;rgb.g=t1-t3}else if(h<300){rgb.b=t1;rgb.g=t2;rgb.r=t2+t3}else if(h<360){rgb.r=t1;rgb.g=t2;rgb.b=t1-t3}else{rgb.r=0;rgb.g=0;rgb.b=0}}return{r:Math.round(rgb.r),g:Math.round(rgb.g),b:Math.round(rgb.b)}};var rgbToHex=function(rgb){var hex=[rgb.r.toString(16),rgb.g.toString(16),rgb.b.toString(16)];$.each(hex,function(nr,val){if(val.length==1){hex[nr]="0"+val}});return hex.join("")};var hsbToHex=function(hsb){return rgbToHex(hsbToRgb(hsb))};$.fn.extend({colpick:colpick.init,colpickHide:colpick.hidePicker,colpickShow:colpick.showPicker,colpickSetColor:colpick.setColor});$.extend({colpick:{rgbToHex:rgbToHex,rgbToHsb:rgbToHsb,hsbToHex:hsbToHex,hsbToRgb:hsbToRgb,hexToHsb:hexToHsb,hexToRgb:hexToRgb}})})(jQuery);(function(){"use strict";TS.registerModule("ui.a11y",{focus_stack:[],unread_message_strings:{},$aria_live_div:null,onStart:function(){_createAriaLiveElement();TS.channels.switched_sig.add(TS.ui.a11y.annouceCurrentChannelOrImOrGroup);TS.ims.switched_sig.add(TS.ui.a11y.annouceCurrentChannelOrImOrGroup);TS.groups.switched_sig.add(TS.ui.a11y.annouceCurrentChannelOrImOrGroup);TS.mpims.switched_sig.add(TS.ui.a11y.annouceCurrentChannelOrImOrGroup);TS.prefs.a11y_font_size_changed_sig.add(TS.ui.a11y.adjustFontSize);TS.prefs.a11y_animations_changed_sig.add(TS.ui.a11y.replaceAnimatedImages)},focusOnNextMessage:function(){var $currently_focused_element=$(document.activeElement);var $element_to_focus_on;var is_message_element=$currently_focused_element.is(_message_element_selectors);if(is_message_element&&$currently_focused_element.next().length){$element_to_focus_on=$currently_focused_element.next()}else{$element_to_focus_on=_getMessageInputElement()}TS.ui.a11y.focusAndAddTabindex($element_to_focus_on)},focusOnPreviousMessage:function(){var $currently_focused_element=$(document.activeElement);var $element_to_focus_on;var $msgs_div=_getMessageDivElement();var is_message_element=$currently_focused_element.is(_message_element_selectors);if(is_message_element&&$currently_focused_element.prev().length){$element_to_focus_on=$currently_focused_element.prev()}else if(is_message_element&&TS.model.archive_view_is_showing){$element_to_focus_on=_getMessageInputElement()}else if($currently_focused_element.is("#end_display_meta")){$element_to_focus_on=_getMessageInputElement()}else if($msgs_div.children(_message_element_selectors).length&&$msgs_div.children(_message_element_selectors).last()){$element_to_focus_on=$msgs_div.children(_message_element_selectors).last()}else{$element_to_focus_on=_getMessageInputElement()}TS.ui.a11y.focusAndAddTabindex($element_to_focus_on)},focusOnOldestUnreadMessage:function(){if(TS.client.ui.$msgs_unread_divider&&TS.client.ui.$msgs_unread_divider.next().length){TS.ui.a11y.focusAndAddTabindex(TS.client.ui.$msgs_unread_divider.next())}else{TS.ui.a11y.ariaLiveAnnounce("No unread messages.",true)}},
focusOnMessageInput:function(){TS.ui.a11y.focusAndAddTabindex(_getMessageInputElement())},focusAndAddTabindex:function($el){if(!$el)return;if($el.attr("tabindex"))$el.data("previous-tabindex",$el.attr("tabindex"));$el.attr("tabindex","0");$el.focus()},cleanUpTabindex:function($el){if(!$el)return;if($el.data("previous-tabindex")){$el.attr("tabindex",$el.data("previous-tabindex"))}else{$el.removeAttr("tabindex")}},saveCurrentFocus:function(){TS.ui.a11y.focus_stack.push(document.activeElement);return document.activeElement},saveCurrentFocusAndFocusOnElement:function($el){var active_element=TS.ui.a11y.saveCurrentFocus();TS.ui.a11y.focusAndAddTabindex($el);return active_element},restorePreviousFocus:function(){var last_focused_element=TS.ui.a11y.focus_stack.pop();if(last_focused_element&&typeof last_focused_element.focus==="function"){last_focused_element.focus();return last_focused_element}},restorePreviousFocusAndCleanUpElement:function($el){var last_focused_element=TS.ui.a11y.restorePreviousFocus();TS.ui.a11y.cleanUpTabindex($el);return last_focused_element},ariaLiveAnnounce:function(text,assertive){TS.ui.a11y.$aria_live_div.empty();TS.ui.a11y.$aria_live_div.attr("aria-live",assertive?"assertive":"polite");TS.ui.a11y.$aria_live_div.text(text)},assembleActiveModelName:function(){var model_ob=TS.shared.getActiveModelOb();var name="";if(TS.boot_data.feature_unread_view&&TS.model.unread_view_is_showing){name="All unread messages"}else if(TS.boot_data.feature_message_replies_threads_view&&TS.model.threads_view_is_showing){name="Threads"}else if(model_ob.is_channel){name="Channel #"+model_ob.name}else if(model_ob.is_im){if(TS.boot_data.feature_name_tagging_client){name="Direct message with "+TS.members.getMemberFullName(model_ob.user)}else{name="Direct message with "+model_ob.name}}else if(model_ob.is_mpim){name="Direct message with "+TS.mpims.getDisplayName(model_ob)}else if(model_ob.is_group){name="Private Channel "+model_ob.name}return name},saveUnreadCountMessage:function(model_ob,message){if(!model_ob||!model_ob.name||!message)return;TS.ui.a11y.unread_message_strings[model_ob.name]=message},annouceCurrentChannelOrImOrGroup:function(){var name=TS.ui.a11y.assembleActiveModelName();var announce_message=name;var model_ob=TS.shared.getActiveModelOb();if(!model_ob)return;if(TS.model.archive_view_is_showing){TS.ui.a11y.focusAndAddTabindex(_getMessageInputElement());return}if(TS.ui.a11y.unread_message_strings[model_ob.name]){announce_message+=", "+TS.ui.a11y.unread_message_strings[model_ob.name];delete TS.ui.a11y.unread_message_strings[model_ob.name]}TS.ui.a11y.ariaLiveAnnounce(announce_message,true);TS.client.ui.$msg_input.attr("aria-label","Message input for "+name)},adjustFontSize:function(){TS.ui.a11y.setFontSize();TS.ui.a11y.resetMessageInput()},setFontSize:function(){var sizes={normal:"16",110:"17.6",125:"20",150:"24"};var size=TS.model.prefs.a11y_font_size;var value=(sizes[size]||sizes["normal"])+"px";document.documentElement.style.fontSize=value},resetMessageInput:function(){TS.client.msg_input.reset();TS.client.msg_input.$input.trigger("autosize-resizeIncludeStyle");TS.client.msg_input.resized();TS.view.onResize()},replaceAnimatedImages:function(){TS.ui.a11y.replaceAnimatedFiles();TS.ui.a11y.replaceEmoji()},replaceAnimatedFiles:function(){var animations=TS.model.prefs.a11y_animations;var file;var img_to_replace;if(_is_space){_replacePostGif();return}var msgs=TS.utility.msgs.getDisplayedMsgs(TS.shared.getActiveModelOb().msgs);if(animations===false){for(var i=0;i<msgs.length;i++){if(msgs[i].file){file=msgs[i].file;if(file.filetype==="gif"){if(file.deanimate_gif){img_to_replace=file.deanimate_gif}else if(file.thumb_160){img_to_replace=file.thumb_160}if(img_to_replace){_replaceFileGif(file.id,img_to_replace)}}else if(file.filetype==="space"){_replacePostGif(msgs[i].ts)}}else if(msgs[i].attachments){_replaceAttachment(msgs[i].ts,msgs[i].attachments[0])}}}else{for(var i=0;i<msgs.length;i++){if(msgs[i].file){file=msgs[i].file;if(file.filetype==="gif"){if(file.thumb_360_gif){img_to_replace=file.thumb_360_gif}else if(file.thumb_360){img_to_replace=file.thumb_360}if(img_to_replace){_replaceFileGif(file.id,img_to_replace)}}else if(file.filetype==="space"){_replacePostGif(msgs[i].ts)}}else if(msgs[i].attachments){_replaceAttachment(msgs[i].ts,msgs[i].attachments[0])}}}},replaceEmoji:function(){var _emoji=emoji;var emoji_list=$(".emoji");var new_emoji_url;for(var j=0;j<emoji_list.length;j++){var new_emoji=_emoji.replace_colons(emoji_list[j].innerText);if(!new_emoji){var emoji_colons=":"+emoji_list[j].parentNode.getAttribute("data-emoji")+":";new_emoji=_emoji.replace_colons(emoji_colons)}if(new_emoji){if(new_emoji.match(/.+background-image:url\((.+)\).*/)){new_emoji_url=new_emoji.match(/.+background-image:url\((.+)\).*/)[1]}}emoji_list[j].style["backgroundImage"]='url("'+new_emoji_url+'")'}TS.emoji.makeMenuLists()},test:function(){return{createAriaLiveElement:_createAriaLiveElement,destroyAriaLiveElement:_destroyAriaLiveElement,getMessageInputElement:_getMessageInputElement,getMessageDivElement:_getMessageDivElement}}});var _message_element_selectors=".message, .day_divider, .unread_divider";var _is_space=TS.web&&TS.web.space;var _createAriaLiveElement=function(){TS.ui.a11y.$aria_live_div=$('<div id="aria_live_announcer" role="status"></div>');$("body").append(TS.ui.a11y.$aria_live_div);return TS.ui.a11y.$aria_live_div};var _destroyAriaLiveElement=function(){TS.ui.a11y.$aria_live_div.remove();delete TS.ui.a11y.$aria_live_div};var _getMessageInputElement=function(){return TS.model.archive_view_is_showing&&TS.client.archives.not_member?$("#footer_archives"):TS.client.ui.$msg_input};var _getMessageDivElement=function(){return TS.model.archive_view_is_showing?TS.client.archives.$archives_msgs_div:TS.client.ui.$msgs_div};var _replaceFileGif=function(file_id,img_to_replace){var $image=$('.image_gif[data-file-id="'+file_id+'"]');$image.attr("data-src",img_to_replace);$image.find(".image_bg").attr("data-real-background-image",img_to_replace);$image.find(".image_bg").css("backgroundImage","url("+img_to_replace+")");$image.find("img").data("real-src",img_to_replace);$image.find("img").attr("src",img_to_replace)};var _replaceAttachment=function(message_ts,attachment){if(!attachment)return;if(attachment.is_animated||attachment.image_url&&attachment.image_url.match(/\.gifv?$/)){var $message=$('.message[data-ts="'+message_ts+'"]');var $gif=$message.find(".msg_inline_img img");var img_to_replace=TS.model.prefs.a11y_animations===false?TS.utility.getImgProxyURL(attachment.image_url,attachment.image_width,attachment.image_height):attachment.image_url;_replaceImg($gif,img_to_replace)}};var _replacePostGif=function(message_ts){var $gifs=_is_space?$("ts-space .msg_inline_img img"):$('.message[data-ts="'+message_ts+'"] .post_container .msg_inline_img img');$.each($gifs,function(){var $gif=$(this);var img_to_replace=TS.utility.getImgProxyURL($gif.attr("src"));_replaceImg($gif,img_to_replace)})};var _replaceImg=function($gif,img_to_replace){$gif.attr({"data-real-src":img_to_replace,src:img_to_replace});var $msg_inline_img=$gif.closest(".msg_inline_img");$msg_inline_img.attr("data-real-background-image",img_to_replace);$msg_inline_img.css("backgroundImage","url("+img_to_replace+")")}})();(function(){"use strict";TS.registerModule("ui.at_channel_warning_dialog",{$div:null,showing:false,onKeydown:function(e){if(!TS.ui.at_channel_warning_dialog.showing)return;switch(e.which){case TS.utility.keymap.esc:TS.ui.at_channel_warning_dialog.cancel();break;case TS.utility.keymap.enter:e.preventDefault();TS.ui.at_channel_warning_dialog.go();break}},start:function($el,text,member_count,timezone_count,callback,fullsize){if(!TS.ui.at_channel_warning_dialog.$div)TS.ui.at_channel_warning_dialog.build();if(TS.ui.at_channel_warning_dialog.showing)return;var $div=TS.ui.at_channel_warning_dialog.$div;_callback=callback;_$el=$el;var clean_text=TS.format.cleanMsg(text);var keyword="";if(TS.model.everyone_regex.test(clean_text)){keyword="everyone"}else if(TS.model.channel_regex.test(clean_text)){keyword="channel"}else if(TS.model.group_regex.test(clean_text)){keyword="group"}if(member_count<AT_CHANNEL_WARNING_MINIMUM_MEMBER_COUNT){TS.ui.at_channel_warning_dialog.go();return}var html=TS.templates.at_channel_warning_dialog({keyword:keyword,member_count:member_count,timezone_count:timezone_count});$div.html(html);fullsize?$div.addClass("fullsize"):$div.removeClass("fullsize");$div.modal("show");TS.ui.a11y.saveCurrentFocusAndFocusOnElement($div);$div.find(".dialog_cancel").click(TS.ui.at_channel_warning_dialog.cancel);$div.find(".dialog_go").click(TS.ui.at_channel_warning_dialog.go);$(window).bind("resize",TS.ui.at_channel_warning_dialog.position);TS.ui.at_channel_warning_dialog.position();TS.prefs.setPrefByAPI({name:"last_seen_at_channel_warning",value:Date.now()})},startInMessagePane:function(c_id,text,controller){var eligible_members;var timezone_count;var model_ob=TS.shared.getModelObById(c_id);if(!model_ob||model_ob.is_im)return;var c_info_p=new Promise(function(resolve,reject){if(TS.lazyLoadMembersAndBots()){_promiseToGetTimezoneCountAndMemberCountForObject(model_ob).then(resolve)}else{eligible_members=_(model_ob.members).map(TS.members.getMemberById).compact().sortBy(TS.members.memberSorterByName).value().filter(TS.utility.members.isMemberNonBotNonDeletedNonSelf);timezone_count=_(eligible_members).map("tz_offset").uniq().value().length;resolve({member_count:eligible_members.length,timezone_count:timezone_count})}});var callback=function(){TS.view.clearMessageInput();TS.shared.sendMsg(c_id,text,controller)};var $el=TS.client.ui.$msg_input;var fullsize=true;TS.client.msg_input.populate(text);c_info_p.then(function(result){TS.ui.at_channel_warning_dialog.start($el,text,result.member_count,result.timezone_count,callback,fullsize);return null})},startInFlexPane:function(file,channel_ids,text){if(!file){TS.error("no file to warn about!");return}var callback=function(){var bypass_at_warning_check=true;TS.client.ui.files.submitFileComment(bypass_at_warning_check)};var $el=$("#file_comment_form #file_comment");var fullsize=false;var eligible_members;var timezone_count;var f_info_p=new Promise(function(resolve,reject){if(TS.lazyLoadMembersAndBots()){_promiseToGetTimezoneCountAndMemberCountForObject(file).then(resolve)}else{var model_obs=_(channel_ids).map(TS.shared.getModelObById).compact().reject({is_im:true}).value();var member_ids=_(model_obs).map("members").flatten().uniq().value();var members=_(member_ids).map(TS.members.getMemberById).compact().sortBy(TS.members.memberSorterByName).value();eligible_members=members.filter(TS.utility.members.isMemberNonBotNonDeletedNonSelf);timezone_count=_(eligible_members).map("tz_offset").uniq().value().length;resolve({member_count:eligible_members.length,timezone_count:timezone_count})}});f_info_p.then(function(result){TS.ui.at_channel_warning_dialog.start($el,text,result.member_count,result.timezone_count,callback,fullsize);return null})},position:function(){var $div=TS.ui.at_channel_warning_dialog.$div;var offset=_$el.offset();$div.css({top:offset.top-$div.height()-8,left:offset.left})},go:function(){TS.ui.at_channel_warning_dialog.$div.modal("hide");_callback()},cancel:function(){TS.ui.at_channel_warning_dialog.$div.modal("hide");TS.ui.a11y.restorePreviousFocus()},end:function(){TS.ui.at_channel_warning_dialog.showing=TS.model.dialog_is_showing=false;$(window.document).unbind("keydown",TS.ui.at_channel_warning_dialog.onKeydown);$(window).unbind("resize",TS.ui.at_channel_warning_dialog.position)},build:function(){$("body").append('<div id="at_channel_warning_dialog" class="modal hide fade"></div>');var $div=TS.ui.at_channel_warning_dialog.$div=$("#at_channel_warning_dialog");$div.on("hide",function(e){if(e.target!=this)return;TS.ui.at_channel_warning_dialog.end()});$div.on("show",function(e){if(e.target!=this)return;TS.ui.at_channel_warning_dialog.showing=TS.model.dialog_is_showing=true});$div.on("shown",function(e){if(e.target!=this)return;setTimeout(function(){$(window.document).bind("keydown",TS.ui.at_channel_warning_dialog.onKeydown)},100)})}});var _callback=function(){};var _$el;var AT_CHANNEL_WARNING_MINIMUM_MEMBER_COUNT=5;var _promiseToGetTimezoneCountAndMemberCountForObject=function(model_ob){var is_file=false;var api_endpoint;var api_args={timezone_count:true,display_counts:true};if(model_ob.is_group){api_endpoint="groups.info";api_args.channel=model_ob.id}else if(model_ob.is_channel){api_endpoint="channels.info";api_args.channel=model_ob.id}else{is_file=true;api_endpoint="files.info";api_args.file=model_ob.id}return TS.api.call(api_endpoint,api_args).then(function(response){var member_count;var timezone_count;if(is_file){member_count=_.get(response,"data.display_counts.display_counts")||1;timezone_count=response.data.timezone_count}else{member_count=(model_ob.is_group?_.get(response,"data.group.display_counts.display_counts"):_.get(response,"data.channel.display_counts.display_counts"))||1;timezone_count=model_ob.is_group?response.data.group.timezone_count:response.data.channel.timezone_count}member_count--;return{member_count:member_count,timezone_count:timezone_count}}).catch(function(err){return{member_count:0,timezone_count:1}})}})();(function(){"use strict";TS.registerModule("client.archives",{current_model_ob:null,not_member:false,$scroller:$("#archive_msgs_scroller_div"),$archives_msgs_div:$("#archives_msgs_div"),msgs_are_auto_scrolling:false,active_highlight_count:0,onStart:function(){TS.shared.msg_sent_sig.add(_msgSent);TS.channels.joined_sig.add(_channelJoined);TS.groups.unarchived_sig.add(_groupUnArchived);TS.groups.archived_sig.add(_groupArchived);TS.channels.unarchived_sig.add(_channelUnArchived);TS.channels.archived_sig.add(_channelArchived);TS.channels.message_received_sig.add(_messageReceived);TS.channels.message_removed_sig.add(_messageRemoved);TS.channels.message_changed_sig.add(_messageChanged);TS.groups.message_received_sig.add(_messageReceived);TS.groups.message_removed_sig.add(_messageRemoved);TS.groups.message_changed_sig.add(_messageChanged);TS.ims.message_received_sig.add(_messageReceived);TS.ims.message_removed_sig.add(_messageRemoved);TS.ims.message_changed_sig.add(_messageChanged);TS.mpims.message_received_sig.add(_messageReceived);TS.mpims.message_removed_sig.add(_messageRemoved);TS.mpims.message_changed_sig.add(_messageChanged);if(!TS.environment.supports_custom_scrollbar){TS.client.archives.$scroller.monkeyScroll({always_show:true})}_$container=$("#monkey_scroll_wrapper_for_archive_msgs_scroller_div");_$container.addClass("hidden");$("#archives_return").addClass("hidden").removeClass("warning").find(".cancel_archives").addClass("hidden");_bindUI()},start:function(msg_id){var model_ob=TS.shared.getActiveModelOb();if(!model_ob){TS.warn("WTF no model_ob in TS.client.archives.start()");return}if(TS.client.archives.current_model_ob){if(model_ob.id==TS.client.archives.current_model_ob.id){if(msg_id&&msg_id==_msg_id){if(model_ob._archive_msgs&&TS.utility.msgs.getMsg(msg_id,model_ob._archive_msgs)){_scrollToMsgOrOpenConversation(_msg_id)}return}else{if(msg_id){if(model_ob._archive_msgs&&TS.utility.msgs.getMsg(msg_id,model_ob._archive_msgs)){_msg_id=msg_id;_scrollToMsgOrOpenConversation(_msg_id);return}else if(!TS.boot_data.feature_browse_date){_end()}}else{TS.info("no change requested in TS.client.archives.start()");return}}}else{_end()}}var loading_text=TS.i18n.t("Loading...","archives")();TS.client.archives.$archives_msgs_div.html('<div class="loading_hash_animation"><img src="'+cdn_url+"/f85a/img/loading_hash_animation_@2x.gif"+'" alt="'+loading_text+'" /><br />'+loading_text+"</div>");_showing_id=model_ob.id+(msg_id||"");_msg_id=msg_id||null;TS.client.archives.current_model_ob=model_ob;_current_history_api_method=TS.shared.getHistoryApiMethodForModelOb(model_ob);TS.client.archives.not_member=model_ob.is_channel&&(!model_ob.is_member||model_ob.is_archived)||model_ob.is_group&&model_ob.is_archived;model_ob.never_needs_joined_msg=true;_adjustForArchivesDisplay();_$container.removeClass("hidden");TS.client.archives.$scroller.removeClass("hidden");var latest_api_args={channel:model_ob.id,count:50,_showing_id:_showing_id};_scrolled_to_bottom=false;_scrolled_to_top=false;_expected_api_rsps=0;_received_api_rsps=0;_all_loaded_bottom=null;_all_loaded_top=null;_loading_bottom=false;_loading_top=false;_updateTop();_updateBottom();var onInitialHistoryApiCall=function(ok,data,args){if(!ok){if(args._showing_id!=_showing_id)return false;_end();TS.client.archives.start()}if(!_onHistory(ok,data,args))return;if(_received_api_rsps!=_expected_api_rsps)return;if(TS.boot_data.feature_message_replies){var msg=TS.utility.msgs.getMsg(_msg_id,model_ob._archive_msgs);if(msg&&TS.utility.msgs.isMsgReply(msg)){TS.ui.replies.openConversation(model_ob,msg.thread_ts,msg.ts);if(!model_ob.is_channel||model_ob.is_member){_end();return}}}_displayMsgs(model_ob,model_ob._archive_msgs);var $scroller=TS.client.archives.$scroller;var onDone=function(){TS.client.archives.msgs_are_auto_scrolling=true;$scroller.scrollTop($scroller[0].scrollHeight);TS.client.archives.msgs_are_auto_scrolling=false;if(_msg_id)TS.client.ui.scrollMsgsSoMsgIsInView(_msg_id,false,true)};onDone();if(_all_loaded_top)return;if(TS.client.archives.$archives_msgs_div.find(".message").length>=20)return;_loadMoreTop(function(){onDone()})};if(_msg_id){var oldest_api_args={channel:model_ob.id,count:50,oldest:_msg_id,inclusive:true,_showing_id:_showing_id};latest_api_args.latest=_msg_id;latest_api_args.count=25;_expected_api_rsps=2;TS.api.callImmediately(_current_history_api_method,oldest_api_args,onInitialHistoryApiCall);TS.api.callImmediately(_current_history_api_method,latest_api_args,onInitialHistoryApiCall)}else{_expected_api_rsps=1;setTimeout(function(){if(!TS.model.archive_view_is_showing)return;if(_msg_id)return;TS.api.callImmediately(_current_history_api_method,latest_api_args,onInitialHistoryApiCall)},20)}if(!_msg_id&&model_ob.was_archived_this_session){model_ob.was_archived_this_session=false;if(model_ob.is_channel){TS.channels.calcUnreadCnts(model_ob,true);TS.channels.markMostRecentReadMsg(model_ob,TS.model.marked_reasons.none_qualify)}else{TS.groups.calcUnreadCnts(model_ob,true);TS.groups.markMostRecentReadMsg(model_ob,TS.model.marked_reasons.none_qualify)}model_ob.was_archived_this_session=true}TS.model.archive_view_is_showing=true;if(TS.client.archives.not_member){TS.client.channel_pane.rebuild("starred","channels");if(!model_ob.is_group){TS.api.callImmediately("channels.info",{channel:model_ob.id},function(ok,data,args){if(!TS.model.archive_view_is_showing){return}if(!ok){TS.warn("WTF, bad API rsp? error:"+data.error);return}if(!data.channel){TS.warn("WTF, no channel?");return}var channel=TS.channels.upsertChannel(data.channel);if(channel.id!=TS.client.archives.current_model_ob.id){return}TS.channels.data_updated_sig.dispatch(channel)})}}TS.view.resizeManually("TS.client.archives started")},maybeHandleArchiveLink:function($el){if(!TS.client)return false;if(!$el||!$el.length)return false;if(!$el.is("a"))return false;var href=$el.attr("href");if(!href)return false;href=TS.utility.normalizeDevHost(href);href=href.replace("https://","").replace("http://","");var archives_url=TS.model.archives_url.replace("https://","").replace("http://","");if(href.indexOf(archives_url)===0){href=href.replace(archives_url,"archives")}while(href.indexOf("/")===0){href=href.substr(1)}if(href.indexOf("archives/")===0){var A=href.split("/");if(A.length<2)return false;var identifier=A[1];if(!identifier)return false;var model_ob=TS.ims.getImById(identifier)||TS.channels.getChannelByName(identifier)||TS.groups.getGroupByName(identifier)||TS.mpims.getMpimById(identifier)||TS.mpims.getMpimByName(identifier);if(!model_ob)return false;if(model_ob.is_im&&TS.ims.isImWithDeletedMember(model_ob))return false;if(A.length==2||!A[2]){if(model_ob.is_channel){TS.channels.displayChannel(model_ob.id)}else if(model_ob.is_mpim){TS.mpims.displayMpim(model_ob.id)}else if(model_ob.is_group){TS.groups.displayGroup(model_ob.id)}else{TS.ims.startImById(model_ob.id)}return model_ob.id==TS.model.active_cid}var url_ts=A[2];if(!url_ts)return false;if(url_ts.indexOf("p")!==0)return false;if(url_ts.length!=17)return false;url_ts=url_ts.replace("p","");if(isNaN(url_ts))return false;var actual_ts=url_ts.substr(0,10)+"."+url_ts.substr(10);if(model_ob.id==TS.model.active_cid){if($el.hasClass("timestamp")){if($el.closest("#msgs_div").length!==0||$el.closest("#archives_msgs_div").length!==0){var container_id=TS.templates.makeMsgDomId(actual_ts);if($el.closest("#"+container_id).length!==0){return false}}}}return TS.client.ui.tryToJump(model_ob.id,actual_ts)}return false},onMsgsScroll:function(){if(!TS.model.archive_view_is_showing)return;TS.utility.throttle.method(_onMsgsScrollThrottled,"ts_archives_on_msgs_scroll",250)},maybeLoadScrollBackHistory:function(){if(TS.client.archives.active_highlight_count||TS.model.ui.is_mouse_down)return;if(_received_api_rsps!=_expected_api_rsps)return;if(_scrolled_to_bottom){TS.info("_scrolled_to_bottom _all_loaded_bottom:"+_all_loaded_bottom);if(!_all_loaded_bottom)_loadMoreBottom()}else if(_scrolled_to_top){TS.info("_scrolled_to_top _all_loaded_top:"+_all_loaded_top);if(!_all_loaded_top)_loadMoreTop()}},loadMoreBottom:function(){if(!TS.model.archive_view_is_showing)return;if(!_all_loaded_bottom)_loadMoreBottom()},loadMoreTop:function(){if(!TS.model.archive_view_is_showing)return;if(!_all_loaded_top)_loadMoreTop()},padOutMsgsScroller:function(){var end_div=$("#archives_top_div");end_div.css("margin-top","");var h=end_div.outerHeight();var allowed_h=TS.client.archives.$scroller[0].scrollHeight-(TS.client.archives.$archives_msgs_div.outerHeight()+$("#archives_top_div").outerHeight());allowed_h-=13;if(allowed_h>h){end_div.css("margin-top",allowed_h-end_div.outerHeight()+"px")}},tryToJoin:function(){if(!TS.model.archive_view_is_showing)return;if(!TS.client.archives.current_model_ob)return;if(!TS.client.archives.current_model_ob.is_channel)return;if(TS.client.archives.current_model_ob.is_archived)return;$("#footer_archives_action_button").trigger("click")},userWantsToCancel:function(){if(!TS.model.archive_view_is_showing)return;if(TS.client.archives.current_model_ob.is_group&&TS.client.archives.current_model_ob.is_archived){TS.client.ui.maybePromptForClosingGroup(TS.client.archives.current_model_ob.id)}else{if(TS.client.archives.current_model_ob.was_archived_this_session){TS.client.archives.current_model_ob.was_archived_this_session=false}TS.client.archives.cancel()}},cancel:function(going_somewhere){if(!TS.model.archive_view_is_showing)return;var go_back=TS.client.archives.not_member&&!going_somewhere;_end(go_back)},rebuildMsg:function(msg){if(!TS.model.archive_view_is_showing||!TS.client.archives.current_model_ob)return;if(!msg)return;var $msg_div=TS.client.archives.$archives_msgs_div.find("#"+TS.templates.makeMsgDomId(msg.ts));if(!$msg_div.length)return;var model_ob=TS.client.archives.current_model_ob;var prev_msg=TS.utility.msgs.getPrevDisplayedMsg(msg.ts,model_ob._archive_msgs);var html=TS.templates.builders.buildMsgHTML({msg:msg,model_ob:model_ob,prev_msg:prev_msg,container_id:"archives_msgs_div",enable_slack_action_links:false});$msg_div.replaceWith(html);TS.utility.makeSureAllExternalLinksAreRefererSafe($msg_div)}});var _current_history_api_method="";var _$container=null;var _msg_id=null;var _scrolled_to_bottom=false;var _scrolled_to_top=false;var _expected_api_rsps=0;var _received_api_rsps=0;var _all_loaded_bottom=null;var _all_loaded_top=null;var _loading_bottom=false;var _loading_top=false;var _showing_id=false;var _displayMsgs=function(model_ob,msgs){var $archives_msgs_div=TS.client.archives.$archives_msgs_div;$archives_msgs_div.empty();var jl_rolled_up_msgs=[];var msg;var prev_msg;var html="";var visible_msgs=msgs;if(TS.boot_data.feature_message_replies){visible_msgs=_.reject(msgs,TS.utility.msgs.isMsgHidden)}for(var i=visible_msgs.length-1;i>-1;i--){if(!msg||!TS.utility.msgs.isMsgHidden(msg))prev_msg=msg;msg=visible_msgs[i];if(TS.boot_data.feature_message_replies&&TS.utility.msgs.isMsgHidden(msg))continue;var rollup=TS.utility.msgs.msgRollUpWorker(i,msg,visible_msgs,jl_rolled_up_msgs);if(rollup=="continue"){msg=prev_msg;continue}else if(rollup=="swap"){msg=jl_rolled_up_msgs[0];jl_rolled_up_msgs.length=0}if(!prev_msg||!TS.utility.msgs.areMsgsSameDay(msg,prev_msg)){if(prev_msg)html+="</div></div>";html+='<div class="day_container">';html+=TS.templates.messages_day_divider({ts:msg.ts});html+='<div class="day_msgs" data-date="'+TS.utility.date.toCalendarDate(msg.ts)+'" data-ts="'+msg.ts+'">'}html+=TS.templates.builders.buildMsgHTML({msg:msg,model_ob:model_ob,prev_msg:prev_msg,container_id:"archives_msgs_div",enable_slack_action_links:false});if(i===0){html+="</div></div>"}}$archives_msgs_div.html(html);TS.utility.makeSureAllExternalLinksAreRefererSafe($archives_msgs_div);var show_bottom=!_all_loaded_bottom;$("#archives_bottom_div").toggleClass("hidden",!show_bottom);$("#archives_return").toggleClass("hidden",!show_bottom);$("#archives_top_div").removeClass("hidden");TS.client.ui.$msgs_scroller_div.addClass("hidden");TS.client.archives.padOutMsgsScroller();TS.client.archives.msgs_are_auto_scrolling=true;_onMsgsScrollThrottled();TS.client.archives.msgs_are_auto_scrolling=false;TS.ui.utility.updateClosestMonkeyScroller(TS.client.archives.$scroller);_updateDateDisplayed()};var _loadMoreTop=function(callback){_loading_top=true;_updateTop();var model_ob=TS.client.archives.current_model_ob;var latest_ts=model_ob._archive_msgs[model_ob._archive_msgs.length-1].ts;_expected_api_rsps++;TS.api.callImmediately(_current_history_api_method,{channel:model_ob.id,latest:latest_ts,count:parseInt(TS.model.subsequent_msgs_cnt/2),_showing_id:_showing_id},function(ok,data,args){if(!_onHistory(ok,data,args))return;_loading_top=false;_updateTop();_displayMsgs(model_ob,model_ob._archive_msgs);if(latest_ts){TS.client.ui.scrollMsgsSoMsgIsInView(latest_ts,true,false)}if(callback)callback()})};var _loadMoreBottom=function(){_loading_bottom=true;_updateBottom();var model_ob=TS.client.archives.current_model_ob;var oldest_ts=model_ob._archive_msgs[0].ts;_expected_api_rsps++;TS.api.callImmediately(_current_history_api_method,{channel:model_ob.id,oldest:oldest_ts,count:parseInt(TS.model.subsequent_msgs_cnt/2),_showing_id:_showing_id},function(ok,data,args){if(!_onHistory(ok,data,args))return;_loading_bottom=false;_updateBottom();_displayMsgs(model_ob,model_ob._archive_msgs);if(oldest_ts){TS.client.ui.scrollMsgsSoMsgIsInView(oldest_ts,false,false,0)}})};var _onHistory=function(ok,data,args){if(!TS.model.archive_view_is_showing)return false;if(args._showing_id!=_showing_id)return false;var model_ob=TS.client.archives.current_model_ob;var archive_msgs=model_ob._archive_msgs;var new_msgs=[];var imsg;var overlapped=false;var id;var i;var msg_to_keep_in_place_if_overlap=archive_msgs&&archive_msgs.length?archive_msgs[0]:"";if(msg_to_keep_in_place_if_overlap&&!TS.client.msg_pane.getDivForArchiveMsg(msg_to_keep_in_place_if_overlap.ts).length){msg_to_keep_in_place_if_overlap=null}if(data.messages){for(i=0;i<data.messages.length;i++){id=data.messages[i].ts;if(!archive_msgs||!TS.utility.msgs.getMsg(id,archive_msgs)){imsg=data.messages[i];new_msgs.push(TS.utility.msgs.processImsgFromHistory(imsg,model_ob.id))}if(!TS.client.archives.not_member&&!overlapped&&TS.utility.msgs.getMsg(id,model_ob.msgs)){overlapped=true}}}model_ob._archive_msgs=archive_msgs?new_msgs.concat(archive_msgs):new_msgs;if(overlapped){new_msgs=[];for(i=0;i<model_ob._archive_msgs.length;i++){if(!TS.utility.msgs.getMsg(model_ob._archive_msgs[i].ts,model_ob.msgs)){imsg=model_ob._archive_msgs[i];new_msgs.push(imsg)}}TS.utility.msgs.setMsgs(model_ob,new_msgs.concat(model_ob.msgs));TS.client.msg_pane.rebuildMsgs();var msg_id_to_highlight;var scrolltop;if(msg_to_keep_in_place_if_overlap){scrolltop=TS.client.archives.$scroller.scrollTop()}else{msg_id_to_highlight=_msg_id}var no_scroll=true;_end(false,no_scroll);if(msg_to_keep_in_place_if_overlap){TS.client.ui.$msgs_scroller_div.scrollTop(scrolltop)}else if(msg_id_to_highlight){TS.client.ui.scrollMsgsSoMsgIsInView(msg_id_to_highlight,false,true)}return false}TS.utility.msgs.sortMsgs(model_ob._archive_msgs);if(args.latest){_all_loaded_top=!data.has_more;_updateTop()}else if(args.oldest){_all_loaded_bottom=!data.has_more;_updateBottom()}else{_all_loaded_top=args.count!=data.messages.length;_updateTop();_all_loaded_bottom=true;_updateBottom()}_received_api_rsps++;return true};var _adjustForArchivesDisplay=function(){$("#monkey_scroll_wrapper_for_msgs_scroller_div").addClass("hidden");var model_ob=TS.client.archives.current_model_ob;var placeholder_hash=model_ob.is_channel?"#":"";var hash="";if(model_ob.is_channel){hash='<ts-icon class="ts_icon_bold_hash_small"></ts-icon>'}else if(model_ob.is_group){hash='<ts-icon class="ts_icon_lock"></ts-icon>'}var shared="";if(model_ob.is_shared)shared='<ts-icon class="ts_icon_shared_channel"></ts-icon>';$("#footer_archives_action_button").addClass("btn_outline");if(TS.client.archives.not_member){var archive_html;var action_tip_html;$("#active_channel_name").addClass("no_star");$("#footer_msgs").addClass("hidden");$("#footer").css("height","auto");$("#footer_archives").removeClass("hidden");if(model_ob.is_archived){archive_html=TS.i18n.t("You are viewing <strong>{hash}{channel_name}{shared}</strong>, an archived channel","archives")({hash:hash,channel_name:TS.utility.htmlEntities(TS.utility.ellipsize(model_ob.name,25)),shared:shared});action_tip_html=TS.i18n.t('<strong aria-label="return">Esc</strong> to close',"archives")();$("#footer_archives_text").html(archive_html);$("#footer_archives_action_button").text(TS.i18n.t("Close Channel","archives")());$("#footer_archives_action_tip").html('<span class="tiny dialog_cancel_hint">'+action_tip_html+"</span>")}else{archive_html=TS.i18n.t("You are viewing a preview of <strong>{hash}{channel_name}{shared}</strong>","archives")({hash:hash,channel_name:TS.utility.htmlEntities(TS.utility.ellipsize(model_ob.name,25)),shared:shared});action_tip_html=TS.i18n.t('<strong aria-label="return">Return <span class="return_char">&crarr;</span></strong> to join',"archives")();$("#footer_archives_text").html(archive_html);$("#footer_archives_action_button").text(TS.i18n.t("Join Channel","archives")()).removeClass("btn_outline");$("#footer_archives_action_tip").html('<span class="tiny dialog_cancel_hint">'+action_tip_html+"</span>")}TS.utility.contenteditable.placeholder(TS.client.ui.$msg_input,"")}else{TS.utility.contenteditable.placeholder(TS.client.ui.$msg_input,TS.i18n.t("You are viewing the archives of {hash}{channel_name}","archives")({hash:placeholder_hash,channel_name:model_ob.name}))}};var _unAdjustForArchivesDisplay=function(){$("#monkey_scroll_wrapper_for_msgs_scroller_div").removeClass("hidden");$("#active_channel_name").removeClass("no_star");$("#footer_msgs").removeClass("hidden");$("#footer").css("height","");$("#footer_archives").addClass("hidden");$("#archives_bottom_div").addClass("hidden");$("#archives_top_div").addClass("hidden");$("#archives_return").addClass("hidden").removeClass("warning");TS.client.archives.$scroller.addClass("hidden");TS.client.ui.$msgs_scroller_div.removeClass("hidden");TS.client.msg_input.setPlaceholder();TS.ui.utility.updateClosestMonkeyScroller(TS.client.ui.$msgs_scroller_div);TS.view.measureInput();if(!TS.boot_data.feature_texty&&!TS.boot_data.feature_new_msg_input){TS.client.ui.files.$file_btn.css("height",TS.view.last_input_height+"px")}};var _updateBottom=function(){var txt;if(_loading_bottom){txt=TS.i18n.t("retrieving history...","archives")()}else if(_all_loaded_bottom){if(_msg_id){txt="&nbsp;"}else{txt=""}}else{txt='<a onclick="TS.client.archives.loadMoreBottom()">'+TS.i18n.t("and more...","archives")()+"</a>"}$("#archives_bottom_div").html(txt)};var _updateTop=function(){var txt;if(_loading_top){
txt=TS.i18n.t("retrieving history...","archives")()}else if(_all_loaded_top){txt=TS.i18n.t("~FIN~","archives")()}else{txt='<a onclick="TS.client.archives.loadMoreTop()">'+TS.i18n.t("and more...","archives")()+"</a>"}$("#archives_top_div").html(txt)};var _end=function(go_back,no_scroll){if(!TS.model.archive_view_is_showing)return;if(go_back&&!TS.client.archives.previous_model_ob){TS.client.archives.previous_model_ob=TS.channels.getGeneralChannel()||TS.ims.getImByMemberId("USLACKBOT")}TS.client.archives.$archives_msgs_div.empty();TS.ui.utility.updateClosestMonkeyScroller(TS.client.archives.$scroller);_$container.addClass("hidden");var clean_lists=false;if(TS.client.archives.current_model_ob){delete TS.client.archives.current_model_ob._archive_msgs;if(TS.client.archives.not_member)clean_lists=true}_msg_id=null;TS.client.archives.current_model_ob=null;_current_history_api_method="";TS.model.archive_view_is_showing=false;if(clean_lists){TS.client.channel_pane.rebuild("starred","channels")}_unAdjustForArchivesDisplay();TS.view.resizeManually("TS.client.archives ended");if(!no_scroll&&TS.model.prefs.start_scroll_at_oldest&&TS.shared.getActiveModelOb().unread_cnt){setTimeout(TS.client.ui.scrollMsgsSoFirstUnreadMsgIsInView,100)}else{TS.client.msg_pane.checkUnreads()}if(go_back){var model_ob=TS.client.archives.previous_model_ob;delete TS.client.archives.previous_model_ob;if(model_ob.is_channel){TS.channels.displayChannel(model_ob.id)}else if(model_ob.is_mpim){TS.mpims.displayMpim(model_ob.id)}else if(model_ob.is_group){TS.groups.displayGroup(model_ob.id)}else{TS.ims.startImById(model_ob.id)}}};var _bindUI=function(){$("#footer_archives_action_button").bind("click",function(){if(TS.isPartiallyBooted()){TS.incremental_boot.userDidInteractWithUI();return}var model_ob=TS.client.archives.current_model_ob;if(model_ob.is_channel){if(model_ob.is_archived){TS.channels.closeArchivedChannel(model_ob.id)}else{TS.channels.join(model_ob.name,function(){if(TS.boot_data.feature_calls)TS.client.msg_pane.maybeSetupCalls()})}}else{TS.shared.closeArchivedChannel(model_ob.id)}});TS.client.archives.$scroller.scroll(function(){TS.client.archives.onMsgsScroll()});$("#archives_return .cancel_archives").bind("click",function(){if(TS.client.archives.not_member){if(_all_loaded_bottom){TS.client.ui.slowScrollMsgsToBottom()}else{_end();TS.client.archives.start()}}else{_end()}});TS.client.ui.$msg_input.bind("textchange",function(e,prev_txt){if(!TS.model.archive_view_is_showing)return;if(TS.client.archives.not_member)return;var $this=$(this);if($this.val()===""){$("#archives_return").removeClass("warning")}else{$("#archives_return").addClass("warning")}})};var _onMsgsScrollThrottled=function(){if(!TS.model.archive_view_is_showing)return;var scroll_top;_scrolled_to_top=false;_scrolled_to_bottom=false;if(TS.client.ui.areMsgsScrolledToBottom(0)){scroll_top=-1;_scrolled_to_bottom=true}else{scroll_top=TS.client.archives.$scroller[0].scrollTop;if(scroll_top===0){_scrolled_to_top=true}}var scrolled_almost_to_bottom=TS.client.ui.areMsgsScrolledToBottom(50);$("#archives_return").find(".cancel_archives").toggleClass("hidden",!!scrolled_almost_to_bottom&&_all_loaded_bottom);if(TS.client.archives.msgs_are_auto_scrolling)return;TS.client.ui.checkInlineImgsAndIframes("archives");TS.client.archives.maybeLoadScrollBackHistory()};var _updateDateDisplayed=function(){var $msgs=TS.client.archives.$scroller.find(".message");var dates=[];if($msgs.length){dates.push(TS.utility.date.toCalendarDate($msgs.eq(0).data("ts")));if($msgs.length>1){var date_2=TS.utility.date.toCalendarDate($msgs.eq($msgs.length-1).data("ts"));if(date_2!=dates[0])dates.push(date_2)}$("#archives_return_date").text(dates.join(" - "))}else{}};var _scrollToMsgOrOpenConversation=function(ts){if(TS.boot_data.feature_message_replies&&TS.client.archives.current_model_ob){var model_ob=TS.client.archives.current_model_ob;var msg=TS.utility.msgs.getMsg(ts,model_ob._archive_msgs);if(msg&&TS.utility.msgs.isMsgReply(msg)){TS.ui.replies.openConversation(model_ob,msg.thread_ts,msg.ts);return}}TS.client.ui.scrollMsgsSoMsgIsInView(ts,false,true)};var _channelJoined=function(channel){if(!TS.model.archive_view_is_showing)return;if(channel.id!=TS.client.archives.current_model_ob.id)return;TS.client.archives.not_member=false;TS.client.archives.cancel();TS.client.ui.instaScrollMsgsToBottom(false)};var _groupUnArchived=function(group){if(!TS.model.archive_view_is_showing)return;if(group.id!=TS.client.archives.current_model_ob.id)return;TS.client.archives.not_member=false;TS.client.archives.cancel();TS.client.ui.instaScrollMsgsToBottom(false)};var _groupArchived=function(group){if(!TS.model.archive_view_is_showing)return;if(group.id!=TS.client.archives.current_model_ob.id)return};var _channelUnArchived=function(channel){if(!TS.model.archive_view_is_showing)return;if(channel.id!=TS.client.archives.current_model_ob.id)return;_adjustForArchivesDisplay()};var _channelArchived=function(channel){if(!TS.model.archive_view_is_showing)return;if(channel.id!=TS.client.archives.current_model_ob.id)return;_adjustForArchivesDisplay()};var _msgSent=function(model_ob,rsp_id){if(!TS.model.archive_view_is_showing)return;if(TS.client.archives.not_member)return;if(model_ob.id!=TS.client.archives.current_model_ob.id)return;TS.client.archives.cancel()};var _messageReceived=function(model_ob,msg){if(!TS.model.archive_view_is_showing)return;if(!msg)return;if(model_ob.id!=TS.client.archives.current_model_ob.id)return};var _messageRemoved=function(model_ob,msg){if(!TS.model.archive_view_is_showing)return;if(!msg)return;if(model_ob.id!=TS.client.archives.current_model_ob.id)return;var $msg_div=TS.client.msg_pane.getDivForArchiveMsg(msg.ts);if(!$msg_div.length)return;_displayMsgs(model_ob,model_ob._archive_msgs)};var _messageChanged=function(model_ob,msg){if(!TS.model.archive_view_is_showing)return;if(!msg)return;if(model_ob.id!=TS.client.archives.current_model_ob.id)return;var $msg_div=TS.client.msg_pane.getDivForArchiveMsg(msg.ts);if(!$msg_div.length)return;_displayMsgs(model_ob,model_ob._archive_msgs)}})();(function(){"use strict";TS.registerModule("client.channel_page",{onStart:function(){_member_presence_list=TS.presence_manager.createList();TS.client.login_sig.add(_loggedIn);TS.client.flexpane_display_switched_sig.add(_flexpaneDisplaySwitched);TS.ms.connected_sig.add(_socketConnected);TS.channels.data_updated_sig.add(_channelDataUpdated);TS.channels.switched_sig.add(_modelObSwitched);TS.channels.purpose_changed_sig.add(_purposeChanged);TS.channels.member_left_sig.add(_channelMemberRemoved);TS.channels.member_joined_sig.add(_channelMemberAdded);TS.channels.renamed_sig.add(_nameChanged);TS.channels.left_sig.add(_leftChannelOrGroup);TS.channels.joined_sig.add(_channelJoined);TS.channels.topic_changed_sig.add(_topicChanged);TS.channels.converted_to_shared_sig.add(_convertedToShared);TS.channels.shared_teams_updated_sig.add(_sharedTeamsUpdated);TS.groups.switched_sig.add(_modelObSwitched);TS.groups.purpose_changed_sig.add(_purposeChanged);TS.groups.member_left_sig.add(_groupMemberRemoved);TS.groups.member_joined_sig.add(_groupMemberAdded);TS.groups.renamed_sig.add(_nameChanged);TS.groups.left_sig.add(_leftChannelOrGroup);TS.groups.topic_changed_sig.add(_topicChanged);TS.groups.converted_to_shared_sig.add(_convertedToShared);TS.groups.shared_teams_updated_sig.add(_sharedTeamsUpdated);TS.ims.switched_sig.add(_modelObSwitched);TS.mpims.switched_sig.add(_modelObSwitched);TS.members.presence_changed_sig.add(_memberChanged);TS.members.changed_name_sig.add(_memberChanged);TS.members.changed_profile_sig.add(_memberChanged);TS.members.changed_account_type_sig.add(_memberChanged);TS.members.changed_deleted_sig.add(_memberChangedDeleted);TS.prefs.display_real_names_override_changed_sig.add(_displayNamePrefChanged);TS.prefs.team_display_real_names_changed_sig.add(_displayNamePrefChanged);if(TS.boot_data.feature_name_tagging_client){TS.prefs.display_preferred_names_changed_sig.add(_displayNamePrefChanged)}TS.prefs.push_changed_sig.add(_notifPrefChanged);TS.prefs.dtop_notif_changed_sig.add(_notifPrefChanged);TS.prefs.team_perms_pref_changed_sig.add(_notifPrefChanged);TS.prefs.muted_channels_changed_sig.add(_notifPrefChanged);TS.ui.growls.permission_changed_sig.add(_notifPrefChanged);TS.files.channel_files_fetched_sig.add(_channelFilesFetched);TS.files.team_file_added_sig.add(_fileChanged);TS.files.team_file_deleted_sig.add(_fileChanged);TS.files.team_file_changed_sig.add(_fileChanged);TS.files.team_file_comment_edited_sig.add(_commentChanged);TS.pins.pinned_status_changed_sig.add(_pinnedStatusChanged);TS.pins.pinned_message_changed_sig.add(_pinnedStatusChanged);TS.pins.pinned_message_deleted_sig.add(_pinnedStatusChanged);TS.pins.pins_fetched_sig.add(_pinnedStatusChanged);if(TS.boot_data.feature_pin_update){TS.channels.marked_sig.add(_markUnreadPinItems);TS.groups.marked_sig.add(_markUnreadPinItems);TS.mpims.marked_sig.add(_markUnreadPinItems);TS.ims.marked_sig.add(_markUnreadPinItems)}TS.client.channel_page.initUI();_initEvents();TS.view.resize_sig.add(_resetPinnedItemsFade)},initUI:function(){_state=TS.storage.fetchChannelPageState();if(!_state.expanded_sections){_state.expanded_sections={about:false,pinned_items:false,members:false,shared_files:false,notif_prefs:false}}_expanded_sections=_state.expanded_sections;_$container=$("#details_tab");_$container.append(TS.templates.channel_page_empty_state({state:_state}));_$scroller=_$container.find("#channel_page_scroller");_$conversation_details=_$container.find(".conversation_details");_$details=_$container.find(".channel_page_about .section_content.channel_purpose");_$pinned_items=_$container.find(".channel_page_pinned_items .section_content.pinned_items");_$member_tabs=_$container.find(".channel_page_member_tabs");_$member_lists=_$container.find(".channel_page_member_lists");_$shared_files=_$container.find(".channel_page_shared_files .section_content");_$notif_prefs=_$container.find(".channel_page_notif_prefs .section_content");_$notif_prefs_mute_state=_$container.find(".channel_page_notif_prefs .channel_page_notif_prefs_mute_state")},showAboutSection:function(){if(!_expanded_sections.about)_toggleSection("about");_$scroller.find(".channel_page_about").scrollintoview({offset:"top",px_offset:50})},showPinsSection:function(){if(!_expanded_sections.pinned_items)_toggleSection("pinned_items");_$scroller.find(".channel_page_pinned_items").scrollintoview({offset:"top",px_offset:50})},showMembersSection:function(){if(_expanded_sections.pinned_items)_toggleSection("pinned_items");if(!_expanded_sections.members)_toggleSection("members");_$scroller.find(".channel_page_members").scrollintoview({offset:"top",px_offset:50})},showMemberSectionAndHighlight:function(){TS.client.ui.flex.openFlexTab("details");TS.client.channel_page.showMembersSection();$("#channel_page_scroller .channel_page_members").highlight(null,"channel_page_members_highlighter")},showFilesSection:function(){if(!_expanded_sections.shared_files)_toggleSection("shared_files");_$scroller.find(".channel_page_shared_files").scrollintoview({offset:"top",px_offset_:50})},showNotifPrefsSection:function(){if(!_expanded_sections.notif_prefs)_toggleSection("notif_prefs");_$scroller.find(".channel_page_notif_prefs").scrollintoview({offset:"top",px_offset_:50})},pinnedItemHtml:function(pinned_item,model_ob){try{var template_args={item:pinned_item,model_ob:model_ob,can_remove:TS.pins.canUserPinHere(model_ob)};if(pinned_item.type==="message"){var msg=pinned_item.message;var member=TS.members.getMemberById(msg.user);var is_bot=TS.utility.msgs.shouldHaveBotLabel(msg,member);var app_id;var bot_id;if(TS.boot_data.feature_app_cards_and_profs_frontend&&is_bot){var bot_info=TS.bots.getBotInfoByMsg(msg);if(bot_info){app_id=bot_info.app_id;bot_id=bot_info.bot_id}}template_args.is_message=true;template_args.member=member;template_args.permalink=TS.utility.msgs.constructMsgPermalink(model_ob,pinned_item.message.ts);template_args.is_bot=is_bot;template_args.is_reply=TS.boot_data.feature_message_replies&&msg.thread_ts&&msg.thread_ts!=msg.ts;template_args.app_id=app_id;template_args.bot_id=bot_id}else if(pinned_item.type==="file"){template_args.is_file=true}else if(pinned_item.type==="file_comment"){template_args.is_comment=true}return TS.templates.channel_page_pinned_item(template_args)}catch(err){TS.info("Problem in pinnedItemHtml:"+err);return""}},clearUnreadPinState:function(){$(".pinned_item").removeClass("unread_pin")},highlightPinnedItemForRemoval:function(pinned_item){var $item=_findItem(pinned_item);$item.addClass("delete_mode")},unHighlightPinnedItemForRemoval:function(pinned_item){var $item=_findItem(pinned_item);$item.removeClass("delete_mode")},test:function(){return{initEvents:_initEvents,rebuildChannelPage:_rebuildChannelPage,rebuildChannelDetails:_rebuildChannelDetails,rebuildPinnedItems:_rebuildPinnedItems,rebuildMembersTabs:_rebuildMembersTabs,rebuildMemberLists:_rebuildMemberLists,rebuildMember:_rebuildMember}}});var _$container;var _$scroller;var _$details;var _$pinned_items;var _$member_tabs;var _$member_lists;var _$conversation_details;var _$shared_files;var _$notif_prefs;var _$notif_prefs_mute_state;var _logged_in=false;var _previously_connected=false;var _is_channel_page_visible=false;var _lazy_load;var _state;var _expanded_sections;var _members=[];var _current_files=[];var _channels_with_files_loaded={};var _channels_currently_loading_files={};var _max_num_files_to_preview=10;var _member_presence_list;var _cached_scroll_top;var SEE_ALL_MEMBERS_DIALOG_THRESHOLD=100;var _initEvents=function(){_$container.on("click",".invite_link",function(){var model_ob=TS.shared.getActiveModelOb();TS.ui.channel_invite_modal.startInviteToChannelModal(model_ob.id)});_$container.on("click",".find_files_link",function(){var model_ob=TS.shared.getActiveModelOb();TS.search.setInputVal("in:"+(model_ob.is_channel?"#":"")+model_ob.name);TS.search.setFilter("files");TS.search.submitSearch()});_$container.on("click",".leave_link",function(){var model_ob=TS.shared.getActiveModelOb();if(model_ob.is_channel){TS.channels.leave(model_ob.id)}else if(model_ob.is_group){TS.groups.leave(model_ob.id)}});_$container.on("click","a[data-member-id]",function(e){e.preventDefault();var id=$(this).data("member-id");TS.menu.member.startWithMember(e,id)});_$container.on("click",".section_header",function(e){var $section=$(e.target).closest("[data-section-name]");var section_name=$section.data("section-name");if(!section_name)return;_toggleSection(section_name)});_$container.on("click keydown",".edit_purpose, .purpose_cancel",function(e){if(e.type=="click"){_togglePurposeInput()}else{if(e.which==TS.utility.keymap.enter)_togglePurposeInput()}});_$container.on("click keydown",".purpose_done",function(e){if(e.type=="click"){_setPurpose()}else{if(e.which==TS.utility.keymap.enter)_setPurpose();if(e.which==TS.utility.keymap.tab){e.preventDefault();e.stopImmediatePropagation();_$details.find(".purpose_cancel").focus()}}});_$container.on("keydown","#channel_purpose_input",function(e){if(e.which==TS.utility.keymap.enter&&!e.shiftKey&&!e.altKey){_setPurpose()}if(e.which==TS.utility.keymap.esc){_togglePurposeInput()}});_$container.on("focus","#channel_purpose_input",function(){_$details.find("#channel_purpose_input").autosize()});_$container.on("click",".pinned_item .remove_pin",function(e){var model_ob=TS.shared.getActiveModelOb();var $item=$(this).closest(".pinned_item");var ts=$item.data("ts");var c_id=$item.data("comment-id");var f_id=$item.data("file-id");var type=$item.data("type");if(type==="message"){TS.pins.unPinMessage(ts.toString(),model_ob)}else if(type==="file"){TS.pins.unPinFile(f_id,model_ob)}else if(type==="file_comment"){TS.pins.unPinFileComment(c_id,f_id,model_ob)}e.preventDefault()});_$container.on("click",".pinned_item .pin_metadata",function(e){if(TS.client.archives.maybeHandleArchiveLink($(this))){e.preventDefault();return}});_$container.on("click",".pinned_item",function(e){if(e.isDefaultPrevented()||$(e.target).is("a"))return;e.preventDefault();var type=$(this).data("type");var model_ob=TS.shared.getActiveModelOb();var ts=$(this).data("ts");var file_id=$(this).data("file-id");var thread_ts=$(this).data("thread-ts");if(type==="message"){if(TS.boot_data.feature_message_replies&&thread_ts&&thread_ts!=ts){TS.ui.replies.openConversation(model_ob,thread_ts,ts)}else{TS.client.ui.tryToJump(model_ob.id,ts.toString())}}else if(type==="file"||type==="file_comment"){var origin="channel_page";if(model_ob.is_im||model_ob.is_mpim){origin="im_page"}else if(model_ob.is_group){origin="group_page"}TS.client.ui.files.previewFile(file_id,origin)}});_$container.on("click",".view_all_files_link",function(){TS.clog.track("SEARCH_OPEN",{open_method:"files"});var model_ob=TS.shared.getActiveModelOb();TS.search.setInputVal("in:"+(model_ob.is_channel?"#":"")+model_ob.name);TS.search.setFilter("files");TS.search.submitSearch()});_$container.on("click",".edit_notif_prefs_btn",function(){var model_ob=TS.shared.getActiveModelOb();TS.ui.channel_prefs_dialog.start(model_ob.id)});_$container.on("click",".add_someone",function(e){e.preventDefault();var model_ob=TS.shared.getActiveModelOb();if(!model_ob.is_mpim)return;TS.ui.im_browser.startWithMpim(model_ob)});_$container.on("click",".creator_link",function(e){var model_ob=TS.shared.getActiveModelOb();var min_ts=model_ob.created;var last_visible=model_ob.msgs[model_ob.msgs.length-1];var last_ts=Math.floor(last_visible.ts);if(last_ts<=min_ts){var msg=TS.utility.msgs.getDisplayedMsgAfterTS(min_ts,model_ob.msgs);if(msg){TS.client.ui.scrollMsgsSoMsgIsInView(msg.ts,false,true)}}else{_scrollToHistoryMsg(min_ts,model_ob)}});_$scroller.on("scroll",_.debounce(function(){if(!_isChannelPageVisible())return;_cached_scroll_top=_$scroller.scrollTop()},100))};var _scrollToHistoryMsg=function(min_ts,model_ob){var api_method=TS.shared.getHistoryApiMethodForModelOb(model_ob);TS.api.call(api_method,{channel:model_ob.id,oldest:min_ts,count:1,inclusive:1}).then(function(response){var msg_id;if(response.data.messages.length<1){msg_id=model_ob._archive_msgs[0].ts;TS.client.archives.start(msg_id)}else{msg_id=response.data.messages[0].ts;if(TS.utility.msgs.getMsg(msg_id,model_ob.msgs)){TS.client.ui.scrollMsgsSoMsgIsInView(msg_id,false,true)}else{TS.client.archives.start(msg_id)}}return true}).catch(function(err){return TS.warn("Couldn’t find creation message at "+min_ts+" in channel: "+model_ob.id)})};var _toggleSection=function(section_name){var model_ob=TS.shared.getActiveModelOb();var $section=_$scroller.find('.channel_page_section[data-section-name="'+section_name+'"]');if($section.length===0)return;if(_expanded_sections[section_name]){_expanded_sections[section_name]=false;if(section_name==="pinned_items")_cleanPinnedItems();if(section_name==="members")_cleanMemberLists();if(section_name==="notif_prefs")_cleanNotifPrefs();$section.removeClass("expanded")}else{_expanded_sections[section_name]=true;if(section_name==="pinned_items")_rebuildPinnedItems(model_ob);if(section_name==="members")_rebuildMemberLists(model_ob);if(section_name==="shared_files")_rebuildSharedFiles(model_ob);if(section_name==="notif_prefs")_rebuildNotifPrefs(model_ob);$section.addClass("expanded")}TS.storage.storeChannelPageState(_state);TS.ui.utility.updateClosestMonkeyScroller(_$scroller);_triggerInitialLazyLoad()};var _togglePurposeInput=function(){_$details.find(".edit_purpose_label, #channel_purpose_input, .purpose_done, .purpose_cancel, .purpose_label, .channel_purpose_section .channel_purpose_text").toggleClass("hidden");if(_$details.find("#channel_purpose_input").hasClass("hidden")){_$details.find("#channel_purpose_input, .purpose_done, .purpose_cancel").blur()}else{_$details.find("#channel_purpose_input").select()}};var _setPurpose=function(){var model_ob=TS.shared.getActiveModelOb();var input=_$details.find("#channel_purpose_input");var new_val=$.trim(input.val());if(model_ob.purpose.value===new_val){_togglePurposeInput();return}if(model_ob.is_group){TS.groups.setPurpose(model_ob.id,new_val)}else if(model_ob.is_channel){TS.channels.setPurpose(model_ob.id,new_val)}_togglePurposeInput()};var _isFileInChannel=function(file){var model_ob=TS.shared.getActiveModelOb();var array_to_search=file.channels;if(model_ob.is_group){array_to_search=file.groups}else if(model_ob.is_im){array_to_search=file.ims}return array_to_search.indexOf(model_ob.id)!==-1};var _loggedIn=function(){_logged_in=true};var _flexpaneDisplaySwitched=function(prev_flex_name){var flex_name=TS.model.ui_state.flex_name;if(!flex_name||prev_flex_name==="details"&&flex_name!=="details"){_cleanChannelPage();_is_channel_page_visible=false;return}if(!_is_channel_page_visible&&flex_name==="details"){_is_channel_page_visible=true;_rebuildChannelPage()}};var _socketConnected=function(){if(_previously_connected){_channels_with_files_loaded={};if(!_isChannelPageVisible())return;_rebuildChannelPage()}else{_previously_connected=true}};var _modelObSwitched=function(){if(!_logged_in)return;var model_ob=TS.shared.getActiveModelOb();if(!model_ob)return;_cached_scroll_top=null;if(TS.model.ui_state.flex_name==="details"){_rebuildChannelPage()}};var _channelDataUpdated=function(changed_model_ob){if(!_isChangeForThisChannelPage(changed_model_ob))return;if(TS.model.ui_state.flex_name==="details"){_rebuildChannelPage()}};var _sharedTeamsUpdated=function(changed_model_ob){if(!_isChannelPageVisible())return;if(!_isChangeForThisChannelPage(changed_model_ob))return;var model_ob=TS.shared.getActiveModelOb();_rebuildChannelDetails(model_ob)};var _purposeChanged=function(changed_model_ob){if(!_isChannelPageVisible())return;if(!_isChangeForThisChannelPage(changed_model_ob))return;var model_ob=TS.shared.getActiveModelOb();_rebuildChannelDetails(model_ob)};var _topicChanged=function(changed_model_ob){if(!_isChannelPageVisible())return;if(!_isChangeForThisChannelPage(changed_model_ob))return;var model_ob=TS.shared.getActiveModelOb();_rebuildChannelDetails(model_ob)};var _convertedToShared=function(changed_model_ob){if(!_isChannelPageVisible())return;if(!_isChangeForThisChannelPage(changed_model_ob))return;var model_ob=TS.shared.getActiveModelOb();_rebuildChannelDetails(model_ob)};var _notifPrefChanged=function(changed_model_ob){if(!_isChannelPageVisible())return;var model_ob=TS.shared.getActiveModelOb();_rebuildNotifPrefs(model_ob)};var _nameChanged=function(changed_model_ob){if(!_isChannelPageVisible())return;if(!_isChangeForThisChannelPage(changed_model_ob))return;var model_ob=TS.shared.getActiveModelOb();_setTitle(model_ob);_rebuildChannelDetails(model_ob)};var _groupMemberAdded=function(changed_model_ob,member){if(!_isChannelPageVisible())return;if(!_isChangeForThisChannelPage(changed_model_ob))return;var model_ob=TS.shared.getActiveModelOb();_rebuildChannelDetails(model_ob);_rebuildMembersTabs(model_ob);if(_expanded_sections.members)_rebuildMember(member)};var _groupMemberRemoved=function(changed_model_ob,member){if(!_isChannelPageVisible())return;if(!_isChangeForThisChannelPage(changed_model_ob))return;var model_ob=TS.shared.getActiveModelOb();_rebuildChannelDetails(model_ob);_rebuildMembersTabs(model_ob);if(_expanded_sections.members)_removeMemberItem(member)};var _channelMemberAdded=function(changed_model_ob,member){if(!_isChannelPageVisible())return;if(!_isChangeForThisChannelPage(changed_model_ob))return;var model_ob=TS.shared.getActiveModelOb();_rebuildMembersTabs(model_ob);if(_expanded_sections.members)_rebuildMember(member)};var _channelMemberRemoved=function(changed_model_ob,member){if(!_isChannelPageVisible())return;if(!_isChangeForThisChannelPage(changed_model_ob))return;var model_ob=TS.shared.getActiveModelOb();_rebuildMembersTabs(model_ob);if(_expanded_sections.members)_removeMemberItem(member)};var _memberChanged=function(member){if(!TS.model.ms_connected)return;if(!member)return;if(!_isChannelPageVisible())return;var model_ob=TS.shared.getActiveModelOb();if(model_ob&&model_ob.members&&model_ob.members.indexOf(member.id)>-1){_rebuildMembersTabs(model_ob);if(_expanded_sections.members)_rebuildMember(member)}};var _memberChangedDeleted=function(member){if(!_isChannelPageVisible())return;var model_ob=TS.shared.getActiveModelOb();_rebuildMembersTabs(model_ob);if(_expanded_sections.members)_removeMemberItem(member)};var _displayNamePrefChanged=function(){if(!_isChannelPageVisible())return;var model_ob=TS.shared.getActiveModelOb();_rebuildMemberLists(model_ob)};var _channelFilesFetched=function(id){if(!_isChannelPageVisible())return;var model_ob=TS.shared.getActiveModelOb();if(!model_ob||!id||model_ob.id!==id)return;_rebuildSharedFiles(model_ob)};var _fileChanged=function(file){if(!_isChannelPageVisible())return;var model_ob=TS.shared.getActiveModelOb();if(!model_ob)return;if(file.pinned_to&&file.pinned_to.indexOf(model_ob.id)!==-1)_rebuildPinnedItems(model_ob);if(_isFileInChannel(file))_rebuildSharedFiles(model_ob)};var _commentChanged=function(file,comment){if(!_isChannelPageVisible())return;var model_ob=TS.shared.getActiveModelOb();if(!model_ob)return;if(comment.pinned_to&&comment.pinned_to.indexOf(model_ob.id)!==-1)_rebuildPinnedItems(model_ob)};var _pinnedStatusChanged=function(model_ob){if(!_isChannelPageVisible())return;if(!_isChangeForThisChannelPage(model_ob))return;_rebuildPinnedItems(model_ob)};var _leftChannelOrGroup=function(model_ob){delete _channels_with_files_loaded[model_ob.id];if(_isChannelPageVisible()&&TS.model.user.is_restricted){_rebuildChannelDetails(TS.shared.getActiveModelOb())}};var _channelJoined=function(model_ob){if(!_isChannelPageVisible())return;if(_isChangeForThisChannelPage(model_ob)){_rebuildChannelPage()}else if(TS.model.user.is_restricted){_rebuildChannelDetails(TS.shared.getActiveModelOb())}};var _isChannelPageVisible=function(){return _is_channel_page_visible};var _isChangeForThisChannelPage=function(changed_model_ob){var model_ob=TS.shared.getActiveModelOb();if(!model_ob||!changed_model_ob||model_ob.id!==changed_model_ob.id)return false;return true};var _rebuildChannelPage=function(){_cleanChannelPage();var model_ob=TS.shared.getActiveModelOb();if(model_ob.is_im||model_ob.is_mpim){if(model_ob.is_im){$("#details_tab").addClass("dm_info_pane")}else{$("#details_tab").removeClass("dm_info_pane")}if(model_ob.is_mpim){$("#details_tab").addClass("mpim_info_pane")}else{$("#details_tab").removeClass("mpim_info_pane")}_rebuildConversationDetails(model_ob)}else{$("#details_tab").removeClass("dm_info_pane mpim_info_pane")}_setTitle(model_ob);_rebuildChannelDetails(model_ob);_rebuildPinnedItems(model_ob);_rebuildMembersTabs(model_ob);_rebuildMemberLists(model_ob);_rebuildSharedFiles(model_ob);_rebuildNotifPrefs(model_ob);if(!TS.environment.supports_custom_scrollbar){var monkeyScroll=_$scroller.data("monkeyScroll");if(monkeyScroll){TS.ui.utility.updateClosestMonkeyScroller(_$scroller)}else{_$scroller.monkeyScroll()}}_triggerInitialLazyLoad();if(_cached_scroll_top){_$scroller.scrollTop(_cached_scroll_top)}};var _cleanChannelPage=function(){_detachLazyLoad();_cleanPinnedItems();_cleanMemberTabs();_cleanMemberLists();_cleanConversationDetails();_cleanSharedFiles();_cleanNotifPrefs()};var _setTitle=function(model_ob){var html;if(model_ob.is_channel||!model_ob.is_channel&&model_ob.is_group&&!model_ob.is_mpim){$("#channel_page_title").text("Channel Details");if(TS.boot_data.page_needs_enterprise&&model_ob.is_shared&&model_ob.is_channel){html='About <span class="channel_name"><ts-icon class="ts_icon_channel"></ts-icon><strong>'+TS.utility.htmlEntities(model_ob.name)+' <ts-icon class="ts_icon_org_shared_channel"></ts-icon></strong></span>'}else if(TS.boot_data.page_needs_enterprise&&model_ob.is_shared&&model_ob.is_group&&!model_ob.is_mpim){html='About <span class="channel_name"><ts-icon class="ts_icon_lock prefix"></ts-icon><strong>'+TS.utility.htmlEntities(model_ob.name)+' <ts-icon class="ts_icon_org_shared_channel"></ts-icon></strong></span>'}else if(model_ob.is_group&&!model_ob.is_mpim){html='About <span class="channel_name"><ts-icon class="ts_icon_lock prefix"></ts-icon><strong>'+TS.utility.htmlEntities(model_ob.name)+" </strong></span>"}else{html='About <span class="channel_name"><ts-icon class="ts_icon_channel"></ts-icon><strong>'+TS.utility.htmlEntities(model_ob.name)+"</strong></span>"}}else{html='<span class="overflow_ellipsis">About this conversation</span>'}$("#details_tab_header").html(html)};var _rebuildConversationDetails=function(model_ob){_cleanConversationDetails();if(model_ob.is_mpim)return;var member=TS.members.getMemberById(model_ob.user);_member_presence_list.add(member.id);_$conversation_details.html(TS.templates.channel_page_conversation_details({member:member}));TS.client.flex_pane.startLocalTimeInterval()};var _cleanConversationDetails=function(){_member_presence_list.clear();_$conversation_details.empty();TS.client.flex_pane.stopLocalTimeInterval()};var _rebuildChannelDetails=function(model_ob){if(model_ob.is_im||model_ob.is_mpim)return;var template_args={model_ob:model_ob,show_set_purpose:(model_ob.is_member||model_ob.is_group)&&!TS.model.user.is_ultra_restricted&&(!model_ob.is_general||TS.members.canUserPostInGeneral()),show_edit_purpose_or_topic:(model_ob.is_member||model_ob.is_group)&&!TS.model.user.is_ultra_restricted&&!TS.model.user.is_restricted&&(!model_ob.is_general||TS.members.canUserPostInGeneral())};if(TS.boot_data.page_needs_enterprise&&model_ob.is_channel&&model_ob.is_org_shared&&model_ob.is_global_shared){template_args.is_globally_shared=true;template_args.enterprise_org_name=TS.model.enterprise.name;template_args.enterprise_org_icon=TS.model.enterprise.icon}var user=TS.model.user;if(!user.is_ultra_restricted&&!model_ob.is_archived&&(model_ob.is_member||model_ob.is_group)){if(model_ob.is_channel){template_args.show_invite=TS.channels.makeMembersWithPreselectsForTemplate(TS.channels.getActiveMembersNotInThisChannelForInviting(model_ob.id)).length>0}else if(model_ob.is_group){template_args.show_invite=TS.channels.makeMembersWithPreselectsForTemplate(TS.groups.getActiveMembersNotInThisGroupForInviting(model_ob.id)).length>0}if(model_ob.is_channel){template_args.show_leave=!model_ob.is_general&&!user.is_restricted}else if(model_ob.is_group&&!model_ob.is_mpim){if(model_ob.active_members.length>1){if(TS.groups.canLeaveGroup(model_ob.id))template_args.show_leave=true}else{}}}var creator=TS.members.getMemberById(model_ob.creator);if(creator&&creator.is_self){template_args.creator_name="you"}else if(creator){if(TS.boot_data.feature_name_tagging_client){template_args.creator_name=TS.members.getMemberFullName(creator)}else{template_args.creator_name=TS.members.getMemberDisplayName(creator)}}else{template_args.creator_name="unknown"}var date_str=TS.utility.date.toCalendarDateOrNamedDay(model_ob.created);var on="";if($.trim(date_str.toLowerCase())=="yesterday"||$.trim(date_str.toLowerCase())=="today"){date_str=$.trim(date_str.toLowerCase())}else{on="on "}template_args.creation_date=on+date_str;_$details.html(TS.templates.channel_page_details(template_args)).removeClass("hidden")};var _rebuildNotifPrefs=function(model_ob){_cleanNotifPrefs();if(model_ob.is_im)return;var c_id=model_ob.id;var is_muted=TS.notifs.isCorGMuted(c_id);var desktop_notifs_enabled=TS.ui.growls.checkPermission();var notifications_impossible=desktop_notifs_enabled===false&&TS.ui.growls.no_notifications;var notifications_not_allowed=desktop_notifs_enabled===false&&TS.ui.growls.getPermissionLevel()=="denied";var notifications_not_yet_allowed=desktop_notifs_enabled===false&&TS.ui.growls.shouldShowPermissionButton();var desktop_setting=TS.notifs.getCalculatedCorGNotifySetting(c_id);var push_setting=TS.notifs.getCalculatedCorGPushNotifySetting(c_id);var desktop_everything=desktop_setting==="everything";var desktop_mentions=desktop_setting==="mentions";var desktop_nothing=desktop_setting==="nothing";var push_everything=push_setting==="everything";var push_mentions=push_setting==="mentions";var push_nothing=push_setting==="nothing";var template_args={model_ob:model_ob,
is_muted:is_muted,desktop_notifs_enabled:desktop_notifs_enabled,notifications_impossible:notifications_impossible,notifications_not_allowed:notifications_not_allowed,notifications_not_yet_allowed:notifications_not_yet_allowed,desktop_everything:desktop_everything,desktop_mentions:desktop_mentions,desktop_nothing:desktop_nothing,push_everything:push_everything,push_mentions:push_mentions,push_nothing:push_nothing};_$notif_prefs.html(TS.templates.channel_page_notif_prefs(template_args));_$notif_prefs_mute_state.html(TS.templates.channel_page_notif_prefs_mute_state({is_muted:is_muted}))};var _cleanNotifPrefs=function(){_$notif_prefs.empty()};var _rebuildPinnedItems=function(model_ob){_cleanPinnedItems();var pins=model_ob.pinned_items;var html="";var loading=false;if(!_arePinsLoadedForChannel(model_ob)){_loadPinsForChannel(model_ob);loading=true}if(pins&&pins.length>0){if(pins.length===1){$("#pinned_items_title").text("1 Pinned Item")}else{$("#pinned_items_title").text(pins.length+" Pinned Items")}}else{$("#pinned_items_title").text("Pinned Items")}if(!_expanded_sections.pinned_items)return;if(pins&&pins.length>0){pins.forEach(function(pinned_item){if(pinned_item.file&&pinned_item.file.is_deleted)return;_fixPinnedComment(pinned_item);html+=TS.client.channel_page.pinnedItemHtml(pinned_item,model_ob)})}else if(!loading){html=TS.templates.channel_page_empty_pinned_items({model_ob:model_ob})}html=TS.format.replaceHighlightMarkers(html);_$pinned_items.html(html);if(TS.boot_data.feature_pin_update)_markUnreadPinItems(model_ob);_resetPinnedItemsFade()};var _markUnreadPinItems=function(model_ob){if(!model_ob)return;TS.client.channel_page.clearUnreadPinState();var unread_pins=TS.pins.getUnreadPins(model_ob);if(_.isEmpty(unread_pins))return;_.forEach(unread_pins,function(unread_pin){var $pinned_item;if(unread_pin.type==="message"){var ts=unread_pin.message.ts;$pinned_item=$('.pinned_item*[data-ts="'+ts+'"]')}else if(unread_pin.type==="file"){var file_id=unread_pin.file.id;$pinned_item=$('.pinned_item*[data-type="file"]*[data-file-id="'+file_id+'"]')}else if(unread_pin.type==="file_comment"){var comment_id=unread_pin.comment.id;$pinned_item=$('.pinned_item*[data-comment-id="'+comment_id+'"]')}if($pinned_item.length>0)$pinned_item.addClass("unread_pin")})};var _resetPinnedItemsFade=function(){TS.utility.rAF(function(){var $pins=_$pinned_items.find(".pinned_item");$pins.each(function(){var $pin=$(this);if($pin.data("type")!=="message")return;var $pin_message=$pin.find(".pinned_message_text");var $pin_fade=$pin.find(".pin_truncate_fade");if($pin_message[0].scrollHeight>$pin_message[0].clientHeight+3){$pin_fade.removeClass("hidden")}else{$pin_fade.addClass("hidden")}});$pins.find(".pinned_message_text").addClass("hide_scroll")})};var _cleanPinnedItems=function(){_$pinned_items.empty()};var _rebuildMembersTabs=function(model_ob){if(model_ob.is_im)return;_cleanMemberTabs();var template_args={model_ob:model_ob};var member_count=0;var online_count=0;var restricted_count=0;var member;for(var i=0;i<model_ob.members.length;i++){member=TS.members.getMemberById(model_ob.members[i]);if(member&&!member.deleted){member_count++;if(member.presence==="active")online_count++;if(member.is_restricted)restricted_count++}}template_args.member_count=member_count;template_args.online_count=online_count;template_args.restricted_count=restricted_count;template_args.show_restricted_members=restricted_count>0;if(TS.lazyLoadMembersAndBots()&&!TS.members.haveAllMembersForModelOb(model_ob)){template_args.loading_members=true}_$member_tabs.html(TS.templates.channel_page_member_tabs(template_args))};var _cleanMemberTabs=function(){_$member_tabs.empty()};var _rebuildMemberLists=function(model_ob){if(model_ob.is_im)return;_cleanMemberLists();if(TS.lazyLoadMembersAndBots()&&!TS.members.haveAllMembersForModelOb(model_ob)){TS.log(1989,"Flannel: fetching missing members for channel "+model_ob.name);_$member_lists.addClass("loading").html(TS.templates.infinite_spinner({color:"white",size:"medium"}));TS.flannel.fetchAndUpsertAllMembersForModelOb(model_ob).then(function(){TS.log(1989,"Flannel: finished fetching missing members for channel "+model_ob.name+"; rebuilding channel page");_rebuildMemberLists(model_ob);_rebuildMembersTabs(model_ob)}).catch(function(err){TS.log(1989,"Flannel error: failed to fetch all members for channel "+model_ob.name);TS.logError(err,"failed to fetch all members for channel "+model_ob.name,"Flannel error");_$member_lists.removeClass("loading");_$member_lists.html('<div class="align_center subtle_silver">Oops, failed to fetch users. <a href="#">Try again</a></div>');_$member_lists.find("a").click(function(e){e.preventDefault();_rebuildMemberLists(model_ob)})});return}if(!_expanded_sections.members)return;var template_args={model_ob:model_ob};var members=[];var member;for(var i=0;i<model_ob.members.length;i++){member=TS.members.getMemberById(model_ob.members[i]);if(member&&!member.deleted){members.push(member)}}members.sort(TS.members.memberSorterByActiveWithBotsLast);_members=members;var MAX_SIDEBAR_MEMBERS_COUNT=10;if(members.length>SEE_ALL_MEMBERS_DIALOG_THRESHOLD){template_args.members=members.slice(0,MAX_SIDEBAR_MEMBERS_COUNT);template_args.show_more_members_link=true;template_args.total_member_count=members.length}else{template_args.members=members}_member_presence_list.clear();_member_presence_list.add(_.map(template_args.members,"id"));_$member_lists.html(TS.templates.channel_page_member_lists(template_args));_$member_lists.find("#see_all_members").on("click",function(e){e.preventDefault();TS.client.channel_page.members_dialog.show(model_ob,members)});_resetLazyLoad()};var _removeMemberItem=function(member){var $row=$("#channel_page_all_members #"+_memberRowId(member));$row.remove();var i;for(i=0;i<_members.length;i++){if(member.id===_members[i].id)break}if(i<_members.length){_members.splice(i,1);_rebuildMembersDialog()}if(_lazy_load&&_lazy_load.detachSome)_lazy_load.detachSome($row.find(".lazy"));_triggerInitialLazyLoad()};var _addMemberItem=function(member){var i;for(i=0;i<_members.length;i++){var compare=TS.members.memberSorterByActiveWithBotsLast(member,_members[i]);if(compare<=0)break}var member_after=_members[i];var $row=TS.templates.channel_page_member_row({member:member,lazy:false});if(member_after){var $after=$("#channel_page_all_members #"+_memberRowId(member_after));$after.before($row)}else{$("#channel_page_all_members").append($row)}_members.splice(i,0,member);_rebuildMembersDialog()};var _rebuildMembersDialog=function(){TS.client.channel_page.members_dialog.updateMembers(_members)};var _rebuildMember=function(member){_removeMemberItem(member);_addMemberItem(member)};var _memberRowId=function(member){return"channel_page_member_"+member.id};var _cleanMemberLists=function(){_member_presence_list.clear();_detachLazyLoad();_$member_lists.empty();_members=[];if(TS.lazyLoadMembersAndBots()){_$member_lists.removeClass("loading")}};var _rebuildSharedFiles=function(model_ob){_cleanSharedFiles();var html="";var file;if(!_areFilesLoadedForChannel(model_ob)){_loadFilesForChannel(model_ob)}if(!_expanded_sections.shared_files)return;for(var i=0;i<TS.model.files.length;i++){file=TS.model.files[i];if(file.is_deleted)continue;if(_isFileInChannel(file)){if(_current_files.length<_max_num_files_to_preview){_current_files.push(file);html+=TS.templates.builders.fileHTML(file)}}}if(_current_files.length>=_max_num_files_to_preview){if(model_ob.is_im){var member=TS.members.getMemberById(model_ob.user);html+=TS.templates.channel_page_view_all_files_link({model_ob:model_ob,member:member})}else{html+=TS.templates.channel_page_view_all_files_link({model_ob:model_ob})}}if(html){_$shared_files.html(html)}else{_$shared_files.html(TS.templates.channel_page_empty_shared_files({model_ob:model_ob}))}_resetLazyLoad()};var _cleanSharedFiles=function(){_current_files=[];_$shared_files.empty()};var _resetLazyLoad=function(){_detachLazyLoad();_lazy_load=_$scroller.find(".lazy").lazyload({container:_$scroller});_triggerInitialLazyLoad()};var _detachLazyLoad=function(){if(_lazy_load&&_lazy_load.detachEvents){_lazy_load.detachEvents();_lazy_load=null}};var _initialLazyRAF;var _triggerInitialLazyLoad=function(){TS.utility.cancelRAF(_initialLazyRAF);_initialLazyRAF=TS.utility.rAF(function(){_$scroller.trigger("resize-immediate")})};var _findItem=function(pinned_item){var $item;if(pinned_item.type==="message"){$item=_$pinned_items.find('.pinned_item[data-type="message"][data-ts="'+pinned_item.message.ts+'"]')}else if(pinned_item.type==="file"){$item=_$pinned_items.find('.pinned_item[data-type="file"][data-file-id="'+pinned_item.file.id+'"]')}else if(pinned_item.type==="file_comment"){$item=_$pinned_items.find('.pinned_item[data-type="file_comment"][data-comment-id="'+pinned_item.comment.id+'"]')}return $item};var _fixPinnedComment=function(pinned_item){if(pinned_item.type!=="file_comment")return;var comment=TS.files.getFileCommentById(pinned_item.file,pinned_item.comment.id);pinned_item.comment=comment};var _arePinsLoadedForChannel=function(model_ob){if(false===model_ob.has_pins)return true;return TS.pins.havePinsBeenFetched(model_ob)};var _loadPinsForChannel=function(model_ob){if(TS.pins.arePinsCurrentlyBeingFetched(model_ob))return;TS.pins.fetchPins(model_ob)};var _areFilesLoadedForChannel=function(model_ob){return!!_channels_with_files_loaded[model_ob.id]};var _loadFilesForChannel=function(model_ob){if(_channels_currently_loading_files[model_ob.id])return;_channels_currently_loading_files[model_ob.id]=true;TS.files.fetchChannelFiles(model_ob.id,function(ok,data,args){delete _channels_currently_loading_files[model_ob.id];if(!ok)return;if(!model_ob.is_channel||model_ob.is_member)_channels_with_files_loaded[model_ob.id]=true},_max_num_files_to_preview)}})();(function(){"use strict";TS.registerModule("client.channel_page.members_dialog",{show:_showMembersDialog,updateMembers:_updateMembersInDialog,test:function(){var test_ob={updateMembersInDialog:_updateMembersInDialog};Object.defineProperty(test_ob,"filterMembersInDialog",{get:function(){return _filterMembersInDialog},set:function(v){_filterMembersInDialog=v}});Object.defineProperty(test_ob,"getFilter",{get:function(){return _getFilter},set:function(v){_getFilter=v}});Object.defineProperty(test_ob,"members",{get:function(){return _members},set:function(v){_members=v}});return test_ob}});var _current_filter;var _filtered_members;var _members;var DIALOG_CLASS="all_members_dialog";function _initDialogUI(){var $list_container=TS.generic_dialog.div.find("#all_members_container");var $filter_input=TS.generic_dialog.div.find("#all_members_filter input");$filter_input.focus();var generic_item_html=TS.templates.channel_page_member_row({member:TS.model.user,lazy:false});var $generic_item=$(generic_item_html);$generic_item.appendTo(document.body);var approx_item_height=$generic_item.height();$generic_item.remove();$list_container.longListView({items:[],scrollable:$list_container,approx_item_height:approx_item_height,makeElement:function(data){return $('<div class="list_item_container">')},renderItem:function($el,member,data){var html=TS.templates.channel_page_member_row({member:member,lazy:false});$el.html(html)}}).monkeyScroll();TS.utility.rAF(function(){$list_container.longListView("setItems",_members)});$filter_input.on("keydown",function(e){if(e.which==TS.utility.keymap.esc){TS.generic_dialog.cancel()}}).on("change keyup cut paste",function(e){var filter=_getFilter();_filterMembersInDialog(filter)});TS.menu.member.member_item_click_sig.addOnce(_memberMenuItemClicked)}var _isShowing=function(){if(!TS.generic_dialog.is_showing)return false;return TS.generic_dialog.current_setting.dialog_class==DIALOG_CLASS};var _memberMenuItemClicked=function(){TS.generic_dialog.cancel()};function _showMembersDialog(model_ob,members){var body_html=TS.templates.channel_page_all_members_dialog();var title=TS.utility.numberWithCommas(members.length)+" members in "+TS.shared.getDisplayNameForModelOb(model_ob);_members=members;TS.generic_dialog.start({dialog_class:DIALOG_CLASS,title:title,body:body_html,cancel_button_text:"Close",hide_footer:true,show_cancel_button:true,show_go_button:false,backdrop_click_to_dismiss:true,onShow:_initDialogUI,onEnd:function(){TS.generic_dialog.div.remove();TS.generic_dialog.div=undefined;_current_filter=undefined;_filtered_members=undefined;_members=undefined;TS.menu.member.member_item_click_sig.remove(_memberMenuItemClicked)}})}function _updateMembersInDialog(members){if(!_isShowing())return;_members=members;var filter=_getFilter();var redo_filter=true;_filterMembersInDialog(filter,redo_filter)}function _getFilter(){var $filter_input=TS.generic_dialog.div.find("#all_members_filter input");return _.toString($filter_input.val()).toLowerCase().trim()}function _filterMembersInDialog(filter,redo_filter){if(redo_filter)_current_filter=undefined;if(filter&&filter===_current_filter)return;if(_filtered_members&&_current_filter&&filter&&_.includes(filter,_current_filter)){_filtered_members=TS.utility.members.filterMembersByQuery(_filtered_members,filter)}else{_filtered_members=TS.utility.members.filterMembersByQuery(_members,filter)}_current_filter=filter;var force_rebuild=true;var $list_container=TS.generic_dialog.div.find("#all_members_container");$list_container.longListView("setItems",_filtered_members,force_rebuild);$list_container.toggleClass("invisible",!_filtered_members.length);TS.generic_dialog.div.find("#all_members_no_matches").toggleClass("hidden",_filtered_members.length>0);TS.utility.rAF(function(){TS.ui.utility.updateClosestMonkeyScroller($list_container)})}})();(function(){"use strict";TS.registerModule("ui.channel_browser",{onStart:function(){TS.channels.list_fetched_sig.add(_channelsListFetched)},start:function(){if(TS.model.user.is_ultra_restricted)return;if(TS.client.ui.checkForEditing())return;if(TS.isPartiallyBooted()){TS.incremental_boot.userDidInteractWithUI();return}var measure_label="channel_browser_show";var start_mark_label="start_channel_browser_show";TS.metrics.mark(start_mark_label);var can_create=TS.permissions.members.canCreateChannels()||TS.members.canUserCreateGroups();var channel_count=TS.channels.getUnarchivedChannelsForUser().length;var group_count=TS.groups.getUnarchivedGroups().length;var title="Browse all "+(channel_count+group_count)+" channels";if(TS.model.user.is_restricted){title="Browse channels"}var html=TS.templates.channel_browser({can_create:can_create,title:title});TS.ui.fs_modal.start({body_template_html:html,onShow:_onShow,onEnd:_onEnd,modal_class:"fs_modal_internal_scroll"});TS.metrics.measureAndClear(measure_label,start_mark_label)},test:function(){return{onShow:_onShow,onEnd:_onEnd,channelsListFetched:_channelsListFetched,filterList:_filterList,sortChannels:_sortChannels}}});var _active=false;var _showing_list=false;var _member_channels=null;var _non_member_channels=null;var _filtered_channels=null;var _fetched_list;var _$channel_browser;var _$list_container;var _$filter;var _$sort_by;var _$footer;var _$new_channel_container;var _onShow=function(){_active=true;_$channel_browser=$("#channel_browser");_$list_container=_$channel_browser.find("#channel_list_container");_$filter=_$channel_browser.find("#channel_browser_filter");_$sort_by=_$channel_browser.find("#channel_browser_sort");_$new_channel_container=$("#new_channel_container");_addFooterLinks();if(TS.model.ui_state&&TS.model.ui_state.sort_channel_browser_by)_$sort_by.find('option[value="'+TS.model.ui_state.sort_channel_browser_by+'"]').prop("selected",true);_bindUI();if(_needToFetchList()){_fetched_list=false;TS.channels.fetchList()}else{_channelsListFetched()}};var _needToFetchList=function(){if(!_fetched_list)return true;for(var i=0,j=TS.model.channels.length;i<j;i++){if(!TS.model.channels[i].is_member&&TS.model.channels[i].num_members==undefined){return true}}return false};var _onEnd=function(){_active=false;_showing_list=false;_member_channels=null;_non_member_channels=null;_filtered_channels=null;TS.kb_nav.end();if(_$channel_browser)_$channel_browser.remove();_$channel_browser=null;_$list_container=null;_$filter=null;_$sort_by=null;if(_$new_channel_container)_$new_channel_container.remove();_$new_channel_container=null;_removeFooterLnks();TS.ui.new_channel_modal.end()};var _bindUI=function(){_$list_container.on("click",".channel_browser_row",function(e){_openChannel($(this),e)});_$filter.on("textchange",function(){if(!_active||!_showing_list)return;_filterList()}).on("keydown",function(e){if(e.which===TS.utility.keymap.esc)TS.ui.fs_modal.close()});_$sort_by.on("change",function(){if(!_active||!_showing_list)return;var sort_by=$(this).val();if(TS.model.ui_state){TS.model.ui_state.sort_channel_browser_by=sort_by;TS.storage.storeUIState(TS.model.ui_state)}_sortChannels(sort_by);_filterList()});_$footer.on("click",".about_channels",function(e){e.preventDefault();TS.ui.fs_modal.close();setTimeout(function(){if(TS.boot_data.feature_update_coachmarks_cta){TS.coachmark.start($.extend({},TS.coachmarks.coachmarks.channels,{ui_click:true}))}else{TS.coachmark.start(TS.coachmarks.coachmarks.channels)}},500)});_$channel_browser.on("click",".new_channel",function(e){_switchToNewChannel()});_$channel_browser.on("click",".clear_filter_icon",function(){_$filter.val("").trigger("textchange").focus()})};var _channelsListFetched=function(){_fetched_list=true;if(!_active||_showing_list)return;var channels=TS.channels.getUnarchivedChannelsForUser();var groups=TS.groups.getUnarchivedGroups();_member_channels=[];_non_member_channels=[];channels.forEach(function(c){if(c.is_member){_member_channels.push(c)}else{_non_member_channels.push(c)}});_member_channels=_member_channels.concat(groups);if(TS.model.ui_state&&TS.model.ui_state.sort_channel_browser_by){_sortChannels(TS.model.ui_state.sort_channel_browser_by)}else{_sortChannels(_$sort_by.val())}_filtered_channels=_concatWithDividers(_non_member_channels,_member_channels);_$list_container.empty();_startListView();_filterList();if(_filtered_channels.length===0)_showEmptyState();_.defer(function(){_$filter.focus()})};var _concatWithDividers=function(non_member_channels,member_channels){var channels=[];if(non_member_channels.length>0){channels.push({is_divider:true,name:"Channels you can join"});channels=channels.concat(non_member_channels)}if(member_channels.length>0){channels.push({is_divider:true,name:"Channels you belong to"});channels=channels.concat(member_channels)}return channels};var _startListView=function(){_$list_container.longListView({items:_filtered_channels,approx_item_height:60*TS.utility.getA11yFontSizeMultiplier(),preserve_dom_order:true,approx_divider_height:35,pin_dividers:true,makeElement:function(data){var $el=$(TS.templates.channel_browser_row());data.$icon=$el.find(".channel_browser_type_icon");data.$name=$el.find(".channel_browser_channel_name");data.$creator=$el.find(".channel_browser_created_by");data.$date=$el.find(".channel_browser_created_on");data.$purpose=$el.find(".channel_browser_channel_purpose");data.$member_count=$el.find(".channel_browser_member_count");data.$open=$el.find(".channel_browser_open");data.$preview=$el.find(".channel_browser_preview");data.$joined=$el.find(".channel_browser_joined");data.$shared_channel_icon=$el.find(".shared_channel_icon");return $el},makeDivider:function(data){return $("<div>").addClass("channel_browser_divider")},renderItem:function($el,item,data){if(TS.boot_data.page_needs_enterprise&&item.is_shared){data.$shared_channel_icon.removeClass("hidden")}else{data.$shared_channel_icon.addClass("hidden")}if(item.is_channel){data.$icon.removeClass("ts_icon_lock").addClass("ts_icon_channel_pane_hash")}else{data.$icon.removeClass("ts_icon_channel_pane_hash").addClass("ts_icon_lock")}data.$name.text(item.name);var creator=TS.members.getMemberById(item.creator);if(creator){data.$creator.removeClass("hidden");data.$creator.find(".channel_browser_creator_name").text(TS.members.getMemberDisplayName(creator))}else{data.$creator.addClass("hidden")}data.$date.text(TS.utility.date.toCalendarDate(item.created));var member_count=_numMembers(item);data.$member_count.text(member_count);if(item.purpose&&item.purpose.value){var purpose_html=TS.utility.formatTopicOrPurpose(item.purpose.value);purpose_html=purpose_html.replace(/<a .*?>(.*?)<\/a>/g,"$1");data.$purpose.removeClass("hidden").html(purpose_html)}else{data.$purpose.text("").addClass("hidden")}var is_member=item.is_member||item.is_group;if(is_member){data.$open.removeClass("hidden");data.$preview.addClass("hidden");data.$joined.removeClass("hidden")}else{data.$open.addClass("hidden");data.$preview.removeClass("hidden");data.$joined.addClass("hidden")}if(item.is_group){$el.removeClass("channel_link").removeAttr("data-channel-id");$el.addClass("group_link").attr("data-group-id",item.id)}else{$el.removeClass("group_link").removeAttr("data-group-id");$el.addClass("channel_link").attr("data-channel-id",item.id)}},renderDivider:function($el,item,data){$el.text(item.name)},calcItemHeight:function($el,item,data){return $el.outerHeight()}});_$list_container.monkeyScroll();_showing_list=true;TS.kb_nav.start(_$list_container.find(".list_items"),".channel_browser_row",_$list_container,{use_data_ordering:true,px_offset:35,scrollToStartImmediately:function(){_$list_container.longListView("scrollToTop",true)},scrollToEndImmediately:function(){_$list_container.longListView("scrollToEnd",true)}});TS.kb_nav.setAllowHighlightWithoutBlurringInput(true);TS.kb_nav.setSubmitItemHandler(function(e){_openChannel($(this),e)})};var _filterList=function(){var measure_label="channel_browser_search";var start_mark_label="start_channel_browser_search";TS.metrics.mark(start_mark_label);var query=$.trim(_$filter.val());if(query!==""){if(query.indexOf("#")!==-1){query=query.replace("#","","g");query=$.trim(query)}}if(query){_$filter.closest(".channel_browser_filter_container").addClass("active");var non_member_matches=_filterWorker(_non_member_channels,query);var member_matches=_filterWorker(_member_channels,query);_filtered_channels=_concatWithDividers(non_member_matches,member_matches)}else{_$filter.closest(".channel_browser_filter_container").removeClass("active");_filtered_channels=_concatWithDividers(_non_member_channels,_member_channels)}_$list_container.longListView("setItems",_filtered_channels);if(_filtered_channels.length===0){_showEmptyState(query)}else{_hideEmptyState()}_$list_container.scrollTop(0);TS.utility.rAF(function(){TS.ui.utility.updateClosestMonkeyScroller(_$list_container)});if(query){TS.kb_nav.highlightFirstItem()}else{TS.kb_nav.clearHighlightedItem()}TS.metrics.measureAndClear(measure_label,start_mark_label)};var _filterWorker=function(channels,query){query=TS.utility.regexpEscape(query);var match_regex=new RegExp(query,"i");var exact_match_index=-1;var filtered=channels.filter(function(item,i){if(item.name.toLowerCase()===query.toLowerCase()){exact_match_index=i;return false}else{return item.name.match(match_regex)}});if(exact_match_index!==-1){filtered.unshift(channels[exact_match_index])}return filtered};var _showEmptyState=function(query){var _$empty_state=$("#channel_browser_empty");var _$msg=_$empty_state.find(".channel_browser_empty_message");if(query){_$msg.html("No matches found for <strong>"+TS.utility.truncateAndEscape(query,50)+"</strong>")}else{_$msg.text("No channels")}_$empty_state.removeClass("hidden")};var _hideEmptyState=function(){var _$empty_state=$("#channel_browser_empty");_$empty_state.addClass("hidden")};var _sortChannels=function(sort_by){_sortWorker(_member_channels,sort_by);_sortWorker(_non_member_channels,sort_by)};var _sortWorker=function(channels,sort_by){var sorts=["name","creator","created","members_high","members_low"];var sort="name";if(sorts.indexOf(sort_by)!==-1)sort=sort_by;if(sort==="name"){channels.sort(function(a,b){return a._name_lc>b._name_lc?1:b._name_lc>a._name_lc?-1:0})}else if(sort==="creator"){channels.sort(function(a,b){var a_creator,b_creator;a_creator=TS.members.getMemberById(a.creator);b_creator=TS.members.getMemberById(b.creator);if(a_creator&&b_creator){return a_creator._name_lc>b_creator._name_lc?1:b_creator._name_lc>a_creator._name_lc?-1:0}else if(a_creator&&!b_creator){return-1}else if(!a_creator&&b_creator){return 1}else{return 0}})}else if(sort==="created"){channels.sort(function(a,b){return a.created<b.created?1:b.created<a.created?-1:0})}else if(sort==="members_high"){channels.sort(function(a,b){var num_a=_numMembers(a);var num_b=_numMembers(b);return num_a<num_b?1:num_b<num_a?-1:0})}else if(sort==="members_low"){channels.sort(function(a,b){var num_a=_numMembers(a);var num_b=_numMembers(b);return num_a>num_b?1:num_b>num_a?-1:0})}};var _numMembers=function(channel){return"num_members"in channel?channel.num_members:channel.active_members.length};var _addFooterLinks=function(){_$footer=$(TS.templates.channel_browser_footer()).appendTo("#fs_modal")};var _removeFooterLnks=function(){if(_$footer)_$footer.remove();_$footer=null};var _switchToNewChannel=function(){var prefill=$.trim(_$filter.val());TS.ui.new_channel_modal.startInContainer(_$new_channel_container,prefill);_$channel_browser.addClass("hidden");$("#fs_modal").removeClass("fs_modal_internal_scroll");_$new_channel_container.removeClass("no_opacity");_$footer.addClass("hidden");TS.ui.fs_modal.bindBackButton(_switchBackToChannelBrowser);TS.ui.fs_modal.showBackButton()};var _switchBackToChannelBrowser=function(){TS.ui.fs_modal.unbindBackButton();TS.ui.fs_modal.hideBackButton();_$new_channel_container.addClass("no_opacity");$("#fs_modal").addClass("fs_modal_internal_scroll");_$channel_browser.removeClass("hidden");_$footer.removeClass("hidden");TS.ui.new_channel_modal.end();_$filter.focus();_$list_container.longListView("resizeImmediately");TS.ui.utility.updateClosestMonkeyScroller(_$list_container)};var _openChannel=function($row,e){if($row.hasClass("channel_link")){var channel_id=$row.data("channel-id");TS.view.onChannelReferenceClick(e,channel_id)}else{var group_id=$row.data("group-id");TS.view.onGroupReferenceClick(e,group_id)}TS.ui.fs_modal.close()}})();(function(){"use strict";TS.registerModule("ui.im_browser",{onStart:function(){_member_presence_list=TS.presence_manager.createList()},start:function(preselected_ids){if(TS.client.ui.checkForEditing())return;if(TS.isPartiallyBooted()){TS.incremental_boot.userDidInteractWithUI();return}_selected_members=[];_selected_ids_map={};if(preselected_ids){preselected_ids.forEach(function(id){var member=TS.members.getMemberById(id);if(!member)return;if(member.is_self)return;if(member.deleted)return;if(member.is_slackbot)return;if(_selected_members.indexOf(member)!==-1)return;_selected_members.push(member);_selected_ids_map[member.id]=true})}var html=TS.templates.im_browser({preselected:_selected_members,reached_maximum:_selected_members.length===_MAX});TS.ui.fs_modal.start({body_template_html:html,onShow:_onShow,onEnd:_onEnd,modal_class:"fs_modal_internal_scroll"})},startWithMpim:function(mpim,additional_member_ids){if(!mpim)return;var preselected_ids=mpim.members.concat(additional_member_ids);TS.ui.im_browser.start(preselected_ids)},test:function(){return{onShow:_onShow,onEnd:_onEnd,getLastMsg:_getLastMsg,filterListWorker:_filterListWorker,filteredItems:function(){return _filtered_items}}},getRecentDMList:function(){return _buildRecentItemsList()}});var _$im_browser;var _$list_container;var _$scroll_mask;var _$scroll_wrapper;var _all_recent_items;var _all_invitable_items;var _filtered_items=[];var _selected_members;var _selected_ids_map={};var _filtered_mpims=[];var _member_presence_list;var _last_slackbot_msg_placeholder;var _ladda;var _showing_ra_alert=false;var _filter_p=null;var _filter_cursor_mark="";var _filter_num_remaining=0;var _filter_last_query=null;var _filter_last_include_org=null;var _filter_scroll_mark=0;var _FILTER_API_COUNT=100;var _APPROXIMATE_ITEM_HEIGHT=64;var _MAX=8;var _onShow=function(){_$im_browser=$("#im_browser");_$list_container=$("#im_list_container");if(!_selected_members)_selected_members=[];_pickSlackbotMsgPlaceholder();_startListView();var go_btn=_$im_browser.find(".im_browser_go")[0];if(go_btn)_ladda=Ladda.create(go_btn);_$list_container.on("click",".im_browser_row",function(e){if($(e.target).closest("a").length!==0)return;_selectRow($(this))});_$im_browser.on("input","#im_browser_filter",function(){_filterList()});_$im_browser.on("keydown","#im_browser_filter",function(e){var val=$("#im_browser_filter").val();if(e.which===TS.utility.keymap.del&&val===""){_removeLastMemberToken();return}if(e.which===TS.utility.keymap.enter&&val===""){if(!TS.kb_nav.getHighlightedItem())_go();return}if(e.which===TS.utility.keymap.esc){TS.ui.fs_modal.close();return}if(_selected_members.length>=_MAX){e.preventDefault();return}});_$im_browser.on("focus","#im_browser_filter",function(){$("#im_browser_tokens").addClass("active")}).on("blur","#im_browser_filter",function(){$("#im_browser_tokens").removeClass("active")});_$im_browser.on("click","#im_browser_tokens",function(e){var $member_token=$(e.target).closest(".member_token");if($member_token.length){_removeMemberToken($member_token)}else{if($(e.target).closest("#im_browser_filter").length)return;$("#im_browser_filter").focus()}});_$im_browser.on("click",".im_browser_go:not(.disabled)",function(e){_go()});_$im_browser.on("click",".create_private_channel",function(e){e.preventDefault();_switchToNewChannel()});setTimeout(function(){$("#im_browser_filter").focus()},0)};var _onEnd=function(){if(_$im_browser)_$im_browser.remove();_$im_browser=null;_$list_container=null;_$scroll_mask=null;_$scroll_wrapper=null;_all_recent_items=null;_all_invitable_items=null;_filtered_items=[];_filtered_mpims=[];_selected_members=null;_selected_ids_map={};_ladda=null;_showing_ra_alert=false;if(_filter_p)_filter_p.cancel();_filter_cursor_mark="";_filter_num_remaining=0;_filter_last_query=null;_filter_last_include_org=null;_filter_scroll_mark=0;TS.kb_nav.end();TS.ui.new_channel_modal.end();_member_presence_list.clear()};var _buildRecentItemsList=function(){var members=TS.members.getActiveMembersWithSelfAndSlackbot();var mpims=TS.mpims.getVisibleMpims();var member_items=members.map(function(m){return{id:m.id,model_ob:TS.ims.getImByMemberId(m.id),member:m}});var items=member_items;if(mpims&&mpims.length>0){var mpim_items=mpims.map(function(mpim){return{id:mpim.id,model_ob:mpim,members:TS.mpims.getMembersInDisplayOrder(mpim)}});items=member_items.concat(mpim_items)}items.sort(_sortByRecency);_all_recent_items=items;return _all_recent_items};var _buildInvitableItemsList=function(){var members_you_can_invite=[];if(!TS.boot_data.page_needs_enterprise)members_you_can_invite=TS.members.getActiveMembersExceptSelfAndSlackbot().slice(0);if(_selected_members.length===0){var slackbot=TS.members.getMemberByName("slackbot");if(slackbot)members_you_can_invite.push(slackbot);var yourself=TS.members.getMemberById(TS.model.user.id);if(yourself)members_you_can_invite.push(yourself)}members_you_can_invite=members_you_can_invite.map(function(m){return{id:m.id,model_ob:TS.ims.getImByMemberId(m.id),member:m}});var mpims=TS.mpims.getVisibleMpims();if(mpims&&mpims.length>0){var filtered_mpims=mpims.filter(function(mpim){var all_selected=_selected_members.every(function(member){return mpim.members.indexOf(member.id)!==-1});if(!all_selected)return false;if(_selected_members.length===mpim.members.length-1)return false;var members=TS.mpims.getMembersInDisplayOrder(mpim);var has_others=members.some(function(member){if(_selected_members.indexOf(member)!==-1)return false;return!member.deleted&&!member.is_self});if(!has_others)return false;return true});_filtered_mpims=filtered_mpims.map(function(mpim){return{id:mpim.id,model_ob:mpim,members:TS.mpims.getMembersInDisplayOrder(mpim)}});_all_invitable_items=_filtered_mpims.concat(members_you_can_invite)}else{_all_invitable_items=members_you_can_invite}_all_invitable_items.sort(_sortByName)};var _buildItemLists=function(members,mpims){if(!_all_recent_items)_buildRecentItemsList();
_buildInvitableItemsList();if(_selected_members.length){if(!TS.boot_data.page_needs_enterprise)_filtered_items=_all_invitable_items}else{_filtered_items=_all_recent_items}};var _startListView=function(){_buildItemLists();_$list_container.longListView({items:_filtered_items,approx_item_height:_APPROXIMATE_ITEM_HEIGHT*TS.utility.getA11yFontSizeMultiplier(),preserve_dom_order:true,makeElement:function(data){return $('<div class="im_browser_row"></div>')},renderItem:function($el,item,data){$el.data("row_id",item.id);var model_ob=item.model_ob;$el.toggleClass("multiparty",!!(model_ob&&model_ob.is_mpim));$el.toggleClass("disabled",!!_selected_ids_map[item.id]);var template_args={item:item,model_ob:model_ob,slackbot_msg:_last_slackbot_msg_placeholder};if(item.members){if(item.members.length>0)template_args.member_one=item.members[0];if(item.members.length>1)template_args.member_two=item.members[1]}else if(item.member&&item.member.is_self){template_args.is_self=true}if(item.member)_member_presence_list.add(item.member.id);template_args.secondary_name=null;if(model_ob&&model_ob.is_mpim){template_args.display_name=TS.mpims.getDisplayName(model_ob)}else{if(TS.boot_data.feature_name_tagging_client){template_args.display_name=TS.members.getMemberFullName(item.member);if(item.member.profile.title)template_args.title=item.member.profile.title;template_args.secondary_name=TS.members.getMemberPreferredName(item.member)}else{template_args.display_name=TS.members.getMemberDisplayName(item.member);if(item.member.profile.title)template_args.title=item.member.profile.title;if(item.member.profile.real_name&&item.member.name!==item.member.profile.real_name){if(template_args.display_name===item.member.profile.real_name){template_args.secondary_name=item.member.name}else{template_args.secondary_name=item.member.profile.real_name}}}}var last_msg_html="";var last_msg_time_html="";var last_msg=model_ob&&_getLastMsg(model_ob);var formatted_msg;var you=false;if(last_msg){var msg_member=last_msg.comment?TS.members.getMemberById(last_msg.comment.user):TS.members.getMemberById(last_msg.user);if(msg_member){if(msg_member.id===TS.model.user.id){last_msg_html="You: ";you=true}else{last_msg_html=TS.utility.htmlEntities(_nameForLastMsg(msg_member));last_msg_html+=": "}formatted_msg=TS.format.formatNoHighlightsNoSpecialsNoInlineImgs(last_msg.text,last_msg);formatted_msg=formatted_msg.replace(/<a .*?>(.*?)<\/a>/g,"$1");last_msg_html+=formatted_msg;if(you&&!model_ob.is_slackbot_im)last_msg_time_html+='<i class="ts_icon ts_icon_angle_arrow_up_left ts_icon_inherit"></i>';last_msg_time_html+=TS.utility.date.toTimeAgo(last_msg.ts)}}else if(model_ob){var latest_ts=TS.shared.getLatestMsgTs(model_ob);if(latest_ts){last_msg_time_html+=TS.utility.date.toTimeAgo(latest_ts)}}if(last_msg_html)template_args.last_msg=new Handlebars.SafeString(last_msg_html);if(last_msg_time_html)template_args.last_msg_time=new Handlebars.SafeString(last_msg_time_html);if(model_ob&&model_ob.unread_cnt>0){var count=item.model_ob.unread_cnt;if(count>10)count="9+";template_args.unread_cnt=count}$el.html(TS.templates.im_browser_row(template_args))}});_$list_container.monkeyScroll();TS.kb_nav.start(_$list_container.find(".list_items"),".im_browser_row",_$list_container,{use_data_ordering:true,no_blur:true,scrollToStartImmediately:function(){_$list_container.longListView("scrollToTop",true)},scrollToEndImmediately:function(){_$list_container.longListView("scrollToEnd",true)}});TS.kb_nav.setAllowHighlightWithoutBlurringInput(true);TS.kb_nav.setSubmitItemHandler(function(e){_selectRow($(this));e.preventDefault()});if(_selected_members.length&&TS.boot_data.page_needs_enterprise){_filterList()}else if(!_filtered_items.length){_showEmptyState()}};var _getLastMsg=function(im){return TS.shared.getLastMsg(im)};var _nameForLastMsg=function(member){if(TS.members.shouldDisplayRealNames()){if(member.profile&&member.profile.first_name){return member.profile.first_name}}return member.name};var _filterList=function(){var query=$("#im_browser_filter").val();if(TS.boot_data.page_needs_enterprise||TS.lazyLoadMembersAndBots()){_promiseToFilterListWorker(query,!!TS.boot_data.page_needs_enterprise)}else{_filterListWorker(query)}};var _startLoadingFeedback=function(){_startSpinner();_obscureList()};var _stopLoadingFeedback=function(){_stopSpinner();_revealList()};var _startSpinner=function(){document.getElementById("im_browser_spinner").classList.remove("hidden")};var _stopSpinner=function(){document.getElementById("im_browser_spinner").classList.add("hidden")};var _obscureList=function(){if(!_$scroll_wrapper){_$scroll_wrapper=$("#monkey_scroll_wrapper_for_im_list_container");_$scroll_mask=$("<div>",{"class":"monkey_scroll_mask"});_$scroll_wrapper.append(_$scroll_mask);return}_$scroll_mask.removeClass("hidden")};var _revealList=function(){if(_$scroll_mask)_$scroll_mask.addClass("hidden")};var _cleanUpPromiseToFilterListWorker=function(){if(_filter_p){_filter_p.cancel();_filter_cursor_mark="";_filter_num_remaining=0;_filter_last_query=null;_filter_last_include_org=null;_filter_scroll_mark=0;_$list_container.off("scroll.filter")}};var _promiseToFilterListWorker=function(query,all_of_org){_startLoadingFeedback();var query_for_display=query;if(query.charAt(0)==="@")query=query.substring(1);var new_query=_filter_last_query!==query||_filter_last_include_org!==all_of_org;if(new_query){_cleanUpPromiseToFilterListWorker();_filter_last_query=query;_filter_last_include_org=all_of_org}var promiseToFilter=function(){if(!new_query&&!_filter_num_remaining){return Promise.resolve().then(function(){_stopLoadingFeedback()})}return Promise.resolve().then(function(){if(!_selected_members.length&&!query){_filtered_items=_all_recent_items;_$im_browser.addClass("showing_recent");_$im_browser.removeClass("filter_active no_filter_matches")}else{var prefix_regexes=[];var suffix_regexes=[];var queries=query?query.split(/\s*,\s*|\s+/):[];queries=queries.map(function(q){return q.charAt("0")==="@"?q.substring(1):q});for(var i=0;i<queries.length;i++){prefix_regexes.push(new RegExp("^"+TS.utility.regexpEscape(queries[i]),"i"));suffix_regexes.push(new RegExp("(-|_|\\+|\\s|\\.|@)"+TS.utility.regexpEscape(queries[i]),"i"))}return _promiseToMatchIm(query,all_of_org).then(function(matches){var exact_name_matches=[];var mpims_matches=_filtered_mpims;if(query){exact_name_matches=_.remove(matches,function(match){match.member&&match.member.name===query});mpims_matches=_filtered_mpims.filter(function(item){return item.members&&TS.mpims.checkMpimMatch(item.model_ob,prefix_regexes,suffix_regexes)})}if(new_query){_filtered_items=matches.concat(mpims_matches);_filtered_items.sort(_sortByName)}else{_filtered_items.length-=_filtered_items.mpims_matches_length;exact_name_matches.push.apply(exact_name_matches,_filtered_items.splice(0,_filtered_items.exact_matches_length));_filtered_items.push.apply(_filtered_items,matches.concat(mpims_matches));_filtered_items.sort(_sortByName)}if(exact_name_matches.length)_filtered_items.unshift.apply(_filtered_items,exact_name_matches);if(TS.utility.queryIsMaybeSelf(query)){_filtered_items.unshift({id:TS.model.user.id,member:TS.model.user})}_filtered_items.exact_matches_length=exact_name_matches.length;_filtered_items.mpims_matches_length=mpims_matches.length;_$im_browser.toggleClass("filter_active",!!query).removeClass("showing_recent");if(_filtered_items.length>0){_$im_browser.removeClass("no_filter_matches")}else{_$im_browser.addClass("no_filter_matches")}})}}).then(function(){_$list_container.longListView("setItems",_filtered_items);if(new_query)_$list_container.scrollTop(0);TS.utility.rAF(function(){TS.ui.utility.updateClosestMonkeyScroller(_$list_container)});if(!_selected_members.length&&!query){_$list_container.off("scroll.filter")}else if(new_query){_$list_container.on("scroll.filter",function(e){var maybe_filter_scroll_mark=_$list_container.scrollTop()+_$list_container.height()+_APPROXIMATE_ITEM_HEIGHT;if(maybe_filter_scroll_mark<=_filter_scroll_mark)return;var list_items_height=_$list_container.find(".list_items").height();if(maybe_filter_scroll_mark>list_items_height&&_filter_p&&_filter_p.isResolved()){_promiseToFilterListWorker(query,all_of_org);_filter_scroll_mark=maybe_filter_scroll_mark}})}if(_filtered_items.length===0){_showEmptyState(query_for_display)}else{_hideEmptyState()}if(query&&query!=="@"&&_filtered_items.length!==0){if(new_query)TS.kb_nav.highlightFirstItem()}else{TS.kb_nav.clearHighlightedItem()}_stopLoadingFeedback()})};if(new_query){_filter_p=promiseToFilter()}else{_filter_p=_filter_p.then(promiseToFilter)}return _filter_p};var _promiseToMatchIm=function(query_no_at,all_of_org){var can_just_use_local_model=!all_of_org&&!TS.lazyLoadMembersAndBots();if(!query_no_at&&!can_just_use_local_model){_filter_num_remaining=0;return Promise.resolve(TS.members.getActiveMembersExceptSelfAndSlackbot().map(function(member){return{id:member.id,model_ob:TS.ims.getImByMemberId(member.id),member:member}}))}var calling_args={count:_FILTER_API_COUNT,all_of_org:all_of_org,include_bots:true,include_deleted:false};if(query_no_at){if(TS.boot_data.feature_name_tagging_client){var is_user=TS.utility.search.makeClause("is","user");var is_full_name_match=TS.utility.search.makeClause("full_name",query_no_at);var is_preferred_name_match=TS.utility.search.makeClause("preferred_name",query_no_at);var is_full_name_or_preferred_name_match=TS.utility.search.makeConjunction("OR",[is_full_name_match,is_preferred_name_match]);var is_user_and_is_full_name_or_preferred_name_match=TS.utility.search.makeConjunction("AND",[is_user,is_full_name_or_preferred_name_match]);calling_args.query=is_user_and_is_full_name_or_preferred_name_match}else{var is_user=TS.utility.search.makeClause("is","user");var is_name_match=TS.utility.search.makeClause("name",query_no_at);var is_real_name_match=TS.utility.search.makeClause("real_name",query_no_at);var is_name_or_real_name_match=TS.utility.search.makeConjunction("OR",[is_name_match,is_real_name_match]);var is_user_and_is_name_or_real_name_match=TS.utility.search.makeConjunction("AND",[is_user,is_name_or_real_name_match]);calling_args.query=is_user_and_is_name_or_real_name_match}}else{calling_args.query=TS.utility.search.makeClause("is","user")}if(TS.lazyLoadMembersAndBots())calling_args.raw_query=query_no_at;if(_filter_cursor_mark)calling_args.cursor_mark=_filter_cursor_mark;return TS.utility.search.promiseToSearch(calling_args).then(function(response){if(!_filter_num_remaining)_filter_num_remaining=response.data.num_found;_filter_num_remaining-=response.data.items.length;_filter_cursor_mark=response.data.next_cursor_mark;if(!response.data.items.length)return Promise.resolve([]);var has_selected_members=!!_selected_members.length;var matches=response.data.items.map(function(member){var full_member=TS.members.getMemberById(member.id);if(!full_member){if(all_of_org&&member.team_id!=TS.model.team.id){member.is_primary_owner=false;member.is_owner=false;member.is_admin=false}full_member=TS.members.upsertMember(member).member}return{id:member.id,model_ob:TS.ims.getImByMemberId(member.id),member:full_member}}).filter(function(item){if(item.member.is_self&&TS.utility.queryIsMaybeSelf(query_no_at))return false;if(item.member.is_self&&has_selected_members)return false;if(item.member.is_slackbot&&has_selected_members)return false;return true});if(matches.length){return Promise.resolve(matches)}if(_filter_num_remaining)return _promiseToMatchIm(query_no_at);return Promise.resolve([])})};var _filterListWorker=function(query){if(query&&query!=="@"){var prefix_regexes=[];var suffix_regexes=[];var queries=query.split(/[,| ]/).filter(function(i){return!!i});queries=queries.map(function(q){return q.charAt("0")==="@"?q.substring(1):q});for(var i=0;i<queries.length;i++){prefix_regexes.push(new RegExp("^"+TS.utility.regexpEscape(queries[i]),"i"));suffix_regexes.push(new RegExp("(-|_|\\+|\\s|\\.|@)"+TS.utility.regexpEscape(queries[i]),"i"))}var query_no_at=query;if(query.charAt(0)==="@")query_no_at=query.substring(1);var prefix_regex=new RegExp("^"+TS.utility.regexpEscape(query_no_at),"i");var suffix_regex=new RegExp("(-|_|\\+|\\s|\\.|@)"+TS.utility.regexpEscape(query),"i");var matches=[];var non_matches=[];if(TS.boot_data.feature_name_tagging_client){var exact_name_matches=[]}else{var exact_name_match=-1}var self;_all_invitable_items.forEach(function(item,i){if(!TS.boot_data.feature_name_tagging_client&&item.member&&query_no_at===item.member.name){exact_name_match=i}else if(TS.boot_data.feature_name_tagging_client&&item.member&&(query_no_at===item.member._full_name_normalized_lc||query_no_at===item.member._preferred_name_normalized_lc)){exact_name_matches.push(_all_invitable_items[i])}else if(item.member&&item.member.is_self&&TS.utility.queryIsMaybeSelf(query)){self=item}else if(item.member&&_matchIm(item,prefix_regex,suffix_regex)){matches.push(item)}else if(item.members&&TS.mpims.checkMpimMatch(item.model_ob,prefix_regexes,suffix_regexes)){matches.push(item)}else{non_matches.push(item)}});matches.sort(_sortByName);if(TS.boot_data.feature_name_tagging_client){if(exact_name_matches.length>0)matches=exact_name_matches.concat(matches)}else{if(exact_name_match!==-1)matches.unshift(_all_invitable_items[exact_name_match])}if(self)matches.unshift(self);_filtered_items=matches;_$im_browser.addClass("filter_active").removeClass("showing_recent");if(_filtered_items.length>0){_$im_browser.removeClass("no_filter_matches")}else{_$im_browser.addClass("no_filter_matches")}}else{if(_selected_members.length){_filtered_items=_all_invitable_items;_$im_browser.removeClass("showing_recent")}else{_filtered_items=_all_recent_items;_$im_browser.addClass("showing_recent")}_$im_browser.removeClass("filter_active no_filter_matches")}_$list_container.longListView("setItems",_filtered_items);_$list_container.scrollTop(0);TS.utility.rAF(function(){TS.ui.utility.updateClosestMonkeyScroller(_$list_container)});if(_filtered_items.length===0){_showEmptyState(query)}else{_hideEmptyState()}if(query&&query!=="@"&&_filtered_items.length!==0){TS.kb_nav.highlightFirstItem()}else{TS.kb_nav.clearHighlightedItem()}};var _matchIm=function(item,prefix_regex,suffix_regex){var match_names_only=true;return TS.utility.members.checkMemberMatch(item.member,prefix_regex,match_names_only)||TS.utility.members.checkMemberMatch(item.member,suffix_regex,match_names_only)};var _go=function(){if(!_selected_members.length)return;if(_selected_members.length===1){if(_ladda)_ladda.start();TS.ims.promiseToStartImByMemberId(_selected_members[0].id).then(function(){TS.ui.fs_modal.close()}).finally(function(){if(_ladda)_ladda.stop()});return}if(!TS.members.canUserCreateMpims())return;_ladda.start();TS.mpims.startMpimWithMembers(_selected_members,function(ok,data){if(_ladda)_ladda.stop();if(!ok){if(data.error)TS.error("Could not open MPIM: "+data.error);return}TS.ui.fs_modal.close()})};var _openIm=function($row){var row_id=$row.data("row_id");if(TS.utility.strLooksLikeAMemberId(row_id)){TS.ims.startImByMemberId(row_id)}else{TS.mpims.displayMpim(row_id)}TS.ui.fs_modal.close()};var _selectRow=function($row){if(_selected_members.length===_MAX)return;if(!TS.members.canUserCreateMpims())return _openIm($row);var row_id=$row.data("row_id");if(row_id===TS.model.user.id||row_id==="USLACKBOT")return _openIm($row);var members_changed=[];if(TS.utility.strLooksLikeAMemberId(row_id)){var member=TS.members.getMemberById(row_id);if(!member)return;if(_selected_members.indexOf(member)!==-1)return;_selected_members.push(member);_selected_ids_map[member.id]=true;members_changed.push(member)}else{var mpim=TS.mpims.getMpimById(row_id);if(!mpim)return;var mpim_members=TS.mpims.getMembersInDisplayOrder(mpim);mpim_members.forEach(function(member){if(member.deleted)return;if(_selected_members.indexOf(member)!==-1)return;_selected_members.push(member);_selected_ids_map[member.id]=true;members_changed.push(member)})}_selectedMemberListChanged(members_changed)};var _removeMemberToken=function($token){var member_id=$token.data("member-id");var removed=[];_selected_members=_selected_members.filter(function(member){if(member_id===member.id)removed.push(member);return member.id!==member_id});delete _selected_ids_map[member_id];_selectedMemberListChanged(removed)};var _removeLastMemberToken=function(){if(!_selected_members.length)return;var removed=_selected_members.pop();delete _selected_ids_map[removed.id];_selectedMemberListChanged([removed])};var _selectedMemberListChanged=function(what_changed){_buildItemLists();_updateParticipantCountHint();if(_selected_members.length){_$im_browser.find(".im_browser_go").removeClass("disabled")}else{_$im_browser.find(".im_browser_go").addClass("disabled")}if(_selected_members.length>=_MAX){_$im_browser.addClass("reached_maximum")}else{_$im_browser.removeClass("reached_maximum")}if(what_changed){what_changed.forEach(function(member){_$list_container.longListView("itemUpdatedById",member.id)})}_rebuildTokens();_updateRestrictedAccountWarning();TS.kb_nav.clearHighlightedItem();_$list_container.longListView("resizeImmediately")};var _updateParticipantCountHint=function(){var max=_MAX;var remaining=Math.max(0,max-_selected_members.length);var $div=_$im_browser.find(".remaining_participant_hint");if(remaining){if(remaining===1){$div.text("You can add 1 more person")}else{$div.text("You can add "+remaining+" more people")}}else{$div.text("You have reached the maximum number of participants")}};var _rebuildTokens=function(){var query=$("#im_browser_filter").val();$("#im_browser_tokens").replaceWith(TS.templates.im_browser_tokens({members:_selected_members}));var $el=$("#im_browser_filter");if(!query&&TS.boot_data.page_needs_enterprise){$el.focus()}else{$el.val("").trigger("input").focus()}_$im_browser.removeClass("filter_active")};var _showEmptyState=function(query){var _$empty_state=$("#im_browser_empty");var _$msg=_$empty_state.find(".im_browser_empty_message");if(query){_$msg.html("No one found matching <strong>"+TS.utility.truncateAndEscape(query,50)+"</strong>")}else{_$msg.empty()}_$empty_state.removeClass("hidden");$("#monkey_scroll_wrapper_for_im_list_container").addClass("hidden")};var _hideEmptyState=function(){var _$empty_state=$("#im_browser_empty");_$empty_state.addClass("hidden");$("#monkey_scroll_wrapper_for_im_list_container").removeClass("hidden")};var _sortByRecency=function(a,b){var cmp=TS.shared.sorterByLastMsg(a.model_ob,b.model_ob);if(0!==cmp)return cmp;return _sortByName(a,b)};var _sortByName=function(a,b){var a_members;var b_members;if(a.member){a_members=[a.member]}else{a_members=a.members||[]}if(b.member){b_members=[b.member]}else{b_members=b.members||[]}if(a_members.length!==b_members.length){if(a_members.length===1)return-1;if(b_members.length===1)return 1}return _sortByNameWorker(a_members,b_members,0)};var _sortByNameWorker=function(a_members,b_members,inx){var a=a_members[inx];var b=b_members[inx];if(a&&b){var comp=TS.members.memberSorterByName(a,b);if(comp!==0)return comp;return _sortByNameWorker(a_members,b_members,inx+1)}else{if(b)return-1;if(a)return 1}return 0};var _pickSlackbotMsgPlaceholder=function(){var options=["Yay! You’re here. What can I do for you?","Hello, What’s up?","How can I help today?","Hi hi! How can I help?","You’re here! What can I do to help?","You rang?"];_last_slackbot_msg_placeholder=options[Math.round(Math.random()*(options.length-1))]};var _switchToNewChannel=function(){if(!TS.members.canUserCreateGroups())return;var $new_channel_container=$("#new_channel_container");var ids=Object.keys(_selected_ids_map);TS.ui.new_channel_modal.startInContainer($new_channel_container,"",false,ids);_$im_browser.addClass("hidden");$("#fs_modal").removeClass("fs_modal_internal_scroll");$new_channel_container.removeClass("hidden");TS.ui.fs_modal.bindBackButton(_switchBackToImBrowser);TS.ui.fs_modal.showBackButton()};var _switchBackToImBrowser=function(){TS.ui.fs_modal.unbindBackButton();TS.ui.fs_modal.hideBackButton();var $new_channel_container=$("#new_channel_container");$new_channel_container.addClass("hidden");$("#fs_modal").addClass("fs_modal_internal_scroll");_$im_browser.removeClass("hidden");TS.ui.new_channel_modal.end();_$list_container.longListView("resizeImmediately");TS.ui.utility.updateClosestMonkeyScroller(_$list_container)};var _showAlert=function(html){_hideAlert();_$im_browser.prepend(html);_$im_browser.addClass("showing_alert")};var _hideAlert=function(){$("#im_browser_alert").remove();_$im_browser.removeClass("showing_alert")};var _updateRestrictedAccountWarning=function(){if(_showing_ra_alert){_hideAlert();_showing_ra_alert=false}if(TS.model.user.is_restricted)return;if(_selected_members.length<2)return;var members=_selected_members.filter(function(member){return member.is_restricted});if(members.length===0)return;var member=members.length===1&&members[0];var is_ura=member&&member.is_ultra_restricted;var html=TS.templates.im_browser_ra_alert({members:members,member:member,is_ura:is_ura});_showAlert(html);_showing_ra_alert=true}})();(function(){"use strict";TS.registerModule("ui.channel_invite_modal",{onStart:function(){},startInviteToChannelModal:function(channel_id,preselected_ids){if(TS.isPartiallyBooted()){return}var channel=TS.shared.getModelObById(channel_id);if(!channel){TS.error("TS.ui.channel_invite_modal.startInviteToChannelModal no channel or group found with id "+channel_id);return}_channel=channel;preselected_ids=preselected_ids||[];var members_an_admin_could_invite;var members_you_can_invite;if(TS.boot_data.page_needs_enterprise){_selected_members=preselected_ids.map(function(id){_selected_ids_map[id]=true;return TS.model.getMemberById(id)});_invite_members=[]}else{if(channel.is_group){members_an_admin_could_invite=TS.groups.getActiveMembersNotInThisGroupForInviting(channel.id,true);members_you_can_invite=TS.model.user.is_admin?members_an_admin_could_invite:TS.groups.getActiveMembersNotInThisGroupForInviting(channel.id)}else{members_an_admin_could_invite=TS.channels.getActiveMembersNotInThisChannelForInviting(channel.id,true);members_you_can_invite=TS.model.user.is_admin?members_an_admin_could_invite:TS.channels.getActiveMembersNotInThisChannelForInviting(channel.id)}_invite_members=TS.channels.makeMembersWithPreselectsForTemplate(members_you_can_invite,preselected_ids);_show_ra_tip=members_you_can_invite.length!=members_an_admin_could_invite.length}var template_args={channel_name:channel.name,is_private:!!channel.is_group};if(TS.boot_data.page_needs_enterprise)template_args.preselected=_selected_members;var html=TS.templates.channel_invite_modal(template_args);TS.ui.fs_modal.start({body_template_html:html,onShow:_onShow,onEnd:_onEnd,modal_class:"fs_modal_internal_scroll"});if(TS.model.user.is_admin){var admin_invite_html='<div class="channel_modal_footer">Or, <a class="do_admin_invite" data-channel-id="'+channel_id+'">invite a new person to your team</a></div>';$("#channel_invite_modal").append(admin_invite_html)}}});var _$container;var _channel;var _invite_members=[];var _has_invitable_members=true;var _keep_group_history=true;var _show_ra_tip=false;var _lfs_instance;var _$input;var _ladda;var _$list_container;var _$scroll_mask;var _$scroll_wrapper;var _selected_members=[];var _selected_ids_map={};var _member_searcher={};var _APPROXIMATE_ITEM_HEIGHT=64;var _onShow=function(){_$container=$("#channel_invite_modal");_$container.on("click",".no_create_channel",function(){_keep_group_history=false;_advanceToStepTwo()});_$container.on("click",".yes_show_history",function(){_keep_group_history=true;_advanceToStepTwo()});_$container.on("click",".do_admin_invite",function(){TS.ui.fs_modal.close();var channel_id=$(this).data("channel-id");setTimeout(function(){TS.ui.admin_invites.start({initial_channel_id:channel_id})},500)});if(_channel.is_channel){_bindUI()}};var _onEnd=function(){_$container=null;_channel=null;_invite_members=[];_has_invitable_members=true;_keep_group_history=true;_show_ra_tip=false;_lfs_instance=null;_$input=null;_ladda=null;_$list_container=null;_$scroll_mask=null;_$scroll_wrapper=null;_selected_members=[];_selected_ids_map={};if(_member_searcher._searcher_p)_member_searcher._searcher_p.cancel();_member_searcher={};if(TS.boot_data.page_needs_enterprise)TS.kb_nav.end();$(window).off("resize",_recomputeHeight)};var _go=function(){var $selected;if(TS.boot_data.page_needs_enterprise){if(!_selected_members.length)return}else{$selected=$("#channel_invite_container").lazyFilterSelect("value");if(!$selected||!$selected.length)return}if(_keep_group_history||_channel.is_channel){var method=_channel.is_group?"groups.invite":"channels.invite";if(TS.boot_data.page_needs_enterprise){_.chunk(Object.keys(_selected_ids_map),30).forEach(function(members){TS.api.call(method,{channel:_channel.id,force:true,users:members.join(",")})})}else{for(var i=0;i<$selected.length;i++){TS.api.call(method,{channel:_channel.id,user:$selected[i].member.id})}}TS.ui.fs_modal.close()}else{if(_ladda)_ladda.start();var invited_members;if(TS.boot_data.page_needs_enterprise){invited_members=Object.keys(_selected_ids_map)}else{invited_members=$selected.map(function(item){return item.member.id})}TS.groups.createChild(_channel.id,invited_members,function(ok,data,args){if(_ladda)_ladda.stop();if(!ok){if(data&&data.error=="restricted_action"){setTimeout(function(){TS.generic_dialog.alert("<p>You don't have permission to create new groups.</p><p>Talk to your Team Owner.</p>")},500)}else{alert("failed! "+data.error)}return}TS.ui.fs_modal.close()})}};var _advanceToStepTwo=function(){$("#private_channel_invite_step_one").addClass("hidden");$("#channel_invite_container").removeClass("hidden");if(TS.boot_data.page_needs_enterprise)_$container.find(".channel_invite_filter_container").removeClass("hidden");_bindUI()};var _bindUI=function(){if(TS.boot_data.page_needs_enterprise){_startLongListView()}else{_bindFilterSelect()}_bindInviteButton()};var _startLoadingFeedback=function(){_startSpinner();_obscureList()};var _stopLoadingFeedback=function(){_stopSpinner();_revealList()};var _startSpinner=function(){var el=document.getElementById("channel_invite_spinner");if(el)el.classList.remove("hidden")};var _stopSpinner=function(){var el=document.getElementById("channel_invite_spinner");if(el)el.classList.add("hidden")};var _obscureList=function(){if(!_$scroll_wrapper){_$scroll_wrapper=$("#monkey_scroll_wrapper_for_channel_invite_container");_$scroll_mask=$("<div>",{"class":"monkey_scroll_mask"});_$scroll_wrapper.append(_$scroll_mask);return}_$scroll_mask.removeClass("hidden")};var _revealList=function(){if(_$scroll_mask)_$scroll_mask.addClass("hidden")};var _startLongListView=function(){_$list_container=$("#channel_invite_container");_$list_container.longListView({items:[],approx_item_height:_APPROXIMATE_ITEM_HEIGHT,preserve_dom_order:true,makeElement:function(data){return $('<div class="channel_invite_row"></div>')},renderItem:function($el,item,data){$el.data("member-id",item.id);$el.toggleClass("disabled",!!_selected_ids_map[item.id]);$el.html(TS.templates.channel_invite_member({member:item.member}))}});_$list_container.monkeyScroll();_maybeShowRaTip();_$list_container.on("click",".channel_invite_row",function(e){_selectRow($(e.currentTarget))});_$container.on("keydown","#channel_invite_filter",function(e){var val=$(e.currentTarget).val();if(e.which===TS.utility.keymap.del&&val===""){_removeLastMemberToken();return}if(e.which===TS.utility.keymap.enter&&val===""){if(!TS.kb_nav.getHighlightedItem())_go();return}if(e.which===TS.utility.keymap.esc){TS.ui.fs_modal.close();return}}).on("input",function(e){_toggleEnterToGoLabel();_promiseToFilter($(e.target).val().trim()).then(_updateForInviteableMembers).then(_displayFilterResults)});_$container.on("focus","#channel_invite_filter",function(e){$("#channel_invite_tokens").addClass("active")}).on("blur","#im_browser_filter",function(){$("#channel_invite_tokens").removeClass("active")});_$container.on("click","#channel_invite_tokens",function(e){var $member_token=$(e.target).closest(".member_token");if($member_token.length){_removeMemberToken($member_token)}else{$("#channel_invite_filter").focus()}});setTimeout(function(){TS.kb_nav.start(_$list_container.find(".list_items"),".channel_invite_row",_$list_container,{use_data_ordering:true,no_blur:true,scrollToStartImmediately:function(){_$list_container.longListView("scrollToTop",true)},scrollToEndImmediately:function(){_$list_container.longListView("scrollToEnd",true)}});TS.kb_nav.setAllowHighlightWithoutBlurringInput(true);TS.kb_nav.setSubmitItemHandler(function(e){_selectRow($(this));e.preventDefault()});$("#channel_invite_filter").focus()});_promiseToFilter("").then(_updateForInviteableMembers).then(_displayFilterResults)};var _promiseToVerifyOtherOrgMembersExist=function(){if(!_channel.is_shared||!_member_searcher||!_member_searcher.include_org||!TS.model.enterprise||TS.model.enterprise_teams.length===_member_searcher.org_team_ids.length)return Promise.resolve(false);var searcher={query:_member_searcher.query,include_org:_member_searcher.include_org,include_slackbot:_member_searcher.include_slackbot,include_self:_member_searcher.include_self,max_api_results:1,org_team_ids:_(TS.model.enterprise_teams).map("id").xor(_member_searcher.org_team_ids).value()};return TS.members.promiseToSearchMembers(searcher).then(function(searcher){return Promise.resolve(!!searcher.num_found)})};var _promiseToFilter=function(query){_startLoadingFeedback();var query_for_match=query;if(query.charAt(0)==="@")query_for_match=query.substring(1);if(_member_searcher.query!==query_for_match){_member_searcher.query=query_for_match;_member_searcher.include_org=!!_channel.is_shared;_member_searcher.include_slackbot=false;_member_searcher.include_self=false;_member_searcher.not_member_of=[_channel.id];if(_channel.is_shared){var org_team_ids=_.map(_channel.shares||[],"team.id");org_team_ids.push(TS.model.user.team_id);_member_searcher.org_team_ids=org_team_ids}_member_searcher.scroll_mark=0;_member_searcher.query_for_display=query;_$list_container.off("scroll.filter")}return TS.members.promiseToSearchMembers(_member_searcher)};var _updateForInviteableMembers=function(searcher){var members_an_admin_could_invite;var members_you_can_invite;if(_channel.is_group){members_an_admin_could_invite=TS.groups.getActiveMembersNotInThisGroupForInviting(_channel.id,true,searcher.items);members_you_can_invite=TS.model.user.is_admin?members_an_admin_could_invite:TS.groups.getActiveMembersNotInThisGroupForInviting(_channel.id,false,searcher.items)}else{members_an_admin_could_invite=TS.channels.getActiveMembersNotInThisChannelForInviting(_channel.id,true,searcher.items);members_you_can_invite=TS.model.user.is_admin?members_an_admin_could_invite:TS.channels.getActiveMembersNotInThisChannelForInviting(_channel.id,false,searcher.items)}_show_ra_tip=members_you_can_invite.length!=members_an_admin_could_invite.length;_maybeShowRaTip();if(!searcher.query){if(TS.lazyLoadMembersAndBots()){}else{_has_invitable_members=!!searcher.num_found}}if(members_you_can_invite.length!=searcher.items.length){searcher.num_new-=searcher.items.length-members_you_can_invite.length;searcher.items=members_you_can_invite}if(!searcher.num_new&&searcher.num_found&&searcher.num_remaining)return _promiseToFilter(searcher.query).then(_updateForInviteableMembers);return Promise.resolve(searcher)};var _displayFilterResults=function(searcher){var filtered_items=searcher.items.map(function(member){return{id:member.id,member:member}});_$list_container.longListView("setItems",filtered_items);if(searcher._is_new)_$list_container.scrollTop(0);TS.utility.rAF(function(){TS.ui.utility.updateClosestMonkeyScroller(_$list_container)});if(searcher._is_new){_$list_container.on("scroll.filter",function(e){var maybe_scroll_mark=_$list_container.scrollTop()+_$list_container.height()+_APPROXIMATE_ITEM_HEIGHT;if(maybe_scroll_mark<=searcher.scroll_mark)return;var list_items_height=_$list_container.find(".list_items").height();if(maybe_scroll_mark>list_items_height&&_member_searcher._searcher_p&&_member_searcher._searcher_p.isResolved()){
_promiseToFilter(searcher.query).then(_updateForInviteableMembers).then(_displayFilterResults);searcher.scroll_mark=maybe_scroll_mark}})}if(filtered_items.length){_hideEmptyState();_stopLoadingFeedback()}else{return _promiseToVerifyOtherOrgMembersExist().then(function(response){_showEmptyState(searcher.query_for_display,response);_stopLoadingFeedback()})}if(searcher.query&&searcher.query!=="@"&&filtered_items.length!==0){if(searcher._is_new)TS.kb_nav.highlightFirstItem()}else{TS.kb_nav.clearHighlightedItem()}};var _maybeShowRaTip=function(){if(_show_ra_tip){if(!_$container.find(".ra_not_appear_warning").length){var html='<p class="mini subtle_silver no_bottom_margin ra_not_appear_warning">'+TS.templates.builders.raLabel("Restricted accounts")+" may not appear below. Ask a Team Administrator to invite them.</p>";_$container.find(".kb_nav_label").after(html)}}};var _rebuildTokens=function(){var $el=$("#channel_invite_filter");var query=$el.val();$("#channel_invite_tokens").replaceWith(TS.templates.channel_invite_tokens({members:_selected_members}));$el=$("#channel_invite_filter");if(!query&&TS.boot_data.page_needs_enterprise){$el.focus()}else{$el.val("").trigger("input").focus()}};var _selectRow=function($row){var id=$row.data("member-id");var members_changed=[];var member=TS.members.getMemberById(id);if(!member)return;if(_selected_ids_map[id])return;_selected_members.push(member);_selected_ids_map[id]=true;members_changed.push(member);_selectedMemberListChanged(members_changed)};var _removeMemberToken=function($token){var id=$token.data("member-id");var removed=_.remove(_selected_members,function(member){return member.id===id});delete _selected_ids_map[id];_selectedMemberListChanged(removed)};var _removeLastMemberToken=function(){if(!_selected_members.length)return;var removed=_selected_members.pop();delete _selected_ids_map[removed.id];_selectedMemberListChanged([removed])};var _selectedMemberListChanged=function(what_changed){if(what_changed){what_changed.forEach(function(member){_$list_container.longListView("itemUpdatedById",member.id)})}_rebuildTokens();_toggleEnterToGoLabel();_$container.find(".invite_go").toggleClass("disabled",!_selected_members.length);_$list_container.longListView("resizeImmediately")};var _showEmptyState=function(query,other_org_members_exist){var _$empty_state=$("#filter_invite_empty");var _$msg=_$empty_state.find(".filter_invite_empty_message");if(_has_invitable_members){if(query){var template_args={query:query};if(_channel.is_shared&&other_org_members_exist)template_args.teams=[TS.model.team.name].concat(_.map(_channel.shares,"team.name"));_$msg.html(TS.templates.channel_invite_no_results(template_args))}else{_$msg.empty()}}else{_$msg.html(TS.templates.channel_invite_no_results())}_$empty_state.removeClass("hidden");$("#monkey_scroll_wrapper_for_channel_invite_container").addClass("hidden")};var _hideEmptyState=function(){var _$empty_state=$("#filter_invite_empty");_$empty_state.addClass("hidden");$("#monkey_scroll_wrapper_for_channel_invite_container").removeClass("hidden")};var _bindFilterSelect=function(){var $container=$("#channel_invite_container");var prev_query;var start_regex;var suffix_regex;var opts={append:true,data:_invite_members,approx_item_height:_APPROXIMATE_ITEM_HEIGHT,per_page:50,placeholder_text:"Search",always_visible:true,tab_to_nav:true,template:function(item){var html=TS.templates.channel_invite_member({member:item.member});return new Handlebars.SafeString(html)},tokenTemplate:function(item){var html=TS.templates.channel_invite_member_token({member:item.member});return new Handlebars.SafeString(html)},tokenClass:function(item){return TS.templates.builders.getMemberTypeClass(item.member)},filter:function(item,query){var member=item.member;if(prev_query!==query){start_regex=new RegExp("^"+TS.utility.regexpEscape(query),"i");suffix_regex=new RegExp("(-|_|\\+|\\s|\\.|@)"+TS.utility.regexpEscape(query),"i");prev_query=query}var match_names_only=true;return TS.utility.members.checkMemberMatch(member,start_regex,match_names_only)||TS.utility.members.checkMemberMatch(member,suffix_regex,match_names_only)},noResultsTemplate:function(query){if(_invite_members.length){return"No one found matching <strong>"+TS.utility.htmlEntities(query)+"</strong>"}else{return"Everyone is already in this channel, so there is no one to invite!"}},onItemAdded:function(){var $selected=$container.lazyFilterSelect("value");var $invite_list=$container.find(".lfs_input_container");if($selected&&$selected.length!==0){$(".invite_go").removeClass("disabled")}$invite_list.scrollTop($invite_list.height());_toggleEnterToGoLabel();_recomputeHeight()},onItemRemoved:function(){var $selected=$container.lazyFilterSelect("value");if($selected&&$selected.length===0){$(".invite_go").addClass("disabled")}_toggleEnterToGoLabel();_recomputeHeight()},onKeyDown:function(e,handled){if(e.which===TS.utility.keymap.enter&&!handled){var $lazy_filter_select_value=$container.lazyFilterSelect("value");if($lazy_filter_select_value&&$lazy_filter_select_value.length>0){var $input=$container.find(".lfs_input");if($input.val()===""){_go()}}}}};_lfs_instance=$container.lazyFilterSelect(opts);_$input=_lfs_instance.find(".lfs_input");$container.find(".lfs_list_container").on("mouseleave",function(){$(this).find(".lfs_item.active").removeClass("active")});$container.find(".lfs_input_container").after(TS.templates.channel_kb_nav_label({multiple_select:true}));_maybeShowRaTip();$(window).on("resize",_recomputeHeight);setTimeout(_recomputeHeight,10);_$input.on("keyup",function(){_toggleEnterToGoLabel()}).on("keydown",function(e){if(e.which===TS.utility.keymap.esc){TS.ui.fs_modal.close()}}).focus()};var _bindInviteButton=function(){var $container=$("#channel_invite_container");if(_lfs_instance){var $input_container=$container.find(".lfs_input_container");$input_container.wrap("<div></div>");$input_container.attr("style","max-width: 85%").addClass("inline_block").addClass("no_padding");$input_container.after(TS.templates.channel_modal_go_button({class_name:"invite_go",label:"Invite"}))}_toggleEnterToGoLabel();var $button=_$container.find(".invite_go");_ladda=Ladda.create($button[0]);$button.on("click",_go)};var _recomputeHeight=function(){$("#channel_invite_container").lazyFilterSelect("recomputeHeight")};var _toggleEnterToGoLabel=function(){var $container=$("#channel_invite_container");if(_lfs_instance){var $lazy_filter_select_value=_lfs_instance.lazyFilterSelect("value");var $enter_to_go_label=$container.find(".enter_to_go_label");if(_$input.val()){$enter_to_go_label.addClass("hidden")}else if($lazy_filter_select_value&&$lazy_filter_select_value.length>0){$enter_to_go_label.removeClass("hidden")}else{$enter_to_go_label.addClass("hidden")}}else if(TS.boot_data.page_needs_enterprise){var $return_hint=_$container.find(".return_hint");if($("#channel_invite_filter").val()){$return_hint.addClass("hidden")}else if(_selected_members.length){$return_hint.removeClass("hidden")}else{$return_hint.addClass("hidden")}}}})();(function(){"use strict";TS.registerModule("ui.prefs_dialog",{onStart:function(){TS.client.login_sig.add(_onLogin);TS.prefs.sidebar_theme_changed_sig.add(_updateThemeControls);TS.prefs.dtop_notif_changed_sig.add(_updateNotificationControls);TS.prefs.read_changed_sig.add(_updateReadControls);TS.prefs.display_real_names_override_changed_sig.add(_updateRealNameControls);TS.prefs.team_display_real_names_changed_sig.add(_updateRealNameControls);if(TS.boot_data.feature_name_tagging_client){TS.prefs.display_preferred_names_changed_sig.add(_updatePreferredNameControls)}TS.prefs.mac_speak_changed_sig.add(_updateMacSpeakControls);TS.prefs.tz_changed_sig.add(_tzPrefChanged);TS.members.changed_tz_sig.add(_memberTzChanged);TS.prefs.channel_sort_changed_sig.add(_updateChannelSortControls);_last_section=TS.qs_args.prefs_last_section||_last_section},start:function(section,highlight_selector,expand_rollup){_start(section,highlight_selector,expand_rollup)}});var _is_open=false;var _$div=null;var _$div_contents=null;var _$sidebar=null;var _last_section="notifications";var _sidebar_html=null;var _theme_throttle_tim=0;var _show_customization_ui=false;var _show_speech_settings=false;var _show_mac_ssb_prefs=false;var _show_win_ssb_prefs=false;var _show_lin_ssb_prefs=false;var _need_to_hide_sidebar=false;var _expanded_rollups=[];var _sorting_tim;var _onLogin=function(){_show_speech_settings=TS.boot_data.feature_tinyspeck&&TS.ui.growls.canSpeak()&&(TS.model.mac_ssb_version&&TS.model.mac_ssb_version>=.32);_show_mac_ssb_prefs=TS.model.mac_ssb_version&&TS.model.mac_ssb_version>=.32||TS.model.win_ssb_version&&TS.model.is_mac;_show_win_ssb_prefs=TS.model.win_ssb_version&&TS.model.is_win;_show_lin_ssb_prefs=TS.model.lin_ssb_version&&TS.model.is_lin;_show_customization_ui=TS.model.prefs.sidebar_theme&&(TS.model.prefs.sidebar_theme=="custom_theme"||TS.model.prefs.sidebar_theme=="cotton_theme"||TS.model.prefs.sidebar_theme=="eco_theme")};var _start=function(section,highlight_selector,expand_rollup){section=section||_last_section;if(!TS.model.ms_logged_in_once||!TS.model.prefs||$("body").hasClass("loading")||TS.ui.fs_modal.is_showing)return;if(!_sidebar_html){_sidebar_html=TS.templates.prefs_sidebar({show_mac_ssb_prefs:_show_mac_ssb_prefs,show_win_ssb_prefs:_show_win_ssb_prefs,show_lin_ssb_prefs:_show_lin_ssb_prefs,show_labs_prefs:TS.boot_data.feature_tinyspeck,show_a11y_prefs:TS.boot_data.feature_a11y_pref_text_size})}_is_open=true;var settings={title:"Your preferences for "+TS.model.team.name,body_template_html:"",sidebar_html:_sidebar_html,onShow:_onShow,onCancel:_onCancel,modal_class:"fs_modal_header fs_modal_sidebar prefs_modal"};TS.ui.fs_modal.start(settings);_$div=$("#fs_modal");_$div_contents=_$div.find(".contents");_$sidebar=$("#fs_modal_sidebar");_$sidebar.find("a").on("click",function(){_openSection($(this).data("section"))});if(!TS.environment.supports_custom_scrollbar)_$div.find(".contents_container").monkeyScroll();_openSection(section);if(highlight_selector){setTimeout(function(){_$div.find(highlight_selector).highlight()},1e3)}if(section==="notifications"){if(expand_rollup)_expandRollup(expand_rollup)}_bindInlineSavers();$("#col_channels").addClass("prefs_open");if(TS.boot_data.feature_sli_channel_priority){clearTimeout(_sorting_tim);_sorting_tim=setTimeout(function(){TS.client.channel_pane.startSortingMode()},TS.ui.fs_modal.transition_duration)}};var _onShow=function(){};var _onCancel=function(){$("#col_channels").removeClass("prefs_open");_expanded_rollups=[];_is_open=false;_$div=null;_$div_contents=null;_$sidebar.find("a").off("click");_$sidebar=null;if(TS.boot_data.feature_sli_channel_priority){clearTimeout(_sorting_tim);TS.client.channel_pane.stopSortingMode()}};var _openSection=function(section){if(_need_to_hide_sidebar)_hideSidebar();var html=_buildSectionHTML(section);_last_section=section;_$sidebar.find("a").removeClass("is_active").end().find('a[data-section="'+section+'"]').addClass("is_active");_$div_contents.html(html);_bindSectionUI(section);setTimeout(function(){if(!TS.environment.supports_custom_scrollbar)TS.ui.utility.updateClosestMonkeyScroller(_$div_contents);_$div.find(".contents_container").scrollTop(0)},0);_need_to_hide_sidebar=section==="themes";if(section==="notifications"){_.each(_expanded_rollups,function(rollup){_expandRollup(rollup)})}if(TS.boot_data.feature_frecency_migration){if(section==="labs"){TS.ui.prefs_frecency_migration.start()}}};var _buildSectionHTML=function(section){var html;var template_args={};switch(section){case"notifications":var highlight_words=TS.model.prefs.highlight_words||"";highlight_words=highlight_words.replace(/\,/g,", ").replace(/\ \ /g," ");template_args={notification_sounds:TS.boot_data.notification_sounds,member:TS.model.user,highlight_words:highlight_words,team_prefs:TS.model.team.prefs,time24:TS.model.prefs.time24,show_mac_ssb_prefs:_show_mac_ssb_prefs,show_win_ssb_prefs:_show_win_ssb_prefs,has_tz:!!TS.model.prefs.tz,tz_guess:!TS.model.prefs.tz&&_dndTzGuess()};html=TS.templates.prefs_notifications(template_args);break;case"win_ssb":case"lin_ssb":html=TS.templates.prefs_win_lin_ssb({show_lin_ssb_prefs:_show_lin_ssb_prefs});break;case"messages_media":var skin_tone_modifier="";if(TS.model.prefs.preferred_skin_tone&&TS.model.prefs.preferred_skin_tone!=="1"){skin_tone_modifier=":skin-tone-"+TS.model.prefs.preferred_skin_tone+":"}template_args={inline_img_byte_limit:TS.model.inline_img_byte_limit,clean_theme:TS.model.prefs.messages_theme=="light_with_avatars",compact_theme:TS.model.prefs.messages_theme=="dense",thumbs_up_name_with_skin_tone_modifier:":thumbsup:"+skin_tone_modifier,should_use_local_lato_2:TS.boot_data.should_use_local_lato_2};html=TS.templates.prefs_messages_media(template_args);break;case"themes":if(TS.model.prefs.sidebar_theme_custom_values&&TS.model.prefs.sidebar_theme_custom_values!="undefined"){template_args.theme=JSON.parse(TS.model.prefs.sidebar_theme_custom_values);template_args.show_customization_ui=_show_customization_ui;template_args.show_customization_ui=_show_customization_ui}template_args.channel_sort_options=TS.model.channel_sort_options;template_args.channel_sort_options_cnt=TS.model.channel_sort_options.length-5;template_args.channel_sort_simple_options=TS.model.channel_sort_simple_options;html=TS.templates.prefs_themes(template_args);break;case"search":html=TS.templates.prefs_search(_buildSearchPrefsData());break;case"read_state_tracking":html=TS.templates.prefs_read_state_tracking();break;case"a11y":html=TS.templates.prefs_a11y();break;case"advanced":var show_app_download_path=false;var app_download_path="";if(TS.model.is_our_app){show_app_download_path=window.TSSSB&&TSSSB.call("hasPreference","PrefSSBFileDownloadPath");if(TSSSB.env.mac_ssb_version&&TSSSB.env.mac_ssb_version<2){show_app_download_path=false}if(show_app_download_path){app_download_path=TSSSB.call("getPreference","PrefSSBFileDownloadPath")}}template_args.show_app_download_path=show_app_download_path;template_args.app_download_path=app_download_path;if(TS.boot_data.feature_flannel_fe)template_args.show_flannel_pref=true;template_args.show_console_whitelist=true;var preselected=_.get(TS.model.prefs,"client_logs_pri","");template_args.whitelisted_pris=_(Object.keys(TS.boot_data.client_logs)).filter(function(key){var obj=TS.boot_data.client_logs[key];var feature_allowed=true;if(!_.isUndefined(obj.features)){var features=obj.features;if(!_.isArray(obj.features))features=features.split(",");var count=0;features.forEach(function(feature){if(feature.indexOf("feature_")!==0)feature="feature_"+feature;if(TS.boot_data[feature])count++});feature_allowed=count===features.length}return!_.isUndefined(obj.whitelisted)&&obj.whitelisted&&feature_allowed}).map(function(key){var obj=_.merge({},TS.boot_data.client_logs[key]);obj.selected=preselected.indexOf(key)>-1;if(obj.name)obj.name=obj.name[0].toUpperCase()+obj.name.substring(1);return obj}).value();template_args.client_logs_pri_all_selected=preselected.indexOf("all")>-1;html=TS.templates.prefs_advanced(template_args);break;case"labs":template_args={show_cmd_comma_pref:TS.model.is_mac&&TS.model.is_our_app,show_speech_settings:_show_speech_settings,show_electron_prefs:TS.model.is_electron};html=TS.templates.prefs_labs(template_args);break;default:TS.error("This isn't the Prefs HTML builder you're looking for: "+section);return}return html};var _bindSectionUI=function(section){switch(section){case"notifications":_bindNotificationsPrefs();_updateNotificationControls();if(_show_mac_ssb_prefs){_bindMacSSBPrefs();_updateBounceShortCB()}if(_show_win_ssb_prefs){_bindWinSSBPrefs()}_bindPrefsRollups();_updateNotificationSummary();_updateDnDSummary();break;case"win_ssb":case"lin_ssb":_bindWinLinSSBPrefs();break;case"messages_media":_bindMessagesMediaPrefs();if(TS.boot_data.feature_name_tagging_client){_updatePreferredNameControls()}else{_updateRealNameControls()}$("#dont_obey_inline_img_limit_cb").prop("disabled",!TS.model.prefs.expand_inline_imgs);break;case"themes":_bindThemePrefs();_bindSidebarBehaviorPrefs();_updateThemeControls();_updateChannelSortControls();_showSidebar();break;case"search":_bindSearchPrefs();break;case"read_state_tracking":_bindReadStateTrackingPrefs();_updateReadControls();break;case"a11y":_bindA11yPrefs();break;case"advanced":_bindAdvancedPrefs();_bindSidebarBehaviorPrefs();break;case"labs":_bindLabsPrefs();if(_show_speech_settings)_updateMacSpeakControls();break;default:TS.error("This isn't the Prefs UI binding you're looking for: "+section);return}};var _bindInlineSavers=function(){_$div_contents.on("change",'input[type="checkbox"][data-inline-saver], input[type="radio"][data-inline-saver], input[type="file"], select[data-inline-saver]',function(){TS.ui.inline_saver.show({target:$(this).data("inline-saver")})});_$div_contents.on("input",'input[type="text"][data-inline-saver], textarea[data-inline-saver]',TS.utility.debounce(function(){TS.ui.inline_saver.show({target:$(this).data("inline-saver")})},250))};var _bindNotificationsPrefs=function(){$(".growls_stuff").addClass("hidden");$("#growls_permission_link").on("click",_onGrowlsPermissionLinkClick);$("#growls_test").on("click",function(){TS.sounds.play("new_message");if(TS.model.prefs.no_text_in_notifications){TS.ui.growls.show("A Notification from Slack","")}else{TS.ui.growls.show("A Notification from Slack","What do you know? It works.")}}).addClass("hidden");if(TS.ui.growls.shouldShowPermissionButton()){$("#growls_permission_div").removeClass("hidden")}else{if(TS.ui.growls.checkPermission()){$("#growls_allowed_div").removeClass("hidden");$("#growls_test").removeClass("hidden")}else{if(TS.ui.growls.no_notifications){$("#growls_impossible_div").removeClass("hidden")}else if(TS.ui.growls.getPermissionLevel()=="denied"){$("#growls_disallowed_div").removeClass("hidden")}}}$('input:radio[name="notifications_rd"]').on("change",function(){var val=$(this).val();if(val=="all"||val=="mentions"){if(val=="all"){TS.prefs.setPrefByAPI({name:"all_channels_loud",value:true});TS.model.prefs.all_channels_loud=true}else{TS.prefs.setPrefByAPI({name:"all_channels_loud",value:false});TS.model.prefs.all_channels_loud=false}if(!TS.model.prefs.growls_enabled){TS.prefs.setPrefByAPI({name:"growls_enabled",value:true});TS.model.prefs.growls_enabled=true}}else{TS.prefs.setPrefByAPI({name:"growls_enabled",value:false});TS.model.prefs.growls_enabled=false}TS.prefs.dtop_notif_changed_sig.dispatch()});$("#no_text_in_notifications_cb").on("change",function(){var val=!$(this).prop("checked");TS.prefs.setPrefByAPI({name:"no_text_in_notifications",value:val})});var snd_val;$('input:radio[name="sound_option_rd"]').on("change",function(){snd_val=$(this).val();TS.sounds.play(snd_val,{ignore_mute:true});TS.prefs.setPrefByAPI({name:"new_msg_snd",value:snd_val})});$(".sound_option").find("ts-icon").on("click",function(e){snd_val=$(this).siblings("input").val();TS.sounds.play(snd_val,{ignore_mute:true});e.preventDefault();e.stopPropagation()});$("#mute_sounds_cb").prop("checked",TS.model.prefs.mute_sounds===true);$("#mute_sounds_cb").on("change",function(){var val=!!$(this).prop("checked");TS.model.prefs.mute_sounds=val;TS.prefs.setPrefByAPI({name:"mute_sounds",value:val});_updateNotificationControls()});_$div.find("#highlight_words_input").on("input",TS.utility.debounce(_saveHighlightWords,250));if(TS.model.win_ssb_version||TS.model.lin_ssb_version){var highlight_words_placeholder=$("#highlight_words_input").attr("placeholder");var has_placeholder=true;$("#highlight_words_input").on("textchange",function(){if($(this).val()&&has_placeholder){$(this).attr("placeholder","");has_placeholder=false}else if(!$(this).val()&&!has_placeholder){$(this).attr("placeholder",highlight_words_placeholder);has_placeholder=true}})}$("#dnd_enabled").prop("checked",!!TS.model.prefs.dnd_enabled);$("#dnd_start_hour, #dnd_end_hour").prop("disabled",!TS.model.prefs.dnd_enabled).closest("label").toggleClass("disabled",!TS.model.prefs.dnd_enabled);var dnd_props=_getDndProps();$("#dnd_enabled").on("change",function(){var checked=$(this).is(":checked");if(checked){$("#dnd_start_hour, #dnd_end_hour").prop("disabled",false).closest("label").removeClass("disabled")}else{$("#dnd_start_hour, #dnd_end_hour").prop("disabled",true).closest("label").addClass("disabled")}dnd_props.dnd_enabled=checked;TS.prefs.setMultiPrefsByAPI(dnd_props)});var $start_el=_getDndOptionElement($("#dnd_start_hour"),dnd_props.dnd_start_hour);$start_el.prop("selected",true);var $end_el=_getDndOptionElement($("#dnd_end_hour"),dnd_props.dnd_end_hour);$end_el.prop("selected",true);$("#dnd_start_hour").on("change",function(){dnd_props.dnd_start_hour=$(this).val();TS.prefs.setMultiPrefsByAPI(dnd_props);$("#dnd_end_hour option").each(function(){return $(this).prop("disabled",false)});var $end_disabled=_getDndOptionElement($("#dnd_end_hour"),dnd_props.dnd_start_hour);$end_disabled.prop("disabled",true)});$("#dnd_end_hour").on("change",function(){dnd_props.dnd_end_hour=$(this).val();TS.prefs.setMultiPrefsByAPI(dnd_props);$("#dnd_start_hour option").each(function(){return $(this).prop("disabled",false)});var $start_disabled=_getDndOptionElement($("#dnd_start_hour"),dnd_props.dnd_end_hour);$start_disabled.prop("disabled",true)});$start_el=_getDndOptionElement($("#dnd_start_hour"),dnd_props.dnd_end_hour);$start_el.prop("disabled",true);$end_el=_getDndOptionElement($("#dnd_end_hour"),dnd_props.dnd_start_hour);$end_el.prop("disabled",true);$("#confirm_dnd_tz_guess").click(function(){if($(this).hasClass("disabled"))return;if(!window.timezones_guess)return;var guess=window.timezones_guess();TS.prefs.setPrefByAPI({name:"tz",value:guess});$(this).addClass("disabled")})};var _getDndProps=function(){return{dnd_enabled:TS.model.prefs.dnd_enabled,dnd_start_hour:TS.model.prefs.dnd_start_hour||TS.model.team.prefs.dnd_start_hour||"22:00",dnd_end_hour:TS.model.prefs.dnd_end_hour||TS.model.team.prefs.dnd_end_hour||"08:00"}};var _getDndOptionElement=function($select,time){var $option=$select.find("option").filter(function(){var val=$(this).attr("value");var matches=val===time;if(!matches)matches=val==="0"+time;return matches});if(!$option.length){$option=$('<option data-custom-time="true">');$option.val(time);if(TS.utility.date.do24hrTime()){$option.text(time)}else{var twelve_hour_time=_to12h(time);$option.text(twelve_hour_time)}var $after=$select.find("option").filter(function(){var val=$(this).attr("value");return val>time});if($after.length){$after.filter(":first").before($option)}else{$select.append($option)}}return $option};var _dndTzGuess=function(){if(!window.timezones_guess||!window.timezones_list)return null;var guess=window.timezones_guess();var list=window.timezones_list();var match=_.find(list,function(tz_item){if(tz_item.length===2){return tz_item[1]===guess}return false});if(match)return match[0];return null};var _bindMessagesMediaPrefs=function(){$('input:radio[name="messages_theme_select"]').filter('[value="'+TS.model.prefs.messages_theme+'"]').prop("checked",true);$('input:radio[name="messages_theme_select"]').on("change",function(){$(".prefs_messages_theme_preview").toggleClass("hidden");TS.prefs.setPrefByAPI({name:"messages_theme",value:$(this).val()})});$("#show_typing_cb").prop("checked",TS.model.prefs.show_typing===true).removeClass("hidden");$("#show_typing_cb").on("change",function(){TS.prefs.setPrefByAPI({name:"show_typing",value:!!$(this).prop("checked")})});$("#display_real_names_override_cb").on("change",function(){var checked=!!$(this).prop("checked");var val;if(TS.model.team.prefs.display_real_names){val=checked?0:-1}else{val=checked?1:0}TS.prefs.setPrefByAPI({name:"display_real_names_override",value:val})});if(TS.boot_data.feature_name_tagging_client){$("#display_preferred_names_cb").on("change",function(){var checked=!!$(this).prop("checked");TS.prefs.setPrefByAPI({name:"display_preferred_names",value:!checked})})}$("#time24_cb").prop("checked",TS.model.prefs.time24===true);$("#time24_cb").on("change",function(){TS.prefs.setPrefByAPI({name:"time24",value:!!$(this).prop("checked")})});$("#load_lato_2_cb").prop("checked",TS.model.prefs.load_lato_2===true);$("#load_lato_2_cb").on("change",function(){var val=!!$(this).prop("checked");TS.model.prefs.load_lato_2=val;TS.prefs.setPrefByAPI({name:"load_lato_2",value:val},function(){TS.reload()})});$('input:radio[name="emoji_mode_select"]').filter('[value="'+TS.model.prefs.emoji_mode+'"]').prop("checked",true);$('input:radio[name="emoji_mode_select"]').on("change",function(){TS.prefs.setPrefByAPI({name:"emoji_mode",value:$(this).val()})});$("#jumbomoji_cb").prop("checked",TS.model.prefs.jumbomoji===true);$("#jumbomoji_cb").on("change",function(){var val=!!$(this).prop("checked");TS.prefs.setPrefByAPI({name:"jumbomoji",value:val});TS.prefs.onPrefChanged({name:"jumbomoji",value:val})});$("#convert_emoticons_cb").prop("checked",TS.model.prefs.convert_emoticons===true);$("#convert_emoticons_cb").on("change",function(){var val=!!$(this).prop("checked");TS.prefs.setPrefByAPI({name:"convert_emoticons",value:val})});$("#expand_internal_inline_imgs_cb").prop("checked",TS.model.prefs.expand_internal_inline_imgs===true);$("#expand_internal_inline_imgs_cb").on("change",function(){TS.prefs.setPrefByAPI({name:"expand_internal_inline_imgs",value:!!$(this).prop("checked")})});$("#expand_inline_imgs_cb").prop("checked",TS.model.prefs.expand_inline_imgs===true);$("#expand_inline_imgs_cb").on("change",function(){var val=!!$(this).prop("checked");TS.prefs.setPrefByAPI({name:"expand_inline_imgs",value:val});TS.model.prefs.expand_inline_imgs=val;$("#dont_obey_inline_img_limit_cb").prop("disabled",!TS.model.prefs.expand_inline_imgs)});$("#dont_obey_inline_img_limit_cb").prop("checked",TS.model.prefs.obey_inline_img_limit===false);$("#dont_obey_inline_img_limit_cb").on("change",function(){var val=!!$(this).prop("checked");TS.model.prefs.obey_inline_img_limit=!val;TS.prefs.setPrefByAPI({name:"obey_inline_img_limit",value:!val})});$("#expand_non_media_attachments_cb").prop("checked",TS.model.prefs.expand_non_media_attachments===true);$("#expand_non_media_attachments_cb").on("change",function(){TS.prefs.setPrefByAPI({name:"expand_non_media_attachments",value:!!$(this).prop("checked")})})};var _bindSearchPrefs=function(){$("#search_channel_exclusion").lazyFilterSelect({placeholder_text:"Pick channels to exclude..."}).on("change",function(){var channels=$(this).val();TS.prefs.setPrefByAPI({name:"search_exclude_channels",value:channels?channels.join(","):""})}).hide()};var _bindReadStateTrackingPrefs=function(){$('input:radio[name="read_rd"]').on("change",function(){var val=$(this).val();TS.prefs.setReadStateTrackingPref(val);_updateReadControls()})};var _bindA11yPrefs=function(){var $a11y_font_size_select_input=$('input:radio[name="a11y_font_size_select"]');$a11y_font_size_select_input.filter('[value="'+TS.model.prefs.a11y_font_size+'"]').prop("checked",true);$a11y_font_size_select_input.on("change",function(){TS.prefs.setPrefByAPI({name:"a11y_font_size",value:$(this).val()})})};var _bindAdvancedPrefs=function(){$("#webapp_spellcheck_cb").prop("checked",TS.model.prefs.webapp_spellcheck===true).removeClass("hidden");$("#webapp_spellcheck_cb").on("change",function(){TS.prefs.setPrefByAPI({name:"webapp_spellcheck",value:!!$(this).prop("checked")})});if(!TS.boot_data.feature_name_tagging_client){$("#require_at_cb").prop("checked",TS.model.prefs.require_at===true).removeClass("hidden");$("#require_at_cb").on("change",function(){TS.prefs.setPrefByAPI({name:"require_at",value:!!$(this).prop("checked")})})}$("#enter_is_special_in_tbt_cb").prop("checked",TS.model.prefs.enter_is_special_in_tbt===true);$("#enter_is_special_in_tbt_cb").on("change",function(){TS.prefs.setPrefByAPI({name:"enter_is_special_in_tbt",value:!!$(this).prop("checked")})});$("#arrow_history_cb").prop("checked",TS.model.prefs.arrow_history===true);$("#arrow_history_cb").on("change",function(){var val=!!$(this).prop("checked");TS.prefs.setPrefByAPI({name:"arrow_history",value:val})});_$div.find('[data-action="select_ssb_download_path"]').on("click",function(e){var default_path=TSSSB.call("getPreference","PrefSSBFileDownloadPath")||"";var options={type:"openDirectory",title:"Select a download location",defaultPath:default_path};TSSSB.call("showOpenDialog",{options:options,callback:function(arrayOfPaths){if(!arrayOfPaths)return;var download_path=arrayOfPaths[0];TSSSB.call("setPreference",{name:"PrefSSBFileDownloadPath",value:download_path});_$div.find("#app_download_path_input").val(download_path);TS.ui.inline_saver.show({target:_$div.find("#prefs_download_location")})}})});$("#pagekeys_handled_cb").prop("checked",TS.model.prefs.pagekeys_handled===true).removeClass("hidden");$("#pagekeys_handled_cb").on("change",function(){TS.prefs.setPrefByAPI({name:"pagekeys_handled",value:!!$(this).prop("checked")})});$("#f_key_search_cb").prop("checked",TS.model.prefs.f_key_search===true).removeClass("hidden");$("#f_key_search_cb").on("change",function(){TS.prefs.setPrefByAPI({name:"f_key_search",value:!!$(this).prop("checked")})});$("#k_key_omnibox_cb").prop("checked",TS.model.prefs.k_key_omnibox===true).removeClass("hidden");$("#k_key_omnibox_cb").on("change",function(){TS.prefs.setPrefByAPI({name:"k_key_omnibox",value:!!$(this).prop("checked")})});$("#no_omnibox_in_channels_cb").prop("checked",TS.model.prefs.no_omnibox_in_channels===true).removeClass("hidden");$("#no_omnibox_in_channels_cb").on("change",function(){TS.prefs.setPrefByAPI({name:"no_omnibox_in_channels",value:!!$(this).prop("checked")})});if(TS.boot_data.feature_prev_next_button){$("#prev_next_btn").prop("checked",TS.model.prefs.prev_next_btn===true).removeClass("hidden");$("#prev_next_btn").on("change",function(){TS.prefs.setPrefByAPI({name:"prev_next_btn",value:!!$(this).prop("checked")})})}$("#ask_after_away_cb").prop("checked",TS.model.prefs.confirm_user_marked_away===true);$("#ask_after_away_cb").on("change",function(){var val=!!$(this).prop("checked");TS.model.prefs.confirm_user_marked_away=val;TS.prefs.setPrefByAPI({name:"confirm_user_marked_away",value:val})});$("#enable_chan_suggestions").prop("checked",TS.model.prefs.overloaded_message_enabled===true);$("#enable_chan_suggestions").on("change",function(){var val=!!$(this).prop("checked");TS.prefs.setPrefByAPI({name:"overloaded_message_enabled",value:val})});if(TS.boot_data.feature_a11y_pref_no_animation){var $a11y_animations=$("#a11y_animations");$a11y_animations.prop("checked",TS.model.prefs.a11y_animations===true);$a11y_animations.on("change",function(){var val=!!$(this).prop("checked");TS.prefs.setPrefByAPI({name:"a11y_animations",value:val})})}$("#ls_disabled_cb").prop("checked",TS.model.prefs.ls_disabled===true);$("#ls_disabled_cb").bind("change",function(){var val=!!$(this).prop("checked");TS.model.prefs.ls_disabled=val;TS.storage.setDisabled(TS.model.prefs.ls_disabled);TS.prefs.setPrefByAPI({name:"ls_disabled",value:val},function(){TS.reload()})});$("#ss_emojis_cb").prop("checked",TS.model.prefs.ss_emojis!==true);$("#ss_emojis_cb").bind("change",function(){var val=!$(this).prop("checked");TS.model.prefs.ss_emojis=val;TS.prefs.setPrefByAPI({name:"ss_emojis",value:val},function(){TS.reload()})});$("#enhanced_debugging_cb").prop("checked",TS.model.prefs.enhanced_debugging===true);$("#enhanced_debugging_cb").bind("change",function(){var val=!!$(this).prop("checked");TS.model.prefs.enhanced_debugging=val;TS.prefs.setPrefByAPI({name:"enhanced_debugging",value:val},function(){TS.reload()})});$("#flannel_lazy_members").prop("checked",TS.model.prefs.flannel_lazy_members===true);$("#flannel_lazy_members").on("change",function(){TS.storage.completelyEmptyAllStorageAndReset();var val=!!$(this).prop("checked");TS.prefs.setPrefByAPI({name:"flannel_lazy_members",value:val},function(){TS.log(1989,"Flannel: pref toggled! Reloading ... see you on the other side");TS.reload()})});$("#flannel_server_pool").val(TS.model.prefs.flannel_server_pool);$("#flannel_server_pool").attr("disabled",!TS.model.prefs.flannel_lazy_members);
$("#flannel_server_pool").on("change",function(){var val=$(this).val();var prev_val=TS.model.prefs.flannel_server_pool;if(!_.includes(["production","canary","random"],val)){TS.error("Tried to set an invalid value ('"+val+"') for `flannel_server_pool` pref");return}TS.prefs.setPrefByAPI({name:"flannel_server_pool",value:val},function(){TS.log(1989,"Flannel: canary pref changed from "+prev_val+" to "+val);TS.ms.disconnect()})});$("#enable_unread_view").prop("checked",TS.model.prefs.enable_unread_view===true);$("#enable_unread_view").on("change",function(){var val=!!$(this).prop("checked");TS.model.prefs.seen_unread_view_coachmark=true;TS.prefs.setMultiPrefsByAPI({enable_unread_view:val,seen_unread_view_coachmark:true});TS.prefs.onPrefChanged({name:"enable_unread_view",value:val})});$("#client_logs_pri").hide().lazyFilterSelect({placeholder_text:"Select logs to enable..."}).on("change",function(){var priorities=$(this).val();TS.prefs.setPrefByAPI({name:"client_logs_pri",value:priorities?priorities.join(","):""})});var surprise_suffix=Math.random();if(TS.model.user.id=="U024BE7LV"){$("#emo_bear").attr("src","/img/emo_bear2.gif?"+surprise_suffix)}else{$("#emo_bear").attr("src","/img/emo_bear.gif?"+surprise_suffix)}$("#surprise_me").on("change",function(){$("#surprise").fadeIn(150,function(){setTimeout(function(){$("#surprise").fadeOut(500,function(){surprise_suffix=Math.random();if(TS.model.user.id=="U024BE7LV"){$("#emo_bear").attr("src","/img/emo_bear2.gif?"+surprise_suffix)}else{$("#emo_bear").attr("src","/img/emo_bear.gif?"+surprise_suffix)}$("#surprise_me").prop("checked",false)})},2400)})})};var _bindThemePrefs=function(){var $custom_sort_selects=_$div.find(".custom_sort_select");var $custom_sort_simple_select=_$div.find("#custom_sort_simple_select");var sort_saver=_.debounce(function(str_val){TS.prefs.setPrefByAPI({name:"channel_sort",value:str_val})},3e3);var updateChannelSort=function(changes){var ob=TS.model.channel_sort;if(changes){if(changes.hasOwnProperty("sorts"))ob.sorts=changes.sorts||[];if(changes.hasOwnProperty("priority_type"))ob.priority_type=changes.priority_type||"";if(changes.hasOwnProperty("priority_display"))ob.priority_display=!!changes.priority_display;if(changes.hasOwnProperty("is_custom_sorted"))ob.is_custom_sorted=!!changes.is_custom_sorted}var str_val=JSON.stringify(ob);TS.prefs.onPrefChanged({name:"channel_sort",value:str_val});sort_saver(str_val)};var buildSortsAndPriorityType=function(priority_type_override){var sorts=[];var priority_type="";$custom_sort_selects.each(function(){var val=$(this).val();if(val)sorts.push(val)});if(priority_type_override){priority_type=priority_type_override;sorts=sorts.map(function(sort){if(sort=="sli"||sort=="frecency")return priority_type_override;return sort});if(!sorts.length){sorts.push(priority_type_override)}else if(sorts.indexOf("frecency")>-1){sorts[sorts.indexOf("sli")]=priority_type_override;sorts[sorts.indexOf("frecency")]=priority_type_override}}if(sorts.indexOf("sli")>-1){priority_type="sli"}else if(sorts.indexOf("frecency")>-1){priority_type="frecency"}return{sorts:sorts,priority_type:priority_type}};$custom_sort_selects.on("change",function(){var ob=buildSortsAndPriorityType();updateChannelSort({priority_type:ob.priority_type,sorts:ob.sorts})});_$div.find(".channel_sort_remover").on("click",function(){$(this).prev().val("").trigger("change")});_$div.find("#custom_sort_btn").on("click",function(){var ob=buildSortsAndPriorityType(TS.model.channel_sort.priority_type);updateChannelSort({is_custom_sorted:true,priority_type:ob.priority_type,sorts:ob.sorts})});$custom_sort_simple_select.on("change",function(){updateChannelSort({priority_type:$custom_sort_simple_select.val()})});_$div.find("#default_sort_btn").on("click",function(){updateChannelSort({is_custom_sorted:false,sorts:[]})});$("#priority_display_cb").on("change",function(){updateChannelSort({priority_display:!!$(this).prop("checked")})});_$div.find('input:radio[name="sidebar_theme_rd"]').on("change",function(){var name=$(this).val();var custom_values=TS.sidebar_themes.default_themes[name];_updateThemePrefsOptimistically(name,custom_values)});_$div.find("input.color_hex").on("textchange",function(){var hex=$.trim($(this).val());if(!hex.match(TS.prefs.hex_regex)){clearTimeout(_theme_throttle_tim);return}if(hex.indexOf("#")!==0){hex="#"+hex}$(this).prev(".color_swatch").css("background-color",hex).data("hex",hex);clearTimeout(_theme_throttle_tim);_theme_throttle_tim=setTimeout(function(){var name="custom_theme";var custom_values={column_bg:_$div.find('input[name="color_column_bg_hex"]').val(),menu_bg:_$div.find('input[name="color_menu_bg_hex"]').val(),active_item:_$div.find('input[name="color_active_item_hex"]').val(),active_item_text:_$div.find('input[name="color_active_item_text_hex"]').val(),hover_item:_$div.find('input[name="color_hover_item_hex"]').val(),text_color:_$div.find('input[name="color_text_color_hex"]').val(),active_presence:_$div.find('input[name="color_active_presence_hex"]').val(),badge:_$div.find('input[name="color_badge_hex"]').val()};$.each(custom_values,function(index,hex){if(hex[0]!=="#"){custom_values[index]="#"+hex}});_updateThemePrefsOptimistically(name,custom_values)},250)});_$div.find("#sidebar_theme_custom").on("textchange",function(e){var $custom_input=$(this);setTimeout(function(){var custom_input=$.trim($custom_input.val());var custom_arr=custom_input.replace(/ /g,"").split(",");var valid_values=true;$.each(custom_arr,function(index,hex){if(!hex.match(TS.prefs.hex_regex)){valid_values=false}if(!valid_values)return});if(!valid_values){clearTimeout(_theme_throttle_tim);return}var custom_values={column_bg:custom_arr[0],menu_bg:custom_arr[1],active_item:custom_arr[2],active_item_text:custom_arr[3],hover_item:custom_arr[4],text_color:custom_arr[5],active_presence:custom_arr[6],badge:custom_arr[7]};$.each(custom_values,function(index,hex){if(hex[0]!=="#"){custom_values[index]="#"+hex}});clearTimeout(_theme_throttle_tim);_theme_throttle_tim=setTimeout(function(){_updateThemePrefsOptimistically("custom_theme",custom_values)},250)},0)});_$div.find(".color_swatch").on("click.show_picker",function(e){e.stopPropagation();var $swatch=$(this);var $hex_input=$swatch.next("input");_$div.find(".color_swatch.selected").removeClass("selected").find(".colpick").addClass("hidden");var init_color=$swatch.data("hex").replace("#","");$swatch.colpick({flat:true,layout:"hex",color:init_color,submit:0,onChange:function(hsb,hex,rgb,el,bySetColor){$swatch.css("background-color","#"+hex).data("hex","#"+hex);$hex_input.val("#"+hex);clearTimeout(_theme_throttle_tim);_theme_throttle_tim=setTimeout(function(){var name="custom_theme";var custom_values={column_bg:_$div.find('input[name="color_column_bg_hex"]').val(),menu_bg:_$div.find('input[name="color_menu_bg_hex"]').val(),active_item:_$div.find('input[name="color_active_item_hex"]').val(),active_item_text:_$div.find('input[name="color_active_item_text_hex"]').val(),hover_item:_$div.find('input[name="color_hover_item_hex"]').val(),text_color:_$div.find('input[name="color_text_color_hex"]').val(),active_presence:_$div.find('input[name="color_active_presence_hex"]').val(),badge:_$div.find('input[name="color_badge_hex"]').val()};_updateThemePrefsOptimistically(name,custom_values)},500)}}).colpickSetColor(init_color);_$div.on("click.hide_colpick",function(){_$div.find(".color_swatch.selected").removeClass("selected").find(".colpick").addClass("hidden")});$swatch.addClass("selected").find(".colpick").removeClass("hidden")});$("#customize_theme_toggle").on("click",function(){$("#customize_theme_info").addClass("hidden");$("#prefs_themes_customize").removeClass("hidden");_show_customization_ui=true})};var _bindLabsPrefs=function(){$("#tab_ui_return_selects_cb").prop("checked",TS.model.prefs.tab_ui_return_selects===true);$("#tab_ui_return_selects_cb").on("change",function(){var val=!!$(this).prop("checked");TS.prefs.setPrefByAPI({name:"tab_ui_return_selects",value:val})});$("#comma_key_prefs_cb").prop("checked",TS.model.prefs.comma_key_prefs===true);$("#comma_key_prefs_cb").on("change",function(){var val=!!$(this).prop("checked");TS.prefs.setPrefByAPI({name:"comma_key_prefs",value:val})});$("#full_text_extracts_cb").prop("checked",TS.model.prefs.full_text_extracts===true);$("#full_text_extracts_cb").on("change",function(){var val=!!$(this).prop("checked");TS.model.prefs.full_text_extracts=val;TS.prefs.setPrefByAPI({name:"full_text_extracts",value:val})});$("#msg_preview_cb").prop("checked",TS.model.prefs.msg_preview===true);$("#msg_preview_cb").on("change",function(){var val=!!$(this).prop("checked");TS.prefs.setPrefByAPI({name:"msg_preview",value:val});$("#msg_preview_persistent_cb").prop("disabled",!val);TS.prefs.onPrefChanged({name:"msg_preview",value:val})});$("#msg_preview_persistent_cb").prop("checked",TS.model.prefs.msg_preview_persistent===true);$("#msg_preview_persistent_cb").prop("disabled",!TS.model.prefs.msg_preview);$("#msg_preview_persistent_cb").on("change",function(){var val=!!$(this).prop("checked");TS.prefs.setPrefByAPI({name:"msg_preview_persistent",value:val});TS.prefs.onPrefChanged({name:"msg_preview_persistent",value:val})});$("#flex_resize_window_cb").prop("checked",TS.model.prefs.flex_resize_window===true);$("#flex_resize_window_cb").on("change",function(){var val=!!$(this).prop("checked");TS.model.prefs.flex_resize_window=val;TS.prefs.setPrefByAPI({name:"flex_resize_window",value:val})});$("#hotness_cb").prop("checked",TS.model.prefs.hotness===true);$("#hotness_cb").on("change",function(){var val=!!$(this).prop("checked");TS.prefs.setPrefByAPI({name:"hotness",value:val});TS.prefs.onPrefChanged({name:"hotness",value:val})});$("#no_flex_in_history_cb").prop("checked",TS.model.prefs.no_flex_in_history===true);$("#no_flex_in_history_cb").on("change",function(){var val=!!$(this).prop("checked");TS.prefs.setPrefByAPI({name:"no_flex_in_history",value:val},function(){TS.reload()});TS.prefs.onPrefChanged({name:"no_flex_in_history",value:val})});$("#attachments_with_borders_cb").prop("checked",TS.model.prefs.attachments_with_borders===true);$("#attachments_with_borders_cb").on("change",function(){var val=!!$(this).prop("checked");TS.prefs.setPrefByAPI({name:"attachments_with_borders",value:val});TS.prefs.onPrefChanged({name:"attachments_with_borders",value:val})});$("#measure_css_usage_cb").prop("checked",TS.model.prefs.measure_css_usage===true);$("#measure_css_usage_cb").on("change",function(){var val=!!$(this).prop("checked");TS.prefs.setPrefByAPI({name:"measure_css_usage",value:val});TS.prefs.onPrefChanged({name:"measure_css_usage",value:val})});if(TS.model.is_electron){$("#show_memory_instrument_cb").prop("checked",TS.model.prefs.show_memory_instrument===true);$("#show_memory_instrument_cb").on("change",function(){var val=!!$(this).prop("checked");TS.prefs.setPrefByAPI({name:"show_memory_instrument",value:val});TS.prefs.onPrefChanged({name:"show_memory_instrument",value:val})})}if(_show_speech_settings){$("#speak_growls_cb").on("change",function(){var val=!!$(this).prop("checked");TS.prefs.setPrefByAPI({name:"speak_growls",value:val})});$("#mac_speak_voice_select").on("change",function(){var val=$(this).val();TS.model.prefs.mac_speak_voice=val;TS.prefs.setPrefByAPI({name:"mac_speak_voice",value:val});$("#mac_speak_test").trigger("click")});$("#mac_speak_speed_select").on("change",function(){var val=parseInt($(this).val());TS.model.prefs.mac_speak_speed=val;TS.prefs.setPrefByAPI({name:"mac_speak_speed",value:val});$("#mac_speak_test").trigger("click")});$("#mac_speak_test").on("click",function(){if(!TS.ui.growls.speakQ.length){TS.ui.growls.speak("Time flies like an arrow, fruit flies like a banana.",true,TS.model.prefs.mac_speak_voice,TS.model.prefs.mac_speak_speed)}})}};var _bindMacSSBPrefs=function(){$("#mac_ssb_bounce_cb").prop("checked",!!TS.model.prefs.mac_ssb_bounce);$("#mac_ssb_bounce_short_cb").prop("checked",TS.model.prefs.mac_ssb_bounce!="long");$("#mac_ssb_bounce_cb").on("change",function(){var val=!!$(this).prop("checked");var short_val=!!$("#mac_ssb_bounce_short_cb").prop("checked");TS.model.prefs.mac_ssb_bounce=val?short_val?"short":"long":"";TS.prefs.setPrefByAPI({name:"mac_ssb_bounce",value:TS.model.prefs.mac_ssb_bounce});_updateBounceShortCB()});$("#mac_ssb_bounce_short_cb").on("change",function(){var val=!!$(this).prop("checked");TS.prefs.setPrefByAPI({name:"mac_ssb_bounce",value:val?"short":"long"})});$("#mac_ssb_bullet_cb").prop("checked",TS.model.prefs.mac_ssb_bullet===true);$("#mac_ssb_bullet_cb").on("change",function(){var val=!!$(this).prop("checked");TS.prefs.setPrefByAPI({name:"mac_ssb_bullet",value:val})})};var _bindWinSSBPrefs=function(){if(window.TSSSB&&TSSSB.call("hasPreference","windowFlashBehavior")){$('input:radio[name="winssb_flash_window_rd"]').filter('[value="'+TSSSB.call("getPreference","windowFlashBehavior")+'"]').prop("checked",true);$('input:radio[name="winssb_flash_window_rd"]').on("change",function(){var val=$(this).val();TSSSB.call("setPreference",{name:"windowFlashBehavior",value:val});$('input:radio[name="winssb_flash_window_rd"]').filter('[value="'+val+'"]').prop("checked",true)})}else{$("#winssb_flash_window_heading").addClass("hidden");$("#winssb_flash_window_choices").addClass("hidden")}if(window.TSSSB&&TSSSB.call("hasPreference","notifyPosition")){var pos=TSSSB.call("getPreference","notifyPosition");$("#winssb_notify_corner").val(pos.corner);$("#winssb_notify_corner").on("change",function(){var corner=$(this).val();var display=$("#winssb_notify_display").val();TSSSB.call("setPreference",{name:"notifyPosition",value:{corner:corner,display:display}})});$("#winssb_notify_display").val(pos.display);$("#winssb_notify_display").on("change",function(){var corner=$("#winssb_notify_corner").val();var display=$(this).val();TSSSB.call("setPreference",{name:"notifyPosition",value:{corner:corner,display:display}})})}else{$("#winssb_notify_prefs_heading").addClass("hidden");$("#winssb_notify_position").addClass("hidden")}};var _bindWinLinSSBPrefs=function(){$("#winssb_launch_on_start_cb").prop("checked",TSSSB.call("getPreference","launchOnStartup"));$("#winssb_launch_on_start_cb").on("change",function(){var val=!!$(this).prop("checked");TSSSB.call("setPreference",{name:"launchOnStartup",value:val})});$("#winssb_run_from_tray_cb").prop("checked",TSSSB.call("getPreference","runFromTray"));$("#winssb_run_from_tray_cb").on("change",function(){var val=!!$(this).prop("checked");TSSSB.call("setPreference",{name:"runFromTray",value:val})});if(window.TSSSB&&TSSSB.call("hasPreference","useHwAcceleration")){$("#winssb_disable_hw_acceleration_cb").prop("checked",!TSSSB.call("getPreference","useHwAcceleration"));$("#winssb_disable_hw_acceleration_cb").on("change",function(){var val=!$(this).prop("checked");TSSSB.call("setPreference",{name:"useHwAcceleration",value:val})})}else{$("#winssb_disable_hw_acceleration_pref").addClass("hidden");$("#winssb_disable_hw_acceleration_note").addClass("hidden")}};var _bindPrefsRollups=function(){_$div.find(".section_rollup").on("click",function(e){var $el=$(e.target);var $prefs_rollup_el=$(this);var rollup_id=$prefs_rollup_el.attr("id");var was_active=$prefs_rollup_el.hasClass("is_active");if($el.closest(".section_rollup_header").length){$prefs_rollup_el.toggleClass("is_active");if(was_active){_updateNotificationSummary();_updateDnDSummary()}if(!TS.environment.supports_custom_scrollbar)TS.ui.utility.updateClosestMonkeyScroller(_$div_contents)}else if(!$prefs_rollup_el.hasClass("is_active")){$prefs_rollup_el.toggleClass("is_active");if(!TS.environment.supports_custom_scrollbar)TS.ui.utility.updateClosestMonkeyScroller(_$div_contents)}if($prefs_rollup_el.hasClass("is_active")){_expanded_rollups.push(rollup_id);_expanded_rollups=_.uniq(_expanded_rollups)}else{_.remove(_expanded_rollups,function(rollup){return rollup===rollup_id})}})};var _expandRollup=function(selector){var $rollup=$("#"+selector);if($rollup.length)$rollup.addClass("is_active")};var _updateNotificationControls=function(){if(!_is_open)return;var send_notifications_for=_getSendNotificationsForPref();$("#growls_test").css("visibility","");$('input:radio[name="notifications_rd"]').filter('[value="'+send_notifications_for+'"]').prop("checked",true);var non_default_html=TS.templates.builders.buildNonDefaultNotificationBlock("margin-left");if(non_default_html){$(".non_default").removeClass("hidden");$("#non_default_html").html(non_default_html);$("#no_non_default").addClass("hidden")}else{$(".non_default").addClass("hidden");$("#no_non_default").removeClass("hidden")}$("#non_default_tip_link").tooltip("destroy").attr("title",TS.templates.builders.buildNonDefaultNotificationBlock("align_left")).tooltip({html:true});if(send_notifications_for=="never"){$("#no_text_in_notifications_cb").prop("disabled",true).prop("checked",false).closest("label").addClass("disabled")}else{$("#no_text_in_notifications_cb").prop("disabled",false).prop("checked",TS.model.prefs.no_text_in_notifications!==true).closest("label").removeClass("disabled")}$('input:radio[name="sound_option_rd"]').each(function(){if($(this).val()==TS.model.prefs.new_msg_snd){$(this).attr("checked",true)}});if(TS.model.prefs.mute_sounds){_$div.find('input:radio[name="sound_option_rd"]').attr("disabled","disabled");_$div.find("label.sound_option").addClass("disabled")}else{_$div.find('input:radio[name="sound_option_rd"]').removeAttr("disabled");_$div.find("label.sound_option").removeClass("disabled")}_updateNotificationSummary();_updateDnDSummary()};var _getSendNotificationsForPref=function(){var send_notifications_for="all";if(!TS.model.prefs.growls_enabled){send_notifications_for="never"}else if(!TS.model.prefs.all_channels_loud){send_notifications_for="mentions"}return send_notifications_for};var _updateNotificationSummary=function(){var template_args={send_notifications_for:_getSendNotificationsForPref(),mute_sounds:TS.model.prefs.mute_sounds,new_msg_snd:TS.sounds.getNotificationSoundNameFromFilename(TS.model.prefs.new_msg_snd)||"none",no_text_in_notifications:TS.model.prefs.no_text_in_notifications,show_mac_ssb_prefs:_show_mac_ssb_prefs,show_win_ssb_prefs:_show_win_ssb_prefs};if(_show_mac_ssb_prefs){template_args.show_mac_ssb_bullet=TS.model.prefs.mac_ssb_bullet;template_args.mac_ssb_bounce=!!TS.model.prefs.mac_ssb_bounce;template_args.mac_ssb_bounce_short=!!TS.model.prefs.mac_ssb_bounce&&TS.model.prefs.mac_ssb_bounce!="long"}if(_show_win_ssb_prefs){template_args.window_flash_behavior=TSSSB.call("getPreference","windowFlashBehavior");if(window.TSSSB&&TSSSB.call("hasPreference","notifyPosition")){template_args.show_notify_position=true;template_args.winssb_notify_corner=TSSSB.call("getPreference","notifyPosition").corner;template_args.winssb_notify_display=TSSSB.call("getPreference","notifyPosition").display}}var notifications_summary_html=TS.templates.prefs_notifications_summary(template_args);_$div.find("#prefs_notifications").find(".section_rollup_summary").html(notifications_summary_html)};var _updateDnDSummary=function(){var props=_getDndProps();var start=props.dnd_start_hour;var end=props.dnd_end_hour;if(!TS.model.prefs.time24){start=_to12h(start);end=_to12h(end)}var dnd_summary_html=TS.templates.prefs_dnd_summary({dnd_enabled:props.dnd_enabled,dnd_start_hour:start,dnd_end_hour:end,timezone:TS.model.user.tz_label});_$div.find("#prefs_dnd").find(".section_rollup_summary").html(dnd_summary_html)};var _to12h=function(time_string){var match=/(\d?\d):(\d\d)/.exec(time_string);if(!match)return time_string;var h=parseInt(match[1],10);var m=match[2];var ampm="AM";if(h>12){ampm="PM";h-=12}else if(h==0){h=12}else if(h==12){ampm="PM"}return h+":"+m+" "+ampm};var _onGrowlsPermissionLinkClick=function(){$("#growls_permission_div").addClass("hidden");$("#growls_instructions_div").removeClass("hidden");TS.ui.growls.promptForPermission(function(allowed,permission_level){TS.info("callback called allowed:"+allowed+" permission_level:"+permission_level);$("#growls_instructions_div").addClass("hidden");if(permission_level=="granted"&&allowed){$("#growls_allowed_div").removeClass("hidden").find(".desktop_notifications_title").addClass("kelly_green").text("Desktop Notifications enabled!");$("#growls_test").removeClass("hidden");if(!TS.model.prefs.growls_enabled){TS.prefs.setPrefByAPI({name:"growls_enabled",value:true});TS.model.prefs.growls_enabled=true}_updateNotificationControls()}else if(permission_level=="default"){$("#growls_permission_div").removeClass("hidden")}else if(permission_level=="denied"){$("#growls_disallowed_div").removeClass("hidden")}else{alert("huh allowed:"+allowed+" permission_level:"+permission_level)}})};var _updateRealNameControls=function(){if(!_is_open)return;var $display_real_names_override_cb=$("#display_real_names_override_cb");$display_real_names_override_cb.prop("checked",TS.members.shouldDisplayRealNames());if(TS.model.team.prefs.display_real_names){$("#display_real_names_default").removeClass("hidden");$("#display_usernames_default").addClass("hidden")}else{$("#display_real_names_default").addClass("hidden");$("#display_usernames_default").removeClass("hidden")}};var _updatePreferredNameControls=function(){if(!_is_open)return;var $display_preferred_names_cb=$("#display_preferred_names_cb");$display_preferred_names_cb.prop("checked",!TS.members.shouldDisplayPreferredNames())};var _highlight_words_p=null;var _saveHighlightWords=function(){if(_highlight_words_p)_highlight_words_p.cancel();_highlight_words_p=TS.prefs.saveHighlightWords(_$div.find("#highlight_words_input").val());_highlight_words_p.finally(function(){_highlight_words_p=null})};var _buildSearchPrefsData=function(){var active_channels=[];var archived_channels=[];var search_channel_exclusion;if(TS.model.deferred_archived_channels){TS.model.deferred_archived_channels.slice().forEach(function(channel){TS.channels.getChannelById(channel.id)})}var channels=TS.channels.getChannelsForUser();channels.sort(function compare(a,b){var a_srt=a._name_lc;var b_srt=b._name_lc;if(a_srt<b_srt)return-1;if(a_srt>b_srt)return 1;return 0});for(var i in channels){var c=channels[i];search_channel_exclusion=false;if($.inArray(c.id,TS.model.search_exclude_channels)!=-1)search_channel_exclusion=true;if(c.is_archived){archived_channels.push({search_channel_exclusion:search_channel_exclusion,channel:c})}else{active_channels.push({search_channel_exclusion:search_channel_exclusion,channel:c})}}return{active_channels:active_channels,archived_channels:archived_channels}};var _updateReadControls=function(){if(!_is_open)return;var val=TS.prefs.getReadStateTrackingPref();$('input:radio[name="read_rd"]').filter('[value="'+val+'"]').prop("checked",true)};var _showSidebar=function(){$("#fs_modal, #fs_modal_bg").addClass("show_sidebar");if(!TS.boot_data.feature_sli_channel_priority)$("#fs_modal_bg").append('<div id="sidebar_overlay"></div>')};var _hideSidebar=function(){$("#fs_modal, #fs_modal_bg").removeClass("show_sidebar");$("#sidebar_overlay").remove();setTimeout(function(){TS.view.resizeManually()},TS.ui.fs_modal.transition_duration)};var _updateThemeControls=function(remove_last_theme_selected){if(!_is_open)return;remove_last_theme_selected=remove_last_theme_selected!==false;if(TS.prefs.last_theme_selected_in_UI&&TS.model.prefs.sidebar_theme!==TS.prefs.last_theme_selected_in_UI){return}else if(TS.prefs.last_theme_selected_in_UI&&remove_last_theme_selected){TS.prefs.last_theme_selected_in_UI=null}if(TS.model.prefs.sidebar_theme=="default"){TS.model.prefs.sidebar_theme="default_theme"}var val=TS.model.prefs.sidebar_theme;$('input:radio[name="sidebar_theme_rd"]').filter('[value="'+val+'"]').prop("checked",true);if(TS.model.prefs.sidebar_theme_custom_values&&TS.model.prefs.sidebar_theme_custom_values!="undefined"){var theme_values_ob=JSON.parse(TS.model.prefs.sidebar_theme_custom_values);var theme_values_arr=$.map(theme_values_ob,function(val){return val});if(_$div){_$div.find('input[name="color_column_bg_hex"]').val(theme_values_ob.column_bg);_$div.find('input[name="color_menu_bg_hex"]').val(theme_values_ob.menu_bg);_$div.find('input[name="color_active_item_hex"]').val(theme_values_ob.active_item);_$div.find('input[name="color_active_item_text_hex"]').val(theme_values_ob.active_item_text);_$div.find('input[name="color_hover_item_hex"]').val(theme_values_ob.hover_item);_$div.find('input[name="color_text_color_hex"]').val(theme_values_ob.text_color);_$div.find('input[name="color_active_presence_hex"]').val(theme_values_ob.active_presence);_$div.find('input[name="color_badge_hex"]').val(theme_values_ob.badge);_$div.find('.color_swatch[data-theme-element="column_bg"]').css("background-color",theme_values_ob.column_bg).data("hex",theme_values_ob.column_bg);_$div.find('.color_swatch[data-theme-element="menu_bg"]').css("background-color",theme_values_ob.menu_bg).data("hex",theme_values_ob.menu_bg);_$div.find('.color_swatch[data-theme-element="active_item"]').css("background-color",theme_values_ob.active_item).data("hex",theme_values_ob.active_item);_$div.find('.color_swatch[data-theme-element="active_item_text"]').css("background-color",theme_values_ob.active_item_text).data("hex",theme_values_ob.active_item_text);_$div.find('.color_swatch[data-theme-element="hover_item"]').css("background-color",theme_values_ob.hover_item).data("hex",theme_values_ob.hover_item);_$div.find('.color_swatch[data-theme-element="text_color"]').css("background-color",theme_values_ob.text_color).data("hex",theme_values_ob.text_color);_$div.find('.color_swatch[data-theme-element="active_presence"]').css("background-color",theme_values_ob.active_presence).data("hex",theme_values_ob.active_presence);_$div.find('.color_swatch[data-theme-element="badge"]').css("background-color",theme_values_ob.badge).data("hex",theme_values_ob.badge);$("#sidebar_theme_custom").val(theme_values_arr.join(","))}}};var _updateThemePrefsOptimistically=function(name,custom_values){var remove_last_theme_selected=false;TS.prefs.last_theme_selected_in_UI=name;TS.prefs.setMultiPrefsByAPI({sidebar_theme:name,sidebar_theme_custom_values:JSON.stringify(custom_values)});TS.model.prefs.sidebar_theme=name;TS.prefs.setSidebarThemeCustomValues(custom_values);_updateThemeControls(remove_last_theme_selected);TS.view.prefs.sidebarThemePrefChanged(remove_last_theme_selected)};var _updateBounceShortCB=function(){if(!!TS.model.prefs.mac_ssb_bounce){$("#mac_ssb_bounce_short_cb").prop("disabled",false)}else{$("#mac_ssb_bounce_short_cb").prop("disabled",true)}};var _updateMacSpeakControls=function(){if(!_is_open)return;$("#speak_growls_cb").prop("checked",TS.model.prefs.speak_growls===true);$("#mac_speak_voice_select").val(TS.model.prefs.mac_speak_voice);$("#mac_speak_speed_select").val(TS.model.prefs.mac_speak_speed)};var _memberTzChanged=function(member){if(!member.is_self)return;if(!_is_open)return;$(".dnd_tz_label").text(TS.model.user.tz_label)};var _tzPrefChanged=function(){if(!_is_open)return;if(TS.model.prefs.tz)$("#prefs_dnd").removeClass("tz_not_set")};var _updateChannelSortControls=function(){var channel_sort=TS.model.channel_sort;_$div.find(".has_custom_sort").toggleClass("hidden",!channel_sort.is_custom_sorted);_$div.find(".no_custom_sort").toggleClass("hidden",!!channel_sort.is_custom_sorted);$("#priority_display_cb").prop("checked",channel_sort.priority_display===true);$("#priority_display_cb").prop("disabled",!channel_sort.priority_type);$("#priority_display_cb").parent().toggleClass("disabled",!channel_sort.priority_type);if(channel_sort.is_custom_sorted){_$div.find(".custom_sort_select").each(function(i){var val=channel_sort.sorts[i]||"";$(this).val(val);$(this).data("prev_value",val);$(this).next(".channel_sort_remover").toggleClass("hidden",!val)})}else{_$div.find("#custom_sort_simple_select").val(channel_sort.priority_type)}_$div.find(".custom_sort_select option").each(function(i){var $select=$(this).parent();var $option=$(this);var val=$option.val();var sorts_already_contain_this_option=val&&channel_sort.sorts.indexOf(val)>-1;var should_hide_option=false;var select_val_is_for_unreads=($select.val()||"").indexOf("unread_")>-1;var select_val_is_for_ranking=$select.val()=="frecency"||$select.val()=="sli";if(val=="sli"||val=="frecency"){sorts_already_contain_this_option=channel_sort.sorts.indexOf("sli")>-1||channel_sort.sorts.indexOf("frecency")>-1;if(sorts_already_contain_this_option&&!$option.is(":selected")&&!select_val_is_for_ranking){should_hide_option=true}}else if((val||"").indexOf("unread_")>-1){sorts_already_contain_this_option=channel_sort.sorts.indexOf("has_unread_mentions")>-1||channel_sort.sorts.indexOf("has_unread_msgs")>-1||channel_sort.sorts.indexOf("unread_msgs_count")>-1||channel_sort.sorts.indexOf("unread_mentions_count")>-1;if(sorts_already_contain_this_option&&!$option.is(":selected")&&!select_val_is_for_unreads){should_hide_option=true}}else{if(sorts_already_contain_this_option&&!$option.is(":selected")){should_hide_option=true}}if(should_hide_option){$option.addClass("hidden")}else{$option.removeClass("hidden")}})};var _bindSidebarBehaviorPrefs=function(){$('input:radio[name="pr_sidebar"]').filter('[value="'+TS.model.prefs.sidebar_behavior+'"]').prop("checked",true);$('input:radio[name="pr_sidebar"]').on("change",function(){var val=$(this).val();TS.prefs.setPrefByAPI({name:"sidebar_behavior",value:val});TS.prefs.onPrefChanged({name:"sidebar_behavior",value:val})});$("#separate_private_channels_cb").prop("checked",TS.model.prefs.separate_private_channels===true);$("#separate_private_channels_cb").on("change",function(){var val=!!$(this).prop("checked");TS.prefs.setPrefByAPI({name:"separate_private_channels",value:val})})}})();(function(){"use strict";TS.registerModule("ui.mpim_conversion_modal",{onStart:function(){},startMpimConversionModal:function(model_ob){_mpim=model_ob;var members=TS.mpims.getMembersInDisplayOrder(_mpim);var uras=_.filter(members,{is_ultra_restricted:true});var html=TS.templates.mpim_conversion_modal({members:members,uras:uras});TS.ui.fs_modal.start({body_template_html:html,onShow:_onShow,onEnd:_onEnd,modal_class:"mpim_conversion_modal",onGo:_advanceToConversionStep})},go:function(){var validated=TS.channels.ui.channelCreateDialogValidateInput(_$modal_container);if(!validated)return;if(_ladda)_ladda.start();var title=_$modal_container.find(".title_input").val();TS.mpims.convertToGroup(_mpim,title).then(function(){TS.ui.fs_modal.close()},function(response){if(_ladda)_ladda.stop();var data=response.data;var error=data&&data.error;if(error==="name_taken"){TS.channels.ui.channelCreateDialogShowNameTakenAlert(_$modal_container)}else if(error==="restricted_action"){TS.channels.ui.channelCreateDialogShowOtherErrorAlert(_$modal_container,"Sorry! An admin on your team has restricted who can create private channels.")}else{if(error)TS.error("mpim.convertToGroup for "+_mpim.id+" returned "+error);TS.channels.ui.channelCreateDialogShowOtherErrorAlert(_$modal_container,"Sorry! Something went wrong.")}});return false}});var _$modal_container;var _ladda;var _mpim;var _onShow=function(){_$modal_container=$(".mpim_conversion_modal");_$modal_container.on("click",".continue",function(){_advanceToConversionStep()});_$modal_container.find(".convert_mpim_go").click(TS.ui.mpim_conversion_modal.go);var $input=_$modal_container.find(".title_input");$input.keydown(function(e){if(e.which===TS.utility.keymap.enter){TS.ui.mpim_conversion_modal.go()}else if(e.which===TS.utility.keymap.esc){TS.ui.fs_modal.close()}})};var _advanceToConversionStep=function(){if(!$("#conversion_step").hasClass("hidden"))return TS.ui.mpim_conversion_modal.go();$("#confirmation_step").addClass("hidden");$("#conversion_step").removeClass("hidden");_ladda=Ladda.create(_$modal_container.find(".convert_mpim_go")[0]);_$modal_container.find(".title_input").focus();return false};var _onEnd=function(){_cleanup()};var _cleanup=function(){_$modal_container=null;_ladda=null;_mpim=null}})();"use strict";function timezones_list(){var tz=new TimezoneDetector;return tz.getList();
}function timezones_guess(){var tz=new TimezoneDetector;var opts={};if(arguments.length>0)opts.default=arguments[0];var ret=tz.detect(opts);return ret.zoneId}(function(){var root=this;var previous_detector=root.TimezoneDetector;var tz=function(){var self=this;self.getList=function(){return _list};self.detect=function(opts){var out={zoneId:"America/Los_Angeles",method:"gave_up"};if(opts&&opts.default){out.zoneId=opts.default;out.method="default"}out.intl=_try_using_api();var api_guess=out.intl.zoneId;if(api_guess){for(var i=0;i<_list.length;i++){if(_list[i][1]==api_guess){out.zoneId=api_guess;out.method="intlapi_exact";return out}}if(_manual_alts[api_guess]){out.zoneId=_manual_alts[api_guess];out.method="intl_api_manual";return out}if(_auto_alts[api_guess]){out.zoneId=_auto_alts[api_guess];out.method="intl_api_equivalent";return out}if(_fallback_alts[api_guess]){out.zoneId=_fallback_alts[api_guess];out.method="intl_api_fallback";return out}}out.probe=_try_using_probe();if(out.probe.zoneId){out.zoneId=out.probe.zoneId;out.method="date_probe";return out}return out};var _try_using_api=function(){var out={zoneId:null,hasIntl:false,hasDateTime:false,hasOptions:false};try{if(typeof Intl==="undefined")return out;out.hasIntl=true;if(typeof Intl.DateTimeFormat==="undefined")return out;var format=Intl.DateTimeFormat();if(typeof format==="undefined")return out;out.hasDateTime=true;if(typeof format.resolvedOptions==="undefined")return out;out.hasOptions=true;out.zoneId=format.resolvedOptions().timeZone}catch(e){return out}return out};var _try_using_probe=function(){var key_parts=[];key_parts.push(-1*new Date(Date.UTC(2008,10,27,0,0,0,0)).getTimezoneOffset());key_parts.push(-1*new Date(Date.UTC(2010,4,30,0,0,0,0)).getTimezoneOffset());key_parts.push(-1*new Date(Date.UTC(2001,10,28,0,0,0,0)).getTimezoneOffset());key_parts.push(-1*new Date(Date.UTC(2002,4,7,0,0,0,0)).getTimezoneOffset());key_parts.push(-1*new Date(Date.UTC(2004,10,3,0,0,0,0)).getTimezoneOffset());key_parts.push(-1*new Date(Date.UTC(2011,11,7,0,0,0,0)).getTimezoneOffset());key_parts.push(-1*new Date(Date.UTC(2012,11,10,0,0,0,0)).getTimezoneOffset());key_parts.push(-1*new Date(Date.UTC(2015,9,22,0,0,0,0)).getTimezoneOffset());key_parts.push(-1*new Date(Date.UTC(2015,11,2,0,0,0,0)).getTimezoneOffset());key_parts.push(-1*new Date(Date.UTC(2016,3,27,0,0,0,0)).getTimezoneOffset());for(var i=1;i<=key_parts.length;i++){var key=key_parts.slice(0,i).join(":");if(_map[key]){return{zoneId:_map[key],probeKey:key,fullKey:key_parts.join(":")}}}return{zoneId:null,fullKey:key_parts.join(":")}};var _map={"-660:-660:-660:-660:-660:-660":"Pacific/Midway","-540":"America/Adak","-600":"Pacific/Honolulu","-570":"Pacific/Marquesas","-480:-480":"America/Anchorage","-480:-420":"America/Tijuana","-420:-420:-420:-480":"America/Los_Angeles","-420:-420:-420:-420":"America/Phoenix","-420:-360":"America/Chihuahua","-360:-360:-360:-420":"America/Denver","-360:-360:-360:-360":"America/Regina","-300:-300:-300:-360":"America/Chicago","-300:-360":"Pacific/Easter","-360:-300:-360:-360:-300:-360:-360:-300:-360":"America/Mexico_City","-300:-300:-300:-300:-300:-300:-300:-300":"America/Bogota","-360:-300:-360:-360:-300:-360:-360:-300:-300":"America/Cancun","-240:-240:-240:-300:-240:-300:-300:-240:-300":"America/New_York","-300:-300:-300:-300:-300:-300:-300:-240":"America/Port-au-Prince","-300:-240":"America/Havana","-240:-240:-300":"America/Indiana/Indianapolis","-180:-240:-180:-180":"America/Asuncion","-180:-180:-180:-240":"America/Halifax","-270":"America/Caracas","-180:-240:-180:-240:-240:-180:-180:-240":"America/Cuiaba","-240:-240:-240:-240":"America/Manaus","-180:-240:-180:-240:-240:-180:-180:-180":"America/Santiago","-240:-240:-240:-300:-240:-300:-300:-240:-240":"America/Grand_Turk","-150":"America/St_Johns","-180:-180:-120:-180:-180:-180":"America/Fortaleza","-120:-180:-120":"America/Sao_Paulo","-180:-180:-180:-180":"America/Cayenne","-120:-180:-180:-180:-180":"America/Buenos_Aires","-180:-120":"America/Godthab","-120:-180:-180:-180:-120":"America/Montevideo","-120:-120:-120":"America/Miquelon","-180:-180:-120:-180:-180:-120":"America/Bahia","-120:-120:-60":"America/Noronha","-60:0":"Atlantic/Azores","-60:-60":"Atlantic/Cape_Verde","0:0:0:0:0:0:0:60":"Africa/Casablanca","0:60":"Europe/London","0:0:0:0:0:0:0:0":"Africa/Monrovia","60:120":"Europe/Amsterdam","60:60":"Africa/Algiers","120:60":"Africa/Windhoek","180:180:120:180:180":"Asia/Amman","120:180:180":"Europe/Athens","120:180:120:180:180:120:120:180:120":"Asia/Beirut","120:180:120:120:120:120:120:120":"Africa/Cairo","180:180:120:180:120":"Asia/Damascus","120:180:120:120:120:120:120:180":"Asia/Gaza","120:120:120:120:120:120:120":"Africa/Harare","120:180:120:180:120":"Asia/Jerusalem","120:180:120:180:180:180:180:120":"Europe/Kaliningrad","120:120:120:120:120:120:60":"Africa/Tripoli","180:180:180:240":"Asia/Baghdad","120:180:120:180:180:120:120:180:180":"Asia/Istanbul","180:180:180:180":"Asia/Kuwait","120:180:120:180:180:180:180:180":"Europe/Minsk","180:240:180:240:240:240:240:180:180:180":"Europe/Moscow",210:"Asia/Tehran","240:240:240:240":"Asia/Muscat","180:240:180:240:240:240:240:180:180:240":"Europe/Astrakhan","240:300:240:300:300:240:240:300":"Asia/Baku","240:240:240:300:300":"Europe/Samara","300:240":"Indian/Mauritius","240:240:240:300:240":"Asia/Tbilisi","240:300:240:300:300:240:240:240":"Asia/Yerevan",270:"Asia/Kabul","300:300":"Asia/Tashkent","300:360":"Asia/Yekaterinburg","360:300":"Asia/Karachi","330:330:330":"Asia/Kolkata","330:330:360":"Asia/Colombo",345:"Asia/Katmandu","360:360:360:420":"Asia/Almaty","360:360:360:360":"Asia/Dhaka","360:420:360:420:420:420:420:360:360:360":"Asia/Novosibirsk",390:"Asia/Rangoon","420:420:420:420":"Asia/Bangkok","360:420:360:420:420:420:420:360:360:420":"Asia/Barnaul","420:420:420:480":"Asia/Hovd","420:480":"Asia/Krasnoyarsk","360:420:420":"Asia/Tomsk","480:480:480:480":"Asia/Chongqing","480:540":"Asia/Irkutsk","540:480":"Australia/Perth","480:480:480:540":"Asia/Ulaanbaatar","540:540:540:540:540:540:540:510":"Asia/Pyongyang",585:"Australia/Eucla","540:600:540:600:600:600:600:480":"Asia/Chita","540:540:540:540:540:540:540:540":"Asia/Tokyo","540:600:540:600:600:600:600:540":"Asia/Yakutsk",630:"Australia/Adelaide",570:"Australia/Darwin","600:600:600:600:600:600:600:600":"Australia/Brisbane","660:600:660:600:600":"Australia/Canberra","660:600:660:600:660":"Australia/Hobart","600:660:600:660:660:660:660:600:600:600":"Asia/Vladivostok","660:630":"Australia/Lord_Howe","600:600:600:600:600:600:600:660":"Pacific/Bougainville","660:720:660:720:720:720:720:660":"Asia/Srednekolymsk","660:720:660:720:720:720:720:600":"Asia/Magadan",690:"Pacific/Norfolk","600:660:600:660:660:660:660:600:600:660":"Asia/Sakhalin","660:660":"Pacific/Guadalcanal","720:720:720:780":"Asia/Anadyr","780:720":"Pacific/Auckland","720:720:720:720":"Pacific/Fiji",825:"Pacific/Chatham","780:780":"Pacific/Tongatapu","-660:-660:-660:-660:-660:-600":"Pacific/Apia",840:"Pacific/Kiritimati"};var _list=[["(UTC-11:00) Midway Island, American Samoa","Pacific/Midway"],["(UTC-10:00) Aleutian Islands","America/Adak"],["(UTC-10:00) Hawaii","Pacific/Honolulu"],["(UTC-09:30) Marquesas Islands","Pacific/Marquesas"],["(UTC-09:00) Alaska","America/Anchorage"],["(UTC-08:00) Baja California","America/Tijuana"],["(UTC-08:00) Pacific Time (US and Canada)","America/Los_Angeles"],["(UTC-07:00) Arizona","America/Phoenix"],["(UTC-07:00) Chihuahua, La Paz, Mazatlan","America/Chihuahua"],["(UTC-07:00) Mountain Time (US and Canada)","America/Denver"],["(UTC-06:00) Central America","America/Belize"],["(UTC-06:00) Central Time (US and Canada)	","America/Chicago"],["(UTC-06:00) Easter Island","Pacific/Easter"],["(UTC-06:00) Guadalajara, Mexico City, Monterrey","America/Mexico_City"],["(UTC-06:00) Saskatchewan","America/Regina"],["(UTC-05:00) Bogota, Lima, Quito","America/Bogota"],["(UTC-05:00) Chetumal","America/Cancun"],["(UTC-05:00) Eastern Time (US and Canada)","America/New_York"],["(UTC-05:00) Haiti","America/Port-au-Prince"],["(UTC-05:00) Havana","America/Havana"],["(UTC-05:00) Indiana (East)","America/Indiana/Indianapolis"],["(UTC-04:00) Asuncion","America/Asuncion"],["(UTC-04:00) Atlantic Time (Canada)","America/Halifax"],["(UTC-04:00) Caracas","America/Caracas"],["(UTC-04:00) Cuiaba","America/Cuiaba"],["(UTC-04:00) Georgetown, La Paz, Manaus, San Juan","America/Manaus"],["(UTC-04:00) Santiago","America/Santiago"],["(UTC-04:00) Turks and Caicos","America/Grand_Turk"],["(UTC-03:30) Newfoundland","America/St_Johns"],["(UTC-03:00) Araguaina","America/Fortaleza"],["(UTC-03:00) Brasilia","America/Sao_Paulo"],["(UTC-03:00) Cayenne, Fortaleza","America/Cayenne"],["(UTC-03:00) City of Buenos Aires","America/Buenos_Aires"],["(UTC-03:00) Greenland","America/Godthab"],["(UTC-03:00) Montevideo","America/Montevideo"],["(UTC-03:00) Saint Pierre and Miquelon","America/Miquelon"],["(UTC-03:00) Salvador","America/Bahia"],["(UTC-02:00) Fernando de Noronha","America/Noronha"],["(UTC-01:00) Azores","Atlantic/Azores"],["(UTC-01:00) Cabo Verde Islands","Atlantic/Cape_Verde"],["(UTC) Casablanca","Africa/Casablanca"],["(UTC) Dublin, Edinburgh, Lisbon, London","Europe/London"],["(UTC) Monrovia, Reykjavik","Africa/Monrovia"],["(UTC+01:00) Amsterdam, Berlin, Bern, Rome, Stockholm, Vienna","Europe/Amsterdam"],["(UTC+01:00) Belgrade, Bratislava, Budapest, Ljubljana, Prague","Europe/Belgrade"],["(UTC+01:00) Brussels, Copenhagen, Madrid, Paris","Europe/Brussels"],["(UTC+01:00) Sarajevo, Skopje, Warsaw, Zagreb","Europe/Warsaw"],["(UTC+01:00) West Central Africa","Africa/Algiers"],["(UTC+01:00) Windhoek","Africa/Windhoek"],["(UTC+02:00) Amman","Asia/Amman"],["(UTC+02:00) Athens, Bucharest","Europe/Athens"],["(UTC+02:00) Beirut","Asia/Beirut"],["(UTC+02:00) Cairo","Africa/Cairo"],["(UTC+02:00) Damascus","Asia/Damascus"],["(UTC+02:00) Gaza, Hebron","Asia/Gaza"],["(UTC+02:00) Harare, Pretoria","Africa/Harare"],["(UTC+02:00) Helsinki, Kiev, Riga, Sofia, Tallinn, Vilnius","Europe/Helsinki"],["(UTC+02:00) Jerusalem","Asia/Jerusalem"],["(UTC+02:00) Kaliningrad","Europe/Kaliningrad"],["(UTC+02:00) Tripoli","Africa/Tripoli"],["(UTC+03:00) Baghdad","Asia/Baghdad"],["(UTC+03:00) Istanbul","Asia/Istanbul"],["(UTC+03:00) Kuwait, Riyadh","Asia/Kuwait"],["(UTC+03:00) Minsk","Europe/Minsk"],["(UTC+03:00) Moscow, St. Petersburg, Volgograd","Europe/Moscow"],["(UTC+03:00) Nairobi","Africa/Nairobi"],["(UTC+03:30) Tehran","Asia/Tehran"],["(UTC+04:00) Abu Dhabi, Muscat","Asia/Muscat"],["(UTC+04:00) Astrakhan, Ulyanovsk","Europe/Astrakhan"],["(UTC+04:00) Baku","Asia/Baku"],["(UTC+04:00) Izhevsk, Samara","Europe/Samara"],["(UTC+04:00) Port Louis","Indian/Mauritius"],["(UTC+04:00) Tbilisi","Asia/Tbilisi"],["(UTC+04:00) Yerevan","Asia/Yerevan"],["(UTC+04:30) Kabul","Asia/Kabul"],["(UTC+05:00) Tashkent, Ashgabat","Asia/Tashkent"],["(UTC+05:00) Ekaterinburg","Asia/Yekaterinburg"],["(UTC+05:00) Islamabad, Karachi","Asia/Karachi"],["(UTC+05:30) Chennai, Kolkata, Mumbai, New Delhi","Asia/Kolkata"],["(UTC+05:30) Sri Jayawardenepura","Asia/Colombo"],["(UTC+05:45) Kathmandu","Asia/Katmandu"],["(UTC+06:00) Astana","Asia/Almaty"],["(UTC+06:00) Dhaka","Asia/Dhaka"],["(UTC+06:00) Novosibirsk","Asia/Novosibirsk"],["(UTC+06:30) Yangon (Rangoon)","Asia/Rangoon"],["(UTC+07:00) Bangkok, Hanoi, Jakarta","Asia/Bangkok"],["(UTC+07:00) Barnaul, Gorno-Altaysk","Asia/Barnaul"],["(UTC+07:00) Hovd","Asia/Hovd"],["(UTC+07:00) Krasnoyarsk","Asia/Krasnoyarsk"],["(UTC+07:00) Tomsk","Asia/Tomsk"],["(UTC+08:00) Beijing, Chongqing, Hong Kong SAR, Urumqi","Asia/Chongqing"],["(UTC+08:00) Irkutsk","Asia/Irkutsk"],["(UTC+08:00) Kuala Lumpur, Singapore","Asia/Kuala_Lumpur"],["(UTC+08:00) Perth","Australia/Perth"],["(UTC+08:00) Taipei","Asia/Taipei"],["(UTC+08:00) Ulaanbaatar","Asia/Ulaanbaatar"],["(UTC+08:30) Pyongyang","Asia/Pyongyang"],["(UTC+08:45) Eucla","Australia/Eucla"],["(UTC+09:00) Chita","Asia/Chita"],["(UTC+09:00) Osaka, Sapporo, Tokyo","Asia/Tokyo"],["(UTC+09:00) Seoul","Asia/Seoul"],["(UTC+09:00) Yakutsk","Asia/Yakutsk"],["(UTC+09:30) Adelaide","Australia/Adelaide"],["(UTC+09:30) Darwin","Australia/Darwin"],["(UTC+10:00) Brisbane","Australia/Brisbane"],["(UTC+10:00) Canberra, Melbourne, Sydney","Australia/Canberra"],["(UTC+10:00) Guam, Port Moresby","Pacific/Guam"],["(UTC+10:00) Hobart","Australia/Hobart"],["(UTC+10:00) Vladivostok","Asia/Vladivostok"],["(UTC+10:30) Lord Howe Island","Australia/Lord_Howe"],["(UTC+11:00) Bougainville Island","Pacific/Bougainville"],["(UTC+11:00) Chokirdakh","Asia/Srednekolymsk"],["(UTC+11:00) Magadan","Asia/Magadan"],["(UTC+11:00) Norfolk Island","Pacific/Norfolk"],["(UTC+11:00) Sakhalin","Asia/Sakhalin"],["(UTC+11:00) Solomon Islands, New Caledonia","Pacific/Guadalcanal"],["(UTC+12:00) Anadyr, Petropavlovsk-Kamchatsky","Asia/Anadyr"],["(UTC+12:00) Auckland, Wellington","Pacific/Auckland"],["(UTC+12:00) Fiji Islands","Pacific/Fiji"],["(UTC+12:45) Chatham Islands","Pacific/Chatham"],["(UTC+13:00) Nuku'alofa","Pacific/Tongatapu"],["(UTC+13:00) Samoa","Pacific/Apia"],["(UTC+14:00) Kiritimati Island","Pacific/Kiritimati"]];var _manual_alts={"America/Guatemala":"America/Belize","America/Indianapolis":"America/Indiana/Indianapolis","America/La_Paz":"America/Manaus",UTC:"Africa/Monrovia","Atlantic/Reykjavik":"Africa/Monrovia","Europe/Berlin":"Europe/Amsterdam","Europe/Budapest":"Europe/Belgrade","Europe/Paris":"Europe/Brussels","Africa/Lagos":"Africa/Algiers","Europe/Bucharest":"Europe/Athens","Africa/Johannesburg":"Africa/Harare","Europe/Kiev":"Europe/Helsinki","Europe/Istanbul":"Asia/Istanbul","Asia/Riyadh":"Asia/Kuwait","Asia/Dubai":"Asia/Muscat","Asia/Calcutta":"Asia/Kolkata","Asia/Shanghai":"Asia/Chongqing","Asia/Singapore":"Asia/Kuala_Lumpur","Australia/Sydney":"Australia/Canberra","Pacific/Port_Moresby":"Pacific/Guam","Asia/Kamchatka":"Asia/Anadyr"};var _auto_alts={"Africa/Abidjan":"Africa/Monrovia","Africa/Accra":"Africa/Monrovia","Africa/Addis_Ababa":"Europe/Moscow","Africa/Asmara":"Europe/Moscow","Africa/Asmera":"Europe/Moscow","Africa/Bamako":"Africa/Monrovia","Africa/Bangui":"Africa/Algiers","Africa/Banjul":"Africa/Monrovia","Africa/Bissau":"Africa/Monrovia","Africa/Blantyre":"Africa/Harare","Africa/Brazzaville":"Africa/Algiers","Africa/Bujumbura":"Africa/Harare","Africa/Ceuta":"Europe/Amsterdam","Africa/Conakry":"Africa/Monrovia","Africa/Dakar":"Africa/Monrovia","Africa/Dar_es_Salaam":"Europe/Moscow","Africa/Djibouti":"Europe/Moscow","Africa/Douala":"Africa/Algiers","Africa/El_Aaiun":"Africa/Casablanca","Africa/Freetown":"Africa/Monrovia","Africa/Gaborone":"Africa/Harare","Africa/Johannesburg":"Africa/Harare","Africa/Juba":"Europe/Moscow","Africa/Kampala":"Europe/Moscow","Africa/Khartoum":"Europe/Moscow","Africa/Kigali":"Africa/Harare","Africa/Kinshasa":"Africa/Algiers","Africa/Lagos":"Africa/Algiers","Africa/Libreville":"Africa/Algiers","Africa/Lome":"Africa/Monrovia","Africa/Luanda":"Africa/Algiers","Africa/Lubumbashi":"Africa/Harare","Africa/Lusaka":"Africa/Harare","Africa/Malabo":"Africa/Algiers","Africa/Maputo":"Africa/Harare","Africa/Maseru":"Africa/Harare","Africa/Mbabane":"Africa/Harare","Africa/Mogadishu":"Europe/Moscow","Africa/Ndjamena":"Africa/Algiers","Africa/Niamey":"Africa/Algiers","Africa/Nouakchott":"Africa/Monrovia","Africa/Ouagadougou":"Africa/Monrovia","Africa/Porto-Novo":"Africa/Algiers","Africa/Sao_Tome":"Africa/Monrovia","Africa/Timbuktu":"Africa/Monrovia","Africa/Tunis":"Africa/Algiers","America/Anguilla":"America/Manaus","America/Antigua":"America/Manaus","America/Araguaina":"America/Buenos_Aires","America/Argentina/Buenos_Aires":"America/Buenos_Aires","America/Argentina/Catamarca":"America/Buenos_Aires","America/Argentina/ComodRivadavia":"America/Buenos_Aires","America/Argentina/Cordoba":"America/Buenos_Aires","America/Argentina/Jujuy":"America/Buenos_Aires","America/Argentina/La_Rioja":"America/Buenos_Aires","America/Argentina/Mendoza":"America/Buenos_Aires","America/Argentina/Rio_Gallegos":"America/Buenos_Aires","America/Argentina/Salta":"America/Buenos_Aires","America/Argentina/San_Juan":"America/Buenos_Aires","America/Argentina/San_Luis":"America/Buenos_Aires","America/Argentina/Tucuman":"America/Buenos_Aires","America/Argentina/Ushuaia":"America/Buenos_Aires","America/Aruba":"America/Manaus","America/Atikokan":"America/Bogota","America/Atka":"America/Adak","America/Bahia_Banderas":"America/Mexico_City","America/Barbados":"America/Manaus","America/Belem":"America/Buenos_Aires","America/Blanc-Sablon":"America/Manaus","America/Boa_Vista":"America/Manaus","America/Boise":"America/Denver","America/Cambridge_Bay":"America/Denver","America/Campo_Grande":"America/Cuiaba","America/Catamarca":"America/Buenos_Aires","America/Cayman":"America/Bogota","America/Coral_Harbour":"America/Bogota","America/Cordoba":"America/Buenos_Aires","America/Costa_Rica":"America/Regina","America/Creston":"America/Phoenix","America/Curacao":"America/Manaus","America/Danmarkshavn":"Africa/Monrovia","America/Dawson":"America/Los_Angeles","America/Dawson_Creek":"America/Phoenix","America/Detroit":"America/New_York","America/Dominica":"America/Manaus","America/Edmonton":"America/Denver","America/Eirunepe":"America/Bogota","America/El_Salvador":"America/Regina","America/Ensenada":"America/Los_Angeles","America/Fort_Wayne":"America/New_York","America/Glace_Bay":"America/Halifax","America/Goose_Bay":"America/Halifax","America/Grenada":"America/Manaus","America/Guadeloupe":"America/Manaus","America/Guatemala":"America/Regina","America/Guayaquil":"America/Bogota","America/Guyana":"America/Manaus","America/Hermosillo":"America/Phoenix","America/Indiana/Knox":"America/Chicago","America/Indiana/Marengo":"America/New_York","America/Indiana/Petersburg":"America/New_York","America/Indiana/Tell_City":"America/Chicago","America/Indiana/Vevay":"America/New_York","America/Indiana/Vincennes":"America/New_York","America/Indiana/Winamac":"America/New_York","America/Indianapolis":"America/New_York","America/Inuvik":"America/Denver","America/Iqaluit":"America/New_York","America/Jamaica":"America/Bogota","America/Jujuy":"America/Buenos_Aires","America/Juneau":"America/Anchorage","America/Kentucky/Louisville":"America/New_York","America/Kentucky/Monticello":"America/New_York","America/Knox_IN":"America/Chicago","America/Kralendijk":"America/Manaus","America/La_Paz":"America/Manaus","America/Lima":"America/Bogota","America/Louisville":"America/New_York","America/Lower_Princes":"America/Manaus","America/Maceio":"America/Buenos_Aires","America/Managua":"America/Regina","America/Marigot":"America/Manaus","America/Martinique":"America/Manaus","America/Matamoros":"America/Chicago","America/Mazatlan":"America/Chihuahua","America/Mendoza":"America/Buenos_Aires","America/Menominee":"America/Chicago","America/Merida":"America/Mexico_City","America/Moncton":"America/Halifax","America/Monterrey":"America/Mexico_City","America/Montreal":"America/New_York","America/Montserrat":"America/Manaus","America/Nassau":"America/New_York","America/Nipigon":"America/New_York","America/Nome":"America/Anchorage","America/North_Dakota/Beulah":"America/Chicago","America/North_Dakota/Center":"America/Chicago","America/North_Dakota/New_Salem":"America/Chicago","America/Ojinaga":"America/Denver","America/Panama":"America/Bogota","America/Pangnirtung":"America/New_York","America/Paramaribo":"America/Buenos_Aires","America/Port_of_Spain":"America/Manaus","America/Porto_Acre":"America/Bogota","America/Porto_Velho":"America/Manaus","America/Puerto_Rico":"America/Manaus","America/Rainy_River":"America/Chicago","America/Rankin_Inlet":"America/Chicago","America/Recife":"America/Buenos_Aires","America/Resolute":"America/Chicago","America/Rio_Branco":"America/Bogota","America/Rosario":"America/Buenos_Aires","America/Santa_Isabel":"America/Los_Angeles","America/Santarem":"America/Buenos_Aires","America/Santo_Domingo":"America/Manaus","America/Scoresbysund":"Atlantic/Azores","America/Shiprock":"America/Denver","America/Sitka":"America/Anchorage","America/St_Barthelemy":"America/Manaus","America/St_Kitts":"America/Manaus","America/St_Lucia":"America/Manaus","America/St_Thomas":"America/Manaus","America/St_Vincent":"America/Manaus","America/Swift_Current":"America/Regina","America/Tegucigalpa":"America/Regina","America/Thule":"America/Halifax","America/Thunder_Bay":"America/New_York","America/Toronto":"America/New_York","America/Tortola":"America/Manaus","America/Vancouver":"America/Los_Angeles","America/Virgin":"America/Manaus","America/Whitehorse":"America/Los_Angeles","America/Winnipeg":"America/Chicago","America/Yakutat":"America/Anchorage","America/Yellowknife":"America/Denver","Antarctica/Casey":"Asia/Chongqing","Antarctica/Davis":"Asia/Bangkok","Antarctica/DumontDUrville":"Australia/Brisbane","Antarctica/Macquarie":"Pacific/Bougainville","Antarctica/Mawson":"Asia/Tashkent","Antarctica/McMurdo":"Pacific/Auckland","Antarctica/Palmer":"America/Santiago","Antarctica/Rothera":"America/Buenos_Aires","Antarctica/South_Pole":"Pacific/Auckland","Antarctica/Syowa":"Europe/Moscow","Antarctica/Vostok":"Asia/Dhaka","Arctic/Longyearbyen":"Europe/Amsterdam","Asia/Aden":"Europe/Moscow","Asia/Aqtau":"Asia/Tashkent","Asia/Aqtobe":"Asia/Tashkent","Asia/Ashgabat":"Asia/Tashkent","Asia/Ashkhabad":"Asia/Tashkent","Asia/Bahrain":"Europe/Moscow","Asia/Bishkek":"Asia/Dhaka","Asia/Brunei":"Asia/Chongqing","Asia/Calcutta":"Asia/Kolkata","Asia/Choibalsan":"Asia/Ulaanbaatar","Asia/Chungking":"Asia/Chongqing","Asia/Dacca":"Asia/Dhaka","Asia/Dili":"Asia/Tokyo","Asia/Dubai":"Asia/Muscat","Asia/Dushanbe":"Asia/Tashkent","Asia/Harbin":"Asia/Chongqing","Asia/Hebron":"Asia/Gaza","Asia/Ho_Chi_Minh":"Asia/Bangkok","Asia/Hong_Kong":"Asia/Chongqing","Asia/Jakarta":"Asia/Bangkok","Asia/Jayapura":"Asia/Tokyo","Asia/Kamchatka":"Asia/Anadyr","Asia/Kashgar":"Asia/Dhaka","Asia/Kathmandu":"Asia/Katmandu","Asia/Khandyga":"Asia/Tokyo","Asia/Kuching":"Asia/Chongqing","Asia/Macao":"Asia/Chongqing","Asia/Macau":"Asia/Chongqing","Asia/Makassar":"Asia/Chongqing","Asia/Manila":"Asia/Chongqing","Asia/Nicosia":"Europe/Athens","Asia/Novokuznetsk":"Asia/Bangkok","Asia/Omsk":"Asia/Dhaka","Asia/Oral":"Asia/Tashkent","Asia/Phnom_Penh":"Asia/Bangkok","Asia/Pontianak":"Asia/Bangkok","Asia/Qatar":"Europe/Moscow","Asia/Qyzylorda":"Asia/Dhaka","Asia/Riyadh":"Europe/Moscow","Asia/Saigon":"Asia/Bangkok","Asia/Samarkand":"Asia/Tashkent","Asia/Shanghai":"Asia/Chongqing","Asia/Singapore":"Asia/Chongqing","Asia/Tel_Aviv":"Asia/Jerusalem","Asia/Thimbu":"Asia/Dhaka","Asia/Thimphu":"Asia/Dhaka","Asia/Ujung_Pandang":"Asia/Chongqing","Asia/Ulan_Bator":"Asia/Ulaanbaatar","Asia/Urumqi":"Asia/Dhaka","Asia/Ust-Nera":"Australia/Brisbane","Asia/Vientiane":"Asia/Bangkok","Atlantic/Bermuda":"America/Halifax","Atlantic/Canary":"Europe/London","Atlantic/Faeroe":"Europe/London","Atlantic/Faroe":"Europe/London","Atlantic/Jan_Mayen":"Europe/Amsterdam","Atlantic/Madeira":"Europe/London","Atlantic/Reykjavik":"Africa/Monrovia","Atlantic/South_Georgia":"America/Noronha","Atlantic/St_Helena":"Africa/Monrovia","Atlantic/Stanley":"America/Buenos_Aires","Australia/ACT":"Australia/Canberra","Australia/Broken_Hill":"Australia/Adelaide","Australia/Currie":"Australia/Canberra","Australia/LHI":"Australia/Lord_Howe","Australia/Lindeman":"Australia/Brisbane","Australia/Melbourne":"Australia/Canberra","Australia/NSW":"Australia/Canberra","Australia/North":"Australia/Darwin","Australia/Queensland":"Australia/Brisbane","Australia/South":"Australia/Adelaide","Australia/Sydney":"Australia/Canberra","Australia/Tasmania":"Australia/Canberra","Australia/Victoria":"Australia/Canberra","Australia/West":"Asia/Chongqing","Australia/Yancowinna":"Australia/Adelaide","Brazil/Acre":"America/Bogota","Brazil/DeNoronha":"America/Noronha","Brazil/East":"America/Sao_Paulo","Brazil/West":"America/Manaus",CET:"Europe/Amsterdam",CST6CDT:"America/Chicago","Canada/Atlantic":"America/Halifax","Canada/Central":"America/Chicago","Canada/East-Saskatchewan":"America/Regina","Canada/Eastern":"America/New_York","Canada/Mountain":"America/Denver","Canada/Newfoundland":"America/St_Johns","Canada/Pacific":"America/Los_Angeles","Canada/Saskatchewan":"America/Regina","Canada/Yukon":"America/Los_Angeles","Chile/Continental":"America/Santiago","Chile/EasterIsland":"Pacific/Easter",Cuba:"America/Havana",EET:"Europe/Athens",EST:"America/New_York",EST5EDT:"America/New_York",Egypt:"Africa/Cairo",Eire:"Europe/London","Etc/GMT":"Africa/Monrovia","Etc/GMT+0":"Africa/Monrovia","Etc/GMT+1":"Atlantic/Cape_Verde","Etc/GMT+10":"Pacific/Honolulu","Etc/GMT+11":"Pacific/Midway","Etc/GMT+2":"America/Noronha","Etc/GMT+3":"America/Buenos_Aires","Etc/GMT+4":"America/Manaus","Etc/GMT+5":"America/Bogota","Etc/GMT+6":"America/Regina","Etc/GMT+7":"America/Phoenix","Etc/GMT-0":"Africa/Monrovia","Etc/GMT-1":"Africa/Algiers","Etc/GMT-10":"Australia/Brisbane","Etc/GMT-11":"Pacific/Bougainville","Etc/GMT-12":"Asia/Anadyr","Etc/GMT-13":"Pacific/Tongatapu","Etc/GMT-14":"Pacific/Kiritimati","Etc/GMT-2":"Africa/Harare","Etc/GMT-3":"Europe/Moscow","Etc/GMT-4":"Asia/Muscat","Etc/GMT-5":"Asia/Tashkent","Etc/GMT-6":"Asia/Dhaka","Etc/GMT-7":"Asia/Bangkok","Etc/GMT-8":"Asia/Chongqing","Etc/GMT-9":"Asia/Tokyo","Etc/GMT0":"Africa/Monrovia","Etc/Greenwich":"Africa/Monrovia","Etc/UCT":"Africa/Monrovia","Etc/UTC":"Africa/Monrovia","Etc/Universal":"Africa/Monrovia","Etc/Zulu":"Africa/Monrovia","Europe/Andorra":"Europe/Amsterdam","Europe/Belfast":"Europe/London","Europe/Berlin":"Europe/Amsterdam","Europe/Bratislava":"Europe/Amsterdam","Europe/Bucharest":"Europe/Athens","Europe/Budapest":"Europe/Amsterdam","Europe/Busingen":"Europe/Amsterdam","Europe/Copenhagen":"Europe/Amsterdam","Europe/Dublin":"Europe/London","Europe/Gibraltar":"Europe/Amsterdam","Europe/Guernsey":"Europe/London","Europe/Isle_of_Man":"Europe/London","Europe/Istanbul":"Asia/Istanbul","Europe/Jersey":"Europe/London","Europe/Kiev":"Europe/Athens","Europe/Kirov":"Europe/Moscow","Europe/Lisbon":"Europe/London","Europe/Ljubljana":"Europe/Amsterdam","Europe/Luxembourg":"Europe/Amsterdam","Europe/Madrid":"Europe/Amsterdam","Europe/Malta":"Europe/Amsterdam","Europe/Mariehamn":"Europe/Athens","Europe/Monaco":"Europe/Amsterdam","Europe/Nicosia":"Europe/Athens","Europe/Oslo":"Europe/Amsterdam","Europe/Paris":"Europe/Amsterdam","Europe/Podgorica":"Europe/Amsterdam","Europe/Prague":"Europe/Amsterdam","Europe/Riga":"Europe/Athens","Europe/Rome":"Europe/Amsterdam","Europe/San_Marino":"Europe/Amsterdam","Europe/Sarajevo":"Europe/Amsterdam","Europe/Simferopol":"Europe/Moscow","Europe/Skopje":"Europe/Amsterdam","Europe/Sofia":"Europe/Athens","Europe/Stockholm":"Europe/Amsterdam","Europe/Tallinn":"Europe/Athens","Europe/Tirane":"Europe/Amsterdam","Europe/Ulyanovsk":"Europe/Astrakhan","Europe/Uzhgorod":"Europe/Athens","Europe/Vaduz":"Europe/Amsterdam","Europe/Vatican":"Europe/Amsterdam","Europe/Vienna":"Europe/Amsterdam","Europe/Vilnius":"Europe/Athens","Europe/Volgograd":"Europe/Moscow","Europe/Zagreb":"Europe/Amsterdam","Europe/Zaporozhye":"Europe/Athens","Europe/Zurich":"Europe/Amsterdam",Factory:"Africa/Monrovia",GB:"Europe/London","GB-Eire":"Europe/London",GMT:"Africa/Monrovia","GMT+0":"Africa/Monrovia","GMT-0":"Africa/Monrovia",GMT0:"Africa/Monrovia",Greenwich:"Africa/Monrovia",HST:"Pacific/Honolulu",Hongkong:"Asia/Chongqing",Iceland:"Africa/Monrovia","Indian/Antananarivo":"Europe/Moscow","Indian/Chagos":"Asia/Dhaka","Indian/Christmas":"Asia/Bangkok","Indian/Cocos":"Asia/Rangoon","Indian/Comoro":"Europe/Moscow","Indian/Kerguelen":"Asia/Tashkent","Indian/Mahe":"Asia/Muscat","Indian/Maldives":"Asia/Tashkent","Indian/Mayotte":"Europe/Moscow","Indian/Reunion":"Asia/Muscat",Iran:"Asia/Tehran",Israel:"Asia/Jerusalem",Jamaica:"America/Bogota",Japan:"Asia/Tokyo",Kwajalein:"Asia/Anadyr",Libya:"Africa/Harare",MET:"Europe/Amsterdam",MST:"America/Denver",MST7MDT:"America/Denver","Mexico/BajaNorte":"America/Los_Angeles","Mexico/BajaSur":"America/Chihuahua","Mexico/General":"America/Mexico_City",NZ:"Pacific/Auckland","NZ-CHAT":"Pacific/Chatham",Navajo:"America/Denver",PRC:"Asia/Chongqing",PST8PDT:"America/Los_Angeles","Pacific/Chuuk":"Australia/Brisbane","Pacific/Efate":"Pacific/Bougainville","Pacific/Enderbury":"Pacific/Tongatapu","Pacific/Fakaofo":"Pacific/Tongatapu","Pacific/Funafuti":"Asia/Anadyr","Pacific/Galapagos":"America/Regina","Pacific/Johnston":"Pacific/Honolulu","Pacific/Kosrae":"Pacific/Bougainville","Pacific/Kwajalein":"Asia/Anadyr","Pacific/Majuro":"Asia/Anadyr","Pacific/Nauru":"Asia/Anadyr","Pacific/Niue":"Pacific/Midway","Pacific/Noumea":"Pacific/Bougainville","Pacific/Pago_Pago":"Pacific/Midway","Pacific/Palau":"Asia/Tokyo","Pacific/Pohnpei":"Pacific/Bougainville","Pacific/Ponape":"Pacific/Bougainville","Pacific/Port_Moresby":"Australia/Brisbane","Pacific/Rarotonga":"Pacific/Honolulu","Pacific/Saipan":"Australia/Brisbane","Pacific/Samoa":"Pacific/Midway","Pacific/Tahiti":"Pacific/Honolulu","Pacific/Tarawa":"Asia/Anadyr","Pacific/Truk":"Australia/Brisbane","Pacific/Wake":"Asia/Anadyr","Pacific/Wallis":"Asia/Anadyr","Pacific/Yap":"Australia/Brisbane",Poland:"Europe/Amsterdam",Portugal:"Europe/London",ROC:"Asia/Chongqing",ROK:"Asia/Tokyo",Singapore:"Asia/Chongqing",Turkey:"Asia/Istanbul",UCT:"Africa/Monrovia","US/Alaska":"America/Anchorage","US/Aleutian":"America/Adak","US/Arizona":"America/Phoenix","US/Central":"America/Chicago","US/East-Indiana":"America/New_York","US/Eastern":"America/New_York","US/Hawaii":"Pacific/Honolulu","US/Indiana-Starke":"America/Chicago","US/Michigan":"America/New_York","US/Mountain":"America/Denver","US/Pacific":"America/Los_Angeles","US/Pacific-New":"America/Los_Angeles","US/Samoa":"Pacific/Midway",UTC:"Africa/Monrovia",Universal:"Africa/Monrovia","W-SU":"Europe/Moscow",WET:"Europe/Amsterdam",Zulu:"Africa/Monrovia"};var _fallback_alts={"America/Fort_Nelson":"America/Denver"};return self};if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=tz}exports.TimezoneDetector=tz}else if(typeof define==="function"&&define.amd){define(function(){return tz})}else{root.TimezoneDetector=tz}}).call(function(){return this||(typeof window!=="undefined"?window:global)}());(function(){"use strict";TS.registerModule("ui.fs_modal_file_viewer",{onStart:function(){},start:function(settings){_settings=settings;if(!_settings||!_settings.current_file_id&&!_settings.current_external_link){TS.error("Full screen file viewer modal requires something to show.");return}if(TS.ui.fs_modal_file_viewer.is_showing){TS.error("Full screen file viewer modal is already showing.");return}TS.files.team_file_comment_added_sig.add(_maybeUpdateCommentCount);TS.files.team_file_comment_deleted_sig.add(_maybeUpdateCommentCount);TS.files.team_file_deleted_sig.add(_fileDeletedHandler);TS.files.team_file_changed_sig.add(_updateFileHeaderDetailed);TS.channels.message_received_sig.add(TS.ui.fs_modal_file_viewer.updateGallery,TS.ui.fs_modal_file_viewer);TS.ims.message_received_sig.add(TS.ui.fs_modal_file_viewer.updateGallery,TS.ui.fs_modal_file_viewer);TS.groups.message_received_sig.add(TS.ui.fs_modal_file_viewer.updateGallery,TS.ui.fs_modal_file_viewer);TS.mpims.message_received_sig.add(TS.ui.fs_modal_file_viewer.updateGallery,TS.ui.fs_modal_file_viewer);TS.channels.message_removed_sig.add(TS.ui.fs_modal_file_viewer.updateGallery,TS.ui.fs_modal_file_viewer);TS.ims.message_removed_sig.add(TS.ui.fs_modal_file_viewer.updateGallery,TS.ui.fs_modal_file_viewer);TS.groups.message_removed_sig.add(TS.ui.fs_modal_file_viewer.updateGallery,TS.ui.fs_modal_file_viewer);TS.mpims.message_removed_sig.add(TS.ui.fs_modal_file_viewer.updateGallery,TS.ui.fs_modal_file_viewer);TS.channels.message_changed_sig.add(TS.ui.fs_modal_file_viewer.updateGallery,TS.ui.fs_modal_file_viewer);TS.ims.message_changed_sig.add(TS.ui.fs_modal_file_viewer.updateGallery,TS.ui.fs_modal_file_viewer);TS.groups.message_changed_sig.add(TS.ui.fs_modal_file_viewer.updateGallery,TS.ui.fs_modal_file_viewer);TS.mpims.message_changed_sig.add(TS.ui.fs_modal_file_viewer.updateGallery,TS.ui.fs_modal_file_viewer);
TS.ui.fs_modal.start(_generateFileViewerConfig());TS.ui.fs_modal_file_viewer.is_showing=true;_initGallery();_dedupeGallery();_updateCurrentIndex();_maybeUpdateArrows();_displayPanelView();_moveCommentFormToViewer();_preloadImage("both");setTimeout(function(){_setIsImageWithinViewer()},0)},getCurrentFileId:function(){if(!TS.ui.fs_modal_file_viewer.is_showing)return false;if(_settings.current_file_id)return _settings.current_file_id;if(_settings.current_external_link)return _settings.current_external_link.getAttribute("data-src");return false},previous:function(){if(_$file_viewer.find(".previous_btn:not([disabled])").length){_navigate(-1)}},next:function(){if(_$file_viewer.find(".next_btn:not([disabled])").length){_navigate(1)}},updateGallery:function(){if(TS.client.activeChannelIsHidden())return;setTimeout(function(){var new_gallery=$("#msgs_div").find(".file_viewer_link, .file_viewer_external_link, .thumbnail_link");if(new_gallery!==_gallery){_gallery=new_gallery;if(TS.model.pdf_viewer_enabled){_filterPDFs()}_updateCurrentIndex();_maybeUpdateArrows()}},500)},test:function(){return{_generateTemplateArguments:_generateTemplateArguments}},canClose:function(){return _canClose()}});var _$body=$("body");var _$file_viewer;var _$content;var _$viewer;var _$header;var _$file_header_detailed;var _$image_wrapper;var _$image;var _$image_actual_pixel;var _$comment_btn;var _$aside_panel;var _$details_container;var _$comments_container;var _$shared_to_conversations;var _$file_comment_form_container;var _$file_comment_form;var _$file_comment_input;var _$file_edit_comment_form;var _gallery;var _current_file={index:0,aside_panel_showing:false};var _settings={};var _pdf_viewer;var _cacheNodes=function(){_$file_viewer=$(".fs_modal_file_viewer");_$content=_$file_viewer.find(".fs_modal_file_viewer_content");_$viewer=_$file_viewer.find(".viewer");_cacheHeaderNodes();_$image_wrapper=_$viewer.find(".images");_cacheImageNodes();_cacheAsideNodes()};var _cacheHeaderNodes=function(){_$header=_$file_viewer.find(".fs_modal_file_viewer_header");_$file_header_detailed=_$header.find(".file_header_detailed")};var _cacheImageNodes=function(){_$image=_$image_wrapper.find(".scaled_image");_$image_actual_pixel=_$image_wrapper.find(".actual_pixel_image")};var _cacheAsideNodes=function(){_$comment_btn=_$file_viewer.find(".comment_btn");_$aside_panel=_$file_viewer.find(".aside_panel");_$details_container=_$file_viewer.find(".details_container");_$comments_container=_$file_viewer.find(".comments_container");_$shared_to_conversations=_$file_viewer.find(".shared_to_conversations");_$file_comment_form_container=_$file_viewer.find(".file_comment_form_container")};var _clean=function(){_$file_viewer=null;_$content=null;_$viewer=null;_$image=null;_$image_wrapper=null;_$comment_btn=null;_$aside_panel=null;_$details_container=null;_$comments_container=null;_$shared_to_conversations=null;_$file_comment_form_container=null;_$image_actual_pixel=null;_$header=null;_$file_header_detailed=null;_gallery=null;_settings.$el=null};var _onEnd=function(){_removeSignals();_moveCommentFormBackToFlexpane();_detachEventHandlers();TS.ui.inline_edit.end();_resetData();_removeDownloadProgressUI();_clean();TS.ui.fs_modal_file_viewer.is_showing=false};var _onShow=function(){_cacheNodes();_attachEventHandlers();_showDownloadProgressUI();if(_current_file.is_pdf){_pdf_viewer=new TS.ui.PdfViewer(_$image_wrapper.find("#pdf_display"),_current_file.file)}};var _attachEventHandlers=function(){_$file_viewer.on("click",".comment_btn, .aside_close_btn",_toggleCommentPanel);_$file_viewer.on("click","#fs_modal_close_btn, .channel_link, .group_link, .file_preview_link",TS.ui.fs_modal.close);_$file_viewer.on("mousedown",".viewer",_mousedownHandler);_$file_viewer.on("click",".viewer",_clickToCloseHandler);_$file_viewer.on("click",".scaled_image",function(e){e.stopPropagation();_showActualPixelImage(e)});_$file_viewer.on("click",".actual_pixel_image",function(e){e.stopPropagation();_hideActualPixelImage()});_$file_viewer.on("click",".previous_btn",function(e){e.stopPropagation();TS.ui.fs_modal_file_viewer.previous()});_$file_viewer.on("click",".next_btn",function(e){e.stopPropagation();TS.ui.fs_modal_file_viewer.next()});_$file_viewer.on("click",".file_comment_btn",function(e){var $this=$(e.target);var c_id=$this.closest("[data-model-ob-id]").attr("data-model-ob-id");_displayPanelView(c_id)});_$file_viewer.on("click",".aside_back_btn",function(e){_displayPanelView(null)});_$body.on("keydown",_keydownHandler);TS.view.resize_sig.add(_setIsImageWithinViewer);_$content.on("click.view",TS.view.onFilePreviewClick);_$file_viewer.on("textchange","#file_comment",function(e){TS.storage.storeLastCommentInput(_current_file.file.id,$(this).val())});_attachErrorHandler()};var _attachErrorHandler=function(){_$file_viewer.find(".scaled_image").on("error",function(){if(!_$image_wrapper)return;_$image_wrapper.addClass("broken_image")})};var _keydownHandler=function(e){switch(e.which){case TS.utility.keymap.up:if(TS.utility.isFocusOnInput())return;if(!_current_file.is_actual_pixel_image_shown)return;e.preventDefault();e.stopPropagation();_panActualPixelImage("up");break;case TS.utility.keymap.down:if(TS.utility.isFocusOnInput())return;if(!_current_file.is_actual_pixel_image_shown)return;e.preventDefault();e.stopPropagation();_panActualPixelImage("down");break;case TS.utility.keymap.left:if(TS.utility.isFocusOnInput())return;e.preventDefault();e.stopPropagation();if(_current_file.is_actual_pixel_image_shown){_panActualPixelImage("left")}else{TS.ui.fs_modal_file_viewer.previous()}break;case TS.utility.keymap.right:if(TS.utility.isFocusOnInput())return;e.preventDefault();e.stopPropagation();if(_current_file.is_actual_pixel_image_shown){_panActualPixelImage("right")}else{TS.ui.fs_modal_file_viewer.next()}break;case TS.utility.keymap.space:if(TS.utility.isFocusOnInput())return;e.preventDefault();e.stopPropagation();_toggleActualPixelImage(e);break;case TS.utility.keymap.esc:_escHandler(e);break}};var _canClose=function(){if(TS.menu.emoji.is_showing)return false;if(TS.model.menu_is_showing)return false;if(TS.model.dialog_is_showing)return false;if(TS.utility.isTabCompleteShowing())return false;if(TS.ui.inline_edit.containsActiveElement(_$file_viewer)){return false}return true};var _can_close_on_click=true;var _mousedownHandler=function(e){_can_close_on_click=_canClose()};var _clickToCloseHandler=function(e){if(!_can_close_on_click)return;if($(e.target).closest(".control_btns").length)return;TS.ui.fs_modal.close()};var _escHandler=function(e){if(!_canClose())return;e.stopPropagation();e.preventDefault();if(_current_file.is_actual_pixel_image_shown){_hideActualPixelImage()}else{TS.ui.fs_modal.close()}};var _detachEventHandlers=function(){_$file_viewer.off("click");_$body.off("keydown",_keydownHandler);TS.view.resize_sig.remove(_setIsImageWithinViewer)};var _updateFileHeaderDetailed=function(file){if(_$file_viewer.length&&_current_file.file.id===file.id){var template_args=_generateTemplateArguments();var was_just_renaming=false;if(TS.ui.inline_edit.containsActiveElement(_$file_header_detailed)){was_just_renaming=true}if(!was_just_renaming){_$file_header_detailed.replaceWith(TS.templates.file_header_detailed(template_args));_cacheHeaderNodes()}}};var _toggleCommentPanel=function(){if(_current_file.aside_panel_showing){_hideCommentPanel()}else{_showCommentPanel()}};var _showCommentPanel=function(){_$comment_btn.addClass("active");_$content.addClass("aside_panel_active");_current_file.aside_panel_showing=true;window.setTimeout(function(){_$file_comment_input.focus()},250)};var _hideCommentPanel=function(){_$comment_btn.removeClass("active");_$content.removeClass("aside_panel_active");_current_file.aside_panel_showing=false;window.setTimeout(function(){_$comment_btn.blur()},250)};var _toggleActualPixelImage=function(e){if(_current_file.is_actual_pixel_image_shown){_hideActualPixelImage()}else{_showActualPixelImage(e)}};var _showActualPixelImage=function(e){if(_current_file.is_image_within_viewer)return false;var focal_point=_getFocalPoint(e);_$viewer.addClass("show_actual_pixel");_current_file.is_actual_pixel_image_shown=true;_positionActualPixelImage(focal_point)};var _hideActualPixelImage=function(){_$viewer.removeClass("show_actual_pixel");_current_file.is_actual_pixel_image_shown=false;_$viewer.scrollLeft(0);_$viewer.scrollTop(0)};var _panActualPixelImage=function(direction){var scroll_element=_$viewer[0];if(!scroll_element)return;var vertical_axis=direction==="up"||direction==="down";var scroll_position=vertical_axis?"scrollTop":"scrollLeft";var scroll_by=25;if(direction==="up"||direction==="left"){scroll_by=-1*scroll_by}scroll_element[scroll_position]+=scroll_by};var _initGallery=function(){if(TS.client.activeChannelIsHidden()){_gallery=$();return}_gallery=$("#msgs_div").find(".file_viewer_link, .file_viewer_external_link, .thumbnail_link");if(TS.model.pdf_viewer_enabled){_filterPDFs()}};var _filterPDFs=function(){_gallery=_gallery.filter(function(index){var $file=$(this);var file_id=$file.attr("data-file-id");return!TS.files.fileIsPDF(file_id)})};var _removeSignals=function(){TS.files.team_file_comment_added_sig.remove(_maybeUpdateCommentCount);TS.files.team_file_comment_deleted_sig.remove(_maybeUpdateCommentCount);TS.files.team_file_deleted_sig.remove(_fileDeletedHandler);TS.files.team_file_changed_sig.remove(_updateFileHeaderDetailed);TS.channels.message_received_sig.remove(TS.ui.fs_modal_file_viewer.updateGallery,TS.ui.fs_modal_file_viewer);TS.ims.message_received_sig.remove(TS.ui.fs_modal_file_viewer.updateGallery,TS.ui.fs_modal_file_viewer);TS.groups.message_received_sig.remove(TS.ui.fs_modal_file_viewer.updateGallery,TS.ui.fs_modal_file_viewer);TS.mpims.message_received_sig.remove(TS.ui.fs_modal_file_viewer.updateGallery,TS.ui.fs_modal_file_viewer);TS.channels.message_removed_sig.remove(TS.ui.fs_modal_file_viewer.updateGallery,TS.ui.fs_modal_file_viewer);TS.ims.message_removed_sig.remove(TS.ui.fs_modal_file_viewer.updateGallery,TS.ui.fs_modal_file_viewer);TS.groups.message_removed_sig.remove(TS.ui.fs_modal_file_viewer.updateGallery,TS.ui.fs_modal_file_viewer);TS.mpims.message_removed_sig.remove(TS.ui.fs_modal_file_viewer.updateGallery,TS.ui.fs_modal_file_viewer);TS.channels.message_changed_sig.remove(TS.ui.fs_modal_file_viewer.updateGallery,TS.ui.fs_modal_file_viewer);TS.ims.message_changed_sig.remove(TS.ui.fs_modal_file_viewer.updateGallery,TS.ui.fs_modal_file_viewer);TS.groups.message_changed_sig.remove(TS.ui.fs_modal_file_viewer.updateGallery,TS.ui.fs_modal_file_viewer);TS.mpims.message_changed_sig.remove(TS.ui.fs_modal_file_viewer.updateGallery,TS.ui.fs_modal_file_viewer)};var _resetData=function(){_settings.current_file_id=null;_settings.current_external_link=null;_current_file.external_file_src=null;_current_file.link_url=null;_current_file.is_image_within_viewer=null;if(_pdf_viewer){_pdf_viewer.destroy();_pdf_viewer=null}};var _storeData=function(){if(_settings.current_file_id){_current_file.file=TS.files.getFileById(_settings.current_file_id);_current_file.member=TS.members.getMemberById(_current_file.file.user);_current_file.original_w=_current_file.file.original_w;_current_file.original_h=_current_file.file.original_h;_current_file.is_pdf=TS.model.pdf_viewer_enabled&&TS.files.fileIsPDF(_current_file.file);TS.files.fetchFileInfo(_current_file.file.id,function(){if(_current_file.file&&_current_file.file.comments&&_current_file.file.comments.length){if(!TS.boot_data.feature_share_mention_comment_cleanup){var $aside_panel=_$aside_panel||$();$aside_panel.find(".comments").html(TS.templates.builders.buildComments(_current_file.file))}}})}else if(_settings.current_external_link){_current_file.file={};_current_file.model_ob=_getModelOb();_current_file.msg=_getExternalLinkMessage();_current_file.member=_getEntityFromMessage(_current_file.msg);_current_file.link_url=_settings.current_external_link.getAttribute("data-link-url");_current_file.external_file_src=_settings.current_external_link.getAttribute("data-src");_current_file.original_w=_settings.current_external_link.getAttribute("data-width");_current_file.original_h=_settings.current_external_link.getAttribute("data-height");_current_file.rotation=_settings.current_external_link.getAttribute("data-rotation");_current_file.content_type=_settings.current_external_link.getAttribute("data-content-type");_current_file.is_pdf=false}else{_current_file.file={}}};var _isExifRotatedImage=function(){return _current_file.file.image_exif_rotation>4};var _generateTemplateArguments=function(){var comments_count=_current_file.file.comments_count?_current_file.file.comments_count:"";var hosted=!_current_file.external_file_src||_settings.current_file_id;var share_label;if(hosted){share_label=TS.templates.builders.makeFileShareLabel(_current_file.file)}else{share_label=TS.templates.builders.makeMessageShareLabelSafe(_current_file.model_ob)}var timestamp=hosted?_current_file.file.timestamp:_current_file.msg&&_current_file.msg.ts;var star_type=hosted?"file":"message";var star_ob=star_type==="message"?_current_file.msg:_current_file.file;var star_parent_ob=star_type==="message"?_current_file.model_ob:null;var actions=_current_file.file.id?TS.files.getFileActions(_current_file.file):{};actions.more=hosted;var title;if(hosted){title=TS.templates.inline_edit_file_title({file:_current_file.file,actions:actions})}else{title=TS.templates.builders.makeMessageLinkLabelSafe(_current_file.link_url)}if(TS.boot_data.feature_share_mention_comment_cleanup)TS.files.createFileCommentsGroup(_current_file.file);var template_args={file:_current_file.file,member:_current_file.member,title:title,share_label:share_label,timestamp:timestamp,star_type:star_type,star_ob:star_ob,star_parent_ob:star_parent_ob,msg:_current_file.msg,model_ob:_current_file.model_ob,comments_count:comments_count,is_aside_panel_active:!!_current_file.aside_panel_showing,show_open_public_link:hosted&&!TS.model.team.prefs.disallow_public_file_urls,show_revoke_public_link:hosted&&!TS.model.team.prefs.disallow_public_file_urls&&TS.files.getFileActions(_current_file.file).revoke_public_link,control_btns:_settings.show_control_btns,actions:actions,link_url:_current_file.link_url};if(TS.model.pdf_viewer_enabled&&_current_file.is_pdf){template_args.file_is_pdf=true;template_args.control_btns=false;template_args.pdf_viewer_url=TS.boot_data.abs_root_url+"pdf-viewer?feature_pdf_viewer=1"}else{var image_src=_getImageSrc(_current_file);var scaled_src=image_src.scaled;var actual_pixel_src=image_src.actual_pixel;template_args.scaled_src=scaled_src;template_args.scaled_rotation=scaled_src===_current_file.file.url_private&&_current_file.file.image_exif_rotation;template_args.actual_pixel_src=actual_pixel_src;template_args.actual_pixel_rotation=actual_pixel_src===_current_file.file.url_private&&_current_file.file.image_exif_rotation}return template_args};var _getImageSrc=function(config){var scaled_src=config.file.url_private;if(TS.boot_data.feature_a11y_pref_no_animation){if(TS.model.prefs.a11y_animations===false){if(config.file.filetype==="gif"){if(config.file.deanimate_gif){scaled_src=config.file.deanimate_gif}else{scaled_src=TS.files.getThumbSrcForFile(config.file,{max_size:1024})}}}}if(config.file.mode==="external")scaled_src=TS.files.getThumbSrcForFile(config.file,{max_size:1024});if(_isExifRotatedImage())scaled_src=TS.files.getThumbSrcForFile(config.file,{max_size:1024});if(config.external_file_src){var imgproxy_opts={};imgproxy_opts.rotate=!!parseInt(config.rotation);if(config.content_type=="image/svg+xml"){imgproxy_opts.render_svg=true;imgproxy_opts.width=config.original_w;imgproxy_opts.height=config.original_h}scaled_src=TS.utility.getImgProxyURLWithOptions(config.external_file_src,imgproxy_opts)}var actual_pixel_src=scaled_src;if(config.file.thumb_1024&&!config.file.thumb_360_gif){var fits_in_window=$(window).width()<config.file.thumb_1024_w||$(window).height()<config.file.thumb_1024_h;if(fits_in_window)scaled_src=config.file.thumb_1024}return{scaled:scaled_src,actual_pixel:actual_pixel_src}};var _getModelOb=function(){var $external_link=$(_settings.current_external_link);var model_ob;if($external_link.closest(".search_message_result").length){var identifier_id=$external_link.closest(".search_message_result").data("channel");model_ob=TS.ims.getImById(identifier_id)||TS.channels.getChannelById(identifier_id)||TS.groups.getGroupById(identifier_id)||TS.mpims.getMpimById(identifier_id)}else if($external_link.closest("#messages_container").length){model_ob=TS.shared.getActiveModelOb()}return model_ob||{}};var _getExternalLinkMessage=function(){var msg_ts=$(_settings.current_external_link).closest("ts-message").data("ts");var msg=TS.utility.msgs.findMsg(msg_ts,_current_file.model_ob.id);return msg||{ts:msg_ts}};var _getEntityFromMessage=function(message){if(!message)return false;return TS.members.getMemberById(message.user)};var _generateFileViewerConfig=function(){_storeData();_current_file.aside_panel_showing=false;var modal_class="fs_modal_file_viewer";if(TS.boot_data.feature_share_mention_comment_cleanup){modal_class+=" with_conversations"}return $.extend({},{modal_class:modal_class,modal_contents_container_class:"fs_modal_file_viewer_content",disable_default_controls:true,body_template_html:TS.templates.fs_modal_file_viewer(_generateTemplateArguments()),onShow:_onShow,onEnd:_onEnd})};var _setIsImageWithinViewer=function(){_current_file.is_image_within_viewer=null;if(!_$viewer)return;if(_current_file.is_pdf)return;var viewer_width=_$viewer.width();var viewer_height=_$viewer.height();var actual_pixel_width;var actual_pixel_height;if(_isExifRotatedImage()){var src=TS.files.getThumbSrcForFile(_current_file.file,{max_size:1024});var thumb_key=_.invert(_current_file.file)[src];if(thumb_key&&_current_file.file){actual_pixel_width=_current_file.file[thumb_key+"_w"];actual_pixel_height=_current_file.file[thumb_key+"_h"]}}else{actual_pixel_width=_current_file.original_w;actual_pixel_height=_current_file.original_h}if(!actual_pixel_width)actual_pixel_width=_$image_actual_pixel.width();if(!actual_pixel_height)actual_pixel_height=_$image_actual_pixel.height();var difference_width=actual_pixel_width-viewer_width;var difference_height=actual_pixel_height-viewer_height;if(difference_width<1&&difference_height<1){_current_file.is_image_within_viewer=true}if(_current_file.is_image_within_viewer){_$image.addClass("no_zoom")}else{_$image.removeClass("no_zoom")}};var _getFocalPoint=function(e){if(e.pageX){var image={width:_$image.width(),height:_$image.height()};var offset={x:e.pageX-_$image.offset().left,y:e.pageY-_$image.offset().top};return{x:offset.x/image.width,y:offset.y/image.height}}else{return{x:.5,y:.5}}};var _positionActualPixelImage=function(focal_point){var scroll_position={x:(_$image_actual_pixel.width()-_$viewer.width())*focal_point.x,y:(_$image_actual_pixel.height()-_$viewer.height())*focal_point.y};_$viewer.scrollLeft(scroll_position.x);_$viewer.scrollTop(scroll_position.y)};var _navigate=function(direction){TS.ui.inline_edit.end();_resetData();_current_file.index+=direction;if(_gallery){var $new_image=_gallery.eq(_current_file.index);_settings.current_file_id=$new_image.data("file-id");if($new_image.hasClass("file_viewer_external_link")){_settings.current_external_link=$new_image[0];if(_current_file.aside_panel_showing&&!_settings.current_file_id){_toggleCommentPanel()}}_renderFile();_showDownloadProgressUI();_attachErrorHandler();_preloadImage(direction)}};var _renderFile=function(){_storeData();var template_obj=_generateTemplateArguments();var $header=$(TS.templates.fs_modal_file_viewer_header(template_obj));_$header.replaceWith($header);_$header=$header;if(_current_file.is_pdf){var $pdf=$(TS.templates.fs_modal_file_viewer_content_pdf(template_obj));_$image_wrapper.replaceWith($pdf);_$image_wrapper=$pdf;_pdf_viewer=new TS.ui.PdfViewer(_$image_wrapper.find("#pdf_display"),_current_file.file)}else{var $image=$(TS.templates.fs_modal_file_viewer_content_image(template_obj));_$image_wrapper.replaceWith($image);_$image_wrapper=$image}_cacheImageNodes();_detachCommentForm();if(TS.boot_data.feature_share_mention_comment_cleanup){_displayPanelView()}else{var $aside=$(TS.templates.fs_modal_file_viewer_aside(template_obj));_$aside_panel.replaceWith($aside);_$aside_panel=$aside}_cacheAsideNodes();_attachCommentForm();_maybeUpdateArrows();_setIsImageWithinViewer()};var _preloadImage=function(direction){if(direction==="both"){_preloadImage(1);direction=-1}var preload_index=_current_file.index+direction;if(!_gallery||preload_index<0||_gallery.length<=preload_index)return;var $preload_image=_gallery.eq(preload_index);var is_preload_image_external=$preload_image.hasClass("file_viewer_external_link");var preload_current_file={file:TS.files.getFileById($preload_image.data("file-id"))||{},external_file_src:is_preload_image_external?$preload_image.data("src"):undefined};if(TS.model.pdf_viewer_enabled&&TS.files.fileIsPDF(preload_current_file.file))return;var preload_src=_getImageSrc(preload_current_file);var image_for_preload=new Image;image_for_preload.src=preload_src.scaled};var _maybeUpdateArrows=function(){if(!_$file_viewer)return;var $control_btns=_$file_viewer.find(".control_btns");var $previous_btn=_$file_viewer.find(".previous_btn");var $next_btn=_$file_viewer.find(".next_btn");if(_gallery.length===1||_gallery.length===0){$control_btns.addClass("hidden")}else{$control_btns.removeClass("hidden")}$previous_btn.attr("disabled",_current_file.index<=0);$next_btn.attr("disabled",_current_file.index>=_gallery.length-1)};var _dedupeGallery=function(){var seen={};_gallery=_gallery.filter(function(index){var key=this.getAttribute("data-file-id")?this.getAttribute("data-file-id"):"";key+=this.getAttribute("data-src")?this.getAttribute("data-src"):"";if(seen.hasOwnProperty(key)){return false}else{seen[key]=true;return true}})};var _updateCurrentIndex=function(){for(var i=0;i<_gallery.length;i++){if(_gallery[i].getAttribute("data-file-id")){if(_gallery[i].getAttribute("data-file-id")===_settings.current_file_id){_current_file.index=i;break}}else{if(_gallery[i].getAttribute("data-src")===_current_file.external_file_src){_current_file.index=i;break}}}};var _maybeUpdateCommentCount=function(){if(!_$file_viewer)return;var comments_count=_current_file.file.comments&&_current_file.file.comments.length;_$file_viewer.find(".comment_count").text(comments_count?comments_count:"")};var _displayPanelView=function(c_id){if(TS.boot_data.feature_share_mention_comment_cleanup){c_id=c_id!==null&&(c_id||_settings.$el.closest("[data-model-ob-id").attr("data-model-ob-id"));if(c_id){_displayFileCommentsView(c_id)}else{_displayFileDetailsView()}}};var _displayFileDetailsView=function(){TS.files.createFileCommentsGroup(_current_file.file);_$shared_to_conversations.replaceWith(TS.templates.shared_to_conversations(_current_file.file));_$aside_panel.attr("data-model-ob-id","");_$file_comment_form_container.addClass("hidden");_$details_container.unhideWithRememberedScrollTop();_$comments_container.hideWithRememberedScrollTop()};var _displayFileCommentsView=function(c_id){TS.files.createFileCommentsGroup(_current_file.file);var massaged_file=jQuery.extend(true,{},_current_file.file);var comment_group=massaged_file._comments_grouped[c_id];massaged_file.comments=comment_group.comments;var model_ob=TS.shared.getModelObById(c_id);var display_name=model_ob&&TS.shared.getDisplayNameForModelOb(model_ob);var actions=massaged_file.id?TS.files.getFileActions(massaged_file):{};var template_args={file:massaged_file,name:display_name,actions:actions};_$comments_container.html(TS.templates.fs_modal_file_viewer_comments(template_args));_$aside_panel.attr("data-model-ob-id",c_id);if(actions.comment){_$file_comment_form_container.removeClass("hidden")}else{_$file_comment_form_container.addClass("hidden")}_$comments_container.unhideWithRememberedScrollTop();_$details_container.hideWithRememberedScrollTop()};var _moveCommentFormToViewer=function(){_detachCommentForm();_attachCommentForm()};var _detachCommentForm=function(){_$file_comment_input=$("#file_comment");_$file_comment_form=$("#file_comment_form").detach();_$file_edit_comment_form=$("#file_edit_comment_form").detach()};var _attachCommentForm=function(){_$file_comment_form_container.append(_$file_comment_form);_$file_comment_form_container.append(_$file_edit_comment_form);_$file_comment_input.val(TS.storage.fetchLastCommentInput(_current_file.file.id))};var _moveCommentFormBackToFlexpane=function(){TS.ui.comments.onEndEdit();var $file_scroller;if(TS.boot_data.feature_share_mention_comment_cleanup){$file_scroller=$(".file_comments_scroller")}else{$file_scroller=$("#file_preview_scroller")}var $file_comment_form=$("#file_comment_form").detach();var $file_edit_comment_form=$("#file_edit_comment_form").detach();$file_scroller.append($file_comment_form);$file_scroller.append($file_edit_comment_form);if(_current_file.file.id!==TS.model.last_previewed_file_id){$("#file_comment_form #file_comment").val(TS.storage.fetchLastCommentInput(TS.model.last_previewed_file_id)).trigger("keyup")}};var _showDownloadProgressUI=function(){TS.client.downloads.addIndividualDownload(_$file_viewer.find(".flex_menu_download_circle"),_settings.current_file_id)};var _removeDownloadProgressUI=function(){TS.client.downloads.removeIndividualDownload()};var _fileDeletedHandler=function(){TS.ui.fs_modal.close(true)}})();(function(){"use strict";TS.registerComponent("ui.PdfViewer",{_constructor:function($iframe,file){if(!file||!$iframe||!$iframe.length){TS.error("TS.ui.PdfViewer missing either the file or iframe");return}if(!TS.files.fileIsPDF(file)){TS.error("Non-PDF given to TS.ui.PdfViewer");return}TS.metrics.count("pdf_viewer_open");this.file=file;this.$iframe=$iframe;this.$image_wrapper=this.$iframe.parent();this.$pdf_loading_spinner=$("#pdf_loading_spinner");var root_url=TS.boot_data.abs_root_url;if(_.endsWith(root_url,"/"))root_url=root_url.substring(0,root_url.length-1);this.iframe_origin=root_url;this.iframe_ready=false;this.addLoadingSpinner(this.$pdf_loading_spinner);this.loadData();this.boundOnMessage=this.onMessage.bind(this);$(window).on("message",this.boundOnMessage)},addLoadingSpinner:function($element){$element.removeClass("hidden").html(TS.templates.infinite_spinner({color:"blue",size:"medium",speed:"fast"}))},removeLoadingSpinner:function($element){$element.addClass("hidden")},destroy:function(){if(this.xhr)this.xhr.abort();$(window).off("message",this.boundOnMessage)},loadData:function(){this.xhr=new XMLHttpRequest;this.xhr.onload=this.onLoad.bind(this);this.xhr.onerror=this.onError.bind(this);this.xhr.open("GET",this.file.url_private_download);this.xhr["responseType"]="arraybuffer";this.xhr["withCredentials"]=true;this.xhr.send()},addFallBackImage:function(){this.$image_wrapper.addClass("broken_image")},onError:function(){TS.metrics.count("pdf_viewer_xhr_error");TS.warn("Error requesting PDF data!");this.removeLoadingSpinner(this.$pdf_loading_spinner);this.addFallBackImage()},onLoad:function(){if(this.xhr.readyState===4&&this.xhr.status==200){this.buffer=new Uint8Array(this.xhr.response);if(this.iframe_ready)this.sendBuffer()}this.xhr=null},onMessage:function(event){var origin=event.origin||event.originalEvent.origin;var data=event.data||event.originalEvent.data;if(_.includes(["pdf_iframe_ready","corrupt_pdf","close_file_viewer"],data)){if(origin!==this.iframe_origin){TS.warn(data+" from unexpected origin: "+origin);return}}else{return}if(data==="pdf_iframe_ready"){this.iframe_ready=true;this.$iframe.focus();if(this.buffer)this.sendBuffer()}else if(data==="corrupt_pdf"){TS.metrics.count("pdf_viewer_corrupt_pdf");this.addFallBackImage()}else if(data==="close_file_viewer"&&TS.ui.fs_modal_file_viewer.canClose()){TS.ui.fs_modal.close()}},sendBuffer:function(){if(bowser.msie){this.$iframe[0].contentWindow.postMessage(this.buffer,this.iframe_origin)}else{this.$iframe[0].contentWindow.postMessage(this.buffer,this.iframe_origin,[this.buffer.buffer])}this.removeLoadingSpinner(this.$pdf_loading_spinner)}})})();(function(){"use strict";TS.registerModule("ui.jumper",{is_showing:false,onStart:function(){TS.client.login_sig.add(TS.ui.jumper.onLogin)},onLogin:function(){_build()},start:function(){if(TS.isPartiallyBooted())return;if(TS.ui.jumper.is_showing)return;TS.metrics.mark("start_jumper_open");$(window.document).on("keydown.jumper",_onKeyDown);_setupData();_$jumper[0].classList.add("active");_$jumper_input.removeAttr("disabled");_$jumper_input.focus();TS.ui.jumper.is_showing=TS.model.dialog_is_showing=true;TS.metrics.measureAndClear("jumper_open","start_jumper_open");setTimeout(function(){if(!TS.ui.jumper.is_showing)return;_unreads=_getUnreadList();_render(_unreads,"")},0)},end:function(){_reset();_$jumper[0].classList.remove("active");$(window.document).off("keydown.jumper",_onKeyDown);TS.kb_nav.end();_cleanupData();_$jumper_results.off("mousemove");_$jumper_input.blur();if(_search_p)_search_p.cancel();_search_p=null;TS.ui.jumper.is_showing=TS.model.dialog_is_showing=false},test:function(){return{setupData:_setupData,cleanup:_cleanupData,search:_search}},debugQuery:function(query){TS.sorter.printTest(query,{prefer_exact_match:true,frecency:true})}});var _RESULT_LIMIT=24;var _data;var _unreads=[];var _$jumper;var _$jumper_input;var _$jumper_results;var _search_p;var _build=function(){var html=TS.templates.jumper();$("body").append(html);_$jumper=$("ts-jumper");_$jumper_input=_$jumper.find("input");_$jumper_results=_$jumper.find("ts-jumper-results");_bindUI();_$jumper_results.monkeyScroll()};var _reset=function(){_$jumper_input.val("");_render(_unreads,"");_$jumper_results.scrollTop(0);setTimeout(function(){TS.ui.utility.updateClosestMonkeyScroller(_$jumper_results)},0)};var _bindUI=function(){_$jumper_input.on("input.search",function(){var query=$.trim(_$jumper_input.val());var matches;if(_search_p)_search_p.cancel();if(query){TS.metrics.mark("start_jumper_search");matches=_search(query);_maybeStartExtendedSearch(matches,query);_render(matches,query);TS.metrics.measureAndClear("jumper_results","start_jumper_search")}else{_reset()}});_$jumper.on("click","[data-item-id]",function(){_select($(this))});_$jumper.on("click",'[data-action="new_channel"]',_endJumperAndOpenNewChannelModal);_$jumper.on("click.end",function(e){if($(e.target).is("ts-jumper"))TS.ui.jumper.end()})};var _render=function(matches,query){if(!query&&$.trim(_$jumper_input.val()).length>0)return;var show_extended_search=_shouldShowExtendedSearch(matches,query);var show_new_channel_link=false;var clean_name="";var disambiguate_mpims=false;if(matches.length==0){show_new_channel_link=!(query.charAt(0)==="@"||query.charAt(0)==="#"&&query.length===1||query.indexOf(",")>-1);if(!query||!/[a-zA-Z\d]/.test(query)||!TS.permissions.members.canCreateChannels()){show_new_channel_link=false}clean_name=TS.utility.cleanChannelName(query.substring(0,21));if(!clean_name||TS.channels.getChannelByName(clean_name)||TS.groups.getGroupByName(clean_name)||TS.members.getMemberByName(clean_name)){show_new_channel_link=false}if(show_extended_search){show_new_channel_link=false}}else{disambiguate_mpims=_shouldDisambiguateMpims(matches)}var template_args={matches:matches,query:query,disambiguate_mpims:disambiguate_mpims,show_new_channel_link:show_new_channel_link,clean_name:clean_name,show_extended_search:show_extended_search};var html=TS.templates.jumper_results(template_args);_$jumper_results.html(html);_initKbNav(matches);_captureFakeMousemoveEvent();TS.ui.utility.updateClosestMonkeyScroller(_$jumper_results)};var _shouldShowExtendedSearch=function(matches,query){return TS.boot_data.page_needs_enterprise&&!!query&&matches.length<_RESULT_LIMIT&&_search_p&&!_search_p.isResolved()};var _shouldDisambiguateMpims=function(matches){var disambiguate_mpims=false;if(TS.members.shouldDisplayRealNames()){var mpims=_.filter(matches,"model_ob.is_mpim",true);if(mpims.length>1)disambiguate_mpims=true}return disambiguate_mpims};
var _captureFakeMousemoveEvent=function(){_$jumper_results.one("mousemove",function(e){_$jumper_results.one("mousemove",function(e){var ol=_$jumper_results.find("ol")[0];if(ol)ol.classList.remove("no_pointer_events")})})};var _initKbNav=function(matches){TS.kb_nav.end();TS.kb_nav.start(_$jumper.find("ol"),"li",_$jumper.find("ol"));TS.kb_nav.setAllowHighlightWithoutBlurringInput(true);TS.kb_nav.setSubmitItemHandler(function(e){_select($(this));e.preventDefault()});if(matches.length>0){var $first=_$jumper.find("li:first");TS.kb_nav.highlightItemWithKey($first,true)}};var _onKeyDown=function(e){if(!TS.ui.jumper.is_showing)return;if(e.which==TS.utility.keymap.esc){TS.ui.jumper.end();e.preventDefault();e.stopPropagation()}else if(e.which==TS.utility.keymap.enter){var $new_channel_link=_$jumper_results.find('[data-action="new_channel"]');if($new_channel_link.length){_endJumperAndOpenNewChannelModal();return}}else if(!e.altKey&&TS.utility.cmdKey(e)&&(e.which==75||TS.model.is_our_app&&e.which==84)){if(!$.trim(_$jumper_input.val())){TS.ui.jumper.end();e.preventDefault()}else{_reset()}}};var _select=function($el){if(!$el)TS.warn("No $el for Jumper selection");var id=$el.data("item-id");if(!id)TS.warn("No ID for Jumper selection");var team_id;if($el.data("item-team-id"))team_id=$el.data("item-team-id");var item_selected;var team_match=false;var query=$.trim(_$jumper_input.val());if(id.charAt(0)==="G"){item_selected=TS.shared.getModelObById(id)}else if(id.charAt(0)==="C"){item_selected=TS.channels.getChannelById(id)}else if(id.charAt(0)==="V"){item_selected=TS.model.getViewById(id)}else{if(TS.boot_data.page_needs_enterprise){if(team_id){team_match=_.find(TS.boot_data.other_accounts,["id",id])}}else{team_match=_.find(TS.boot_data.other_accounts,["id",id])}if(team_match){item_selected=team_match}else{item_selected=TS.members.getMemberById(id)}}TS.ui.frecency.record(item_selected,query);if(team_match){_selectTeam(team_match)}else if(item_selected){_promiseToSwitchTo(item_selected).then(function(){TS.ui.jumper.end()})}else{TS.error("Unknown jumper item "+id)}};var _promiseToSwitchTo=function(item){if(item.is_channel){TS.channels.displayChannel(item.id);return Promise.resolve()}else if(item.is_mpim&&item.is_group){TS.mpims.displayMpim(item.id);return Promise.resolve()}else if(item.is_group&&!item.is_mpim){TS.groups.displayGroup(item.id);return Promise.resolve()}else if(item.is_view){TS.client.ui.showView(item.id);return Promise.resolve()}else if(item.presence){_$jumper_input.attr("disabled","disabled");var start_p=TS.ims.promiseToStartImByMemberId(item.id);var loading_timeout=setTimeout(function(){_showSwitching(TS.members.getMemberDisplayName(item))},500);return start_p.then(function(){clearTimeout(loading_timeout)},function(error){_cancelSwitching();throw error})}return Promise.reject()};var _selectTeam=function(team){if(TSSSB.call("displayTeam",team.id)){TS.ui.jumper.end();return}_showSwitching(team.team_name);TS.prefs.setPrefByAPI({name:TS.ui.frecency.isEnterprise()?"frecency_ent_jumper":"frecency_jumper",value:JSON.stringify(TS.model.frecency_jumper)}).finally(function(){window.location.href=team.team_url})};var _showSwitching=function(name){_$jumper_input.attr("disabled","disabled");_$jumper_results.html(TS.templates.jumper_switch_loading({name:name}));TS.ui.utility.updateClosestMonkeyScroller(_$jumper_results)};var _cancelSwitching=function(){_$jumper_input.removeAttr("disabled").trigger("input.search")};var _endJumperAndOpenNewChannelModal=function(){var query=$.trim(_$jumper_input.val());TS.ui.jumper.end();TS.ui.new_channel_modal.start(query)};var _updateMembersData=function(){_data.members=TS.members.getActiveMembersWithSelfAndSlackbot().slice()};var _setupData=function(){var all_members=TS.members.getActiveMembersWithSelfAndSlackbot().slice();if(!TS.model.user.is_restricted){var all_channels=TS.channels.getChannelsForUser().slice().concat(TS.model.deferred_archived_channels);var all_groups=TS.model.groups.slice().concat(TS.model.deferred_archived_groups);all_channels=_.uniqBy(all_channels,"id");all_groups=_.uniqBy(all_groups,"id")}else{var all_channels=TS.channels.getUnarchivedChannelsForUser().slice();var all_groups=TS.groups.getUnarchivedGroups().slice()}var all_mpims=TS.mpims.getVisibleMpims().slice();var all_teams=_.values(TS.boot_data.other_accounts);_data={members:all_members,channels:all_channels,groups:all_groups,mpims:all_mpims,teams:all_teams};if(TS.boot_data.feature_unread_view&&TS.client.unread.isEnabled()){_data.views=TS.model.NAMED_VIEWS}};var _cleanupData=function(){_data=null};var _search=function(query){if(!_data)return[];var search_options={prefer_exact_match:true,frecency:true,limit:_RESULT_LIMIT,prefer_channels_user_belongs_to:true,search_previous_channel_names:!!TS.boot_data.feature_reveal_channel_renames};return TS.sorter.search(query,_data,search_options)};var _mayDoExtendedSearch=function(){return!!(TS.boot_data.page_needs_enterprise||TS.lazyLoadMembersAndBots())};var _maybeStartExtendedSearch=function(matches,query){if(_mayDoExtendedSearch()&&!!query&&matches.length<_RESULT_LIMIT){var render=function(matches,query){var $maybe=TS.kb_nav.getHighlightedItem();_render(matches,query);if($maybe){var highlighted_item_id=$maybe.data("item-id");var $formerly_highlighted_elem=TS.kb_nav.getItemByItemId(highlighted_item_id);if($formerly_highlighted_elem){TS.kb_nav.highlightItemWithKey($formerly_highlighted_elem,true)}}};_search_p=_promiseToSearchMembers(query,_RESULT_LIMIT-matches.length);_search_p.then(function(members){if(!TS.ui.jumper.is_showing)return;if(!members||!members.length)return void render(matches,query);_updateMembersData();render(_search(query),query)}).catch(function(error){if(!TS.ui.jumper.is_showing)return;render(matches,query)})}};var _promiseToSearchMembers=function(query,limit){if(!_mayDoExtendedSearch()||!limit)return Promise.resolve();if(query.charAt(0)==="#")return Promise.resolve([]);if(query.charAt(0)==="@")query=query.substring(1);var org_team_ids;if(TS.model.enterprise){org_team_ids=_(TS.model.enterprise_teams).map("id").filter(function(id){return id!==TS.model.team.id}).value()}else{org_team_ids=[]}var searcher={query:query,max_api_results:limit,include_org:true,include_slackbot:false,include_self:true,full_profile_filter:false,org_team_ids:org_team_ids};return TS.members.promiseToSearchMembers(searcher).then(function(response){return Promise.resolve(response.items)})};var _getUnreadList=function(){var highlights=[];var unreads=[];var list=[];_data.members.forEach(function(member){var im=TS.ims.getImByMemberId(member.id);if(im&&im.unread_cnt&&im.unread_cnt>0){highlights.push({model_ob:member,score:0})}});_data.mpims.forEach(function(mpim){if(mpim.unread_cnt&&mpim.unread_cnt>0){highlights.push({model_ob:mpim,score:0})}});_data.groups.forEach(function(group){if(group.unread_highlight_cnt&&group.unread_highlight_cnt>0){highlights.push({model_ob:group,score:0})}else if(group.unread_cnt&&group.unread_cnt>0&&!TS.notifs.isCorGMuted(group.id)){unreads.push({model_ob:group,score:0})}});_data.channels.forEach(function(channel){if(channel.unread_highlight_cnt&&channel.unread_highlight_cnt>0){highlights.push({model_ob:channel,score:0})}else if(channel.unread_cnt&&channel.unread_cnt>0&&!TS.notifs.isCorGMuted(channel.id)){unreads.push({model_ob:channel,score:0})}});list=highlights.concat(unreads);if(!list.length){if(_data.channels.length+_data.groups.length<10){_data.channels.forEach(function(channel){list.push({model_ob:channel,score:0})});_data.groups.forEach(function(group){list.push({model_ob:group,score:0})})}}return list.slice(0,_RESULT_LIMIT)}})();(function(){"use strict";TS.registerModule("utility.box",{onStart:function(){},launchPopup:function(){if(!window.BoxSelect)return;var window_open;try{window_open=window.open;window.open=function(url,name,specs){var width,height,left,top;width=String(specs).match(/width\D+(\d+)/);width=parseInt(width&&width[1]||590);height=String(specs).match(/height\D+(\d+)/);height=parseInt(height&&height[1]||520);left=(window.screenX||window.screenLeft)+((window.outerWidth||document.documentElement.offsetWidth)-width)/2;top=(window.screenY||window.screenTop)+((window.outerHeight||document.documentElement.offsetHeight)-height)/2;_box_window=window_open(url,name,[specs,"left="+left,"top="+top].join(","));return _box_window};_getBoxSelect().launchPopup();if(window.focus&&_box_window)_box_window.focus()}finally{window.open=window_open}},closePopup:function(){window.BoxSelect&&_getBoxSelect().closePopup()},success:function(callback){window.BoxSelect&&_getBoxSelect().success(callback)},cancel:function(callback){window.BoxSelect&&_getBoxSelect().cancel(callback)},unregister:function(){window.BoxSelect&&_getBoxSelect().unregister.apply(_getBoxSelect(),arguments)},isBrowserSupported:function(){return window.BoxSelect&&_getBoxSelect().isBrowserSupported()},test:function(){return{getBoxSelect:_getBoxSelect,setBoxSelect:_setBoxSelect}}});var _box_select,_box_window;var _getBoxSelect=function(){if(_box_select)return _box_select;_box_select=new window.BoxSelect({clientId:TS.boot_data.box_app_key,linkType:"shared",multiselect:"true"});TS.utility.box.SUCCESS_EVENT_TYPE=_box_select.SUCCESS_EVENT_TYPE;TS.utility.box.CANCEL_EVENT_TYPE=_box_select.CANCEL_EVENT_TYPE;return _box_select};var _setBoxSelect=function(box_select){_box_select=box_select}})();(function(){"use strict";TS.registerModule("ui.inline_edit",{onStart:function(){$(document).on("click.ui_"+BASE_CLASS_NAME+"_start","."+BASE_CLASS_NAME+"_inner",function(e){var $target=$(e.target);var $wrapper=$target.closest("."+BASE_CLASS_NAME);if(!$wrapper||!$wrapper.length)return;var $link=$target.closest("a[href]");if($link&&$link.length)return;e.stopPropagation();TS.ui.inline_edit.start($wrapper)})},start:function($wrapper,api_settings){if(!$wrapper)return;if(TS.isPartiallyBooted()){TS.incremental_boot.userDidInteractWithUI();return}var $input=$wrapper.find("."+BASE_CLASS_NAME+"_input");if(!$input)return;if(_$wrapper&&!$wrapper.is(_$wrapper)){TS.ui.inline_edit.end()}var api=api_settings||_.find(KNOWN_APIS,function(api){var data_attribute=$wrapper.data(api.data_attribute)||$input.data(api.data_attribute);if(!data_attribute)return false;api.arguments={};api.arguments[api.argument_name_for_data_attribute]=data_attribute;return true});if(typeof api!=="object")return;_api_method=api.method_name;_api_value_name=api.value_name;_api_arguments=api.arguments;if(!_api_method||!_api_value_name||typeof _api_arguments!=="object")return;_format=_api_value_name==="topic"?TS.utility.formatTopicOrPurpose:TS.format.formatNoSpecials;_$wrapper=$wrapper;_$input=$input;_start()},end:function(){_stop();_end()},containsActiveElement:function(parent_element){if(!TS.ui.inline_edit.is_showing||!_$input||!_$input.length)return false;var active=document.activeElement;var $active=$(active);if(!$active.is(_$input))return false;if(parent_element instanceof jQuery&&parent_element[0]){parent_element=parent_element[0]}if(parent_element.nodeType!==Node.ELEMENT_NODE)return false;return $.contains(parent_element,active)}});var BASE_CLASS_NAME="inline_edit";var ANIMATION_END_EVENT_STR=["animationend","webkitAnimationEnd","MSAnimationEnd","oAnimationEnd"].join(".ui_"+BASE_CLASS_NAME+" ")+".ui_"+BASE_CLASS_NAME;var KNOWN_APIS=[{data_attribute:"file-id",method_name:"files.edit",value_name:"title",argument_name_for_data_attribute:"file"},{data_attribute:"group-id",method_name:"groups.setTopic",value_name:"topic",argument_name_for_data_attribute:"channel"},{data_attribute:"channel-id",method_name:"channels.setTopic",value_name:"topic",argument_name_for_data_attribute:"channel"}];var _$wrapper;var _$input;var _api_method;var _api_value_name;var _api_arguments;var _format;var _unformatted_value;var _should_cancel_on_blur=true;var _editing=false;var _start=function(){if(_editing)return;$(document).off(".ui_"+BASE_CLASS_NAME).on("keydown.ui_"+BASE_CLASS_NAME,_onKeyDown).on("mousedown.ui_"+BASE_CLASS_NAME,_onMouseDown);_$wrapper.off(".ui_"+BASE_CLASS_NAME).on("blur.ui_"+BASE_CLASS_NAME,"."+BASE_CLASS_NAME+"_input",_onBlur).on(ANIMATION_END_EVENT_STR,_onAnimationEnd);_$input.off(".ui_"+BASE_CLASS_NAME).on("paste.ui_"+BASE_CLASS_NAME,_onPaste);_unformatted_value=_$input.data("inline-edit-unformatted")||_$input.text();_$input.text(TS.utility.unHtmlEntities(_unformatted_value));_$wrapper.addClass(BASE_CLASS_NAME+"_editing");_$input.attr("contenteditable",true);_$input.focus();TS.ui.inline_edit.is_showing=true;_editing=true;_selectAllContentEditable(_$input)};var _stop=function(){if(!_editing)return;if(!!_$input)_$input.removeAttr("contenteditable");if(!!_$wrapper)_$wrapper.removeClass(BASE_CLASS_NAME+"_editing");_editing=false};var _save=function(){_should_cancel_on_blur=false;_stop();_$wrapper.addClass(BASE_CLASS_NAME+"_updating").removeClass(BASE_CLASS_NAME+"_done");var removeSpinner=function(){_$wrapper.removeClass(BASE_CLASS_NAME+"_updating")};var api_args=_.clone(_api_arguments);var text=_$input[0].innerText;if(!text)text=$("<textarea/>").html(_$input.html().replace(/<br[^>]*>/,"\n")).text();api_args[_api_value_name]=text;TS.api.call(_api_method,api_args).then(function(){removeSpinner();_updated.apply(null,arguments)}).catch(function(){removeSpinner();_error.apply(null,arguments)})};var _cancel=function(e){if(!_editing)return;if(!!_$input)_$input.html(_format(_unformatted_value));_stop();TS.ui.inline_edit.is_showing=false};var _end=function(){$(document).off(".ui_"+BASE_CLASS_NAME);if(!!_$wrapper)_$wrapper.off(".ui_"+BASE_CLASS_NAME);if(!!_$input)_$input.off(".ui_"+BASE_CLASS_NAME);TS.ui.inline_edit.is_showing=false;_editing=false;_should_cancel_on_blur=true;_unformatted_value=null;_api_arguments=null;_api_value_name=null;_api_method=null;_$input=null;_$wrapper=null};var _error=function(response){_$input.html(_format(_unformatted_value));_$wrapper.addClass(BASE_CLASS_NAME+"_done "+BASE_CLASS_NAME+"_error")};var _updated=function(response){var data=response.data||{};if(!data.ok){_error(response);return}var text=_$input.text();if(data.topic)text=data.topic;if(data.file&&data.file.title)text=data.file.title;_$input.data("inline-edit-unformatted",text);_$input.html(_format(text));_$wrapper.addClass(BASE_CLASS_NAME+"_done "+BASE_CLASS_NAME+"_success")};var _onAnimationEnd=function(e){var animation_name=e.originalEvent.animationName;if(animation_name!==BASE_CLASS_NAME+"_hide_done")return;_$wrapper.removeClass(BASE_CLASS_NAME+"_done "+BASE_CLASS_NAME+"_error "+BASE_CLASS_NAME+"_success");_should_cancel_on_blur=true;if(!_editing){_stop();TS.ui.inline_edit.is_showing=false}};var _onKeyDown=function(e){if(!_editing)return;switch(e.which){case TS.utility.keymap.esc:_cancel(e);break;case TS.utility.keymap.enter:if(e.shiftKey||e.altKey)return;e.preventDefault();_save();break}};var _onMouseDown=function(e){if(_$wrapper[0]&&$.contains(_$wrapper[0],e.target)){_should_cancel_on_blur=false}else{_should_cancel_on_blur=true}};var _onBlur=function(e){if(!_editing)return;if(_should_cancel_on_blur){_cancel(e)}else{_$input.focus();_.delay(_selectAllContentEditable,0,_$input)}};var _onPaste=function(e){if(!_editing)return;e=e.originalEvent||e;var clipboard_data=window.clipboardData||e.clipboardData;var can_insert=document.queryCommandSupported("insertText")||document.queryCommandSupported("insertHTML");if(document.queryCommandSupported("ms-pasteTextOnly")){e.preventDefault();window.document.execCommand("ms-pasteTextOnly",false)}else if(clipboard_data&&can_insert){var text=clipboard_data.getData("text");if(text=="")text=clipboard_data.getData("text/plain");if(text!==""){e.preventDefault();if(document.queryCommandSupported("insertText")){document.execCommand("insertText",false,text)}else{document.execCommand("insertHTML",false,TS.utility.htmlEntities(text))}}}};var _selectAllContentEditable=function(el){if(el.length)el=el[0];var range=document.createRange();range.selectNodeContents(el);var sel=window.getSelection();sel.removeAllRanges();sel.addRange(range)}})();(function(){"use strict";TS.registerModule("files.media",{INLINE_VIDEO_CLASS_NAME:"inline_video",COUNT_LABEL_MOV_CANPLAY:"inline_mov_canplay",COUNT_LABEL_MOV_ERROR:"inline_mov_error",bindVideoElements:function(options){var $container_el=$(_.get(options,"container","body"));var on_canplay=_.get(options,"onCanplay",_.noop);var on_error=_.get(options,"onError",_.noop);$container_el[0].addEventListener("canplay",function(event){var $el=$(event.target);if($el.hasClass(TS.files.media.INLINE_VIDEO_CLASS_NAME)){_handleMetrics($el,TS.files.media.COUNT_LABEL_MOV_CANPLAY);on_canplay($el)}},true);$container_el[0].addEventListener("error",function(event){var $el=$(event.target);if($el.hasClass(TS.files.media.INLINE_VIDEO_CLASS_NAME)){_handleMetrics($el,TS.files.media.COUNT_LABEL_MOV_ERROR);on_error($el)}},true);$container_el.find("."+TS.files.media.INLINE_VIDEO_CLASS_NAME).each(function(){var $el=$(this);if(this.readyState>=HTMLVideoElement.HAVE_CURRENT_DATA){on_canplay($el)}else if(this.error){on_error($el)}})},test:function(){return{_isSrcMov:_isSrcMov}}});var _handleMetrics=function($el,label){if(_isSrcMov($el.attr("src"))){TS.metrics.count(label)}};var _isSrcMov=function(src){return _.isString(src)&&_.last(src.split(".")).toLowerCase()==="mov"}})();(function(){"use strict";TS.registerModule("client.unread",{switched_sig:new signals.Signal,is_showing:false,new_messages_in_channels:[],messages_loaded:false,onStart:function(){if(!TS.boot_data.feature_unread_view)return false;TS.prefs.enable_unread_view_changed_sig.add(_toggleUnreadView);TS.channels.message_received_sig.add(_messageReceived);TS.groups.message_received_sig.add(_messageReceived);TS.ims.message_received_sig.add(_messageReceived);TS.mpims.message_received_sig.add(_messageReceived);TS.channels.message_changed_sig.add(_messageChanged);TS.groups.message_changed_sig.add(_messageChanged);TS.ims.message_changed_sig.add(_messageChanged);TS.mpims.message_changed_sig.add(_messageChanged);TS.channels.message_removed_sig.add(_messageRemoved);TS.groups.message_removed_sig.add(_messageRemoved);TS.ims.message_removed_sig.add(_messageRemoved);TS.mpims.message_removed_sig.add(_messageRemoved);TS.files.team_file_changed_sig.add(_fileChanged);TS.channels.deleted_sig.add(_onDelete);TS.groups.deleted_sig.add(_onDelete);TS.client.login_sig.add(_addUnreadSignals);TS.client.login_sig.add(_setSortOrder);TS.prefs.all_unreads_sort_order_changed_sig.add(_setSortOrder)},isEnabled:function(){return!!(TS.boot_data.feature_unread_view&&TS.model.prefs.enable_unread_view)},shouldRecordMetrics:function(){return!!_should_record_metrics},debug:function(text,data){_debug_data.push({msg:text,data:data});if(!TS.boot_data.feature_tinyspeck)return;TS.info("[ALL_UNREADS] "+text,data)},showUnreadView:function(from_history,replace_history_state,direct_from_boot){if(TS.model.sorting_mode_is_showing)return false;if(!TS.client.unread.isEnabled())return false;from_history=!!from_history;replace_history_state=!!replace_history_state;var no_history_add=replace_history_state?false:from_history;var switched=TS.client.unreadViewActivated(replace_history_state,no_history_add);if(switched){TS.client.unread.switched_sig.dispatch()}else{return false}_direct_from_boot=direct_from_boot;_should_record_metrics=TS.utility.enableFeatureForUser(10);if(_should_record_metrics)TS.metrics.mark("unread_view_time_to_display");_resetData();_init_timestamp=TS.utility.date.makeTsStamp(null,"0",9);TS.client.ui.unread.showUnreadView();if(_should_record_metrics)TS.metrics.count("unread_view_displayed");if(_should_record_metrics)TS.metrics.mark("unread_view_time_spent");if(_coachmark_has_been_displayed){_coachmark_has_been_displayed=false;TS.metrics.count("unread_view_coachmark_conversion")}return true},destroyUnreadView:function(){if(!TS.client.ui.unread.isUnreadViewDOMShowing())return;if(_should_record_metrics)TS.metrics.measureAndClear("unread_view_time_spent","unread_view_time_spent");TS.client.ui.unread.destroyUnreadView();_resetData()},reloadIfPendingMessages:function(){if(TS.client.unread.getTotalNewUnreadCount()>0&&TS.client.unread.new_messages_in_channels.length){TS.client.unread.reload()}},reload:function(){_direct_from_boot=undefined;TS.client.ui.unread.removeEmptyState();_resetData();TS.client.ui.unread.restart()},getGroup:function(model_ob_id){return _.find(_groups,{model_ob:{id:model_ob_id}})},getAllGroups:function(){return _groups},collapseGroup:function(group,persist_state){if(persist_state)TS.api.call("unread.collapse",{channel:group.id});group.collapsed=true;group.hidden_msgs=group.msgs;group.msgs=[];if(_backfilling_for_group&&_backfilling_for_group.id===group.id){_groups=_groups.concat(_excluded_groups);TS.client.ui.unread.addMessageContainerGroups(_excluded_groups);_stopBackfilling()}return group},expandGroup:function(group,persist_state){group.collapsed=false;if(persist_state)TS.api.call("unread.expand",{channel:group.id});if(group.msgs.length>0){group.new_unread_msgs=group.msgs;group.new_unread_cnt=group.new_unread_msgs.length;group.msgs=[]}group.msgs=group.msgs.concat(group.hidden_msgs);_sortAndDedupe(group,"msgs");group.hidden_msgs=[];if(group.has_more){var group_index=_.findIndex(_groups,{id:group.id});_excluded_groups=_groups.splice(group_index+1);TS.client.ui.unread.removeMessageContainerGroup(_.map(_excluded_groups,"id"));_backfilling_for_group=group;_backfilling_was_all_fetched=_all_messages_fetched;_all_messages_fetched=false}return group},markGroupAsRead:function(group,skip_mark_read_msg){var reason=null;group.previous_read_ts=group.model_ob.last_read;group.marked_as_read_cnt=group.total_unreads;group.marked_as_read=true;group.total_unreads=0;group.manually_marked_unread_msg=null;if(!skip_mark_read_msg){TS.shared.markReadMsg(group.model_ob.id,TS.client.unread.getMarkerTS(group),reason);if(_should_record_metrics)TS.metrics.store("unread_view_mark_model_read",group.marked_as_read_cnt,{is_count:true})}return group},markGroupAsUnread:function(group){TS.shared.markReadMsg(group.model_ob.id,group.previous_read_ts,null);group.marked_as_read=false;group.manually_marked_unread_msg=null;_current_model_ob_id=group.id;group.total_unreads=group.marked_as_read_cnt;group.marked_as_read_cnt=0;return group},markAllAsRead:function(){var skip_mark_read_msg=true;var markers={};var marked_as_read_cnt=0;_groups.forEach(function(group){markers[group.id]=TS.client.unread.getMarkerTS(group);TS.client.unread.markGroupAsRead(group,skip_mark_read_msg);marked_as_read_cnt+=group.msgs.length});if(_should_record_metrics)TS.metrics.count("unread_view_mark_all_read");if(_should_record_metrics)TS.metrics.store("unread_view_mark_all_read_count",marked_as_read_cnt,{is_count:true});if(_all_messages_fetched){TS.api.call("unread.markRead",{markers:JSON.stringify(markers)});TS.client.ui.unread.displayEmptyState(marked_as_read_cnt)}else{TS.api.call("unread.markRead",{markers:JSON.stringify(markers)}).then(function(){if(!TS.model.unread_view_is_showing)return;TS.client.unread.reload()})}},markAllAsUnread:function(){_groups.forEach(function(group){TS.client.unread.markGroupAsUnread(group)});TS.client.ui.unread.removeEmptyState()},getMarkerTS:function(group){var ts=TS.client.unread.getNewestMsgTs(group);if(!ts||ts<_init_timestamp){ts=_init_timestamp}return ts},updateGroupWithNewMessages:function(group){if(group.new_unread_msgs){group.msgs=group.new_unread_msgs.concat(group.msgs);_sortAndDedupe(group,"msgs");group.total_unreads+=group.new_unread_cnt;group.new_unread_cnt=0;group.new_unread_msgs=[];group.marked_as_read=false;group.collapsed=false;TS.client.unread.new_messages_in_channels=_.without(TS.client.unread.new_messages_in_channels,group.id);TS.client.ui.unread.showOrHideRefreshButton()}return group},moveNewUnreadsOntoHiddenMsgs:function(group){if(group.collapsed&&group.marked_as_read&&group.new_unread_msgs.length){group.hidden_msgs=group.new_unread_msgs;_sortAndDedupe(group,"msgs");group.new_unread_cnt=0;group.new_unread_msgs=[];group.msgs=[];group.total_unreads=group.hidden_msgs.length;group.marked_as_read=false;TS.client.unread.new_messages_in_channels=_.without(TS.client.unread.new_messages_in_channels,group.id);TS.client.ui.unread.showOrHideRefreshButton()}return group},getNewestMsgTs:function(group){return group.msgs&&group.msgs.length?group.msgs[0].ts:null},promiseToGetMoreMessages:function(){TS.client.unread.debug("promiseToGetMoreMessages");if(!_direct_from_boot&&!_current_model_ob_id&&!TS.client.unread.getAllCurrentlyUnreadGroups().length){TS.client.unread.debug("DONE FETCHING: First fetch, not from boot, nothing in global model is unread, marking all msgs as fetched");_all_messages_fetched=true;_channelConsistencyCheck()}if(_all_messages_fetched){TS.client.unread.debug("NO FETCHING: All messages are fetched");return Promise.resolve({groups:[],has_more:false})}clearTimeout(_slow_loading_timeout);_slow_loading_timeout=setTimeout(function(){TS.client.ui.unread.displaySlowLoadingMessage()},5e3);_more_messages_p=new Promise(function(resolve,reject){TS.experiment.loadUserAssignments().then(function(){var skip_channels=[];var api_args;if(_current_model_ob_id){if(_should_record_metrics)TS.metrics.count("unread_view_scroll")}if(_backfilling_for_group){var current_backfill_id=_backfilling_for_group.id;api_args={channel:_backfilling_for_group.id,oldest:TS.client.unread.getNewestMsgTs(_backfilling_for_group)||_backfilling_for_group.model_ob.last_read,latest:_init_timestamp,always_asc:true};TS.client.unread.debug("Backfilling using api_args: ",_.clone(api_args));TS.api.call(TS.shared.getHistoryApiMethodForModelOb(_backfilling_for_group.model_ob),api_args).then(function(resp){clearTimeout(_slow_loading_timeout);if(!TS.model.unread_view_is_showing)return;if(_backfilling_for_group||_backfilling_for_group.id!=current_backfill_id){var data_for_processing={channels:[{channel_id:_backfilling_for_group.id,messages:resp.data.messages,has_more:resp.data.has_more}],channels_count:1,total_messages_count:null};if(!resp.data.has_more){data_for_processing.groups=_excluded_groups}var processed_data=_processResp(data_for_processing,skip_channels);if(!resp.data.has_more){_stopBackfilling();processed_data.has_more=!_all_messages_fetched}resolve(processed_data)}else{reject(new Error("channels.history rejected because we are no longer backfilling or we are backfilling a different group"))}}).catch(function(err){TS.error(err);clearTimeout(_slow_loading_timeout);TS.client.ui.unread.displayFatalError()})}else{api_args={timestamp:_init_timestamp,sort:TS.client.unread.getSortOrder()};if(_current_model_ob_id){api_args.current_channel=_current_model_ob_id;var group=TS.client.unread.getGroup(_current_model_ob_id);if(group){if(group.collapsed){api_args.current_channel_timestamp=_init_timestamp;skip_channels.push(_current_model_ob_id)}else if(TS.client.unread.getNewestMsgTs(group)){api_args.current_channel_timestamp=TS.client.unread.getNewestMsgTs(group)}}}if(_should_record_metrics||TS.boot_data.feature_tinyspeck)TS.metrics.mark("unread_history_sort_marker");TS.client.unread.debug("Regular fetch using api_args: ",_.clone(api_args));TS.api.call("unread.history",api_args).then(function(resp){if(_should_record_metrics||TS.boot_data.feature_tinyspeck)TS.metrics.measureAndClear("unread_history_sort_"+api_args.sort,"unread_history_sort_marker");clearTimeout(_slow_loading_timeout);if(!TS.model.unread_view_is_showing)return;if(_backfilling_for_group){reject(new Error("unread.history rejected because we are now backfilling"))}else{resolve(_processResp(resp.data,skip_channels,!_current_model_ob_id))}}).catch(function(err){TS.error(err);clearTimeout(_slow_loading_timeout);TS.client.ui.unread.displayFatalError()})}})});return _more_messages_p},getMessage:function(model_ob,ts){if(!TS.model.unread_view_is_showing)return null;var group=TS.client.unread.getGroup(model_ob.id);if(!group)return null;return TS.utility.msgs.getMsg(ts,group.msgs)},getTotalMessagesCount:function(){return _groups.reduce(function(previous,current){return!current.marked_as_read?previous+current.msgs.length:previous},0)},getCurrentModelID:function(){return _current_model_ob_id},areAllMessagesFetched:function(){return _all_messages_fetched},getAllCurrentlyUnreadGroups:function(){return TS.channels.getUnarchivedChannelsForUser().concat(TS.groups.getUnarchivedGroups(),TS.model.mpims,TS.model.ims).filter(function(model_ob){return model_ob.unread_cnt>0?true:false})},getTotalNewUnreadCount:function(){var count=_groups.reduce(function(total,group,i){return group.new_unread_msgs?total+group.new_unread_msgs.length:total},0);if(_orphan_new_msgs){count=Object.keys(_orphan_new_msgs).reduce(function(total,group,i){return total+_orphan_new_msgs[group].length},count)}return count},moveActiveMarker:function(backwards){var new_index=0;var active_group_index=_.findIndex(_groups,{active:true});if(active_group_index!=-1){new_index=backwards?active_group_index-1:active_group_index+1}if(new_index>=0&&_groups[new_index]){if(_groups[active_group_index])_groups[active_group_index].active=false;_groups[new_index].active=true;return _groups[new_index]}},setActiveGroup:function(group){var current_group=TS.client.unread.getActiveGroup();if(current_group)current_group.active=false;group.active=true;return group},getActiveGroup:function(){return _.find(_groups,{active:true})},getSortOrder:function(){return _sort_order},test:function(){var test_ob={_current_model_ob_id:null,_processResp:_processResp,_resetData:_resetData,_messageReceived:_messageReceived,_appendNewUnreadToGroup:_appendNewUnreadToGroup,_messageChanged:_messageChanged,_messageRemoved:_messageRemoved,_toggleUnreadView:_toggleUnreadView,_groups:[],_all_messages_fetched:false,_more_messages_p:undefined,_init_timestamp:undefined};Object.defineProperty(test_ob,"_processResp",{get:function(){return _processResp},set:function(v){_processResp=v}});Object.defineProperty(test_ob,"_resetData",{get:function(){return _resetData},set:function(v){_resetData=v}});Object.defineProperty(test_ob,"_current_model_ob_id",{get:function(){return _current_model_ob_id},set:function(v){_current_model_ob_id=v}});Object.defineProperty(test_ob,"_groups",{get:function(){return _groups},set:function(v){_groups=v}});Object.defineProperty(test_ob,"_all_messages_fetched",{get:function(){return _all_messages_fetched},set:function(v){_all_messages_fetched=v}});Object.defineProperty(test_ob,"_more_messages_p",{get:function(){return _more_messages_p},set:function(v){_more_messages_p=v}});Object.defineProperty(test_ob,"_messageReceived",{get:function(){return _messageReceived},set:function(v){_messageReceived=v}});Object.defineProperty(test_ob,"_messageChanged",{get:function(){return _messageChanged},set:function(v){_messageChanged=v}});Object.defineProperty(test_ob,"_messageRemoved",{get:function(){return _messageRemoved},set:function(v){_messageRemoved=v}});Object.defineProperty(test_ob,"_appendNewUnreadToGroup",{get:function(){return _appendNewUnreadToGroup},set:function(v){_appendNewUnreadToGroup=v}});Object.defineProperty(test_ob,"_toggleUnreadView",{get:function(){return _toggleUnreadView},set:function(v){_toggleUnreadView=v}});Object.defineProperty(test_ob,"_init_timestamp",{get:function(){return _init_timestamp},set:function(v){_init_timestamp=v}});Object.defineProperty(test_ob,"_backfilling_for_group",{get:function(){return _backfilling_for_group},set:function(v){_backfilling_for_group=v}});Object.defineProperty(test_ob,"_excluded_groups",{get:function(){return _excluded_groups},set:function(v){_excluded_groups=v}});Object.defineProperty(test_ob,"_orphan_new_msgs",{get:function(){return _orphan_new_msgs},set:function(v){_orphan_new_msgs=v}});Object.defineProperty(test_ob,"_direct_from_boot",{get:function(){return _direct_from_boot},set:function(v){_direct_from_boot=v}});Object.defineProperty(test_ob,"_sortAndDedupe",{get:function(){return _sortAndDedupe},set:function(v){_sortAndDedupe=v}});Object.defineProperty(test_ob,"_backfilling_was_all_fetched",{get:function(){return _backfilling_was_all_fetched},set:function(v){
_backfilling_was_all_fetched=v}});return test_ob}});var _should_record_metrics;var _groups=[];var _excluded_groups=[];var _current_model_ob_id=null;var _all_messages_fetched=false;var _more_messages_p;var _init_timestamp;var _backfilling_for_group=null;var _backfilling_was_all_fetched;var _orphan_new_msgs={};var _slow_loading_timeout;var _direct_from_boot;var _coachmark_has_been_displayed=false;var _sort_order;var _debug_data=[];var _debug_seen_model_ids=[];var _channelConsistencyCheck=function(){if(_direct_from_boot)return;var unread_models=TS.client.unread.getAllCurrentlyUnreadGroups();var mismatched_models=[];unread_models.forEach(function(model_ob){if(_debug_seen_model_ids.indexOf(model_ob.id)===-1&&model_ob.oldest_unread_ts<_init_timestamp){mismatched_models.push(model_ob)}});if(mismatched_models.length>0){TS.metrics.count("unread_view_consistency_fail");TS.metrics.count("unread_view_consistency_fail_"+TS.client.unread.getSortOrder());TS.metrics.count("unread_view_consistency_fail_count",mismatched_models.length);TS.client.unread.debug("Consistency check: Unread models",_.map(unread_models,"id"));TS.client.unread.debug("Consistency check: Mismatched models: ",_.map(mismatched_models,"id"));if(mismatched_models.length>2){TS.logError(_debug_data,"all_unreads_consistency_debug")}}};var _processResp=function(data,skip_channels,first_fetch){skip_channels=skip_channels||[];var processed_data={groups:[],has_more:true};TS.info("Received unread view response: "+data.channels_count+" channels; "+data.total_messages_count+" total messages ("+(first_fetch?"first fetch":"subsequent fetch")+")");TS.client.unread.debug("Process response starting info:",{first_fetch:first_fetch,skip_channels:skip_channels,channels_count:data.channels_count,total_messages_count:data.total_messages_count,channels:data.channels.map(function(unread_obj){return{channel_id:unread_obj.channel_id,msg_count:unread_obj.messages?unread_obj.messages.length:null,collapsed:unread_obj.collapsed,total_unreads:unread_obj.total_unreads,has_more:unread_obj.has_more}})});if(first_fetch){if(_should_record_metrics)TS.metrics.count("unread_view_fetched_channels_first",data.channels_count);if(_should_record_metrics)TS.metrics.count("unread_view_fetched_messages_first",data.total_messages_count)}if(data.channels.length&&skip_channels.length){_.remove(data.channels,function(c){return skip_channels.indexOf(c.channel_id)!==-1})}if(data.channels.length===0||data.channels.length===1&&!data.channels[0].has_more&&(!data.channels[0].messages||data.channels[0].messages.length===0)){_all_messages_fetched=true;processed_data.has_more=false;TS.client.unread.debug("DONE FETCHING: API response had no messages",data.channels.length);_channelConsistencyCheck();return processed_data}if(data.channels.length===1&&data.channels[0].messages.length===0&&data.channels[0].collapsed&&TS.client.unread.getGroup(data.channels[0].channel_id)&&TS.client.unread.getGroup(data.channels[0].channel_id).collapsed&&TS.client.unread.getGroup(data.channels[0].channel_id).msgs.length===0){_all_messages_fetched=true;processed_data.has_more=false;TS.client.unread.debug("DONE FETCHING: Received only one collapsed group with zero messages");_channelConsistencyCheck();return processed_data}var last_channel=_.last(data.channels);var last_has_more=last_channel.has_more;data.channels.forEach(function(unread_obj){_current_model_ob_id=unread_obj.channel_id;var model_ob=TS.shared.getModelObById(_current_model_ob_id);var group=TS.client.unread.getGroup(_current_model_ob_id);var msgs=[];_debug_seen_model_ids.push(unread_obj.channel_id);if(group){msgs=unread_obj.messages.map(function(msg){return TS.utility.msgs.processImsg(msg,model_ob.id)});msgs=group.msgs.concat(msgs);if(group.collapsed){group.hidden_msgs=group.hidden_msgs.concat(msgs);group.marked_as_read_cnt=group.hidden_msgs.length}else{group.msgs=msgs}group.has_more=unread_obj.has_more}else{if(!unread_obj.has_more&&!unread_obj.collapsed&&!unread_obj.messages.length){TS.warn("Received model_ob with no messages for unread view: "+_current_model_ob_id);TS.client.unread.debug("all_unreads_ignored_channel no msgs",{current_model_ob_id:_current_model_ob_id,unread_obj_id:unread_obj.channel_id,has_more:unread_obj.has_more,collapsed:!!unread_obj.collapsed,msg_count:unread_obj.messages.length});return}if(!(first_fetch&&_direct_from_boot)&&model_ob.unread_cnt===0){TS.client.unread.debug("all_unreads_ignored_channel model_ob has no unreads",{current_model_ob_id:_current_model_ob_id,unread_obj_id:unread_obj.channel_id,model_ob_id:model_ob.id,model_ob_unread_cnt:model_ob.unread_cnt,first_fetch:first_fetch,direct_from_boot:_direct_from_boot});return}msgs=unread_obj.messages.map(function(msg){return TS.utility.msgs.processImsg(msg,model_ob.id)});group={id:_current_model_ob_id,order:_groups.length,msgs:msgs,hidden_msgs:[],model_ob:model_ob,marked_as_read:false,new_unread_cnt:0,collapsed:unread_obj.collapsed,total_unreads:unread_obj.total_unreads,has_more:unread_obj.has_more};_groups.push(group)}if(!group.has_more&&_orphan_new_msgs[group.id]){_orphan_new_msgs[group.id].forEach(function(msg){_appendNewUnreadToGroup(group,msg)});delete _orphan_new_msgs[group.id]}_sortAndDedupe(group,"msgs");TS.client.unread.messages_loaded=true;processed_data.groups.push(group)});if(data.groups){data.groups.forEach(function(group){_groups.push(group);processed_data.groups.push(group);last_has_more=group.has_more})}if(!last_has_more){_all_messages_fetched=true;processed_data.has_more=false}if(first_fetch&&_groups.length&&!TS.client.unread.getActiveGroup()){_groups[0].active=true}TS.client.unread.debug("Process response, processed data",{has_more:processed_data.has_more,touched_groups:processed_data.groups.map(function(g){return{channel_id:g.id,has_more:g.has_more,msg_count:g.msgs.length,marked_as_read:g.marked_as_read,collapsed:g.collapsed}}),all_groups:_groups.map(function(g){return{channel_id:g.id,has_more:g.has_more,msg_count:g.msgs.length,marked_as_read:g.marked_as_read,collapsed:g.collapsed}})});if(!last_has_more){TS.client.unread.debug("DONE FETCHING: Last group has no more messages");_channelConsistencyCheck()}return processed_data};var _sortAndDedupe=function(group,collection_key){collection_key=collection_key||"msgs";TS.utility.msgs.sortMsgs(group[collection_key]);group[collection_key]=_.uniqBy(group[collection_key],"ts");return group};var _messageReceived=function(model_ob,msg){if(!TS.model.unread_view_is_showing)return;if(TS.utility.msgs.isMsgHidden(msg))return;if(msg.is_ephemeral)return;if(msg.user===TS.model.user.id)return;if(_.startsWith(msg.subtype,"sh_room"))return;if(TS.utility.msgs.isMsgHidden(msg))return;if(TS.utility.msgs.msgMightBeRolledUp(msg))return;var model_ob_is_muted_or_archived=model_ob.is_channel&&model_ob.is_archived||TS.notifs.isCorGMuted(model_ob.id);if(!model_ob_is_muted_or_archived&&TS.client.ui.unread.isFatalErrorDisplaying()){TS.client.unread.reload();return}var group=TS.client.unread.getGroup(model_ob.id);if(group){TS.client.ui.unread.updateNewMessagesMessage(_appendNewUnreadToGroup(group,msg))}else if(!model_ob.is_channel||!model_ob_is_muted_or_archived){if(!_orphan_new_msgs[model_ob.id])_orphan_new_msgs[model_ob.id]=[];_orphan_new_msgs[model_ob.id].push(msg)}if(!model_ob_is_muted_or_archived){if(_.indexOf(TS.client.unread.new_messages_in_channels,model_ob.id)===-1){TS.client.unread.new_messages_in_channels.push(model_ob.id)}}TS.client.ui.unread.showOrHideRefreshButton()};var _messageChanged=function(model_ob,msg){if(!TS.model.unread_view_is_showing)return;if(_orphan_new_msgs[model_ob.id]){var orphan_msg_index=_.findIndex(_orphan_new_msgs[model_ob.id],{ts:msg.ts});_orphan_new_msgs[model_ob.id].splice(orphan_msg_index,1,TS.utility.msgs.processImsg(msg,model_ob.id))}var group=TS.client.unread.getGroup(model_ob.id);if(!group)return;var msg_index=_.findIndex(group.msgs,{ts:msg.ts});var new_msg_index=_.findIndex(group.new_unread_msgs,{ts:msg.ts});if(new_msg_index>=0){group.msgs.splice(new_msg_index,1,TS.utility.msgs.processImsg(msg,model_ob.id))}if(msg_index>=0){group.msgs.splice(msg_index,1,TS.utility.msgs.processImsg(msg,model_ob.id));TS.client.ui.unread.updateMsgs()}};var _messageRemoved=function(model_ob,msg){if(!TS.model.unread_view_is_showing)return;if(_orphan_new_msgs[model_ob.id]){_.remove(_orphan_new_msgs[model_ob.id],{ts:msg.ts});if(!_orphan_new_msgs[model_ob.id].length){delete _orphan_new_msgs[model_ob.id]}}var group=TS.client.unread.getGroup(model_ob.id);if(!group){if(!_orphan_new_msgs[model_ob.id]){_.pull(TS.client.unread.new_messages_in_channels,model_ob.id)}TS.client.ui.unread.showOrHideRefreshButton();return}var msg_index=_.findIndex(group.msgs,{ts:msg.ts});var new_msg_index=_.findIndex(group.new_unread_msgs,{ts:msg.ts});if(new_msg_index>=0){group.new_unread_msgs.splice(new_msg_index,1);group.new_unread_cnt=group.new_unread_msgs.length;TS.client.ui.unread.updateNewMessagesMessage(group)}if(msg_index>=0){group.msgs.splice(msg_index,1);group.total_unreads--;if(group.msgs.length===0){_onDelete(group.model_ob)}else{TS.client.ui.unread.updateMsgs()}}};var _appendNewUnreadToGroup=function(group,msg){var existing_msg=_.find(group.msgs,{ts:msg.ts});if(existing_msg)return group;if(!group.first_new_unread_ts)group.first_new_unread_ts=msg.ts;msg=TS.utility.msgs.processImsg(msg,group.id);if(!group.new_unread_msgs)group.new_unread_msgs=[];group.new_unread_msgs.push(msg);_sortAndDedupe(group,"new_unread_msgs");group.new_unread_cnt=group.new_unread_msgs.length;return group};var _fileChanged=function(file){if(!TS.model.unread_view_is_showing)return;var groups_to_update=_.intersection(_.map(_groups,"id"),file.channels.concat(file.ims,file.groups));if(!groups_to_update.length)return;groups_to_update.forEach(function(model_ob_id){var group=TS.client.unread.getGroup(model_ob_id);group.msgs.forEach(function(m){if(!file.is_deleted&&(m.subtype=="file_share"||m.subtype=="file_mention"||m.subtype=="file_comment")&&m.file&&m.file.id==file.id){}else if(m.attachments&&m.attachments.length&&TS.inline_attachments.getAttachmentBySlackFileId(m.attachments,file.id)){}else{return}if(file.mode==="hosted"||file.mode==="external"){if(file.comments.length||file.is_tombstoned==false){_messageChanged(group.model_ob,m)}else{return}}TS.client.ui.unread.rebuildMsgFile(m,file)})})};var _onDelete=function(model_ob){var group=TS.client.unread.getGroup(model_ob.id);if(group){TS.client.ui.unread.removeMessageContainerGroup([model_ob.id]);_.remove(_groups,{id:model_ob.id});if(_current_model_ob_id===model_ob.id){var last_group=_.last(_groups);if(last_group){_current_model_ob_id=last_group.id}}TS.client.ui.unread.updateMsgs()}};var _toggleUnreadView=function(){TS.client.ui.unread.toggleUnreadView();if(!TS.model.prefs.enable_unread_view&&TS.model.unread_view_is_showing){TS.client.displayModelOb(TS.shared.getActiveModelOb());TS.client.unread.destroyUnreadView()}};var _resetData=function(){_backfilling_for_group=null;_backfilling_was_all_fetched=undefined;_excluded_groups=[];_all_messages_fetched=false;_current_model_ob_id=null;_groups=[];_more_messages_p=undefined;_init_timestamp=TS.utility.date.makeTsStamp(null,"0",9);TS.client.unread.new_messages_in_channels=[];_orphan_new_msgs={};if(_slow_loading_timeout){clearTimeout(_slow_loading_timeout);_slow_loading_timeout=null}_debug_data=[];_debug_seen_model_ids=[]};var _addUnreadSignals=function(){TS.channels.unread_changed_sig.add(_handleAllUnreadSignals);TS.groups.unread_changed_sig.add(_handleAllUnreadSignals);TS.ims.unread_changed_sig.add(_handleAllUnreadSignals);TS.mpims.unread_changed_sig.add(_handleAllUnreadSignals)};var _removeUnreadSignals=function(){TS.channels.unread_changed_sig.remove(_handleAllUnreadSignals);TS.groups.unread_changed_sig.remove(_handleAllUnreadSignals);TS.ims.unread_changed_sig.remove(_handleAllUnreadSignals);TS.mpims.unread_changed_sig.remove(_handleAllUnreadSignals)};var _handleAllUnreadSignals=_.throttle(function(){_maybeDisplayCoachmark();TS.client.ui.unread.updateChannelPaneUnreadState(TS.model.all_unread_cnt>0&&TS.client.unread.getAllCurrentlyUnreadGroups().length>0)},1e3);var _stopBackfilling=function(){if(_backfilling_for_group){_excluded_groups=[];_backfilling_for_group=null;_all_messages_fetched=_backfilling_was_all_fetched;_backfilling_was_all_fetched=undefined;TS.client.ui.unread.setMessageContainerHasMoreEnd(!_all_messages_fetched)}};var _maybeDisplayCoachmark=function(){if(TS.client.unread.isEnabled()||TS.model.prefs.seen_unread_view_coachmark)return;if(TS.client.unread.isEnabled()||TS.model.prefs.seen_unread_view_coachmark){_removeUnreadSignals();return}if(TS.model.all_unread_cnt>100){var total_unread_models=TS.client.unread.getAllCurrentlyUnreadGroups();if(total_unread_models.length>10){_removeUnreadSignals();_displayCoachmark()}}};var _displayCoachmark=function(){if(TS.client.unread.isEnabled())return;if(TS.model.prefs.seen_unread_view_coachmark)return;TS.model.prefs.seen_unread_view_coachmark=true;TS.prefs.setMultiPrefsByAPI({enable_unread_view:true,seen_unread_view_coachmark:true},function(){TS.metrics.count("unread_view_coachmark_displayed");_coachmark_has_been_displayed=true;$("#channels_scroller").scrollTop(0);TS.coachmark.start(TS.coachmarks.coachmarks.unread_view)})};var _setSortOrder=function(){if(TS.model.prefs.all_unreads_sort_order){_sort_order=TS.model.prefs.all_unreads_sort_order}else{TS.experiment.loadUserAssignments().then(function(){if(TS.model.team.plan!==""){var group=TS.experiment.getGroup("all_unreads_sort_order");if(group==="default_alphabetical"){_sort_order="alphabetical"}else if(group==="default_sli"){_sort_order="priority"}else{_sort_order="alphabetical"}}else{_sort_order="alphabetical"}})}}})();(function(){"use strict";TS.registerModule("client.ui.unread",{$channel_pane_item:$("#channels_scroller .all_unreads"),$scroller:$("#unread_msgs_scroller_div"),$unread_msgs_div:null,$container:null,unread_groups:[],showUnreadView:function(){TS.channels.renamed_sig.add(_onRename);TS.groups.renamed_sig.add(_onRename);TS.inline_file_previews.collapse_sig.add(_updateUnreadGroupPositions);TS.inline_file_previews.expand_sig.add(_updateUnreadGroupPositions);TS.inline_others.collapse_sig.add(_updateUnreadGroupPositions);TS.inline_others.expand_sig.add(_updateUnreadGroupPositions);TS.inline_audios.collapse_sig.add(_updateUnreadGroupPositions);TS.inline_audios.expand_sig.add(_updateUnreadGroupPositions);TS.inline_videos.collapse_sig.add(_updateUnreadGroupPositions);TS.inline_videos.expand_sig.add(_updateUnreadGroupPositions);TS.inline_room_previews.toggle_sig.add(_updateUnreadGroupPositions);TS.inline_imgs.expand_sig.add(_updateUnreadGroupPositions);TS.inline_imgs.collapse_sig.add(_updateUnreadGroupPositions);TS.inline_attachments.expand_sig.add(_updateUnreadGroupPositions);TS.inline_attachments.collapse_sig.add(_updateUnreadGroupPositions);TS.prefs.a11y_font_size_changed_sig.add(_updateStickyHeader);TS.prefs.a11y_font_size_changed_sig.add(_updateUnreadGroupPositions);_initialized_time=Date.now();_keyboard_in_use=false;$("#client-ui").addClass("unread_view_is_showing");$("#msgs_scroller_div").addClass("hidden");$("#archives_return").addClass("hidden");if(TS.model.ui_state.flex_name==="details")TS.client.ui.flex.hideFlex(true);var skip_mark_msgs_read_immediate_check=true;TS.client.msg_pane.hideNewMsgsBar(skip_mark_msgs_read_immediate_check);TS.client.ui.unread.$scroller.html(TS.templates.unread_main());TS.client.ui.unread.$unread_msgs_div=$("#unread_msgs_div");if(TS.environment.supports_custom_scrollbar){TS.client.ui.unread.$container=$("#unread_msgs_scroller_div")}else{TS.client.ui.unread.$scroller.monkeyScroll();TS.client.ui.unread.$container=$("#monkey_scroll_wrapper_for_unread_msgs_scroller_div")}$("#footer").addClass("invisible");_onResize();TS.view.resize_sig.add(_onResize);TS.client.ui.unread.$unread_msgs_div.on("click.unread",".bottom_mark_all_read_btn",function(){TS.client.unread.markAllAsRead()});TS.client.ui.unread.$unread_msgs_div.on("click.unread",".unread_group_mark",function(e){var model_ob_id=$(e.target).closest(".unread_group").data("model-id");var group=TS.client.unread.getGroup(model_ob_id);if(!group||group.marked_as_read)return;TS.client.ui.unread.markGroupAsRead(model_ob_id)});TS.client.ui.unread.$unread_msgs_div.on("click.unread",".unread_group_undo > a",function(e){TS.client.ui.unread.markGroupAsUnread($(e.target).closest(".unread_group").data("model-id"))});TS.client.ui.unread.$unread_msgs_div.on("click.unread",".unread_group_header_name .channel_link, .unread_group_header_name .mpim_link, .unread_group_header_name .internal_im_link",function(e){if(TS.client.unread.shouldRecordMetrics())TS.metrics.count("unread_view_channel_navigation")});TS.client.ui.unread.$unread_msgs_div.on("click.unread",".unread_group_new",function(e){var group=TS.client.unread.getGroup($(e.target).closest(".unread_group").data("model-id"));if(group.collapsed){if(group.marked_as_read){TS.client.unread.moveNewUnreadsOntoHiddenMsgs(group)}TS.client.ui.unread.expandGroup(group)}else{TS.client.ui.unread.updateGroupWithNewMessages(group)}});TS.client.ui.unread.$unread_msgs_div.on("click.unread",".unread_group_collapse_toggle",function(e){var group=TS.client.unread.getGroup($(e.target).closest(".unread_group").data("model-id"));if(group){if(group.collapsed){TS.client.ui.unread.expandGroup(group,{persist_state:true})}else{var $group=_getGroupElement(group);var $msgs_holder=$group.find(".unread_group_msgs");TS.client.ui.unread.collapseGroup(group,$msgs_holder,{persist_state:true})}}});_currently_changing_active_group=false;$(window).on("keydown.unread",function(e){_onKeyDown(e)});if(!TS.model.supports_sticky_position){if($("body").hasClass("banner_showing")){_updateBannerHeight()}TS.ui.banner.show_hide_sig.add(_updateBannerHeight);var updated_sig=new signals.Signal;_throttled_update_sticky_header=_.throttle(_updateStickyHeader,16,{leading:true,trailing:false});TS.client.ui.unread.$scroller.on("scroll",_throttled_update_sticky_header);updated_sig.add(_updateUnreadGroupPositions)}_msgs_config={name:"unread",container:$("#unread_msgs_div"),scroller:$("#unread_msgs_scroller_div"),page_size:25,sections:[],has_more_beginning:false,has_more_end:false,updated_sig:updated_sig,promiseToLoadMoreAtEnd:function(){return TS.client.ui.unread.promiseToShowNextPage()},buildMsgHTML:function(msg,prev_msg,section){var $msg=$(TS.templates.builders.buildMsgHTML({msg_dom_id:TS.templates.makeMsgDomIdInUnreadView(msg.ts),msg:msg,model_ob:section.model_ob,prev_msg:prev_msg,container_id:"unread_msgs_div",enable_slack_action_links:true,hide_actions:false}));if(_fade_in_messages)$msg.css("opacity",0);return $msg},buildSection:function(section){return TS.templates.unread_group(_buildTemplateArgs(section))},buildDayDivider:function(section,msg){var ts=msg.ts;var date=TS.utility.date.toDateObject(ts);var is_today=TS.utility.date.isToday(date);var $divider=$(TS.templates.unread_day_divider({ts:ts,is_today:is_today}));if(_fade_in_messages)$divider.css("opacity",0);return $divider},updateCallback:function(changes){var manually_marked_unread_msgs=TS.client.unread.getAllGroups().map(function(group){return group.manually_marked_unread_msg});changes.added.forEach(function($added_msg){if(!$added_msg.data("ts"))return;var msg_id=$added_msg.data("ts");if(manually_marked_unread_msgs.indexOf(msg_id)>=0){var model_ob_id=$added_msg.data("modelObId");_setUnreadPoint(msg_id,model_ob_id,$added_msg)}})}};TS.ui.message_container.register(_msgs_config);_preloadEmptyState();TS.client.ui.unread.$scroller.attr("tabindex","-1");TS.client.ui.unread.$scroller.get(0).focus();TS.client.ui.rebuildAllButMsgs();TS.client.ui.unread.promiseToShowNextPage().then(function(){if(TS.client.unread.shouldRecordMetrics())TS.metrics.measureAndClear("unread_view_time_to_display","unread_view_time_to_display");if(!TS.model.unread_view_is_showing)return;if(TS.client.unread.getAllGroups().length){_transitionToMessages()}else{var marked_as_read_cnt;var skip_delay=true;TS.client.ui.unread.displayEmptyState(marked_as_read_cnt,skip_delay)}});TS.client.ui.unread.$unread_msgs_div.on("click.unread",".message[data-ts]",function(e){if(e.altKey){var $msg=$(e.target).closest(".message");var msg_id=$msg.data("ts");var model_ob_id=$(e.target).closest(".message").data("modelObId");_setUnreadPoint(msg_id,model_ob_id,$msg)}});TS.utility.queueRAF(function(){$(".channels_nav_unread").scrollintoview({offset:"top",px_offset:50,scroller:TS.client.channel_pane.$scroller})});TS.clog.track("UNREADS_OPEN",{})},promiseToShowNextPage:function(){if(_currently_loading_more_promise&&_currently_loading_more_promise.isPending())return _currently_loading_more_promise;_currently_loading_more_promise=TS.client.unread.promiseToGetMoreMessages().then(function(msgs_data){if(!TS.model.unread_view_is_showing)return;_tracking_data.unreads_page++;TS.client.ui.unread.addMessageContainerGroups(msgs_data.groups);TS.client.ui.unread.setMessageContainerHasMoreEnd(!!msgs_data.has_more);_onResize();_checkToShowEmptyState();if(_move_active_marker_after_next_page){var backwards=false;var current_group=TS.client.unread.getActiveGroup();var target_group=TS.client.unread.moveActiveMarker(backwards);_changeActiveElement(target_group,current_group,{collapse_current_group:false});_move_active_marker_after_next_page=false}_currently_loading_more_promise=null;return null}).catch(function(err){TS.error(err)});return _currently_loading_more_promise},removeMessageContainerGroup:function(model_ob_ids){_msgs_config.sections=_msgs_config.sections.filter(function(section){return model_ob_ids.indexOf(section.id)===-1});_msgs_config.has_more_end=true;return _msgs_config},addMessageContainerGroups:function(groups){_.forEach(groups,function(data_ob){var group=TS.client.unread.getGroup(data_ob.id);var inx=_.findIndex(_msgs_config.sections,{id:group.id});if(-1===inx){_msgs_config.sections.push(group)}})},setMessageContainerHasMoreEnd:function(has_more_end){_msgs_config.has_more_end=has_more_end},restart:function(){TS.client.ui.unread.showOrHideRefreshButton();TS.ui.message_container.cleanup(_msgs_config);TS.client.ui.unread.$unread_msgs_div.empty();_msgs_config.sections=[];_msgs_config.has_more_end=false;TS.ui.message_container.register(_msgs_config);TS.client.ui.unread.$scroller.addClass("loading");_preloadEmptyState();_keyboard_in_use=false;TS.client.ui.unread.promiseToShowNextPage().then(function(){if(!TS.model.unread_view_is_showing)return;if(TS.client.unread.getAllGroups().length){_transitionToMessages()}else{var marked_as_read_cnt;var skip_delay=true;TS.client.ui.unread.displayEmptyState(marked_as_read_cnt,skip_delay)}})},displaySlowLoadingMessage:function(){if(TS.client.ui.unread.$scroller.hasClass("loading"))TS.client.ui.unread.$scroller.addClass("loading-slow")},isFatalErrorDisplaying:function(){return $("#messages_container .unread_error_state").length},displayFatalError:function(){TS.client.ui.unread.$scroller.addClass("invisible");$("#messages_container .unread_empty_state_wrapper").remove();$("#messages_container").prepend(TS.templates.unread_error({emoji:new Handlebars.SafeString(TS.emoji.graphicReplace(":tropical_fish:",{jumbomoji:true}))}));$(".unread_error_state_refresh_button").on("click",function(){TS.client.unread.reload()});_.defer(function(){$("#messages_container .unread_empty_state").addClass("transitioning")})},displayEmptyState:function(marked_as_read_cnt,skip_delay){TS.client.ui.unread.$scroller.addClass("invisible");$("#messages_container .unread_empty_state_wrapper").remove();$("#messages_container").prepend(TS.templates.unread_empty_state({line_one:_preloaded_empty_state.line_one,line_two:_preloaded_empty_state.line_two,emoji:_preloaded_empty_state.emoji_url,marked_as_read_cnt:marked_as_read_cnt}));_.defer(function(){$("#messages_container .unread_empty_state").addClass("transitioning");var $undo=$("#messages_container .unread_empty_state_undo");if($undo.length){$undo.addClass("unread_empty_state_undo_visible");_.delay(function(){$undo.removeClass("unread_empty_state_undo_visible")},10300);$(".unread_empty_state_undo_action").one("click",function(){TS.client.unread.markAllAsUnread();TS.client.ui.unread.updateChannelHeader()})}});if(!skip_delay){_delay_refresh_button=true;_.delay(function(){_delay_refresh_button=false;TS.client.ui.unread.showOrHideRefreshButton()},2e3)}else{_delay_refresh_button=false}TS.client.ui.unread.updateChannelHeader();TS.client.ui.unread.showOrHideRefreshButton()},removeEmptyState:function(){$(window).off("keydown.unread_empty_state");$("#messages_container .unread_empty_state_wrapper").remove();$("#messages_container .unread_empty_state_undo").remove();TS.client.ui.unread.$scroller.removeClass("invisible");_delay_refresh_button=false},showOrHideRefreshButton:function(){var unreads_count=TS.client.unread.getTotalNewUnreadCount();var $empty=$("#messages_container .unread_empty_state");var $refresh=$(".unread_empty_state_refresh");if(unreads_count>0&&TS.client.unread.new_messages_in_channels.length){$("#channel_header_unread_refresh").removeClass("hidden")}else{$("#channel_header_unread_refresh").addClass("hidden");if($refresh)$refresh.remove()}if(unreads_count>0&&$empty.length&&TS.client.unread.new_messages_in_channels.length&&!$empty.hasClass("unread_error_state")){if($refresh.length>0){$refresh.html($(TS.templates.unread_empty_state_refresh({unreads_count:unreads_count})).html())}else{if(_delay_refresh_button)return;$empty.append(TS.templates.unread_empty_state_refresh({unreads_count:unreads_count}));$empty.addClass("faded");$empty.addClass("with_refresh");$(window).on("keydown.unread_empty_state",function(e){if(TS.model.unread_view_is_showing&&e.which==TS.utility.keymap.enter&&TS.client.ui.isUserAttentionOnChat()&&!TS.utility.isFocusOnInput()){TS.client.unread.reload()}})}$(".unread_empty_state_refresh_button").on("click",function(){TS.client.unread.reload()})}},destroyUnreadView:function(){if(!TS.client.ui.unread.isUnreadViewDOMShowing())return;$(window).off("keydown.unread");if(_currently_loading_more_promise&&_currently_loading_more_promise.isPending())_currently_loading_more_promise.cancel();TS.client.ui.unread.$scroller.removeAttr("tabindex");var $client_ui=$("#client-ui");$client_ui.removeClass("unread_view_is_showing");$("#msgs_scroller_div").removeClass("hidden");TS.ui.message_container.cleanup(_msgs_config);_msgs_config=null;TS.client.ui.unread.removeEmptyState();TS.client.ui.unread.$unread_msgs_div.off("click.unread",".unread_group_mark");TS.client.ui.unread.$unread_msgs_div.off("click.unread",".unread_group_undo > a");if(!TS.model.supports_sticky_position){TS.client.ui.unread.$scroller.off("scroll",_throttled_update_sticky_header);TS.ui.banner.show_hide_sig.remove(_updateBannerHeight)}TS.client.ui.unread.$unread_msgs_div.empty();TS.client.ui.unread.$scroller.addClass("loading");$("#footer").removeClass("invisible");TS.view.resize_sig.remove(_onResize);TS.channels.renamed_sig.remove(_onRename);TS.groups.renamed_sig.remove(_onRename);TS.client.ui.unread.unread_groups=null;$_currently_sticky=null;if(!TS.boot_data.feature_message_replies_threads_view){if(!TS.model.ui_state.flex_name&&TS.model.ui_state.details_tab_active){TS.client.ui.flex.openFlexTab("details",true)}}var payload=TS.client.ui.unread.getTrackingData();TS.clog.track("UNREADS_CLOSE",payload);_initialized_time=0;_tracking_data={unreads_event_seq_id:0,unreads_elasped_time:0,unreads_page:0,unreads_page_message_index:0}},isUnreadViewDOMShowing:function(){return $("#client-ui").hasClass("unread_view_is_showing")},collapseGroup:function(group,$msgs_holder,opts){opts=_.extend({persist_state:false,add_classname:true,scroll_group:true},opts||{});if(group.collapsed)return Promise.resolve(group);TS.client.unread.collapseGroup(group,opts.persist_state);return new Promise(function(resolve,reject){var $group=_getGroupElement(group);var collapsed_group_offset=$group.offset().top;$group.addClass("collapsing");TS.client.ui.unread.updateHeader(group);$msgs_holder.animate({opacity:0},300,function(){$group.removeClass("collapsing");if(opts.add_classname)$group.addClass("collapsed");TS.client.ui.unread.updateMsgs();if(opts.scroll_group&&collapsed_group_offset<0){_scrollGroupElementToTop($group)}_updateUnreadGroupPositions();if(!TS.model.supports_sticky_position)_updateStickyHeader();$msgs_holder.css("opacity",1);resolve(group)})})},expandGroup:function(group,opts){opts=_.extend({persist_state:false},opts||{});var $group=_getGroupElement(group);if(!group.collapsed||$group.hasClass("collapsing")||!$group.hasClass("collapsed"))return Promise.resolve(group);return new Promise(function(resolve,reject){TS.client.unread.expandGroup(group,opts.persist_state);TS.client.ui.unread.updateHeader(group);$group.removeClass("collapsed");$group.removeClass("marked_as_read");$group.removeClass("with_footer");_fade_in_messages=true;TS.client.ui.unread.$unread_msgs_div.css("height",TS.client.ui.unread.$unread_msgs_div.height());var changes=TS.client.ui.unread.updateMsgsWithFocus($group);_fade_in_messages=false;if(_currently_loading_more_promise){_currently_loading_more_promise.then(function(){TS.client.ui.unread.$unread_msgs_div.css("height","auto")})}else{TS.client.ui.unread.$unread_msgs_div.css("height","auto")}TS.client.ui.unread.updateNewMessagesMessage(group);changes.added.forEach(function($msg){$msg.animate({opacity:1},300)});_updateUnreadGroupPositions();if(!TS.model.supports_sticky_position)_updateStickyHeader();resolve(group)})},markGroupAsRead:function(model_ob_id){var group=TS.client.unread.getGroup(model_ob_id);if(!group)return;TS.client.unread.markGroupAsRead(group);TS.client.ui.unread.updateChannelHeader();var $group=_getGroupElement(group);var $msgs_holder=$group.find(".unread_group_msgs");if(group.new_unread_cnt<1){$group.addClass("marked_as_read")}if($msgs_holder.length){if(!group.new_unread_cnt){_checkToShowEmptyState()}if(group.collapsed){TS.client.ui.unread.updateHeader(group)}else{var opts={add_classname:group.new_unread_cnt<1};return TS.client.ui.unread.collapseGroup(group,$msgs_holder,opts).then(function(group){if(group.new_unread_cnt>0){TS.client.ui.unread.updateGroupWithNewMessages(group)}else{TS.client.ui.unread.updateHeader(group)}})}}else{TS.client.ui.unread.updateMsgs()}return Promise.resolve()},markGroupAsUnread:function(model_ob_id){var group=TS.client.unread.getGroup(model_ob_id);if(!group)return;TS.client.unread.markGroupAsUnread(group);TS.client.ui.unread.expandGroup(group);TS.client.ui.unread.updateChannelHeader()},updateNewMessagesMessage:function(group){if(group.has_more)return;var $group=_getGroupElement(group);var $group_footer=$group.find(".unread_group_footer");if(group.collapsed){TS.client.ui.unread.updateHeader(group)}else{if(group.new_unread_cnt>0&&group.new_unread_msgs){$group_footer.find(".unread_group_new_text").text(TS.i18n.t("{new_unread_cnt, plural, =1 {# new message} other {# new messages}}","all_unreads")({new_unread_cnt:group.new_unread_cnt}));$group.addClass("with_footer")}else if($group_footer){$group.removeClass("with_footer")}}},updateHeader:function(group){var $group=_getGroupElement(group);$group.find(".unread_group_header").html(TS.templates.unread_group_header(_buildTemplateArgs(group)))},updateMsgs:function(){return TS.ui.message_container.update(_msgs_config)},updateMsgsWithFocus:function($section){return TS.ui.message_container.updateWithFocus(_msgs_config,$section)},updateGroupWithNewMessages:function(group){var $group=_getGroupElement(group);var original_height=$group.height();$group.height(original_height);TS.client.unread.updateGroupWithNewMessages(group);_fade_in_messages=true;var changes=TS.client.ui.unread.updateMsgsWithFocus($group);_fade_in_messages=false;$group.css("height","auto");var new_height=$group.height();$group.removeClass("with_footer");$group.height(original_height).animate({height:new_height,margin:0},300,function(){$group.css("height","");$group.css("margin","");changes.added.forEach(function($msg){$msg.animate({opacity:1},300)})});$group.removeClass("collapsed").removeClass("marked_as_read");
TS.client.ui.unread.updateHeader(group);_updateUnreadGroupPositions()},updateSidebarLink:function(){if(TS.model.unread_view_is_showing){$("#channels_scroller li.active").removeClass("active");$('li[data-action="show_unread_view"]').addClass("active")}else{$('li[data-action="show_unread_view"]').removeClass("active")}},toggleUnreadView:function(){if(TS.model.prefs.enable_unread_view){$(".channels_nav_unread").removeClass("hidden");$("#channels_nav").addClass("unread_enabled")}else{$(".channels_nav_unread").addClass("hidden");$(".all_unreads").removeClass("active");$("#channels_nav").removeClass("unread_enabled")}},updateChannelPaneUnreadState:function(is_unread){TS.client.ui.unread.$channel_pane_item.toggleClass("unread",is_unread)},rebuildMsgFile:function(msg,file){var $msg=TS.client.ui.unread.$unread_msgs_div.find("#"+TS.templates.makeMsgDomIdInUnreadView(msg.ts));if(!$msg||!$msg.length)return;var $file_container=$msg.find(".file_container");if(!$file_container||!$file_container.length)return;var data={file:file,is_message:true,msg_dom_id:$msg.attr("id")};if(file.mode==="post"||file.mode==="space"){$file_container.replaceWith(TS.templates.file_post(data))}else if(file.mode==="snippet"){$file_container.replaceWith(TS.templates.file_snippet(data))}else if(file.mode==="email"){$file_container.replaceWith(TS.templates.file_email(data))}else if(file.mode==="multnomah"){$file_container.replaceWith(TS.templates.file_multnomah(data))}else{return TS.warn("Trying to rebuild message file, but cannot rebuild "+file.mode)}TS.utility.makeSureAllLinksHaveTargets($msg);TS.ui.utility.updateClosestMonkeyScroller($msg)},updateChannelHeader:function(){var output=TS.templates.unread_header_info({is_showing:TS.model.unread_view_is_showing,has_new_messages:TS.model.unread_view_is_showing&&TS.client.unread.new_messages_in_channels.length,messages_loaded:TS.client.unread.messages_loaded,total_unread_count:TS.client.unread.getTotalMessagesCount(),sort_order:TS.client.unread.getSortOrder()});TS.client.channel_header.updateChannelHeaderInfo(output)},setUnreadPoint:function(msg_ts){var $msg=TS.client.ui.unread.$unread_msgs_div.find('ts-message[data-ts="'+msg_ts+'"]');var model_ob_id=$msg.data("modelObId");_setUnreadPoint(msg_ts,model_ob_id,$msg)},getTrackingData:function(msg_ts){var payload={is_unreads_view:true,unreads_event_seq_id:_tracking_data.unreads_event_seq_id,unreads_elasped_time:Date.now()-_initialized_time,unreads_page:_tracking_data.unreads_page};if(msg_ts){payload.unreads_page_message_index=_(TS.client.unread.getAllGroups()).map(function(group){return group.msgs}).flatten().reverse().findIndex({ts:msg_ts.toString()})}return payload},incrementTrackingSeqId:function(){_tracking_data.unreads_event_seq_id++}});var _msgs_config;var _fade_in_messages=false;var $_currently_sticky=false;var _throttled_update_sticky_header;var _banner_height=0;var _preloaded_empty_state;var _currently_loading_more_promise=null;var _currently_changing_active_group=false;var _move_active_marker_after_next_page=false;var _skip_next_sticky_header_active_update=false;var _initialized_time=0;var _tracking_data={unreads_event_seq_id:0,unreads_elasped_time:0,unreads_page:0,unreads_page_message_index:0};var _delay_refresh_button;var _keyboard_in_use=false;var _preloadEmptyState=function(){var done_message_combo_options=[{emoji:"tada",skintone:false,line_one:TS.i18n.t("Ta-da!","all_unreads")(),line_two:TS.i18n.t("You’ve read everything there is to read.","all_unreads")()},{emoji:"victory",skintone:true,line_one:TS.i18n.t("All caught up.","all_unreads")(),line_two:TS.i18n.t("What’s next?","all_unreads")()},{emoji:"ok",skintone:true,line_one:TS.i18n.t("There.","all_unreads")(),line_two:TS.i18n.t("All caught up.","all_unreads")()},{emoji:"rocket",skintone:false,line_one:TS.i18n.t("All done.","all_unreads")(),line_two:TS.i18n.t("The future is yours.","all_unreads")()},{emoji:"octopus",skintone:false,line_one:TS.i18n.t("All done.","all_unreads")(),line_two:TS.i18n.t("The world is your oyster.","all_unreads")()},{emoji:"high5",skintone:true,line_one:TS.i18n.t("That’s everything!","all_unreads")(),line_two:""},{emoji:"apple",skintone:false,line_one:TS.i18n.t("You’ve read all you needed.","all_unreads")(),line_two:TS.i18n.t("Take a moment.","all_unreads")()},{emoji:"sunglasses",skintone:false,line_one:TS.i18n.t("All clear.","all_unreads")(),line_two:""},{emoji:"thumbup",skintone:true,line_one:TS.i18n.t("That’s that.","all_unreads")(),line_two:TS.i18n.t("You’re good to go.","all_unreads")()},{emoji:"boom",skintone:false,line_one:TS.i18n.t("Boom.","all_unreads")(),line_two:TS.i18n.t("You’re up to date.","all_unreads")()},{emoji:"bee",skintone:false,line_one:TS.i18n.t("You’re up to date.","all_unreads")(),line_two:TS.i18n.t("Go forth and do great things.","all_unreads")()},{emoji:"clap",skintone:true,line_one:TS.i18n.t("Everything unread is now read.","all_unreads")(),line_two:TS.i18n.t("You’ve done it.","all_unreads")()},{emoji:"crystalball",skintone:false,line_one:TS.i18n.t("All that was unread is now read.","all_unreads")(),line_two:TS.i18n.t("What’s next?","all_unreads")()},{emoji:"tada",skintone:false,line_one:TS.i18n.t("Ta-da!","all_unreads")(),line_two:TS.i18n.t("You’re up to date.","all_unreads")()},{emoji:"tractor",skintone:false,line_one:TS.i18n.t("You’re all read.","all_unreads")(),line_two:TS.i18n.t("Here’s a tractor.","all_unreads")()},{emoji:"pony",skintone:false,line_one:TS.i18n.t("You’re all read.","all_unreads")(),line_two:TS.i18n.t("Here’s a pony.","all_unreads")()},{emoji:"chick",skintone:false,line_one:TS.i18n.t("Everything’s sorted!","all_unreads")(),line_two:TS.i18n.t("Let’s start something new.","all_unreads")()},{emoji:"sun",skintone:false,line_one:TS.i18n.t("You’re all caught up!","all_unreads")(),line_two:TS.i18n.t("Clear screens ahead.","all_unreads")()},{emoji:"balloon",skintone:false,line_one:TS.i18n.t("There! Caught up.","all_unreads")(),line_two:TS.i18n.t("Set your mind to something new.","all_unreads")()},{emoji:"sweetpotato",skintone:false,line_one:TS.i18n.t("Sweet potato!","all_unreads")(),line_two:TS.i18n.t("You’re all done.","all_unreads")()},{emoji:"leafs",skintone:false,line_one:TS.i18n.t("Done and done.","all_unreads")(),line_two:""}];var emoji_paths={"default":{tada:cdn_url+"/3976a/img/unread/empty/default/tada.png",victory:{1:cdn_url+"/3976a/img/unread/empty/default/victory_1.png",2:cdn_url+"/3976a/img/unread/empty/default/victory_2.png",3:cdn_url+"/3976a/img/unread/empty/default/victory_3.png",4:cdn_url+"/3976a/img/unread/empty/default/victory_4.png",5:cdn_url+"/3976a/img/unread/empty/default/victory_5.png",6:cdn_url+"/3976a/img/unread/empty/default/victory_6.png"},ok:{1:cdn_url+"/3976a/img/unread/empty/default/ok_1.png",2:cdn_url+"/3976a/img/unread/empty/default/ok_2.png",3:cdn_url+"/3976a/img/unread/empty/default/ok_3.png",4:cdn_url+"/3976a/img/unread/empty/default/ok_4.png",5:cdn_url+"/3976a/img/unread/empty/default/ok_5.png",6:cdn_url+"/3976a/img/unread/empty/default/ok_6.png"},rocket:cdn_url+"/3976a/img/unread/empty/default/rocket.png",octopus:cdn_url+"/3976a/img/unread/empty/default/octopus.png",high5:{1:cdn_url+"/3976a/img/unread/empty/default/high5_1.png",2:cdn_url+"/3976a/img/unread/empty/default/high5_2.png",3:cdn_url+"/3976a/img/unread/empty/default/high5_3.png",4:cdn_url+"/3976a/img/unread/empty/default/high5_4.png",5:cdn_url+"/3976a/img/unread/empty/default/high5_5.png",6:cdn_url+"/3976a/img/unread/empty/default/high5_6.png"},apple:cdn_url+"/3976a/img/unread/empty/default/apple.png",sunglasses:cdn_url+"/3976a/img/unread/empty/default/sunglasses.png",thumbup:{1:cdn_url+"/3976a/img/unread/empty/default/thumbup_1.png",2:cdn_url+"/3976a/img/unread/empty/default/thumbup_2.png",3:cdn_url+"/3976a/img/unread/empty/default/thumbup_3.png",4:cdn_url+"/3976a/img/unread/empty/default/thumbup_4.png",5:cdn_url+"/3976a/img/unread/empty/default/thumbup_5.png",6:cdn_url+"/3976a/img/unread/empty/default/thumbup_6.png"},boom:cdn_url+"/3976a/img/unread/empty/default/boom.png",bee:cdn_url+"/3976a/img/unread/empty/default/bee.png",clap:{1:cdn_url+"/3976a/img/unread/empty/default/clap_1.png",2:cdn_url+"/3976a/img/unread/empty/default/clap_2.png",3:cdn_url+"/3976a/img/unread/empty/default/clap_3.png",4:cdn_url+"/3976a/img/unread/empty/default/clap_4.png",5:cdn_url+"/3976a/img/unread/empty/default/clap_5.png",6:cdn_url+"/3976a/img/unread/empty/default/clap_6.png"},crystalball:cdn_url+"/3976a/img/unread/empty/default/crystalball.png",tractor:cdn_url+"/3976a/img/unread/empty/default/tractor.png",pony:cdn_url+"/3976a/img/unread/empty/default/pony.png",chick:cdn_url+"/3976a/img/unread/empty/default/chick.png",sun:cdn_url+"/3976a/img/unread/empty/default/sun.png",balloon:cdn_url+"/3976a/img/unread/empty/default/balloon.png",sweetpotato:cdn_url+"/3976a/img/unread/empty/default/sweetpotato.png",leafs:cdn_url+"/3976a/img/unread/empty/default/leafs.png"},google:{tada:cdn_url+"/42c04/img/unread/empty/google/tada.png",victory:{1:cdn_url+"/42c04/img/unread/empty/google/victory_1.png",2:cdn_url+"/42c04/img/unread/empty/google/victory_2.png",3:cdn_url+"/42c04/img/unread/empty/google/victory_3.png",4:cdn_url+"/42c04/img/unread/empty/google/victory_4.png",5:cdn_url+"/42c04/img/unread/empty/google/victory_5.png",6:cdn_url+"/42c04/img/unread/empty/google/victory_6.png"},ok:{1:cdn_url+"/42c04/img/unread/empty/google/ok_1.png",2:cdn_url+"/42c04/img/unread/empty/google/ok_2.png",3:cdn_url+"/42c04/img/unread/empty/google/ok_3.png",4:cdn_url+"/42c04/img/unread/empty/google/ok_4.png",5:cdn_url+"/42c04/img/unread/empty/google/ok_5.png",6:cdn_url+"/42c04/img/unread/empty/google/ok_6.png"},rocket:cdn_url+"/42c04/img/unread/empty/google/rocket.png",octopus:cdn_url+"/42c04/img/unread/empty/google/octopus.png",high5:{1:cdn_url+"/42c04/img/unread/empty/google/high5_1.png",2:cdn_url+"/42c04/img/unread/empty/google/high5_2.png",3:cdn_url+"/42c04/img/unread/empty/google/high5_3.png",4:cdn_url+"/42c04/img/unread/empty/google/high5_4.png",5:cdn_url+"/42c04/img/unread/empty/google/high5_5.png",6:cdn_url+"/42c04/img/unread/empty/google/high5_6.png"},apple:cdn_url+"/42c04/img/unread/empty/google/apple.png",sunglasses:cdn_url+"/42c04/img/unread/empty/google/sunglasses.png",thumbup:{1:cdn_url+"/42c04/img/unread/empty/google/thumbup_1.png",2:cdn_url+"/42c04/img/unread/empty/google/thumbup_2.png",3:cdn_url+"/42c04/img/unread/empty/google/thumbup_3.png",4:cdn_url+"/42c04/img/unread/empty/google/thumbup_4.png",5:cdn_url+"/42c04/img/unread/empty/google/thumbup_5.png",6:cdn_url+"/42c04/img/unread/empty/google/thumbup_6.png"},boom:cdn_url+"/42c04/img/unread/empty/google/boom.png",bee:cdn_url+"/42c04/img/unread/empty/google/bee.png",clap:{1:cdn_url+"/42c04/img/unread/empty/google/clap_1.png",2:cdn_url+"/d90ef/img/unread/empty/google/clap_2.png",3:cdn_url+"/42c04/img/unread/empty/google/clap_3.png",4:cdn_url+"/42c04/img/unread/empty/google/clap_4.png",5:cdn_url+"/42c04/img/unread/empty/google/clap_5.png",6:cdn_url+"/42c04/img/unread/empty/google/clap_6.png"},crystalball:cdn_url+"/42c04/img/unread/empty/google/crystalball.png",tractor:cdn_url+"/42c04/img/unread/empty/google/tractor.png",pony:cdn_url+"/42c04/img/unread/empty/google/pony.png",chick:cdn_url+"/42c04/img/unread/empty/google/chick.png",sun:cdn_url+"/42c04/img/unread/empty/google/sun.png",balloon:cdn_url+"/42c04/img/unread/empty/google/balloon.png",sweetpotato:cdn_url+"/42c04/img/unread/empty/google/sweetpotato.png",leafs:cdn_url+"/7fa97/img/unread/empty/google/leafs.png"},twitter:{tada:cdn_url+"/42c04/img/unread/empty/twitter/tada.png",victory:{1:cdn_url+"/42c04/img/unread/empty/twitter/victory_1.png",2:cdn_url+"/42c04/img/unread/empty/twitter/victory_2.png",3:cdn_url+"/42c04/img/unread/empty/twitter/victory_3.png",4:cdn_url+"/42c04/img/unread/empty/twitter/victory_4.png",5:cdn_url+"/42c04/img/unread/empty/twitter/victory_5.png",6:cdn_url+"/42c04/img/unread/empty/twitter/victory_6.png"},ok:{1:cdn_url+"/42c04/img/unread/empty/twitter/ok_1.png",2:cdn_url+"/42c04/img/unread/empty/twitter/ok_2.png",3:cdn_url+"/42c04/img/unread/empty/twitter/ok_3.png",4:cdn_url+"/42c04/img/unread/empty/twitter/ok_4.png",5:cdn_url+"/42c04/img/unread/empty/twitter/ok_5.png",6:cdn_url+"/42c04/img/unread/empty/twitter/ok_6.png"},rocket:cdn_url+"/42c04/img/unread/empty/twitter/rocket.png",octopus:cdn_url+"/42c04/img/unread/empty/twitter/octopus.png",high5:{1:cdn_url+"/42c04/img/unread/empty/twitter/high5_1.png",2:cdn_url+"/42c04/img/unread/empty/twitter/high5_2.png",3:cdn_url+"/42c04/img/unread/empty/twitter/high5_3.png",4:cdn_url+"/42c04/img/unread/empty/twitter/high5_4.png",5:cdn_url+"/42c04/img/unread/empty/twitter/high5_5.png",6:cdn_url+"/42c04/img/unread/empty/twitter/high5_6.png"},apple:cdn_url+"/42c04/img/unread/empty/twitter/apple.png",sunglasses:cdn_url+"/42c04/img/unread/empty/twitter/sunglasses.png",thumbup:{1:cdn_url+"/42c04/img/unread/empty/twitter/thumbup_1.png",2:cdn_url+"/42c04/img/unread/empty/twitter/thumbup_2.png",3:cdn_url+"/42c04/img/unread/empty/twitter/thumbup_3.png",4:cdn_url+"/42c04/img/unread/empty/twitter/thumbup_4.png",5:cdn_url+"/42c04/img/unread/empty/twitter/thumbup_5.png",6:cdn_url+"/42c04/img/unread/empty/twitter/thumbup_6.png"},boom:cdn_url+"/42c04/img/unread/empty/twitter/boom.png",bee:cdn_url+"/42c04/img/unread/empty/twitter/bee.png",clap:{1:cdn_url+"/42c04/img/unread/empty/twitter/clap_1.png",2:cdn_url+"/42c04/img/unread/empty/twitter/clap_2.png",3:cdn_url+"/42c04/img/unread/empty/twitter/clap_3.png",4:cdn_url+"/42c04/img/unread/empty/twitter/clap_4.png",5:cdn_url+"/42c04/img/unread/empty/twitter/clap_5.png",6:cdn_url+"/42c04/img/unread/empty/twitter/clap_6.png"},crystalball:cdn_url+"/42c04/img/unread/empty/twitter/crystalball.png",tractor:cdn_url+"/42c04/img/unread/empty/twitter/tractor.png",pony:cdn_url+"/42c04/img/unread/empty/twitter/pony.png",chick:cdn_url+"/42c04/img/unread/empty/twitter/chick.png",sun:cdn_url+"/42c04/img/unread/empty/twitter/sun.png",balloon:cdn_url+"/42c04/img/unread/empty/twitter/balloon.png",sweetpotato:cdn_url+"/42c04/img/unread/empty/twitter/sweetpotato.png",leafs:cdn_url+"/7fa97/img/unread/empty/twitter/leafs.png"},emojione:{tada:cdn_url+"/42c04/img/unread/empty/emojione/tada.png",victory:{1:cdn_url+"/42c04/img/unread/empty/emojione/victory_1.png",2:cdn_url+"/42c04/img/unread/empty/emojione/victory_2.png",3:cdn_url+"/42c04/img/unread/empty/emojione/victory_3.png",4:cdn_url+"/42c04/img/unread/empty/emojione/victory_4.png",5:cdn_url+"/42c04/img/unread/empty/emojione/victory_5.png",6:cdn_url+"/42c04/img/unread/empty/emojione/victory_6.png"},ok:{1:cdn_url+"/42c04/img/unread/empty/emojione/ok_1.png",2:cdn_url+"/42c04/img/unread/empty/emojione/ok_2.png",3:cdn_url+"/42c04/img/unread/empty/emojione/ok_3.png",4:cdn_url+"/42c04/img/unread/empty/emojione/ok_4.png",5:cdn_url+"/42c04/img/unread/empty/emojione/ok_5.png",6:cdn_url+"/42c04/img/unread/empty/emojione/ok_6.png"},rocket:cdn_url+"/42c04/img/unread/empty/emojione/rocket.png",octopus:cdn_url+"/42c04/img/unread/empty/emojione/octopus.png",high5:{1:cdn_url+"/42c04/img/unread/empty/emojione/high5_1.png",2:cdn_url+"/42c04/img/unread/empty/emojione/high5_2.png",3:cdn_url+"/42c04/img/unread/empty/emojione/high5_3.png",4:cdn_url+"/42c04/img/unread/empty/emojione/high5_4.png",5:cdn_url+"/42c04/img/unread/empty/emojione/high5_5.png",6:cdn_url+"/42c04/img/unread/empty/emojione/high5_6.png"},apple:cdn_url+"/42c04/img/unread/empty/emojione/apple.png",sunglasses:cdn_url+"/42c04/img/unread/empty/emojione/sunglasses.png",thumbup:{1:cdn_url+"/42c04/img/unread/empty/emojione/thumbup_1.png",2:cdn_url+"/42c04/img/unread/empty/emojione/thumbup_2.png",3:cdn_url+"/42c04/img/unread/empty/emojione/thumbup_3.png",4:cdn_url+"/42c04/img/unread/empty/emojione/thumbup_4.png",5:cdn_url+"/42c04/img/unread/empty/emojione/thumbup_5.png",6:cdn_url+"/42c04/img/unread/empty/emojione/thumbup_6.png"},boom:cdn_url+"/42c04/img/unread/empty/emojione/boom.png",bee:cdn_url+"/42c04/img/unread/empty/emojione/bee.png",clap:{1:cdn_url+"/42c04/img/unread/empty/emojione/clap_1.png",2:cdn_url+"/42c04/img/unread/empty/emojione/clap_2.png",3:cdn_url+"/42c04/img/unread/empty/emojione/clap_3.png",4:cdn_url+"/42c04/img/unread/empty/emojione/clap_4.png",5:cdn_url+"/42c04/img/unread/empty/emojione/clap_5.png",6:cdn_url+"/42c04/img/unread/empty/emojione/clap_6.png"},crystalball:cdn_url+"/42c04/img/unread/empty/emojione/crystalball.png",tractor:cdn_url+"/42c04/img/unread/empty/emojione/tractor.png",pony:cdn_url+"/42c04/img/unread/empty/emojione/pony.png",chick:cdn_url+"/42c04/img/unread/empty/emojione/chick.png",sun:cdn_url+"/42c04/img/unread/empty/emojione/sun.png",balloon:cdn_url+"/42c04/img/unread/empty/emojione/balloon.png",sweetpotato:cdn_url+"/42c04/img/unread/empty/emojione/sweetpotato.png",leafs:cdn_url+"/42c04/img/unread/empty/emojione/sweetpotato.png"}};var selected_combo=done_message_combo_options[Math.floor(Math.random()*done_message_combo_options.length)];var emoji_mode=TS.model.prefs.emoji_mode;if(emoji_mode==="as_text")emoji_mode="default";var preferred_skintone=TS.model.prefs.preferred_skin_tone||"1";var emoji_url=selected_combo.skintone?emoji_paths[emoji_mode][selected_combo.emoji][preferred_skintone]:emoji_paths[emoji_mode][selected_combo.emoji];selected_combo.emoji_url=emoji_url;var img_element=new Image;img_element.src=selected_combo.emoji_url;_preloaded_empty_state=selected_combo};var _onResize=function(){TS.client.ui.unread.$scroller.height(TS.view.cached_wh-$("#client_header").outerHeight()-TS.client.ui.CLIENT_HEADER_OVERHANG);if(!TS.environment.supports_custom_scrollbar)TS.ui.utility.updateClosestMonkeyScroller(TS.client.ui.unread.$scroller);if(!TS.model.supports_sticky_position){_updateBannerHeight();_updateUnreadGroupPositions()}};var _onRename=function(model_ob){var group=TS.client.unread.getGroup(model_ob.id);if(group)TS.client.ui.unread.updateHeader(group)};var _onKeyDown=function(e){var target_group;if(TS.menu.emoji.is_showing)return;if([TS.utility.keymap.left,TS.utility.keymap.right,82].indexOf(e.which)===-1)return;if(e.metaKey||e.ctrlKey||e.shiftKey)return;if(_currently_loading_more_promise&&_currently_loading_more_promise.isPending())return;if(!_currently_changing_active_group&&TS.client.ui.isUserAttentionOnChat()&&!TS.utility.isFocusOnInput()&&!$("#messages_container .unread_empty_state").length&&!TS.client.ui.unread.$scroller.hasClass("loading")&&!TS.client.ui.unread.$scroller.hasClass("transitioning")&&!TS.client.ui.unread.$unread_msgs_div.find(".collapsing").length){var current_group=TS.client.unread.getActiveGroup();if(e.which===TS.utility.keymap.right||e.which===TS.utility.keymap.left){_keyboard_in_use=true;e.preventDefault();var backwards=e.which===TS.utility.keymap.left?true:false;target_group=TS.client.unread.moveActiveMarker(backwards);if(target_group){_changeActiveElement(target_group,current_group,{collapse_current_group:!backwards})}else if(!TS.client.unread.areAllMessagesFetched()&&!backwards){var last_group=_.last(TS.client.unread.getAllGroups());if(last_group.id===current_group.id){_move_active_marker_after_next_page=true;var $current_group=_getGroupElement(current_group);var $msgs_holder=$current_group.find(".unread_group_msgs");TS.client.ui.unread.collapseGroup(current_group,$msgs_holder)}}}else if(e.which===82){_keyboard_in_use=true;if(current_group){if(current_group.marked_as_read){TS.client.ui.unread.markGroupAsUnread(current_group.id)}else{_currently_changing_active_group=true;TS.client.ui.unread.markGroupAsRead(current_group.id).then(function(){if(current_group.marked_as_read){target_group=TS.client.unread.moveActiveMarker();_changeActiveElement(target_group,current_group)}else{_currently_changing_active_group=false}})}}}}};var _changeActiveElement=function(target_group,current_group,opts){opts=_.defaults(opts,{collapse_current_group:false,scroll_and_expand:true});var updateTargetGroup=function(){var $target_group=_getGroupElement(target_group);$target_group.toggleClass("active",target_group.active&&_keyboard_in_use);TS.client.ui.unread.updateHeader(target_group);if(!target_group.marked_as_read){if(opts.scroll_and_expand)TS.client.ui.unread.expandGroup(target_group)}if(opts.scroll_and_expand){var $previous_group=$target_group.prev();if(current_group&&$previous_group.length&&$previous_group.data("model-id")===current_group.id){_skip_next_sticky_header_active_update=true;_scrollGroupElementToTop($current_group)}else{_scrollGroupElementToTop($target_group)}}_currently_changing_active_group=false;return null};if(target_group){_move_active_marker_after_next_page=false;_currently_changing_active_group=true;if(current_group){var $current_group=_getGroupElement(current_group);if(opts.collapse_current_group){var $msgs_holder=$current_group.find(".unread_group_msgs");TS.client.ui.unread.collapseGroup(current_group,$msgs_holder,{scroll_group:false}).then(function(){$current_group.toggleClass("active",current_group.active&&_keyboard_in_use);TS.client.ui.unread.updateHeader(current_group);updateTargetGroup()})}else{$current_group.toggleClass("active",current_group.active&&_keyboard_in_use);TS.client.ui.unread.updateHeader(current_group);updateTargetGroup()}}else{updateTargetGroup()}}else{_currently_changing_active_group=false}return null};var _scrollGroupElementToTop=function($group){if(!$group.length)return;var $scroller=$group.closest(".monkey_scroller");if(!$scroller.length)$scroller=$group.closest(":scrollable(vertical)");if($scroller.is("html"))$scroller=$("body");$scroller.scrollTop(Math.round($group[0].offsetTop-8))};var _getGroupElement=function(group){return TS.client.ui.unread.$unread_msgs_div.find("[data-model-id="+group.model_ob.id+"]")};var _updateStickyHeader=function(e){var current_scroll_offset=TS.client.ui.unread.$scroller.scrollTop();var groups=TS.client.ui.unread.unread_groups.toArray();if(!groups.length)return;var group_in_view=groups.reduce(function(previous_unread_group,current_unread_group){if(current_scroll_offset+TS.client.ui.CLIENT_HEADER_OVERHANG>=current_unread_group.y){return current_unread_group}else{return previous_unread_group}});if(!group_in_view)return;var sticky_top=_banner_height;if(TS.model.prefs.a11y_font_size==="110"){sticky_top+=6}else if(TS.model.prefs.a11y_font_size==="125"){sticky_top+=15}else if(TS.model.prefs.a11y_font_size==="150"){sticky_top+=30}if(TS.environment.isSSBAndAtLeastVersion("2.2.8")&&TS.boot_data.feature_flexbox_client){sticky_top-=2}if(!$_currently_sticky){$_currently_sticky=group_in_view.$node;$_currently_sticky.find(".unread_group_header").css("top",sticky_top);$_currently_sticky.addClass("currently_sticky")}if($_currently_sticky!==group_in_view.$node){$_currently_sticky.find(".unread_group_header").css("top","0");$_currently_sticky.removeClass("currently_sticky");$_currently_sticky=group_in_view.$node;$_currently_sticky.find(".unread_group_header").css("top",sticky_top);$_currently_sticky.addClass("currently_sticky")}if(!_currently_changing_active_group&&!_skip_next_sticky_header_active_update){var current_group=TS.client.unread.getActiveGroup();if(current_group){if($_currently_sticky.data("model-id")!=current_group.id){var target_group=TS.client.unread.getGroup($_currently_sticky.data("model-id"));target_group=TS.client.unread.setActiveGroup(target_group);_changeActiveElement(target_group,current_group,{collapse_current_group:false,scroll_and_expand:false})}}}_skip_next_sticky_header_active_update=false};var _updateUnreadGroupPositions=function(changes){var $unread_groups=TS.client.ui.unread.$scroller.find(".unread_group");TS.client.ui.unread.unread_groups=$unread_groups.map(function(index,unread_group){return{$node:$(unread_group),y:unread_group.offsetTop}})};var _updateBannerHeight=function(){_banner_height=$("#banner").height()};var _buildTemplateArgs=function(group){return{model_ob:group.model_ob,model_ob_id:group.model_ob.id,has_new_unreads:group.new_unread_cnt>0,unread_cnt:group.total_unreads||0,new_unread_cnt:group.new_unread_cnt,marked_as_read_cnt:group.marked_as_read_cnt||0,show_footer:group.new_unread_cnt>0,name:group.model_ob.name,display_name:TS.shared.getDisplayNameForModelObNoSigns(group.model_ob),name_with_sign:TS.shared.getDisplayNameForModelOb(group.model_ob),marked_as_read:group.marked_as_read,collapsed:group.collapsed,active:_keyboard_in_use&&group.active,is_channel:group.model_ob.is_channel,is_group:group.model_ob.is_group,is_mpim:group.model_ob.is_mpim,is_im:group.model_ob.is_im,im_user:group.model_ob.user?TS.members.getMemberById(group.model_ob.user):null,supports_sticky_position:TS.model.supports_sticky_position}};var _checkToShowEmptyState=function(){if(!TS.client.unread.areAllMessagesFetched())return;var all_groups=TS.client.unread.getAllGroups();var all_channels_read=true;if(all_groups.length){all_channels_read=_.reduce(all_groups,function(result,g){return result&&g.marked_as_read},all_groups[0].marked_as_read)}if(all_channels_read)TS.client.ui.unread.displayEmptyState()};var _transitionToMessages=function(){TS.client.ui.unread.$scroller.removeClass("loading");TS.client.ui.unread.$scroller.removeClass("loading-slow");TS.client.ui.unread.$scroller.addClass("transitioning");TS.client.ui.unread.updateChannelHeader();TS.client.ui.unread.updateMsgs();TS.client.ui.unread.$scroller.removeClass("transitioning")};var _setUnreadPoint=function(msg_id,model_ob_id,$msg){var group=TS.client.unread.getGroup(model_ob_id);var model_ob=group.model_ob;var mark_msg_ts=TS.utility.msgs.getMarkMsgTSForUnreadPoint(msg_id,group.msgs,model_ob);var marked_msg_index=_.findIndex(group.msgs,{ts:mark_msg_ts});var $group=$msg.closest(".unread_group");$group.find(".unread_divider").remove();$group.find(".unread_day_container").removeClass("unread_day_container");if(!mark_msg_ts)return false;group.manually_marked_unread_msg=msg_id;TS.shared.markReadMsg(group.model_ob.id,mark_msg_ts,TS.model.marked_reasons.back);TS.client.markLastReadsWithAPI();if(msg_id===parseFloat(group.msgs[group.msgs.length-1].ts))return;var divider_html=TS.templates.messages_unread_divider({label:TS.i18n.t("unread messages","all_unreads")()});var $last_read_msg=TS.client.ui.unread.$unread_msgs_div.find('ts-message[data-ts="'+group.msgs[marked_msg_index].ts+'"]');$last_read_msg.after(divider_html);var $divider=$msg.closest(".unread_group").find(".unread_divider");if($divider.next(".day_divider").length||$divider.is(":last-child")){$divider.addClass("adjacent_to_date");$divider.closest(".day_container").next(".day_container").addClass("unread_day_container")}return true}})();(function(){"use strict";TS.registerModule("ui.message_container",{register:function(config){if(!config.container){TS.error("TS.ui.message_container.register requires a container!");return}if(!config.updateCallback)config.updateCallback=_.noop;if(!config.msg_order)config.msg_order="asc";_setVisibleRange(config);var visible_sections=_getVisibleRange(config);var $container=$(config.container);$container.data("message-container-config",config);$container.addClass("message_container");_buildSections(config,visible_sections);config._state=visible_sections;_buildLoadingIndicators(config);_bindUI(config)},cleanup:function(config){var $container=$(config.container);var $scroller=$container;if(config.scroller)$scroller=$(config.scroller);$scroller.off("scroll.message_container");if(config._pending_op)config._pending_op.cancel()},update:function(config){_changes={added:[],removed:[],replaced:[]};var $container=$(config.container);if(config._range){_setVisibleRange(config,config._range.start)}else{_setVisibleRange(config)}var sections=_getVisibleRange(config);var current_state=config._state;var sections_resolution=_resolveSections(current_state,sections);var $current_section;_resolutionIterator(sections_resolution,function(step){var section=step.item;if(step.action==="continue"){$current_section=$container.children('[data-section-id="'+section.id+'"]');_updateSection(config,section)}else if(step.action==="delete"){$container.children('[data-section-id="'+section.id+'"]').remove()}else if(step.action==="insert"){var $inserting=_buildSection(config,section);if($current_section&&$current_section.length){$current_section.after($inserting)}else{$container.prepend($inserting)}$current_section=$inserting}else if(step.action==="append"){var $appending=_buildSection(config,section);$container.append($appending);$current_section=$appending}});config._state=sections;_buildLoadingIndicators(config);if(TS.client&&config.name){TS.client.ui.checkInlineImgsAndIframes(config.name)}var $scroller=$container;if(config.scroller)$scroller=$(config.scroller);TS.ui.utility.updateClosestMonkeyScroller($scroller);if(config.updated_sig){config.updated_sig.dispatch(_changes)}if(config.page_size){var num_msgs=_.reduce(sections,function(sum,section){return sum+section.msgs.length},0);if(num_msgs<2*config.page_size){var loader;if(config.has_more_end&&config.promiseToLoadMoreAtEnd){loader=config.promiseToLoadMoreAtEnd}else if(config.has_more_beginning&&config.promiseToLoadMoreAtBeginning){loader=config.config.promiseToLoadMoreAtBeginning}if(loader){config._pending_op=loader().then(function(){TS.ui.message_container.updateWithFocus(config,$container.find(".message_container_item").first())}).finally(function(){config._pending_op=null})}}}var result=_changes;config.updateCallback(result);_changes=null;return result},updateWithFocus:function(config,$element){if(!$element||!$element.length)return TS.ui.message_container.update(config);var $focus=$($element);var changes;if($element.is("ts-message")){var $message_body=$element.find(".message_body");if($message_body.length)$focus=$message_body}if($element.is("ts-thread")){var $root_msg=$element.find("ts-message:first");if($root_msg.length)$focus=$root_msg}TS.ui.utility.preventElementFromScrolling($focus,function(){changes=TS.ui.message_container.update(config)},function(){var $container=$(config.container);if($.contains($container[0],$focus[0]))return $focus;var id=$element.attr("id");$element=$container.find("#"+id);if($element.is("ts-message")){$message_body=$element.find(".message_body");if($message_body.length)return $message_body}if($element.is("ts-thread")){$root_msg=$element.find("ts-message:first");if($root_msg.length)return $root_msg}return $element});return changes},jumpToTop:function(config){delete config._range;var $first=$(config.container).find(".message_container_item").first();var ret=TS.ui.message_container.updateWithFocus(config,$first);$first=$(config.container).find(".message_container_item").first();$first.scrollintoview({offset:"top",px_offset:50});return ret},getRange:function(config){return config._range},pageUp:function(config,$element){if(!config._range||!config.page_size)return;_moveVisibleRangeBack(config);TS.ui.message_container.updateWithFocus(config,$element)},pageDown:function(config,$element){if(!config._range||!config.page_size)return;_moveVisibleRangeForward(config);TS.ui.message_container.updateWithFocus(config,$element)},test:function(){return{resolveOrderedLists:_resolveOrderedLists}}});var _changes;var _loaded_but_not_shown=false;var _logRemove=function($msg){if(!_changes)return;_changes.removed.push($msg)};var _logAdd=function($msg){if(!_changes)return;_changes.added.push($msg)};var _logReplace=function($msg){if(!_changes)return;_changes.replaced.push($msg)};var _bindUI=function(config){if(!config.page_size)return;var $container=$(config.container);var $scroller=$container;var $scroller_holder=$scroller.parent();if(config.scroller)$scroller=$(config.scroller);var scroll_handler=_.debounce(function(scroller){if(scroller.scrollTop+$scroller_holder.height()>scroller.scrollHeight*.25){_loadMoreMessages(config)}if(scroller.scrollTop===0){_handleScrolledToTop(config,$container)}else if(scroller.scrollTop+$scroller_holder.height()>scroller.scrollHeight*.9){_appendMoreMessages(config,$container)}if(TS.client){TS.client.ui.checkInlineImgsAndIframes("unread")}},250);$scroller.on("scroll.message_container",function(){scroll_handler(this)})};var _handleScrolledToTop=function(config,$container){var all=_flattenAllMsgs(config);
if(!all.length)return;var $first=$container.find(".message_container_item").first();var first_msg=_.first(all);if(_.isEqual(first_msg,config._range.start)){if(config.has_more_beginning&&config.promiseToLoadMoreAtBeginning){config._pending_op=config.promiseToLoadMoreAtBeginning().then(function(){TS.ui.message_container.pageUp(config,$first)}).finally(function(){config._pending_op=null});return config._pending_op()}}else{TS.ui.message_container.pageUp(config,$first)}};var _loadMoreMessages=function(config){if(!config._pending_op&&_loaded_but_not_shown!==true){if(config.has_more_end&&config.promiseToLoadMoreAtEnd){_debug("Start pre-emptive load of more messages",config);config._pending_op=config.promiseToLoadMoreAtEnd().then(function(){_debug("End pre-emptive load of more messages",config);config._pending_op=null;_loaded_but_not_shown=true});return config._pending_op}}};var _appendMoreMessages=function(config,$container){var $last=$container.find(".message_container_item").last();if(_loaded_but_not_shown){_debug("Start appending loaded but not shown messages",config);_loaded_but_not_shown=false;TS.ui.message_container.pageDown(config,$last);_debug("End appending loaded but not shown messages",config)}else{if(!config._pending_op&&(config.has_more_end&&config.promiseToLoadMoreAtEnd)){_debug("Start load of more messages at append point",config);config._pending_op=config.promiseToLoadMoreAtEnd().then(function(){_debug("End load of more messages at append point",config);_debug("Start appending loaded messages at append point",config);config._pending_op=null;_loaded_but_not_shown=false;TS.ui.message_container.pageDown(config,$last);_debug("End appending loaded messages at append point",config)});return config._pending_op}else{if(config._pending_op){return config._pending_op.then(function(){if(_loaded_but_not_shown){_debug("Start appending loaded but not shown messages after pending",config);config._pending_op=null;_loaded_but_not_shown=false;TS.ui.message_container.pageDown(config,$last);_debug("End appending loaded but not shown messages after pending",config)}})}else{_debug("Appending loaded and shown messages hidden by message_container at append point",config);TS.ui.message_container.pageDown(config,$last)}}}};var _updateSection=function(config,section){var $container=$(config.container);var section_state=_.find(config._state,{id:section.id});if(!section){TS.error("TS.ui.message_container.update could not find section "+section.id+" to update.");return}if(!section_state){TS.error("TS.ui.message_container.update could not find section_state for "+section.id+" to update.");return}var $section=$container.children('[data-section-id="'+section.id+'"]');if(!$section.length){TS.error("TS.ui.message_container.updateSection could not find section "+section.id);return}if(section.completeness){$section.removeClass("complete partial_start partial_end");if(section.completeness.start&&section.completeness.end){$section.addClass("complete")}else{if(!section.completeness.start){$section.addClass("partial_start")}if(!section.completeness.end){$section.addClass("partial_end")}}}var days=_groupMsgsIntoDays(config,section.msgs);var days_state=_groupMsgsIntoDays(config,section_state.msgs);var days_resolution=_resolveDays(days_state,days,config.msg_order);_updateDays(config,section,$section,days,days_state,days_resolution)};var _updateDays=function(config,section,$section,days,days_state,resolution){var $current;var $msgs_holder=$section.find(".msgs_holder");if(!$msgs_holder.length)$msgs_holder=$section;var $days=$msgs_holder.find(".day_container");var $findDay=function(ts){return $days.filter(function(){var this_ts=$(this).attr("data-ts");var date_a=TS.utility.date.toDateObject(ts);var date_b=TS.utility.date.toDateObject(this_ts);return TS.utility.date.sameDay(date_a,date_b)})};var findDay=function(msg_groups,msg){return _.find(msg_groups,function(msgs){var first_msg=msgs[0];return TS.utility.msgs.areMsgsSameDay(first_msg,msg)})};_resolutionIterator(resolution,function(step){var first_msg=step.item;var msgs=findDay(days,first_msg);if(step.action==="continue"){$current=$findDay(first_msg.ts);var msgs_resolution=_resolveMsgs(findDay(days_state,first_msg),msgs,config.msg_order);_updateMsgs(config,section,$current,msgs,msgs_resolution)}else if(step.action==="delete"){$findDay(first_msg.ts).remove()}else if(step.action==="insert"){var $inserting=_buildDay(config,section,findDay(days,first_msg));if($current&&$current.length){$current.after($inserting)}else if($days.length){$days.first().before($inserting)}else{$msgs_holder.append($inserting)}$current=$inserting}else if(step.action==="append"){var $appending=_buildDay(config,section,findDay(days,first_msg));$msgs_holder.append($appending);$current=$appending}})};var _updateMsgs=function(config,section,$day,msgs,resolution){var $current;var $msgs=$day.find(".message_container_item");var msg_dom_map={};$msgs.each(function(){var ts=$(this).attr("data-ts");msg_dom_map[ts]=this});var msg_map={};var prev_msg_map={};var prev_msg;msgs.forEach(function(msg){msg_map[msg.ts]=msg;prev_msg_map[msg.ts]=prev_msg;prev_msg=msg});var last_action;_resolutionIterator(resolution,function(step){var msg=step.item;var id=msg.ts;var action=step.action;if(action==="edited")action="replace";if(action==="continue"&&(last_action==="insert"||last_action==="delete"))action="replace";if(action==="continue"){$current=$(msg_dom_map[id])}else if(action==="replace"){var $replacing=$(msg_dom_map[id]);var $edited=_buildMsg(config,msg_map[id],prev_msg_map[id],section);$replacing.replaceWith($edited);_logReplace($edited);$current=$edited}else if(action==="delete"){var $deleting=$(msg_dom_map[id]);_logRemove($deleting);$deleting.remove()}else if(action==="insert"){var $inserting=_buildMsg(config,msg_map[id],prev_msg_map[id],section);if($current&&$current.length){$current.after($inserting)}else if($msgs.length){$msgs.first().before($inserting)}else{$day.append($inserting)}_logAdd($inserting);$current=$inserting}else if(action==="append"){var $appending=_buildMsg(config,msg_map[id],prev_msg_map[id],section);$day.append($appending);_logAdd($appending);$current=$appending}last_action=step.action})};var _buildSections=function(config,sections){var $container=$(config.container);_.forEach(sections,function(section){var $section=_buildSection(config,section);$container.append($section)})};var _buildSection=function(config,section){var section_html=config.buildSection(section);var $section=$(section_html);$section.attr("data-section-id",section.id);if(section.completeness){if(section.completeness.start&&section.completeness.end){$section.addClass("complete")}else{if(!section.completeness.start){$section.addClass("partial_start")}if(!section.completeness.end){$section.addClass("partial_end")}}}var $msgs_holder=$section.find(".msgs_holder");if(!$msgs_holder.length)$msgs_holder=$section;var days=_groupMsgsIntoDays(config,section.msgs);_.forEach(days,function(msgs){var $day=_buildDay(config,section,msgs);$msgs_holder.append($day)});return $section};var _buildDay=function(config,section,msgs){var first_msg=msgs[0];var $day=$('<div class="day_container" data-ts="'+first_msg.ts+'"></div>');if(!config.skip_day_groupings){var $divider=$(config.buildDayDivider(section,first_msg));$day.append($divider);_logAdd($divider)}var prev_msg;var $msgs=_.map(msgs,function(msg){var $msg=_buildMsg(config,msg,prev_msg,section);prev_msg=msg;return $msg});$msgs.forEach(function($msg){$day.append($msg);_logAdd($msg)});return $day};var _buildMsg=function(config,msg,prev_msg,section){var msg_html=config.buildMsgHTML(msg,prev_msg,section);var $msg=$(msg_html);$msg.addClass("message_container_item");return $msg};var _buildLoadingIndicators=function(config){var $container=$(config.container);var all=_flattenAllMsgs(config);var first=_.first(all);var last=_.last(all);var start=config._range&&config._range.start;var end=config._range&&config._range.end;var more_at_beginning=config.has_more_beginning;if(!more_at_beginning){if(first&&start&&!_.isEqual(first,start))more_at_beginning=true}var more_at_end=config.has_more_end;if(!more_at_end){if(last&&end&&!_.isEqual(last,end))more_at_end=true}var $beginning=$container.find(".and_more_beginning");$beginning.remove();if(more_at_beginning){$container.prepend('<div class="and_more_beginning italic align_center large_top_margin large_bottom_margin">Loading more messages...</div>')}var $end=$container.find(".and_more_end");$end.remove();if(more_at_end){$container.append('<div class="and_more_end italic align_center large_top_margin large_bottom_margin">Loading more messages...</div>')}else{$container.find(".unread_group:last").addClass("at_bottom")}};var _resolveSections=function(sections_current,sections_new){return _resolveOrderedLists(sections_current,sections_new,function(a,b){var a_inx=a.order||0;var b_inx=b.order||0;return a_inx-b_inx})};var _resolveDays=function(days_current,days_new,order){var current_msgs=_.map(days_current,function(msgs){return msgs[0]});var new_msgs=_.map(days_new,function(msgs){return msgs[0]});return _resolveOrderedLists(current_msgs,new_msgs,function(a,b){if(TS.utility.msgs.areMsgsSameDay(a,b))return 0;return _compareTs(order,a.ts,b.ts)})};var _resolveMsgs=function(msgs_current,msgs_new,order){return _resolveOrderedLists(msgs_current,msgs_new,function(a,b){if(a.ts===b.ts)return 0;return _compareTs(order,a.ts,b.ts)},function(old_msg,new_msg){var old_edited=old_msg.edited;var new_edited=new_msg.edited;return!_.isEqual(old_edited,new_edited)})};var _resolutionIterator=function(steps,cb){while(steps){cb(steps);steps=steps.next}};var _resolveOrderedLists=function(old_items,new_items,compare_fn,is_edited_fn){var a=_toLinkedList(old_items,0);var b=_toLinkedList(new_items,0);return _resolveWorker(a,b,compare_fn,is_edited_fn)};var _resolveWorker=function(a,b,compare_fn,is_edited_fn){if(!a&&!b)return null;if(!a){return{action:"append",item:b.item,next:_resolveWorker(a,b.next,compare_fn,is_edited_fn)}}if(!b){return{action:"delete",item:a.item,next:_resolveWorker(a.next,b,compare_fn,is_edited_fn)}}var cmp_val=compare_fn(a.item,b.item);if(cmp_val===0){if(is_edited_fn&&is_edited_fn(a.item,b.item)){return{action:"edited",item:b.item,next:_resolveWorker(a.next,b.next,compare_fn,is_edited_fn)}}else{return{action:"continue",item:b.item,next:_resolveWorker(a.next,b.next,compare_fn,is_edited_fn)}}}if(cmp_val<0){return{action:"delete",item:a.item,next:_resolveWorker(a.next,b,compare_fn,is_edited_fn)}}if(cmp_val>0){return{action:"insert",item:b.item,next:_resolveWorker(a,b.next,compare_fn,is_edited_fn)}}};var _toLinkedList=function(items,i,prev){if(i>=items.length)return null;var node={item:items[i],prev:prev};node.next=_toLinkedList(items,i+1,node);return node};var _setVisibleRange=function(config,start_at){if(!config.page_size)return;var all=_flattenAllMsgs(config);if(!all.length)return;var max=2*config.page_size;var range={};var start_index=0;var order=config.msg_order;if(start_at){var found_section=false;start_index=_.findIndex(all,function(m){if(m.section_id===start_at.section_id){if(m.msg_ts==-1)return true;if(!found_section)found_section=true;return _isOnOrAfter(order,m.msg_ts,start_at.msg_ts)}if(found_section&&m.section_id!==start_at.section_id){return true}return false});if(start_index<0)start_index=0}var end_index=Math.min(max+start_index,all.length);range.start=all[start_index];range.end=all[end_index-1];if(start_index>0&&end_index-start_index<max){var unused_space=max-(end_index-start_index);start_index=Math.max(0,start_index-unused_space);range.start=all[start_index]}config._range=range};var _getVisibleRange=function(config){if(!config._range){return _.map(config.sections,function(s){var section=_.create(s);section.msgs=_.map(s.msgs,_.clone);section.completeness={start:true,end:true};return section})}var visible=[];var start=config._range.start;var end=config._range.end;_.forEach(config.sections,function(section){if(!_isSectionInVisibleRange(section,config))return;var s=_.create(section);var msgs=_processMessages(config,section.msgs);s.msgs=_.filter(msgs,function(msg){var order=config.msg_order;if(start.section_id===end.section_id){return _isOnOrAfter(order,msg.ts,start.msg_ts)&&_isOnOrBefore(order,msg.ts,end.msg_ts)}if(section.id===start.section_id){return _isOnOrAfter(order,msg.ts,start.msg_ts)}else if(section.id===end.section_id){return _isOnOrBefore(order,msg.ts,end.msg_ts)}else{return true}});if(config.msg_order==="desc"){s.completeness={start:_.first(s.msgs)===_.first(msgs),end:_.last(s.msgs)===_.last(msgs)}}else{s.completeness={start:_.last(s.msgs)===_.last(msgs),end:_.first(s.msgs)===_.first(msgs)}}if(section===_.first(config.sections)&&config.has_more_beginning){s.completeness.start=false}if(section===_.last(config.sections)&&config.has_more_end){s.completeness.end=false}s.msgs=_.map(s.msgs,_.clone);visible.push(s)});return visible};var _moveVisibleRangeBack=function(config){var all=_flattenAllMsgs(config);var range=config._range;var order=config.msg_order;var before=_.takeWhile(all,function(msg){return!(msg.section_id===range.start.section_id&&_isOnOrAfter(order,msg.msg_ts,range.start.msg_ts))});if(!before.length)return;var visible=_.drop(all,before.length);var found_end=false;visible=_.takeWhile(visible,function(msg){if(found_end)return false;var at_end=msg.section_id===range.end.section_id&&_isOnOrAfter(order,msg.msg_ts,range.end.msg_ts);if(at_end)found_end=true;return true});var adding=_.takeRight(before,config.page_size);var survivors=_.take(visible,visible.length-adding.length);range.start=_.first(adding);range.end=_.last(survivors)};var _moveVisibleRangeForward=function(config){var all=_flattenAllMsgs(config);var range=config._range;var order=config.msg_order;all=_.dropWhile(all,function(msg){return!(msg.section_id===range.start.section_id&&_isOnOrAfter(order,msg.msg_ts,range.start.msg_ts))});var found_end=false;var visible=_.takeWhile(all,function(msg){if(found_end)return false;var at_end=msg.section_id===range.end.section_id&&_isOnOrAfter(order,msg.msg_ts,range.end.msg_ts);if(at_end)found_end=true;return true});var tail=_.drop(all,visible.length);if(!tail.length)return;var adding=_.take(tail,config.page_size);var survivors=_.drop(visible,adding.length);range.start=_.first(survivors);range.end=_.last(adding)};var _isSectionInVisibleRange=function(section,config){if(!config._range)return true;var reached_beginning=false;var s;for(var i=0;i<config.sections.length;i++){s=config.sections[i];if(!reached_beginning&&s.id===config._range.start.section_id){reached_beginning=true}if(reached_beginning&&s.id===section.id)return true;if(s.id===config._range.end.section_id){break}}return false};var _flattenAllMsgs=function(config){var all=[];var order=config.msg_order;var iterator=order==="asc"?_.forEachRight:_.forEach;_.forEach(config.sections,function(section){if(!section.msgs.length){all.push({section_id:section.id,msg_ts:"-1"})}else{var msgs=_processMessages(config,section.msgs);iterator(msgs,function(msg){all.push({section_id:section.id,msg_ts:msg.ts})})}});return all};var _groupMsgsIntoDays=function(config,msgs){if(!msgs)return[];var order=config.msg_order;var iterator=order==="asc"?_.forEachRight:_.forEach;var prev_msg;var all_days=[];var day=[];iterator(msgs,function(msg){if(!config.skip_day_groupings&&(!prev_msg||!TS.utility.msgs.areMsgsSameDay(msg,prev_msg))){if(day.length)all_days.push(day);day=[msg]}else{day.push(msg)}prev_msg=msg});if(day.length)all_days.push(day);return all_days};var _processMessages=function(config,msgs){if(config.msg_order==="desc")return msgs;var processed=[];var jl_rolled_up_msgs=[];var i,rollup,msg;for(i=msgs.length-1;i>-1;i--){msg=msgs[i];if(TS.utility.msgs.isMsgHidden(msg))continue;rollup=TS.utility.msgs.msgRollUpWorker(i,msg,msgs,jl_rolled_up_msgs);if(rollup==="continue"){continue}else if(rollup==="swap"){msg=jl_rolled_up_msgs[0];jl_rolled_up_msgs.length=0}processed.unshift(msg)}return processed};var _compareTs=function(order,a_ts,b_ts){if(order==="asc"){if(a_ts<b_ts)return-1;if(a_ts>b_ts)return 1}else{if(a_ts>b_ts)return-1;if(a_ts<b_ts)return 1}return 0};var _isOnOrAfter=function(order,a_ts,b_ts){if(order==="asc"){return a_ts>=b_ts}else{return a_ts<=b_ts}};var _isOnOrBefore=function(order,a_ts,b_ts){if(order==="asc"){return a_ts<=b_ts}else{return a_ts>=b_ts}};var _debug=function(msg,config){var pri=102;if(!TS.shouldLog(pri))return;var all=_flattenAllMsgs(config);var messages_count=all.length;var sections_count=config.sections.length;var range_start_index=config._range?_.findIndex(all,{msg_ts:config._range.start.msg_ts}):null;var range_end_index=config._range?_.findIndex(all,{msg_ts:config._range.end.msg_ts}):null;var has_more_end=config.has_more_end;TS.log(pri,"[msg_container] "+msg,{sections:sections_count,messages:messages_count,range_start:range_start_index,range_end:range_end_index,has_more_end:has_more_end})}})();
